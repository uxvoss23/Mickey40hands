<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Route - Sunton Solutions</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f1f5f9;
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
    }
    .header {
      background: #4f46e5;
      color: white;
      padding: 20px 16px 16px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header h1 { font-size: 18px; font-weight: 700; margin-bottom: 2px; }
    .header .subtitle { font-size: 11px; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }
    .route-info {
      background: white;
      padding: 14px 16px;
      border-bottom: 1px solid #e2e8f0;
    }
    .route-name { font-size: 17px; font-weight: 700; color: #1e293b; }
    .route-date { font-size: 13px; color: #6366f1; font-weight: 500; margin-top: 2px; }
    .progress-bar-wrap {
      background: white;
      padding: 10px 16px 14px;
      border-bottom: 2px solid #e2e8f0;
    }
    .progress-text {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 6px;
      font-weight: 500;
    }
    .progress-bar {
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: #22c55e;
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    .stops-list { padding: 12px; }
    .stop-card {
      background: white;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      margin-bottom: 10px;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    .stop-card.completed {
      opacity: 0.6;
      border-color: #bbf7d0;
    }
    .stop-card.completed .stop-number { background: #22c55e; }
    .stop-top { display: flex; }
    .stop-number {
      background: #6366f1;
      color: white;
      min-width: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
      transition: background 0.3s;
    }
    .stop-details { flex: 1; padding: 12px 14px; }
    .stop-name { font-weight: 700; color: #1e293b; font-size: 15px; }
    .stop-time { color: #6366f1; font-weight: 600; font-size: 13px; }
    .stop-service { color: #8b5cf6; font-size: 12px; font-weight: 500; margin-top: 2px; }
    .stop-address {
      display: block;
      color: #3b82f6;
      font-size: 13px;
      margin-top: 4px;
      text-decoration: underline;
    }
    .stop-phone {
      display: inline-block;
      color: #64748b;
      font-size: 13px;
      margin-top: 3px;
      text-decoration: none;
    }
    .stop-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px; }
    .stop-tag {
      background: #f1f5f9;
      border-radius: 4px;
      padding: 3px 8px;
      font-size: 11px;
      color: #64748b;
    }
    .stop-tag.price { background: #f0fdf4; color: #059669; font-weight: 600; }
    .stop-notes {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 6px;
      margin-top: 6px;
    }
    .stop-notes.customer { color: #1e40af; background: #eff6ff; border-left: 3px solid #3b82f6; }
    .stop-notes.job { color: #92400e; background: #fffbeb; border-left: 3px solid #f59e0b; }
    .complete-btn {
      display: block;
      width: calc(100% - 24px);
      margin: 8px 12px 12px;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
    }
    .complete-btn.active {
      background: #22c55e;
      color: white;
    }
    .complete-btn.active:active {
      transform: scale(0.97);
      background: #16a34a;
    }
    .complete-btn.done {
      background: #f0fdf4;
      color: #22c55e;
      pointer-events: none;
    }
    .complete-btn.loading {
      background: #94a3b8;
      color: white;
      pointer-events: none;
    }
    .all-done {
      text-align: center;
      padding: 24px 16px;
      color: #22c55e;
      font-size: 20px;
      font-weight: 700;
    }
    .loading-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
      color: #64748b;
      font-size: 16px;
    }
    .error-screen {
      text-align: center;
      padding: 40px 20px;
      color: #ef4444;
      font-size: 16px;
    }

    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .modal-content {
      background: white;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      border-radius: 20px 20px 0 0;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
      padding-bottom: env(safe-area-inset-bottom, 16px);
    }
    .modal-header {
      position: sticky;
      top: 0;
      background: white;
      padding: 20px 20px 12px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1;
    }
    .modal-header h2 { font-size: 18px; font-weight: 700; color: #1e293b; }
    .modal-close {
      width: 32px; height: 32px;
      border-radius: 50%;
      border: none;
      background: #f1f5f9;
      color: #64748b;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-body { padding: 16px 20px; }
    .modal-section { margin-bottom: 20px; }
    .modal-label {
      font-size: 13px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .modal-label .required {
      color: #ef4444;
      font-size: 11px;
      font-weight: 600;
    }
    .section-title { font-size: 14px; font-weight: 800; color: #1e293b; margin-bottom: 12px; padding: 8px 0 6px; border-bottom: 2px solid #e2e8f0; }
    .section-title .st-icon { margin-right: 6px; }
    .photo-slots-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .photo-slot {
      border: 2px dashed #cbd5e1; border-radius: 10px; padding: 8px; text-align: center;
      cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
      min-height: 90px; display: flex; align-items: center; justify-content: center;
      flex-direction: column; background: #f8fafc;
    }
    .photo-slot:active { background: #eef2ff; border-color: #6366f1; }
    .photo-slot.filled { border-style: solid; border-color: #22c55e; padding: 3px; background: white; }
    .photo-slot.filled img { width: 100%; height: 80px; object-fit: cover; border-radius: 7px; }
    .photo-slot-icon { font-size: 22px; margin-bottom: 2px; }
    .photo-slot-label { font-size: 10px; color: #64748b; font-weight: 600; line-height: 1.3; }
    .photo-slot-check { position: absolute; top: 4px; left: 4px; font-size: 14px; }
    .photo-slot-name { font-size: 9px; color: #475569; font-weight: 700; margin-top: 3px; text-align: center; }
    .photo-remove {
      position: absolute; top: 3px; right: 3px; width: 22px; height: 22px; border-radius: 50%;
      background: rgba(239,68,68,0.9); color: white; border: none; font-size: 12px;
      cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 2;
    }
    .issue-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 8px; }
    .issue-thumb { position: relative; border-radius: 6px; overflow: hidden; aspect-ratio: 1; border: 2px solid #fca5a5; }
    .issue-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .issue-tag { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; font-size: 8px; padding: 2px 4px; text-align: center; font-weight: 600; }
    .issue-add-btn {
      border: 2px dashed #fca5a5; border-radius: 6px; aspect-ratio: 1; display: flex;
      align-items: center; justify-content: center; flex-direction: column; cursor: pointer;
      background: #fef2f2; transition: all 0.2s;
    }
    .issue-add-btn:active { background: #fee2e2; border-color: #f87171; }
    .radio-group { display: flex; flex-direction: column; gap: 6px; }
    .radio-row {
      display: flex; align-items: center; gap: 8px; padding: 10px 12px; border: 1.5px solid #e2e8f0;
      border-radius: 8px; cursor: pointer; transition: all 0.15s; background: white;
      font-size: 13px; font-weight: 500; color: #475569;
    }
    .radio-row:active { transform: scale(0.98); }
    .radio-row.selected { border-color: #6366f1; background: #eef2ff; color: #4f46e5; font-weight: 600; }
    .radio-dot {
      width: 18px; height: 18px; border-radius: 50%; border: 2px solid #cbd5e1;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .radio-row.selected .radio-dot { border-color: #6366f1; }
    .radio-dot-inner { width: 10px; height: 10px; border-radius: 50%; background: #6366f1; display: none; }
    .radio-row.selected .radio-dot-inner { display: block; }
    .check-group { display: flex; flex-direction: column; gap: 6px; }
    .check-row {
      display: flex; align-items: center; gap: 8px; padding: 10px 12px; border: 1.5px solid #e2e8f0;
      border-radius: 8px; cursor: pointer; transition: all 0.15s; background: white;
      font-size: 13px; font-weight: 500; color: #475569;
    }
    .check-row:active { transform: scale(0.98); }
    .check-row.checked { border-color: #6366f1; background: #eef2ff; color: #4f46e5; }
    .check-box {
      width: 18px; height: 18px; border-radius: 4px; border: 2px solid #cbd5e1;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
      font-size: 11px; color: white;
    }
    .check-row.checked .check-box { background: #6366f1; border-color: #6366f1; }
    .service-price-card {
      background: linear-gradient(135deg, #f0fdf4, #ecfdf5); border: 1.5px solid #bbf7d0;
      border-radius: 10px; padding: 12px 14px; margin-bottom: 12px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .service-price-label { font-size: 12px; color: #64748b; font-weight: 600; }
    .service-price-amount { font-size: 22px; font-weight: 800; color: #059669; }
    .recurring-price-tag { font-size: 11px; font-weight: 700; color: #059669; background: #f0fdf4; padding: 2px 8px; border-radius: 6px; margin-left: 6px; }
    .recurring-savings { font-size: 10px; color: #64748b; margin-top: 2px; }
    .modal-textarea {
      width: 100%; min-height: 60px; border: 1.5px solid #e2e8f0; border-radius: 10px;
      padding: 10px 12px; font-size: 13px; font-family: 'Inter', sans-serif; resize: vertical;
      transition: border-color 0.2s; color: #1e293b;
    }
    .modal-textarea:focus { outline: none; border-color: #6366f1; }
    .modal-textarea::placeholder { color: #94a3b8; }
    .modal-submit {
      width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px;
      font-weight: 700; cursor: pointer; font-family: 'Inter', sans-serif;
      transition: all 0.2s; margin-top: 8px;
    }
    .modal-submit.enabled { background: #22c55e; color: white; }
    .modal-submit.enabled:active { transform: scale(0.97); background: #16a34a; }
    .modal-submit.disabled { background: #e2e8f0; color: #94a3b8; pointer-events: none; }
    .modal-submit.submitting { background: #94a3b8; color: white; pointer-events: none; }
    .validation-checklist { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
    .validation-item { font-size: 10px; padding: 3px 8px; border-radius: 20px; font-weight: 600; }
    .validation-item.done { background: #f0fdf4; color: #22c55e; }
    .validation-item.pending { background: #fef2f2; color: #ef4444; }
    .issue-select { width: 100%; padding: 6px 8px; border: 1.5px solid #e2e8f0; border-radius: 6px; font-size: 11px; font-family: 'Inter', sans-serif; color: #475569; margin-top: 4px; }
    .stop-card.cancelled {
      opacity: 0.5;
      border-color: #fca5a5;
    }
    .stop-card.cancelled .stop-number { background: #ef4444; }
    .cancel-btn {
      display: block;
      width: calc(100% - 24px);
      margin: 0 12px 8px;
      padding: 10px;
      border: 2px solid #fca5a5;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      background: #fef2f2;
      color: #dc2626;
      transition: all 0.2s;
    }
    .cancel-btn:active {
      background: #fee2e2;
      transform: scale(0.97);
    }
    .gap-fill-banner {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border: 2px solid #f59e0b;
      border-radius: 12px;
      margin: 12px;
      padding: 16px;
      text-align: center;
    }
    .gap-fill-banner h3 {
      color: #92400e;
      font-size: 16px;
      margin-bottom: 4px;
    }
    .gap-fill-banner p {
      color: #a16207;
      font-size: 13px;
    }
    .gap-fill-confirmed {
      background: linear-gradient(135deg, #f0fdf4, #dcfce7);
      border: 2px solid #22c55e;
      border-radius: 12px;
      margin: 12px;
      padding: 16px;
    }
    .gap-fill-confirmed h3 {
      color: #166534;
      font-size: 16px;
      margin-bottom: 8px;
    }
    .gap-fill-confirmed .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      font-size: 13px;
      color: #15803d;
    }
    .cancel-modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }
    .cancel-modal-content {
      background: white;
      width: 100%;
      max-width: 500px;
      border-radius: 20px 20px 0 0;
      animation: slideUp 0.3s ease;
      padding: 20px;
      padding-bottom: env(safe-area-inset-bottom, 20px);
    }
    .cancel-modal-content h2 {
      font-size: 18px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 16px;
    }
    .cancel-reason-btn {
      display: block;
      width: 100%;
      padding: 12px;
      margin-bottom: 6px;
      border: 1.5px solid #e2e8f0;
      border-radius: 8px;
      background: white;
      font-size: 14px;
      font-weight: 500;
      color: #475569;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      text-align: left;
      transition: all 0.15s;
    }
    .cancel-reason-btn.selected {
      border-color: #ef4444;
      background: #fef2f2;
      color: #dc2626;
      font-weight: 600;
    }
    .cancel-reason-btn:active { transform: scale(0.98); }
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="modal-root"></div>
  <script>
    const routeId = window.location.pathname.split('/').pop();
    let routeData = null;
    let completedStops = new Set();
    let activeModal = null;
    let cancellingStopId = null;
    let gapFillActive = false;
    let gapFillConfirmed = null;
    let cancelledStops = new Set();
    const PHOTO_SLOTS = [
      { key: 'full_before', label: 'Full System \u2013 Before', icon: '\ud83c\udfe0' },
      { key: 'closeup_before', label: 'Close-Up Buildup \u2013 Before', icon: '\ud83d\udd0d' },
      { key: 'full_after', label: 'Full System \u2013 After', icon: '\u2728' },
      { key: 'closeup_after', label: 'Close-Up Clean \u2013 After', icon: '\ud83e\uddfc' }
    ];
    const ISSUE_TAGS = ['Crack','Chip','Delamination','Loose hardware','Pest activity','Roof concern','Other'];
    const DEBRIS_OPTIONS = ['Dust / Pollen','Bird Droppings','Sap','Pollution Film','Mixed','Other'];
    const DAMAGE_OPTIONS = [{value:'None'}, {value:'Crack', hasCount:true}, {value:'Chip', hasCount:true}, {value:'Micro-cracks'}, {value:'Delamination'}, {value:'Hot Spots'}, {value:'Discoloration'}];
    const SYSTEM_CHECKS = ['No visible issues','Loose racking / hardware','Pest activity','Shading concern','Roof penetration concern','Conduit / wiring concern','Other'];
    let modalState = {
      slotPhotos: {},
      issuePhotos: [],
      buildupLevel: '',
      debris: [],
      otherDebris: '',
      surfaceDamage: [],
      systemChecks: [],
      urgentChecks: [],
      otherSystemCheck: '',
      inspectionNotes: '',
      recommendedFreq: '',
      recurringSelection: ''
    };

    async function loadRoute() {
      const app = document.getElementById('app');
      app.innerHTML = '<div class="loading-screen">Loading route...</div>';
      try {
        const res = await fetch(`/api/routes/${routeId}/tech-view`);
        if (!res.ok) throw new Error('Route not found');
        routeData = await res.json();
        routeData.stops.forEach(s => {
          if (s.completed_at) completedStops.add(s.id);
        });
        render();
      } catch (err) {
        app.innerHTML = '<div class="error-screen" style="padding:40px 20px;text-align:center;color:#ef4444;"><p style="font-size:18px;font-weight:700;margin-bottom:8px;">Could not load route</p><p style="color:#64748b;font-size:14px;">This route may have been cleared or deleted. Please ask dispatch to resend the route email.</p></div>';
      }
    }

    function openCompletionModal(stopId) {
      activeModal = stopId;
      modalState = {
        slotPhotos: {}, issuePhotos: [], buildupLevel: '', debris: [], otherDebris: '',
        surfaceDamage: [], systemChecks: [], urgentChecks: [], otherSystemCheck: '',
        inspectionNotes: '', recommendedFreq: '', recurringSelection: ''
      };
      renderModal();
    }

    function closeModal() {
      activeModal = null;
      document.getElementById('modal-root').innerHTML = '';
    }

    function openCancelModal(stopId) {
      cancellingStopId = stopId;
      const stop = routeData.stops.find(s => s.id === stopId);
      const modalRoot = document.getElementById('modal-root');
      const reasons = ['Customer Requested', 'No Answer', 'Weather', 'Rescheduled', 'Other'];
      let selectedReason = '';
      let note = '';
      
      function renderCancelModal() {
        modalRoot.innerHTML = `
          <div class="cancel-modal-overlay" onclick="if(event.target===this){closeCancelModal()}">
            <div class="cancel-modal-content">
              <h2>Cancel: ${stop ? stop.customer_name : 'Stop'}</h2>
              <p style="font-size:13px;color:#64748b;margin-bottom:16px;">Select a reason for cancellation:</p>
              ${reasons.map(r => `
                <button class="cancel-reason-btn ${selectedReason === r ? 'selected' : ''}" 
                  onclick="document.querySelectorAll('.cancel-reason-btn').forEach(b=>b.classList.remove('selected'));this.classList.add('selected');window._cancelReason='${r}';">
                  ${r}
                </button>
              `).join('')}
              <textarea placeholder="Notes (optional)..." 
                oninput="window._cancelNote=this.value"
                style="width:100%;min-height:60px;border:1.5px solid #e2e8f0;border-radius:10px;padding:10px;font-size:13px;font-family:'Inter',sans-serif;margin-top:12px;resize:vertical;"></textarea>
              <div style="display:flex;gap:8px;margin-top:16px;">
                <button onclick="closeCancelModal()" style="flex:1;padding:14px;border:1.5px solid #e2e8f0;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;font-family:'Inter',sans-serif;background:white;color:#64748b;">
                  Back
                </button>
                <button onclick="confirmCancel(${stopId})" style="flex:1;padding:14px;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;font-family:'Inter',sans-serif;background:#ef4444;color:white;">
                  Confirm Cancel
                </button>
              </div>
            </div>
          </div>
        `;
      }
      
      renderCancelModal();
    }

    function closeCancelModal() {
      cancellingStopId = null;
      window._cancelReason = '';
      window._cancelNote = '';
      document.getElementById('modal-root').innerHTML = '';
    }

    async function confirmCancel(stopId) {
      const reason = window._cancelReason || 'Other';
      const note = window._cancelNote || '';
      
      try {
        const res = await fetch(`/api/routes/${routeId}/stops/${stopId}/cancel`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason, note })
        });
        const data = await res.json();
        if (data.success) {
          cancelledStops.add(stopId);
          closeCancelModal();
          gapFillActive = true;
          startGapFillPolling();
          render();
        } else {
          alert('Failed to cancel: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        console.error('Cancel error:', err);
        alert('Failed to cancel stop. Please try again.');
      }
    }

    let gapFillPollInterval = null;
    function startGapFillPolling() {
      if (gapFillPollInterval) return;
      gapFillPollInterval = setInterval(async () => {
        try {
          const res = await fetch(`/api/gapfill/route/${routeId}/status`);
          const data = await res.json();
          if (data.confirmed && !gapFillConfirmed) {
            gapFillConfirmed = {
              customer_name: data.confirmed_customer_name,
              address: data.confirmed_address
            };
            gapFillActive = false;
            render();
          } else if (!data.active && !data.confirmed && gapFillActive) {
            gapFillActive = false;
            gapFillConfirmed = null;
            render();
          }
        } catch (err) {
          console.error('Gap fill poll error:', err);
        }
      }, 15000);
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const maxSize = 800;
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = new Image();
          img.onload = function() {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            if (w > maxSize || h > maxSize) {
              if (w > h) { h = Math.round(h * maxSize / w); w = maxSize; }
              else { w = Math.round(w * maxSize / h); h = maxSize; }
            }
            canvas.width = w;
            canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            resolve(canvas.toDataURL('image/jpeg', 0.7));
          };
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function handleSlotPhoto(slotKey) {
      const input = document.createElement('input');
      input.type = 'file'; input.accept = 'image/*';
      input.onchange = async (e) => {
        const file = e.target.files[0]; if (!file) return;
        try { modalState.slotPhotos[slotKey] = await fileToBase64(file); renderModal(); }
        catch(err) { alert('Failed to process photo'); }
      };
      input.click();
    }
    function removeSlotPhoto(k) { delete modalState.slotPhotos[k]; renderModal(); }

    async function handleAddIssue() {
      const input = document.createElement('input');
      input.type = 'file'; input.accept = 'image/*';
      input.onchange = async (e) => {
        const file = e.target.files[0]; if (!file) return;
        try {
          const b64 = await fileToBase64(file);
          modalState.issuePhotos.push({ data: b64, tag: '' });
          renderModal();
        } catch(err) { console.error(err); }
      };
      input.click();
    }
    const TAG_TO_DAMAGE = { 'Crack': 'Crack', 'Chip': 'Chip', 'Delamination': 'Delamination' };
    const TAG_TO_SYSTEM = { 'Loose hardware': 'Loose racking / hardware', 'Pest activity': 'Pest activity', 'Roof concern': 'Roof penetration concern' };

    function getActiveIssueTags() {
      return modalState.issuePhotos.map(p => p.tag).filter(Boolean);
    }

    function isTagLocked(checkField, checkValue) {
      const tags = getActiveIssueTags();
      if (checkField === 'surfaceDamage') {
        return tags.some(t => TAG_TO_DAMAGE[t] === checkValue) && modalState.surfaceDamage.some(d => d.type === checkValue);
      }
      if (checkField === 'systemChecks') {
        return tags.some(t => TAG_TO_SYSTEM[t] === checkValue);
      }
      return false;
    }

    function showTagLockWarning(msg) {
      let el = document.getElementById('tag-lock-warning');
      if (!el) {
        el = document.createElement('div');
        el.id = 'tag-lock-warning';
        el.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#991b1b;color:#fecaca;padding:10px 18px;border-radius:8px;font-size:12px;font-weight:600;z-index:100001;box-shadow:0 4px 12px rgba(0,0,0,0.4);text-align:center;max-width:90%;';
        document.body.appendChild(el);
      }
      el.textContent = msg;
      el.style.display = 'block';
      clearTimeout(el._timer);
      el._timer = setTimeout(() => { el.style.display = 'none'; }, 3000);
    }

    function syncAllTagSelections() {
      const tags = getActiveIssueTags();
      const lockedDamage = tags.map(t => TAG_TO_DAMAGE[t]).filter(Boolean);
      const lockedSystem = tags.map(t => TAG_TO_SYSTEM[t]).filter(Boolean);
      lockedDamage.forEach(dmgVal => {
        if (!modalState.surfaceDamage.some(d => d.type === dmgVal)) {
          modalState.surfaceDamage = modalState.surfaceDamage.filter(d => d.type !== 'None');
          const opt = DAMAGE_OPTIONS.find(o => o.value === dmgVal);
          modalState.surfaceDamage.push({ type: dmgVal, count: opt && opt.hasCount ? 1 : undefined });
        }
      });
      lockedSystem.forEach(sysVal => {
        if (!modalState.systemChecks.includes(sysVal)) {
          modalState.systemChecks.push(sysVal);
        }
      });
    }

    function removeIssue(i) {
      modalState.issuePhotos.splice(i, 1);
      syncAllTagSelections();
      renderModal();
    }

    function setIssueTag(i, tag) {
      modalState.issuePhotos[i].tag = tag;
      syncAllTagSelections();
      renderModal();
    }

    function getAllPhotos() {
      const photos = [];
      PHOTO_SLOTS.forEach(s => { if (modalState.slotPhotos[s.key]) photos.push({ label: s.label, data: modalState.slotPhotos[s.key] }); });
      modalState.issuePhotos.forEach((p, i) => photos.push({ label: 'Issue: ' + (p.tag || 'Untagged'), data: p.data }));
      return photos;
    }

    function setRadio(field, value) {
      modalState[field] = value;
      document.querySelectorAll('[data-radio-field="' + field + '"]').forEach(row => {
        const isSelected = row.dataset.radioValue === value;
        row.className = 'radio-row' + (isSelected ? ' selected' : '');
      });
      updateValidation();
    }

    function toggleDamage(value) {
      const arr = modalState.surfaceDamage;
      const idx = arr.findIndex(d => d.type === value);
      if (idx >= 0) {
        if (isTagLocked('surfaceDamage', value)) {
          showTagLockWarning('Cannot uncheck â€” "' + value + '" is linked to an issue photo. Remove the photo first.');
          return;
        }
        arr.splice(idx, 1);
      } else {
        if (value === 'None') {
          const lockedTypes = arr.filter(d => isTagLocked('surfaceDamage', d.type));
          if (lockedTypes.length > 0) {
            showTagLockWarning('Cannot select None â€” damage types linked to issue photos are still active.');
            return;
          }
          modalState.surfaceDamage = [{ type: 'None' }];
        } else {
          modalState.surfaceDamage = arr.filter(d => d.type !== 'None');
          const opt = DAMAGE_OPTIONS.find(o => o.value === value);
          if (opt && opt.hasCount) {
            modalState.surfaceDamage.push({ type: value, count: 1 });
          } else {
            modalState.surfaceDamage.push({ type: value });
          }
        }
      }
      renderModal();
    }

    function setDamageCount(type, count) {
      const entry = modalState.surfaceDamage.find(d => d.type === type);
      if (entry) entry.count = count;
      updateValidation();
    }
    function toggleCheck(field, value) {
      const arr = modalState[field];
      const idx = arr.indexOf(value);
      if (idx >= 0) {
        if (isTagLocked(field, value)) {
          showTagLockWarning('Cannot uncheck â€” "' + value + '" is linked to an issue photo. Remove the photo first.');
          return;
        }
        arr.splice(idx, 1);
      } else { if (field === 'debris' && arr.length >= 3) return; arr.push(value); }
      if (field === 'systemChecks') {
        modalState.urgentChecks = modalState.urgentChecks.filter(u => arr.includes(u));
        renderModal();
        return;
      }
      document.querySelectorAll('[data-check-field="' + field + '"]').forEach(row => {
        const isChecked = arr.includes(row.dataset.checkValue);
        row.className = 'check-row' + (isChecked ? ' checked' : '');
        row.querySelector('.check-box').innerHTML = isChecked ? '\u2713' : '';
      });
      if (field === 'debris') {
        const otherBox = document.getElementById('other-debris-input');
        if (otherBox) otherBox.style.display = arr.includes('Other') ? 'block' : 'none';
      }
      updateValidation();
    }

    function toggleUrgent(value) {
      const idx = modalState.urgentChecks.indexOf(value);
      if (idx >= 0) { modalState.urgentChecks.splice(idx, 1); } else { modalState.urgentChecks.push(value); }
      renderModal();
    }

    function updateNotes() {
      const el = document.getElementById('modal-inspection-notes'); if (el) modalState.inspectionNotes = el.value;
      const os = document.getElementById('other-system-text'); if (os) modalState.otherSystemCheck = os.value;
      const odr = document.getElementById('other-debris-text'); if (odr) modalState.otherDebris = odr.value;
    }

    function updateValidation() {
      updateNotes();
      const ms = modalState;
      const filledSlots = Object.keys(ms.slotPhotos).length;
      const needsIssuePhoto = ms.surfaceDamage.length > 0 && !ms.surfaceDamage.some(d => d.type === 'None');
      const hasIssuePhoto = ms.issuePhotos.length > 0;
      const v = {
        photos: filledSlots >= 4,
        condition: !!ms.buildupLevel && ms.surfaceDamage.length > 0 && (!needsIssuePhoto || hasIssuePhoto),
        system: ms.systemChecks.length > 0 && !!ms.inspectionNotes.trim(),
        maintenance: !!ms.recommendedFreq && !!ms.recurringSelection
      };
      const valid = v.photos && v.condition && v.system && v.maintenance;
      const items = document.querySelectorAll('.validation-item');
      const labels = ['Photos', 'Condition', 'Inspection', 'Plan'];
      const vals = [v.photos, v.condition, v.system, v.maintenance];
      items.forEach((item, i) => {
        if (i < vals.length) {
          item.className = 'validation-item ' + (vals[i] ? 'done' : 'pending');
          item.textContent = (vals[i] ? '\u2713' : '\u25CB') + ' ' + labels[i];
        }
      });
      const btn = document.getElementById('modal-submit-btn');
      if (btn && !btn.classList.contains('submitting')) {
        btn.className = 'modal-submit ' + (valid ? 'enabled' : 'disabled');
        btn.textContent = valid ? 'Complete Job' : 'Fill All Required Fields';
      }
    }

    function isModalValid() {
      const s = modalState;
      const filledSlots = Object.keys(s.slotPhotos).length;
      const needsIssuePhoto = s.surfaceDamage.length > 0 && !s.surfaceDamage.some(d => d.type === 'None');
      const hasIssuePhoto = s.issuePhotos.length > 0;
      return filledSlots >= 4 && s.buildupLevel && s.surfaceDamage.length > 0 &&
        (!needsIssuePhoto || hasIssuePhoto) &&
        s.systemChecks.length > 0 && s.inspectionNotes.trim() &&
        s.recommendedFreq && s.recurringSelection;
    }

    async function submitCompletion() {
      updateNotes();
      if (!isModalValid()) return;
      const submitBtn = document.getElementById('modal-submit-btn');
      if (submitBtn) { submitBtn.className = 'modal-submit submitting'; submitBtn.textContent = 'Submitting...'; }
      try {
        const res = await fetch(`/api/routes/${routeId}/stops/${activeModal}/complete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            photos: getAllPhotos(),
            inspection_notes: modalState.inspectionNotes.trim(),
            recurring_selection: modalState.recurringSelection,
            completion_data: {
              buildup_level: modalState.buildupLevel,
              debris: modalState.debris.map(d => d === 'Other' ? 'Other: ' + (modalState.otherDebris || '').trim() : d),
              surface_damage: modalState.surfaceDamage,
              system_checks: modalState.systemChecks.map(c => c === 'Other' ? 'Other: ' + (modalState.otherSystemCheck || '').trim() : c),
              urgent_checks: modalState.urgentChecks,
              recommended_frequency: modalState.recommendedFreq,
              issue_tags: modalState.issuePhotos.map(p => p.tag).filter(Boolean)
            }
          })
        });
        if (!res.ok) { const data = await res.json(); throw new Error(data.error || 'Failed'); }
        completedStops.add(activeModal);
        closeModal();
        render();
      } catch (err) {
        alert('Error: ' + err.message);
        if (submitBtn) { submitBtn.className = 'modal-submit enabled'; submitBtn.textContent = 'Complete Job'; }
      }
    }

    function renderModal() {
      if (!activeModal) return;
      const stop = routeData.stops.find(s => s.id === activeModal);
      if (!stop) return;
      updateNotes();
      const isRerender = !!document.querySelector('.modal-overlay');
      const modalContentEl = document.querySelector('.modal-content');
      const savedScroll = modalContentEl ? modalContentEl.scrollTop : 0;

      const ms = modalState;
      const filledSlots = Object.keys(ms.slotPhotos).length;
      const needsIssuePhoto = ms.surfaceDamage.length > 0 && !ms.surfaceDamage.some(d => d.type === 'None');
      const hasIssuePhoto = ms.issuePhotos.length > 0;
      const v = {
        photos: filledSlots >= 4,
        condition: !!ms.buildupLevel && ms.surfaceDamage.length > 0 && (!needsIssuePhoto || hasIssuePhoto),
        system: ms.systemChecks.length > 0 && !!ms.inspectionNotes.trim(),
        maintenance: !!ms.recommendedFreq && !!ms.recurringSelection
      };
      const valid = v.photos && v.condition && v.system && v.maintenance;

      const servicePrice = stop.amount_paid ? parseFloat(stop.amount_paid) : 0;
      const annualPrice = servicePrice > 0 ? (servicePrice * 0.90).toFixed(2) : null;
      const biannualPrice = servicePrice > 0 ? (servicePrice * 0.85).toFixed(2) : null;
      const annualSavings = servicePrice > 0 ? (servicePrice * 0.10).toFixed(2) : null;
      const biannualSavings = servicePrice > 0 ? (servicePrice * 0.15).toFixed(2) : null;
      const triannualPrice = servicePrice > 0 ? (servicePrice * 0.80).toFixed(2) : null;
      const triannualSavings = servicePrice > 0 ? (servicePrice * 0.20).toFixed(2) : null;

      const slotsHTML = PHOTO_SLOTS.map(slot => {
        const filled = !!ms.slotPhotos[slot.key];
        if (filled) return '<div class="photo-slot filled" data-slot="' + slot.key + '"><span class="photo-slot-check">\u2705</span><img src="' + ms.slotPhotos[slot.key] + '" alt="' + slot.label + '"><button class="photo-remove" data-remove-slot="' + slot.key + '">&times;</button><div class="photo-slot-name">' + slot.label + '</div></div>';
        return '<div class="photo-slot" data-slot="' + slot.key + '"><div class="photo-slot-icon">' + slot.icon + '</div><div class="photo-slot-label">' + slot.label + '</div></div>';
      }).join('');

      const issuesHTML = ms.issuePhotos.map((p, i) =>
        '<div style="display:flex;flex-direction:column;gap:4px">' +
        '<div class="issue-thumb"><img src="' + p.data + '" alt="Issue"><button class="photo-remove" data-issue-idx="' + i + '">&times;</button>' +
        (p.tag ? '<div class="issue-tag">' + p.tag + '</div>' : '') + '</div>' +
        '<select class="issue-select" data-issue-for="' + i + '"><option value="">Tag...</option>' +
        ISSUE_TAGS.map(t => '<option value="' + t + '"' + (p.tag === t ? ' selected' : '') + '>' + t + '</option>').join('') +
        '</select></div>'
      ).join('');

      const radioHTML = (field, options, extra) => options.map(opt => {
        const val = typeof opt === 'string' ? opt : opt.value;
        const label = typeof opt === 'string' ? opt : opt.label;
        const sel = ms[field] === val;
        const ex = extra && extra[val] ? extra[val] : '';
        const locked = isTagLocked(field, val);
        const lockIcon = locked ? '<span style="margin-left:auto;font-size:10px;opacity:0.7" title="Linked to issue photo">\uD83D\uDD12</span>' : '';
        return '<div class="radio-row ' + (sel ? 'selected' : '') + '" data-radio-field="' + field + '" data-radio-value="' + val.replace(/"/g, '&quot;') + '" onclick="setRadio(\'' + field + '\',\'' + val.replace(/'/g, "\\'") + '\')"><div class="radio-dot"><div class="radio-dot-inner"></div></div><div style="flex:1;display:flex;align-items:center">' + label + ex + lockIcon + '</div></div>';
      }).join('');

      const checkHTML = (field, options) => options.map(opt => {
        const chk = ms[field].includes(opt);
        const locked = isTagLocked(field, opt);
        const lockIcon = locked ? '<span style="margin-left:auto;font-size:10px;opacity:0.7" title="Linked to issue photo">\uD83D\uDD12</span>' : '';
        return '<div class="check-row ' + (chk ? 'checked' : '') + '" data-check-field="' + field + '" data-check-value="' + opt.replace(/"/g, '&quot;') + '" onclick="toggleCheck(\'' + field + '\',\'' + opt.replace(/'/g, "\\'") + '\')"><div class="check-box">' + (chk ? '\u2713' : '') + '</div><div style="flex:1;display:flex;align-items:center">' + opt + lockIcon + '</div></div>';
      }).join('');

      const recurringOptions = [
        { value: 'not_offered', label: 'Not Offered' },
        { value: 'offered_declined', label: 'Offered \u2014 Declined' },
        { value: 'enrolled_annual', label: 'Enrolled \u2014 Annual', price: annualPrice, savings: annualSavings, discount: '10% off' },
        { value: 'enrolled_biannual', label: 'Enrolled \u2014 Bi-Annual', price: biannualPrice, savings: biannualSavings, discount: '15% off' },
        { value: 'enrolled_triannual', label: 'Enrolled \u2014 3x Per Year', price: triannualPrice, savings: triannualSavings, discount: '20% off' }
      ];

      const bodyHTML = `
              <div style="background:#f8fafc;border-radius:10px;padding:10px 12px;margin-bottom:8px">
                <div style="font-size:14px;font-weight:700;color:#1e293b">${stop.full_name || 'Customer'}</div>
                <div style="font-size:12px;color:#64748b;margin-top:2px">${stop.address || ''}</div>
              </div>
              ${servicePrice > 0 ? '<div class="service-price-card"><div class="service-price-label">Service Price</div><div class="service-price-amount">$' + servicePrice.toFixed(2) + '</div></div>' : ''}

              <div class="validation-checklist">
                <span class="validation-item ${v.photos ? 'done' : 'pending'}">${v.photos ? '\u2713' : '\u25CB'} Photos</span>
                <span class="validation-item ${v.condition ? 'done' : 'pending'}">${v.condition ? '\u2713' : '\u25CB'} Condition</span>
                <span class="validation-item ${v.system ? 'done' : 'pending'}">${v.system ? '\u2713' : '\u25CB'} Inspection</span>
                <span class="validation-item ${v.maintenance ? 'done' : 'pending'}">${v.maintenance ? '\u2713' : '\u25CB'} Plan</span>
              </div>

              <!-- SECTION 1: PHOTOS -->
              <div class="section-title"><span class="st-icon">\ud83d\udcf7</span> Photo Documentation</div>
              <div class="modal-section">
                <div class="modal-label">Required Photos <span class="required">All 4 required</span></div>
                <div class="photo-slots-grid">${slotsHTML}</div>
              </div>
              <div class="modal-section">
                <div class="modal-label">\u2795 Issue Photos <span style="font-size:10px;color:#64748b;font-weight:400">Optional \u2013 tag each photo</span></div>
                <div class="issue-grid">
                  ${issuesHTML}
                  <div class="issue-add-btn" id="add-issue-btn">
                    <div style="font-size:16px">\u26A0\uFE0F</div>
                    <div style="font-size:8px;color:#ef4444;margin-top:2px;font-weight:600">Add Issue</div>
                  </div>
                </div>
              </div>

              <!-- SECTION 2: PANEL CONDITION -->
              <div class="section-title"><span class="st-icon">\ud83d\udd35</span> Cleaning Assessment</div>
              <div class="modal-section">
                <div class="modal-label">Buildup Level <span class="required">Required</span></div>
                <div class="radio-group">${radioHTML('buildupLevel', ['Light', 'Moderate', 'Heavy'])}</div>
              </div>
              <div class="modal-section">
                <div class="modal-label">Primary Debris <span style="font-size:10px;color:#64748b;font-weight:400">Select up to 3</span></div>
                <div class="check-group">${checkHTML('debris', DEBRIS_OPTIONS)}</div>
                <div id="other-debris-input" style="display:${ms.debris.includes('Other') ? 'block' : 'none'};margin-top:6px">
                  <input type="text" id="other-debris-text" placeholder="Describe debris type..." value="${ms.otherDebris.replace(/"/g, '&quot;')}" oninput="updateNotes()" style="width:100%;padding:8px 12px;border:1.5px solid #e2e8f0;border-radius:8px;font-size:13px;font-family:'Inter',sans-serif;color:#1e293b">
                </div>
              </div>
              <div class="modal-section">
                <div class="modal-label">Surface Damage Observed <span class="required">Required</span></div>
                <div class="check-group">${DAMAGE_OPTIONS.map(opt => {
                  const chk = ms.surfaceDamage.some(d => d.type === opt.value);
                  const locked = isTagLocked('surfaceDamage', opt.value);
                  const lockIcon = locked ? '<span style="margin-left:auto;font-size:10px;opacity:0.7" title="Linked to issue photo">\uD83D\uDD12</span>' : '';
                  const entry = ms.surfaceDamage.find(d => d.type === opt.value);
                  const countInput = (opt.hasCount && chk) ? ' <input type="number" min="1" max="99" value="' + (entry ? entry.count : 1) + '" onclick="event.stopPropagation()" onchange="setDamageCount(\'' + opt.value + '\', parseInt(this.value)||1)" style="width:48px;padding:4px;border:1.5px solid #cbd5e1;border-radius:6px;font-size:12px;font-family:Inter,sans-serif;text-align:center">' : '';
                  return '<div class="check-row ' + (chk ? 'checked' : '') + '" onclick="toggleDamage(\'' + opt.value.replace(/'/g, "\\'") + '\')"><div class="check-box">' + (chk ? '\u2713' : '') + '</div><div style="flex:1;display:flex;align-items:center">' + opt.value + countInput + lockIcon + '</div></div>';
                }).join('')}</div>
                <div id="damage-warning" style="font-size:11px;color:#ef4444;margin-top:4px;font-weight:600;display:${needsIssuePhoto && !hasIssuePhoto ? 'block' : 'none'}">\u26A0 Surface damage selected \u2014 issue photo required</div>
              </div>

              <!-- SECTION 3: SYSTEM CHECK -->
              <div class="section-title"><span class="st-icon">\ud83d\udd0d</span> Visual Inspection</div>
              <div class="modal-section">
                <div class="modal-label">System Condition <span class="required">Select all that apply</span></div>
                <div class="check-group">${SYSTEM_CHECKS.map(opt => {
                  const chk = ms.systemChecks.includes(opt);
                  const isUrgent = ms.urgentChecks.includes(opt);
                  const isIssue = opt !== 'No visible issues' && opt !== 'Other';
                  const urgentBtn = chk && isIssue ? '<span onclick="event.stopPropagation();toggleUrgent(\'' + opt.replace(/'/g, "\\'") + '\')" style="margin-left:auto;font-size:10px;padding:2px 8px;border-radius:10px;font-weight:700;cursor:pointer;' + (isUrgent ? 'background:#dc2626;color:#fff;' : 'background:#fee2e2;color:#dc2626;') + '">' + (isUrgent ? 'ðŸš¨ URGENT' : 'Flag urgent') + '</span>' : '';
                  return '<div class="check-row ' + (chk ? 'checked' : '') + '" style="' + (isUrgent ? 'border:1.5px solid #dc2626;background:#fef2f2;' : '') + '" data-check-field="systemChecks" data-check-value="' + opt.replace(/"/g, '&quot;') + '" onclick="toggleCheck(\'systemChecks\',\'' + opt.replace(/'/g, "\\'") + '\')"><div class="check-box">' + (chk ? 'âœ“' : '') + '</div><div style="flex:1;display:flex;align-items:center;gap:6px">' + opt + urgentBtn + '</div></div>';
                }).join('')}</div>
                <div id="other-system-input" style="display:${ms.systemChecks.includes('Other') ? 'block' : 'none'};margin-top:6px">
                  <input type="text" id="other-system-text" placeholder="Describe the issue..." value="${ms.otherSystemCheck.replace(/"/g, '&quot;')}" oninput="updateNotes()" style="width:100%;padding:8px 12px;border:1.5px solid #e2e8f0;border-radius:8px;font-size:13px;font-family:'Inter',sans-serif;color:#1e293b">
                </div>
              </div>
              <div class="modal-section">
                <div class="modal-label">Inspection Notes <span class="required">Required</span></div>
                <textarea class="modal-textarea" id="modal-inspection-notes" placeholder="Anything notable about system condition? (1\u20133 sentences)" oninput="updateNotes();updateValidation();">${ms.inspectionNotes}</textarea>
              </div>

              <!-- SECTION 4: MAINTENANCE PLAN -->
              <div class="section-title"><span class="st-icon">\ud83d\udcc5</span> Maintenance Recommendation</div>
              <div class="modal-section">
                <div class="modal-label">Recommended Cleaning Frequency <span class="required">Required</span></div>
                <div class="radio-group">${radioHTML('recommendedFreq', ['Annual', 'Bi-Annual', '3x Per Year'])}</div>
              </div>
              <div class="modal-section">
                <div class="modal-label">Recurring Service Status <span class="required">Required</span></div>
                <div class="radio-group">
                  ${recurringOptions.map(opt => {
                    const sel = ms.recurringSelection === opt.value;
                    const priceInfo = opt.price ? '<div class="recurring-price-tag">$' + opt.price + '</div><div class="recurring-savings">' + opt.discount + ' \u00B7 Save $' + opt.savings + '</div>' : '';
                    return '<div class="radio-row ' + (sel ? 'selected' : '') + '" data-radio-field="recurringSelection" data-radio-value="' + opt.value + '" onclick="setRadio(\'recurringSelection\',\'' + opt.value + '\')"><div class="radio-dot"><div class="radio-dot-inner"></div></div><div style="flex:1"><div>' + opt.label + '</div>' + priceInfo + '</div></div>';
                  }).join('')}
                </div>
              </div>

              <button id="modal-submit-btn" class="modal-submit ${valid ? 'enabled' : 'disabled'}" onclick="submitCompletion()">
                ${valid ? 'Complete Job' : 'Fill All Required Fields'}
              </button>
      `;

      if (isRerender) {
        const existingBody = document.querySelector('.modal-body');
        if (existingBody) existingBody.innerHTML = bodyHTML;
      } else {
        document.getElementById('modal-root').innerHTML = `
          <div class="modal-overlay" onclick="if(event.target===this)closeModal()">
            <div class="modal-content">
              <div class="modal-header">
                <h2>Complete Job</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
              </div>
              <div class="modal-body">${bodyHTML}</div>
            </div>
          </div>
        `;
      }

      setTimeout(() => {
        document.querySelectorAll('[data-slot]').forEach(el => {
          if (!ms.slotPhotos[el.dataset.slot]) el.addEventListener('click', () => handleSlotPhoto(el.dataset.slot));
        });
        document.querySelectorAll('[data-remove-slot]').forEach(btn => {
          btn.addEventListener('click', (e) => { e.stopPropagation(); removeSlotPhoto(btn.dataset.removeSlot); });
        });
        const issueBtn = document.getElementById('add-issue-btn');
        if (issueBtn) issueBtn.addEventListener('click', () => handleAddIssue());
        document.querySelectorAll('[data-issue-idx]').forEach(btn => {
          btn.addEventListener('click', (e) => { e.stopPropagation(); removeIssue(parseInt(btn.dataset.issueIdx)); });
        });
        document.querySelectorAll('.issue-select').forEach(sel => {
          sel.addEventListener('change', (e) => setIssueTag(parseInt(sel.dataset.issueFor), sel.value));
        });
        if (isRerender) {
          const mc = document.querySelector('.modal-content');
          if (mc) mc.scrollTop = savedScroll;
        }
      }, 0);
    }

    function render() {
      if (!routeData) return;
      const { route, stops } = routeData;
      const completed = completedStops.size;
      const total = stops.length;
      const pct = total > 0 ? Math.round((completed / total) * 100) : 0;

      const scheduledDate = route.scheduled_date
        ? new Date(route.scheduled_date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })
        : '';

      const stopsHTML = stops.map((s, i) => {
        const isDone = completedStops.has(s.id);
        const isCancelled = cancelledStops.has(s.id);
        const time = s.scheduled_time
          ? new Date(`2000-01-01T${s.scheduled_time}`).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })
          : '';
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(s.address || '')}`;
        const phone = s.phone || '';
        const panels = s.panel_count || 0;
        const amount = s.amount_paid ? `$${parseFloat(s.amount_paid).toFixed(2)}` : '';
        const serviceIcon = (s.customer_type || 'residential') === 'commercial' ? 'ðŸ¢' : 'ðŸ ';

        let btnHTML = '';
        if (isCancelled) {
          btnHTML = `<button class="complete-btn done" id="btn-${s.id}" style="background:#fef2f2;color:#ef4444;pointer-events:none;">âœ• Cancelled</button>`;
        } else if (isDone) {
          btnHTML = `<button class="complete-btn done" id="btn-${s.id}">âœ“ Completed</button>`;
        } else {
          btnHTML = `<button class="cancel-btn" onclick="openCancelModal(${s.id})">Cancel Stop</button>` +
                    `<button class="complete-btn active" id="btn-${s.id}" onclick="openCompletionModal(${s.id})">Mark Complete</button>`;
        }

        return `
          <div class="stop-card ${isDone ? 'completed' : ''}${isCancelled ? ' cancelled' : ''}">
            <div class="stop-top">
              <div class="stop-number">${isCancelled ? 'âœ•' : isDone ? 'âœ“' : i + 1}</div>
              <div class="stop-details">
                <div>
                  <span class="stop-name">${s.full_name || 'Customer'}</span>
                  ${time ? `<span class="stop-time"> Â· ${time}</span>` : ''}
                </div>
                <div class="stop-service">${serviceIcon} ${(s.customer_type || 'residential') === 'commercial' ? 'Commercial' : 'Residential'} Panel Cleaning</div>
                <a class="stop-address" href="${mapsUrl}" target="_blank">ðŸ“ ${s.address || ''}</a>
                ${phone ? `<a class="stop-phone" href="tel:${phone.replace(/[^0-9+]/g, '')}">ðŸ“ž ${phone}</a>` : ''}
                <div class="stop-tags">
                  <span class="stop-tag">${panels} panels</span>
                  ${amount ? `<span class="stop-tag price">${amount}</span>` : ''}
                </div>
                ${s.customer_notes ? `<div class="stop-notes customer">ðŸ‘¤ ${s.customer_notes}</div>` : ''}
                ${s.job_notes ? `<div class="stop-notes job">ðŸ“ ${s.job_notes}</div>` : ''}
              </div>
            </div>
            ${btnHTML}
          </div>`;
      }).join('');

      document.getElementById('app').innerHTML = `
        <div class="header">
          <h1>â˜€ï¸ Sunton Solutions</h1>
          <div class="subtitle">Solar Panel Cleaning</div>
        </div>
        <div class="route-info">
          <div class="route-name">${route.name || 'Route'}</div>
          <div class="route-date">ðŸ“… ${scheduledDate}</div>
        </div>
        <div class="progress-bar-wrap">
          <div class="progress-text">${completed} of ${total} stops completed</div>
          <div class="progress-bar"><div class="progress-fill" style="width: ${pct}%"></div></div>
        </div>
        <div class="stops-list">
          ${stopsHTML}
        </div>
        ${gapFillActive && !gapFillConfirmed ? '<div class="gap-fill-banner"><h3>â³ Gap Fill In Progress</h3><p>Stand by for dispatch instructions</p></div>' : ''}
        ${gapFillConfirmed ? `<div class="gap-fill-confirmed"><h3>âœ… Gap Fill Confirmed</h3><div class="detail-row"><span>Customer</span><span>${gapFillConfirmed.customer_name || ''}</span></div><div class="detail-row"><span>Address</span><span>${gapFillConfirmed.address || ''}</span></div><div class="detail-row"><span>Time</span><span>${gapFillConfirmed.time || ''}</span></div></div>` : ''}
        ${completed === total && total > 0 ? '<div class="all-done">ðŸŽ‰ All stops completed!</div>' : ''}
      `;
    }

    loadRoute();
  </script>
</body>
</html>
