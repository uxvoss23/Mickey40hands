<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Route - Sunton Solutions</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f1f5f9;
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
    }
    .header {
      background: #4f46e5;
      color: white;
      padding: 20px 16px 16px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header h1 { font-size: 18px; font-weight: 700; margin-bottom: 2px; }
    .header .subtitle { font-size: 11px; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }
    .route-info {
      background: white;
      padding: 14px 16px;
      border-bottom: 1px solid #e2e8f0;
    }
    .route-name { font-size: 17px; font-weight: 700; color: #1e293b; }
    .route-date { font-size: 13px; color: #6366f1; font-weight: 500; margin-top: 2px; }
    .progress-bar-wrap {
      background: white;
      padding: 10px 16px 14px;
      border-bottom: 2px solid #e2e8f0;
    }
    .progress-text {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 6px;
      font-weight: 500;
    }
    .progress-bar {
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: #22c55e;
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    .stops-list { padding: 12px; }
    .stop-card {
      background: white;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      margin-bottom: 10px;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    .stop-card.completed {
      opacity: 0.6;
      border-color: #bbf7d0;
    }
    .stop-card.completed .stop-number { background: #22c55e; }
    .stop-top { display: flex; }
    .stop-number {
      background: #6366f1;
      color: white;
      min-width: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
      transition: background 0.3s;
    }
    .stop-details { flex: 1; padding: 12px 14px; }
    .stop-name { font-weight: 700; color: #1e293b; font-size: 15px; }
    .stop-time { color: #6366f1; font-weight: 600; font-size: 13px; }
    .stop-service { color: #8b5cf6; font-size: 12px; font-weight: 500; margin-top: 2px; }
    .stop-address {
      display: block;
      color: #3b82f6;
      font-size: 13px;
      margin-top: 4px;
      text-decoration: underline;
    }
    .stop-phone {
      display: inline-block;
      color: #64748b;
      font-size: 13px;
      margin-top: 3px;
      text-decoration: none;
    }
    .stop-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px; }
    .stop-tag {
      background: #f1f5f9;
      border-radius: 4px;
      padding: 3px 8px;
      font-size: 11px;
      color: #64748b;
    }
    .stop-tag.price { background: #f0fdf4; color: #059669; font-weight: 600; }
    .stop-notes {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 6px;
      margin-top: 6px;
    }
    .stop-notes.customer { color: #1e40af; background: #eff6ff; border-left: 3px solid #3b82f6; }
    .stop-notes.job { color: #92400e; background: #fffbeb; border-left: 3px solid #f59e0b; }
    .complete-btn {
      display: block;
      width: calc(100% - 24px);
      margin: 8px 12px 12px;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
    }
    .complete-btn.active {
      background: #22c55e;
      color: white;
    }
    .complete-btn.active:active {
      transform: scale(0.97);
      background: #16a34a;
    }
    .complete-btn.done {
      background: #f0fdf4;
      color: #22c55e;
      pointer-events: none;
    }
    .complete-btn.loading {
      background: #94a3b8;
      color: white;
      pointer-events: none;
    }
    .all-done {
      text-align: center;
      padding: 24px 16px;
      color: #22c55e;
      font-size: 20px;
      font-weight: 700;
    }
    .loading-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
      color: #64748b;
      font-size: 16px;
    }
    .error-screen {
      text-align: center;
      padding: 40px 20px;
      color: #ef4444;
      font-size: 16px;
    }

    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .modal-content {
      background: white;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      border-radius: 20px 20px 0 0;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
      padding-bottom: env(safe-area-inset-bottom, 16px);
    }
    .modal-header {
      position: sticky;
      top: 0;
      background: white;
      padding: 20px 20px 12px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1;
    }
    .modal-header h2 { font-size: 18px; font-weight: 700; color: #1e293b; }
    .modal-close {
      width: 32px; height: 32px;
      border-radius: 50%;
      border: none;
      background: #f1f5f9;
      color: #64748b;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-body { padding: 16px 20px; }
    .modal-section { margin-bottom: 20px; }
    .modal-label {
      font-size: 13px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .modal-label .required {
      color: #ef4444;
      font-size: 11px;
      font-weight: 600;
    }
    .photo-slots-section { margin-bottom: 4px; }
    .photo-slots-title {
      font-size: 11px;
      font-weight: 700;
      color: #475569;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      padding-bottom: 4px;
      border-bottom: 1px solid #e2e8f0;
    }
    .photo-slots-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .photo-slot {
      border: 2px dashed #cbd5e1;
      border-radius: 10px;
      padding: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
      min-height: 90px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      background: #f8fafc;
    }
    .photo-slot:active { background: #eef2ff; border-color: #6366f1; }
    .photo-slot.filled {
      border-style: solid;
      border-color: #22c55e;
      padding: 3px;
      background: white;
    }
    .photo-slot.filled img {
      width: 100%;
      height: 80px;
      object-fit: cover;
      border-radius: 7px;
    }
    .photo-slot-icon { font-size: 22px; margin-bottom: 2px; }
    .photo-slot-label { font-size: 10px; color: #64748b; font-weight: 600; line-height: 1.3; }
    .photo-slot-check { position: absolute; top: 4px; left: 4px; font-size: 14px; }
    .photo-slot-name { font-size: 9px; color: #475569; font-weight: 700; margin-top: 3px; text-align: center; }
    .callout-photos-area { margin-top: 8px; }
    .callout-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }
    .callout-thumb {
      position: relative;
      border-radius: 6px;
      overflow: hidden;
      aspect-ratio: 1;
      border: 2px solid #e2e8f0;
    }
    .callout-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .callout-add-btn {
      border: 2px dashed #cbd5e1;
      border-radius: 6px;
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      cursor: pointer;
      background: #fef2f2;
      transition: all 0.2s;
    }
    .callout-add-btn:active { background: #fee2e2; border-color: #f87171; }
    .photo-remove {
      position: absolute;
      top: 3px;
      right: 3px;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: rgba(239, 68, 68, 0.9);
      color: white;
      border: none;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
    }
    .service-price-card {
      background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
      border: 1.5px solid #bbf7d0;
      border-radius: 10px;
      padding: 12px 14px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .service-price-label { font-size: 12px; color: #64748b; font-weight: 600; }
    .service-price-amount { font-size: 22px; font-weight: 800; color: #059669; }
    .recurring-price-tag {
      font-size: 11px;
      font-weight: 700;
      color: #059669;
      background: #f0fdf4;
      padding: 2px 8px;
      border-radius: 6px;
      margin-left: 6px;
    }
    .recurring-savings {
      font-size: 10px;
      color: #64748b;
      margin-top: 2px;
    }
    .modal-textarea {
      width: 100%;
      min-height: 80px;
      border: 1.5px solid #e2e8f0;
      border-radius: 10px;
      padding: 12px;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      resize: vertical;
      transition: border-color 0.2s;
      color: #1e293b;
    }
    .modal-textarea:focus { outline: none; border-color: #6366f1; }
    .modal-textarea::placeholder { color: #94a3b8; }
    .recurring-options { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .recurring-option {
      padding: 12px;
      border: 1.5px solid #e2e8f0;
      border-radius: 10px;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      color: #64748b;
      background: white;
      font-family: 'Inter', sans-serif;
    }
    .recurring-option:active { transform: scale(0.97); }
    .recurring-option.selected {
      border-color: #6366f1;
      background: #eef2ff;
      color: #4f46e5;
    }
    .modal-submit {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
      margin-top: 8px;
    }
    .modal-submit.enabled {
      background: #22c55e;
      color: white;
    }
    .modal-submit.enabled:active {
      transform: scale(0.97);
      background: #16a34a;
    }
    .modal-submit.disabled {
      background: #e2e8f0;
      color: #94a3b8;
      pointer-events: none;
    }
    .modal-submit.submitting {
      background: #94a3b8;
      color: white;
      pointer-events: none;
    }
    .validation-checklist {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .validation-item {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: 600;
    }
    .validation-item.done { background: #f0fdf4; color: #22c55e; }
    .validation-item.pending { background: #fef2f2; color: #ef4444; }
    .photo-remove {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(239, 68, 68, 0.9);
      color: white;
      border: none;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="modal-root"></div>
  <script>
    const routeId = window.location.pathname.split('/').pop();
    let routeData = null;
    let completedStops = new Set();
    let activeModal = null;
    const PHOTO_SLOTS = [
      { key: 'wide_before', label: 'Wide \u2013 Before', icon: '\ud83c\udfe0' },
      { key: 'closeup_before', label: 'Dirty Close-Up \u2013 Before', icon: '\ud83d\udd0d' },
      { key: 'wide_after', label: 'Wide \u2013 After', icon: '\u2728' },
      { key: 'closeup_after', label: 'Clean Close-Up \u2013 After', icon: '\ud83e\uddfc' }
    ];
    let modalState = { slotPhotos: {}, calloutPhotos: [], inspectionNotes: '', recurringSelection: '' };

    async function loadRoute() {
      const app = document.getElementById('app');
      app.innerHTML = '<div class="loading-screen">Loading route...</div>';
      try {
        const res = await fetch(`/api/routes/${routeId}/tech-view`);
        if (!res.ok) throw new Error('Route not found');
        routeData = await res.json();
        routeData.stops.forEach(s => {
          if (s.completed_at) completedStops.add(s.id);
        });
        render();
      } catch (err) {
        app.innerHTML = '<div class="error-screen">Could not load route. Please check the link and try again.</div>';
      }
    }

    function openCompletionModal(stopId) {
      activeModal = stopId;
      modalState = { slotPhotos: {}, calloutPhotos: [], inspectionNotes: '', recurringSelection: '' };
      renderModal();
    }

    function closeModal() {
      activeModal = null;
      document.getElementById('modal-root').innerHTML = '';
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const maxSize = 800;
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = new Image();
          img.onload = function() {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            if (w > maxSize || h > maxSize) {
              if (w > h) { h = Math.round(h * maxSize / w); w = maxSize; }
              else { w = Math.round(w * maxSize / h); h = maxSize; }
            }
            canvas.width = w;
            canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            resolve(canvas.toDataURL('image/jpeg', 0.7));
          };
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function handleSlotPhoto(slotKey) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        try {
          const base64 = await fileToBase64(file);
          modalState.slotPhotos[slotKey] = base64;
          renderModal();
        } catch (err) {
          alert('Failed to process photo');
        }
      };
      input.click();
    }

    function removeSlotPhoto(slotKey) {
      delete modalState.slotPhotos[slotKey];
      renderModal();
    }

    async function handleAddCallout() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.multiple = true;
      input.onchange = async (e) => {
        const files = Array.from(e.target.files);
        if (!files.length) return;
        for (const file of files) {
          try {
            const base64 = await fileToBase64(file);
            modalState.calloutPhotos.push(base64);
          } catch (err) {
            console.error('Failed to process photo:', err);
          }
        }
        renderModal();
      };
      input.click();
    }

    function removeCallout(index) {
      modalState.calloutPhotos.splice(index, 1);
      renderModal();
    }

    function getAllPhotos() {
      const photos = [];
      PHOTO_SLOTS.forEach(slot => {
        if (modalState.slotPhotos[slot.key]) {
          photos.push({ label: slot.label, data: modalState.slotPhotos[slot.key] });
        }
      });
      modalState.calloutPhotos.forEach((p, i) => {
        photos.push({ label: 'Call-Out ' + (i + 1), data: p });
      });
      return photos;
    }

    function setRecurring(value) {
      modalState.recurringSelection = value;
      renderModal();
    }

    function updateNotes() {
      const el = document.getElementById('modal-inspection-notes');
      if (el) modalState.inspectionNotes = el.value;
    }

    function isModalValid() {
      const filledSlots = Object.keys(modalState.slotPhotos).length;
      return filledSlots >= 4 && modalState.inspectionNotes.trim() && modalState.recurringSelection;
    }

    async function submitCompletion() {
      updateNotes();
      if (!isModalValid()) return;
      const submitBtn = document.getElementById('modal-submit-btn');
      if (submitBtn) { submitBtn.className = 'modal-submit submitting'; submitBtn.textContent = 'Submitting...'; }
      try {
        const res = await fetch(`/api/routes/${routeId}/stops/${activeModal}/complete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            photos: getAllPhotos(),
            inspection_notes: modalState.inspectionNotes.trim(),
            recurring_selection: modalState.recurringSelection
          })
        });
        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Failed');
        }
        completedStops.add(activeModal);
        closeModal();
        render();
      } catch (err) {
        alert('Error: ' + err.message);
        if (submitBtn) { submitBtn.className = 'modal-submit enabled'; submitBtn.textContent = 'Complete Job'; }
      }
    }

    function renderModal() {
      if (!activeModal) return;
      const stop = routeData.stops.find(s => s.id === activeModal);
      if (!stop) return;
      updateNotes();

      const filledSlots = Object.keys(modalState.slotPhotos).length;
      const hasAllSlots = filledSlots >= 4;
      const hasNotes = !!modalState.inspectionNotes.trim();
      const hasRecurring = !!modalState.recurringSelection;
      const valid = hasAllSlots && hasNotes && hasRecurring;

      const servicePrice = stop.amount_paid ? parseFloat(stop.amount_paid) : 0;
      const annualPrice = servicePrice > 0 ? (servicePrice * 0.90).toFixed(2) : null;
      const biannualPrice = servicePrice > 0 ? (servicePrice * 0.85).toFixed(2) : null;
      const annualSavings = servicePrice > 0 ? (servicePrice * 0.10).toFixed(2) : null;
      const biannualSavings = servicePrice > 0 ? (servicePrice * 0.15).toFixed(2) : null;

      const recurringOptions = [
        { value: 'not_offered', label: 'Not Offered', price: null, savings: null },
        { value: 'offered_declined', label: 'Offered - Declined', price: null, savings: null },
        { value: 'signed_annual', label: 'Annual Service', price: annualPrice, savings: annualSavings, discount: '10% off' },
        { value: 'signed_biannual', label: 'Bi-Annual Service', price: biannualPrice, savings: biannualSavings, discount: '15% off' }
      ];

      const slotsHTML = PHOTO_SLOTS.map(slot => {
        const filled = !!modalState.slotPhotos[slot.key];
        if (filled) {
          return '<div class="photo-slot filled" data-slot="' + slot.key + '">' +
            '<span class="photo-slot-check">\u2705</span>' +
            '<img src="' + modalState.slotPhotos[slot.key] + '" alt="' + slot.label + '">' +
            '<button class="photo-remove" data-remove-slot="' + slot.key + '">&times;</button>' +
            '<div class="photo-slot-name">' + slot.label + '</div>' +
          '</div>';
        }
        return '<div class="photo-slot" data-slot="' + slot.key + '">' +
          '<div class="photo-slot-icon">' + slot.icon + '</div>' +
          '<div class="photo-slot-label">' + slot.label + '</div>' +
        '</div>';
      }).join('');

      const calloutsHTML = modalState.calloutPhotos.map((p, i) =>
        '<div class="callout-thumb"><img src="' + p + '" alt="Call-out ' + (i+1) + '"><button class="photo-remove" data-callout-idx="' + i + '">&times;</button></div>'
      ).join('');

      document.getElementById('modal-root').innerHTML = `
        <div class="modal-overlay" onclick="if(event.target===this)closeModal()">
          <div class="modal-content">
            <div class="modal-header">
              <h2>Complete Job</h2>
              <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
              <div style="background:#f8fafc;border-radius:10px;padding:10px 12px;margin-bottom:12px">
                <div style="font-size:14px;font-weight:700;color:#1e293b">${stop.full_name || 'Customer'}</div>
                <div style="font-size:12px;color:#64748b;margin-top:2px">${stop.address || ''}</div>
              </div>

              ${servicePrice > 0 ? `
                <div class="service-price-card">
                  <div class="service-price-label">Service Price</div>
                  <div class="service-price-amount">$${servicePrice.toFixed(2)}</div>
                </div>
              ` : ''}

              <div class="validation-checklist">
                <span class="validation-item ${hasAllSlots ? 'done' : 'pending'}">${hasAllSlots ? '\u2713' : '\u25CB'} Photos (${filledSlots}/4)</span>
                <span class="validation-item ${hasNotes ? 'done' : 'pending'}">${hasNotes ? '\u2713' : '\u25CB'} Notes</span>
                <span class="validation-item ${hasRecurring ? 'done' : 'pending'}">${hasRecurring ? '\u2713' : '\u25CB'} Recurring</span>
              </div>

              <div class="modal-section">
                <div class="modal-label">Required Photos <span class="required">All 4 required</span></div>
                <div class="photo-slots-grid">
                  ${slotsHTML}
                </div>
              </div>

              <div class="modal-section">
                <div class="modal-label">Call-Out Photos <span style="font-size:10px;color:#64748b;font-weight:400">Damaged panels, cracks, pest activity, etc.</span></div>
                <div class="callout-grid">
                  ${calloutsHTML}
                  <div class="callout-add-btn" id="add-callout-btn">
                    <div style="font-size:18px">\u26A0\uFE0F</div>
                    <div style="font-size:9px;color:#64748b;margin-top:2px">Add Issue</div>
                  </div>
                </div>
                ${modalState.calloutPhotos.length > 0 ? '<div style="font-size:11px;color:#64748b;margin-top:4px">' + modalState.calloutPhotos.length + ' call-out photo' + (modalState.calloutPhotos.length !== 1 ? 's' : '') + '</div>' : ''}
              </div>

              <div class="modal-section">
                <div class="modal-label">Inspection Notes <span class="required">Required</span></div>
                <textarea class="modal-textarea" id="modal-inspection-notes" placeholder="Describe the condition of the panels, any issues found, work performed..." oninput="updateNotes();renderValidation();">${modalState.inspectionNotes}</textarea>
              </div>

              <div class="modal-section">
                <div class="modal-label">Recurring Service <span class="required">Required</span></div>
                <div class="recurring-options">
                  ${recurringOptions.map(opt => `
                    <button class="recurring-option ${modalState.recurringSelection === opt.value ? 'selected' : ''}" onclick="setRecurring('${opt.value}')">
                      <div>${opt.label}</div>
                      ${opt.price ? `<div class="recurring-price-tag">$${opt.price}</div><div class="recurring-savings">${opt.discount} &middot; Save $${opt.savings}</div>` : ''}
                    </button>
                  `).join('')}
                </div>
              </div>

              <button id="modal-submit-btn" class="modal-submit ${valid ? 'enabled' : 'disabled'}" onclick="submitCompletion()">
                ${valid ? 'Complete Job' : 'Fill All Required Fields'}
              </button>
            </div>
          </div>
        </div>
      `;

      setTimeout(() => {
        document.querySelectorAll('[data-slot]').forEach(el => {
          const key = el.dataset.slot;
          if (!modalState.slotPhotos[key]) {
            el.addEventListener('click', () => handleSlotPhoto(key));
          }
        });
        document.querySelectorAll('[data-remove-slot]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            removeSlotPhoto(btn.dataset.removeSlot);
          });
        });
        const calloutBtn = document.getElementById('add-callout-btn');
        if (calloutBtn) calloutBtn.addEventListener('click', () => handleAddCallout());
        document.querySelectorAll('[data-callout-idx]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            removeCallout(parseInt(btn.dataset.calloutIdx));
          });
        });
      }, 0);
    }

    function renderValidation() {
      updateNotes();
      const filledSlots = Object.keys(modalState.slotPhotos).length;
      const hasAllSlots = filledSlots >= 4;
      const hasNotes = !!modalState.inspectionNotes.trim();
      const hasRecurring = !!modalState.recurringSelection;
      const valid = hasAllSlots && hasNotes && hasRecurring;
      const items = document.querySelectorAll('.validation-item');
      if (items.length >= 1) {
        items[0].className = `validation-item ${hasAllSlots ? 'done' : 'pending'}`;
        items[0].textContent = `${hasAllSlots ? '\u2713' : '\u25CB'} Photos (${filledSlots}/4)`;
      }
      if (items.length >= 2) {
        items[1].className = `validation-item ${hasNotes ? 'done' : 'pending'}`;
        items[1].textContent = `${hasNotes ? '\u2713' : '\u25CB'} Notes`;
      }
      if (items.length >= 3) {
        items[2].className = `validation-item ${hasRecurring ? 'done' : 'pending'}`;
        items[2].textContent = `${hasRecurring ? '\u2713' : '\u25CB'} Recurring`;
      }
      const btn = document.getElementById('modal-submit-btn');
      if (btn) {
        btn.className = `modal-submit ${valid ? 'enabled' : 'disabled'}`;
        btn.textContent = valid ? 'Complete Job' : 'Fill All Required Fields';
      }
    }

    function render() {
      if (!routeData) return;
      const { route, stops } = routeData;
      const completed = completedStops.size;
      const total = stops.length;
      const pct = total > 0 ? Math.round((completed / total) * 100) : 0;

      const scheduledDate = route.scheduled_date
        ? new Date(route.scheduled_date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })
        : '';

      const stopsHTML = stops.map((s, i) => {
        const isDone = completedStops.has(s.id);
        const time = s.scheduled_time
          ? new Date(`2000-01-01T${s.scheduled_time}`).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })
          : '';
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(s.address || '')}`;
        const phone = s.phone || '';
        const panels = s.panel_count || 0;
        const amount = s.amount_paid ? `$${parseFloat(s.amount_paid).toFixed(2)}` : '';
        const serviceIcon = (s.customer_type || 'residential') === 'commercial' ? 'üè¢' : 'üè†';

        return `
          <div class="stop-card ${isDone ? 'completed' : ''}">
            <div class="stop-top">
              <div class="stop-number">${isDone ? '‚úì' : i + 1}</div>
              <div class="stop-details">
                <div>
                  <span class="stop-name">${s.full_name || 'Customer'}</span>
                  ${time ? `<span class="stop-time"> ¬∑ ${time}</span>` : ''}
                </div>
                <div class="stop-service">${serviceIcon} ${(s.customer_type || 'residential') === 'commercial' ? 'Commercial' : 'Residential'} Panel Cleaning</div>
                <a class="stop-address" href="${mapsUrl}" target="_blank">üìç ${s.address || ''}</a>
                ${phone ? `<a class="stop-phone" href="tel:${phone.replace(/[^0-9+]/g, '')}">üìû ${phone}</a>` : ''}
                <div class="stop-tags">
                  <span class="stop-tag">${panels} panels</span>
                  ${amount ? `<span class="stop-tag price">${amount}</span>` : ''}
                </div>
                ${s.customer_notes ? `<div class="stop-notes customer">üë§ ${s.customer_notes}</div>` : ''}
                ${s.job_notes ? `<div class="stop-notes job">üìù ${s.job_notes}</div>` : ''}
              </div>
            </div>
            ${isDone
              ? `<button class="complete-btn done" id="btn-${s.id}">‚úì Completed</button>`
              : `<button class="complete-btn active" id="btn-${s.id}" onclick="openCompletionModal(${s.id})">Mark Complete</button>`
            }
          </div>`;
      }).join('');

      document.getElementById('app').innerHTML = `
        <div class="header">
          <h1>‚òÄÔ∏è Sunton Solutions</h1>
          <div class="subtitle">Solar Panel Cleaning</div>
        </div>
        <div class="route-info">
          <div class="route-name">${route.name || 'Route'}</div>
          <div class="route-date">üìÖ ${scheduledDate}</div>
        </div>
        <div class="progress-bar-wrap">
          <div class="progress-text">${completed} of ${total} stops completed</div>
          <div class="progress-bar"><div class="progress-fill" style="width: ${pct}%"></div></div>
        </div>
        <div class="stops-list">
          ${stopsHTML}
        </div>
        ${completed === total && total > 0 ? '<div class="all-done">üéâ All stops completed!</div>' : ''}
      `;
    }

    loadRoute();
  </script>
</body>
</html>
