
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>ðŸ›¸ Galactic Navigation System - Alien Customer CRM ðŸ¦•</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; overflow-y: auto; overflow-x: hidden; background: #0a0e27; max-width: 100vw; }

    .pac-container {
      background: #1e293b !important;
      border: 1px solid rgba(139, 92, 246, 0.4) !important;
      border-radius: 0 0 8px 8px !important;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5) !important;
      z-index: 100000 !important;
      font-family: 'Inter', sans-serif !important;
    }
    .pac-item {
      padding: 8px 14px !important;
      border-top: 1px solid rgba(148,163,184,0.1) !important;
      color: #e2e8f0 !important;
      cursor: pointer !important;
      font-size: 13px !important;
      line-height: 1.5 !important;
      background: transparent !important;
    }
    .pac-item:hover, .pac-item-selected {
      background: rgba(139,92,246,0.15) !important;
    }
    .pac-item-query {
      color: #f1f5f9 !important;
      font-weight: 600 !important;
      font-size: 13px !important;
    }
    .pac-matched {
      color: #a78bfa !important;
      font-weight: 700 !important;
    }
    .pac-icon { display: none !important; }
    .pac-item span { color: #94a3b8 !important; }
    
    .custom-marker { background: transparent; border: none; }
    .marker-pin {
      width: 20px; height: 26px; border-radius: 50% 50% 50% 0;
      transform: rotate(-45deg); margin-left: 2px; margin-top: 3px;
      box-shadow: 0 4px 16px rgba(139, 92, 246, 0.5);
      transition: all 0.3s; cursor: pointer;
      position: relative;
    }
    .marker-pin:hover { 
      transform: rotate(-45deg) scale(1.3); 
      box-shadow: 0 6px 24px rgba(139, 92, 246, 0.7);
    }
    .marker-pin.in-route {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important;
      transform: rotate(-45deg) scale(1.2);
    }
    .marker-pin.suggested {
      background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%) !important;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: rotate(-45deg) scale(1.25); }
      50% { transform: rotate(-45deg) scale(1.35); }
    }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes pulse-glow { 
      0%, 100% { 
        box-shadow: 0 0 20px rgba(139, 92, 246, 0.6), 0 0 40px rgba(139, 92, 246, 0.3); 
      } 
      50% { 
        box-shadow: 0 0 30px rgba(139, 92, 246, 0.8), 0 0 60px rgba(139, 92, 246, 0.5); 
      } 
    }
    @keyframes slideInRight { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes pulse-ring {
      0% { transform: translate(-50%, -50%) scale(0.8); opacity: 1; }
      50% { transform: translate(-50%, -50%) scale(1); opacity: 0.6; }
      100% { transform: translate(-50%, -50%) scale(1.2); opacity: 0; }
    }
    @keyframes pulse-dot {
      0%, 100% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.2); }
    }
    @keyframes bounce-arrow-down {
      0%, 100% { transform: translateX(-50%) translateY(0); }
      50% { transform: translateX(-50%) translateY(5px); }
    }
    @keyframes pulse-label {
      0%, 100% { transform: translate(-50%, -100px) scale(1); }
      50% { transform: translate(-50%, -100px) scale(1.05); }
    }
    @keyframes pulse-label-modal {
      0%, 100% { transform: translateX(-50%) scale(1); }
      50% { transform: translateX(-50%) scale(1.05); }
    }
    @keyframes techPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
      50% { box-shadow: 0 0 0 14px rgba(34, 197, 94, 0); }
    }
    
    .leaflet-tooltip {
      background: rgba(10, 14, 39, 0.98) !important;
      border: 1px solid rgba(139, 92, 246, 0.3) !important;
      border-radius: 8px !important;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4) !important;
      padding: 0 !important;
      backdrop-filter: blur(12px) !important;
      color: #f1f5f9 !important;
      max-width: 250px !important;
    }
    
    .leaflet-tooltip-top:before {
      border-top-color: rgba(10, 14, 39, 0.98) !important;
    }
    
    .custom-tooltip {
      max-width: 250px !important;
    }
    
    .leaflet-popup-content-wrapper {
      background: rgba(15, 23, 42, 0.98) !important;
      border: 2px solid rgba(139, 92, 246, 0.3) !important;
      border-radius: 8px !important;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5) !important;
      padding: 8px !important;
      backdrop-filter: blur(20px) !important;
      will-change: transform;
    }
    
    .leaflet-popup {
      margin-bottom: 12px !important;
    }
    
    .leaflet-popup-content {
      margin: 0 !important;
      color: #f1f5f9 !important;
      width: 180px !important;
    }
    
    .leaflet-popup-tip {
      background: rgba(15, 23, 42, 0.98) !important;
    }
    
    /* Prevent map from panning when popup opens */
    .leaflet-container {
      transition: none !important;
    }
    
    .custom-popup .leaflet-popup-close-button {
      color: #94a3b8 !important;
      font-size: 18px !important;
      padding: 4px !important;
      width: 20px !important;
      height: 20px !important;
      line-height: 20px !important;
    }
    
    .custom-popup .leaflet-popup-close-button:hover {
      color: #f1f5f9 !important;
    }
    
    /* Ensure popup content is clickable */
    .leaflet-popup-content-wrapper,
    .leaflet-popup-content {
      pointer-events: auto !important;
    }
    
    /* Style popup buttons on hover */
    .leaflet-popup button:hover {
      opacity: 0.9;
      transform: translateY(-1px);
      transition: all 0.2s ease;
    }
    
    .leaflet-popup a:hover {
      opacity: 0.9;
    }

    .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(99, 102, 241, 0.2)) !important;
      border: 2px solid rgba(139, 92, 246, 0.6) !important;
      backdrop-filter: blur(8px);
      transition: all 0.3s ease;
    }
    
    .marker-cluster-small div, .marker-cluster-medium div, .marker-cluster-large div {
      background: linear-gradient(135deg, #8b5cf6, #6366f1) !important;
      color: white;
      font-family: 'Inter', sans-serif;
      font-weight: 700;
      font-size: 14px;
    }
    
    .glass-card {
      background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(20px);
      border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 24px;
      transition: all 0.3s;
      box-shadow: 0 0 10px rgba(139, 92, 246, 0.1);
    }
    .glass-card:hover { 
      border-color: rgba(139, 92, 246, 0.4);
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
    }
    
    .button-primary {
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      border: none; border-radius: 16px; padding: 12px 20px;
      color: white; font-weight: 600; font-size: 14px; cursor: pointer;
      display: inline-flex; align-items: center; gap: 8px;
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.5), 0 4px 16px rgba(99, 102, 241, 0.3);
      transition: all 0.3s;
    }
    .button-primary:hover:not(:disabled) { 
      transform: translateY(-2px); 
      box-shadow: 0 0 30px rgba(139, 92, 246, 0.8), 0 6px 20px rgba(99, 102, 241, 0.5);
    }
    .button-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .button-secondary {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 16px; padding: 12px 20px;
      color: #e2e8f0; font-weight: 600; font-size: 14px;
      cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
      transition: all 0.3s;
      box-shadow: 0 0 10px rgba(139, 92, 246, 0.2);
    }
    .button-secondary:hover { 
      background: rgba(139, 92, 246, 0.2); 
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.4);
    }
    
    .input-field {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 16px; padding: 14px 18px;
      color: #f1f5f9; font-size: 14px; font-family: 'Inter', sans-serif;
      outline: none; width: 100%; transition: all 0.3s;
    }
    .input-field:focus { border-color: #8b5cf6; box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1); }
    .input-field::placeholder { color: #64748b; }
    
    textarea.input-field { resize: vertical; min-height: 80px; }
    
    .upload-area {
      border: 2px dashed rgba(139, 92, 246, 0.3);
      border-radius: 24px; padding: 32px; text-align: center;
      cursor: pointer; transition: all 0.3s;
      background: rgba(139, 92, 246, 0.05);
    }
    .upload-area:hover { border-color: #8b5cf6; transform: translateY(-2px); }
    .upload-area.dragover { border-color: #8b5cf6; background: rgba(139, 92, 246, 0.15); }
    
    input[type="file"] { display: none; }
    
    .route-stop-item {
      padding: 16px; border-radius: 16px;
      background: rgba(15, 23, 42, 0.4);
      margin-bottom: 8px; border: 1px solid rgba(34, 197, 94, 0.3);
      cursor: grab; transition: all 0.2s;
      user-select: none;
    }
    .route-stop-item:active { cursor: grabbing; }
    .route-stop-item.dragging { opacity: 0.5; }
    .route-stop-item:hover { background: rgba(34, 197, 94, 0.1); }
    
    .suggested-customer-item {
      padding: 16px; border-radius: 16px;
      background: rgba(15, 23, 42, 0.4);
      margin-bottom: 8px; border: 1px solid rgba(245, 158, 11, 0.3);
      cursor: pointer; transition: all 0.2s;
    }
    .suggested-customer-item:hover { background: rgba(245, 158, 11, 0.1); transform: translateX(4px); }
    
    /* Recurring Job Styles */
    .recurring-job {
      border: 2px solid rgba(59, 130, 246, 0.5) !important;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(99, 102, 241, 0.05)) !important;
      position: relative;
    }
    .recurring-job::before {
      content: 'ðŸ”„';
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 16px;
      z-index: 1;
    }
    
    .tab-button {
      background: transparent; border: none;
      border-bottom: 2px solid transparent;
      padding: 6px 12px; color: #64748b;
      font-weight: 600; font-size: 11px; cursor: pointer;
      transition: all 0.3s;
    }
    .tab-button:hover { color: #94a3b8; }
    .tab-button.active { color: #8b5cf6; border-bottom-color: #8b5cf6; }
    
    .distance-badge {
      display: inline-flex; align-items: center; gap: 4px;
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(99, 102, 241, 0.2));
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 12px; padding: 4px 10px;
      font-size: 11px; font-weight: 600; color: #c4b5fd;
    }
    
    .scrollbar-custom::-webkit-scrollbar { width: 8px; }
    .scrollbar-custom::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.3); border-radius: 4px; }
    .scrollbar-custom::-webkit-scrollbar-thumb { background: rgba(139, 92, 246, 0.4); border-radius: 4px; }
    
    .modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px);
      display: flex; align-items: center; justify-content: center;
      z-index: 10000; animation: fadeIn 0.3s;
    }
    
    .modal-content {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95));
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 32px; padding: 32px; max-width: 500px; width: 90%;
      max-height: 80vh; overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: slideUp 0.3s;
    }
    
    .route-number {
      width: 32px; height: 32px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border-radius: 12px; display: flex;
      align-items: center; justify-content: center;
      font-weight: 700; font-size: 14px; color: white;
    }
    
    .stat-card { animation: slideUp 0.5s ease-out; }
    
    .status-badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 12px; border-radius: 12px;
      font-size: 12px; font-weight: 600;
    }
    .status-new { background: rgba(59, 130, 246, 0.2); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.3); }
    .status-customered { background: rgba(245, 158, 11, 0.2); color: #fcd34d; border: 1px solid rgba(245, 158, 11, 0.3); }
    .status-nurturing { background: rgba(139, 92, 246, 0.2); color: #c4b5fd; border: 1px solid rgba(139, 92, 246, 0.3); }
    .status-qualified { background: rgba(34, 197, 94, 0.2); color: #86efac; border: 1px solid rgba(34, 197, 94, 0.3); }
    
    select, textarea {
      background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 16px; padding: 14px 18px; color: #f1f5f9;
      font-size: 14px; font-family: 'Inter', sans-serif;
      outline: none; width: 100%; transition: all 0.3s;
    }
    select { cursor: pointer; }
    select:focus, textarea:focus { border-color: #8b5cf6; box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1); }

    /* Pipeline table */
    .pipeline-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(15, 23, 42, 0.6);
      border-radius: 16px;
      overflow: hidden;
    }
    
    .pipeline-table thead {
      background: rgba(139, 92, 246, 0.2);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .pipeline-table th {
      padding: 16px;
      text-align: left;
      font-size: 13px;
      font-weight: 700;
      color: #c4b5fd;
      border-bottom: 2px solid rgba(139, 92, 246, 0.3);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .pipeline-table td {
      padding: 16px;
      font-size: 14px;
      color: #e2e8f0;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }
    
    .pipeline-table tbody tr {
      transition: all 0.2s;
    }
    
    .pipeline-table tbody tr:hover {
      background: rgba(139, 92, 246, 0.1);
    }
    
    .pipeline-table input[type="text"],
    .pipeline-table textarea,
    .pipeline-table select {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 8px;
      padding: 8px 12px;
      color: #f1f5f9;
      font-size: 13px;
      width: 100%;
    }
    
    .pipeline-table input[type="text"]:focus,
    .pipeline-table textarea:focus,
    .pipeline-table select:focus {
      border-color: #8b5cf6;
      outline: none;
    }

    .pipeline-table input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="root"><div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#0a0e27;color:#a78bfa;font-family:Inter,sans-serif;font-size:18px;flex-direction:column;gap:16px"><div style="font-size:48px">ðŸ›¸</div><div>Loading Galactic Navigation System...</div><div style="width:200px;height:4px;background:rgba(139,92,246,0.2);border-radius:4px;overflow:hidden"><div style="width:60%;height:100%;background:linear-gradient(90deg,#8b5cf6,#a78bfa);border-radius:4px;animation:loadbar 1.5s ease-in-out infinite"></div></div></div></div>
  <style>@keyframes loadbar{0%{width:20%;margin-left:0}50%{width:60%;margin-left:20%}100%{width:20%;margin-left:80%}}</style>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const HOME_BASE_ADDRESS = "1444 Mountain Air Trail, Fort Worth, TX 76131";

    const API_BASE = '';  // Same origin
    const apiFetch = async (endpoint, options = {}) => {
      const { headers: customHeaders, ...restOptions } = options;
      const response = await fetch(`${API_BASE}/api${endpoint}`, {
        headers: { 'Content-Type': 'application/json', ...customHeaders },
        ...restOptions
      });
      if (!response.ok) throw new Error(`API Error: ${response.status}`);
      return response.json();
    };

    const CustomerMap = () => {
      // PERFORMANCE: Disable logs in production mode
      const PRODUCTION_MODE = true; // Set to true to boost performance
      const log = PRODUCTION_MODE ? () => {} : console.log;
      
      const [activeCustomerType, setActiveCustomerType] = useState('all');
      const defaultTabs = [
        { key: 'all', label: 'All' },
        { key: 'residential', label: 'Residential' },
        { key: 'commercial', label: 'Commercial' },
        { key: 'partner', label: 'Partners' },
        { key: 'hoa', label: 'HOAs' }
      ];
      const [customTypeTabs, setCustomTypeTabs] = useState(() => {
        try { return JSON.parse(localStorage.getItem('customTypeTabs') || '[]'); } catch { return []; }
      });
      const [showAddTabInput, setShowAddTabInput] = useState(false);
      const [newTabName, setNewTabName] = useState('');
      const allTypeTabs = [...defaultTabs, ...customTypeTabs];
      const [currentView, setCurrentView] = useState('dashboard');
      const [uploadedFiles, setUploadedFiles] = useState([]); // Array of {id, name, customers, visible}
      const [savedLists, setSavedLists] = useState([]); // Array of {id, name, customers, visible, type: 'list'}
      const [showRecurringList, setShowRecurringList] = useState(false); // Toggle for auto-generated recurring list
      const [customers, setCustomers] = useState([]);
      const [filteredCustomers, setFilteredCustomers] = useState([]);
      const [verifying, setVerifying] = useState(false);
      const [verificationProgress, setVerificationProgress] = useState({ current: 0, total: 0 });
      const [selectedCustomer, setSelectedCustomer] = useState(null);
      const [verificationEditMode, setVerificationEditMode] = useState(false);
      const [hoveredCustomer, setHoveredCustomer] = useState(null);
      const [hoveredPrefDay, setHoveredPrefDay] = useState(null);
      const [hoveredPrefTime, setHoveredPrefTime] = useState(null);
      const [hoveredUnroutedDays, setHoveredUnroutedDays] = useState([]);
      const [dayPickerPopup, setDayPickerPopup] = useState(null);
      const [verifyingCustomer, setVerifyingCustomer] = useState(false);
      const [visibleCustomers, setVisibleCustomers] = useState([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [dragOver, setDragOver] = useState(false);
      const [searchQuery, setSearchQuery] = useState('');
      const [cityFilter, setCityFilter] = useState('');
      const [stateFilter, setStateFilter] = useState('');
      const [zipFilter, setZipFilter] = useState('');
      const [showHeatMap, setShowHeatMap] = useState(false);
      const [radiusMode, setRadiusMode] = useState(false);
      const [awaitingMapClick, setAwaitingMapClick] = useState(false);
      const [showSaveModal, setShowSaveModal] = useState(false);
      const [showSaveListModal, setShowSaveListModal] = useState(false);
      const [showFilterPanel, setShowFilterPanel] = useState(true);
      const [showExistingJobModal, setShowExistingJobModal] = useState(false);
      const [existingJobData, setExistingJobData] = useState({
        totalPanels: '',
        lastServiceDate: '',
        amountPaid: '',
        isRecurring: false,
        nextScheduledDate: ''
      });
      const [listName, setListName] = useState('');
      const [radiusAddress, setRadiusAddress] = useState('');
      const [radiusMiles, setRadiusMiles] = useState(10);
      const [drawMode, setDrawMode] = useState(false);
      const [drawnArea, setDrawnArea] = useState(null);
      const [drawnPolygon, setDrawnPolygon] = useState(null);
      const [lastServiceFilter, setLastServiceFilter] = useState(''); // '', '3months', '6months', '12months'
      const [referencePoint, setReferencePoint] = useState(null);
      const [referenceAddress, setReferenceAddress] = useState('');
      const [homeBase, setHomeBase] = useState(null);
      const [techEmail, setTechEmail] = useState(() => localStorage.getItem('techEmail') || 'solarcleaning@suntonsolutions.com');
      const [sendingEmail, setSendingEmail] = useState(false);
      const [mapBounds, setMapBounds] = useState(null);
      const [route, setRoute] = useState([]); // Keep for backward compatibility
      const [routesByDay, setRoutesByDay] = useState({}); // New: routes organized by day
      const [unsavedRouteChanges, setUnsavedRouteChanges] = useState(false);
      const [unsavedRouteDays, setUnsavedRouteDays] = useState({}); // Track which days have unsaved edits: { 'dateString': true }
      const [pendingViewChange, setPendingViewChange] = useState(null);
      const [pendingDateChange, setPendingDateChange] = useState(null); // Track pending date switch when warning shown
      const [routePlannerEditMode, setRoutePlannerEditMode] = useState(false);
      const [multiSelectDays, setMultiSelectDays] = useState(false);
      const [showMonthCalendar, setShowMonthCalendar] = useState(false);
      const [suggestedCustomers, setSuggestedCustomers] = useState([]);
      const [savedRoutes, setSavedRoutes] = useState([]);
      const [failedCustomers, setFailedCustomers] = useState([]);
      const [showFailedCustomersModal, setShowFailedCustomersModal] = useState(false);
      const [pipelineCustomers, setPipelineCustomers] = useState([]);
      const [selectedPipeline, setSelectedPipeline] = useState([]);
      const [activeSorts, setActiveSorts] = useState([]); // array of sort keys: 'lastService', 'distance', 'panels', 'zip'
      const [sortOrder, setSortOrder] = useState('asc'); // 'asc', 'desc'
      const [selectedDate, setSelectedDate] = useState(new Date());
      const [savedViewDays, setSavedViewDays] = useState({}); // Track which days show saved view: { 'dateString': true/false }
      const [selectedRouteIndexByDay, setSelectedRouteIndexByDay] = useState({}); // Track which route is selected for each day: { 'dateString': 0, 1, 2... }
      const [weekStart, setWeekStart] = useState(() => {
        const today = new Date();
        const day = today.getDay();
        const diff = today.getDate() - day; // Get Monday
        return new Date(today.setDate(diff));
      });
      const [showCalendar, setShowCalendar] = useState(true);
      const [showTip, setShowTip] = useState(true);
      const [calendarViewMode, setCalendarViewMode] = useState('week'); // 'week' or 'month'
      const [statusFilter, setStatusFilter] = useState('scheduled'); // Default to scheduled view
      const [preferredDateFilter, setPreferredDateFilter] = useState([]); // Array of dates
      const [preferredTimeFilter, setPreferredTimeFilter] = useState([]); // Array of time windows
      const [showDayView, setShowDayView] = useState(false);
      const [dayViewDate, setDayViewDate] = useState(null);
      // Scheduled map view: show routes on map by week or month
      const [scheduledMapView, setScheduledMapView] = useState('week'); // 'week' or 'both'
      const [scheduledViewWeekStart, setScheduledViewWeekStart] = useState(() => {
        const d = new Date(); d.setDate(d.getDate() - d.getDay()); d.setHours(0,0,0,0); return d;
      });
      const [showNeedScheduling, setShowNeedScheduling] = useState(false); // Toggle unscheduled overlay
      const [showNext2Weeks, setShowNext2Weeks] = useState(false);
      const [focusedDays, setFocusedDays] = useState([(() => { const d = new Date(); d.setHours(0,0,0,0); return d; })()]); // Default to today's route
      const [visibleStartHour, setVisibleStartHour] = useState(8); // 8am default
      const [visibleEndHour, setVisibleEndHour] = useState(17); // 5pm default
      const [filterWeekStart, setFilterWeekStart] = useState(() => {
        const today = new Date();
        const day = today.getDay();
        const diff = today.getDate() - day;
        return new Date(today.setDate(diff));
      });
      const [filterCity, setFilterCity] = useState('');
      const [filterState, setFilterState] = useState('');
      const [filterZip, setFilterZip] = useState('');
      const [verificationFilter, setVerificationFilter] = useState('all'); // 'all', 'verified', 'no-solar', 'unverified'
      const [activeFilters, setActiveFilters] = useState({
        verifiedSolar: false,
        existingJob: false,
        recurring: false,
        minPanels: '',
        lastService: ''
      });
      const [routeName, setRouteName] = useState('');
      const [editingRouteId, setEditingRouteId] = useState(null);
      const [editingSavedRouteId, setEditingSavedRouteId] = useState(null); // Track which saved route is being edited on the map
      const [editedRouteName, setEditedRouteName] = useState('');
      const [editingCustomerNotes, setEditingCustomerNotes] = useState(null); // {routeId, customerId}
      const [editedNotes, setEditedNotes] = useState('');
      const [expandedSavedRouteId, setExpandedSavedRouteId] = useState(null);
      const [draggedIndex, setDraggedIndex] = useState(null);
      const [stats, setStats] = useState({
        total: 0,
        visible: 0,
        states: 0,
        avgDistance: 0,
        totalRouteDistance: 0
      });
      const [showAllMarkers, setShowAllMarkers] = useState(false); // Performance: toggle showing all 20k+ markers
      
      // PROPERTY DATA: Stories, Street View, etc.
      const [propertyDataCache, setPropertyDataCache] = useState({}); // Cache property lookups
      const [streetViewCache, setStreetViewCache] = useState({}); // Cache street view images
      const [showStreetView, setShowStreetView] = useState(true); // Toggle street view in popups
      const [propertyApiKey, setPropertyApiKey] = useState(localStorage.getItem('propertyApiKey') || ''); // ATTOM API key (optional)
      
      // VERIFICATION SYSTEM - Property Type & Solar Permits
      const [verificationEnabled, setVerificationEnabled] = useState(true);
      const [verificationResults, setVerificationResults] = useState({}); // customerID -> verification data
      const [autoVerify, setAutoVerify] = useState(false); // Auto-verify on customer add

      const [showJobModal, setShowJobModal] = useState(false);
      const [showCustomerProfile, setShowCustomerProfile] = useState(false);
      const [profileCustomer, setProfileCustomer] = useState(null);
      const [confirmDeleteJobId, setConfirmDeleteJobId] = useState(null);
      const [confirmDeleteCustomer, setConfirmDeleteCustomer] = useState(false);
      const [newJobNote, setNewJobNote] = useState('');
      const [newCustomerNote, setNewCustomerNote] = useState('');


      const [pipelineSortColumn, setPipelineSortColumn] = useState(null); // Column index being sorted
      const [pipelineSortOrder, setPipelineSortOrder] = useState('asc'); // 'asc' or 'desc'
      const [pipelineFilters, setPipelineFilters] = useState({});
      const [pipelineGlobalSearch, setPipelineGlobalSearch] = useState('');
      const [pipelineQuickFilter, setPipelineQuickFilter] = useState('all');
      const [showPipelineFilterPanel, setShowPipelineFilterPanel] = useState(false);

      const allColumnKeys = ['name','status','phone','email','address','city','state','zip','panelCount','scheduledDate','preferredDate','lastServiceDate','amountPaid','employee','isRecurring','notes'];
      const defaultHiddenColumns = [];

      const getHiddenColumnsForType = (type) => {
        try {
          const saved = localStorage.getItem('dbViewHiddenColumns_' + type);
          if (saved) return JSON.parse(saved);
          const legacy = localStorage.getItem('dbViewHiddenColumns');
          if (legacy) return JSON.parse(legacy);
          return defaultHiddenColumns;
        } catch(e) { return defaultHiddenColumns; }
      };

      const [savedHiddenColumns, setSavedHiddenColumns] = useState(() => getHiddenColumnsForType(activeCustomerType));
      const [tempUnhiddenColumns, setTempUnhiddenColumns] = useState([]);
      const [showColumnManager, setShowColumnManager] = useState(false);
      const [editingCell, setEditingCell] = useState(null);
      const [editingCellValue, setEditingCellValue] = useState('');

      useEffect(() => {
        if (currentView === 'pipeline') {
          setSavedHiddenColumns(getHiddenColumnsForType(activeCustomerType));
          setTempUnhiddenColumns([]);
        }
      }, [activeCustomerType, currentView]);

      const saveColumnView = (hidden) => {
        setSavedHiddenColumns(hidden);
        localStorage.setItem('dbViewHiddenColumns_' + activeCustomerType, JSON.stringify(hidden));
      };

      const getVisibleColumns = () => {
        const hidden = savedHiddenColumns.filter(k => !tempUnhiddenColumns.includes(k));
        return allColumnKeys.filter(k => !hidden.includes(k));
      };
      const [showNewCustomerForm, setShowNewCustomerForm] = useState(false);
      const [csvUploadStatus, setCsvUploadStatus] = useState('');
      const [newCustomerData, setNewCustomerData] = useState({
        firstName: '', lastName: '', phone: '', email: '',
        address: '', city: '', state: '', zip: '',
        addJob: false, panels: '0', notes: ''
      });
      const [quickAddJobPopup, setQuickAddJobPopup] = useState(null);
      const [jobRefreshKey, setJobRefreshKey] = useState(0);
      const [quickJobData, setQuickJobData] = useState({
        serviceType: '', notes: '', panels: '0',
        pricePerPanel: '9', totalPrice: '0', priceOverridden: false,
        preferredDays: [], preferredTime: '', technician: 'Chance T',
        isRecurring: false, recurrenceInterval: '', nextServiceDate: ''
      });
      
      // Job Creation Modal State
      const [jobForm, setJobForm] = useState({
        customerId: null,
        customerName: '',
        isNewCustomer: false,
        firstName: '',
        lastName: '',
        address: '',
        phone: '',
        email: '',
        panelCount: '',
        pricingTier: '2', // Default to Tier 2
        customPrice: '',
        useCustomPrice: false,
        calculatedPrice: 0,
        jobType: 'Panel Cleaning',
        scheduledDate: '',
        scheduledTime: '',
        isRecurring: false,
        recurringFrequency: '12', // months
        assignedEmployee: 'Chance Thompson',
        notes: ''
      });
      const [customerSearchQuery, setCustomerSearchQuery] = useState('');

      const openJobPopupForCustomer = (customer) => {
        const panels = String(customer.panelCount || customer.totalPanels || '0');
        setQuickJobData({
          serviceType: '', notes: '', panels: panels,
          pricePerPanel: '9', totalPrice: String((parseInt(panels) || 0) * 9),
          priceOverridden: false, preferredDays: [], preferredTime: '', technician: 'Chance T',
          isRecurring: false, recurrenceInterval: '', nextServiceDate: '',
          editingJobId: null
        });
        setQuickAddJobPopup({
          customerId: customer.id,
          customerName: customer.name || 'Customer',
          customerPhone: customer.phone || customer.phoneNumber || '',
          customerEmail: customer.email || '',
          customerAddress: customer.address || '',
          lat: customer.lat, lng: customer.lng
        });
      };

      const editJobFromHistory = (job, customer) => {
        const days = (job.preferredDays || '').split(',').filter(Boolean);
        const panels = String(job.panelCount || customer.panelCount || customer.totalPanels || '0');
        const ppp = String(job.pricePerPanel || 9);
        const price = String(job.price || (parseInt(panels) || 0) * (parseFloat(ppp) || 9));
        let cleanNotes = (job.notes || '');
        cleanNotes = cleanNotes.replace(/Preferred days?:\s*[^|]*/gi, '').replace(/Preferred time:\s*[^|]*/gi, '').replace(/Technician:\s*[^|]*/gi, '');
        cleanNotes = cleanNotes.split('|').map(s => s.trim()).filter(Boolean).join(' | ');
        setQuickJobData({
          serviceType: job.jobDescription || '',
          notes: cleanNotes,
          panels: panels,
          pricePerPanel: ppp,
          totalPrice: price,
          priceOverridden: false,
          preferredDays: days,
          preferredTime: job.preferredTime || '',
          technician: job.technician || 'Chance T',
          isRecurring: job.isRecurring || false,
          recurrenceInterval: job.recurrenceInterval || '',
          nextServiceDate: job.nextServiceDate || job.scheduledDate || job.date || '',
          editingJobId: job.jobId || null
        });
        setQuickAddJobPopup({
          customerId: customer.id,
          customerName: customer.name || customer.full_name || 'Customer',
          customerPhone: customer.phone || customer.phoneNumber || '',
          customerEmail: customer.email || '',
          customerAddress: customer.address || '',
          lat: customer.lat, lng: customer.lng
        });
      };

      const customerHasOpenJobs = (customer) => {
        if (!customer) return false;
        if (customer.activeJobCount > 0) return true;
        if (customer.existingJob) return true;
        if (customer.jobPrice > 0) return true;
        if (customer.totalJobCount > 0) {
          const completed = (customer.serviceHistory || []).filter(j => j.status === 'completed' || j.status === 'cancelled').length;
          if (completed < customer.totalJobCount) return true;
        }
        const fullCustomer = customers.find(c => c.id === customer.id);
        if (fullCustomer && fullCustomer !== customer) {
          if (fullCustomer.activeJobCount > 0) return true;
          if (fullCustomer.existingJob) return true;
        }
        return false;
      };
      const getStatusAfterUnschedule = (customer) => customerHasOpenJobs(customer) ? 'unscheduled' : '';
      const [customerSearchResults, setCustomerSearchResults] = useState([]);
      const [geocoding, setGeocoding] = useState(false);
      const [addressSuggestions, setAddressSuggestions] = useState([]);
      const [searchingAddress, setSearchingAddress] = useState(false);
      
      const mapRef = useRef(null);
      const mapInstanceRef = useRef(null);
      const prevSelectedDateRef = useRef(null);
      const markerClusterRef = useRef(null);
      const heatLayerRef = useRef(null);
      const radiusCircleRef = useRef(null);
      const referenceMarkerRef = useRef(null);
      const homeBaseMarkerRef = useRef(null);
      const routeLinesRef = useRef([]);
      const fileInputRef = useRef(null);
      const markersMapRef = useRef(new Map());
      const techMarkerLayersRef = useRef({});
      const [activeTechnicians, setActiveTechnicians] = useState({});

      // Pricing Tiers
      const PRICING_TIERS = {
        '1': 9,  // Tier 1: $9/panel
        '2': 8,  // Tier 2: $8/panel
        '3': 7,  // Tier 3: $7/panel
        '4': 6   // Tier 4: $6/panel
      };

      // CSV Row Parser - handles quoted values, escaped quotes, values with spaces
      const parseCSVRow = (row) => {
        const result = [];
        let current = '';
        let inQuotes = false;

        for (let i = 0; i < row.length; i++) {
          const char = row[i];
          const nextChar = row[i + 1];

          if (inQuotes) {
            if (char === '"' && nextChar === '"') {
              current += '"';
              i++;
            } else if (char === '"') {
              inQuotes = false;
            } else {
              current += char;
            }
          } else {
            if (char === '"') {
              inQuotes = true;
            } else if (char === ',') {
              result.push(current.trim());
              current = '';
            } else {
              current += char;
            }
          }
        }
        result.push(current.trim());
        return result;
      };

      // Load saved data
      useEffect(() => {
        const saved = localStorage.getItem('savedRoutes');

        if (saved) {
          const parsedRoutes = JSON.parse(saved);
          setSavedRoutes(parsedRoutes);
          const savedDays = {};
          parsedRoutes.forEach(r => {
            if (r.scheduledDate) {
              savedDays[new Date(r.scheduledDate).toDateString()] = true;
            }
          });
          setSavedViewDays(savedDays);

          const enrichRoutesWithJobData = async () => {
            const enriched = await Promise.all(parsedRoutes.map(async (route) => {
              if (!route.customers || route.customers.length === 0) return route;
              const enrichedCustomers = await Promise.all(route.customers.map(async (c) => {
                try {
                  const data = await apiFetch('/jobs?customer_id=' + c.id);
                  if (data && data.jobs && data.jobs.length > 0) {
                    const activeJob = data.jobs.find(j => j.status !== 'completed' && j.status !== 'cancelled');
                    if (activeJob) {
                      return { 
                        ...c, 
                        jobPrice: parseFloat(activeJob.price) || c.jobPrice || 0,
                        panelCount: parseInt(activeJob.panel_count || activeJob.panelCount) || c.panelCount || c.totalPanels || 0,
                        totalPanels: parseInt(activeJob.panel_count || activeJob.panelCount) || c.panelCount || c.totalPanels || 0,
                        amountPaid: parseFloat(activeJob.price) || c.amountPaid || 0,
                        jobDescription: activeJob.job_description || activeJob.jobDescription || c.jobDescription || c.job_description || '',
                        isRecurring: activeJob.is_recurring || activeJob.isRecurring || c.isRecurring || false,
                        scheduledTime: c.scheduledTime || activeJob.scheduled_time || activeJob.scheduledTime || '',
                        jobNotes: activeJob.notes || ''
                      };
                    }
                  }
                } catch (e) {}
                return c;
              }));
              return { ...route, customers: enrichedCustomers };
            }));
            setSavedRoutes(enriched);
          };
          enrichRoutesWithJobData();
        }
        setTimeout(async () => {
          const count = await loadFromDatabase();
          if (count > 0) {
            console.log(`ðŸ“¦ Auto-loaded ${count} customers from database`);
          }
        }, 500);
      }, []);

      const savedRoutesInitialized = React.useRef(false);
      useEffect(() => {
        if (!savedRoutesInitialized.current) {
          savedRoutesInitialized.current = true;
          return;
        }
        localStorage.setItem('savedRoutes', JSON.stringify(savedRoutes));
      }, [savedRoutes]);

      const refreshRouteStopStatus = async () => {
        const sentRoutes = savedRoutes.filter(r => r.sentToTech && (r.dbRouteId || r.id));
        if (sentRoutes.length === 0) return;
        try {
          const updates = await Promise.all(sentRoutes.map(async (sr) => {
            const routeDbId = sr.dbRouteId || sr.id;
            const idNum = parseInt(routeDbId);
            if (isNaN(idNum) || idNum > 2147483647) return null;
            const data = await apiFetch(`/routes/${routeDbId}/tech-view`);
            if (!data || !data.stops) return null;
            const completedStopCustomerIds = new Set(
              data.stops.filter(s => s.completed_at).map(s => s.customer_id)
            );
            const completedCount = completedStopCustomerIds.size;
            const totalCount = data.stops.length;
            return {
              routeId: sr.id,
              completedStopIds: completedStopCustomerIds,
              completedCount,
              totalCount,
              allComplete: completedCount === totalCount && totalCount > 0,
              completedAt: data.route?.completed_at || null
            };
          }));
          setSavedRoutes(prev => prev.map(r => {
            const update = updates.find(u => u && u.routeId === r.id);
            if (!update) return r;
            const updatedCustomers = r.customers.map(c => ({
              ...c,
              _stopCompleted: update.completedStopIds.has(c.id)
            }));
            return {
              ...r,
              customers: updatedCustomers,
              _completedStopCount: update.completedCount,
              _totalStopCount: update.totalCount,
              completedAt: update.completedAt || r.completedAt
            };
          }));
        } catch (err) {
          console.error('Error refreshing stop status:', err);
        }
      };

      useEffect(() => {
        if (currentView === 'history') {
          refreshRouteStopStatus();
        }
      }, [currentView]);

      // Update calculated price when panel count or tier changes
      useEffect(() => {
        if (!jobForm.useCustomPrice && jobForm.panelCount) {
          const calculated = calculateJobPrice(parseInt(jobForm.panelCount), jobForm.pricingTier);
          setJobForm(prev => ({ ...prev, calculatedPrice: calculated }));
        }
      }, [jobForm.panelCount, jobForm.pricingTier, jobForm.useCustomPrice]);

      // Search customers when search query changes
      useEffect(() => {
        searchCustomers(customerSearchQuery);
      }, [customerSearchQuery]);


      // NOTE: filteredCustomers is managed by the unified filter useEffect below (search for "UNIFIED FILTER")

      // Day colors for scheduled map view
      const DAY_COLORS = {
        0: { color: '#ef4444', label: 'Sun', bg: 'rgba(239, 68, 68, 0.3)' },  // Red
        1: { color: '#f97316', label: 'Mon', bg: 'rgba(249, 115, 22, 0.3)' },  // Orange
        2: { color: '#eab308', label: 'Tue', bg: 'rgba(234, 179, 8, 0.3)' },   // Yellow
        3: { color: '#22c55e', label: 'Wed', bg: 'rgba(34, 197, 94, 0.3)' },   // Green
        4: { color: '#3b82f6', label: 'Thu', bg: 'rgba(59, 130, 246, 0.3)' },  // Blue
        5: { color: '#8b5cf6', label: 'Fri', bg: 'rgba(139, 92, 246, 0.3)' },  // Purple
        6: { color: '#ec4899', label: 'Sat', bg: 'rgba(236, 72, 153, 0.3)' }   // Pink
      };

      const formatTime12h = (time24) => {
        if (!time24) return '';
        const [h, m] = time24.split(':').map(Number);
        const ampm = h >= 12 ? 'PM' : 'AM';
        const h12 = h === 0 ? 12 : h > 12 ? h - 12 : h;
        return `${h12}:${String(m).padStart(2, '0')} ${ampm}`;
      };

      // Get customers from saved routes for a date range
      // Includes sentToTech routes for past dates (history/reporting)
      const getScheduledCustomersForRange = (startDate, endDate) => {
        const result = new Map(); // customerId -> { customer, routeDate, routeName, dayOfWeek }
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        savedRoutes.forEach(sr => {
          const routeDate = new Date(sr.scheduledDate);
          // For future dates, skip sentToTech (those customers are unscheduled now)
          // For past dates, include sentToTech (historical record for reporting)
          if (sr.sentToTech && routeDate >= today) return;
          if (routeDate >= startDate && routeDate <= endDate) {
            sr.customers.forEach(c => {
              if (c.lat && c.lng) {
                result.set(c.id, {
                  ...c,
                  _routeDate: routeDate,
                  _routeName: sr.name,
                  _dayOfWeek: routeDate.getDay(),
                  _dayLabel: routeDate.toLocaleDateString('en-US', { weekday: 'short' })
                });
              }
            });
          }
        });
        return Array.from(result.values());
      };

      const calculateDistance = (lat1, lon1, lat2, lon2) => {
        const R = 3959;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      };

      // Geocode home base
      useEffect(() => {
        const geocodeHomeBase = async () => {
          try {
            // Use CORS proxy for local file access
            const nominatimUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(HOME_BASE_ADDRESS)}&limit=1`;
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(nominatimUrl)}`;
            
            const response = await fetch(proxyUrl);
            const data = await response.json();
            if (data && data.length > 0) {
              setHomeBase({ lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) });
            }
          } catch (error) {
            console.error('Error geocoding home base:', error);
            // Silently fail - user can still use the app without home base
          }
        };
        geocodeHomeBase();
      }, []);

      const [googleMapsLoaded, setGoogleMapsLoaded] = useState(false);
      const quickAddInputRef = useRef(null);
      const quickAddAutocompleteRef = useRef(null);

      useEffect(() => {
        const loadGoogleMaps = async () => {
          if (window.google && window.google.maps && window.google.maps.places) {
            setGoogleMapsLoaded(true);
            return;
          }
          try {
            const resp = await fetch('/api/config/maps-key');
            const { key } = await resp.json();
            if (!key) return;
            window._googleMapsApiKey = key;
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${key}&libraries=places`;
            script.async = true;
            script.onload = () => setGoogleMapsLoaded(true);
            document.head.appendChild(script);
          } catch (e) {
            console.error('Failed to load Google Maps:', e);
          }
        };
        loadGoogleMaps();
      }, []);

      useEffect(() => {
        if (!googleMapsLoaded || !showNewCustomerForm || !quickAddInputRef.current) return;
        if (quickAddAutocompleteRef.current) return;

        const autocomplete = new window.google.maps.places.Autocomplete(quickAddInputRef.current, {
          types: ['address'],
          componentRestrictions: { country: 'us' },
          fields: ['address_components', 'geometry', 'formatted_address']
        });

        autocomplete.addListener('place_changed', () => {
          const place = autocomplete.getPlace();
          if (!place.geometry) return;

          let street_number = '', route = '', city = '', state = '', zip = '';
          for (const comp of (place.address_components || [])) {
            const types = comp.types;
            if (types.includes('street_number')) street_number = comp.long_name;
            else if (types.includes('route')) route = comp.long_name;
            else if (types.includes('locality')) city = comp.long_name;
            else if (types.includes('sublocality_level_1') && !city) city = comp.long_name;
            else if (types.includes('administrative_area_level_1')) state = comp.short_name;
            else if (types.includes('postal_code')) zip = comp.long_name;
          }

          const streetAddr = [street_number, route].filter(Boolean).join(' ');
          setNewCustomerData(prev => ({
            ...prev,
            address: streetAddr || prev.address,
            city: city || prev.city,
            state: state || prev.state,
            zip: zip || prev.zip,
            _lat: place.geometry.location.lat(),
            _lng: place.geometry.location.lng(),
            _geocodeStatus: 'found',
            _suggestions: [], _showSuggestions: false
          }));
        });

        quickAddAutocompleteRef.current = autocomplete;

        return () => {
          quickAddAutocompleteRef.current = null;
        };
      }, [googleMapsLoaded, showNewCustomerForm]);

      // Load verification data from localStorage and merge with customers
      useEffect(() => {
        if (customers.length === 0) return;
        
        const saved = localStorage.getItem('gapFillerVerifications');
        if (saved) {
          try {
            const verifications = JSON.parse(saved);
            setCustomers(prev => prev.map(customer => {
              const verification = verifications[customer.id];
              if (verification) {
                return { ...customer, ...verification };
              }
              return customer;
            }));
          } catch (error) {
            console.error('Error loading verifications:', error);
          }
        }
      }, [customers.length > 0 ? customers.length : null]); // Only run when customers first loaded
      
      // Merge visible files and lists into customers array (merge duplicates by address with secondary contacts)
      useEffect(() => {
        const allSources = [
          ...uploadedFiles.filter(file => file.visible),
          ...savedLists.filter(list => list.visible)
        ];
        
        const allCustomers = allSources.flatMap(source => source.customers);
        
        // Merge duplicates by address, keeping secondary phone/email
        const addressMap = new Map();
        
        allCustomers.forEach(customer => {
          // Skip customers without address
          if (!customer.address) {
            console.warn('Customer missing address:', customer.name || customer.id);
            return;
          }
          
          const normalizedAddress = customer.address
            .toLowerCase()
            .trim()
            .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '')
            .replace(/\s+/g, ' ');
          
          if (addressMap.has(normalizedAddress)) {
            const existing = addressMap.get(normalizedAddress);
            
            if (customer.phone && customer.phone !== existing.phone) {
              if (!existing.secondaryPhones) existing.secondaryPhones = [];
              if (!existing.secondaryPhones.includes(customer.phone)) {
                existing.secondaryPhones.push(customer.phone);
              }
            }
            
            if (customer.email && customer.email !== existing.email) {
              if (!existing.secondaryEmails) existing.secondaryEmails = [];
              if (!existing.secondaryEmails.includes(customer.email)) {
                existing.secondaryEmails.push(customer.email);
              }
            }
            
            if (customer.jobDescription || customer.job_description || customer.lastServiceDate || customer.last_service_date) {
              if (!existing.serviceHistory) existing.serviceHistory = [];
              const newJobDesc = customer.jobDescription || customer.job_description || '';
              const newJobDate = customer.lastServiceDate || customer.last_service_date || '';
              const alreadyHasJob = existing.serviceHistory.some(j => j.jobDescription === newJobDesc && j.date === newJobDate);
              if (!alreadyHasJob) {
                existing.serviceHistory.push({
                  jobDescription: customer.jobDescription || customer.job_description || '',
                  status: customer.status || '',
                  date: customer.lastServiceDate || customer.last_service_date || '',
                  amount: parseFloat(customer.amountPaid || customer.amount_paid || 0) || 0,
                  tip: parseFloat(customer.tipAmount || customer.tip_amount || 0) || 0,
                  panelCount: parseInt(customer.panelCount || customer.panel_count || 0) || 0,
                  isRecurring: customer.isRecurring || customer.is_recurring || false,
                  notes: customer.notes || ''
                });
                const mergedDate = customer.lastServiceDate || customer.last_service_date || '';
                if (mergedDate && (!existing.lastServiceDate || new Date(mergedDate) > new Date(existing.lastServiceDate || existing.last_service_date || ''))) {
                  existing.lastServiceDate = mergedDate;
                  existing.last_service_date = mergedDate;
                  existing.status = customer.status || existing.status;
                  existing.jobDescription = customer.jobDescription || customer.job_description || existing.jobDescription;
                  existing.job_description = existing.jobDescription;
                }
                existing.amountPaid = (parseFloat(existing.amountPaid || existing.amount_paid || 0) || 0) + (parseFloat(customer.amountPaid || customer.amount_paid || 0) || 0);
                existing.amount_paid = existing.amountPaid;
                existing.tipAmount = (parseFloat(existing.tipAmount || existing.tip_amount || 0) || 0) + (parseFloat(customer.tipAmount || customer.tip_amount || 0) || 0);
                existing.tip_amount = existing.tipAmount;
                const mergedPanels = parseInt(customer.panelCount || customer.panel_count || 0) || 0;
                if (mergedPanels > (parseInt(existing.panelCount || existing.panel_count || 0) || 0)) {
                  existing.panelCount = mergedPanels;
                  existing.panel_count = mergedPanels;
                  existing.totalPanels = mergedPanels;
                  existing.total_panels = mergedPanels;
                }
              }
            }
            
            console.log('Merged duplicate address:', customer.address, '- Added job to history');
          } else {
            const jobEntry = {
              jobDescription: customer.jobDescription || customer.job_description || '',
              status: customer.status || '',
              date: customer.lastServiceDate || customer.last_service_date || '',
              amount: parseFloat(customer.amountPaid || customer.amount_paid || 0) || 0,
              tip: parseFloat(customer.tipAmount || customer.tip_amount || 0) || 0,
              panelCount: parseInt(customer.panelCount || customer.panel_count || 0) || 0,
              isRecurring: customer.isRecurring || customer.is_recurring || false,
              notes: customer.notes || ''
            };
            customer.serviceHistory = (jobEntry.jobDescription || jobEntry.date) ? [jobEntry] : [];
            addressMap.set(normalizedAddress, customer);
          }
        });
        
        const uniqueCustomers = Array.from(addressMap.values()).map(c => ({ ...c, status: (c.status || "").toLowerCase() }));
        
        console.log(`Loaded ${allCustomers.length} total customers, ${uniqueCustomers.length} unique by address (with merged contacts)`);
        
        setCustomers(uniqueCustomers);
      }, [uploadedFiles, savedLists]);

      const typeFilteredCustomers = React.useMemo(() => {
        if (currentView !== 'pipeline' || activeCustomerType === 'all') return customers;
        return customers.filter(c => (c.customerType || 'residential') === activeCustomerType);
      }, [customers, activeCustomerType, currentView]);


      useEffect(() => {
        if (!profileCustomer || !profileCustomer.id) return;
        if (typeof profileCustomer.id !== 'number') return;
        const fetchJobs = async () => {
          try {
            const data = await apiFetch('/jobs?customer_id=' + profileCustomer.id);
            if (data && data.jobs && data.jobs.length > 0) {
              const dbJobs = data.jobs.map(j => ({
                jobId: j.id,
                jobDescription: j.job_description || '',
                status: j.status || '',
                date: j.completed_date || j.scheduled_date || j.next_service_date || j.created_at || '',
                amount: parseFloat(j.amount) || 0,
                tip: parseFloat(j.tip) || 0,
                panelCount: j.panel_count || 0,
                isRecurring: j.is_recurring || false,
                notes: j.notes || '',
                price: parseFloat(j.price) || 0,
                pricePerPanel: parseFloat(j.price_per_panel) || 0,
                preferredDays: j.preferred_days || '',
                preferredTime: j.preferred_time || '',
                technician: j.technician || '',
                recurrenceInterval: j.recurrence_interval || '',
                nextServiceDate: j.next_service_date || '',
                scheduledDate: j.scheduled_date || ''
              }));
              dbJobs.sort((a, b) => {
                const da = a.date ? new Date(a.date).getTime() : 0;
                const db = b.date ? new Date(b.date).getTime() : 0;
                return db - da;
              });
              setProfileCustomer(prev => ({
                ...prev,
                serviceHistory: dbJobs
              }));
            }
          } catch (err) {
            console.error('Failed to fetch jobs for customer:', err);
          }
        };
        fetchJobs();
      }, [profileCustomer?.id, jobRefreshKey]);

      // Restore scheduling data from savedRoutes into customers on load
      // This ensures scheduledTime/scheduledDate persist across page reloads
      useEffect(() => {
        if (customers.length === 0 || savedRoutes.length === 0) return;

        // Build a map of customer scheduling data from saved routes
        // Skip routes already sent to tech - those customers are no longer scheduled
        const scheduleMap = new Map();
        savedRoutes.forEach(sr => {
          if (sr.sentToTech) return; // Don't restore scheduling for sent routes
          sr.customers.forEach(c => {
            if (c.scheduledTime || c.scheduledDate) {
              scheduleMap.set(c.id, {
                scheduledTime: c.scheduledTime,
                scheduledDate: sr.scheduledDate || c.scheduledDate,
                status: 'scheduled',
                routeConfirmed: true,
                confirmedRouteName: sr.name
              });
            }
          });
        });

        if (scheduleMap.size === 0) return;

        const needsUpdate = customers.some(c => {
          const sched = scheduleMap.get(c.id);
          if (!sched || c.scheduledTime) return false;
          if (c.status === 'unscheduled') return false;
          return true;
        });

        if (needsUpdate) {
          setCustomers(prev => prev.map(c => {
            const sched = scheduleMap.get(c.id);
            if (sched && !c.scheduledTime && c.status !== 'unscheduled') {
              return { ...c, ...sched };
            }
            return c;
          }));
        }
      }, [customers.length, savedRoutes.length]);

      // When changing dates, preserve unsaved route edits in routesByDay
      useEffect(() => {
        const currentDateKey = selectedDate.toDateString();
        const prevDateKey = prevSelectedDateRef.current;

        if (prevDateKey && prevDateKey !== currentDateKey) {
          // Check if the previous day has unsaved route edits (not in saved view and has stops)
          const prevDayRoute = routesByDay[prevDateKey] || [];
          const hasSavedRoute = savedRoutes.some(r => {
            const rDate = new Date(r.scheduledDate);
            return rDate.toDateString() === prevDateKey;
          });

          if (prevDayRoute.length > 0 && !hasSavedRoute && savedViewDays[prevDateKey] !== true) {
            // Mark this day as having unsaved changes - preserve the data
            setUnsavedRouteDays(prev => ({ ...prev, [prevDateKey]: true }));
            setUnsavedRouteChanges(true);
          }

          setEditingSavedRouteId(null);
        }

        // Update the ref for next change
        prevSelectedDateRef.current = currentDateKey;
      }, [selectedDate]);

      // NOTE: All customer filtering is handled in the unified filter useEffect below (search for "UNIFIED FILTER")
      
      // Calculate statistics
      useEffect(() => {
        const customersToAnalyze = visibleCustomers.length > 0 ? visibleCustomers : filteredCustomers;
        
        if (customersToAnalyze.length === 0) {
          setStats({ total: 0, visible: 0, states: 0, avgDistance: 0, totalRouteDistance: 0 });
          return;
        }

        const states = new Set(customersToAnalyze.map(c => c.state).filter(Boolean));

        let avgDistance = 0;
        if (homeBase) {
          const totalDistance = customersToAnalyze.reduce((sum, c) => {
            if (!c.lat || !c.lng) return sum;
            return sum + calculateDistance(homeBase.lat, homeBase.lng, c.lat, c.lng);
          }, 0);
          avgDistance = totalDistance / customersToAnalyze.length;
        }

        let totalRouteDistance = 0;
        if (route.length > 0 && homeBase) {
          // Distance from home to first stop
          totalRouteDistance = calculateDistance(homeBase.lat, homeBase.lng, route[0].lat, route[0].lng);
          // Distance between stops
          for (let i = 0; i < route.length - 1; i++) {
            totalRouteDistance += calculateDistance(route[i].lat, route[i].lng, route[i + 1].lat, route[i + 1].lng);
          }
          // Return trip to home
          const lastStop = route[route.length - 1];
          totalRouteDistance += calculateDistance(lastStop.lat, lastStop.lng, homeBase.lat, homeBase.lng);
        }

        setStats({
          total: filteredCustomers.length,
          visible: visibleCustomers.length,
          states: states.size,
          avgDistance,
          totalRouteDistance
        });
      }, [visibleCustomers, filteredCustomers, homeBase, route]);

      // Update visible customers
      useEffect(() => {
        if (!mapInstanceRef.current) return;

        const updateVisible = () => {
          const bounds = mapInstanceRef.current.getBounds();
          let visible = filteredCustomers.filter(c => {
            if (!c.lat || !c.lng) return false;
            return bounds.contains([c.lat, c.lng]);
          });
          
          if (activeSorts.length > 0) {
            const getDistFromHome = (c) => {
              if (!homeBase || !c.lat || !c.lng) return 99999;
              const R = 3959;
              const dLat = (c.lat - homeBase.lat) * Math.PI / 180;
              const dLng = (c.lng - homeBase.lng) * Math.PI / 180;
              const a2 = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(homeBase.lat * Math.PI / 180) * Math.cos(c.lat * Math.PI / 180) * Math.sin(dLng/2) * Math.sin(dLng/2);
              return R * 2 * Math.atan2(Math.sqrt(a2), Math.sqrt(1 - a2));
            };
            const getSortValue = (c, key) => {
              if (key === 'lastService') return c.lastServiceDate ? new Date(c.lastServiceDate).getTime() : 0;
              if (key === 'zip') return parseInt(c.zip) || 0;
              if (key === 'panels') return parseInt(c.panelCount || c.totalPanels) || 0;
              if (key === 'distance') return getDistFromHome(c);
              return 0;
            };
            visible = [...visible].sort((a, b) => {
              for (const key of activeSorts) {
                const valA = getSortValue(a, key);
                const valB = getSortValue(b, key);
                if (valA !== valB) {
                  const diff = valA - valB;
                  return sortOrder === 'asc' ? diff : -diff;
                }
              }
              return 0;
            });
          }
          
          setVisibleCustomers(visible);
        };

        mapInstanceRef.current.on('moveend', updateVisible);
        mapInstanceRef.current.on('zoomend', updateVisible);
        
        updateVisible();

        return () => {
          if (mapInstanceRef.current) {
            mapInstanceRef.current.off('moveend', updateVisible);
            mapInstanceRef.current.off('zoomend', updateVisible);
          }
        };
      }, [filteredCustomers, activeSorts, sortOrder]);

      // Geocode address to coordinates
      const geocodeAddress = async (address) => {
        try {
          // Remove emojis from address
          const cleanAddress = address.replace(/[\u{1F300}-\u{1F9FF}]/gu, '').trim();
          
          // Use CORS proxy for local file access
          const nominatimUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cleanAddress)}&limit=1`;
          const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(nominatimUrl)}`;
          
          const response = await fetch(proxyUrl);
          const data = await response.json();
          if (data && data.length > 0) {
            return { 
              lat: parseFloat(data[0].lat), 
              lng: parseFloat(data[0].lon),
              display_name: data[0].display_name
            };
          }
          return null;
        } catch (error) {
          console.error('Geocoding error:', error);
          return null;
        }
      };

      // Draw radius circle on map (visual only - filtering handled by unified filter useEffect)
      const drawRadius = (latlng, radiusMeters, displayName) => {
        const L = window.L;
        if (!mapInstanceRef.current) return;

        // Remove existing circle
        if (radiusCircleRef.current) {
          mapInstanceRef.current.removeLayer(radiusCircleRef.current);
        }

        // Create new circle
        const circle = L.circle([latlng.lat, latlng.lng], {
          radius: radiusMeters,
          color: '#8b5cf6',
          fillColor: '#8b5cf6',
          fillOpacity: 0.1,
          weight: 2
        }).addTo(mapInstanceRef.current);

        radiusCircleRef.current = circle;
        setReferencePoint(latlng);
        setReferenceAddress(displayName);

        // Filtering is now handled by the unified filter useEffect
        // which reacts to referencePoint and radiusMiles changes
        mapInstanceRef.current.fitBounds(circle.getBounds(), { padding: [50, 50] });
      };

      // Clear radius circle
      const clearRadius = () => {
        if (radiusCircleRef.current && mapInstanceRef.current) {
          mapInstanceRef.current.removeLayer(radiusCircleRef.current);
          radiusCircleRef.current = null;
        }
        if (referenceMarkerRef.current && mapInstanceRef.current) {
          mapInstanceRef.current.removeLayer(referenceMarkerRef.current);
          referenceMarkerRef.current = null;
        }
        setReferencePoint(null);
        setReferenceAddress('');
        // Filtering handled by unified filter useEffect
      };

      // Clear drawn area
      const clearDrawnArea = () => {
        if (drawnPolygon && mapInstanceRef.current) {
          mapInstanceRef.current.removeLayer(drawnPolygon);
        }
        setDrawnPolygon(null);
        setDrawnArea(null);
        setDrawMode(false);
        // Reset filtered customers if no other filters active
        if (!referencePoint) {
          setFilteredCustomers(typeFilteredCustomers);
        }
      };

      const exitRadiusMode = () => {
        clearRadius();
        clearDrawnArea();
        setRadiusMode(false);
        setAwaitingMapClick(false);
        setLastServiceFilter('');
        setFilteredCustomers(typeFilteredCustomers);
      };

      // Drawing state for freehand polygon
      const drawingPointsRef = React.useRef([]);
      const drawingLayerRef = React.useRef(null);

      // Handle radius search from address
      const handleRadiusSearch = async (clickMode = false) => {
        if (clickMode) {
          // Click mode is now handled by the awaitingMapClick state
          return;
        } else if (radiusAddress) {
          const coords = await geocodeAddress(radiusAddress);
          if (coords) {
            drawRadius({ lat: coords.lat, lng: coords.lng }, radiusMiles * 1609.34, coords.display_name);
            setRadiusAddress('');
          } else {
            alert('Could not find address. Please try a different address.');
          }
        }
      };

      // Initialize map - only once
      useEffect(() => {
        if (!mapRef.current || mapInstanceRef.current) return;

        const initMap = () => {
          const L = window.L;
          const map = L.map(mapRef.current, {
            preferCanvas: true,  // CRITICAL: Use Canvas instead of SVG for markers
            renderer: L.canvas({ tolerance: 5 })  // Canvas renderer with click tolerance
          }).setView([32.7555, -97.3308], 10);
          
          L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: 'Â© OpenStreetMap Â© CARTO',
            maxZoom: 19
          }).addTo(map);

          const markers = L.markerClusterGroup({
            chunkedLoading: true,
            chunkInterval: 500,
            chunkDelay: 100,
            chunkProgress: (processed, total, elapsed) => {
              if (processed % 1000 === 0) {
                console.log(`ðŸ“ Loaded ${processed}/${total} markers (${Math.round(processed/total*100)}%)`);
              }
            },
            maxClusterRadius: 10,  // Extremely tight: only nearly-overlapping pins cluster
            spiderfyOnMaxZoom: true,
            spiderfyDistanceMultiplier: 1.5,
            spiderLegPolylineOptions: { weight: 1.5, color: '#8b5cf6', opacity: 0.6 },
            showCoverageOnHover: false,
            zoomToBoundsOnClick: false,
            disableClusteringAtZoom: 7,  // Show individual pins from zoom 7+ (city-level)
            removeOutsideVisibleBounds: true,
            animate: false
          });

          // Click cluster â†’ spiderfy to show individual pins (no zoom)
          markers.on('clusterclick', function (e) {
            e.layer.spiderfy();
          });

          map.addLayer(markers);
          markerClusterRef.current = markers;
          mapInstanceRef.current = map;
          
          // Track map bounds for sidebar filtering
          const updateBounds = () => {
            setMapBounds(map.getBounds());
          };
          
          map.on('moveend', updateBounds);
          map.on('zoomend', updateBounds);
          updateBounds(); // Set initial bounds
        };

        if (window.L) {
          initMap();
        }
      }, []);

      // Update map when switching back to map view
      useEffect(() => {
        if (currentView === 'map' && mapInstanceRef.current) {
          setTimeout(() => {
            mapInstanceRef.current.invalidateSize();
          }, 100);
        }
      }, [currentView]);

      // Live technician tracking - poll every 5 seconds
      useEffect(() => {
        const pollTechLocations = async () => {
          try {
            const res = await fetch('/api/technician/location');
            const data = await res.json();
            setActiveTechnicians(data.technicians || {});
          } catch (e) {}
        };
        pollTechLocations();
        const interval = setInterval(pollTechLocations, 5000);
        return () => clearInterval(interval);
      }, []);

      // Render technician markers on map
      useEffect(() => {
        if (!mapInstanceRef.current || !window.L) return;
        const L = window.L;
        const map = mapInstanceRef.current;

        Object.keys(techMarkerLayersRef.current).forEach(name => {
          if (!activeTechnicians[name]) {
            map.removeLayer(techMarkerLayersRef.current[name]);
            delete techMarkerLayersRef.current[name];
          }
        });

        Object.entries(activeTechnicians).forEach(([name, data]) => {
          if (!data.lat || !data.lng) return;
          
          const speedMph = data.speed ? (data.speed * 2.237).toFixed(0) : '0';
          const headingDeg = data.heading || 0;
          const ageSeconds = Math.floor((Date.now() - data.lastSeen) / 1000);
          const isStale = ageSeconds > 30;

          const truckIcon = L.divIcon({
            className: 'tech-marker',
            html: `<div style="position: relative; width: 44px; height: 44px;">
              <div style="
                width: 44px; height: 44px; border-radius: 50%;
                background: ${isStale ? 'rgba(100, 116, 139, 0.8)' : 'rgba(34, 197, 94, 0.9)'};
                border: 3px solid ${isStale ? '#64748b' : '#22c55e'};
                display: flex; align-items: center; justify-content: center;
                font-size: 22px; box-shadow: 0 0 12px ${isStale ? 'rgba(100,116,139,0.3)' : 'rgba(34,197,94,0.5)'};
                ${!isStale ? 'animation: techPulse 2s ease-in-out infinite;' : ''}
              ">ðŸš›</div>
              <div style="
                position: absolute; top: -22px; left: 50%; transform: translateX(-50%);
                background: rgba(15, 23, 42, 0.9); color: #e2e8f0;
                padding: 2px 8px; border-radius: 8px; font-size: 11px; font-weight: 700;
                white-space: nowrap; border: 1px solid ${isStale ? 'rgba(100,116,139,0.3)' : 'rgba(34,197,94,0.4)'};
                font-family: Inter, sans-serif;
              ">${name} ${speedMph > 0 ? 'Â· ' + speedMph + ' mph' : ''}</div>
            </div>`,
            iconSize: [44, 44],
            iconAnchor: [22, 22]
          });

          if (techMarkerLayersRef.current[name]) {
            techMarkerLayersRef.current[name].setLatLng([data.lat, data.lng]);
            techMarkerLayersRef.current[name].setIcon(truckIcon);
          } else {
            const marker = L.marker([data.lat, data.lng], { icon: truckIcon, zIndexOffset: 10000 });
            marker.bindPopup(`<div style="font-family: Inter, sans-serif; padding: 4px;">
              <strong>${name}</strong><br/>
              Speed: ${speedMph} mph<br/>
              Last seen: ${ageSeconds}s ago
            </div>`);
            marker.addTo(map);
            techMarkerLayersRef.current[name] = marker;
          }
        });
      }, [activeTechnicians]);
      
      // Handle map clicks for radius mode
      useEffect(() => {
        if (!mapInstanceRef.current) return;
        
        const handleMapClick = (e) => {
          if (awaitingMapClick && radiusMode) {
            const latlng = e.latlng;
            clearRadius();
            drawRadius(latlng, radiusMiles * 1609.34, 'Selected Point');
            setAwaitingMapClick(false);
          }
        };
        
        mapInstanceRef.current.on('click', handleMapClick);
        
        return () => {
          if (mapInstanceRef.current) {
            mapInstanceRef.current.off('click', handleMapClick);
          }
        };
      }, [awaitingMapClick, radiusMode, radiusMiles, customers]);
      
      // Change cursor to crosshair when awaiting map click
      useEffect(() => {
        if (!mapInstanceRef.current) return;
        
        const container = mapInstanceRef.current.getContainer();
        if (awaitingMapClick && radiusMode) {
          container.style.cursor = 'crosshair';
        } else {
          container.style.cursor = '';
        }
        
        return () => {
          if (mapInstanceRef.current) {
            mapInstanceRef.current.getContainer().style.cursor = '';
          }
        };
      }, [awaitingMapClick, radiusMode]);

      // Handle draw mode for custom area selection
      useEffect(() => {
        if (!mapInstanceRef.current) return;
        const map = mapInstanceRef.current;
        const L = window.L;

        if (drawMode) {
          map.getContainer().style.cursor = 'crosshair';
          drawingPointsRef.current = [];

          const onMouseDown = (e) => {
            if (!drawMode) return;
            drawingPointsRef.current = [e.latlng];

            // Create initial polyline
            if (drawingLayerRef.current) {
              map.removeLayer(drawingLayerRef.current);
            }
            drawingLayerRef.current = L.polyline([e.latlng], {
              color: '#8b5cf6',
              weight: 3,
              opacity: 0.8,
              dashArray: '5, 10'
            }).addTo(map);

            map.dragging.disable();
          };

          const onMouseMove = (e) => {
            if (!drawMode || drawingPointsRef.current.length === 0) return;
            drawingPointsRef.current.push(e.latlng);
            if (drawingLayerRef.current) {
              drawingLayerRef.current.setLatLngs(drawingPointsRef.current);
            }
          };

          const onMouseUp = (e) => {
            if (!drawMode || drawingPointsRef.current.length < 3) {
              map.dragging.enable();
              return;
            }

            // Close the polygon
            drawingPointsRef.current.push(drawingPointsRef.current[0]);

            // Remove temporary polyline
            if (drawingLayerRef.current) {
              map.removeLayer(drawingLayerRef.current);
              drawingLayerRef.current = null;
            }

            // Remove old polygon if exists
            if (drawnPolygon) {
              map.removeLayer(drawnPolygon);
            }

            // Create final polygon
            const polygon = L.polygon(drawingPointsRef.current, {
              color: '#8b5cf6',
              weight: 3,
              fillColor: '#8b5cf6',
              fillOpacity: 0.2
            }).addTo(map);

            setDrawnPolygon(polygon);
            setDrawnArea(drawingPointsRef.current);
            setDrawMode(false);
            map.dragging.enable();
            map.getContainer().style.cursor = '';
          };

          const onKeyDown = (e) => {
            if (e.key === 'Escape') {
              setDrawMode(false);
            }
          };

          map.on('mousedown', onMouseDown);
          map.on('mousemove', onMouseMove);
          map.on('mouseup', onMouseUp);
          document.addEventListener('keydown', onKeyDown);

          return () => {
            map.off('mousedown', onMouseDown);
            map.off('mousemove', onMouseMove);
            map.off('mouseup', onMouseUp);
            document.removeEventListener('keydown', onKeyDown);
            map.dragging.enable();
            map.getContainer().style.cursor = '';
            // Clean up temporary drawing polyline
            if (drawingLayerRef.current) {
              map.removeLayer(drawingLayerRef.current);
              drawingLayerRef.current = null;
            }
            drawingPointsRef.current = [];
          };
        } else {
          map.getContainer().style.cursor = '';
        }
      }, [drawMode, drawnPolygon]);

      // Listen for popup action events
      useEffect(() => {
        const handleAddToRoute = (e) => {
          const customerId = e.detail;
          const customer = customers.find(c => c.id === customerId);
          if (customer) {
            handleCustomerClick(customer);
            // Close any open popups
            if (mapInstanceRef.current) {
              mapInstanceRef.current.closePopup();
            }
          }
        };
        
        const handleVerifySolar = async (e) => {
          const customerId = e.detail;
          const customer = customers.find(c => c.id === customerId);
          if (customer) {
            const status = await verifyCustomerSolar(customer);
            markVerified(customerId, status);
            // Close popup after verification
            if (mapInstanceRef.current) {
              mapInstanceRef.current.closePopup();
            }
          }
        };
        
        const handleMarkVerified = (e) => {
          const { id, status } = e.detail;
          markVerified(id, status);
          // Close popup after marking
          if (mapInstanceRef.current) {
            mapInstanceRef.current.closePopup();
          }
        };
        
        const handleViewProfile = (event) => {
          const customerId = event.detail;
          const customer = customers.find(c => c.id === customerId);
          if (customer) {
            setSelectedCustomer(customer);
            if (mapInstanceRef.current) {
              mapInstanceRef.current.closePopup();
            }
          }
        };

        const handleMarkRecurring = (event) => {
          const customerId = event.detail;
          const customer = customers.find(c => c.id === customerId);
          if (customer) {
            setSelectedCustomer(customer);
            // Pre-populate form with existing values if available
            setExistingJobData({
              totalPanels: customer.totalPanels || '',
              lastServiceDate: customer.lastServiceDate || '',
              amountPaid: customer.amountPaid || '',
              isRecurring: customer.isRecurring || false,
              nextScheduledDate: customer.nextScheduledDate || ''
            });
            setShowExistingJobModal(true);
          }
        };
        
        // Handle auto-verify property
        const handleAutoVerify = async (e) => {
          const customerId = e.detail;
          const customer = customers.find(c => c.id === customerId);
          
          if (!customer) return;
          
          console.log('ðŸ” Auto-verifying property:', customer.address);
          
          try {
            // Run verification
            const results = await verifyProperty(customer);
            
            // Update customer with verification results
            setCustomers(prevCustomers => 
              prevCustomers.map(c => {
                if (c.id === customerId) {
                  return {
                    ...c,
                    propertyType: results.propertyType || c.propertyType,
                    solarVerified: results.hasSolar === true ? 'yes' : 
                                  results.hasSolar === false ? 'no' : 
                                  c.solarVerified,
                    verificationDate: results.timestamp,
                    verificationSources: results.sources
                  };
                }
                return c;
              })
            );
            
            // Show success message
            if (results.verified) {
              alert(
                `âœ… Verification Complete!\n\n` +
                `Property Type: ${results.propertyType === 'commercial' ? 'ðŸ¢ Commercial' : 'ðŸ  Residential'}\n` +
                `Solar Status: ${results.hasSolar ? 'âœ“ Has Solar' : 'âŒ No Solar Found'}\n\n` +
                `Data Sources: ${results.sources.join(', ')}\n\n` +
                (results.solarDetails?.permits?.length > 0 ? 
                  `Solar Permits: ${results.solarDetails.permits.length} found\n` : '') +
                `\nVerification saved!`
              );
            } else {
              alert(
                `âš ï¸ Verification Incomplete\n\n` +
                `Could not verify this property automatically.\n\n` +
                `Possible reasons:\n` +
                `â€¢ Address not in Dallas area (limited to Dallas Open Data)\n` +
                `â€¢ No recent building permits\n` +
                `â€¢ Property not in public databases\n\n` +
                `You can still mark solar status manually.`
              );
            }
            
          } catch (error) {
            console.error('Auto-verify failed:', error);
            alert(`âŒ Verification Error\n\n${error.message}\n\nPlease try again or verify manually.`);
          }
        };
        
        const handleAddJobForCustomer = (e) => {
          const customerId = e.detail;
          const customer = customers.find(c => c.id === customerId || String(c.id) === String(customerId));
          if (!customer) {
            console.error('Customer not found for add job:', customerId);
            return;
          }
          openJobPopupForCustomer(customer);
        };

        const handleShowDayPicker = (e) => {
          const cust = customers.find(c => c.id === e.detail.customerId);
          if (cust && focusedDays.length >= 1) {
            setDayPickerPopup({ customer: cust, days: [...focusedDays].sort((a, b) => a - b) });
          }
        };

        window.addEventListener('addToRoute', handleAddToRoute);
        window.addEventListener('viewCustomerProfile', handleViewProfile);
        window.addEventListener('verifySolar', handleVerifySolar);
        window.addEventListener('markVerified', handleMarkVerified);
        window.addEventListener('markRecurring', handleMarkRecurring);
        window.addEventListener('autoVerifyProperty', handleAutoVerify);
        window.addEventListener('addJobForCustomer', handleAddJobForCustomer);
        window.addEventListener('showDayPicker', handleShowDayPicker);
        
        return () => {
          window.removeEventListener('addToRoute', handleAddToRoute);
          window.removeEventListener('viewCustomerProfile', handleViewProfile);
          window.removeEventListener('verifySolar', handleVerifySolar);
          window.removeEventListener('markVerified', handleMarkVerified);
          window.removeEventListener('markRecurring', handleMarkRecurring);
          window.removeEventListener('autoVerifyProperty', handleAutoVerify);
          window.removeEventListener('addJobForCustomer', handleAddJobForCustomer);
          window.removeEventListener('showDayPicker', handleShowDayPicker);
        };
      }, [customers, focusedDays]);
      
      // Highlight map marker when hovering sidebar card
      useEffect(() => {
        if (!hoveredCustomer || !markersMapRef.current) return;
        
        const marker = markersMapRef.current.get(hoveredCustomer.id);
        if (!marker) return;
        
        const markerElement = marker.getElement();
        if (!markerElement) return;
        
        const pinElement = markerElement.querySelector('.marker-pin');
        if (!pinElement) return;
        
        // Check if in route or suggested
        const isInRoute = route.some(r => r.id === hoveredCustomer.id);
        const isSuggested = suggestedCustomers.some(c => c.id === hoveredCustomer.id);
        
        if (!isInRoute && !isSuggested) {
          pinElement.style.background = 'linear-gradient(135deg, #c4b5fd 0%, #a78bfa 100%)';
          pinElement.style.transform = 'rotate(-45deg) scale(1.3)';
          pinElement.style.boxShadow = '0 8px 20px rgba(139, 92, 246, 0.6)';
        }
        
        return () => {
          if (pinElement && !isInRoute && !isSuggested) {
            pinElement.style.background = 'linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%)';
            pinElement.style.transform = 'rotate(-45deg) scale(1)';
            pinElement.style.boxShadow = '0 4px 16px rgba(139, 92, 246, 0.5)';
          }
        };
      }, [hoveredCustomer, route, suggestedCustomers]);

      // Update home base marker
      useEffect(() => {
        if (!mapInstanceRef.current || !window.L || !homeBase) return;

        const L = window.L;

        if (homeBaseMarkerRef.current) {
          mapInstanceRef.current.removeLayer(homeBaseMarkerRef.current);
        }

        const homeIcon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="width: 30px; height: 30px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 16px rgba(59, 130, 246, 0.6); display: flex; align-items: center; justify-content: center;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
              <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
          </div>`,
          iconSize: [30, 30],
          iconAnchor: [15, 15]
        });

        const homeMarker = L.marker([homeBase.lat, homeBase.lng], { icon: homeIcon })
          .addTo(mapInstanceRef.current);

        homeMarker.bindTooltip(`
          <div style="font-family: 'Inter', sans-serif;">
            <div style="font-size: 13px; font-weight: 700; color: #3b82f6; margin-bottom: 6px;">
              ðŸ  Home Base
            </div>
            <div style="font-size: 11px; color: #94a3b8;">
              ${HOME_BASE_ADDRESS}
            </div>
          </div>
        `, {
          direction: 'top',
          offset: [0, -15],
          opacity: 0.98
        });

        homeBaseMarkerRef.current = homeMarker;
      }, [homeBase]);

      // Update reference point marker
      useEffect(() => {
        if (!mapInstanceRef.current || !window.L || !referencePoint) return;

        const L = window.L;

        if (referenceMarkerRef.current) {
          mapInstanceRef.current.removeLayer(referenceMarkerRef.current);
        }

        const refIcon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="width: 24px; height: 24px; background: linear-gradient(135deg, #f59e0b, #ea580c); border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 16px rgba(245, 158, 11, 0.6);"></div>`,
          iconSize: [24, 24],
          iconAnchor: [12, 12]
        });

        const refMarker = L.marker([referencePoint.lat, referencePoint.lng], { icon: refIcon })
          .addTo(mapInstanceRef.current);

        refMarker.bindTooltip(`
          <div style="font-family: 'Inter', sans-serif;">
            <div style="font-size: 13px; font-weight: 700; color: #f59e0b; margin-bottom: 6px;">
              ðŸŽ¯ Reference Point
            </div>
            <div style="font-size: 11px; color: #94a3b8;">
              ${referenceAddress || 'Selected Location'}
            </div>
          </div>
        `, {
          direction: 'top',
          offset: [0, -12],
          opacity: 0.98
        });

        referenceMarkerRef.current = refMarker;
      }, [referencePoint, referenceAddress]);

      // Update markers and route lines
      useEffect(() => {
        if (!markerClusterRef.current || !window.L) return;

        markerClusterRef.current.clearLayers();
        markersMapRef.current.clear();

        routeLinesRef.current.forEach(line => {
          if (mapInstanceRef.current) mapInstanceRef.current.removeLayer(line);
        });
        routeLinesRef.current = [];

        if (heatLayerRef.current && mapInstanceRef.current) {
          mapInstanceRef.current.removeLayer(heatLayerRef.current);
          heatLayerRef.current = null;
        }

        if (filteredCustomers.length === 0) return;

        const L = window.L;

        if (showHeatMap) {
          const heatData = filteredCustomers
            .filter(c => c.lat && c.lng)
            .map(c => [c.lat, c.lng, 1]);
          
          const heat = L.heatLayer(heatData, {
            radius: 25,
            blur: 35,
            maxZoom: 17,
            max: 1.0,
            gradient: {
              0.0: '#8b5cf6',
              0.5: '#6366f1',
              1.0: '#f59e0b'
            }
          }).addTo(mapInstanceRef.current);
          
          heatLayerRef.current = heat;
        } else {
          const routeIds = new Set(route.map(r => r.id));
          const suggestedIds = new Set(suggestedCustomers.map(s => s.id));

          // Performance optimization for large datasets
          const currentZoom = mapInstanceRef.current.getZoom();
          const customerCount = filteredCustomers.length;
          
          // For very large datasets (>5000), skip every Nth marker when zoomed out
          let renderEveryNth = 1;
          if (customerCount > 15000 && currentZoom < 12) {
            renderEveryNth = 4; // Show 25% of markers
          } else if (customerCount > 10000 && currentZoom < 12) {
            renderEveryNth = 3; // Show 33% of markers
          } else if (customerCount > 5000 && currentZoom < 12) {
            renderEveryNth = 2; // Show 50% of markers
          }
          
          console.log(`ðŸ“Š Rendering ${Math.floor(customerCount / renderEveryNth)} of ${customerCount} markers (zoom: ${currentZoom})`);

          filteredCustomers.forEach((customer, index) => {
            if (!customer.lat || !customer.lng) return;
            
            // Skip markers based on zoom/count for performance
            if (renderEveryNth > 1 && index % renderEveryNth !== 0) return;

            // Check if customer is scheduled for the SELECTED day
            const isScheduledToday = (() => {
              if (!customer.scheduledDate || !customer.scheduledTime) return false;
              const custDate = new Date(customer.scheduledDate);
              return custDate.toDateString() === selectedDate.toDateString();
            })();
            
            // Find job number for selected day only
            let routeNumber = null;
            if (isScheduledToday) {
              const jobsForDay = customers
                .filter(c => {
                  if (!c.scheduledDate || !c.scheduledTime) return false;
                  const custDate = new Date(c.scheduledDate);
                  return custDate.toDateString() === selectedDate.toDateString();
                })
                .sort((a, b) => {
                  const [aH, aM] = a.scheduledTime.split(':').map(Number);
                  const [bH, bM] = b.scheduledTime.split(':').map(Number);
                  return (aH * 60 + aM) - (bH * 60 + bM);
                });
              
              const jobIndex = jobsForDay.findIndex(j => j.id === customer.id);
              routeNumber = jobIndex >= 0 ? jobIndex + 1 : null;
            }
            
            const isSuggested = suggestedIds.has(customer.id);
            const isInRoute = routeIds.has(customer.id);

            let pinClass = '';
            let gradient = 'linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%)';
            let verifyBadge = '';
            let goldCheckmark = '';
            let scheduledOtherDayBadge = '';
            let dayLabelBadge = '';

            let isOtherDayRoute = false;
            if (statusFilter === 'scheduled' && customer._dayOfWeek !== undefined) {
              const custRouteDate = customer._routeDate ? new Date(customer._routeDate).toDateString() : null;
              isOtherDayRoute = focusedDays.length > 0 && custRouteDate && !focusedDays.some(fd => fd.toDateString() === custRouteDate);
              if (focusedDays.length === 0) {
                gradient = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
              } else {
                gradient = isOtherDayRoute
                  ? 'linear-gradient(135deg, #22c55e55 0%, #16a34a44 100%)'
                  : 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
              }
            }
            if (statusFilter === 'scheduled' && (customer._needsScheduling || customer._dayOfWeek === undefined)) {
              const cpd = (customer.preferredDate || '').toLowerCase();
              const cpt = (customer.preferredTimeWindow || '').toUpperCase();
              const matchDay = hoveredPrefDay && cpd.includes(hoveredPrefDay.toLowerCase());
              const matchTime = hoveredPrefTime && cpt.includes(hoveredPrefTime);
              if (matchDay || matchTime) {
                gradient = 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)';
                dayLabelBadge = '';
              } else {
                gradient = 'linear-gradient(135deg, #64748b 0%, #475569 100%)';
                dayLabelBadge = '';
              }
            }
            
            // Check if scheduled on a DIFFERENT day
            const isScheduledOtherDay = customer.scheduledDate && customer.scheduledTime && !isScheduledToday;
            
            // Add gold checkmark for ANY verified status
            if (customer.solarVerified === 'yes' || customer.solarVerified === 'no') {
              goldCheckmark = '<span style="position: absolute; top: -8px; left: -8px; font-size: 16px; color: #fbbf24; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.9));">âœ“</span>';
            }
            
            // Add verification status badge
            if (customer.solarVerified === 'yes') {
              // No badge for 'yes' - only gold checkmark shows
              verifyBadge = '';
            } else if (customer.solarVerified === 'no') {
              verifyBadge = '<span style="position: absolute; top: -6px; right: -6px; font-size: 12px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.8));">âŒ</span>';
            }
            
            // Add "scheduled on other day" badge - calendar icon
            if (isScheduledOtherDay && customer.routeConfirmed) {
              const schedDate = new Date(customer.scheduledDate);
              const dayName = schedDate.toLocaleDateString('en-US', { weekday: 'short' });
              scheduledOtherDayBadge = `<span style="position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); font-size: 10px; background: rgba(34, 197, 94, 0.9); color: white; padding: 2px 4px; border-radius: 4px; font-weight: 700; white-space: nowrap; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.8));">ðŸ“…${dayName}</span>`;
            }
            
            if (statusFilter !== 'scheduled') {
              if (isScheduledToday && routeNumber) {
                pinClass = 'in-route';
                gradient = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
              } else if (isSuggested) {
                pinClass = 'suggested';
                gradient = 'linear-gradient(135deg, #f59e0b 0%, #ea580c 100%)';
              } else if (isScheduledOtherDay) {
                gradient = 'linear-gradient(135deg, rgba(139, 92, 246, 0.5) 0%, rgba(99, 102, 241, 0.5) 100%)';
              }
            } else {
              if (isScheduledToday && routeNumber) {
                pinClass = 'in-route';
              }
            }
            
            // Route number display (white text in center of pin)
            const routeNumberDisplay = routeNumber ? `<span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(45deg); color: white; font-weight: 800; font-size: 11px; text-shadow: 0 1px 3px rgba(0,0,0,0.8);">${routeNumber}</span>` : '';

            // Determine icon type based on new logic:
            // - Green dinosaur ðŸ¦– = Recurring customer
            // - Pink pin = Not recurring, but has upcoming job
            // - Default purple pin = No upcoming job
            const isRecurringCustomer = customer.isRecurring === true || customer.recurring === 'TRUE' || customer.recurring === true;

            let nextServiceDate = customer.nextServiceDate;
            const hasUpcomingJob = nextServiceDate && new Date(nextServiceDate) > new Date();

            let customIcon;
            const otherDayStyle = isOtherDayRoute ? 'opacity: 0.35; pointer-events: none;' : '';
            if (statusFilter === 'scheduled') {
              customIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div class="marker-pin ${pinClass}" style="background: ${gradient}; position: relative; ${otherDayStyle}">${goldCheckmark}${verifyBadge}${routeNumberDisplay}</div>`,
                iconSize: [24, 32],
                iconAnchor: [12, 32],
                popupAnchor: [0, -32]
              });
            } else if (isRecurringCustomer) {
              customIcon = L.divIcon({
                className: 'custom-marker-recurring',
                html: `<div style="font-size: 32px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); transform: translate(-50%, -50%); filter: hue-rotate(80deg) saturate(1.5);">ðŸ¦–</div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
              });
            } else if (hasUpcomingJob) {
              customIcon = L.divIcon({
                className: 'custom-marker-upcoming',
                html: `<div class="marker-pin ${pinClass}" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); position: relative;">${goldCheckmark}${verifyBadge}${routeNumberDisplay}${scheduledOtherDayBadge}${dayLabelBadge}</div>`,
                iconSize: [24, 32],
                iconAnchor: [12, 32],
                popupAnchor: [0, -32]
              });
            } else {
              customIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div class="marker-pin ${pinClass}" style="background: ${gradient}; position: relative;">${goldCheckmark}${verifyBadge}${routeNumberDisplay}${scheduledOtherDayBadge}${dayLabelBadge}</div>`,
                iconSize: [24, 32],
                iconAnchor: [12, 32],
                popupAnchor: [0, -32]
              });
            }

            const marker = L.marker([customer.lat, customer.lng], { 
              icon: customIcon,
              customerData: customer
            });

            const distanceFromHome = homeBase 
              ? calculateDistance(homeBase.lat, homeBase.lng, customer.lat, customer.lng)
              : null;

            // Simple hover tooltip


            // Rich popup shows on hover (see mouseover event below)
            // No tooltip needed as popup provides all info
            
            // Rich click popup with satellite preview
            const zoom = 20;
            const x = Math.floor((customer.lng + 180) / 360 * Math.pow(2, zoom));
            const y = Math.floor((1 - Math.log(Math.tan(customer.lat * Math.PI / 180) + 1 / Math.cos(customer.lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom));
            
            const popupContent = `
              <div style="font-family: 'Inter', sans-serif; width: 180px;">
                <div style="margin-bottom: 8px; border-radius: 4px; overflow: hidden; border: 1px solid rgba(139, 92, 246, 0.3); position: relative;">
                  <img src="https://mt1.google.com/vt/lyrs=y&x=${x}&y=${y}&z=${zoom}" style="width: 180px; height: 180px; display: block;" />
                  <div style="position: absolute; top: 4px; left: 4px; background: rgba(0,0,0,0.7); padding: 3px 6px; border-radius: 3px; font-size: 8px; font-weight: 600;">ðŸ›°ï¸</div>
                </div>
                
                <div style="margin-bottom: 8px;">
                  <div style="font-size: 11px; font-weight: 700; color: #f1f5f9; margin-bottom: 3px;">${customer.name}</div>
                  <div style="font-size: 9px; color: #94a3b8; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">ðŸ“ ${customer.address}</div>
                  ${customer.panelCount ? `<div style="font-size: 9px; color: #fbbf24;">${customer.panelCount} panels</div>` : ''}
                  ${customer._dayOfWeek !== undefined && customer._routeDate ? `<div style="font-size: 9px; color: #22c55e; margin-top: 2px;">âœ“ Routed: ${new Date(customer._routeDate).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}${customer.scheduledTime ? ' @ ' + formatTime12h(customer.scheduledTime) : ''}</div>` : ''}
                </div>
                
                ${customer.existingJob ? `
                <div style="margin-bottom: 8px; padding: 8px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 6px;">
                  <div style="font-size: 8px; color: #94a3b8; margin-bottom: 4px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Service History</div>
                  ${customer.totalPanels ? `<div style="font-size: 9px; color: #f1f5f9; margin-bottom: 2px;">â˜€ï¸ ${customer.totalPanels} panels</div>` : ''}
                  ${customer.lastServiceDate ? `<div style="font-size: 9px; color: #f1f5f9; margin-bottom: 2px;">ðŸ“… Last: ${new Date(customer.lastServiceDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' })}</div>` : ''}
                  ${customer.amountPaid ? `<div style="font-size: 9px; color: #22c55e; margin-bottom: 2px;">ðŸ’µ $${customer.amountPaid}</div>` : ''}
                  ${customer.isRecurring ? `<div style="font-size: 9px; color: #3b82f6; margin-bottom: 2px;">ðŸ¦– Recurring</div>` : ''}
                  ${customer.nextScheduledDate && customer.isRecurring ? `<div style="font-size: 9px; color: #3b82f6;">ðŸ“† Next: ${new Date(customer.nextScheduledDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' })}</div>` : ''}
                </div>
                ` : ''}
                
                <div style="display: flex; flex-direction: column; gap: 4px;">
                  <button 
                    onclick="window.dispatchEvent(new CustomEvent('viewCustomerProfile', {detail: '${customer.id}'}))"
                    style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white; border: none; padding: 6px; border-radius: 4px; font-weight: 600; font-size: 10px; cursor: pointer; font-family: 'Inter', sans-serif;">
                    ðŸ‘¤ View Profile
                  </button>
                  <button 
                    onclick="window.dispatchEvent(new CustomEvent('addJobForCustomer', {detail: '${customer.id}'}))"
                    style="background: rgba(34, 197, 94, 0.1); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); padding: 6px; border-radius: 4px; font-weight: 600; font-size: 10px; cursor: pointer; font-family: 'Inter', sans-serif;">
                    + Add Job
                  </button>
                  <a 
                    href="https://www.google.com/maps/@${customer.lat},${customer.lng},20z/data=!3m1!1e3"
                    target="_blank"
                    style="background: rgba(59, 130, 246, 0.1); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); padding: 6px; border-radius: 4px; font-weight: 600; font-size: 10px; text-align: center; text-decoration: none; display: block; font-family: 'Inter', sans-serif;">
                    ðŸ—ºï¸ Maps
                  </a>
                </div>
              </div>
            `;
            
            marker.bindPopup(popupContent, {
              maxWidth: 180,
              minWidth: 180,
              className: 'custom-popup',
              closeButton: true,
              autoClose: false,
              closeOnClick: false,
              autoPan: false,  // Don't move map
              keepInView: false,  // Let popup extend outside if needed
              offset: [0, -10]  // Slight offset above pin
            });
            
            marker.on('click', (e) => {
              L.DomEvent.stopPropagation(e);
              marker.closePopup();
              if (statusFilter === 'scheduled') {
                if (customer._needsScheduling && focusedDays.length > 1) {
                  window.dispatchEvent(new CustomEvent('showDayPicker', { detail: { customerId: customer.id } }));
                } else {
                  handleCustomerClick(customer);
                }
              } else {
                setProfileCustomer(customer);
                setShowCustomerProfile(true);
              }
            });
            
            // Hover = show popup with delay
            let showTimeout;
            let hideTimeout;
            
            marker.on('mouseover', () => {
              setHoveredCustomer(customer); // For sidebar highlighting only
              clearTimeout(hideTimeout);
              
              // Highlight marker directly without re-render (only if not in route or suggested)
              if (!isInRoute && !isSuggested) {
                const markerElement = marker.getElement();
                if (markerElement) {
                  const pinElement = markerElement.querySelector('.marker-pin');
                  if (pinElement) {
                    pinElement.style.background = 'linear-gradient(135deg, #c4b5fd 0%, #a78bfa 100%)';
                    pinElement.style.transform = 'rotate(-45deg) scale(1.3)';
                    pinElement.style.boxShadow = '0 8px 20px rgba(139, 92, 246, 0.6)';
                  }
                }
              }
              
              // Small delay to prevent accidental triggers
              showTimeout = setTimeout(() => {
                marker.openPopup();
              }, 100);
            });
            
            marker.on('mouseout', () => {
              setHoveredCustomer(null); // Clear sidebar highlighting
              clearTimeout(showTimeout);
              
              // Reset marker highlighting (only if not in route or suggested)
              if (!isInRoute && !isSuggested) {
                const markerElement = marker.getElement();
                if (markerElement) {
                  const pinElement = markerElement.querySelector('.marker-pin');
                  if (pinElement) {
                    pinElement.style.background = gradient;
                    pinElement.style.transform = 'rotate(-45deg) scale(1)';
                    pinElement.style.boxShadow = '0 4px 16px rgba(139, 92, 246, 0.5)';
                  }
                }
              }
              
              // Delay closing to allow moving to popup
              hideTimeout = setTimeout(() => {
                const popup = marker.getPopup();
                if (popup && popup.isOpen()) {
                  const popupElement = popup.getElement();
                  if (popupElement && !popupElement.matches(':hover')) {
                    marker.closePopup();
                  }
                }
              }, 150);
            });
            
            // Keep popup open when hovering over it
            marker.on('popupopen', () => {
              const popup = marker.getPopup();
              const popupElement = popup.getElement();
              
              if (popupElement) {
                popupElement.addEventListener('mouseenter', () => {
                  clearTimeout(hideTimeout);
                });
                
                popupElement.addEventListener('mouseleave', () => {
                  marker.closePopup();
                });
              }
            });

            markerClusterRef.current.addLayer(marker);
            markersMapRef.current.set(customer.id, marker);
          });

          // Draw route lines - ONLY when a specific day is focused
          if (statusFilter === 'scheduled' && homeBase && focusedDays.length > 0) {
            const DAY_LINE_COLORS = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#8b5cf6', '#ec4899'];
            focusedDays.forEach(fd => {
              const dateKey = fd.toDateString();
              const lineColor = DAY_LINE_COLORS[fd.getDay()] || '#22c55e';
              const dayJobs = customers
                .filter(c => {
                  if (!c.scheduledDate || !c.scheduledTime) return false;
                  const custDate = new Date(c.scheduledDate);
                  return custDate.toDateString() === dateKey;
                })
                .sort((a, b) => {
                  const [aH, aM] = a.scheduledTime.split(':').map(Number);
                  const [bH, bM] = b.scheduledTime.split(':').map(Number);
                  return (aH * 60 + aM) - (bH * 60 + bM);
                });

              if (dayJobs.length > 0) {
                const line1 = L.polyline(
                  [[homeBase.lat, homeBase.lng], [dayJobs[0].lat, dayJobs[0].lng]],
                  { color: lineColor, weight: 3, opacity: 0.7, dashArray: '5, 10' }
                ).addTo(mapInstanceRef.current);
                routeLinesRef.current.push(line1);
                for (let i = 0; i < dayJobs.length - 1; i++) {
                  const line = L.polyline(
                    [[dayJobs[i].lat, dayJobs[i].lng], [dayJobs[i + 1].lat, dayJobs[i + 1].lng]],
                    { color: lineColor, weight: 3, opacity: 0.8 }
                  ).addTo(mapInstanceRef.current);
                  routeLinesRef.current.push(line);
                }
              }
            });
          }
        }
      }, [filteredCustomers, showHeatMap, route, suggestedCustomers, homeBase, selectedDate, customers, statusFilter, hoveredPrefDay, hoveredPrefTime, focusedDays]);

      // UNIFIED FILTER - Single useEffect that applies ALL filters together
      // This includes: customer type, nav filters (status, date, time), search bar filters (city, state, zip),
      // active filters (solar, existing, recurring, panels), radius/drawn area, and text search
      useEffect(() => {
        if (customers.length === 0) {
          setFilteredCustomers([]);
          return;
        }

        let results = typeFilteredCustomers;

        // --- Navigation bar filters ---
        // Status filter (unscheduled, scheduled)
        if (statusFilter === 'scheduled') {
          let rangeStart, rangeEnd;
          if (focusedDays.length > 0) {
            const sortedDays = [...focusedDays].sort((a, b) => a - b);
            rangeStart = new Date(sortedDays[0]);
            rangeStart.setHours(0, 0, 0, 0);
            rangeEnd = new Date(sortedDays[sortedDays.length - 1]);
            rangeEnd.setHours(23, 59, 59, 999);
          } else {
            rangeStart = new Date(scheduledViewWeekStart);
            rangeStart.setHours(0, 0, 0, 0);
            rangeEnd = new Date(rangeStart);
            rangeEnd.setDate(rangeEnd.getDate() + (scheduledMapView === 'both' ? 13 : 6));
            rangeEnd.setHours(23, 59, 59, 999);
          }

          // Cap range to 3 months from today max (far-future recurring jobs are hidden)
          const threeMonthsOut = new Date();
          threeMonthsOut.setMonth(threeMonthsOut.getMonth() + 3);
          threeMonthsOut.setHours(23, 59, 59, 999);
          if (rangeEnd > threeMonthsOut) {
            rangeEnd = threeMonthsOut;
          }

          // Get scheduled customers from saved routes in this range
          const scheduledInRange = getScheduledCustomersForRange(rangeStart, rangeEnd);
          const scheduledIds = new Set(scheduledInRange.map(c => c.id));

          // Also include customers actively scheduled via edit mode (not yet saved to route)
          results.forEach(c => {
            if (c.scheduledDate && c.scheduledTime && c.status === 'scheduled') {
              const custDate = new Date(c.scheduledDate);
              if (custDate >= rangeStart && custDate <= rangeEnd && !scheduledIds.has(c.id)) {
                scheduledIds.add(c.id);
                scheduledInRange.push({
                  ...c,
                  _routeDate: custDate,
                  _routeName: 'Editing',
                  _dayOfWeek: custDate.getDay(),
                  _dayLabel: custDate.toLocaleDateString('en-US', { weekday: 'short' })
                });
              }
            }
          });

          // Tag customers with route day info
          const dayInfoMap = new Map();
          scheduledInRange.forEach(c => {
            dayInfoMap.set(c.id, { _routeDate: c._routeDate, _routeName: c._routeName, _dayOfWeek: c._dayOfWeek, _dayLabel: c._dayLabel });
          });

          // Filter to scheduled customers (with day info) + unscheduled customers with jobs
          const unscheduledCustomers = results.filter(c => (c.status || '').toLowerCase() === 'unscheduled' && !scheduledIds.has(c.id));
          results = results.filter(c => scheduledIds.has(c.id));
          results = results.map(c => {
            const info = dayInfoMap.get(c.id);
            return info ? { ...c, ...info } : { ...c, _needsScheduling: true };
          });
          if (focusedDays.length > 0) {
            const focusedDateStrs = new Set(focusedDays.map(fd => fd.toDateString()));
            results = results.filter(c => {
              if (c._needsScheduling) return false;
              const rd = c._routeDate ? new Date(c._routeDate).toDateString() : null;
              return rd && focusedDateStrs.has(rd);
            });
          }
          // Always include unscheduled customers on Route Planner map
          results = results.concat(unscheduledCustomers.map(c => ({ ...c, _needsScheduling: true })));
        } else if (statusFilter === 'unscheduled') {
          results = results.filter(c => (c.status || '').toLowerCase() === 'unscheduled');
        } else if (statusFilter !== 'all') {
          results = results.filter(c => (c.status || '').toLowerCase() === statusFilter);
        }

        // Preferred day/time filters are now highlight-only, no filtering

        // --- Active toggle filters ---
        if (activeFilters.verifiedSolar) {
          results = results.filter(c => c.solarVerified === 'yes');
        }
        if (activeFilters.existingJob) {
          results = results.filter(c => c.existingJob === true);
        }
        if (activeFilters.recurring) {
          results = results.filter(c => c.isRecurring === true || c.recurring === true || c.recurring === 'TRUE');
        }
        if (activeFilters.minPanels && !isNaN(parseInt(activeFilters.minPanels))) {
          const minPanels = parseInt(activeFilters.minPanels);
          results = results.filter(c => {
            const panelCount = parseInt(c.panelCount || c.totalPanels) || 0;
            return panelCount >= minPanels;
          });
        }

        // Last Service filter (from activeFilters)
        if (activeFilters.lastService) {
          const now = new Date();
          results = results.filter(c => {
            if (!c.lastServiceDate) return false;
            const lastService = new Date(c.lastServiceDate);
            const monthsDiff = (now - lastService) / (1000 * 60 * 60 * 24 * 30);
            switch (activeFilters.lastService) {
              case '3months': return monthsDiff > 3;
              case '6months': return monthsDiff > 6;
              case '1year': return monthsDiff > 12;
              case '18months': return monthsDiff > 18;
              case '2years': return monthsDiff > 24;
              default: return true;
            }
          });
        }

        // Recurring Auto-List filter
        if (showRecurringList) {
          results = results.filter(c => c.isRecurring === true || c.recurring === true);
        }

        // --- Location filters (city/state/zip dropdowns) ---
        if (cityFilter) {
          results = results.filter(c => (c.city?.toLowerCase() || '') === cityFilter.toLowerCase());
        }
        if (stateFilter) {
          results = results.filter(c => (c.state?.toLowerCase() || '') === stateFilter.toLowerCase());
        }
        if (zipFilter) {
          results = results.filter(c => (c.zip?.toLowerCase() || '').startsWith(zipFilter.toLowerCase()));
        }

        // --- Radius panel: time-based service filter ---
        if (lastServiceFilter) {
          const now = new Date();
          const monthsMap = { '3months': 3, '6months': 6, '12months': 12 };
          const monthsAgo = monthsMap[lastServiceFilter];
          if (monthsAgo) {
            const cutoffDate = new Date(now);
            cutoffDate.setMonth(cutoffDate.getMonth() - monthsAgo);
            results = results.filter(c => {
              if (!c.lastServiceDate) return true;
              const serviceDate = new Date(c.lastServiceDate);
              return serviceDate < cutoffDate;
            });
          }
        }

        // --- Spatial filters (radius circle & drawn polygon) ---
        // Radius filter: only show customers within the radius circle
        if (referencePoint && radiusMiles) {
          results = results.filter(c => {
            if (!c.lat || !c.lng) return false;
            // calculateDistance returns miles
            return calculateDistance(c.lat, c.lng, referencePoint.lat, referencePoint.lng) <= radiusMiles;
          });
        }

        // Drawn area filter
        if (drawnArea && drawnPolygon) {
          results = results.filter(c => {
            if (!c.lat || !c.lng) return false;
            const point = L.latLng(c.lat, c.lng);
            return drawnPolygon.getBounds().contains(point);
          });
        }

        // --- Text search ---
        if (searchQuery.trim()) {
          const query = searchQuery.toLowerCase().trim();

          // Panel count search: p40 means 40+ panels
          if (query.startsWith('p') && !isNaN(query.substring(1))) {
            const minPanels = parseInt(query.substring(1));
            results = results.filter(c => {
              const panelCount = parseInt(c.panelCount || c.totalPanels) || 0;
              return panelCount >= minPanels;
            });
          } else if (query === 'recurring') {
            // Recurring keyword search
            results = results.filter(c => c.isRecurring === true || c.recurring === true);
          } else {
            // State abbreviation normalization
            const stateMap = {
              'tx': 'texas', 'texas': 'texas',
              'ca': 'california', 'california': 'california',
              'fl': 'florida', 'florida': 'florida',
              'ny': 'new york', 'newyork': 'new york',
              'az': 'arizona', 'arizona': 'arizona'
            };

            const normalizedQuery = stateMap[query] || query;

            // Regular search with state normalization
            results = results.filter(c => {
              const normalizedState = (c.state?.toLowerCase() || '');
              const stateFullName = stateMap[normalizedState] || normalizedState;

              return (c.name?.toLowerCase() || '').includes(query) ||
                c.firstName?.toLowerCase().includes(query) ||
                c.lastName?.toLowerCase().includes(query) ||
                (c.address?.toLowerCase() || '').includes(query) ||
                c.city?.toLowerCase().includes(query) ||
                normalizedState.includes(query) ||
                stateFullName.includes(normalizedQuery) ||
                c.zip?.toLowerCase().includes(query) ||
                c.email?.toLowerCase().includes(query) ||
                c.phone?.toLowerCase().includes(query) ||
                c.secondaryEmails?.some(email => email?.toLowerCase().includes(query)) ||
                c.secondaryPhones?.some(phone => phone?.toLowerCase().includes(query));
            });
          }
        }

        setFilteredCustomers(results);
      }, [searchQuery, customers, typeFilteredCustomers, activeCustomerType, cityFilter, stateFilter, zipFilter, lastServiceFilter,
          drawnArea, drawnPolygon, activeFilters, statusFilter, preferredDateFilter,
          preferredTimeFilter, showRecurringList, referencePoint, radiusMiles,
          scheduledMapView, scheduledViewWeekStart, showNeedScheduling, savedRoutes, focusedDays]);

      // Handle customer click - DAY SPECIFIC ROUTING
      const handleCustomerClick = (customer) => {
        if (statusFilter !== 'scheduled') {
          setSelectedCustomer(customer);
          return;
        }

        const effectiveDate = (statusFilter === 'scheduled' && focusedDays.length > 0) ? focusedDays[0] : selectedDate;
        const dateKey = effectiveDate.toDateString();
        const currentDayRoute = routesByDay[dateKey] || [];

        if (statusFilter === 'scheduled' && !routePlannerEditMode) {
          setRoutePlannerEditMode(true);
        }

        // Guard: if in route planner, block clicks on pins from OTHER days' routes
        if (statusFilter === 'scheduled') {
          const isOnAnotherDaysRoute = Object.entries(routesByDay).some(([key, stops]) => {
            if (key === dateKey) return false;
            return stops.some(s => s.id === customer.id);
          });
          const isInSavedRouteOtherDay = savedRoutes.some(r => {
            const rDate = new Date(r.scheduledDate);
            if (rDate.toDateString() === dateKey) return false;
            return (r.customers || []).some(c => c.id === customer.id);
          });
          if (isOnAnotherDaysRoute || isInSavedRouteOtherDay) {
            return;
          }
        }

        // Check BOTH routesByDay AND customers state for existing scheduling
        const isInRoutesByDay = currentDayRoute.some(r => r.id === customer.id);
        const isScheduledForDay = customers.some(c => {
          if (c.id !== customer.id) return false;
          if (!c.scheduledDate) return false;
          return new Date(c.scheduledDate).toDateString() === dateKey;
        });
        const isInRoute = isInRoutesByDay || isScheduledForDay;

        if (isInRoute) {
          // Remove from THIS DAY'S route AND clear scheduling (only if actually scheduled)
          setRoutesByDay(prev => ({
            ...prev,
            [dateKey]: (prev[dateKey] || []).filter(r => r.id !== customer.id)
          }));

          const unscheduleUpdates = { scheduledDate: null, scheduledTime: null, status: getStatusAfterUnschedule(customer), routeConfirmed: false };
          setCustomers(prev => prev.map(c => {
            if (c.id === customer.id) {
              return { ...c, ...unscheduleUpdates };
            }
            return c;
          }));
          propagateCustomerUpdate(customer.id, unscheduleUpdates);

          const savedRoutesForDay = savedRoutes.filter(r => {
            const rDate = new Date(r.scheduledDate);
            return rDate.toDateString() === dateKey;
          });
          const selectedIdx = selectedRouteIndexByDay[dateKey] || 0;
          const savedRouteForDay = savedRoutesForDay[selectedIdx] || savedRoutesForDay[0];
          if (savedRouteForDay && !savedRouteForDay.sentToTech) {
            setSavedRoutes(prev => prev.map(r => {
              if (r.id === savedRouteForDay.id) {
                return { ...r, customers: (r.customers || []).filter(c => c.id !== customer.id) };
              }
              return r;
            }));
          }
          setSuggestedCustomers([]);
        } else {
          const savedRoutesForDay = savedRoutes.filter(r => {
            const rDate = new Date(r.scheduledDate);
            return rDate.toDateString() === dateKey;
          });
          const selectedIdx = selectedRouteIndexByDay[dateKey] || 0;
          const savedRouteForDay = savedRoutesForDay[selectedIdx] || savedRoutesForDay[0];

          const jobsForDay = customers
            .filter(c => {
              if (!c.scheduledDate || !c.scheduledTime) return false;
              const custDate = new Date(c.scheduledDate);
              return custDate.toDateString() === effectiveDate.toDateString();
            })
            .sort((a, b) => {
              const [aH, aM] = a.scheduledTime.split(':').map(Number);
              const [bH, bM] = b.scheduledTime.split(':').map(Number);
              return (aH * 60 + aM) - (bH * 60 + bM);
            });

          let allExistingJobs = [...jobsForDay];
          const unsavedSavedRouteForDay = savedRouteForDay && !savedRouteForDay.sentToTech ? savedRouteForDay : null;
          if (unsavedSavedRouteForDay && savedViewDays[dateKey] === true) {
            const savedJobs = (unsavedSavedRouteForDay.customers || [])
              .filter(rc => rc.scheduledTime)
              .sort((a, b) => {
                const [aH, aM] = a.scheduledTime.split(':').map(Number);
                const [bH, bM] = b.scheduledTime.split(':').map(Number);
                return (aH * 60 + aM) - (bH * 60 + bM);
              });
            const existingIds = new Set(jobsForDay.map(j => j.id));
            savedJobs.forEach(sj => {
              if (!existingIds.has(sj.id)) allExistingJobs.push(sj);
            });
            allExistingJobs.sort((a, b) => {
              const [aH, aM] = a.scheduledTime.split(':').map(Number);
              const [bH, bM] = b.scheduledTime.split(':').map(Number);
              return (aH * 60 + aM) - (bH * 60 + bM);
            });
          }

          let nextSlot = null;
          if (allExistingJobs.length === 0) {
            nextSlot = { time: '08:00', hour: 8, minute: 0 };
          } else {
            const lastJob = allExistingJobs[allExistingJobs.length - 1];
            const [lastH, lastM] = lastJob.scheduledTime.split(':').map(Number);
            const nextMinutes = (lastH * 60 + lastM) + 75;
            const nextH = Math.floor(nextMinutes / 60);
            const nextM = nextMinutes % 60;
            if (nextH < 20) {
              nextSlot = {
                time: `${String(nextH).padStart(2, '0')}:${String(nextM).padStart(2, '0')}`,
                hour: nextH,
                minute: nextM
              };
            }
          }

          if (unsavedSavedRouteForDay && savedViewDays[dateKey] === true) {
            const routeCustomerMap = new Map();
            unsavedSavedRouteForDay.customers.forEach(rc => {
              routeCustomerMap.set(rc.id, rc);
            });
            const newTime = nextSlot ? nextSlot.time : '08:00';
            setCustomers(prev => prev.map(c => {
              if (c.id === customer.id) {
                return {
                  ...c,
                  scheduledDate: effectiveDate.toISOString(),
                  scheduledTime: newTime,
                  status: 'scheduled',
                  routeConfirmed: false
                };
              }
              const rc = routeCustomerMap.get(c.id);
              if (rc) {
                return {
                  ...c,
                  scheduledTime: rc.scheduledTime || c.scheduledTime,
                  scheduledDate: unsavedSavedRouteForDay.scheduledDate || rc.scheduledDate || c.scheduledDate,
                  status: 'scheduled',
                  routeConfirmed: true
                };
              }
              return c;
            }));

            setRoutesByDay(prev => ({
              ...prev,
              [dateKey]: [...unsavedSavedRouteForDay.customers, { ...customer, scheduledTime: newTime, scheduledDate: effectiveDate.toISOString() }]
            }));
            setEditingSavedRouteId(unsavedSavedRouteForDay.id);
            setSavedViewDays(prev => ({ ...prev, [dateKey]: false }));
            setUnsavedRouteChanges(true);
            setUnsavedRouteDays(prev => ({ ...prev, [dateKey]: true }));
          } else {
            if (nextSlot) {
              scheduleCustomerToTimeSlot(customer, effectiveDate, nextSlot.time);
            }
            setRoutesByDay(prev => {
              const existing = prev[dateKey] || [];
              if (existing.some(r => r.id === customer.id)) return prev;
              return { ...prev, [dateKey]: [...existing, customer] };
            });
            setUnsavedRouteChanges(true);
            setUnsavedRouteDays(prev => ({ ...prev, [dateKey]: true }));
          }

          setSuggestedCustomers([]);
        }
      };

      // Sync route state with current day's route when switching days
      useEffect(() => {
        const dateKey = selectedDate.toDateString();
        const currentDayRoute = routesByDay[dateKey] || [];
        setRoute(currentDayRoute);

        // Re-engage edit mode if this day has unsaved changes
        if (unsavedRouteDays[dateKey] && currentDayRoute.length > 0 && statusFilter === 'scheduled') {
          setRoutePlannerEditMode(true);
        }
      }, [selectedDate, routesByDay]);

      // Drag and drop handlers for route reordering
      const handleRouteDragStart = (index) => {
        setDraggedIndex(index);
      };

      const handleRouteDragOver = (e, index) => {
        e.preventDefault();
      };

      const handleRouteDrop = (index) => {
        if (draggedIndex === null || draggedIndex === index) {
          setDraggedIndex(null);
          return;
        }

        const dateKey = selectedDate.toDateString();
        const newRoute = [...route];
        const draggedItem = newRoute[draggedIndex];
        newRoute.splice(draggedIndex, 1);
        newRoute.splice(index, 0, draggedItem);
        
        // Update day-specific route
        setRoutesByDay(prev => ({
          ...prev,
          [dateKey]: newRoute
        }));
        
        setRoute(newRoute);
        setDraggedIndex(null);
        setUnsavedRouteChanges(true);
        setUnsavedRouteDays(prev => ({ ...prev, [dateKey]: true }));
      };

      // Save route (handles both new and edit modes)
      const handleSaveRoute = async () => {
        if (!routeName.trim()) {
          setError('Please enter a route name');
          setTimeout(() => setError(null), 3000);
          return;
        }

        const dateKey = selectedDate.toDateString();
        const scheduledForDay = customers
          .filter(c => {
            if (!c.scheduledDate || !c.scheduledTime) return false;
            return new Date(c.scheduledDate).toDateString() === dateKey;
          })
          .sort((a, b) => {
            const [aH, aM] = a.scheduledTime.split(':').map(Number);
            const [bH, bM] = b.scheduledTime.split(':').map(Number);
            return (aH * 60 + aM) - (bH * 60 + bM);
          });

        const routeCustomersRaw = scheduledForDay.map(c => ({
          ...c,
          distanceFromHome: homeBase ? calculateDistance(homeBase.lat, homeBase.lng, c.lat, c.lng) : null
        }));

        const routeCustomers = await Promise.all(routeCustomersRaw.map(async (c) => {
          try {
            const data = await apiFetch('/jobs?customer_id=' + c.id);
            if (data && data.jobs && data.jobs.length > 0) {
              const activeJob = data.jobs.find(j => j.status !== 'completed' && j.status !== 'cancelled');
              if (activeJob) {
                return { 
                  ...c, 
                  jobPrice: parseFloat(activeJob.price) || c.jobPrice || 0,
                  panelCount: parseInt(activeJob.panel_count || activeJob.panelCount) || c.panelCount || c.totalPanels || 0,
                  totalPanels: parseInt(activeJob.panel_count || activeJob.panelCount) || c.panelCount || c.totalPanels || 0,
                  amountPaid: parseFloat(activeJob.price) || c.amountPaid || 0,
                  jobDescription: activeJob.job_description || activeJob.jobDescription || c.jobDescription || c.job_description || '',
                  isRecurring: activeJob.is_recurring || activeJob.isRecurring || c.isRecurring || false,
                  scheduledTime: c.scheduledTime || activeJob.scheduled_time || activeJob.scheduledTime || '',
                  jobNotes: activeJob.notes || ''
                };
              }
            }
          } catch (e) {}
          return c;
        }));

        let routeTotalDistance = 0;
        const stopsWithCoords = routeCustomers.filter(c => c.lat && c.lng);
        if (stopsWithCoords.length > 0 && homeBase) {
          routeTotalDistance = calculateDistance(homeBase.lat, homeBase.lng, stopsWithCoords[0].lat, stopsWithCoords[0].lng);
          for (let i = 0; i < stopsWithCoords.length - 1; i++) {
            routeTotalDistance += calculateDistance(stopsWithCoords[i].lat, stopsWithCoords[i].lng, stopsWithCoords[i+1].lat, stopsWithCoords[i+1].lng);
          }
          routeTotalDistance += calculateDistance(stopsWithCoords[stopsWithCoords.length - 1].lat, stopsWithCoords[stopsWithCoords.length - 1].lng, homeBase.lat, homeBase.lng);
        }

        if (editingSavedRouteId) {
          setSavedRoutes(prev => prev.map(r => {
            if (r.id === editingSavedRouteId) {
              return {
                ...r,
                name: routeName,
                scheduledDate: selectedDate.toISOString(),
                customers: routeCustomers,
                totalDistance: routeTotalDistance
              };
            }
            return r;
          }));
          setEditingSavedRouteId(null);
        } else {
          const newRoute = {
            id: Date.now().toString(),
            name: routeName,
            date: new Date().toISOString(),
            scheduledDate: selectedDate.toISOString(),
            customers: routeCustomers,
            totalDistance: routeTotalDistance,
            confirmed: true,
            sentToTech: false,
            sentDate: null
          };
          setSavedRoutes(prev => [...prev, newRoute]);
        }

        const routeIds = new Set(routeCustomers.map(c => c.id));
        setCustomers(prev => prev.map(c => {
          if (routeIds.has(c.id)) {
            const scheduleUpdates = {
              status: 'scheduled',
              routeConfirmed: true,
              confirmedRouteName: routeName,
              confirmedRouteDate: selectedDate.toISOString()
            };
            propagateCustomerUpdate(c.id, scheduleUpdates);

            apiFetch('/jobs?customer_id=' + c.id).then(data => {
              if (data && data.jobs) {
                const activeJob = data.jobs.find(j => j.status !== 'completed' && j.status !== 'cancelled');
                if (activeJob) {
                  const routeDateStr = selectedDate.toISOString().split('T')[0];
                  apiFetch(`/jobs/${activeJob.id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status: 'scheduled', scheduled_date: routeDateStr })
                  }).catch(e => console.error('Failed to update job status:', e));
                }
              }
            }).catch(e => console.error('Failed to fetch jobs for route sync:', e));

            return { ...c, ...scheduleUpdates };
          }
          return c;
        }));

        // Add to pipeline
        const newPipelineCustomers = routeCustomers.filter(c =>
          !pipelineCustomers.some(pc => pc.id === c.id)
        ).map(c => ({
          ...c,
          pipelineId: Date.now().toString() + Math.random(),
          status: 'scheduled',
          lastCustomer: null,
          customerMethod: null,
          notes: '',
          addedDate: new Date().toISOString()
        }));

        if (newPipelineCustomers.length > 0) {
          setPipelineCustomers(prev => [...prev, ...newPipelineCustomers]);
        }

        setShowSaveModal(false);
        setRouteName('');
        setRoutePlannerEditMode(false);

        // Clear this day from unsaved tracking
        setUnsavedRouteDays(prev => {
          const next = { ...prev };
          delete next[dateKey];
          // If no more unsaved days, clear the global flag
          if (Object.keys(next).length === 0) {
            setUnsavedRouteChanges(false);
          }
          return next;
        });

        // Clear routesByDay for this date so stale data doesn't accumulate
        setRoutesByDay(prev => ({
          ...prev,
          [dateKey]: []
        }));

        // Switch to saved view for this date
        setSavedViewDays(prev => ({
          ...prev,
          [dateKey]: true
        }));
        setSuggestedCustomers([]);
        setEditingSavedRouteId(null);
      };

      // Save all unsaved routes across multiple days
      const handleSaveAllRoutes = async () => {
        const unsavedDayKeys = Object.keys(unsavedRouteDays).filter(dayKey => unsavedRouteDays[dayKey]);
        if (unsavedDayKeys.length === 0) return;

        for (const dayKey of unsavedDayKeys) {
          const dayRoute = routesByDay[dayKey] || [];
          if (dayRoute.length === 0) continue;

          const dayDate = new Date(dayKey);

          // Use routesByDay as source of truth, enrich with latest customer data
          const routeStops = dayRoute.map(rc => {
            const latestCustomer = customers.find(c => c.id === rc.id) || rc;
            return {
              ...latestCustomer,
              scheduledDate: latestCustomer.scheduledDate || dayDate.toISOString(),
              scheduledTime: latestCustomer.scheduledTime || rc.scheduledTime || '08:00'
            };
          }).sort((a, b) => {
            const [aH, aM] = (a.scheduledTime || '08:00').split(':').map(Number);
            const [bH, bM] = (b.scheduledTime || '08:00').split(':').map(Number);
            return (aH * 60 + aM) - (bH * 60 + bM);
          });

          const routeCustomers = await Promise.all(routeStops.map(async (c) => {
            const enriched = {
              ...c,
              distanceFromHome: homeBase ? calculateDistance(homeBase.lat, homeBase.lng, c.lat, c.lng) : null
            };
            try {
              const data = await apiFetch('/jobs?customer_id=' + c.id);
              if (data && data.jobs && data.jobs.length > 0) {
                const activeJob = data.jobs.find(j => j.status !== 'completed' && j.status !== 'cancelled');
                if (activeJob) {
                  return { 
                    ...enriched, 
                    jobPrice: parseFloat(activeJob.price) || enriched.jobPrice || 0,
                    panelCount: parseInt(activeJob.panel_count || activeJob.panelCount) || enriched.panelCount || enriched.totalPanels || 0,
                    totalPanels: parseInt(activeJob.panel_count || activeJob.panelCount) || enriched.panelCount || enriched.totalPanels || 0,
                    amountPaid: parseFloat(activeJob.price) || enriched.amountPaid || 0,
                    jobDescription: activeJob.job_description || activeJob.jobDescription || enriched.jobDescription || enriched.job_description || '',
                    isRecurring: activeJob.is_recurring || activeJob.isRecurring || enriched.isRecurring || false,
                    scheduledTime: enriched.scheduledTime || activeJob.scheduled_time || activeJob.scheduledTime || '',
                    jobNotes: activeJob.notes || ''
                  };
                }
              }
            } catch (e) {}
            return enriched;
          }));

          if (routeCustomers.length === 0) continue;

          let routeTotalDistance = 0;
          const stopsWithCoords = routeCustomers.filter(c => c.lat && c.lng);
          if (stopsWithCoords.length > 0 && homeBase) {
            routeTotalDistance = calculateDistance(homeBase.lat, homeBase.lng, stopsWithCoords[0].lat, stopsWithCoords[0].lng);
            for (let i = 0; i < stopsWithCoords.length - 1; i++) {
              routeTotalDistance += calculateDistance(stopsWithCoords[i].lat, stopsWithCoords[i].lng, stopsWithCoords[i+1].lat, stopsWithCoords[i+1].lng);
            }
            routeTotalDistance += calculateDistance(stopsWithCoords[stopsWithCoords.length - 1].lat, stopsWithCoords[stopsWithCoords.length - 1].lng, homeBase.lat, homeBase.lng);
          }

          const routeDateStr = dayDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
          const newRoute = {
            id: Date.now().toString() + '_' + dayKey,
            name: `Route - ${routeDateStr}`,
            date: new Date().toISOString(),
            scheduledDate: dayDate.toISOString(),
            customers: routeCustomers,
            totalDistance: routeTotalDistance,
            confirmed: true,
            sentToTech: false,
            sentDate: null
          };

          setSavedRoutes(prev => [...prev, newRoute]);

          const routeIds = new Set(routeCustomers.map(c => c.id));
          setCustomers(prev => prev.map(c => {
            if (routeIds.has(c.id)) {
              const scheduleUpdates = {
                status: 'scheduled',
                routeConfirmed: true,
                confirmedRouteName: newRoute.name,
                confirmedRouteDate: dayDate.toISOString()
              };
              propagateCustomerUpdate(c.id, scheduleUpdates);

              apiFetch('/jobs?customer_id=' + c.id).then(data => {
                if (data && data.jobs) {
                  const activeJob = data.jobs.find(j => j.status !== 'completed' && j.status !== 'cancelled');
                  if (activeJob) {
                    apiFetch(`/jobs/${activeJob.id}`, {
                      method: 'PATCH',
                      body: JSON.stringify({ status: 'scheduled', scheduled_date: dayDate.toISOString().split('T')[0] })
                    }).catch(e => console.error('Failed to update job status:', e));
                  }
                }
              }).catch(e => console.error('Failed to fetch jobs for route sync:', e));

              return { ...c, ...scheduleUpdates };
            }
            return c;
          }));

          // Clear routesByDay and switch to saved view for this day
          setRoutesByDay(prev => ({ ...prev, [dayKey]: [] }));
          setSavedViewDays(prev => ({ ...prev, [dayKey]: true }));
        }

        setUnsavedRouteDays({});
        setUnsavedRouteChanges(false);
        setRoutePlannerEditMode(false);
        setShowSaveModal(false);
        setRouteName('');
        setSuggestedCustomers([]);
        setEditingSavedRouteId(null);
        setRoute([]);
      };

      // Calendar helper functions
      const getWeekDays = (startDate) => {
        const days = [];
        for (let i = 0; i < 7; i++) {
          const date = new Date(startDate);
          date.setDate(startDate.getDate() + i);
          days.push(date);
        }
        return days;
      };

      const getMonthDays = (date) => {
        const year = date.getFullYear();
        const month = date.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const days = [];
        
        // Add days from the month
        for (let i = 1; i <= lastDay.getDate(); i++) {
          days.push(new Date(year, month, i));
        }
        
        return days;
      };

      const getRoutesForDate = (date) => {
        return savedRoutes.filter(route => {
          const routeDate = new Date(route.scheduledDate || route.date);
          return routeDate.toDateString() === date.toDateString();
        });
      };

      const navigateWeek = (direction) => {
        const newStart = new Date(weekStart);
        newStart.setDate(weekStart.getDate() + (direction * 7));
        setWeekStart(newStart);
      };

      const goToToday = () => {
        const today = new Date();
        const day = today.getDay();
        const diff = today.getDate() - day;
        const monday = new Date(today.setDate(diff));
        setWeekStart(monday);
        setSelectedDate(new Date());
      };

      // Day view helper functions
      const generateTimeSlots = () => {
        const slots = [];
        for (let hour = 6; hour < 20; hour++) { // 6am to 8pm
          for (let minute = 0; minute < 60; minute += 15) {
            const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            const displayTime = new Date(2000, 0, 1, hour, minute).toLocaleTimeString('en-US', {
              hour: 'numeric',
              minute: '2-digit',
              hour12: true
            });
            slots.push({ time: timeStr, display: displayTime, hour, minute });
          }
        }
        return slots;
      };

      const getJobsForTimeSlot = (date, timeSlot) => {
        if (!date) return [];
        const dateStr = date.toDateString();
        
        // Get all customers scheduled for this day
        const scheduledCustomers = customers.filter(c => {
          if (!c.scheduledDate || !c.scheduledTime) return false;
          const custDate = new Date(c.scheduledDate);
          return custDate.toDateString() === dateStr && c.scheduledTime === timeSlot;
        });
        
        return scheduledCustomers;
      };

      const scheduleCustomerToTimeSlot = (customer, date, timeSlot) => {
        // Check if customer is already on a DIFFERENT saved route for this day
        const dateKey = date.toDateString();
        const routesForDay = savedRoutes.filter(r => {
          const rDate = new Date(r.scheduledDate);
          return rDate.toDateString() === dateKey;
        });

        // If editing an existing route, exclude it from the check
        const otherRoutesForDay = routesForDay.filter(r => r.id !== editingSavedRouteId);

        // Check if customer is on any of the other routes for this day
        const conflictingRoute = otherRoutesForDay.find(r =>
          r.customers && r.customers.some(c => c.id === customer.id)
        );

        if (conflictingRoute) {
          alert(`${customer.name} is already scheduled on "${conflictingRoute.name}" for this day. A customer cannot be on multiple routes for the same day.`);
          return;
        }

        setCustomers(prev => {
          // Check if customer already has a time slot on this day
          const existingCustomer = prev.find(c => c.id === customer.id);
          let oldTime = null;
          
          if (existingCustomer && existingCustomer.scheduledDate && existingCustomer.scheduledTime) {
            const oldDate = new Date(existingCustomer.scheduledDate);
            if (oldDate.toDateString() === date.toDateString()) {
              oldTime = existingCustomer.scheduledTime;
            }
          }
          
          // If moving from one time to another on the same day
          if (oldTime && oldTime !== timeSlot) {
            const [oldHour, oldMin] = oldTime.split(':').map(Number);
            const [newHour, newMin] = timeSlot.split(':').map(Number);
            const oldMinutes = oldHour * 60 + oldMin;
            const newMinutes = newHour * 60 + newMin;
            
            // If moving DOWN (to a later time), shift all jobs after old time
            if (newMinutes > oldMinutes) {
              const timeDiff = newMinutes - oldMinutes;
              
              // Get all jobs for this day sorted by time
              const jobsForDay = prev
                .filter(c => {
                  if (!c.scheduledDate || !c.scheduledTime) return false;
                  const custDate = new Date(c.scheduledDate);
                  return custDate.toDateString() === date.toDateString();
                })
                .sort((a, b) => {
                  const [aH, aM] = a.scheduledTime.split(':').map(Number);
                  const [bH, bM] = b.scheduledTime.split(':').map(Number);
                  return (aH * 60 + aM) - (bH * 60 + bM);
                });
              
              // Find jobs that come after the old time (and are not the moved job)
              const jobsToShift = jobsForDay.filter(j => {
                if (j.id === customer.id) return false;
                const [jH, jM] = j.scheduledTime.split(':').map(Number);
                const jMinutes = jH * 60 + jM;
                return jMinutes > oldMinutes;
              });
              
              // Shift all subsequent jobs down
              return prev.map(c => {
                // Update the moved customer
                if (c.id === customer.id) {
                  return {
                    ...c,
                    scheduledDate: date.toISOString(),
                    scheduledTime: timeSlot
                    // DO NOT set lastServiceDate - only update when emailing to tech
                  };
                }
                
                // Shift subsequent jobs
                const shouldShift = jobsToShift.some(j => j.id === c.id);
                if (shouldShift) {
                  const [cH, cM] = c.scheduledTime.split(':').map(Number);
                  const newTotalMinutes = cH * 60 + cM + timeDiff;
                  const newH = Math.floor(newTotalMinutes / 60);
                  const newM = newTotalMinutes % 60;
                  
                  // Make sure we don't go past 8pm (20:00)
                  if (newH >= 20) return c;
                  
                  return {
                    ...c,
                    scheduledTime: `${String(newH).padStart(2, '0')}:${String(newM).padStart(2, '0')}`
                  };
                }
                
                return c;
              });
            }
          }
          
          // Default behavior: just schedule the customer
          return prev.map(c => {
            if (c.id === customer.id) {
              return {
                ...c,
                scheduledDate: date.toISOString(),
                scheduledTime: timeSlot,
                status: 'scheduled'
                // DO NOT set lastServiceDate - only update when emailing to tech
              };
            }
            return c;
          });
        });

        // Persist scheduling to database
        propagateCustomerUpdate(customer.id, {
          scheduledDate: date.toISOString(),
          scheduledTime: timeSlot,
          status: 'scheduled'
        });

        setUnsavedRouteChanges(true);
        setUnsavedRouteDays(prev => ({ ...prev, [dateKey]: true }));
      };

      // Mass email
      const handleMassEmail = (customers) => {
        const emails = customers.map(c => c.email).filter(Boolean).join(';');
        if (emails) {
          window.open(`mailto:${emails}`, '_blank');
        } else {
          setError('No email addresses found');
          setTimeout(() => setError(null), 3000);
        }
      };
      
      // Email route to tech with full details
      const emailRouteToTech = async (savedRoute) => {
        if (!savedRoute || !savedRoute.customers || savedRoute.customers.length === 0) {
          setError('No customers in route');
          setTimeout(() => setError(null), 3000);
          return;
        }
        
        const routeCustomers = savedRoute.customers.map(c => ({ ...c }));
        const today = new Date().toISOString();
        const todayFormatted = new Date().toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        
        const scheduledDate = savedRoute.scheduledDate || today;
        setCustomers(prev => prev.map(c => {
          const isInRoute = routeCustomers.some(rc => rc.id === c.id);
          if (isInRoute) {
            return {
              ...c,
              status: 'in progress',
              routeConfirmed: true,
              confirmedRouteName: savedRoute.name
            };
          }
          return c;
        }));
        
        routeCustomers.forEach(async (rc) => {
          propagateCustomerUpdate(rc.id, {
            status: 'in progress'
          });
          try {
            await apiFetch(`/customers/${rc.id}`, {
              method: 'PATCH',
              body: JSON.stringify({ status: 'in progress' })
            });
          } catch (err) {
            console.error('Error updating customer status to in progress:', err);
          }
        });

        const totalRevenue = routeCustomers.reduce((sum, c) => sum + (parseFloat(c.amountPaid) || 0), 0);
        
        const HOME_BASE = homeBase || { lat: 32.8866, lng: -97.3368 };
        const stopsWithCoords = routeCustomers.filter(c => c.lat && c.lng);
        let totalMiles = savedRoute.totalDistance || 0;
        let driveToFirst = 0;
        let driveFromLast = 0;
        
        if (stopsWithCoords.length > 0) {
          driveToFirst = calculateDistance(HOME_BASE.lat, HOME_BASE.lng, stopsWithCoords[0].lat, stopsWithCoords[0].lng);
          driveFromLast = calculateDistance(stopsWithCoords[stopsWithCoords.length - 1].lat, stopsWithCoords[stopsWithCoords.length - 1].lng, HOME_BASE.lat, HOME_BASE.lng);
          
          if (!totalMiles) {
            totalMiles = driveToFirst;
            for (let i = 0; i < stopsWithCoords.length - 1; i++) {
              totalMiles += calculateDistance(stopsWithCoords[i].lat, stopsWithCoords[i].lng, stopsWithCoords[i+1].lat, stopsWithCoords[i+1].lng);
            }
            totalMiles += driveFromLast;
          }
          
          for (let i = 0; i < routeCustomers.length; i++) {
            if (!routeCustomers[i].lat || !routeCustomers[i].lng) continue;
            routeCustomers[i].distanceFromHome = calculateDistance(HOME_BASE.lat, HOME_BASE.lng, routeCustomers[i].lat, routeCustomers[i].lng);
            routeCustomers[i].distanceToHome = calculateDistance(routeCustomers[i].lat, routeCustomers[i].lng, HOME_BASE.lat, HOME_BASE.lng);
            if (i === 0) {
              routeCustomers[i].distanceFromPrevious = driveToFirst;
            } else {
              const prev = routeCustomers[i - 1];
              routeCustomers[i].distanceFromPrevious = (prev.lat && prev.lng) 
                ? calculateDistance(prev.lat, prev.lng, routeCustomers[i].lat, routeCustomers[i].lng) 
                : 0;
            }
          }
        }
        
        const avgDistance = stopsWithCoords.length > 1 ? (totalMiles - driveToFirst - driveFromLast) / (stopsWithCoords.length - 1) : 0;

        setSendingEmail(true);
        try {
          let dbRouteId = savedRoute.dbRouteId || null;
          if (!dbRouteId) {
            const dbRoute = await apiFetch('/routes', {
              method: 'POST',
              body: JSON.stringify({
                name: savedRoute.name,
                scheduled_date: savedRoute.scheduledDate || today,
                status: 'in_progress',
                total_distance: totalMiles || 0,
                stops: routeCustomers.map((c, i) => ({
                  customer_id: c.id,
                  stop_order: i + 1,
                  scheduled_time: c.scheduledTime || '',
                  notes: c.jobNotes || c.customerNotes || '',
                  route_confirmed: true
                }))
              })
            });
            if (dbRoute && dbRoute.id) {
              dbRouteId = dbRoute.id;
              setSavedRoutes(prev => prev.map(r =>
                r.id === savedRoute.id ? { ...r, dbRouteId: dbRoute.id } : r
              ));
            }
          }

          const response = await apiFetch('/email/send-route', {
            method: 'POST',
            body: JSON.stringify({
              to: techEmail,
              routeData: {
                routeName: savedRoute.name,
                scheduledDate: savedRoute.scheduledDate || today,
                stops: routeCustomers.map(c => ({
                  name: c.name,
                  address: c.address,
                  phone: c.phone,
                  secondaryPhones: c.secondaryPhones || [],
                  email: c.email,
                  secondaryEmails: c.secondaryEmails || [],
                  scheduledTime: c.scheduledTime,
                  panelCount: c.panelCount || c.totalPanels,
                  isRecurring: c.isRecurring || c.recurring,
                  lastServiceDate: c.lastServiceDate,
                  amountPaid: c.amountPaid,
                  customerNotes: c.customerNotes || c.customer_notes || '',
                  jobNotes: c.jobNotes || '',
                  serviceType: c.jobDescription || c.job_description || ((c.customerType || c.customer_type || 'residential') === 'commercial' ? 'Commercial Panel Cleaning' : 'Residential Panel Cleaning'),
                  customerType: c.customerType || c.customer_type || 'residential',
                  distanceFromPrevious: c.distanceFromPrevious,
                  distanceFromHome: c.distanceFromHome,
                  distanceToHome: c.distanceToHome,
                  cumulativeDistance: c.cumulativeDistance
                })),
                routeId: dbRouteId || savedRoute.id,
                totalRevenue,
                totalMiles,
                avgDistance,
                driveToFirst,
                driveFromLast
              }
            })
          });
          if (response.success) {
            setError(null);
            setSavedRoutes(prev => prev.map(r =>
              r.id === savedRoute.id ? { ...r, sentToTech: true, sentDate: today, sentAt: new Date().toISOString(), dbRouteId: dbRouteId || r.dbRouteId } : r
            ));
            if (dbRouteId) {
              try {
                await apiFetch(`/routes/${dbRouteId}`, {
                  method: 'PATCH',
                  body: JSON.stringify({ sent_to_tech: true, sent_date: today, sent_at: new Date().toISOString() })
                });
              } catch (e) { console.error('Failed to persist sent status:', e); }
            }
            alert('Route email sent successfully to ' + techEmail + '!');
          } else {
            throw new Error(response.error || 'Failed to send email');
          }
        } catch (err) {
          console.error('Email send error:', err);
          setError('Failed to send email: ' + err.message);
          setTimeout(() => setError(null), 5000);
        } finally {
          setSendingEmail(false);
        }
      };


      const completeRoute = async (savedRoute) => {
        if (!savedRoute || !savedRoute.customers || savedRoute.customers.length === 0) return;
        if (savedRoute.completedAt) return;
        
        if (!window.confirm(`Mark route "${savedRoute.name}" as complete? This will update last service dates and finalize all jobs.`)) return;
        
        const routeCustomers = savedRoute.customers;
        const today = new Date().toISOString();
        const scheduledDate = savedRoute.scheduledDate || today;
        
        setCustomers(prev => prev.map(c => {
          const isInRoute = routeCustomers.some(rc => rc.id === c.id);
          if (isInRoute) {
            return {
              ...c,
              lastServiceDate: scheduledDate,
              status: '',
              routeConfirmed: false,
              confirmedRouteName: null,
              scheduledDate: null,
              nextScheduledDate: null,
              scheduledTime: null,
              serviceHistory: [
                ...(c.serviceHistory || []),
                {
                  id: `history_${Date.now()}_${Math.random()}`,
                  date: today,
                  routeName: savedRoute.name,
                  customerNotes: c.notes || '',
                  scheduledDate: savedRoute.scheduledDate,
                  jobType: c.jobType || 'Panel Cleaning',
                  cost: c.amountPaid || 0,
                  panelCount: c.panelCount || c.totalPanels || 0
                }
              ]
            };
          }
          return c;
        }));
        
        for (const rc of routeCustomers) {
          const isRecurring = rc.isRecurring || rc.recurring;
          
          if (isRecurring) {
            try {
              const jobsData = await apiFetch(`/jobs?customer_id=${rc.id}`);
              const activeRecurringJob = (jobsData.jobs || []).find(j => 
                j.is_recurring && j.status !== 'completed' && j.status !== 'cancelled'
              );
              if (activeRecurringJob) {
                const patchData = await apiFetch(`/jobs/${activeRecurringJob.id}`, {
                  method: 'PATCH',
                  body: JSON.stringify({ status: 'completed', completed_date: scheduledDate })
                });
                if (patchData.next_job) {
                  const nextDate = patchData.next_job.scheduled_date;
                  const daysUntilNext = Math.floor((new Date(nextDate) - new Date()) / (1000 * 60 * 60 * 24));
                  const newStatus = daysUntilNext <= 30 ? 'scheduled' : '';
                  setCustomers(prev => prev.map(c => c.id === rc.id ? {
                    ...c,
                    status: newStatus,
                    scheduledDate: nextDate,
                    nextScheduledDate: nextDate,
                    lastServiceDate: scheduledDate,
                    routeConfirmed: false,
                    confirmedRouteName: null,
                    scheduledTime: null
                  } : c));
                  await apiFetch(`/customers/${rc.id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ 
                      status: newStatus, 
                      last_service_date: scheduledDate,
                      scheduled_date: nextDate
                    })
                  });
                } else {
                  setCustomers(prev => prev.map(c => c.id === rc.id ? {
                    ...c, status: '', lastServiceDate: scheduledDate, routeConfirmed: false,
                    confirmedRouteName: null, scheduledDate: null, scheduledTime: null
                  } : c));
                  await apiFetch(`/customers/${rc.id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status: '', last_service_date: scheduledDate, scheduled_date: null })
                  });
                }
              }
            } catch (err) {
              console.error('Error completing recurring job for', rc.name, err);
            }
          } else {
            propagateCustomerUpdate(rc.id, {
              lastServiceDate: scheduledDate,
              status: '',
              routeConfirmed: false,
              confirmedRouteName: null,
              scheduledDate: null,
              scheduledTime: null
            });
            try {
              await apiFetch(`/customers/${rc.id}`, {
                method: 'PATCH',
                body: JSON.stringify({ 
                  status: '', 
                  last_service_date: scheduledDate,
                  scheduled_date: null
                })
              });
              const custJobsData = await apiFetch(`/jobs?customer_id=${rc.id}`);
              const activeJobs = (custJobsData.jobs || []).filter(j => j.status !== 'completed' && j.status !== 'cancelled');
              for (const j of activeJobs) {
                await apiFetch(`/jobs/${j.id}`, {
                  method: 'PATCH',
                  body: JSON.stringify({ status: 'completed', completed_date: scheduledDate })
                });
              }
            } catch (err) {
              console.error('Error completing non-recurring customer:', rc.name, err);
            }
          }
        }
        
        const completedAtTimestamp = new Date().toISOString();
        setSavedRoutes(prev => prev.map(r =>
          r.id === savedRoute.id ? { ...r, completedAt: completedAtTimestamp } : r
        ));
        
        try {
          await apiFetch(`/routes/${savedRoute.dbRouteId || savedRoute.id}`, {
            method: 'PATCH',
            body: JSON.stringify({ status: 'completed', completed_at: completedAtTimestamp })
          });
        } catch (e) { console.error('Failed to persist route completion:', e); }
        
        alert(`Route "${savedRoute.name}" marked as complete!`);
      };

      // Update pipeline customer
      const updatePipelineCustomer = (pipelineId, updates) => {
        setPipelineCustomers(prev => 
          prev.map(c => c.pipelineId === pipelineId ? { ...c, ...updates } : c)
        );
      };

      // Toggle pipeline selection
      const togglePipelineSelection = (pipelineId) => {
        setSelectedPipeline(prev => {
          if (prev.includes(pipelineId)) {
            return prev.filter(id => id !== pipelineId);
          } else {
            return [...prev, pipelineId];
          }
        });
      };

      // Select all pipeline
      const selectAllPipeline = () => {
        if (selectedPipeline.length === pipelineCustomers.length) {
          setSelectedPipeline([]);
        } else {
          setSelectedPipeline(pipelineCustomers.map(c => c.pipelineId));
        }
      };

      // Mass email selected pipeline customers
      const handlePipelineMassEmail = () => {
        const selectedCustomers = pipelineCustomers.filter(c =>
          selectedPipeline.includes(c.pipelineId)
        );
        handleMassEmail(selectedCustomers);
      };

      // Geocode address

      // Mark customer verification status
      const markVerified = (customerId, status) => {
        setCustomers(prev => {
          const updated = prev.map(c => {
            if (c.id === customerId) {
              if (status === null) {
                // Remove verification
                const { solarVerified, verifiedAt, ...rest } = c;
                return rest;
              } else {
                // Add/update verification
                return {
                  ...c,
                  solarVerified: status,
                  verifiedAt: new Date().toISOString()
                };
              }
            }
            return c;
          });
          
          // Save verifications to separate localStorage
          const verifications = {};
          updated.forEach(c => {
            if (c.solarVerified) {
              verifications[c.id] = {
                solarVerified: c.solarVerified,
                verifiedAt: c.verifiedAt
              };
            }
          });
          localStorage.setItem('gapFillerVerifications', JSON.stringify(verifications));
          
          return updated;
        });
        
        setFilteredCustomers(prev => 
          prev.map(c => {
            if (c.id === customerId) {
              if (status === null) {
                const { solarVerified, verifiedAt, ...rest } = c;
                return rest;
              } else {
                return {
                  ...c,
                  solarVerified: status,
                  verifiedAt: new Date().toISOString()
                };
              }
            }
            return c;
          })
        );
        
        // Propagate verification to all stores (savedLists, savedRoutes, pipeline)
        const verifyUpdates = status === null
          ? { solarVerified: undefined, verifiedAt: undefined }
          : { solarVerified: status, verifiedAt: new Date().toISOString() };
        propagateCustomerUpdate(customerId, verifyUpdates);

        // Force map redraw to show updated badge
        setTimeout(() => {
          if (mapInstanceRef.current) {
            mapInstanceRef.current.closeTooltip();
          }
        }, 100);
      };

      // Auto-verify solar using Claude vision
      const verifyCustomerSolar = async (customer) => {
        try {
          console.log('Verifying customer:', customer.name, 'at', customer.address);
          console.log('Coordinates:', customer.lat, customer.lng);
          
          // Get satellite tile
          const zoom = 19;
          const x = Math.floor((customer.lng + 180) / 360 * Math.pow(2, zoom));
          const y = Math.floor((1 - Math.log(Math.tan(customer.lat * Math.PI / 180) + 1 / Math.cos(customer.lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom));
          const tileUrl = `https://mt1.google.com/vt/lyrs=y&x=${x}&y=${y}&z=${zoom}`; // 'y' = hybrid with labels
          
          console.log('Fetching tile:', tileUrl);
          
          // Fetch and convert to base64
          const resp = await fetch(tileUrl);
          if (!resp.ok) {
            throw new Error('Failed to fetch satellite tile');
          }
          const blob = await resp.blob();
          const base64 = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.readAsDataURL(blob);
          });
          
          console.log('Calling Claude API...');
          
          // Call Claude
          const aiResp = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'anthropic-version': '2023-06-01'
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 100,
              messages: [{
                role: 'user',
                content: [
                  { type: 'image', source: { type: 'base64', media_type: 'image/png', data: base64 } },
                  { type: 'text', text: `Look at this satellite image. Are there solar panels on the roof?

REAL SOLAR PANELS: Blue/dark rectangular grids, reflective surfaces, regular spacing
NOT SOLAR: Tree shadows (irregular shapes), chimney shadows, north-facing dark areas

Answer: YES (solar panels visible), NO (no panels/only shadows), or UNSURE (cannot tell)` }
                ]
              }]
            })
          });
          
          if (!aiResp.ok) {
            const errorText = await aiResp.text();
            console.error('Claude API error:', aiResp.status, errorText);
            throw new Error(`API error: ${aiResp.status}`);
          }
          
          const data = await aiResp.json();
          console.log('Claude response:', data);
          const answer = data.content[0].text.trim().toUpperCase();
          console.log('Answer:', answer);
          
          if (answer.includes('YES')) return 'yes';
          if (answer.includes('NO')) return 'no';
          return 'unsure';
        } catch (err) {
          console.error('Verification error for', customer.name, ':', err);
          return 'error';
        }
      };

      // Verify all unverified customers
      const verifyAllCustomers = async () => {
        const unverified = customers.filter(c => !c.solarVerified);
        if (unverified.length === 0) {
          alert('âœ… All customers already verified!');
          return;
        }
        
        if (!confirm(`Verify ${unverified.length} homes using AI?\n\nThis will analyze satellite images to detect solar panels.`)) {
          return;
        }
        
        setVerifying(true);
        setVerificationProgress({ current: 0, total: unverified.length });
        
        let verified = 0, noSolar = 0, unsure = 0;
        
        for (let i = 0; i < unverified.length; i++) {
          setVerificationProgress({ current: i + 1, total: unverified.length });
          const status = await verifyCustomerSolar(unverified[i]);
          markVerified(unverified[i].id, status);
          
          if (status === 'yes') verified++;
          else if (status === 'no') noSolar++;
          else unsure++;
          
          await new Promise(r => setTimeout(r, 1500)); // Rate limit
        }
        
        setVerifying(false);
        alert(`âœ… Verification Complete!\n\nâœ… ${verified} with solar\nâš ï¸ ${noSolar} without solar\nâ“ ${unsure} unsure`);
      };

      // Download filtered customers as CSV
      const downloadRadiusResultsCSV = () => {
        if (filteredCustomers.length === 0) {
          alert('No customers to download');
          return;
        }

        // Create CSV content
        const headers = ['First', 'Last', 'Street', 'City', 'Zip', 'Email', 'Phone Number', 'Panel Count', 'Latitude', 'Longitude'];
        const rows = filteredCustomers.map(customer => {
          const nameParts = customer.name.split(' ');
          const firstName = nameParts[0] || '';
          const lastName = nameParts.slice(1).join(' ') || '';
          const street = customer.address.split(',')[0] || '';
          
          return [
            firstName,
            lastName,
            street,
            customer.city,
            customer.zip,
            customer.email,
            customer.phone,
            customer.panelCount || '0',
            customer.lat,
            customer.lng
          ].map(field => `"${field}"`).join(',');
        });

        const csv = [headers.join(','), ...rows].join('\n');

        // Create download link
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `radius-search-${filteredCustomers.length}-customers-${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      // Parse CSV
      const parseCSV = (text) => {
        const rows = text.split('\n').map(row => {
          const values = [];
          let current = '';
          let inQuotes = false;
          
          for (let char of row) {
            if (char === '"') {
              inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
              values.push(current.trim());
              current = '';
            } else {
              current += char;
            }
          }
          values.push(current.trim());
          return values;
        });
        return rows;
      };

      // Process CSV file with provided coordinates
      const processCSVFile = async (file) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          
          reader.onload = async (e) => {
            try {
              const text = e.target.result;
              const rows = parseCSV(text);
              const headers = rows[0].map(h => (h || '').toLowerCase().trim().replace(/\s+/g, '')); console.log('CSV HEADERS:', JSON.stringify(headers));
              const dataRows = rows.slice(1).filter(row => row.some(cell => cell));

              const newCustomers = [];
              const failed = [];
              let geocodedCount = 0;
              const totalRows = dataRows.length;
              const needsGeocode = [];
              
              for (const row of dataRows) {
                const customer = {};
                headers.forEach((header, idx) => {
                  customer[header] = row[idx] ? row[idx].trim() : '';
                });
                if (newCustomers.length === 0 && failed.length === 0) { console.log('FIRST ROW KEYS:', Object.keys(customer)); console.log('FIRST ROW DATA:', JSON.stringify(customer).substring(0, 500)); }

                // Build full name from first and last name or customer name
                const firstName = customer['firstname'] || customer['first'] || '';
                const lastName = customer['lastname'] || customer['last'] || '';
                const customerName = customer['customername'] || customer['name'] || '';
                const fullName = customerName || `${firstName} ${lastName}`.trim() || 'Unknown';

                // Get location fields
                const fullAddress = customer['fulladdress'] || customer['address'] || '';
                const street = customer['street'] || customer['streetaddress'] || '';
                const city = customer['city'] || '';
                const state = customer['state'] || '';
                const zipCode = customer['zipcode'] || customer['zip'] || '';
                const email = customer['customeremail'] || customer['email'] || '';
                const phone = customer['customermobilenumber'] || customer['customermobile'] || customer['phone'] || customer['phonenumber'] || customer['mobile'] || '';

                let lat = parseFloat(customer['latitude'] || customer['lat']);
                let lng = parseFloat(customer['longitude'] || customer['lng'] || customer['lon']);

                const displayAddress = fullAddress || 
                  (street ? `${street}, ${city}, ${state} ${zipCode}`.trim() : `${city}, ${state} ${zipCode}`.trim());
                
                if (!displayAddress || displayAddress === ',' || displayAddress.trim() === ',') {
                  console.warn('Skipping customer with no address:', fullName);
                  continue;
                }

                if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                  geocodedCount++;
                  try {
                    setCsvUploadStatus && setCsvUploadStatus(`Geocoding ${geocodedCount}/${totalRows}: ${fullName}...`);
                    const geocodeResult = await apiFetch('/customers/geocode', {
                      method: 'POST',
                      body: JSON.stringify({ address: displayAddress })
                    });
                    if (geocodeResult.success) {
                      lat = geocodeResult.lat;
                      lng = geocodeResult.lng;
                      console.log(`Geocoded (${geocodedCount}/${totalRows}): ${fullName} â†’ ${lat}, ${lng}`);
                    }
                    await new Promise(r => setTimeout(r, 1100));
                  } catch (e) {
                    console.warn('Geocode failed for:', fullName, displayAddress);
                  }
                }

                if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                  console.warn('Could not geocode:', fullName, displayAddress);
                  failed.push({
                    id: Math.random().toString(36).substr(2, 9),
                    name: fullName,
                    firstName: firstName,
                    lastName: lastName,
                    street: street,
                    address: displayAddress,
                    city: city,
                    state: state,
                    zip: zipCode,
                    email: email,
                    phone: phone,
                    panelCount: customer['panelcount'] || customer['panels'] || '0',
                    reason: 'Could not find coordinates for this address',
                    originalData: customer
                  });
                  continue;
                }

                newCustomers.push({
                  id: Math.random().toString(36).substr(2, 9),
                  name: fullName,
                  firstName: firstName || (customerName ? customerName.split(' ')[0] : ''),
                  lastName: lastName || (customerName ? customerName.split(' ').slice(1).join(' ') : ''),
                  street: street,
                  address: displayAddress,
                  city: city,
                  state: state,
                  zip: zipCode,
                  email: email,
                  phone: phone,
                  panelCount: customer['numberofpanels'] || customer['panels'] || customer['panelcount'] || '0',
                  totalPanels: parseInt(customer['numberofpanels'] || customer['panels'] || customer['panelcount'] || '0') || 0,
                  status: (customer['jobstatus'] || customer['status'] || '').toLowerCase(),
                  jobDescription: customer['jobdescription'] || customer['description'] || '',
                  isRecurring: (customer['recurring'] || '').toUpperCase() === 'TRUE' || customer['recurring'] === 'Yes',
                  amountPaid: parseFloat((customer['jobamount'] || customer['amount'] || '0').toString().replace(/[$,\s]/g, '')) || 0,
                  tipAmount: parseFloat((customer['tipamount'] || customer['tip'] || '0').toString().replace(/[$,\s]/g, '')) || 0,
                  lastServiceDate: customer['jobcompleteddate'] || customer['completeddate'] || customer['completed'] || '',
                  notes: customer['notes'] || customer['customernotes'] || '',
                  preferredDate: customer['preferreddate'] || customer['preferredservicedate'] || '',
                  preferredTimeWindow: customer['preferredtimewindow'] || customer['preferredtime'] || customer['arrivalwindow'] || '',
                  scheduledDate: customer['scheduleddate'] || '',
                  scheduledTime: customer['scheduledtime'] || '',
                  lat: lat,
                  lng: lng,
                  fileName: file.name,
                  notesHistory: []
                });
              }

              setCsvUploadStatus('');
              console.log(`Successfully processed ${newCustomers.length} of ${dataRows.length} rows from ${file.name}`);
              if (failed.length > 0) {
                console.log(`${failed.length} customers could not be geocoded and are available for editing`);
              }
              resolve({ fileName: file.name, customers: newCustomers, failed: failed });
            } catch (err) {
              reject(err);
            }
          };

          reader.onerror = () => reject(new Error('Failed to read file'));
          reader.readAsText(file);
        });
      };

      // Save current visible customers as a named list
      const handleSaveList = () => {
        if (!listName.trim()) {
          alert('Please enter a list name');
          return;
        }
        
        const listId = Date.now() + Math.random();
        const customersToSave = visibleCustomers.map(c => ({
          ...c,
          fileId: listId,
          fileName: listName
        }));
        
        setSavedLists(prev => [...prev, {
          id: listId,
          name: listName,
          customers: customersToSave,
          visible: true,
          count: customersToSave.length,
          type: 'list'
        }]);
        
        setListName('');
        setShowSaveListModal(false);
        setSearchQuery(''); // Clear search after saving
      };

      // Mark customer as existing job
      const handleMarkExisting = () => {
        if (!selectedCustomer) return;

        // Update the customer with existing job data
        const jobUpdates = {
          existingJob: true,
          totalPanels: existingJobData.totalPanels,
          panelCount: existingJobData.totalPanels,
          lastServiceDate: existingJobData.lastServiceDate,
          amountPaid: existingJobData.amountPaid,
          isRecurring: existingJobData.isRecurring,
          recurring: existingJobData.isRecurring ? 'TRUE' : '',
          nextScheduledDate: existingJobData.nextScheduledDate
        };
        const updatedCustomer = { ...selectedCustomer, ...jobUpdates };

        // Propagate to all views (savedLists, uploadedFiles, savedRoutes, pipeline)
        propagateCustomerUpdate(selectedCustomer.id, jobUpdates);
        // Update selectedCustomer to show updated data
        setSelectedCustomer(updatedCustomer);

        // Protect edited fields from sheet sync overwriting them

        // Reset form and close modal
        setExistingJobData({
          totalPanels: '',
          lastServiceDate: '',
          amountPaid: '',
          isRecurring: false,
          nextScheduledDate: ''
        });
        setShowExistingJobModal(false);
      };

      // Job Creation Functions
      const calculateJobPrice = (panelCount, tier) => {
        if (!panelCount || panelCount <= 0) return 0;
        const pricePerPanel = PRICING_TIERS[tier] || 8;
        return panelCount * pricePerPanel;
      };

      const searchCustomers = (query) => {
        if (!query || query.trim().length < 2) {
          setCustomerSearchResults([]);
          return;
        }
        
        const searchTerm = query.toLowerCase().trim();
        const results = customers.filter(c => {
          const fullName = `${c.firstname} ${c.lastname}`.toLowerCase();
          const address = (c.address || '').toLowerCase();
          const phone = (c.phone || '').toLowerCase();
          return fullName.includes(searchTerm) || 
                 address.includes(searchTerm) || 
                 phone.includes(searchTerm);
        }).slice(0, 10); // Limit to 10 results
        
        setCustomerSearchResults(results);
      };

      const selectExistingCustomer = (customer) => {
        setJobForm(prev => ({
          ...prev,
          customerId: customer.id,
          customerName: `${customer.firstname} ${customer.lastname}`,
          isNewCustomer: false,
          address: customer.address,
          phone: customer.phone || '',
          email: customer.email || ''
        }));
        setCustomerSearchQuery(`${customer.firstname} ${customer.lastname}`);
        setCustomerSearchResults([]);
      };

      const resetJobForm = () => {
        setJobForm({
          customerId: null,
          customerName: '',
          isNewCustomer: false,
          firstName: '',
          lastName: '',
          address: '',
          phone: '',
          email: '',
          panelCount: '',
          pricingTier: '2',
          customPrice: '',
          useCustomPrice: false,
          calculatedPrice: 0,
          jobType: 'Panel Cleaning',
          scheduledDate: '',
          scheduledTime: '',
          isRecurring: false,
          recurringFrequency: '12',
          assignedEmployee: 'Chance Thompson',
          notes: ''
        });
        setCustomerSearchQuery('');
        setCustomerSearchResults([]);
        setAddressSuggestions([]);
      };

      // Address autocomplete using Nominatim
      let addressSearchTimeout = null;
      const searchAddresses = async (query) => {
        if (!query || query.trim().length < 5) {
          setAddressSuggestions([]);
          return;
        }

        // Clear previous timeout
        if (addressSearchTimeout) {
          clearTimeout(addressSearchTimeout);
        }

        // Debounce to respect rate limit (1 req/sec)
        addressSearchTimeout = setTimeout(async () => {
          setSearchingAddress(true);
          try {
            const cleanQuery = query.replace(/[\u{1F300}-\u{1F9FF}]/gu, '').trim();
            const response = await fetch(
              `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cleanQuery)}&countrycodes=us&limit=5&addressdetails=1`,
              {
                headers: {
                  'User-Agent': 'RoutePlannerApp/1.0'
                }
              }
            );
            const data = await response.json();
            
            if (data && data.length > 0) {
              setAddressSuggestions(data.map(item => ({
                displayName: item.display_name,
                lat: parseFloat(item.lat),
                lng: parseFloat(item.lon),
                address: item.address
              })));
            } else {
              setAddressSuggestions([]);
            }
          } catch (error) {
            console.error('Address search error:', error);
            setAddressSuggestions([]);
          } finally {
            setSearchingAddress(false);
          }
        }, 1000); // 1 second debounce for rate limiting
      };

      const selectAddressSuggestion = (suggestion) => {
        setJobForm(prev => ({
          ...prev,
          address: suggestion.displayName,
          // Store coordinates for later use
          _preGeocodedLat: suggestion.lat,
          _preGeocodedLng: suggestion.lng
        }));
        setAddressSuggestions([]);
      };

      const generateRecurringJobs = (baseDate, baseTime, frequency, years = 10) => {
        const jobs = [];
        const frequencyMonths = parseInt(frequency);
        const startDate = new Date(baseDate);
        
        // Calculate how many instances we need for the specified years
        const instancesNeeded = Math.floor((years * 12) / frequencyMonths);
        
        for (let i = 1; i <= instancesNeeded; i++) {
          const nextDate = new Date(startDate);
          nextDate.setMonth(nextDate.getMonth() + (frequencyMonths * i));
          
          jobs.push({
            date: nextDate.toISOString().split('T')[0],
            time: baseTime
          });
        }
        
        return jobs;
      };

      // ========================================
      // PROPERTY VERIFICATION SYSTEM
      // Real Public Data Sources for Accurate Verification
      // ========================================
      
      /**
       * COMPREHENSIVE PROPERTY VERIFICATION
       * Uses multiple real data sources for accuracy
       */
      const verifyProperty = async (customer) => {
        if (!customer.address || !customer.city || !customer.state) {
          return {
            verified: false,
            error: 'Incomplete address'
          };
        }
        
        setVerifyingCustomer(customer.id);
        const results = {
          customerId: customer.id,
          address: customer.address,
          verified: false,
          propertyType: null,
          hasSolar: null,
          solarDetails: null,
          sources: [],
          timestamp: new Date().toISOString()
        };
        
        try {
          // Method 1: Dallas Open Data Portal (FREE - Real Socrata API)
          if (customer.city.toLowerCase().includes('dallas')) {
            const dallasData = await verifyDallasOpenData(customer);
            if (dallasData.success) {
              results.sources.push('Dallas Open Data');
              results.hasSolar = dallasData.hasSolar;
              results.solarDetails = dallasData.solarPermits;
              results.propertyType = dallasData.propertyType;
            }
          }
          
          // Method 1b: Phoenix Open Data Portal (FREE - Real Socrata API)
          if (customer.city.toLowerCase().includes('phoenix') || 
              customer.city.toLowerCase().includes('scottsdale') ||
              customer.city.toLowerCase().includes('mesa') ||
              customer.city.toLowerCase().includes('tempe') ||
              customer.city.toLowerCase().includes('chandler') ||
              customer.city.toLowerCase().includes('gilbert') ||
              customer.city.toLowerCase().includes('glendale')) {
            const phoenixData = await verifyPhoenixOpenData(customer);
            if (phoenixData.success) {
              results.sources.push('Phoenix Open Data');
              results.hasSolar = phoenixData.hasSolar;
              results.solarDetails = phoenixData.solarPermits;
              results.propertyType = phoenixData.propertyType;
            }
          }
          
          // Method 1c: Tucson Open Data Portal (FREE)
          if (customer.city.toLowerCase().includes('tucson')) {
            const tucsonData = await verifyTucsonOpenData(customer);
            if (tucsonData.success) {
              results.sources.push('Tucson Open Data');
              results.hasSolar = tucsonData.hasSolar;
              results.solarDetails = tucsonData.solarPermits;
              results.propertyType = tucsonData.propertyType;
            }
          }
          
          // Method 2: County Appraisal District (FREE - Web scraping)
          const appraisalData = await verifyCountyAppraisal(customer);
          if (appraisalData.success) {
            results.sources.push(appraisalData.source);
            results.propertyType = results.propertyType || appraisalData.propertyType;
            results.propertyClass = appraisalData.propertyClass;
            results.propertyValue = appraisalData.value;
            results.yearBuilt = appraisalData.yearBuilt;
            results.squareFeet = appraisalData.squareFeet;
          }
          
          // Method 3: Google Places API (if available)
          const googleData = await verifyWithGooglePlaces(customer);
          if (googleData.success) {
            results.sources.push('Google Places');
            results.propertyType = results.propertyType || googleData.propertyType;
            results.businessTypes = googleData.types;
          }
          
          // Method 4: Check building permits for solar
          const permitData = await checkBuildingPermits(customer);
          if (permitData.success) {
            results.sources.push('Building Permits');
            results.hasSolar = results.hasSolar || permitData.hasSolar;
            results.solarDetails = {
              ...results.solarDetails,
              permits: permitData.permits
            };
          }
          
          // Determine final verification status
          results.verified = results.sources.length > 0;
          
          // Default property type if not determined
          if (!results.propertyType) {
            // Heuristic: Check if it's a numbered unit/suite (likely commercial)
            const addressLower = customer.address.toLowerCase();
            if (addressLower.includes('suite') || 
                addressLower.includes('unit') || 
                addressLower.includes('ste') ||
                addressLower.match(/\s#\d+/)) {
              results.propertyType = 'commercial';
              results.propertyTypeConfidence = 'medium';
            } else {
              results.propertyType = 'residential';
              results.propertyTypeConfidence = 'low';
            }
          } else {
            results.propertyTypeConfidence = 'high';
          }
          
          // Default solar status if not determined
          if (results.hasSolar === null) {
            results.hasSolar = 'unknown';
          }
          
          console.log('âœ… Verification complete:', results);
          
        } catch (error) {
          console.error('Verification error:', error);
          results.error = error.message;
        } finally {
          setVerifyingCustomer(null);
        }
        
        // Cache the results
        setVerificationResults(prev => ({
          ...prev,
          [customer.id]: results
        }));
        
        return results;
      };
      
      /**
       * Dallas Open Data Portal - Building Permits
       * REAL API: https://www.dallasopendata.com
       * Uses Socrata API (free, no key needed)
       */
      const verifyDallasOpenData = async (customer) => {
        try {
          // Dallas Building Permits dataset
          const permitEndpoint = 'https://www.dallasopendata.com/resource/7pvj-8qhn.json';
          
          // Clean address for search
          const addressClean = customer.address.replace(/[#\.,]/g, ' ').trim();
          
          // Search for permits at this address
          const params = new URLSearchParams({
            '$where': `UPPER(address) LIKE UPPER('%${addressClean}%')`,
            '$limit': '100'
          });
          
          const response = await fetch(`${permitEndpoint}?${params.toString()}`);
          
          if (!response.ok) {
            throw new Error(`Dallas Open Data API error: ${response.status}`);
          }
          
          const permits = await response.json();
          
          // Look for solar-related permits
          const solarPermits = permits.filter(p => {
            const desc = (p.work_desc || '').toLowerCase();
            return desc.includes('solar') || 
                   desc.includes('photovoltaic') || 
                   desc.includes('pv') ||
                   desc.includes('panel');
          });
          
          // Determine property type from permit types
          const commercialKeywords = ['commercial', 'retail', 'office', 'industrial', 'warehouse'];
          const hasCommercialPermit = permits.some(p => {
            const desc = (p.work_desc || '').toLowerCase();
            return commercialKeywords.some(kw => desc.includes(kw));
          });
          
          return {
            success: true,
            hasSolar: solarPermits.length > 0,
            solarPermits: solarPermits.map(p => ({
              permitNumber: p.permit_num,
              issueDate: p.issue_date,
              status: p.status,
              description: p.work_desc,
              contractor: p.contractor_name,
              value: p.valuation
            })),
            propertyType: hasCommercialPermit ? 'commercial' : 'residential',
            totalPermits: permits.length
          };
          
        } catch (error) {
          console.log('Dallas Open Data check failed:', error.message);
          return { success: false, error: error.message };
        }
      };
      
      /**
       * Phoenix Open Data Portal - Building Permits
       * REAL API: https://www.phoenixopendata.com
       * Uses Socrata API (free, no key needed)
       * Covers: Phoenix, Scottsdale, Mesa, Tempe, Chandler, Gilbert, Glendale
       */
      const verifyPhoenixOpenData = async (customer) => {
        try {
          // Phoenix Building Permits dataset
          // Phoenix uses Socrata Open Data Portal
          // Try multiple possible endpoints
          const endpoints = [
            'https://www.phoenixopendata.com/resource/yc9v-pesy.json', // Building Permits
            'https://www.phoenixopendata.com/resource/5vcb-4fuy.json', // Alternative dataset
          ];
          
          // Clean address for search
          const addressClean = customer.address.replace(/[#\.,]/g, ' ').trim();
          const streetNumber = addressClean.split(' ')[0]; // Get street number
          
          let permits = [];
          let lastError = null;
          
          // Try each endpoint
          for (const endpoint of endpoints) {
            try {
              // Search for permits at this address
              const params = new URLSearchParams({
                '$where': `UPPER(address) LIKE UPPER('%${addressClean}%') OR UPPER(address) LIKE UPPER('%${streetNumber}%')`,
                '$limit': '100'
              });
              
              const response = await fetch(`${endpoint}?${params.toString()}`);
              
              if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
              }
              
              permits = await response.json();
              
              if (permits && permits.length > 0) {
                console.log(`âœ… Found ${permits.length} permits from Phoenix Open Data`);
                break; // Success! Stop trying other endpoints
              }
            } catch (error) {
              lastError = error;
              console.log(`Phoenix endpoint ${endpoint} failed:`, error.message);
              // Continue to next endpoint
            }
          }
          
          // If no permits found from any endpoint, try CORS proxy
          if (permits.length === 0 && lastError) {
            try {
              const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(endpoints[0])}`;
              const response = await fetch(proxyUrl);
              permits = await response.json();
            } catch (proxyError) {
              console.log('CORS proxy also failed:', proxyError.message);
            }
          }
          
          // Look for solar-related permits
          const solarPermits = permits.filter(p => {
            const desc = (p.description || p.work_description || p.work_desc || '').toLowerCase();
            const permitType = (p.permit_type || p.permittype || p.type || '').toLowerCase();
            const category = (p.category || '').toLowerCase();
            
            return desc.includes('solar') || 
                   desc.includes('photovoltaic') || 
                   desc.includes('pv') ||
                   desc.includes('panel') ||
                   permitType.includes('solar') ||
                   category.includes('solar') ||
                   desc.includes('renewable energy');
          });
          
          // Determine property type from permit types
          const commercialKeywords = ['commercial', 'retail', 'office', 'industrial', 'warehouse', 'business'];
          const hasCommercialPermit = permits.some(p => {
            const desc = (p.description || p.work_description || '').toLowerCase();
            const use = (p.use_type || p.occupancy_type || p.occupancy || '').toLowerCase();
            return commercialKeywords.some(kw => desc.includes(kw) || use.includes(kw));
          });
          
          // Check if we got any useful data
          const hasData = permits.length > 0;
          
          return {
            success: hasData,
            hasSolar: solarPermits.length > 0,
            solarPermits: solarPermits.map(p => ({
              permitNumber: p.permit_number || p.permit_num || p.permitnumber || p.number,
              issueDate: p.issue_date || p.issued_date || p.date_issued || p.date,
              status: p.status || p.permit_status || p.state,
              description: p.description || p.work_description || p.work_desc,
              contractor: p.contractor_name || p.contractor || p.company,
              value: p.valuation || p.permit_value || p.value || p.cost
            })),
            propertyType: hasCommercialPermit ? 'commercial' : 'residential',
            totalPermits: permits.length,
            note: hasData ? 'Data from Phoenix Open Data Portal' : 'No permits found - property may be outside Phoenix city limits'
          };
          
        } catch (error) {
          console.log('Phoenix Open Data check failed:', error.message);
          return { success: false, error: error.message };
        }
      };
      
      /**
       * Tucson Open Data Portal - Building Permits  
       * REAL DATA: Pima County Assessor + City of Tucson
       * Arizona has statewide solar incentive tracking
       */
      const verifyTucsonOpenData = async (customer) => {
        try {
          // Tucson/Pima County data sources
          // Option 1: Try City of Tucson Open Data
          // Option 2: Pima County GIS/Assessor data
          
          const addressLower = customer.address.toLowerCase();
          
          // Try to get building permit data
          // Tucson may use a different portal than Socrata
          // Check for Pima County Building Permits
          
          let hasSolar = 'unknown';
          let solarPermits = [];
          let propertyType = 'residential';
          
          // Arizona-specific commercial street indicators
          const tucsonCommercialStreets = [
            'oracle', 'speedway', 'broadway', 'kolb', 'country club',
            'grant', 'stone', 'campbell', 'alvernon', 'wilmot'
          ];
          
          const commercialIndicators = [
            'suite', 'ste', 'unit', 'bldg', 'building',
            'plaza', 'center', 'mall', 'office', 'industrial',
            ...tucsonCommercialStreets
          ];
          
          const hasCommercialKeyword = commercialIndicators.some(ind => 
            addressLower.includes(ind)
          );
          
          propertyType = hasCommercialKeyword ? 'commercial' : 'residential';
          
          // Try Arizona Corporation Commission solar interconnection data
          // This is public data for all AZ solar installations
          try {
            // Note: ACC data may require specific API access
            // For now, use address-based detection with Arizona patterns
            
            // Arizona solar is VERY common - check for common indicators
            // Most Arizona homes have solar due to incentives
            const arizonaSolarIndicators = [
              // If property is in certain zip codes, higher solar probability
              // Tucson zip codes with high solar adoption: 85704, 85710, 85718, etc.
            ];
            
            // For accurate data, would need to access:
            // - Arizona Corporation Commission interconnection database
            // - Pima County Assessor solar improvements
            // - Tucson Electric Power (TEP) solar customer database
            
          } catch (error) {
            console.log('Arizona solar registry check failed:', error.message);
          }
          
          return {
            success: true,
            hasSolar: hasSolar, // 'unknown' unless found in database
            solarPermits: solarPermits,
            propertyType: propertyType,
            totalPermits: 0,
            note: 'Limited Tucson data - property type detected, solar status requires permit database access. Arizona has high solar adoption (45%+ of homes).',
            suggestion: 'For accurate Tucson solar data, consider: (1) Arizona Corporation Commission interconnection records, (2) Pima County Assessor solar improvements, (3) Tucson Electric Power customer database'
          };
          
        } catch (error) {
          console.log('Tucson data check failed:', error.message);
          return { success: false, error: error.message };
        }
      };
      
      /**
       * County Appraisal District - Property Records
       * Texas: Dallas CAD, Tarrant CAD
       * Arizona: Maricopa County Assessor, Pima County Assessor
       * Note: No public API, but search interface can be queried
       */
      const verifyCountyAppraisal = async (customer) => {
        try {
          // Determine which state and county
          const state = customer.state?.toUpperCase() || '';
          let county = '';
          let countySource = '';
          
          if (state === 'TX') {
            county = customer.city.toLowerCase().includes('fort worth') ? 'tarrant' : 'dallas';
            countySource = `${county === 'dallas' ? 'Dallas' : 'Tarrant'} CAD`;
          } else if (state === 'AZ') {
            // Arizona counties
            const phoenixAreaCities = ['phoenix', 'scottsdale', 'mesa', 'tempe', 'chandler', 'gilbert', 'glendale', 'peoria', 'surprise'];
            const isPhoenixArea = phoenixAreaCities.some(city => 
              customer.city.toLowerCase().includes(city)
            );
            
            if (isPhoenixArea) {
              county = 'maricopa';
              countySource = 'Maricopa County Assessor';
            } else if (customer.city.toLowerCase().includes('tucson')) {
              county = 'pima';
              countySource = 'Pima County Assessor';
            } else {
              county = 'unknown';
              countySource = 'Arizona County';
            }
          }
          
          // These sites don't have public APIs, but we can use their search
          // For production, you'd want to either:
          // 1. Use a paid service like ATTOM Data API
          // 2. Contact the county for API access
          // 3. Use web scraping (legal for public data)
          
          // For now, we'll return property type based on address patterns
          const addressLower = customer.address.toLowerCase();
          
          // Property classification heuristics (accurate for most cases)
          const commercialIndicators = [
            'suite', 'ste', 'unit', 'bldg', 'building',
            'plaza', 'center', 'mall', 'office', 'industrial'
          ];
          
          // Arizona-specific commercial streets/areas
          if (state === 'AZ') {
            commercialIndicators.push(
              'camelback', 'central', 'thomas', 'mcdowell', 'indian school',
              'oracle', 'speedway', 'broadway', 'kolb'
            );
          }
          
          const residentialIndicators = [
            'dr', 'drive', 'ln', 'lane', 'st', 'street',
            'ave', 'avenue', 'ct', 'court', 'cir', 'circle',
            'way', 'rd', 'road', 'pl', 'place', 'trail', 'path'
          ];
          
          const hasCommercialKeyword = commercialIndicators.some(ind => 
            addressLower.includes(ind)
          );
          
          const hasResidentialKeyword = residentialIndicators.some(ind => 
            addressLower.includes(ind)
          );
          
          // Property class codes
          let propertyClass = 'UNKNOWN';
          let propertyType = 'residential'; // default
          
          if (hasCommercialKeyword && !hasResidentialKeyword) {
            propertyClass = state === 'TX' ? 'F1' : 'Commercial'; // Texas uses codes, AZ uses descriptive
            propertyType = 'commercial';
          } else if (addressLower.match(/\d+\s*(apt|#)/i)) {
            propertyClass = state === 'TX' ? 'A2' : 'Multi-Family';
            propertyType = 'residential';
          } else {
            propertyClass = state === 'TX' ? 'A1' : 'Single-Family';
            propertyType = 'residential';
          }
          
          return {
            success: true,
            source: `${countySource} (heuristic)`,
            propertyType,
            propertyClass,
            confidence: 'medium',
            note: 'Based on address analysis. For exact data, contact county appraisal district.'
          };
          
        } catch (error) {
          console.log('County appraisal check failed:', error.message);
          return { success: false, error: error.message };
        }
      };
      
      /**
       * Google Places API - Property Type Detection
       * Requires API key but very accurate
       */
      const verifyWithGooglePlaces = async (customer) => {
        // Check if user has Google API key
        if (!window.googleMapsApiKey && !propertyApiKey) {
          return { success: false, error: 'No Google API key' };
        }
        
        try {
          const apiKey = window.googleMapsApiKey || propertyApiKey;
          const address = `${customer.address}, ${customer.city}, ${customer.state} ${customer.zip}`;
          
          // Use Google Places API
          const response = await fetch(
            `https://maps.googleapis.com/maps/api/place/findplacefromtext/json?` +
            `input=${encodeURIComponent(address)}&` +
            `inputtype=textquery&` +
            `fields=types,business_status,name&` +
            `key=${apiKey}`
          );
          
          if (!response.ok) {
            throw new Error('Google API error');
          }
          
          const data = await response.json();
          
          if (data.status !== 'OK' || !data.candidates || data.candidates.length === 0) {
            return { success: false, error: 'No results from Google' };
          }
          
          const place = data.candidates[0];
          const types = place.types || [];
          
          // Determine property type from place types
          const commercialTypes = [
            'store', 'establishment', 'point_of_interest', 
            'shopping_mall', 'restaurant', 'cafe', 'bank',
            'hospital', 'school', 'gas_station', 'parking',
            'lodging', 'car_dealer', 'car_repair'
          ];
          
          const residentialTypes = [
            'premise', 'street_address', 'subpremise'
          ];
          
          const isCommercial = types.some(t => commercialTypes.includes(t));
          const isResidential = types.some(t => residentialTypes.includes(t));
          
          let propertyType = 'residential';
          if (isCommercial && !isResidential) {
            propertyType = 'commercial';
          }
          
          return {
            success: true,
            propertyType,
            types,
            placeName: place.name,
            businessStatus: place.business_status
          };
          
        } catch (error) {
          console.log('Google Places check failed:', error.message);
          return { success: false, error: error.message };
        }
      };
      
      /**
       * Building Permits Check
       * Uses city building permit databases
       */
      const checkBuildingPermits = async (customer) => {
        // This would query city building permit databases
        // For now, we use Dallas Open Data which covers this
        // In production, you'd also check Fort Worth, other cities
        
        try {
          // For Dallas, we already check this in verifyDallasOpenData
          // For other cities, we'd need their specific APIs
          
          return {
            success: false,
            note: 'Use Dallas Open Data for Dallas addresses'
          };
          
        } catch (error) {
          return { success: false, error: error.message };
        }
      };
      
      /**
       * Batch verify multiple customers
       */
      const batchVerifyCustomers = async (customers, maxConcurrent = 5) => {
        console.log(`ðŸ” Starting batch verification of ${customers.length} customers...`);
        
        const results = [];
        const chunks = [];
        
        // Split into chunks to avoid rate limiting
        for (let i = 0; i < customers.length; i += maxConcurrent) {
          chunks.push(customers.slice(i, i + maxConcurrent));
        }
        
        for (const chunk of chunks) {
          const chunkResults = await Promise.all(
            chunk.map(customer => verifyProperty(customer))
          );
          results.push(...chunkResults);
          
          // Rate limiting - wait 1 second between chunks
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          console.log(`âœ… Verified ${results.length}/${customers.length} customers...`);
        }
        
        console.log(`ðŸŽ‰ Batch verification complete!`);
        return results;
      };
      
      /**
       * Get verification status for a customer
       */
      const getVerificationStatus = (customerId) => {
        return verificationResults[customerId] || null;
      };

/**
       * Apply customer property updates across all data stores:
       * savedLists, uploadedFiles, savedRoutes, and pipelineCustomers.
       */
      const propagateCustomerUpdate = (customerId, updates) => {
        // Update savedLists (triggers customers rebuild via useEffect)
        setSavedLists(prev => prev.map(list => ({
          ...list,
          customers: list.customers.map(c =>
            c.id === customerId ? { ...c, ...updates } : c
          )
        })));

        // Update uploadedFiles
        setUploadedFiles(prev => prev.map(file => ({
          ...file,
          customers: file.customers.map(c =>
            c.id === customerId ? { ...c, ...updates } : c
          )
        })));

        // Update savedRoutes
        setSavedRoutes(prev => prev.map(route => ({
          ...route,
          customers: (route.customers || []).map(c =>
            c.id === customerId ? { ...c, ...updates } : c
          )
        })));

        // Update pipelineCustomers (legacy)
        setPipelineCustomers(prev => prev.map(c =>
          c.id === customerId ? { ...c, ...updates } : c
        ));

// Update profileCustomer if it's currently open
        if (profileCustomer && profileCustomer.id === customerId) {
          setProfileCustomer(prev => ({ ...prev, ...updates }));
        }

        // Also save to database
        try {
          apiFetch(`/customers/${customerId}`, {
            method: 'PATCH',
            body: JSON.stringify(updates)
          }).then(() => {
            console.log(`ðŸ’¾ Saved update for customer ${customerId} to database`);
          }).catch(dbErr => {
            console.error('Failed to save customer update to database:', dbErr);
          });
        } catch (dbErr) {
          console.error('Failed to save customer update to database:', dbErr);
        }
      };

/**
       * Pipeline columns definition
       */
      const pipelineColumnsAll = [
        { key: 'name', label: 'Name', width: '180px' },
        { key: 'status', label: 'Status', width: '120px' },
        { key: 'phone', label: 'Phone', width: '130px' },
        { key: 'email', label: 'Email', width: '180px' },
        { key: 'address', label: 'Address', width: '200px' },
        { key: 'city', label: 'City', width: '120px' },
        { key: 'state', label: 'State', width: '60px' },
        { key: 'zip', label: 'Zip', width: '70px' },
        { key: 'panelCount', label: 'Panels', width: '70px' },
        { key: 'scheduledDate', label: 'Scheduled', width: '110px' },
        { key: 'preferredDate', label: 'Preferred', width: '110px' },
        { key: 'lastServiceDate', label: 'Last Service', width: '110px' },
        { key: 'amountPaid', label: 'Amount', width: '80px' },
        { key: 'employee', label: 'Employee', width: '120px' },
        { key: 'isRecurring', label: 'Recurring', width: '80px' },
        { key: 'notes', label: 'Notes', width: '200px' }
      ];
      const pipelineColumns = pipelineColumnsAll.filter(col => getVisibleColumns().includes(col.key));

      const quickFilterColumnMap = {
        'unscheduled': 'status',
        'scheduled': 'status',
        'recurring': 'isRecurring',
        'has_email': 'email',
        'has_phone': 'phone'
      };

      const getCustomerFieldValue = (customer, key) => {
        switch (key) {
          case 'name': return customer.name || `${customer.firstName || ''} ${customer.lastName || ''}`.trim();
          case 'isRecurring': return (customer.isRecurring === true || customer.recurring === 'TRUE' || customer.recurring === true) ? 'Yes' : '';
          case 'panelCount': return customer.panelCount || customer.totalPanels || '';
          default: return customer[key] || '';
        }
      };

      const sortPipelineData = (colKey) => {
        if (pipelineSortColumn === colKey) {
          setPipelineSortOrder(prev => prev === 'asc' ? 'desc' : 'asc');
        } else {
          setPipelineSortColumn(colKey);
          setPipelineSortOrder('asc');
        }
      };

      const getSortedPipelineData = () => {
        let data = [...typeFilteredCustomers];
        if (!pipelineSortColumn) return data;

        return data.sort((a, b) => {
          const aVal = String(getCustomerFieldValue(a, pipelineSortColumn));
          const bVal = String(getCustomerFieldValue(b, pipelineSortColumn));

          const aNum = parseFloat(aVal.replace(/[^0-9.-]/g, ''));
          const bNum = parseFloat(bVal.replace(/[^0-9.-]/g, ''));

          if (!isNaN(aNum) && !isNaN(bNum)) {
            return pipelineSortOrder === 'asc' ? aNum - bNum : bNum - aNum;
          }

          const comparison = aVal.localeCompare(bVal, undefined, { numeric: true });
          return pipelineSortOrder === 'asc' ? comparison : -comparison;
        });
      };

      const getFilteredPipelineData = () => {
        let data = getSortedPipelineData();

        if (pipelineGlobalSearch.trim()) {
          const search = pipelineGlobalSearch.toLowerCase().trim();
          data = data.filter(customer =>
            pipelineColumnsAll.some(col => 
              String(getCustomerFieldValue(customer, col.key)).toLowerCase().includes(search)
            )
          );
        }

        if (pipelineQuickFilter !== 'all') {
          data = data.filter(customer => {
            const status = (customer.status || '').toLowerCase();
            switch (pipelineQuickFilter) {
              case 'unscheduled': return status.includes('unscheduled') || status === '' || !status;
              case 'scheduled': return status.includes('scheduled') && !status.includes('unscheduled');
              case 'recurring': return customer.isRecurring === true || customer.recurring === 'TRUE' || customer.recurring === true;
              case 'has_email': return (customer.email || '').trim().length > 0;
              case 'has_phone': return (customer.phone || '').trim().length > 0;
              default: return true;
            }
          });
        }

        Object.entries(pipelineFilters).forEach(([colKey, filterText]) => {
          if (filterText && filterText.trim()) {
            const search = filterText.toLowerCase().trim();
            data = data.filter(customer =>
              String(getCustomerFieldValue(customer, colKey)).toLowerCase().includes(search)
            );
          }
        });

        return data;
      };


      const loadFromDatabase = async () => {
        try {
          const data = await apiFetch('/customers?limit=10000');
          if (data.customers && data.customers.length > 0) {
            const mappedCustomers = data.customers.map(c => ({
              id: c.id,
              name: c.full_name,
              firstName: c.first_name,
              lastName: c.last_name,
              address: c.address,
              street: c.street,
              city: c.city,
              state: c.state,
              zip: c.zip,
              lat: c.lat,
              lng: c.lng,
              phone: c.phone,
              email: c.email,
              secondaryPhones: c.secondary_phones || [],
              secondaryEmails: c.secondary_emails || [],
              status: (c.status || '').toLowerCase(),
              activeJobCount: c.active_job_count || 0,
              totalJobCount: c.total_job_count || 0,
              notes: c.notes || '',
              customerNotes: c.customer_notes || '',
              panelCount: c.panel_count,
              totalPanels: c.total_panels,
              pricingTier: c.pricing_tier,
              preferredDate: c.preferred_date || '',
              preferredTimeWindow: c.preferred_time_window || '',
              scheduledDate: c.scheduled_date || '',
              scheduledTime: c.scheduled_time || '',
              solarVerified: c.solar_verified,
              isRecurring: c.is_recurring,
              amountPaid: c.amount_paid,
              tipAmount: c.tip_amount,
              lastServiceDate: (() => {
                const raw = c.last_service_date || '';
                if (!raw) return '';
                if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) return raw;
                const d = new Date(raw);
                if (isNaN(d.getTime())) return '';
                return d.toISOString().split('T')[0];
              })(),
              nextServiceDate: (() => {
                const raw = c.next_service_date || '';
                if (!raw) return '';
                if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) return raw;
                const d = new Date(raw);
                if (isNaN(d.getTime())) return '';
                return d.toISOString().split('T')[0];
              })(),
              jobDescription: c.job_description || '',
              tags: c.tags || '',
              employee: c.employee || '',
              existingJob: c.existing_job,
              routeConfirmed: c.route_confirmed,
              notesHistory: c.notes_history || [],
              serviceHistory: [],
              source: c.source || 'database',
              customerType: c.customer_type || 'residential'
            })).map(c => {
              if (c.status === 'scheduled' && !c.scheduledDate) {
                return { ...c, status: '' };
              }
              return c;
            });

            const listId = Date.now() + Math.random();
            const listName = 'Database Import';
            const customersForList = mappedCustomers.map(c => ({
              ...c, fileId: listId, fileName: listName
            }));

            setSavedLists(prev => {
              const filtered = prev.filter(l => l.name !== 'Database Import');
              return [...filtered, {
                id: listId, name: listName, customers: customersForList,
                visible: true, count: customersForList.length, type: 'database'
              }];
            });

            console.log(`ðŸ“¦ Loaded ${mappedCustomers.length} customers from database`);
            return mappedCustomers.length;
          }
          return 0;
        } catch (err) {
          console.error('Failed to load from database:', err);
          return 0;
        }
      };

      const exportToCSV = async () => {
        try {
          window.open('/api/export/csv', '_blank');
        } catch (err) {
          console.error('Export failed:', err);
          alert('Export failed');
        }
      };
const createJob = async () => {
        try {
          let customerId = jobForm.customerId;
          let customerData = null;

          // If new customer, create them first
          if (jobForm.isNewCustomer) {
            if (!jobForm.firstName || !jobForm.lastName || !jobForm.address) {
              alert('Please fill in all required customer fields (name and address)');
              return;
            }

            // Geocode the address (or use pre-geocoded coordinates from autocomplete)
            setGeocoding(true);
            let geoResult;
            
            if (jobForm._preGeocodedLat && jobForm._preGeocodedLng) {
              // Use coordinates from autocomplete selection
              geoResult = {
                lat: jobForm._preGeocodedLat,
                lng: jobForm._preGeocodedLng
              };
            } else {
              // Geocode the address manually
              geoResult = await geocodeAddress(jobForm.address);
            }
            
            setGeocoding(false);

            if (!geoResult) {
              alert('Could not find coordinates for this address. Please check the address and try again.');
              return;
            }

            // Create new customer
            const newCustomer = {
              id: Date.now(),
              firstname: jobForm.firstName.trim(),
              lastname: jobForm.lastName.trim(),
              address: jobForm.address.trim(),
              latitude: geoResult.lat,
              longitude: geoResult.lng,
              phone: jobForm.phone.trim(),
              email: jobForm.email.trim(),
              totalPanels: parseInt(jobForm.panelCount) || 0,
              lastServiceDate: '',
              amountPaid: 0,
              status: '', // Default: no status (blank = no action needed)
              existingJob: false,
              isRecurring: jobForm.isRecurring,
              solarVerified: null,
              serviceHistory: [],
              notesHistory: []
            };

            customerData = newCustomer;
            customerId = newCustomer.id;
            
            // Add to customers and save to database
            setCustomers(prev => [...prev, newCustomer]);
            try {
              await apiFetch('/customers', {
                method: 'POST',
                body: JSON.stringify({
                  name: newCustomer.firstname + ' ' + newCustomer.lastname,
                  firstname: newCustomer.firstname,
                  lastname: newCustomer.lastname,
                  address: newCustomer.address,
                  latitude: newCustomer.latitude,
                  longitude: newCustomer.longitude,
                  phone: newCustomer.phone,
                  email: newCustomer.email,
                  total_panels: newCustomer.totalPanels,
                  status: newCustomer.status
                })
              });
            } catch(err) { console.error('Failed to save new customer to DB:', err); }
          } else {
            // Find existing customer
            customerData = customers.find(c => c.id === customerId);
            if (!customerData) {
              alert('Customer not found');
              return;
            }
          }

          // Calculate final price
          const finalPrice = jobForm.useCustomPrice 
            ? parseFloat(jobForm.customPrice) || 0
            : jobForm.calculatedPrice;

          // Create the job
          const newJob = {
            id: Date.now(),
            customerId: customerId,
            customerName: jobForm.isNewCustomer 
              ? `${jobForm.firstName} ${jobForm.lastName}`
              : jobForm.customerName,
            panelCount: parseInt(jobForm.panelCount) || 0,
            price: finalPrice,
            pricingTier: jobForm.pricingTier,
            jobType: jobForm.jobType,
            scheduledDate: jobForm.scheduledDate,
            scheduledTime: jobForm.scheduledTime,
            isRecurring: jobForm.isRecurring,
            recurringFrequency: jobForm.isRecurring ? parseInt(jobForm.recurringFrequency) : null,
            assignedEmployee: jobForm.assignedEmployee,
            notes: jobForm.notes,
            status: jobForm.scheduledDate ? 'scheduled' : 'unscheduled',
            createdAt: new Date().toISOString()
          };

          // Update customer with panel count if new customer or not set
          if (jobForm.isNewCustomer || !customerData.totalPanels) {
            const updatedCustomers = customers.map(c => 
              c.id === customerId 
                ? { ...c, totalPanels: parseInt(jobForm.panelCount) || 0 }
                : c
            );
            if (jobForm.isNewCustomer) {
              updatedCustomers.push({
                ...customerData,
                totalPanels: parseInt(jobForm.panelCount) || 0
              });
            }
            setCustomers(updatedCustomers);
          }

          // If job has a scheduled date/time, add to calendar
          if (jobForm.scheduledDate && jobForm.scheduledTime) {
            const dateKey = jobForm.scheduledDate;
            const timeSlot = jobForm.scheduledTime;
            
            const jobForRoute = {
              ...customerData,
              scheduledTime: timeSlot,
              jobId: newJob.id,
              jobType: jobForm.jobType,
              jobPrice: finalPrice,
              jobNotes: jobForm.notes,
              isRecurringJob: jobForm.isRecurring,
              panelCount: parseInt(jobForm.panelCount) || customerData.totalPanels
            };

            setRoutesByDay(prev => {
              const dayRoute = prev[dateKey] || [];
              const updatedRoute = [...dayRoute, jobForRoute];
              return { ...prev, [dateKey]: updatedRoute };
            });

            // If recurring, generate future instances
            if (jobForm.isRecurring) {
              const futureJobs = generateRecurringJobs(
                jobForm.scheduledDate,
                jobForm.scheduledTime,
                jobForm.recurringFrequency,
                10 // 10 years
              );

              futureJobs.forEach(futureJob => {
                const futureJobForRoute = {
                  ...jobForRoute,
                  jobId: Date.now() + Math.random(),
                  scheduledTime: futureJob.time
                };

                setRoutesByDay(prev => {
                  const dayRoute = prev[futureJob.date] || [];
                  const updatedRoute = [...dayRoute, futureJobForRoute];
                  return { ...prev, [futureJob.date]: updatedRoute };
                });
              });
            }

            // Update customer status to scheduled
            setCustomers(prev => prev.map(c => 
              c.id === customerId 
                ? { ...c, status: 'scheduled', scheduledDate: jobForm.scheduledDate, scheduledTime: jobForm.scheduledTime }
                : c
            ));
            propagateCustomerUpdate(customerId, { status: 'scheduled', scheduledDate: jobForm.scheduledDate, scheduledTime: jobForm.scheduledTime });
          } else {
            // No date/time - remains unscheduled
            setCustomers(prev => prev.map(c => 
              c.id === customerId 
                ? { ...c, status: 'unscheduled' }
                : c
            ));
            propagateCustomerUpdate(customerId, { status: 'unscheduled' });
          }

          // Close modal and reset form
          setShowJobModal(false);
          resetJobForm();
          
          alert(`Job created successfully! ${jobForm.isRecurring ? `${Math.floor((10 * 12) / parseInt(jobForm.recurringFrequency))} recurring instances generated.` : ''}`);
        } catch (error) {
          console.error('Error creating job:', error);
          alert('Error creating job. Please try again.');
        }
      };

      // Handle file upload
      const handleFileUpload = async (uploadedFiles) => {
        setLoading(true);
        setError(null);

        try {
          const fileArray = Array.from(uploadedFiles);
          
          for (const file of fileArray) {
            if (!file.name.endsWith('.csv')) {
              setError('Please upload CSV files only');
              continue;
            }

            setError(`ðŸ“¡ Processing ${file.name}...`);
            const result = await processCSVFile(file);
            
            if (result.customers.length === 0) {
              setError(`âš ï¸ No valid data found in ${file.name}. Please check that all required columns are present with valid data.`);
            } else {
              // Add file with its customers and visibility flag
              const fileId = Date.now() + Math.random(); // Unique ID
              const customersWithFileId = result.customers.map(c => ({
                ...c,
                fileId: fileId
              }));
              
              setUploadedFiles(prev => [...prev, {
                id: fileId,
                name: result.fileName,
                customers: customersWithFileId,
                visible: true, // Default to visible
                count: customersWithFileId.length
              }]);
              
              try {
                const addrMap = new Map();
                customersWithFileId.forEach(c => {
                  const normAddr = (c.address || '').toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, ' ').trim();
                  if (!normAddr) return;
                  const jobEntry = {
                    jobDescription: c.jobDescription || '',
                    status: c.status || '',
                    date: c.lastServiceDate || '',
                    amount: parseFloat(c.amountPaid) || 0,
                    tip: parseFloat(c.tipAmount) || 0,
                    panelCount: parseInt(c.panelCount) || 0,
                    isRecurring: c.isRecurring || false,
                    notes: c.notes || ''
                  };
                  if (addrMap.has(normAddr)) {
                    const ex = addrMap.get(normAddr);
                    if (jobEntry.jobDescription || jobEntry.date) {
                      const dup = ex.serviceHistory.some(j => j.jobDescription === jobEntry.jobDescription && j.date === jobEntry.date);
                      if (!dup) ex.serviceHistory.push(jobEntry);
                    }
                    const mDate = c.lastServiceDate || '';
                    if (mDate && (!ex.lastServiceDate || new Date(mDate) > new Date(ex.lastServiceDate))) {
                      ex.lastServiceDate = mDate;
                      ex.status = c.status || ex.status;
                      ex.jobDescription = c.jobDescription || ex.jobDescription;
                    }
                    ex.amountPaid = (parseFloat(ex.amountPaid) || 0) + (parseFloat(c.amountPaid) || 0);
                    ex.tipAmount = (parseFloat(ex.tipAmount) || 0) + (parseFloat(c.tipAmount) || 0);
                    const mp = parseInt(c.panelCount) || 0;
                    if (mp > (parseInt(ex.panelCount) || 0)) ex.panelCount = mp;
                    if (c.phone && !ex.secondaryPhones?.includes(c.phone) && c.phone !== ex.phone) {
                      if (!ex.secondaryPhones) ex.secondaryPhones = [];
                      ex.secondaryPhones.push(c.phone);
                    }
                    if (c.email && !ex.secondaryEmails?.includes(c.email) && c.email !== ex.email) {
                      if (!ex.secondaryEmails) ex.secondaryEmails = [];
                      ex.secondaryEmails.push(c.email);
                    }
                  } else {
                    c.serviceHistory = (jobEntry.jobDescription || jobEntry.date) ? [jobEntry] : [];
                    addrMap.set(normAddr, c);
                  }
                });
                const dedupedCustomers = Array.from(addrMap.values());
                const dbCustomers = dedupedCustomers.map(c => ({
                  first_name: c.firstName || '',
                  last_name: c.lastName || '',
                  full_name: c.name || '',
                  address: c.address || '',
                  street: c.street || '',
                  city: c.city || '',
                  state: c.state || '',
                  zip: c.zip || '',
                  lat: c.lat || null,
                  lng: c.lng || null,
                  phone: c.phone || '',
                  email: c.email || '',
                  secondary_phones: c.secondaryPhones || [],
                  secondary_emails: c.secondaryEmails || [],
                  status: c.status || '',
                  notes: c.notes || '',
                  panel_count: parseInt(c.panelCount) || 0,
                  total_panels: parseInt(c.totalPanels || c.panelCount) || 0,
                  job_description: c.jobDescription || '',
                  is_recurring: c.isRecurring || false,
                  amount_paid: parseFloat(c.amountPaid) || 0,
                  tip_amount: parseFloat(c.tipAmount) || 0,
                  last_service_date: c.lastServiceDate || '',
                  scheduled_date: c.scheduledDate || '',
                  scheduled_time: c.scheduledTime || '',
                  preferred_date: c.preferredDate || '',
                  preferred_time_window: c.preferredTimeWindow || '',
                  source: 'csv_upload',
                  serviceHistory: c.serviceHistory || []
                }));
                await apiFetch('/customers/bulk', {
                  method: 'POST',
                  body: JSON.stringify({ customers: dbCustomers })
                });
                console.log(`Saved ${dbCustomers.length} deduplicated customers (from ${customersWithFileId.length} rows) to database from CSV`);
              } catch (dbErr) {
                console.error('Failed to save CSV customers to database:', dbErr);
              }
              
              // Store failed customers if any
              if (result.failed && result.failed.length > 0) {
                setFailedCustomers(prev => [...prev, ...result.failed.map(f => ({ ...f, fileName: result.fileName }))]);
              }
              
              setError(null); // Clear error after successful upload
            }
          }
        } catch (err) {
          setError(`âŒ Failed to process file: ${err.message}`);
        } finally {
          setLoading(false);
        }
      };

      const handleFileDragOver = (e) => {
        e.preventDefault();
        setDragOver(true);
      };

      const handleFileDragLeave = () => {
        setDragOver(false);
      };

      const handleFileDrop = (e) => {
        e.preventDefault();
        setDragOver(false);
        handleFileUpload(e.dataTransfer.files);
      };

      const navigateToView = (view) => {
        if (unsavedRouteChanges && currentView === 'map' && view !== 'map') {
          setPendingViewChange(view);
          return;
        }
        setCurrentView(view);
      };

      const discardAllUnsavedRoutes = () => {
        // Clear all unsaved route data for all days
        Object.keys(unsavedRouteDays).forEach(dayKey => {
          const dayRoute = routesByDay[dayKey] || [];
          dayRoute.forEach(c => {
            // Only unschedule if not in a saved route
            const inSavedRoute = savedRoutes.some(r => (r.customers || []).some(rc => rc.id === c.id));
            if (!inSavedRoute) {
              propagateCustomerUpdate(c.id, { scheduledDate: null, scheduledTime: null, status: getStatusAfterUnschedule(c), routeConfirmed: false });
            }
          });
        });

        // Clear customer scheduling for all unsaved days
        setCustomers(prev => prev.map(c => {
          if (!c.scheduledDate) return c;
          const custDateKey = new Date(c.scheduledDate).toDateString();
          if (unsavedRouteDays[custDateKey]) {
            const inSavedRoute = savedRoutes.some(r => (r.customers || []).some(rc => rc.id === c.id));
            if (!inSavedRoute) {
              return { ...c, scheduledDate: null, scheduledTime: null, status: getStatusAfterUnschedule(c), routeConfirmed: false };
            }
          }
          return c;
        }));

        // Clear routesByDay for all unsaved days
        setRoutesByDay(prev => {
          const next = { ...prev };
          Object.keys(unsavedRouteDays).forEach(dayKey => { next[dayKey] = []; });
          return next;
        });

        setUnsavedRouteDays({});
        setUnsavedRouteChanges(false);
        setRoutePlannerEditMode(false);
        setRoute([]);
      };

      const confirmDiscardRoute = () => {
        discardAllUnsavedRoutes();
        if (pendingViewChange) {
          setCurrentView(pendingViewChange);
          setPendingViewChange(null);
        }
      };

      const cancelDiscardRoute = () => {
        setPendingViewChange(null);
      };

      const zoomToCustomer = (customer) => {
        if (mapInstanceRef.current) {
          mapInstanceRef.current.setView([customer.lat, customer.lng], 15);
          setCurrentView('map');
        }
      };

      const removeFile = (fileName) => {
        const newFiles = files.filter(f => f.name !== fileName);
        const newCustomers = customers.filter(c => c.fileName !== fileName);
        setFiles(newFiles);
        setCustomers(newCustomers);
        // filteredCustomers will be updated by unified filter reacting to customers change
      };

      return (
        <>
        <div style={{
          width: '100vw',
          height: '95vh',
          background: 'linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%)',
          fontFamily: "'Inter', sans-serif",
          color: '#f1f5f9',
          display: 'flex',
          flexDirection: 'column',
          overflow: 'hidden',
          maxWidth: '100vw',
          overflowX: 'hidden'
        }}>
          
          {/* Floating Verification Notification */}
          {verifying && (
            <div style={{
              position: 'fixed',
              bottom: '32px',
              right: '32px',
              zIndex: 10000,
              background: 'linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%)',
              padding: '20px 24px',
              borderRadius: '16px',
              boxShadow: '0 20px 60px rgba(139, 92, 246, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1)',
              display: 'flex',
              alignItems: 'center',
              gap: '16px',
              minWidth: '320px',
              animation: 'slideInRight 0.3s ease-out',
              border: '2px solid rgba(255, 255, 255, 0.2)'
            }}>
              <div style={{
                width: '48px',
                height: '48px',
                borderRadius: '12px',
                background: 'rgba(255, 255, 255, 0.2)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: '24px',
                animation: 'pulse 2s infinite'
              }}>
                ðŸ¤–
              </div>
              <div style={{ flex: 1 }}>
                <div style={{ fontSize: '15px', fontWeight: 700, marginBottom: '6px', color: 'white' }}>
                  Verifying Solar Panels
                </div>
                <div style={{ fontSize: '13px', color: 'rgba(255, 255, 255, 0.9)', marginBottom: '8px' }}>
                  {verificationProgress.current} of {verificationProgress.total} homes analyzed
                </div>
                <div style={{ height: '6px', background: 'rgba(255, 255, 255, 0.2)', borderRadius: '3px', overflow: 'hidden' }}>
                  <div style={{
                    height: '100%',
                    background: 'linear-gradient(90deg, #ffffff 0%, #e0e7ff 100%)',
                    width: `${(verificationProgress.current / verificationProgress.total * 100)}%`,
                    transition: 'width 0.3s ease',
                    boxShadow: '0 0 10px rgba(255, 255, 255, 0.5)'
                  }}></div>
                </div>
              </div>
            </div>
          )}
          
          {/* Header */}
          <div style={{
            background: 'rgba(15, 23, 42, 0.8)',
            backdropFilter: 'blur(20px)',
            borderBottom: '1px solid rgba(139, 92, 246, 0.1)',
            padding: '6px 16px',
            maxWidth: '100vw',
            overflowX: 'hidden'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '4px' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                <div style={{
                  width: '20px',
                  height: '20px',
                  background: 'linear-gradient(135deg, #8b5cf6, #6366f1)',
                  borderRadius: '6px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  boxShadow: '0 2px 8px rgba(139, 92, 246, 0.4)',
                  fontSize: '12px'
                }}>
                  ðŸ“
                </div>
                <div>
                  <h1 style={{
                    fontSize: '14px',
                    fontWeight: 800,
                    margin: 0,
                    background: 'linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%)',
                    WebkitBackgroundClip: 'text',
                    WebkitTextFillColor: 'transparent',
                    letterSpacing: '-0.5px'
                  }}>
                    Route Planner & CRM
                  </h1>
                  <p style={{ fontSize: '9px', color: '#94a3b8', margin: '0' }}>
                    {stats.visible > 0 && stats.visible !== stats.total 
                      ? `Viewing ${stats.visible} of ${stats.total} customers`
                      : `${stats.total} customers loaded`
                    }
                  </p>
                </div>
              </div>
              
              {/* Show All Markers Button (only for large datasets) */}
              {customers.length > 5000 && !showAllMarkers && (
                <button
                  onClick={() => {
                    if (confirm(`âš ï¸ You have ${customers.length.toLocaleString()} customers!\n\nShowing all markers may slow down your browser.\n\nRecommended: Use filters or radius search instead.\n\nShow all anyway?`)) {
                      setShowAllMarkers(true);
                    }
                  }}
                  style={{
                    padding: '8px 16px',
                    fontSize: '12px',
                    fontWeight: 600,
                    display: 'flex',
                    alignItems: 'center',
                    gap: '6px',
                    background: 'rgba(245, 158, 11, 0.1)',
                    border: '1px solid rgba(245, 158, 11, 0.3)',
                    borderRadius: '8px',
                    color: '#fbbf24',
                    cursor: 'pointer',
                    transition: 'all 0.2s'
                  }}
                >
                  <span style={{ fontSize: '16px' }}>âš¡</span>
                  Show All ({customers.length.toLocaleString()})
                </button>
              )}
              
              {/* Hide Some Markers Button (when showing all) */}
              {customers.length > 5000 && showAllMarkers && (
                <button
                  onClick={() => setShowAllMarkers(false)}
                  style={{
                    padding: '8px 16px',
                    fontSize: '12px',
                    fontWeight: 600,
                    display: 'flex',
                    alignItems: 'center',
                    gap: '6px',
                    background: 'rgba(34, 197, 94, 0.1)',
                    border: '1px solid rgba(34, 197, 94, 0.3)',
                    borderRadius: '8px',
                    color: '#86efac',
                    cursor: 'pointer',
                    transition: 'all 0.2s'
                  }}
                >
                  <span style={{ fontSize: '16px' }}>âš¡</span>
                  Performance Mode
                </button>
              )}
              
              {/* Failed Customers Notification */}
              {failedCustomers.length > 0 && (
                <div style={{
                  padding: '12px 16px',
                  background: 'rgba(251, 191, 36, 0.1)',
                  border: '1px solid rgba(251, 191, 36, 0.3)',
                  borderRadius: '12px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between',
                  gap: '12px',
                  marginTop: '16px'
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <div style={{ fontSize: '24px' }}>âš ï¸</div>
                    <div>
                      <div style={{ fontSize: '13px', fontWeight: 600, color: '#fbbf24' }}>
                        {failedCustomers.length} {failedCustomers.length === 1 ? 'address' : 'addresses'} couldn't be mapped
                      </div>
                      <div style={{ fontSize: '11px', color: '#94a3b8' }}>
                        Click to review and fix addresses
                      </div>
                    </div>
                  </div>
                  <button
                    onClick={() => setShowFailedCustomersModal(true)}
                    style={{
                      padding: '8px 16px',
                      background: 'rgba(251, 191, 36, 0.2)',
                      border: '1px solid rgba(251, 191, 36, 0.4)',
                      borderRadius: '8px',
                      color: '#fbbf24',
                      fontSize: '12px',
                      fontWeight: 600,
                      cursor: 'pointer',
                      whiteSpace: 'nowrap'
                    }}
                  >
                    ðŸ“ Review & Fix
                  </button>
                </div>
              )}
              
              {currentView === 'map' && (
                <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                  {referenceAddress && (
                    <div className="glass-card" style={{ padding: '8px 12px', display: 'flex', alignItems: 'center', gap: '6px' }}>
                      <div style={{ fontSize: '14px' }}>ðŸŽ¯</div>
                      <div style={{ fontSize: '12px' }}>
                        <div style={{ color: '#94a3b8', fontSize: '10px' }}>Search Center</div>
                        <div style={{ color: '#f1f5f9', fontWeight: 600 }}>{referenceAddress.split(',')[0]}</div>
                      </div>
                    </div>
                  )}
                  <button
                    className="button-secondary"
                    onClick={() => setShowHeatMap(!showHeatMap)}
                  >
                    ðŸ”¥ Heat Map
                  </button>
                  <button
                    className="button-primary"
                    onClick={() => setRadiusMode(true)}
                  >
                    ðŸŽ¯ Radius Search
                  </button>
                  {referencePoint && (
                    <>
                      <button
                        className="button-secondary"
                        onClick={downloadRadiusResultsCSV}
                        style={{ background: 'rgba(34, 197, 94, 0.1)', borderColor: 'rgba(34, 197, 94, 0.3)', color: '#86efac' }}
                      >
                        ðŸ“¥ Download CSV ({filteredCustomers.length})
                      </button>
                      <button
                        className="button-secondary"
                        onClick={() => {
                          setRadiusMode(false);
                          setAwaitingMapClick(false);
                          setDrawMode(false);
                          clearRadius();
                          clearDrawnArea();
                        }}
                        style={{ background: 'rgba(239, 68, 68, 0.1)', borderColor: 'rgba(239, 68, 68, 0.3)', color: '#fca5a5' }}
                      >
                        âŒ Exit Radius Mode
                      </button>
                    </>
                  )}
                </div>
              )}
            </div>



            {/* View Tabs and Search */}
            <div style={{ display: 'flex', gap: '8px', alignItems: 'center', paddingTop: '4px', flexWrap: 'wrap' }}>
              <div style={{ display: 'flex', gap: '4px', flexShrink: 0 }}>
                <button className={`tab-button ${currentView === 'dashboard' ? 'active' : ''}`} onClick={() => navigateToView('dashboard')}>
                  ðŸ“Š Dashboard
                </button>
                <button className={`tab-button ${currentView === 'map' ? 'active' : ''}`} onClick={() => navigateToView('map')}>
                  ðŸ—ºï¸ Map
                </button>
                <button className={`tab-button ${currentView === 'saved' ? 'active' : ''}`} onClick={() => navigateToView('saved')}>
                  ðŸ“ Saved Routes ({savedRoutes.filter(r => !r.sentToTech).length})
                </button>
                <button className={`tab-button ${currentView === 'history' ? 'active' : ''}`} onClick={() => navigateToView('history')}>
                  ðŸ“œ Route History ({savedRoutes.filter(r => r.sentToTech).length})
                </button>
                <button className={`tab-button ${currentView === 'pipeline' ? 'active' : ''}`} onClick={() => navigateToView('pipeline')}>
                  ðŸ“‹ Database ({customers.length})
                </button>

              </div>
              
              {/* Search Bar - hidden on Database and Dashboard views */}
              {customers.length > 0 && currentView !== 'pipeline' && currentView !== 'dashboard' && (
                <div style={{ position: 'relative', flex: 1, minWidth: '200px', maxWidth: '350px' }}>
                  <div style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: '#64748b', fontSize: '14px' }}>
                    ðŸ”
                  </div>
                  <input
                    type="text"
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    placeholder="Search customers..."
                    className="input-field"
                    style={{ 
                      paddingLeft: '38px', 
                      paddingRight: searchQuery ? '38px' : '12px',
                      height: '32px',
                      fontSize: '12px'
                    }}
                  />
                  {searchQuery && (
                    <button
                      onClick={() => setSearchQuery('')}
                      style={{
                        position: 'absolute',
                        right: '12px',
                        top: '50%',
                        transform: 'translateY(-50%)',
                        background: 'transparent',
                        border: 'none',
                        color: '#64748b',
                        cursor: 'pointer',
                        padding: 0,
                        display: 'flex',
                        alignItems: 'center',
                        fontSize: '14px'
                      }}
                    >
                      âŒ
                    </button>
                  )}
                </div>
              )}
              
              {/* Save List Button - only show when searching or filtering */}
              {(searchQuery || cityFilter || stateFilter || zipFilter) && visibleCustomers.length > 0 && (
                <button
                  onClick={() => setShowSaveListModal(true)}
                  className="button-secondary"
                  style={{
                    fontSize: '10px',
                    padding: '6px 12px',
                    whiteSpace: 'nowrap'
                  }}
                >
                  ðŸ’¾ Save List ({visibleCustomers.length})
                </button>
              )}
            </div>
          </div>

          {/* Content - Keep map always rendered but hidden */}
          <div style={{ flex: 1, overflow: 'hidden', position: 'relative' }}>

            {/* Dashboard View */}
            {currentView === 'dashboard' && (() => {
              const today = new Date();
              today.setHours(0, 0, 0, 0);
              const todayEnd = new Date(today);
              todayEnd.setHours(23, 59, 59, 999);

              const weekStart = new Date(today);
              const dayOfWeek = today.getDay();
              weekStart.setDate(today.getDate() - ((dayOfWeek + 6) % 7));
              const weekDays = Array.from({ length: 6 }, (_, i) => {
                const d = new Date(weekStart);
                d.setDate(weekStart.getDate() + i);
                return d;
              });

              const todaysJobs = getScheduledCustomersForRange(today, todayEnd);
              const unscheduledCustomers = customers.filter(c => (c.status || '').toLowerCase() === 'unscheduled');
              const completedCustomers = customers.filter(c => c.lastServiceDate && c.lastServiceDate !== '');
              const recurringCustomers = customers.filter(c => c.isRecurring || c.recurring === 'TRUE');
              const recentCustomers = [...customers].sort((a, b) => (b.id || 0) - (a.id || 0)).slice(0, 8);

              return (
                <div style={{
                  position: 'absolute', top: 0, left: 0, right: 0, bottom: 0,
                  overflow: 'auto', padding: '28px 32px'
                }} className="scrollbar-custom">

                  {/* Greeting */}
                  <div style={{ marginBottom: '24px' }}>
                    <h2 style={{ fontSize: '22px', fontWeight: 800, margin: '0 0 4px 0', color: '#f1f5f9' }}>
                      {new Date().getHours() < 12 ? 'Good Morning' : new Date().getHours() < 17 ? 'Good Afternoon' : 'Good Evening'}
                    </h2>
                    <p style={{ margin: 0, color: '#64748b', fontSize: '14px' }}>
                      {today.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}
                    </p>
                  </div>

                  {/* Stats Cards */}
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', marginBottom: '24px' }}>
                    <div
                      onClick={() => setCurrentView('pipeline')}
                      style={{ padding: '20px', background: 'rgba(139, 92, 246, 0.1)', border: '1px solid rgba(139, 92, 246, 0.2)', borderRadius: '14px', cursor: 'pointer', transition: 'all 0.2s' }}
                    >
                      <div style={{ fontSize: '11px', color: '#94a3b8', textTransform: 'uppercase', fontWeight: 700, marginBottom: '8px' }}>Total Customers</div>
                      <div style={{ fontSize: '32px', fontWeight: 800, color: '#a78bfa' }}>{customers.length}</div>
                    </div>
                    <div
                      onClick={() => { setCurrentView('map'); }}
                      style={{ padding: '20px', background: 'rgba(239, 68, 68, 0.1)', border: '1px solid rgba(239, 68, 68, 0.2)', borderRadius: '14px', cursor: 'pointer', transition: 'all 0.2s' }}
                    >
                      <div style={{ fontSize: '11px', color: '#94a3b8', textTransform: 'uppercase', fontWeight: 700, marginBottom: '8px' }}>Unscheduled</div>
                      <div style={{ fontSize: '32px', fontWeight: 800, color: '#ef4444' }}>{unscheduledCustomers.length}</div>
                      <div style={{ fontSize: '11px', color: '#64748b', marginTop: '4px' }}>Need routing</div>
                    </div>
                    <div style={{ padding: '20px', background: 'rgba(34, 197, 94, 0.1)', border: '1px solid rgba(34, 197, 94, 0.2)', borderRadius: '14px' }}>
                      <div style={{ fontSize: '11px', color: '#94a3b8', textTransform: 'uppercase', fontWeight: 700, marginBottom: '8px' }}>Serviced</div>
                      <div style={{ fontSize: '32px', fontWeight: 800, color: '#22c55e' }}>{completedCustomers.length}</div>
                    </div>
                    <div style={{ padding: '20px', background: 'rgba(34, 211, 238, 0.1)', border: '1px solid rgba(34, 211, 238, 0.2)', borderRadius: '14px' }}>
                      <div style={{ fontSize: '11px', color: '#94a3b8', textTransform: 'uppercase', fontWeight: 700, marginBottom: '8px' }}>Recurring</div>
                      <div style={{ fontSize: '32px', fontWeight: 800, color: '#22d3ee' }}>{recurringCustomers.length}</div>
                    </div>
                  </div>

                  {/* Weekly Calendar Strip + Today's Jobs side by side */}
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '24px' }}>

                    {/* Weekly Calendar */}
                    <div style={{ padding: '20px', background: 'rgba(15, 23, 42, 0.6)', border: '1px solid rgba(148, 163, 184, 0.1)', borderRadius: '14px' }}>
                      <div style={{ fontSize: '14px', fontWeight: 700, color: '#e2e8f0', marginBottom: '16px' }}>This Week</div>
                      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(6, 1fr)', gap: '8px' }}>
                        {weekDays.map((day, i) => {
                          const dayStart = new Date(day); dayStart.setHours(0, 0, 0, 0);
                          const dayEnd = new Date(day); dayEnd.setHours(23, 59, 59, 999);
                          const dayJobs = getScheduledCustomersForRange(dayStart, dayEnd);
                          const isToday = day.toDateString() === today.toDateString();
                          const isPast = day < today;
                          return (
                            <div
                              key={i}
                              onClick={() => {
                                setCurrentView('map');
                              }}
                              style={{
                                padding: '12px 8px',
                                background: isToday ? 'rgba(139, 92, 246, 0.2)' : 'rgba(30, 41, 59, 0.5)',
                                border: isToday ? '2px solid rgba(139, 92, 246, 0.5)' : '1px solid rgba(148, 163, 184, 0.1)',
                                borderRadius: '10px',
                                textAlign: 'center',
                                cursor: 'pointer',
                                opacity: isPast && !isToday ? 0.5 : 1,
                                transition: 'all 0.2s'
                              }}
                            >
                              <div style={{ fontSize: '11px', color: isToday ? '#a78bfa' : '#64748b', fontWeight: 600, marginBottom: '4px' }}>
                                {day.toLocaleDateString('en-US', { weekday: 'short' })}
                              </div>
                              <div style={{ fontSize: '13px', color: '#94a3b8', marginBottom: '6px' }}>
                                {day.getDate()}
                              </div>
                              <div style={{
                                fontSize: '18px', fontWeight: 800,
                                color: dayJobs.length > 0 ? (isToday ? '#a78bfa' : '#e2e8f0') : '#334155'
                              }}>
                                {dayJobs.length}
                              </div>
                              <div style={{ fontSize: '9px', color: '#64748b', marginTop: '2px' }}>
                                {dayJobs.length === 1 ? 'job' : 'jobs'}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>

                    {/* Today's Jobs */}
                    <div style={{ padding: '20px', background: 'rgba(15, 23, 42, 0.6)', border: '1px solid rgba(148, 163, 184, 0.1)', borderRadius: '14px' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                        <div style={{ fontSize: '14px', fontWeight: 700, color: '#e2e8f0' }}>Today's Jobs</div>
                        <span style={{ fontSize: '11px', padding: '3px 10px', background: todaysJobs.length > 0 ? 'rgba(139, 92, 246, 0.2)' : 'rgba(100, 116, 139, 0.2)', border: '1px solid ' + (todaysJobs.length > 0 ? 'rgba(139, 92, 246, 0.3)' : 'rgba(100, 116, 139, 0.2)'), borderRadius: '12px', color: todaysJobs.length > 0 ? '#a78bfa' : '#64748b' }}>
                          {todaysJobs.length} scheduled
                        </span>
                      </div>
                      {todaysJobs.length === 0 ? (
                        <div style={{ textAlign: 'center', padding: '24px 0', color: '#475569' }}>
                          <div style={{ fontSize: '28px', marginBottom: '8px' }}>ðŸ“­</div>
                          <div style={{ fontSize: '13px' }}>No jobs scheduled for today</div>
                        </div>
                      ) : (
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', maxHeight: '200px', overflow: 'auto' }} className="scrollbar-custom">
                          {todaysJobs.slice(0, 8).map((c, i) => (
                            <div
                              key={c.id || i}
                              onClick={() => { setProfileCustomer(c); setShowCustomerProfile(true); }}
                              style={{
                                display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                                padding: '10px 12px', background: 'rgba(30, 41, 59, 0.5)',
                                border: '1px solid rgba(148, 163, 184, 0.1)', borderRadius: '8px',
                                cursor: 'pointer', transition: 'all 0.15s'
                              }}
                            >
                              <div>
                                <div style={{ fontSize: '13px', fontWeight: 600, color: '#e2e8f0' }}>{c.name || `${c.firstName || ''} ${c.lastName || ''}`.trim()}</div>
                                <div style={{ fontSize: '11px', color: '#64748b' }}>{c.city}{c.city && c.state ? ', ' : ''}{c.state}</div>
                              </div>
                              <div style={{ fontSize: '10px', color: '#94a3b8', textAlign: 'right' }}>
                                {c._routeName && <div>{c._routeName}</div>}
                              </div>
                            </div>
                          ))}
                          {todaysJobs.length > 8 && (
                            <div style={{ textAlign: 'center', fontSize: '11px', color: '#64748b', padding: '4px' }}>
                              +{todaysJobs.length - 8} more
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Needs Attention + Recent Activity side by side */}
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>

                    {/* Needs Attention */}
                    <div style={{ padding: '20px', background: 'rgba(15, 23, 42, 0.6)', border: '1px solid rgba(148, 163, 184, 0.1)', borderRadius: '14px' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                        <div style={{ fontSize: '14px', fontWeight: 700, color: '#e2e8f0' }}>Needs Attention</div>
                        {unscheduledCustomers.length > 0 && (
                          <span style={{ fontSize: '11px', padding: '3px 10px', background: 'rgba(239, 68, 68, 0.15)', border: '1px solid rgba(239, 68, 68, 0.3)', borderRadius: '12px', color: '#ef4444' }}>
                            {unscheduledCustomers.length} unscheduled
                          </span>
                        )}
                      </div>
                      {unscheduledCustomers.length === 0 ? (
                        <div style={{ textAlign: 'center', padding: '24px 0', color: '#475569' }}>
                          <div style={{ fontSize: '28px', marginBottom: '8px' }}>âœ…</div>
                          <div style={{ fontSize: '13px' }}>All customers are scheduled</div>
                        </div>
                      ) : (
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '6px', maxHeight: '220px', overflow: 'auto' }} className="scrollbar-custom">
                          {unscheduledCustomers.slice(0, 10).map((c, i) => (
                            <div
                              key={c.id || i}
                              onClick={() => { setProfileCustomer(c); setShowCustomerProfile(true); }}
                              style={{
                                display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                                padding: '8px 12px', background: 'rgba(239, 68, 68, 0.05)',
                                border: '1px solid rgba(239, 68, 68, 0.1)', borderRadius: '8px',
                                cursor: 'pointer', transition: 'all 0.15s'
                              }}
                            >
                              <div>
                                <div style={{ fontSize: '13px', fontWeight: 600, color: '#e2e8f0' }}>{c.name || `${c.firstName || ''} ${c.lastName || ''}`.trim()}</div>
                                <div style={{ fontSize: '11px', color: '#64748b' }}>{c.address ? `${c.city || ''}${c.city && c.state ? ', ' : ''}${c.state || ''}` : 'No address'}</div>
                              </div>
                              <div style={{ fontSize: '10px', padding: '2px 8px', background: 'rgba(239, 68, 68, 0.15)', border: '1px solid rgba(239, 68, 68, 0.2)', borderRadius: '10px', color: '#ef4444' }}>
                                unscheduled
                              </div>
                            </div>
                          ))}
                          {unscheduledCustomers.length > 10 && (
                            <button
                              onClick={() => { setCurrentView('map'); }}
                              style={{ textAlign: 'center', fontSize: '12px', color: '#a78bfa', padding: '8px', background: 'none', border: 'none', cursor: 'pointer' }}
                            >
                              View all {unscheduledCustomers.length} unscheduled â†’
                            </button>
                          )}
                        </div>
                      )}
                    </div>

                    {/* Recent Customers */}
                    <div style={{ padding: '20px', background: 'rgba(15, 23, 42, 0.6)', border: '1px solid rgba(148, 163, 184, 0.1)', borderRadius: '14px' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                        <div style={{ fontSize: '14px', fontWeight: 700, color: '#e2e8f0' }}>Recently Added</div>
                        <button
                          onClick={() => setCurrentView('pipeline')}
                          style={{ fontSize: '11px', color: '#a78bfa', background: 'none', border: 'none', cursor: 'pointer' }}
                        >
                          View All â†’
                        </button>
                      </div>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '6px', maxHeight: '220px', overflow: 'auto' }} className="scrollbar-custom">
                        {recentCustomers.map((c, i) => (
                          <div
                            key={c.id || i}
                            onClick={() => { setProfileCustomer(c); setShowCustomerProfile(true); }}
                            style={{
                              display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                              padding: '8px 12px', background: 'rgba(30, 41, 59, 0.4)',
                              border: '1px solid rgba(148, 163, 184, 0.08)', borderRadius: '8px',
                              cursor: 'pointer', transition: 'all 0.15s'
                            }}
                          >
                            <div>
                              <div style={{ fontSize: '13px', fontWeight: 600, color: '#e2e8f0' }}>{c.name || `${c.firstName || ''} ${c.lastName || ''}`.trim()}</div>
                              <div style={{ fontSize: '11px', color: '#64748b' }}>{c.city}{c.city && c.state ? ', ' : ''}{c.state}{c.zip ? ' ' + c.zip : ''}</div>
                            </div>
                            <div style={{ fontSize: '10px', padding: '2px 8px', background: c.status === 'unscheduled' ? 'rgba(239, 68, 68, 0.15)' : c.status === 'scheduled' ? 'rgba(251, 191, 36, 0.15)' : c.status === 'completed' ? 'rgba(34, 197, 94, 0.15)' : c.status === 'in progress' ? 'rgba(59, 130, 246, 0.15)' : 'rgba(100, 116, 139, 0.15)', border: '1px solid ' + (c.status === 'unscheduled' ? 'rgba(239, 68, 68, 0.2)' : c.status === 'scheduled' ? 'rgba(251, 191, 36, 0.2)' : c.status === 'completed' ? 'rgba(34, 197, 94, 0.2)' : c.status === 'in progress' ? 'rgba(59, 130, 246, 0.2)' : 'rgba(100, 116, 139, 0.15)'), borderRadius: '10px', color: c.status === 'unscheduled' ? '#ef4444' : c.status === 'scheduled' ? '#fbbf24' : c.status === 'completed' ? '#22c55e' : c.status === 'in progress' ? '#3b82f6' : '#64748b' }}>
                              {c.status || 'no status'}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>

                </div>
              );
            })()}

            {/* Map View */}
            <div style={{ 
              display: currentView === 'map' ? 'flex' : 'none',
              flex: 1,
              overflow: 'hidden',
              position: 'absolute',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0
            }}>
              {/* Left Sidebar */}
              <div style={{
                width: '320px',
                background: 'rgba(15, 23, 42, 0.95)',
                backdropFilter: 'blur(20px)',
                borderRight: '1px solid rgba(139, 92, 246, 0.1)',
                display: 'flex',
                flexDirection: 'column',
                overflow: 'hidden'
              }}>
                {/* Weekly Calendar - Hidden in Route Planner mode */}
                {showCalendar && statusFilter !== 'scheduled' && (
                  <div style={{
                    padding: '8px 12px',
                    borderBottom: '1px solid rgba(139, 92, 246, 0.1)',
                    background: 'rgba(15, 23, 42, 0.8)'
                  }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '6px' }}>
                      <h3 style={{ fontSize: '12px', fontWeight: 700, margin: 0, color: '#8b5cf6' }}>
                        ðŸ“… {calendarViewMode === 'month' ? selectedDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) : 'Schedule'}
                      </h3>
                      <div style={{ display: 'flex', gap: '4px' }}>
                        <button
                          onClick={() => setCalendarViewMode(calendarViewMode === 'week' ? 'month' : 'week')}
                          style={{
                            background: 'rgba(34, 197, 94, 0.1)',
                            border: '1px solid rgba(34, 197, 94, 0.3)',
                            borderRadius: '6px',
                            padding: '4px 8px',
                            color: '#22c55e',
                            cursor: 'pointer',
                            fontSize: '10px',
                            fontWeight: 600
                          }}
                          title={calendarViewMode === 'week' ? 'Show month view' : 'Show week view'}
                        >
                          {calendarViewMode === 'week' ? 'ðŸ“… Month' : 'ðŸ“† Week'}
                        </button>
                        {calendarViewMode === 'week' && (
                          <>
                            <button
                              onClick={() => navigateWeek(-1)}
                              style={{
                                background: 'rgba(139, 92, 246, 0.1)',
                                border: '1px solid rgba(139, 92, 246, 0.2)',
                                borderRadius: '6px',
                                padding: '4px 8px',
                            color: '#8b5cf6',
                            cursor: 'pointer',
                            fontSize: '12px'
                          }}
                        >
                          â†
                        </button>
                        <button
                          onClick={goToToday}
                          style={{
                            background: 'rgba(139, 92, 246, 0.1)',
                            border: '1px solid rgba(139, 92, 246, 0.2)',
                            borderRadius: '6px',
                            padding: '4px 12px',
                            color: '#8b5cf6',
                            cursor: 'pointer',
                            fontSize: '11px',
                            fontWeight: 600
                          }}
                        >
                          This Week
                        </button>
                        <button
                          onClick={() => navigateWeek(1)}
                          style={{
                            background: 'rgba(139, 92, 246, 0.1)',
                            border: '1px solid rgba(139, 92, 246, 0.2)',
                            borderRadius: '6px',
                            padding: '4px 8px',
                            color: '#8b5cf6',
                            cursor: 'pointer',
                            fontSize: '12px'
                          }}
                        >
                          â†’
                        </button>
                          </>
                        )}
                        {calendarViewMode === 'month' && (
                          <>
                            <button
                              onClick={() => {
                                const newDate = new Date(selectedDate);
                                newDate.setMonth(newDate.getMonth() - 1);
                                setSelectedDate(newDate);
                              }}
                              style={{
                                background: 'rgba(139, 92, 246, 0.1)',
                                border: '1px solid rgba(139, 92, 246, 0.2)',
                                borderRadius: '6px',
                                padding: '4px 8px',
                                color: '#8b5cf6',
                                cursor: 'pointer',
                                fontSize: '12px'
                              }}
                            >
                              â†
                            </button>
                            <button
                              onClick={goToToday}
                              style={{
                                background: 'rgba(139, 92, 246, 0.1)',
                                border: '1px solid rgba(139, 92, 246, 0.2)',
                                borderRadius: '6px',
                                padding: '4px 12px',
                                color: '#8b5cf6',
                                cursor: 'pointer',
                                fontSize: '11px',
                                fontWeight: 600
                              }}
                            >
                              This Week
                            </button>
                            <button
                              onClick={() => {
                                const newDate = new Date(selectedDate);
                                newDate.setMonth(newDate.getMonth() + 1);
                                setSelectedDate(newDate);
                              }}
                              style={{
                                background: 'rgba(139, 92, 246, 0.1)',
                                border: '1px solid rgba(139, 92, 246, 0.2)',
                                borderRadius: '6px',
                                padding: '4px 8px',
                                color: '#8b5cf6',
                                cursor: 'pointer',
                                fontSize: '12px'
                              }}
                            >
                              â†’
                            </button>
                          </>
                        )}
                        <button
                          onClick={() => setShowCalendar(false)}
                          style={{
                            background: 'transparent',
                            border: 'none',
                            color: '#64748b',
                            cursor: 'pointer',
                            fontSize: '16px',
                            padding: '0 4px'
                          }}
                          title="Hide calendar"
                        >
                          âœ•
                        </button>
                      </div>
                    </div>
                    
                    {/* Week or Month Days */}
                    {calendarViewMode === 'week' ? (
                      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '4px' }}>
                        {getWeekDays(weekStart).map((date, index) => {
                        const isToday = date.toDateString() === new Date().toDateString();
                        const isSelected = date.toDateString() === selectedDate.toDateString();
                        const routesForDay = getRoutesForDate(date);
                        const hasRoutes = routesForDay.length > 0;
                        
                        return (
                          <div
                            key={index}
                            onClick={() => setSelectedDate(date)}
                            style={{
                              padding: '4px 2px',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              background: isSelected ? 'rgba(139, 92, 246, 0.3)' : 
                                         isToday ? 'rgba(59, 130, 246, 0.1)' : 
                                         'rgba(30, 41, 59, 0.3)',
                              border: isSelected ? '2px solid rgba(139, 92, 246, 0.8)' :
                                     isToday ? '1px solid rgba(59, 130, 246, 0.4)' :
                                     '1px solid transparent',
                              boxShadow: isSelected ? '0 0 12px rgba(139, 92, 246, 0.6)' : 'none',
                              transition: 'all 0.2s',
                              position: 'relative',
                              animation: isSelected ? 'pulse-glow 2s ease-in-out infinite' : 'none'
                            }}
                            onMouseEnter={(e) => {
                              if (!isSelected) {
                                e.currentTarget.style.background = 'rgba(139, 92, 246, 0.15)';
                              }
                            }}
                            onMouseLeave={(e) => {
                              if (!isSelected) {
                                e.currentTarget.style.background = isToday ? 'rgba(59, 130, 246, 0.1)' : 'rgba(30, 41, 59, 0.3)';
                              }
                            }}
                            title="Click to view day schedule"
                          >
                            <div style={{ fontSize: '8px', fontWeight: 600, color: '#64748b', textAlign: 'center', marginBottom: '1px', textTransform: 'uppercase' }}>
                              {date.toLocaleDateString('en-US', { weekday: 'short' })}
                            </div>
                            <div style={{ fontSize: '13px', fontWeight: 700, color: isSelected ? '#a78bfa' : isToday ? '#60a5fa' : '#f1f5f9', textAlign: 'center', position: 'relative' }}>
                              {date.getDate()}
                              {/* Unsaved route indicator (orange dot) */}
                              {unsavedRouteDays[date.toDateString()] && (
                                <span style={{
                                  position: 'absolute',
                                  top: '-4px',
                                  left: '-4px',
                                  width: '8px',
                                  height: '8px',
                                  borderRadius: '50%',
                                  background: '#f59e0b',
                                  boxShadow: '0 0 6px rgba(245, 158, 11, 0.6)'
                                }} title="Unsaved route" />
                              )}
                              {/* Green checkmark for saved routes */}
                              {(() => {
                                const hasSavedRoute = savedRoutes.some(r => {
                                  const routeDate = new Date(r.scheduledDate);
                                  return routeDate.toDateString() === date.toDateString() && r.confirmed;
                                });
                                return hasSavedRoute ? (
                                  <span style={{
                                    position: 'absolute',
                                    top: '-6px',
                                    right: '-6px',
                                    fontSize: '14px',
                                    color: '#22c55e',
                                    filter: 'drop-shadow(0 2px 4px rgba(0,0,0,0.8))'
                                  }}>âœ“</span>
                                ) : null;
                              })()}
                            </div>
                            {hasRoutes && (
                              <div style={{
                                position: 'absolute',
                                bottom: '4px',
                                left: '50%',
                                transform: 'translateX(-50%)',
                                display: 'flex',
                                gap: '2px'
                              }}>
                                {routesForDay.slice(0, 3).map((_, idx) => (
                                  <div key={idx} style={{
                                    width: '4px',
                                    height: '4px',
                                    borderRadius: '50%',
                                    background: isSelected ? '#a78bfa' : '#22c55e'
                                  }} />
                                ))}
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                    ) : (
                      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '3px', maxHeight: '240px', overflowY: 'auto' }} className="scrollbar-custom">
                        {getMonthDays(selectedDate).map((date, index) => {
                          const isToday = date.toDateString() === new Date().toDateString();
                          const isSelected = date.toDateString() === selectedDate.toDateString();
                          const routesForDay = getRoutesForDate(date);
                          const hasSavedRoute = savedRoutes.some(r => {
                            const routeDate = new Date(r.scheduledDate);
                            return routeDate.toDateString() === date.toDateString() && r.confirmed;
                          });
                          
                          return (
                            <div
                              key={index}
                              onClick={() => {
                                // Set the selected date
                                setSelectedDate(date);
                                
                                // Navigate to the week containing this date
                                const clickedDate = new Date(date);
                                const day = clickedDate.getDay();
                                const diff = clickedDate.getDate() - day;
                                const monday = new Date(clickedDate.setDate(diff));
                                setWeekStart(monday);
                                
                                // Switch to week view
                                setCalendarViewMode('week');
                              }}
                              style={{
                                padding: '6px 2px',
                                borderRadius: '6px',
                                cursor: 'pointer',
                                background: isSelected ? 'rgba(139, 92, 246, 0.3)' : 
                                           isToday ? 'rgba(59, 130, 246, 0.1)' : 
                                           'rgba(30, 41, 59, 0.3)',
                                border: isSelected ? '2px solid rgba(139, 92, 246, 0.8)' :
                                       isToday ? '1px solid rgba(59, 130, 246, 0.4)' :
                                       '1px solid transparent',
                                transition: 'all 0.2s',
                                position: 'relative',
                                minHeight: '35px'
                              }}
                              onMouseEnter={(e) => {
                                if (!isSelected) {
                                  e.currentTarget.style.background = 'rgba(139, 92, 246, 0.15)';
                                }
                              }}
                              onMouseLeave={(e) => {
                                if (!isSelected) {
                                  e.currentTarget.style.background = isToday ? 'rgba(59, 130, 246, 0.1)' : 'rgba(30, 41, 59, 0.3)';
                                }
                              }}
                              title={`${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}${routesForDay.length > 0 ? ` - ${routesForDay.length} route(s)` : ''}`}
                            >
                              <div style={{ fontSize: '11px', fontWeight: 600, color: isSelected ? '#a78bfa' : isToday ? '#60a5fa' : '#f1f5f9', textAlign: 'center', position: 'relative' }}>
                                {date.getDate()}
                                {unsavedRouteDays[date.toDateString()] && (
                                  <span style={{
                                    position: 'absolute',
                                    top: '-3px',
                                    left: '2px',
                                    width: '6px',
                                    height: '6px',
                                    borderRadius: '50%',
                                    background: '#f59e0b',
                                    boxShadow: '0 0 4px rgba(245, 158, 11, 0.6)'
                                  }} title="Unsaved route" />
                                )}
                                {hasSavedRoute && (
                                  <span style={{
                                    position: 'absolute',
                                    top: '-4px',
                                    right: '2px',
                                    fontSize: '10px',
                                    color: '#22c55e'
                                  }}>âœ“</span>
                                )}
                              </div>
                              {routesForDay.length > 0 && (
                                <div style={{
                                  fontSize: '8px',
                                  color: '#22c55e',
                                  textAlign: 'center',
                                  marginTop: '2px'
                                }}>
                                  {routesForDay.length}
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    )}
                    
                    {/* Selected Date Info */}
                    <div style={{ marginTop: '6px', padding: '6px 8px', background: 'rgba(139, 92, 246, 0.05)', borderRadius: '6px' }}>
                      <div style={{ fontSize: '9px', color: '#94a3b8', marginBottom: '2px' }}>
                        Route Date:
                      </div>
                      <div style={{ fontSize: '11px', fontWeight: 600, color: '#f1f5f9' }}>
                        {selectedDate.toLocaleDateString('en-US', { 
                          weekday: 'long',
                          month: 'short', 
                          day: 'numeric',
                          year: 'numeric'
                        })}
                      </div>
                      {getRoutesForDate(selectedDate).length > 0 && (
                        <div style={{ fontSize: '9px', color: '#22c55e', marginTop: '4px', fontWeight: 600 }}>
                          {getRoutesForDate(selectedDate).length} route{getRoutesForDate(selectedDate).length > 1 ? 's' : ''} scheduled
                        </div>
                      )}
                    </div>
                  </div>
                )}
                
                {/* Calendar Toggle Button (when hidden) - not shown in Route Planner */}
                {!showCalendar && statusFilter !== 'scheduled' && (
                  <div style={{ padding: '8px 12px', borderBottom: '1px solid rgba(139, 92, 246, 0.1)' }}>
                    <button
                      onClick={() => setShowCalendar(true)}
                      className="button-secondary"
                      style={{
                        width: '100%',
                        justifyContent: 'center',
                        padding: '6px',
                        fontSize: '11px'
                      }}
                    >
                      ðŸ“… Show Calendar
                    </button>
                  </div>
                )}

                {/* Content Area */}
                <div className="scrollbar-custom" style={{ flex: 1, overflow: 'auto', padding: '12px' }}>

                  {/* Route Planner: show selected day stats + week stats when not in edit mode */}
                  {statusFilter === 'scheduled' && !routePlannerEditMode && (
                    <div>
                      {/* Selected Day's Route Stats */}
                      {(() => {
                        const displayDate = focusedDays.length > 0 ? focusedDays[0] : (() => { const t = new Date(); t.setHours(0,0,0,0); return t; })();
                        const displayStr = displayDate.toDateString();
                        const isToday = displayStr === new Date().toDateString();
                        const dayRoutes = savedRoutes.filter(r => new Date(r.scheduledDate).toDateString() === displayStr);
                        const dayStops = dayRoutes.flatMap(r => r.customers || []);
                        const dayRevenue = dayStops.reduce((sum, c) => {
                          const custMatch = customers.find(cu => cu.id === c.id);
                          return sum + (parseFloat(c.jobPrice) || parseFloat(custMatch?.jobPrice) || parseFloat(c.amountPaid) || parseFloat(custMatch?.amountPaid) || parseFloat(c.price) || 0);
                        }, 0);
                        const calcRouteDistance = (routeObj) => {
                          if (!homeBase || !routeObj.customers || routeObj.customers.length === 0) return parseFloat(routeObj.totalDistance) || 0;
                          const stops = routeObj.customers.filter(c => c.lat && c.lng);
                          if (stops.length === 0) return 0;
                          let dist = calculateDistance(homeBase.lat, homeBase.lng, stops[0].lat, stops[0].lng);
                          for (let i = 0; i < stops.length - 1; i++) {
                            dist += calculateDistance(stops[i].lat, stops[i].lng, stops[i+1].lat, stops[i+1].lng);
                          }
                          dist += calculateDistance(stops[stops.length - 1].lat, stops[stops.length - 1].lng, homeBase.lat, homeBase.lng);
                          return dist;
                        };
                        const dayMiles = dayRoutes.reduce((sum, r) => sum + calcRouteDistance(r), 0);
                        return (
                          <div style={{ padding: '12px', borderBottom: '1px solid rgba(234, 179, 8, 0.2)' }}>
                            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '10px' }}>
                              <h3 style={{ fontSize: '13px', fontWeight: 700, margin: 0, color: '#fbbf24' }}>
                                {isToday ? "Today's Route" : displayDate.toLocaleDateString('en-US', { weekday: 'long' }) + "'s Route"}
                                {dayRoutes.some(r => r.sentToTech) && <span style={{ color: '#22c55e', fontSize: '11px', marginLeft: '6px' }}>âœ“ Sent</span>}
                              </h3>
                              <span style={{ fontSize: '10px', color: '#94a3b8' }}>{displayDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</span>
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '8px' }}>
                              <div style={{ padding: '10px', background: 'rgba(234, 179, 8, 0.08)', borderRadius: '10px', textAlign: 'center', border: '1px solid rgba(234, 179, 8, 0.15)' }}>
                                <div style={{ fontSize: '20px', fontWeight: 800, color: '#fbbf24' }}>{dayStops.length}</div>
                                <div style={{ fontSize: '9px', color: '#94a3b8', fontWeight: 600, textTransform: 'uppercase' }}>Stops</div>
                              </div>
                              <div style={{ padding: '10px', background: 'rgba(34, 197, 94, 0.08)', borderRadius: '10px', textAlign: 'center', border: '1px solid rgba(34, 197, 94, 0.15)' }}>
                                <div style={{ fontSize: '20px', fontWeight: 800, color: '#22c55e' }}>{dayMiles.toFixed(1)}</div>
                                <div style={{ fontSize: '9px', color: '#94a3b8', fontWeight: 600, textTransform: 'uppercase' }}>Miles</div>
                              </div>
                              <div style={{ padding: '10px', background: 'rgba(139, 92, 246, 0.08)', borderRadius: '10px', textAlign: 'center', border: '1px solid rgba(139, 92, 246, 0.15)' }}>
                                <div style={{ fontSize: '20px', fontWeight: 800, color: '#a78bfa' }}>${dayRevenue.toFixed(0)}</div>
                                <div style={{ fontSize: '9px', color: '#94a3b8', fontWeight: 600, textTransform: 'uppercase' }}>Revenue</div>
                              </div>
                            </div>
                            {dayStops.length > 0 && (
                              <div style={{ marginTop: '8px' }}>
                                {dayStops.sort((a, b) => (a.scheduledTime || '').localeCompare(b.scheduledTime || '')).map((stop, idx) => (
                                  <div key={stop.id || idx} style={{
                                    display: 'flex', alignItems: 'center', gap: '8px', padding: '5px 8px',
                                    borderRadius: '6px', marginBottom: '2px',
                                    background: 'rgba(234, 179, 8, 0.04)', cursor: 'pointer'
                                  }}
                                    onClick={() => { setProfileCustomer(customers.find(c => c.id === stop.id) || stop); setShowCustomerProfile(true); }}
                                  >
                                    <div style={{
                                      width: '18px', height: '18px', borderRadius: '5px', flexShrink: 0,
                                      background: 'linear-gradient(135deg, #eab308, #ca8a04)',
                                      display: 'flex', alignItems: 'center', justifyContent: 'center',
                                      fontSize: '9px', fontWeight: 700, color: '#000'
                                    }}>{idx + 1}</div>
                                    <div style={{ flex: 1, minWidth: 0 }}>
                                      <div style={{ fontSize: '11px', fontWeight: 600, color: '#f1f5f9', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{stop.name}</div>
                                    </div>
                                    {stop.jobPrice > 0 && (
                                      <span style={{ fontSize: '9px', color: '#22c55e', fontWeight: 700, flexShrink: 0 }}>
                                        ${stop.jobPrice}
                                      </span>
                                    )}
                                    {stop.scheduledTime && (
                                      <span style={{ fontSize: '9px', color: '#fbbf24', fontWeight: 600, flexShrink: 0 }}>
                                        {new Date(`2000-01-01T${stop.scheduledTime}`).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}
                                      </span>
                                    )}
                                  </div>
                                ))}
                              </div>
                            )}
                            {dayRoutes.length > 0 && (() => {
                              const editableRoutes = dayRoutes.filter(r => !r.sentToTech);
                              const hasSentRoutes = dayRoutes.some(r => r.sentToTech);
                              return (
                                <div>
                                  {hasSentRoutes && (
                                    <div style={{
                                      marginTop: '8px', padding: '6px 10px', fontSize: '10px', color: '#86efac',
                                      background: 'rgba(34, 197, 94, 0.1)', border: '1px solid rgba(34, 197, 94, 0.2)',
                                      borderRadius: '6px', textAlign: 'center'
                                    }}>âœ“ Sent to technician</div>
                                  )}
                                  {editableRoutes.length > 0 && (
                                    <button
                                      onClick={() => {
                                        setFocusedDays([displayDate]);
                                        setSelectedDate(displayDate);
                                        setRoutePlannerEditMode(true);
                                        const dayRoute = editableRoutes[0];
                                        if (dayRoute) {
                                          setEditingSavedRouteId(dayRoute.id);
                                          const dateKey = displayDate.toDateString();
                                          setRoutesByDay(prev => ({ ...prev, [dateKey]: dayRoute.customers }));
                                          setCustomers(prev => {
                                            const routeCustomerMap = new Map();
                                            dayRoute.customers.forEach(rc => routeCustomerMap.set(rc.id, rc));
                                            return prev.map(c => {
                                              const rc = routeCustomerMap.get(c.id);
                                              if (rc) return { ...c, scheduledTime: rc.scheduledTime || c.scheduledTime, scheduledDate: dayRoute.scheduledDate || c.scheduledDate, status: 'scheduled', routeConfirmed: true };
                                              return c;
                                            });
                                          });
                                          setSavedViewDays(prev => ({ ...prev, [dateKey]: false }));
                                        }
                                      }}
                                      style={{
                                        width: '100%', marginTop: '8px', padding: '7px', fontSize: '11px', fontWeight: 600,
                                        background: 'rgba(234, 179, 8, 0.1)', border: '1px solid rgba(234, 179, 8, 0.3)',
                                        borderRadius: '8px', color: '#fbbf24', cursor: 'pointer', textAlign: 'center'
                                      }}
                                    >
                                      âœï¸ Edit {isToday ? "Today's" : displayDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })} Route
                                    </button>
                                  )}
                                </div>
                              );
                            })()}
                          </div>
                        );
                      })()}

                      {/* Current Week Stats */}
                      {(() => {
                        const weekDays = getWeekDays(scheduledViewWeekStart);
                        const weekLabel = (() => {
                          const now = new Date(); now.setHours(0,0,0,0);
                          const thisWeekStart = new Date(now); thisWeekStart.setDate(thisWeekStart.getDate() - thisWeekStart.getDay());
                          return scheduledViewWeekStart.toDateString() === thisWeekStart.toDateString() ? 'This Week' :
                            weekDays[0].toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' - ' + weekDays[6].toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        })();
                        const calcRouteDistance = (routeObj) => {
                          if (!homeBase || !routeObj.customers || routeObj.customers.length === 0) return parseFloat(routeObj.totalDistance) || 0;
                          const stops = routeObj.customers.filter(c => c.lat && c.lng);
                          if (stops.length === 0) return 0;
                          let dist = calculateDistance(homeBase.lat, homeBase.lng, stops[0].lat, stops[0].lng);
                          for (let i = 0; i < stops.length - 1; i++) {
                            dist += calculateDistance(stops[i].lat, stops[i].lng, stops[i+1].lat, stops[i+1].lng);
                          }
                          dist += calculateDistance(stops[stops.length - 1].lat, stops[stops.length - 1].lng, homeBase.lat, homeBase.lng);
                          return dist;
                        };
                        const weekStops = weekDays.reduce((total, date) => {
                          const dayRoutes = savedRoutes.filter(r => new Date(r.scheduledDate).toDateString() === date.toDateString());
                          return total + dayRoutes.reduce((sum, r) => sum + (r.customers || []).length, 0);
                        }, 0);
                        const weekRevenue = weekDays.reduce((total, date) => {
                          const dayRoutes = savedRoutes.filter(r => new Date(r.scheduledDate).toDateString() === date.toDateString());
                          return total + dayRoutes.flatMap(r => r.customers || []).reduce((sum, c) => {
                            const custMatch = customers.find(cu => cu.id === c.id);
                            return sum + (parseFloat(c.jobPrice) || parseFloat(custMatch?.jobPrice) || parseFloat(c.amountPaid) || parseFloat(custMatch?.amountPaid) || parseFloat(c.price) || 0);
                          }, 0);
                        }, 0);
                        const weekMiles = weekDays.reduce((total, date) => {
                          const dayRoutes = savedRoutes.filter(r => new Date(r.scheduledDate).toDateString() === date.toDateString());
                          return total + dayRoutes.reduce((sum, r) => sum + calcRouteDistance(r), 0);
                        }, 0);
                        const daysWithRoutes = weekDays.filter(date => {
                          return savedRoutes.some(r => new Date(r.scheduledDate).toDateString() === date.toDateString());
                        }).length;
                        return (
                          <div style={{ padding: '12px', borderBottom: '1px solid rgba(234, 179, 8, 0.15)' }}>
                            <h4 style={{ fontSize: '11px', fontWeight: 700, margin: '0 0 8px 0', color: '#94a3b8', textTransform: 'uppercase', letterSpacing: '0.5px' }}>{weekLabel}</h4>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '6px' }}>
                              <div style={{ padding: '8px', background: 'rgba(30, 41, 59, 0.5)', borderRadius: '8px' }}>
                                <div style={{ fontSize: '16px', fontWeight: 700, color: '#e2e8f0' }}>{weekStops}</div>
                                <div style={{ fontSize: '9px', color: '#64748b', fontWeight: 600 }}>Total Stops</div>
                              </div>
                              <div style={{ padding: '8px', background: 'rgba(30, 41, 59, 0.5)', borderRadius: '8px' }}>
                                <div style={{ fontSize: '16px', fontWeight: 700, color: '#e2e8f0' }}>{daysWithRoutes}/7</div>
                                <div style={{ fontSize: '9px', color: '#64748b', fontWeight: 600 }}>Days Booked</div>
                              </div>
                              <div style={{ padding: '8px', background: 'rgba(30, 41, 59, 0.5)', borderRadius: '8px' }}>
                                <div style={{ fontSize: '16px', fontWeight: 700, color: '#22c55e' }}>{weekMiles.toFixed(1)} mi</div>
                                <div style={{ fontSize: '9px', color: '#64748b', fontWeight: 600 }}>Total Miles</div>
                              </div>
                              <div style={{ padding: '8px', background: 'rgba(30, 41, 59, 0.5)', borderRadius: '8px' }}>
                                <div style={{ fontSize: '16px', fontWeight: 700, color: '#a78bfa' }}>${weekRevenue.toFixed(0)}</div>
                                <div style={{ fontSize: '9px', color: '#64748b', fontWeight: 600 }}>Revenue</div>
                              </div>
                            </div>
                          </div>
                        );
                      })()}

                    </div>
                  )}

                  {/* All View - Read-only route summary with Edit in Route Planner button */}
                  {statusFilter !== 'scheduled' && (() => {
                    const dateKey = selectedDate.toDateString();
                    const dayRoutes = savedRoutes.filter(r => new Date(r.scheduledDate).toDateString() === dateKey);
                    if (dayRoutes.length === 0) return null;
                    return (
                      <div style={{ marginBottom: '12px', padding: '12px', background: 'rgba(30, 41, 59, 0.6)', border: '1px solid rgba(148, 163, 184, 0.15)', borderRadius: '10px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                          <span style={{ fontSize: '12px', fontWeight: 700, color: '#e2e8f0' }}>
                            ðŸ“… {selectedDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
                          </span>
                          <span style={{ fontSize: '10px', color: '#94a3b8' }}>{dayRoutes.reduce((s, r) => s + (r.customers || []).length, 0)} stops</span>
                        </div>
                        {dayRoutes.map((r, ri) => (
                          <div key={ri} style={{ marginBottom: '6px' }}>
                            <div style={{ fontSize: '11px', color: '#a78bfa', fontWeight: 600, marginBottom: '4px' }}>{r.name}</div>
                            {(r.customers || []).slice(0, 5).map((c, ci) => (
                              <div key={ci} style={{ fontSize: '10px', color: '#94a3b8', padding: '2px 0', display: 'flex', gap: '6px' }}>
                                <span style={{ color: '#64748b' }}>{ci + 1}.</span>
                                <span>{c.name}</span>
                                {c.scheduledTime && <span style={{ color: '#fbbf24', marginLeft: 'auto' }}>{new Date(`2000-01-01T${c.scheduledTime}`).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}</span>}
                              </div>
                            ))}
                            {(r.customers || []).length > 5 && <div style={{ fontSize: '9px', color: '#64748b', marginTop: '2px' }}>+{r.customers.length - 5} more</div>}
                          </div>
                        ))}
                        {(() => {
                          const editableRoutes = dayRoutes.filter(r => !r.sentToTech);
                          const hasSentRoutes = dayRoutes.some(r => r.sentToTech);
                          return (
                            <div>
                              {hasSentRoutes && (
                                <div style={{
                                  marginTop: '6px', padding: '6px 10px', fontSize: '10px', color: '#86efac',
                                  background: 'rgba(34, 197, 94, 0.1)', border: '1px solid rgba(34, 197, 94, 0.2)',
                                  borderRadius: '6px', textAlign: 'center'
                                }}>âœ“ Sent to technician</div>
                              )}
                              {editableRoutes.length > 0 && (
                                <button
                                  onClick={() => {
                                    setStatusFilter('scheduled');
                                    setShowNeedScheduling(true);
                                    setFocusedDays([selectedDate]);
                                    const dayRoute = editableRoutes[0];
                                    if (dayRoute) {
                                      setEditingSavedRouteId(dayRoute.id);
                                      setRoutesByDay(prev => ({ ...prev, [dateKey]: dayRoute.customers }));
                                      setRoutePlannerEditMode(true);
                                    }
                                  }}
                                  style={{
                                    width: '100%', marginTop: '8px', padding: '8px', fontSize: '11px', fontWeight: 600,
                                    background: 'rgba(234, 179, 8, 0.1)', border: '1px solid rgba(234, 179, 8, 0.3)',
                                    borderRadius: '8px', color: '#fbbf24', cursor: 'pointer', textAlign: 'center'
                                  }}
                                >
                                  âœï¸ Edit in Route Planner
                                </button>
                              )}
                            </div>
                          );
                        })()}
                      </div>
                    );
                  })()}

                  {/* Day Schedule View - only show in edit mode for Route Planner */}
                  {statusFilter === 'scheduled' && routePlannerEditMode && (
                  <div style={{ marginBottom: '12px' }}>
                    {/* Tip at top */}
                    {customers.length > 0 && showTip && (
                      <div style={{
                        marginBottom: '12px',
                        padding: '12px',
                        background: 'rgba(139, 92, 246, 0.1)',
                        border: '1px solid rgba(139, 92, 246, 0.2)',
                        borderRadius: '8px',
                        fontSize: '11px',
                        color: '#c4b5fd',
                        lineHeight: '1.6',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'space-between',
                        gap: '12px'
                      }}>
                        <span>
                          <strong>ðŸ’¡ Tip:</strong> Click customers on map to build route. Drag stops to reorder!
                        </span>
                        <button
                          onClick={() => setShowTip(false)}
                          style={{
                            background: 'transparent',
                            border: 'none',
                            color: '#94a3b8',
                            cursor: 'pointer',
                            fontSize: '16px',
                            padding: '0 4px',
                            flexShrink: 0
                          }}
                          title="Dismiss tip"
                        >
                          âœ•
                        </button>
                      </div>
                    )}
                    
                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '8px' }}>
                      <h3 style={{
                        fontSize: '12px',
                        fontWeight: 700,
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px',
                        color: '#8b5cf6'
                      }}>
                        ðŸ“… {selectedDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
                      </h3>
                      <div style={{ fontSize: '9px', color: '#94a3b8' }}>
                        {(() => {
                          const jobsForDay = customers.filter(c => {
                            if (!c.scheduledDate) return false;
                            const custDate = new Date(c.scheduledDate);
                            return custDate.toDateString() === selectedDate.toDateString();
                          });
                          return `${jobsForDay.length} job${jobsForDay.length !== 1 ? 's' : ''}`;
                        })()}
                      </div>
                    </div>
                    
                    {(() => {
                      const dateKey = selectedDate.toDateString();
                      const inSavedView = savedViewDays[dateKey] === true;

                      // Find ALL saved routes for this day (multiple technicians)
                      const savedRoutesForDay = savedRoutes.filter(r => {
                        const rDate = new Date(r.scheduledDate);
                        return rDate.toDateString() === dateKey;
                      });

                      // Get the currently selected route index for this day (default to 0)
                      const selectedIdx = selectedRouteIndexByDay[dateKey] || 0;
                      const savedRouteForDay = savedRoutesForDay[selectedIdx] || savedRoutesForDay[0];

                      // Get jobs from saved route OR from customers state (fallback)
                      let jobsForDay = [];
                      if (inSavedView && savedRouteForDay && savedRouteForDay.customers) {
                        // Use customers from saved route (source of truth for saved view)
                        jobsForDay = [...savedRouteForDay.customers].sort((a, b) => {
                          if (!a.scheduledTime || !b.scheduledTime) return 0;
                          const [aHour, aMin] = a.scheduledTime.split(':').map(Number);
                          const [bHour, bMin] = b.scheduledTime.split(':').map(Number);
                          return (aHour * 60 + aMin) - (bHour * 60 + bMin);
                        });
                      } else {
                        // Use customers state (for edit view)
                        jobsForDay = customers
                          .filter(c => {
                            if (!c.scheduledDate) return false;
                            const custDate = new Date(c.scheduledDate);
                            return custDate.toDateString() === dateKey;
                          })
                          .sort((a, b) => {
                            if (!a.scheduledTime || !b.scheduledTime) return 0;
                            const [aHour, aMin] = a.scheduledTime.split(':').map(Number);
                            const [bHour, bMin] = b.scheduledTime.split(':').map(Number);
                            return (aHour * 60 + aMin) - (bHour * 60 + bMin);
                          });
                      }

                      // SAVED VIEW - Show compact list (only if in saved mode and has routes)
                      if (inSavedView && savedRoutesForDay.length > 0) {
                        return (
                          <div>
                            {/* Route Tabs - only show if multiple routes for this day */}
                            {savedRoutesForDay.length > 1 && (
                              <div style={{
                                display: 'flex',
                                gap: '4px',
                                marginBottom: '12px',
                                background: 'rgba(15, 23, 42, 0.5)',
                                padding: '4px',
                                borderRadius: '8px'
                              }}>
                                {savedRoutesForDay.map((route, idx) => (
                                  <button
                                    key={route.id}
                                    onClick={() => setSelectedRouteIndexByDay(prev => ({ ...prev, [dateKey]: idx }))}
                                    style={{
                                      flex: 1,
                                      padding: '8px 12px',
                                      fontSize: '11px',
                                      fontWeight: 600,
                                      background: idx === selectedIdx ? 'rgba(139, 92, 246, 0.3)' : 'transparent',
                                      border: idx === selectedIdx ? '1px solid rgba(139, 92, 246, 0.5)' : '1px solid transparent',
                                      borderRadius: '6px',
                                      color: idx === selectedIdx ? '#a78bfa' : '#94a3b8',
                                      cursor: 'pointer',
                                      transition: 'all 0.2s',
                                      whiteSpace: 'nowrap',
                                      overflow: 'hidden',
                                      textOverflow: 'ellipsis'
                                    }}
                                  >
                                    {route.name || `Route ${idx + 1}`}
                                  </button>
                                ))}
                              </div>
                            )}

                            <div style={{ display: 'flex', gap: '6px', marginBottom: '12px' }}>
                              {savedRouteForDay && !savedRouteForDay.sentToTech && (
                                <button
                                  onClick={() => {
                                    if (savedRouteForDay) {
                                      setRoutesByDay(prev => ({
                                        ...prev,
                                        [dateKey]: savedRouteForDay.customers
                                      }));
                                      setEditingSavedRouteId(savedRouteForDay.id);
                                      setRoutePlannerEditMode(true);

                                      setCustomers(prev => {
                                        const routeCustomerMap = new Map();
                                        savedRouteForDay.customers.forEach(rc => {
                                          routeCustomerMap.set(rc.id, rc);
                                        });
                                        return prev.map(c => {
                                          const rc = routeCustomerMap.get(c.id);
                                          if (rc) {
                                            return {
                                              ...c,
                                              scheduledTime: rc.scheduledTime || c.scheduledTime,
                                              scheduledDate: savedRouteForDay.scheduledDate || rc.scheduledDate || c.scheduledDate,
                                              status: 'scheduled',
                                              routeConfirmed: true
                                            };
                                          }
                                          return c;
                                        });
                                      });
                                    }
                                    setSavedViewDays(prev => ({ ...prev, [dateKey]: false }));
                                  }}
                                  className="button-secondary"
                                  style={{
                                    flex: 1,
                                    padding: '8px 10px',
                                    fontSize: '11px',
                                    justifyContent: 'center'
                                  }}
                                >
                                  âœï¸ Edit Route
                                </button>
                              )}
                              <button
                                onClick={() => {
                                  setRoutesByDay(prev => ({
                                    ...prev,
                                    [dateKey]: []
                                  }));
                                  setEditingSavedRouteId(null);
                                  setSuggestedCustomers([]);
                                  setSavedViewDays(prev => ({ ...prev, [dateKey]: false }));
                                }}
                                className="button-primary"
                                style={{
                                  flex: 1,
                                  padding: '8px 10px',
                                  fontSize: '11px',
                                  justifyContent: 'center'
                                }}
                              >
                                + New Route
                              </button>
                            </div>
                            {savedRouteForDay && savedRouteForDay.sentToTech && (
                              <div style={{
                                padding: '8px 12px',
                                marginBottom: '12px',
                                background: 'rgba(34, 197, 94, 0.1)',
                                border: '1px solid rgba(34, 197, 94, 0.3)',
                                borderRadius: '8px',
                                fontSize: '11px',
                                color: '#86efac'
                              }}>
                                âœ“ This route has been sent to the technician. To add more jobs for this day, use "+ New Route" above.
                              </div>
                            )}
                            
                            <div style={{ 
                              padding: '12px',
                              background: 'rgba(139, 92, 246, 0.1)',
                              border: '1px solid rgba(139, 92, 246, 0.3)',
                              borderRadius: '8px'
                            }}>
                              <h4 style={{ 
                                fontSize: '11px', 
                                fontWeight: 700, 
                                color: '#8b5cf6', 
                                marginBottom: '10px',
                                textTransform: 'uppercase',
                                letterSpacing: '0.5px'
                              }}>
                                ðŸ“‹ Scheduled Jobs ({jobsForDay.length})
                              </h4>
                              <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                                {jobsForDay.map((job, idx) => (
                                  <div key={job.id}
                                    onClick={() => {
                                      const fullCustomer = customers.find(c => c.id === job.id) || job;
                                      setProfileCustomer(fullCustomer);
                                      setShowCustomerProfile(true);
                                    }}
                                    style={{
                                      display: 'flex',
                                      alignItems: 'center',
                                      gap: '10px',
                                      padding: '8px',
                                      background: 'rgba(15, 23, 42, 0.6)',
                                      borderRadius: '6px',
                                      border: '1px solid rgba(139, 92, 246, 0.2)',
                                      cursor: 'pointer',
                                      transition: 'all 0.15s'
                                    }}
                                    onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(139, 92, 246, 0.15)'}
                                    onMouseLeave={(e) => e.currentTarget.style.background = 'rgba(15, 23, 42, 0.6)'}
                                  >
                                    <div style={{
                                      fontSize: '11px',
                                      fontWeight: 700,
                                      color: '#8b5cf6',
                                      minWidth: '25px'
                                    }}>
                                      #{idx + 1}
                                    </div>
                                    <div style={{
                                      fontSize: '11px',
                                      fontWeight: 600,
                                      color: '#22c55e',
                                      minWidth: '65px'
                                    }}>
                                      {job.scheduledTime ?
                                        new Date(`2000-01-01T${job.scheduledTime}`).toLocaleTimeString('en-US', {
                                          hour: 'numeric',
                                          minute: '2-digit',
                                          hour12: true
                                        }) : 'N/A'}
                                    </div>
                                    <div style={{ flex: 1, overflow: 'hidden' }}>
                                      <div style={{
                                        fontSize: '12px',
                                        fontWeight: 600,
                                        color: '#f1f5f9',
                                        overflow: 'hidden',
                                        textOverflow: 'ellipsis',
                                        whiteSpace: 'nowrap'
                                      }}>
                                        {job.name}
                                      </div>
                                      <div style={{
                                        fontSize: '10px',
                                        color: '#64748b',
                                        overflow: 'hidden',
                                        textOverflow: 'ellipsis',
                                        whiteSpace: 'nowrap'
                                      }}>
                                        {job.address}
                                      </div>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          </div>
                        );
                      }
                      
                      // EDIT VIEW - Show action buttons (if jobs exist) and timeslots
                      return (
                        <div>
                          {/* Action Buttons */}
                          {jobsForDay.length > 0 ? (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '6px', marginBottom: '8px' }}>
                              <div style={{ display: 'flex', gap: '6px' }}>
                              <button
                                onClick={() => {
                                  if (editingSavedRouteId) {
                                    const existingRoute = savedRoutes.find(r => r.id === editingSavedRouteId);
                                    if (existingRoute) setRouteName(existingRoute.name);
                                  }
                                  setShowSaveModal(true);
                                }}
                                className="button-primary"
                                style={{
                                  padding: '6px 10px',
                                  fontSize: '10px',
                                  flex: 1,
                                  justifyContent: 'center'
                                }}
                              >
                                ðŸ’¾ Save This Day
                              </button>
                              <button
                                onClick={() => {
                                  if (editingSavedRouteId) {
                                    const savedRoute = savedRoutes.find(r => r.id === editingSavedRouteId);
                                    if (savedRoute) {
                                      const savedCustomerIds = new Set(savedRoute.customers.map(c => c.id));
                                      setCustomers(prev => prev.map(c => {
                                        if (!c.scheduledDate) return c;
                                        const custDate = new Date(c.scheduledDate);
                                        if (custDate.toDateString() === dateKey && !savedCustomerIds.has(c.id)) {
                                          return {
                                            ...c,
                                            scheduledDate: null,
                                            scheduledTime: null,
                                            status: getStatusAfterUnschedule(c),
                                            routeConfirmed: false
                                          };
                                        }
                                        if (savedCustomerIds.has(c.id)) {
                                          const rc = savedRoute.customers.find(sc => sc.id === c.id);
                                          return {
                                            ...c,
                                            scheduledTime: rc.scheduledTime || c.scheduledTime,
                                            scheduledDate: savedRoute.scheduledDate,
                                            status: 'scheduled',
                                            routeConfirmed: true
                                          };
                                        }
                                        return c;
                                      }));
                                      setRoutesByDay(prev => ({
                                        ...prev,
                                        [dateKey]: [...savedRoute.customers]
                                      }));
                                      setSavedViewDays(prev => ({ ...prev, [dateKey]: true }));
                                      setEditingSavedRouteId(null);
                                    }
                                  } else {
                                    const affectedIds = customers.filter(c => {
                                      if (!c.scheduledDate) return false;
                                      return new Date(c.scheduledDate).toDateString() === dateKey;
                                    }).map(c => c.id);

                                    setCustomers(prev => prev.map(c => {
                                      if (!c.scheduledDate) return c;
                                      const custDate = new Date(c.scheduledDate);
                                      if (custDate.toDateString() === dateKey) {
                                        return {
                                          ...c,
                                          scheduledDate: null,
                                          scheduledTime: null,
                                          status: getStatusAfterUnschedule(c),
                                          routeConfirmed: false
                                        };
                                      }
                                      return c;
                                    }));

                                    affectedIds.forEach(cid => {
                                      const affectedCustomer = customers.find(c => c.id === cid);
                                      propagateCustomerUpdate(cid, { scheduledDate: null, scheduledTime: null, status: getStatusAfterUnschedule(affectedCustomer), routeConfirmed: false });
                                    });
                                    setRoutesByDay(prev => ({
                                      ...prev,
                                      [dateKey]: []
                                    }));
                                  }
                                  setRoute([]);
                                  setSuggestedCustomers([]);
                                  setUnsavedRouteDays(prev => {
                                    const next = { ...prev };
                                    delete next[dateKey];
                                    if (Object.keys(next).length === 0) setUnsavedRouteChanges(false);
                                    return next;
                                  });
                                  setRoutePlannerEditMode(false);
                                }}
                                style={{
                                background: 'rgba(239, 68, 68, 0.1)',
                                border: '1px solid rgba(239, 68, 68, 0.2)',
                                borderRadius: '6px',
                                padding: '6px 10px',
                                color: '#fca5a5',
                                cursor: 'pointer',
                                fontSize: '10px',
                                fontWeight: 600,
                                flex: 1,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '4px'
                              }}
                            >
                              {editingSavedRouteId ? 'â†©ï¸ Cancel' : 'ðŸ—‘ï¸ Clear Day'}
                            </button>
                              </div>
                              {/* Save All Routes button - show when multiple days have unsaved changes */}
                              {Object.keys(unsavedRouteDays).filter(k => unsavedRouteDays[k]).length > 1 && (
                                <button
                                  onClick={handleSaveAllRoutes}
                                  style={{
                                    padding: '8px 10px',
                                    fontSize: '11px',
                                    fontWeight: 700,
                                    background: 'linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(59, 130, 246, 0.2))',
                                    border: '1px solid rgba(16, 185, 129, 0.4)',
                                    borderRadius: '6px',
                                    color: '#6ee7b7',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    gap: '6px',
                                    width: '100%'
                                  }}
                                >
                                  ðŸ’¾ Save All Routes ({Object.keys(unsavedRouteDays).filter(k => unsavedRouteDays[k]).length} days)
                                </button>
                              )}
                              {/* Unsaved days indicator */}
                              {Object.keys(unsavedRouteDays).filter(k => unsavedRouteDays[k] && k !== dateKey).length > 0 && (
                                <div style={{
                                  padding: '6px 10px',
                                  background: 'rgba(245, 158, 11, 0.1)',
                                  border: '1px solid rgba(245, 158, 11, 0.2)',
                                  borderRadius: '6px',
                                  fontSize: '10px',
                                  color: '#fbbf24',
                                  textAlign: 'center'
                                }}>
                                  {Object.keys(unsavedRouteDays).filter(k => unsavedRouteDays[k] && k !== dateKey).length} other day{Object.keys(unsavedRouteDays).filter(k => unsavedRouteDays[k] && k !== dateKey).length > 1 ? 's' : ''} with unsaved routes
                                </div>
                              )}
                          </div>
                          ) : editingSavedRouteId ? (
                            <div style={{ marginBottom: '8px' }}>
                              <div style={{ padding: '12px', background: 'rgba(239,68,68,0.08)', borderRadius: '8px', border: '1px solid rgba(239,68,68,0.2)', marginBottom: '8px', textAlign: 'center' }}>
                                <div style={{ fontSize: '13px', fontWeight: 600, color: '#fca5a5', marginBottom: '4px' }}>All stops removed</div>
                                <div style={{ fontSize: '11px', color: '#94a3b8' }}>Delete this route or cancel to restore it</div>
                              </div>
                              <div style={{ display: 'flex', gap: '6px' }}>
                                <button
                                  onClick={async () => {
                                    if (window.confirm('Delete this route? All jobs will be set back to unscheduled.')) {
                                      const savedRoute = savedRoutes.find(r => r.id === editingSavedRouteId);
                                      if (savedRoute) {
                                        for (const rc of savedRoute.customers) {
                                          try {
                                            await apiFetch(`/customers/${rc.id}`, { method: 'PATCH', body: JSON.stringify({ status: 'unscheduled', scheduled_date: null }) });
                                            const custJobsData = await apiFetch(`/jobs?customer_id=${rc.id}`);
                                            const activeJobs = (custJobsData.jobs || []).filter(j => j.status !== 'completed' && j.status !== 'cancelled');
                                            for (const j of activeJobs) {
                                              if (j.scheduled_date) {
                                                await apiFetch(`/jobs/${j.id}`, { method: 'PATCH', body: JSON.stringify({ scheduled_date: '', status: 'unscheduled' }) });
                                              }
                                            }
                                          } catch (err) { console.error('Failed to clear job:', err); }
                                          propagateCustomerUpdate(rc.id, { scheduledDate: null, scheduledTime: null, status: 'unscheduled', routeConfirmed: false, confirmedRouteName: null });
                                        }
                                        setCustomers(prev => prev.map(c => {
                                          const inRoute = savedRoute.customers.some(rc => rc.id === c.id);
                                          return inRoute ? { ...c, scheduledDate: null, scheduledTime: null, status: 'unscheduled', routeConfirmed: false, confirmedRouteName: null } : c;
                                        }));
                                        const routeDateKey = new Date(savedRoute.scheduledDate).toDateString();
                                        setRoutesByDay(prev => ({ ...prev, [routeDateKey]: [] }));
                                        setSavedViewDays(prev => ({ ...prev, [routeDateKey]: false }));
                                        setSavedRoutes(prev => prev.filter(r => r.id !== editingSavedRouteId));
                                      }
                                      setEditingSavedRouteId(null);
                                      setRoutePlannerEditMode(false);
                                      setRoute([]);
                                      setUnsavedRouteDays(prev => {
                                        const next = { ...prev };
                                        delete next[dateKey];
                                        if (Object.keys(next).length === 0) setUnsavedRouteChanges(false);
                                        return next;
                                      });
                                    }
                                  }}
                                  style={{
                                    flex: 1, padding: '8px 10px', fontSize: '11px', fontWeight: 600,
                                    background: 'rgba(239,68,68,0.15)', border: '1px solid rgba(239,68,68,0.3)',
                                    borderRadius: '6px', color: '#fca5a5', cursor: 'pointer', textAlign: 'center'
                                  }}
                                >ðŸ—‘ï¸ Delete Route</button>
                                <button
                                  onClick={() => {
                                    const savedRoute = savedRoutes.find(r => r.id === editingSavedRouteId);
                                    if (savedRoute) {
                                      setRoutesByDay(prev => ({ ...prev, [dateKey]: [...savedRoute.customers] }));
                                      setCustomers(prev => {
                                        const routeCustomerMap = new Map();
                                        savedRoute.customers.forEach(rc => routeCustomerMap.set(rc.id, rc));
                                        return prev.map(c => {
                                          const rc = routeCustomerMap.get(c.id);
                                          if (rc) return { ...c, scheduledTime: rc.scheduledTime || c.scheduledTime, scheduledDate: savedRoute.scheduledDate, status: 'scheduled', routeConfirmed: true };
                                          return c;
                                        });
                                      });
                                      setSavedViewDays(prev => ({ ...prev, [dateKey]: true }));
                                    }
                                    setEditingSavedRouteId(null);
                                    setRoutePlannerEditMode(false);
                                    setRoute([]);
                                    setUnsavedRouteDays(prev => {
                                      const next = { ...prev };
                                      delete next[dateKey];
                                      if (Object.keys(next).length === 0) setUnsavedRouteChanges(false);
                                      return next;
                                    });
                                  }}
                                  style={{
                                    flex: 1, padding: '8px 10px', fontSize: '11px', fontWeight: 600,
                                    background: 'rgba(100,116,139,0.15)', border: '1px solid rgba(100,116,139,0.3)',
                                    borderRadius: '6px', color: '#94a3b8', cursor: 'pointer', textAlign: 'center'
                                  }}
                                >â†©ï¸ Cancel</button>
                              </div>
                            </div>
                          ) : null}
                          
                          {/* Time Slots */}
                          <div>
                          {/* Up Arrow - Show Earlier Times */}
                          {visibleStartHour > 6 && (
                            <button
                              onClick={() => setVisibleStartHour(prev => Math.max(6, prev - 1))}
                              style={{
                                width: '100%',
                                padding: '8px',
                                marginBottom: '8px',
                                background: 'rgba(139, 92, 246, 0.1)',
                            border: '1px solid rgba(139, 92, 246, 0.3)',
                            borderRadius: '6px',
                            color: '#8b5cf6',
                            cursor: 'pointer',
                            fontSize: '12px',
                            fontWeight: 600,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: '6px'
                          }}
                        >
                          â†‘ Show Earlier Times
                        </button>
                          )}
                          
                          <div style={{ display: 'grid', gap: '6px' }}>
                        {generateTimeSlots()
                          .filter(slot => slot.hour >= visibleStartHour && slot.hour < visibleEndHour)
                          .map((slot, index) => {
                            const jobsInSlot = getJobsForTimeSlot(selectedDate, slot.time);
                            const isBlocked = jobsInSlot.length > 0;
                            
                            // Calculate job number based on scheduled time
                            const allJobsForDay = customers
                              .filter(c => {
                                if (!c.scheduledDate || !c.scheduledTime) return false;
                                const custDate = new Date(c.scheduledDate);
                                return custDate.toDateString() === selectedDate.toDateString();
                              })
                              .sort((a, b) => {
                                const [aHour, aMin] = a.scheduledTime.split(':').map(Number);
                                const [bHour, bMin] = b.scheduledTime.split(':').map(Number);
                                return (aHour * 60 + aMin) - (bHour * 60 + bMin);
                              });
                            
                            return (
                              <div
                                key={slot.time}
                                onDragOver={(e) => {
                                  e.preventDefault();
                                  e.currentTarget.style.background = 'rgba(139, 92, 246, 0.2)';
                                }}
                                onDragLeave={(e) => {
                                  e.currentTarget.style.background = isBlocked ? 'rgba(239, 68, 68, 0.05)' : 'rgba(30, 41, 59, 0.3)';
                                }}
                                onDrop={(e) => {
                                  e.preventDefault();
                                  e.currentTarget.style.background = isBlocked ? 'rgba(239, 68, 68, 0.05)' : 'rgba(30, 41, 59, 0.3)';
                                  
                                  const customerData = e.dataTransfer.getData('customer');
                                  if (customerData) {
                                    const customer = JSON.parse(customerData);
                                    scheduleCustomerToTimeSlot(customer, selectedDate, slot.time);
                                  }
                                }}
                                style={{
                                  padding: '8px 12px',
                                  background: isBlocked ? 'rgba(239, 68, 68, 0.05)' : 'rgba(30, 41, 59, 0.3)',
                                  border: `2px solid ${isBlocked ? 'rgba(239, 68, 68, 0.3)' : 'rgba(100, 116, 139, 0.2)'}`,
                                  borderRadius: '6px',
                                  transition: 'all 0.2s',
                                  minHeight: jobsInSlot.length > 0 ? 'auto' : '40px'
                                }}
                              >
                            {/* Time Label */}
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: jobsInSlot.length > 0 ? '6px' : 0 }}>
                              <div style={{
                                fontSize: '11px',
                                fontWeight: 700,
                                color: isBlocked ? '#fca5a5' : '#8b5cf6',
                                minWidth: '65px'
                              }}>
                                {slot.display}
                              </div>
                              
                              {jobsInSlot.length === 0 && (
                                <div style={{ fontSize: '9px', color: '#64748b', fontStyle: 'italic' }}>
                                  Available
                                </div>
                              )}
                            </div>
                            
                            {/* Jobs in this slot */}
                            {jobsInSlot.length > 0 && (
                              <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                                {jobsInSlot.map((job, jobIndex) => {
                                  // Find job number based on time order
                                  const jobNumber = allJobsForDay.findIndex(j => j.id === job.id) + 1;
                                  
                                  // Calculate distance and drive time to next job
                                  const nextJob = allJobsForDay[jobNumber]; // jobNumber is 1-indexed, so this gets the next
                                  let distanceToNext = null;
                                  let driveTimeToNext = null;
                                  
                                  if (nextJob && job.lat && job.lng && nextJob.lat && nextJob.lng) {
                                    distanceToNext = calculateDistance(job.lat, job.lng, nextJob.lat, nextJob.lng);
                                    // Assume 25 mph average speed
                                    driveTimeToNext = Math.round((distanceToNext / 25) * 60); // minutes
                                  }
                                  
                                  return (
                                    <React.Fragment key={job.id}>
                                      <div
                                        draggable
                                        onDragStart={(e) => {
                                          e.dataTransfer.setData('customer', JSON.stringify(job));
                                        }}
                                        style={{
                                          padding: '8px 10px',
                                          background: 'rgba(15, 23, 42, 0.8)',
                                          border: '1px solid rgba(139, 92, 246, 0.3)',
                                          borderRadius: '6px',
                                          cursor: 'grab',
                                          display: 'flex',
                                          gap: '10px',
                                          alignItems: 'flex-start',
                                          position: 'relative'
                                        }}
                                        onMouseDown={(e) => {
                                          e.currentTarget.style.cursor = 'grabbing';
                                        }}
                                        onMouseUp={(e) => {
                                          e.currentTarget.style.cursor = 'grab';
                                        }}
                                      >
                                        {/* Job Number Badge */}
                                        <div style={{
                                          width: '24px',
                                          height: '24px',
                                          borderRadius: '50%',
                                          background: 'rgba(139, 92, 246, 0.3)',
                                          border: '2px solid rgba(139, 92, 246, 0.6)',
                                          display: 'flex',
                                          alignItems: 'center',
                                          justifyContent: 'center',
                                          fontSize: '11px',
                                          fontWeight: 700,
                                          color: '#c4b5fd',
                                          flexShrink: 0
                                        }}>
                                          {jobNumber}
                                        </div>
                                        
                                        {/* Job Details */}
                                        <div style={{ flex: 1, minWidth: 0 }}>
                                          <div style={{ fontSize: '11px', fontWeight: 600, color: '#f1f5f9', marginBottom: '3px' }}>
                                            {job.name}
                                          </div>
                                          <div style={{ fontSize: '9px', color: '#94a3b8' }}>
                                            ðŸ“ {job.address}
                                          </div>
                                          {job.phone && (
                                            <div style={{ fontSize: '9px', color: '#94a3b8', marginTop: '2px' }}>
                                              ðŸ“± {job.phone}
                                            </div>
                                          )}
                                        </div>
                                        
                                        {/* Action Buttons */}
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '4px', flexShrink: 0 }}>
                                          {/* Up Arrow - Move job earlier */}
                                          {jobNumber > 1 && (
                                            <button
                                              onClick={(e) => {
                                                e.stopPropagation();
                                                const currentIndex = jobNumber - 1; // Convert to 0-indexed
                                                const prevJob = allJobsForDay[currentIndex - 1];
                                                
                                                // Swap scheduled times
                                                setCustomers(prev => prev.map(c => {
                                                  if (c.id === job.id) {
                                                    return { ...c, scheduledTime: prevJob.scheduledTime };
                                                  }
                                                  if (c.id === prevJob.id) {
                                                    return { ...c, scheduledTime: job.scheduledTime };
                                                  }
                                                  return c;
                                                }));
                                                propagateCustomerUpdate(job.id, { scheduledTime: prevJob.scheduledTime });
                                                propagateCustomerUpdate(prevJob.id, { scheduledTime: job.scheduledTime });
                                              }}
                                              style={{
                                                background: 'rgba(139, 92, 246, 0.1)',
                                                border: '1px solid rgba(139, 92, 246, 0.3)',
                                                borderRadius: '4px',
                                                width: '20px',
                                                height: '20px',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                color: '#8b5cf6',
                                                cursor: 'pointer',
                                                fontSize: '10px',
                                                flexShrink: 0,
                                                padding: 0
                                              }}
                                              title="Move up"
                                            >
                                              â–²
                                            </button>
                                          )}
                                          
                                          {/* Down Arrow - Move job later */}
                                          {jobNumber < allJobsForDay.length && (
                                            <button
                                              onClick={(e) => {
                                                e.stopPropagation();
                                                const currentIndex = jobNumber - 1; // Convert to 0-indexed
                                                const nextJob = allJobsForDay[currentIndex + 1];
                                                
                                                // Swap scheduled times
                                                setCustomers(prev => prev.map(c => {
                                                  if (c.id === job.id) {
                                                    return { ...c, scheduledTime: nextJob.scheduledTime };
                                                  }
                                                  if (c.id === nextJob.id) {
                                                    return { ...c, scheduledTime: job.scheduledTime };
                                                  }
                                                  return c;
                                                }));
                                                propagateCustomerUpdate(job.id, { scheduledTime: nextJob.scheduledTime });
                                                propagateCustomerUpdate(nextJob.id, { scheduledTime: job.scheduledTime });
                                              }}
                                              style={{
                                                background: 'rgba(139, 92, 246, 0.1)',
                                                border: '1px solid rgba(139, 92, 246, 0.3)',
                                                borderRadius: '4px',
                                                width: '20px',
                                                height: '20px',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                color: '#8b5cf6',
                                                cursor: 'pointer',
                                                fontSize: '10px',
                                                flexShrink: 0,
                                                padding: 0
                                              }}
                                              title="Move down"
                                            >
                                              â–¼
                                            </button>
                                          )}
                                          
                                          {/* Remove Button */}
                                          <button
                                          onClick={(e) => {
                                            e.stopPropagation();
                                            const dateKey = selectedDate.toDateString();
                                            
                                            // Remove from day-specific route
                                            setRoutesByDay(prev => ({
                                              ...prev,
                                              [dateKey]: (prev[dateKey] || []).filter(r => r.id !== job.id)
                                            }));
                                            
                                            // Remove from old route state
                                            setRoute(prev => prev.filter(r => r.id !== job.id));
                                            
                                            // Unschedule customer
                                            setCustomers(prev => prev.map(c => {
                                              if (c.id === job.id) {
                                                return {
                                                  ...c,
                                                  scheduledDate: null,
                                                  scheduledTime: null,
                                                  status: getStatusAfterUnschedule(c),
                                                  routeConfirmed: false
                                                };
                                              }
                                              return c;
                                            }));
                                            const jobCustomer = customers.find(c => c.id === job.id);
                                            propagateCustomerUpdate(job.id, { scheduledDate: null, scheduledTime: null, status: getStatusAfterUnschedule(jobCustomer), routeConfirmed: false });
                                          }}
                                          style={{
                                            background: 'rgba(239, 68, 68, 0.1)',
                                            border: '1px solid rgba(239, 68, 68, 0.3)',
                                            borderRadius: '4px',
                                            width: '20px',
                                            height: '20px',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            color: '#fca5a5',
                                            cursor: 'pointer',
                                            fontSize: '12px',
                                            flexShrink: 0,
                                            padding: 0
                                          }}
                                          title="Remove from route"
                                        >
                                          âœ•
                                        </button>
                                      </div> {/* Close action buttons container */}
                                    </div> {/* Close job card */}
                                      
                                      {/* Distance and Drive Time to Next Job */}
                                      {distanceToNext !== null && (
                                        <div style={{
                                          display: 'flex',
                                          alignItems: 'center',
                                          justifyContent: 'center',
                                          gap: '6px',
                                          padding: '6px',
                                          fontSize: '9px',
                                          color: '#64748b',
                                          background: 'rgba(100, 116, 139, 0.1)',
                                          borderRadius: '4px',
                                          margin: '4px 0'
                                        }}>
                                          <span>â†“</span>
                                          <span style={{ fontWeight: 600, color: '#94a3b8' }}>
                                            {(distanceToNext || 0).toFixed(1)} mi
                                          </span>
                                          <span>â€¢</span>
                                          <span style={{ fontWeight: 600, color: '#94a3b8' }}>
                                            {driveTimeToNext < 60 
                                              ? `${driveTimeToNext} min` 
                                              : `${Math.floor(driveTimeToNext / 60)}h ${driveTimeToNext % 60}min`
                                            } drive
                                          </span>
                                        </div>
                                      )}
                                    </React.Fragment>
                                  );
                                })}
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                    
                          {/* Down Arrow - Show Later Times */}
                          {visibleEndHour < 20 && (
                            <button
                              onClick={() => setVisibleEndHour(prev => Math.min(20, prev + 1))}
                              style={{
                                width: '100%',
                                padding: '8px',
                                marginTop: '8px',
                                background: 'rgba(139, 92, 246, 0.1)',
                                border: '1px solid rgba(139, 92, 246, 0.3)',
                                borderRadius: '6px',
                                color: '#8b5cf6',
                                cursor: 'pointer',
                                fontSize: '12px',
                                fontWeight: 600,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '6px'
                              }}
                            >
                              â†“ Show Later Times
                            </button>
                          )}
                      </div>
                          </div>
                        );
                    })()}
                  </div>
                  )}
                  
                  {/* Hidden file input (shared by both upload methods) */}
                  <input
                    ref={fileInputRef}
                    type="file"
                    accept=".csv"
                    multiple
                    onChange={(e) => {
                      handleFileUpload(e.target.files);
                      e.target.value = ''; // Reset so same file can be uploaded again
                    }}
                    style={{ display: 'none' }}
                  />


                  {/* Error Display */}
                  {error && (
                    <div style={{
                      marginTop: '16px',
                      marginBottom: '16px',
                      padding: '16px',
                      background: 'rgba(239, 68, 68, 0.1)',
                      border: '1px solid rgba(239, 68, 68, 0.3)',
                      borderRadius: '12px',
                      fontSize: '13px',
                      color: '#fca5a5'
                    }}>
                      âš ï¸ {error}
                    </div>
                  )}



                  {/* Hidden file input (shared by both upload methods) */}
                  <input
                    ref={fileInputRef}
                    type="file"
                    accept=".csv"
                    multiple
                    onChange={(e) => {
                      handleFileUpload(e.target.files);
                      e.target.value = ''; // Reset so same file can be uploaded again
                    }}
                    style={{ display: 'none' }}
                  />

                </div>
              </div>

              {/* Map Container */}
              <div style={{ flex: 1, position: 'relative', display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
                {/* Compact Filter Bar - Top of Map */}
                {currentView === 'map' && customers.length > 0 && (
                  <div style={{
                    position: 'absolute',
                    top: '12px',
                    left: '12px',
                    right: '420px',
                    zIndex: 1001,
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '8px'
                  }}>
                    {/* Collapsed: just a small toggle button */}
                    {!showFilterPanel ? (
                      <button
                        onClick={() => setShowFilterPanel(true)}
                        style={{
                          alignSelf: 'flex-start',
                          padding: '6px 14px',
                          fontSize: '12px',
                          fontWeight: 600,
                          background: 'rgba(10, 14, 39, 0.88)',
                          backdropFilter: 'blur(16px)',
                          border: '1px solid rgba(139, 92, 246, 0.3)',
                          borderRadius: '10px',
                          color: '#a78bfa',
                          cursor: 'pointer',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '6px'
                        }}
                      >
                        Filters
                        {(() => {
                          const cnt = [statusFilter !== 'all', stateFilter, cityFilter, zipFilter, lastServiceFilter,
                            activeFilters.verifiedSolar, activeFilters.existingJob, activeFilters.recurring, activeFilters.minPanels].filter(Boolean).length;
                          return cnt > 0 ? <span style={{ background: 'rgba(139,92,246,0.4)', padding: '1px 7px', borderRadius: '8px', fontSize: '10px', color: '#fff' }}>{cnt}</span> : null;
                        })()}
                        <span style={{ fontSize: '10px' }}>â–¼</span>
                      </button>
                    ) : (
                    <>
                    {/* Row 1: Essential controls - clean and minimal */}
                    <div style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '6px',
                      flexWrap: 'wrap',
                      background: 'rgba(10, 14, 39, 0.88)',
                      backdropFilter: 'blur(16px)',
                      border: '1px solid rgba(139, 92, 246, 0.2)',
                      borderRadius: '12px',
                      padding: '8px 12px'
                    }}>
                      {/* Status pills */}
                      {[
                        { value: 'all', label: 'All' },
                        { value: 'scheduled', label: 'Route Planner', color: '#eab308' }
                      ].map(s => (
                        <button
                          key={s.value}
                          onClick={() => { 
                            if (statusFilter === s.value) {
                              setStatusFilter('all');
                              setFocusedDays([]);
                              setShowNeedScheduling(false);
                              setRoutePlannerEditMode(false);
                            } else {
                              setStatusFilter(s.value);
                              setShowNeedScheduling(true);
                              const today = new Date(); today.setHours(0,0,0,0);
                              setSelectedDate(today);
                              setFocusedDays([today]);
                              setRoutePlannerEditMode(false);
                            }
                          }}
                          style={{
                            padding: '4px 10px',
                            fontSize: '11px',
                            fontWeight: 600,
                            border: 'none',
                            borderRadius: '6px',
                            cursor: 'pointer',
                            transition: 'all 0.15s',
                            background: statusFilter === s.value
                              ? (s.color ? `${s.color}33` : 'rgba(139, 92, 246, 0.3)')
                              : 'rgba(30, 41, 59, 0.4)',
                            color: statusFilter === s.value
                              ? (s.color || '#a78bfa')
                              : '#94a3b8',
                            boxShadow: statusFilter === s.value
                              ? `0 0 0 1px ${s.color || 'rgba(139, 92, 246, 0.5)'}`
                              : 'none'
                          }}
                        >
                          {s.label}
                        </button>
                      ))}

                      {statusFilter !== 'scheduled' && (
                        <>
                          <div style={{ width: '1px', height: '18px', background: 'rgba(100, 116, 139, 0.3)', margin: '0 2px' }} />
                          <button
                            onClick={() => setActiveFilters(prev => ({ ...prev, recurring: !prev.recurring }))}
                            style={{
                              padding: '3px 8px', fontSize: '11px', fontWeight: 600,
                              border: 'none', borderRadius: '6px', cursor: 'pointer',
                              background: activeFilters.recurring ? 'rgba(59, 130, 246, 0.25)' : 'rgba(30, 41, 59, 0.4)',
                              color: activeFilters.recurring ? '#3b82f6' : '#94a3b8',
                              boxShadow: activeFilters.recurring ? '0 0 0 1px rgba(59, 130, 246, 0.5)' : 'none'
                            }}
                          >
                            ðŸ¦– Recurring
                          </button>
                        </>
                      )}

                      {statusFilter === 'scheduled' && (
                        <>
                          <div style={{ width: '1px', height: '18px', background: 'rgba(100, 116, 139, 0.3)', margin: '0 2px' }} />
                          <button
                            onClick={() => {
                              const today = new Date(); today.setHours(0,0,0,0);
                              setFocusedDays([today]);
                              setScheduledMapView('week');
                              const ws = new Date(); ws.setDate(ws.getDate() - ws.getDay()); ws.setHours(0,0,0,0);
                              setScheduledViewWeekStart(ws);
                            }}
                            style={{
                              padding: '3px 8px', fontSize: '11px', fontWeight: 600,
                              border: 'none', borderRadius: '6px', cursor: 'pointer',
                              background: 'rgba(234, 179, 8, 0.25)',
                              color: '#fbbf24',
                              boxShadow: '0 0 0 1px rgba(234, 179, 8, 0.5)'
                            }}
                          >This Week</button>
                        </>
                      )}

                      <div style={{ flex: 1 }} />

                      <span style={{ fontSize: '11px', color: '#22c55e', fontWeight: 700 }}>
                        {filteredCustomers.length} results
                      </span>

                      {/* More Filters toggle */}
                      {(() => {
                        const advFilterCount = [stateFilter, cityFilter, zipFilter, lastServiceFilter,
                          activeFilters.minPanels, activeFilters.recurring].filter(Boolean).length;
                        return (
                          <button
                            onClick={() => setShowFilterPanel(showFilterPanel === 'advanced' ? true : 'advanced')}
                            style={{
                              padding: '3px 8px',
                              fontSize: '10px',
                              fontWeight: 600,
                              background: showFilterPanel === 'advanced' ? 'rgba(139, 92, 246, 0.25)' : 'rgba(30, 41, 59, 0.4)',
                              border: advFilterCount > 0 ? '1px solid rgba(139, 92, 246, 0.5)' : '1px solid rgba(100, 116, 139, 0.2)',
                              borderRadius: '6px',
                              color: showFilterPanel === 'advanced' ? '#a78bfa' : '#94a3b8',
                              cursor: 'pointer',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '4px'
                            }}
                          >
                            Filters {advFilterCount > 0 && <span style={{ background: 'rgba(139,92,246,0.5)', padding: '1px 6px', borderRadius: '8px', fontSize: '9px', color: '#fff' }}>{advFilterCount}</span>}
                            <span style={{ fontSize: '8px' }}>{showFilterPanel === 'advanced' ? 'â–²' : 'â–¼'}</span>
                          </button>
                        );
                      })()}

                      {/* Clear all */}
                      {(() => {
                        const hasAny = stateFilter || cityFilter || zipFilter ||
                          lastServiceFilter || activeFilters.verifiedSolar || activeFilters.existingJob ||
                          activeFilters.recurring || activeFilters.minPanels;
                        return hasAny ? (
                          <button
                            onClick={() => {
                              setStateFilter('');
                              setCityFilter('');
                              setZipFilter('');
                              setLastServiceFilter('');
                              setPreferredDateFilter([]);
                              setPreferredTimeFilter([]);
                              setActiveFilters({ verifiedSolar: false, existingJob: false, recurring: false, minPanels: '', lastService: '' });
                              setFocusedDays([]);
                            }}
                            style={{
                              padding: '3px 8px',
                              fontSize: '10px',
                              fontWeight: 600,
                              background: 'rgba(239, 68, 68, 0.2)',
                              border: '1px solid rgba(239, 68, 68, 0.3)',
                              borderRadius: '6px',
                              color: '#fca5a5',
                              cursor: 'pointer'
                            }}
                          >
                            Clear
                          </button>
                        ) : null;
                      })()}

                      <button
                        onClick={() => setShowFilterPanel(false)}
                        title="Hide filters"
                        style={{
                          padding: '3px 6px',
                          fontSize: '10px',
                          fontWeight: 600,
                          background: 'rgba(100, 116, 139, 0.2)',
                          border: '1px solid rgba(100, 116, 139, 0.3)',
                          borderRadius: '6px',
                          color: '#94a3b8',
                          cursor: 'pointer'
                        }}
                      >â–²</button>
                    </div>

                    {/* Advanced Filters Panel - collapsible */}
                    {showFilterPanel === 'advanced' && (
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        flexWrap: 'wrap',
                        background: 'rgba(10, 14, 39, 0.92)',
                        backdropFilter: 'blur(16px)',
                        border: '1px solid rgba(139, 92, 246, 0.15)',
                        borderRadius: '12px',
                        padding: '8px 12px'
                      }}>
                        <span style={{ fontSize: '10px', color: '#94a3b8', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Location:</span>
                        <select
                          value={stateFilter}
                          onChange={(e) => { setStateFilter(e.target.value); setCityFilter(''); }}
                          style={{
                            padding: '4px 6px', fontSize: '11px',
                            background: stateFilter ? 'rgba(139, 92, 246, 0.2)' : 'rgba(30, 41, 59, 0.5)',
                            border: stateFilter ? '1px solid rgba(139, 92, 246, 0.4)' : '1px solid rgba(100, 116, 139, 0.2)',
                            borderRadius: '6px', color: '#f1f5f9', cursor: 'pointer', maxWidth: '90px'
                          }}
                        >
                          <option value="">State</option>
                          {[...new Set(customers.map(c => c.state).filter(Boolean))].sort().map(state => (
                            <option key={state} value={state}>{state}</option>
                          ))}
                        </select>
                        <select
                          value={cityFilter}
                          onChange={(e) => setCityFilter(e.target.value)}
                          style={{
                            padding: '4px 6px', fontSize: '11px',
                            background: cityFilter ? 'rgba(139, 92, 246, 0.2)' : 'rgba(30, 41, 59, 0.5)',
                            border: cityFilter ? '1px solid rgba(139, 92, 246, 0.4)' : '1px solid rgba(100, 116, 139, 0.2)',
                            borderRadius: '6px', color: '#f1f5f9', cursor: 'pointer', maxWidth: '110px'
                          }}
                        >
                          <option value="">City</option>
                          {[...new Set(customers.filter(c => !stateFilter || c.state === stateFilter).map(c => c.city).filter(Boolean))].sort().map(city => (
                            <option key={city} value={city}>{city}</option>
                          ))}
                        </select>
                        <input
                          type="text"
                          value={zipFilter}
                          onChange={(e) => setZipFilter(e.target.value)}
                          placeholder="ZIP"
                          style={{
                            padding: '4px 6px', fontSize: '11px',
                            background: zipFilter ? 'rgba(139, 92, 246, 0.2)' : 'rgba(30, 41, 59, 0.5)',
                            border: zipFilter ? '1px solid rgba(139, 92, 246, 0.4)' : '1px solid rgba(100, 116, 139, 0.2)',
                            borderRadius: '6px', color: '#f1f5f9', width: '60px', boxSizing: 'border-box'
                          }}
                        />

                        <div style={{ width: '1px', height: '18px', background: 'rgba(100, 116, 139, 0.2)', margin: '0 4px' }} />

                        <span style={{ fontSize: '10px', color: '#94a3b8', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Service:</span>
                        <select
                          value={lastServiceFilter}
                          onChange={(e) => setLastServiceFilter(e.target.value)}
                          style={{
                            padding: '4px 6px', fontSize: '11px',
                            background: lastServiceFilter ? 'rgba(251, 191, 36, 0.2)' : 'rgba(30, 41, 59, 0.5)',
                            border: lastServiceFilter ? '1px solid rgba(251, 191, 36, 0.4)' : '1px solid rgba(100, 116, 139, 0.2)',
                            borderRadius: '6px', color: lastServiceFilter ? '#fbbf24' : '#f1f5f9', cursor: 'pointer', maxWidth: '130px'
                          }}
                        >
                          <option value="">Last Service</option>
                          <option value="3months">3+ months ago</option>
                          <option value="6months">6+ months ago</option>
                          <option value="12months">12+ months ago</option>
                        </select>

                        <div style={{ width: '1px', height: '18px', background: 'rgba(100, 116, 139, 0.2)', margin: '0 4px' }} />

                        <span style={{ fontSize: '10px', color: '#94a3b8', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Panels:</span>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                          <span style={{ fontSize: '11px', color: '#94a3b8' }}>Min:</span>
                          <input
                            type="number"
                            value={activeFilters.minPanels}
                            onChange={(e) => setActiveFilters(prev => ({ ...prev, minPanels: e.target.value }))}
                            placeholder="0"
                            min="0"
                            style={{
                              width: '48px', padding: '3px 6px', fontSize: '11px',
                              background: activeFilters.minPanels ? 'rgba(139, 92, 246, 0.2)' : 'rgba(30, 41, 59, 0.5)',
                              border: activeFilters.minPanels ? '1px solid rgba(139, 92, 246, 0.4)' : '1px solid rgba(100, 116, 139, 0.2)',
                              borderRadius: '6px', color: '#f1f5f9', boxSizing: 'border-box'
                            }}
                          />
                        </div>

                        {statusFilter === 'scheduled' && (
                          <>
                            <div style={{ width: '1px', height: '18px', background: 'rgba(100, 116, 139, 0.2)', margin: '0 4px' }} />
                            <span style={{ fontSize: '10px', color: '#94a3b8', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Show:</span>
                            <button
                              onClick={() => setActiveFilters(prev => ({ ...prev, recurring: !prev.recurring }))}
                              style={{
                                padding: '3px 8px', fontSize: '11px', fontWeight: 600,
                                border: 'none', borderRadius: '6px', cursor: 'pointer',
                                background: activeFilters.recurring ? 'rgba(59, 130, 246, 0.25)' : 'rgba(30, 41, 59, 0.4)',
                                color: activeFilters.recurring ? '#3b82f6' : '#94a3b8',
                                boxShadow: activeFilters.recurring ? '0 0 0 1px rgba(59, 130, 246, 0.5)' : 'none'
                              }}
                            >
                              ðŸ¦– Recurring Only
                            </button>
                          </>
                        )}
                      </div>
                    )}


                    </>
                    )}
                  </div>
                )}

                {/* Map - takes remaining space */}
                <div
                  ref={mapRef}
                  style={{
                    flex: 1,
                    width: '100%',
                    position: 'relative',
                    background: '#0a0e27'
                  }}
                />


                {/* Right Sidebar - Absolutely positioned over map */}
                {currentView === 'map' && (
                  <div style={{
                    position: 'absolute',
                    top: 0,
                    right: 0,
                    bottom: 0,
                    width: '380px',
                    background: 'rgba(15, 23, 42, 0.95)',
                    backdropFilter: 'blur(20px)',
                    borderLeft: statusFilter === 'scheduled' ? '2px solid rgba(234, 179, 8, 0.3)' : '2px solid rgba(139, 92, 246, 0.2)',
                    display: 'flex',
                    flexDirection: 'column',
                    overflow: 'hidden',
                    boxShadow: '-10px 0 30px rgba(0, 0, 0, 0.3)',
                    zIndex: 1000
                  }}>
                    {statusFilter === 'scheduled' ? (
                      <>
                        {/* Route Planner Sidebar */}
                        <div className="scrollbar-custom" style={{ flex: 1, overflow: 'auto', display: 'flex', flexDirection: 'column' }}>

                          {/* Days List with Navigation */}
                          <div style={{ padding: '12px', borderBottom: '1px solid rgba(234, 179, 8, 0.15)' }}>
                            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '8px' }}>
                              <div style={{ display: 'flex', gap: '4px', alignItems: 'center' }}>
                                <button
                                  onClick={() => {
                                    const d = new Date(scheduledViewWeekStart);
                                    d.setDate(d.getDate() - 7);
                                    setScheduledViewWeekStart(d);
                                  }}
                                  style={{ padding: '2px 6px', fontSize: '10px', background: 'rgba(234, 179, 8, 0.15)', border: '1px solid rgba(234, 179, 8, 0.25)', borderRadius: '4px', color: '#fbbf24', cursor: 'pointer' }}
                                >â—€</button>
                                <button
                                  onClick={() => {
                                    const d = new Date(); d.setDate(d.getDate() - d.getDay()); d.setHours(0,0,0,0);
                                    setScheduledViewWeekStart(d);
                                    setScheduledMapView('week');
                                    const today = new Date(); today.setHours(0,0,0,0);
                                    setFocusedDays([today]);
                                  }}
                                  style={{ padding: '2px 8px', fontSize: '10px', background: 'rgba(234, 179, 8, 0.15)', border: '1px solid rgba(234, 179, 8, 0.25)', borderRadius: '4px', color: '#fbbf24', cursor: 'pointer', fontWeight: 600 }}
                                >Today</button>
                                <button
                                  onClick={() => {
                                    const d = new Date(scheduledViewWeekStart);
                                    d.setDate(d.getDate() + 7);
                                    setScheduledViewWeekStart(d);
                                  }}
                                  style={{ padding: '2px 6px', fontSize: '10px', background: 'rgba(234, 179, 8, 0.15)', border: '1px solid rgba(234, 179, 8, 0.25)', borderRadius: '4px', color: '#fbbf24', cursor: 'pointer' }}
                                >â–¶</button>
                              </div>
                              <div style={{ display: 'flex', gap: '4px' }}>
                                <button
                                  onClick={() => { setMultiSelectDays(!multiSelectDays); if (multiSelectDays && focusedDays.length > 1) { setFocusedDays([focusedDays[0]]); } }}
                                  title={multiSelectDays ? 'Switch to single day' : 'Select multiple days'}
                                  style={{ padding: '2px 6px', fontSize: '10px', background: multiSelectDays ? 'rgba(34, 197, 94, 0.25)' : 'rgba(100, 116, 139, 0.15)', border: multiSelectDays ? '1px solid rgba(34, 197, 94, 0.5)' : '1px solid rgba(100, 116, 139, 0.3)', borderRadius: '4px', color: multiSelectDays ? '#4ade80' : '#94a3b8', cursor: 'pointer', fontWeight: 600 }}
                                >
                                  {multiSelectDays ? 'âœ“ Multi' : 'âŠž'}
                                </button>
                                <button
                                  onClick={() => setShowMonthCalendar(!showMonthCalendar)}
                                  style={{ padding: '2px 8px', fontSize: '10px', background: showMonthCalendar ? 'rgba(139, 92, 246, 0.25)' : 'rgba(139, 92, 246, 0.1)', border: '1px solid rgba(139, 92, 246, 0.3)', borderRadius: '4px', color: '#a78bfa', cursor: 'pointer', fontWeight: 600 }}
                                >
                                  {showMonthCalendar ? 'ðŸ“† Week' : 'ðŸ“… Month'}
                                </button>
                              </div>
                            </div>

                            {showMonthCalendar ? (
                              <div>
                                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '6px' }}>
                                  <button onClick={() => { const d = new Date(scheduledViewWeekStart); d.setMonth(d.getMonth() - 1); setScheduledViewWeekStart(d); }}
                                    style={{ background: 'none', border: 'none', color: '#fbbf24', cursor: 'pointer', fontSize: '12px' }}>â—€</button>
                                  <span style={{ fontSize: '12px', fontWeight: 700, color: '#e2e8f0' }}>
                                    {new Date(scheduledViewWeekStart).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                                  </span>
                                  <button onClick={() => { const d = new Date(scheduledViewWeekStart); d.setMonth(d.getMonth() + 1); setScheduledViewWeekStart(d); }}
                                    style={{ background: 'none', border: 'none', color: '#fbbf24', cursor: 'pointer', fontSize: '12px' }}>â–¶</button>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '2px' }}>
                                  {['S','M','T','W','T','F','S'].map((d, i) => (
                                    <div key={i} style={{ textAlign: 'center', fontSize: '9px', color: '#64748b', fontWeight: 600, padding: '2px' }}>{d}</div>
                                  ))}
                                  {(() => {
                                    const monthStart = new Date(scheduledViewWeekStart.getFullYear(), scheduledViewWeekStart.getMonth(), 1);
                                    const monthEnd = new Date(scheduledViewWeekStart.getFullYear(), scheduledViewWeekStart.getMonth() + 1, 0);
                                    const startPad = monthStart.getDay();
                                    const days = [];
                                    for (let i = 0; i < startPad; i++) days.push(null);
                                    for (let d = 1; d <= monthEnd.getDate(); d++) {
                                      days.push(new Date(scheduledViewWeekStart.getFullYear(), scheduledViewWeekStart.getMonth(), d));
                                    }
                                    return days.map((date, idx) => {
                                      if (!date) return <div key={idx} />;
                                      const isToday = date.toDateString() === new Date().toDateString();
                                      const isFocused = focusedDays.some(fd => date.toDateString() === fd.toDateString());
                                      const routesOnDay = savedRoutes.filter(r => !r.sentToTech && new Date(r.scheduledDate).toDateString() === date.toDateString());
                                      const jobCount = routesOnDay.reduce((sum, r) => sum + (r.customers || []).length, 0);
                                      return (
                                        <div key={idx}
                                          onClick={() => {
                                            const clickedDate = new Date(date); clickedDate.setHours(0,0,0,0);
                                            setSelectedDate(clickedDate);
                                            if (multiSelectDays) {
                                              setFocusedDays(prev => {
                                                const exists = prev.some(d => d.toDateString() === clickedDate.toDateString());
                                                if (exists) return prev.filter(d => d.toDateString() !== clickedDate.toDateString());
                                                return [...prev, clickedDate];
                                              });
                                            } else {
                                              setFocusedDays([clickedDate]);
                                            }
                                            const weekStart = new Date(clickedDate);
                                            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                                            setScheduledViewWeekStart(weekStart);
                                            if (!multiSelectDays) setShowMonthCalendar(false);
                                          }}
                                          style={{
                                            padding: '4px 2px', borderRadius: '4px', cursor: 'pointer', textAlign: 'center',
                                            background: isFocused ? 'rgba(234, 179, 8, 0.3)' : isToday ? 'rgba(59, 130, 246, 0.15)' : 'transparent',
                                            border: isFocused ? '1px solid rgba(234, 179, 8, 0.6)' : '1px solid transparent',
                                            position: 'relative'
                                          }}
                                        >
                                          <div style={{ fontSize: '11px', fontWeight: isFocused ? 700 : 500, color: isFocused ? '#fbbf24' : isToday ? '#60a5fa' : '#e2e8f0' }}>{date.getDate()}</div>
                                          {jobCount > 0 && (
                                            <div style={{ fontSize: '8px', color: '#22c55e', fontWeight: 700 }}>{jobCount}</div>
                                          )}
                                        </div>
                                      );
                                    });
                                  })()}
                                </div>
                              </div>
                            ) : (
                              (() => {
                                const weekDaysList = getWeekDays(scheduledViewWeekStart);
                                const todayStr = new Date().toDateString();
                                const todayIdx = weekDaysList.findIndex(d => d.toDateString() === todayStr);
                                const sortedDays = weekDaysList;
                                return sortedDays;
                              })().map((date, idx) => {
                                const dayColor = DAY_COLORS[date.getDay()];
                                const isToday = date.toDateString() === new Date().toDateString();
                                const isFocused = focusedDays.some(fd => date.toDateString() === fd.toDateString());
                                const isPrefMatch = hoveredUnroutedDays.includes(date.getDay());
                                const routesOnDay = savedRoutes.filter(r => !r.sentToTech && new Date(r.scheduledDate).toDateString() === date.toDateString());
                                const jobCount = routesOnDay.reduce((sum, r) => sum + r.customers.length, 0);
                                return (
                                  <div
                                    key={idx}
                                    onClick={() => {
                                      const clickedDate = new Date(date);
                                      clickedDate.setHours(0,0,0,0);
                                      setSelectedDate(clickedDate);
                                      if (multiSelectDays) {
                                        setFocusedDays(prev => {
                                          const exists = prev.some(d => d.toDateString() === clickedDate.toDateString());
                                          if (exists) return prev.filter(d => d.toDateString() !== clickedDate.toDateString());
                                          return [...prev, clickedDate];
                                        });
                                      } else {
                                        setFocusedDays([clickedDate]);
                                      }
                                    }}
                                    style={{
                                      display: 'flex', alignItems: 'center', gap: '8px', padding: '6px 10px',
                                      borderRadius: '8px', cursor: 'pointer', marginBottom: '2px',
                                      background: isPrefMatch ? 'rgba(34, 197, 94, 0.2)' : isFocused ? 'rgba(234, 179, 8, 0.15)' : isToday ? 'rgba(59, 130, 246, 0.15)' : 'transparent',
                                      border: isPrefMatch ? '1px solid rgba(34, 197, 94, 0.5)' : isFocused ? '1px solid rgba(234, 179, 8, 0.5)' : isToday ? '1px solid rgba(59, 130, 246, 0.3)' : '1px solid transparent',
                                      transition: 'all 0.15s'
                                    }}
                                  >
                                    <div style={{ width: '8px', height: '8px', borderRadius: '50%', background: isPrefMatch ? '#22c55e' : jobCount > 0 ? dayColor.color : 'rgba(100, 116, 139, 0.3)', flexShrink: 0 }} />
                                    <span style={{ fontSize: '12px', fontWeight: isFocused || isPrefMatch ? 700 : 500, color: isPrefMatch ? '#4ade80' : isFocused ? '#fbbf24' : isToday ? '#93c5fd' : '#e2e8f0', flex: 1 }}>
                                      {dayColor.label} {date.getMonth() + 1}/{date.getDate()}
                                    </span>
                                    {isPrefMatch && <span style={{ fontSize: '9px', color: '#4ade80', fontWeight: 700 }}>PREFERRED</span>}
                                    {isToday && !isPrefMatch && <span style={{ fontSize: '9px', color: '#93c5fd', fontWeight: 600 }}>TODAY</span>}
                                    <span style={{ fontSize: '11px', color: jobCount > 0 ? dayColor.color : '#475569', fontWeight: 600 }}>{jobCount} stop{jobCount !== 1 ? 's' : ''}</span>
                                  </div>
                                );
                              })
                            )}
                          </div>

                          {/* Unrouted Jobs */}
                          {(() => {
                            const unroutedCustomers = customers.filter(c => (c.status || '').toLowerCase() === 'unscheduled');
                            const parsePrefDays = (prefStr) => {
                              if (!prefStr) return [];
                              const dayMap = { 'mon': 1, 'tue': 2, 'wed': 3, 'thu': 4, 'fri': 5, 'sat': 6, 'sun': 0,
                                'monday': 1, 'tuesday': 2, 'wednesday': 3, 'thursday': 4, 'friday': 5, 'saturday': 6, 'sunday': 0 };
                              return prefStr.toLowerCase().split(/[,\s]+/).map(d => dayMap[d.trim()]).filter(d => d !== undefined);
                            };
                            return (
                              <div style={{ flex: 1, display: 'flex', flexDirection: 'column', minHeight: 0 }}>
                                <div style={{ padding: '12px 12px 6px', flexShrink: 0 }}>
                                  <h4 style={{ fontSize: '12px', fontWeight: 700, margin: 0, color: '#94a3b8', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                                    Unrouted Jobs ({unroutedCustomers.length})
                                  </h4>
                                </div>
                                <div className="scrollbar-custom" style={{ flex: 1, overflow: 'auto', padding: '0 12px 12px' }}>
                                  {unroutedCustomers.length === 0 ? (
                                    <div style={{ textAlign: 'center', padding: '20px 0', color: '#475569', fontSize: '11px' }}>All jobs are routed</div>
                                  ) : (
                                    unroutedCustomers.map(customer => (
                                      <div
                                        key={customer.id}
                                        onClick={() => {
                                          if (!routePlannerEditMode) {
                                            setRoutePlannerEditMode(true);
                                          }
                                          if (focusedDays.length > 1) {
                                            setDayPickerPopup({ customer, days: [...focusedDays].sort((a, b) => a - b) });
                                          } else if (focusedDays.length === 1) {
                                            const chosenDate = new Date(focusedDays[0]);
                                            chosenDate.setHours(0,0,0,0);
                                            setSelectedDate(chosenDate);
                                            setTimeout(() => handleCustomerClick(customer), 100);
                                          } else {
                                            setProfileCustomer(customer); setShowCustomerProfile(true);
                                          }
                                        }}
                                        style={{
                                          display: 'flex', alignItems: 'center', gap: '8px', padding: '8px 10px',
                                          borderRadius: '8px', cursor: 'pointer', marginBottom: '3px',
                                          background: 'rgba(100, 116, 139, 0.08)',
                                          border: '1px solid rgba(100, 116, 139, 0.15)',
                                          transition: 'all 0.15s'
                                        }}
                                        onMouseOver={(e) => {
                                          e.currentTarget.style.background = 'rgba(100, 116, 139, 0.15)';
                                          const days = parsePrefDays(customer.preferredDate);
                                          setHoveredUnroutedDays(days);
                                        }}
                                        onMouseOut={(e) => {
                                          e.currentTarget.style.background = 'rgba(100, 116, 139, 0.08)';
                                          setHoveredUnroutedDays([]);
                                        }}
                                      >
                                        <div style={{ width: '8px', height: '8px', borderRadius: '50%', background: '#64748b', flexShrink: 0 }} />
                                        <div style={{ flex: 1, minWidth: 0 }}>
                                          <div style={{ fontSize: '12px', fontWeight: 600, color: '#e2e8f0', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{customer.name}</div>
                                          <div style={{ fontSize: '10px', color: '#64748b', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{(customer.address || '').slice(0, 35)}</div>
                                        </div>
                                        {(customer.preferredDate || customer.preferredTimeWindow) && (
                                          <div style={{ textAlign: 'right', flexShrink: 0 }}>
                                            {customer.preferredDate && <div style={{ fontSize: '9px', color: '#fbbf24', fontWeight: 600 }}>{customer.preferredDate}</div>}
                                            {customer.preferredTimeWindow && <div style={{ fontSize: '9px', color: '#94a3b8' }}>{customer.preferredTimeWindow}</div>}
                                          </div>
                                        )}
                                        <button
                                          onClick={(e) => {
                                            e.stopPropagation();
                                            setProfileCustomer(customer);
                                            setShowCustomerProfile(true);
                                          }}
                                          title="View job details"
                                          style={{
                                            width: '26px', height: '26px', borderRadius: '6px', flexShrink: 0,
                                            background: 'rgba(139, 92, 246, 0.15)', border: '1px solid rgba(139, 92, 246, 0.3)',
                                            color: '#a78bfa', cursor: 'pointer', display: 'flex', alignItems: 'center',
                                            justifyContent: 'center', fontSize: '13px', padding: 0
                                          }}
                                        >ðŸ“‹</button>
                                      </div>
                                    ))
                                  )}
                                </div>
                              </div>
                            );
                          })()}
                        </div>
                      </>
                    ) : (
                      <>
                    {/* Header */}
                    <div style={{
                      padding: '12px',
                      borderBottom: '1px solid rgba(139, 92, 246, 0.2)',
                      background: 'rgba(15, 23, 42, 0.8)'
                    }}>
                      <h3 style={{ fontSize: '16px', fontWeight: 700, margin: 0, marginBottom: '8px' }}>
                        {mapBounds ? filteredCustomers.filter(c => c.lat && c.lng && mapBounds.contains([c.lat, c.lng])).length : filteredCustomers.length} Properties in View
                      </h3>
                      <p style={{ fontSize: '12px', color: '#94a3b8', margin: 0, marginBottom: '12px' }}>
                        {customers.filter(c => c.solarVerified === 'yes').length} verified solar installations
                      </p>
                      
                      {/* Quick Save List Button */}
                      {filteredCustomers.length > 0 && (
                        <button
                          onClick={() => {
                            const listName = prompt(`Save current filter results (${filteredCustomers.length} customers)`, `Filtered List - ${new Date().toLocaleDateString()}`);
                            if (!listName || !listName.trim()) return;
                            
                            const newList = {
                              id: Date.now().toString(),
                              name: listName.trim(),
                              customers: filteredCustomers.map(c => ({
                                ...c,
                                fileId: Date.now().toString(),
                                fileName: listName.trim()
                              })),
                              count: filteredCustomers.length,
                              visible: true,
                              type: 'list',
                              createdAt: new Date().toISOString()
                            };
                            
                            setSavedLists(prev => [...prev.map(l => ({ ...l, visible: false })), newList]);
                            setUploadedFiles(prev => prev.map(f => ({ ...f, visible: false })));
                            // Clear radius/draw if active
                            if (radiusMode || referencePoint || drawnArea) {
                              setRadiusMode(false);
                              setAwaitingMapClick(false);
                              setDrawMode(false);
                              clearRadius();
                              clearDrawnArea();
                            }
                            alert(`Saved "${listName}" with ${filteredCustomers.length} customers!`);
                          }}
                          style={{
                            width: '100%',
                            padding: '10px',
                            marginBottom: '12px',
                            background: 'rgba(139, 92, 246, 0.2)',
                            border: '1px solid rgba(139, 92, 246, 0.4)',
                            borderRadius: '8px',
                            color: '#c4b5fd',
                            fontSize: '12px',
                            fontWeight: 600,
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: '8px',
                            transition: 'all 0.2s'
                          }}
                          onMouseEnter={(e) => {
                            e.currentTarget.style.background = 'rgba(139, 92, 246, 0.3)';
                            e.currentTarget.style.borderColor = 'rgba(139, 92, 246, 0.6)';
                          }}
                          onMouseLeave={(e) => {
                            e.currentTarget.style.background = 'rgba(139, 92, 246, 0.2)';
                            e.currentTarget.style.borderColor = 'rgba(139, 92, 246, 0.4)';
                          }}
                        >
                          ðŸ’¾ Quick Save This List ({filteredCustomers.length})
                        </button>
                      )}
                      
                      {/* Multi-Sort Toggle Buttons */}
                      <div style={{ display: 'flex', gap: '6px', flexWrap: 'wrap', alignItems: 'center' }}>
                        {[
                          { key: 'lastService', label: 'Last Service' },
                          { key: 'distance', label: 'Distance' },
                          { key: 'panels', label: 'Panels' },
                          { key: 'zip', label: 'ZIP' }
                        ].map(opt => {
                          const isActive = activeSorts.includes(opt.key);
                          const sortIndex = activeSorts.indexOf(opt.key);
                          return (
                            <button
                              key={opt.key}
                              onClick={() => {
                                setActiveSorts(prev => 
                                  prev.includes(opt.key)
                                    ? prev.filter(k => k !== opt.key)
                                    : [...prev, opt.key]
                                );
                              }}
                              style={{
                                padding: '5px 10px',
                                borderRadius: '6px',
                                background: isActive ? 'rgba(139, 92, 246, 0.3)' : 'rgba(30, 41, 59, 0.5)',
                                border: `1px solid ${isActive ? 'rgba(139, 92, 246, 0.6)' : 'rgba(100, 116, 139, 0.3)'}`,
                                color: isActive ? '#c4b5fd' : '#94a3b8',
                                fontSize: '11px',
                                fontWeight: isActive ? 600 : 400,
                                cursor: 'pointer',
                                fontFamily: 'inherit',
                                transition: 'all 0.15s ease',
                                position: 'relative'
                              }}
                            >
                              {opt.label}
                              {isActive && activeSorts.length > 1 && (
                                <span style={{
                                  marginLeft: '4px',
                                  fontSize: '9px',
                                  background: 'rgba(139, 92, 246, 0.5)',
                                  borderRadius: '50%',
                                  width: '14px',
                                  height: '14px',
                                  display: 'inline-flex',
                                  alignItems: 'center',
                                  justifyContent: 'center',
                                  color: '#fff'
                                }}>{sortIndex + 1}</span>
                              )}
                            </button>
                          );
                        })}
                        {activeSorts.length > 0 && (
                          <button
                            onClick={() => setSortOrder(prev => prev === 'asc' ? 'desc' : 'asc')}
                            style={{
                              padding: '5px 8px', borderRadius: '6px',
                              background: 'rgba(139, 92, 246, 0.2)',
                              border: '1px solid rgba(139, 92, 246, 0.3)',
                              color: '#f1f5f9', fontSize: '12px',
                              cursor: 'pointer', fontWeight: 600, fontFamily: 'inherit'
                            }}
                            title={sortOrder === 'asc' ? 'Ascending' : 'Descending'}
                          >
                            {sortOrder === 'asc' ? 'â†‘' : 'â†“'}
                          </button>
                        )}
                      </div>
                    </div>
                    
                    {/* Scrollable List */}
                    <div className="scrollbar-custom" style={{ flex: 1, overflow: 'auto' }}>
                      {(() => {
                        // Show import message if no customers at all
                        if (customers.length === 0) {
                          return (
                            <div style={{
                              textAlign: 'center',
                              padding: '60px 20px',
                              color: '#94a3b8'
                            }}>
                              <div style={{ fontSize: '48px', marginBottom: '16px' }}>ðŸ“¡</div>
                              <div style={{ fontSize: '16px', fontWeight: 600, marginBottom: '8px', color: '#f1f5f9' }}>
                                No Customers Yet
                              </div>
                              <div style={{ fontSize: '13px', marginBottom: '20px' }}>
                                Upload a CSV file to get started.
                              </div>
                              <div style={{ fontSize: '12px', color: '#64748b' }}>
                                Use the upload button or drag and drop a CSV file.
                              </div>
                            </div>
                          );
                        }

                        const visibleInMap = mapBounds ? visibleCustomers : filteredCustomers;

                        if (visibleInMap.length === 0) {
                          return (
                            <div style={{
                              textAlign: 'center',
                              padding: '60px 20px',
                              color: '#64748b'
                            }}>
                              <div style={{ fontSize: '48px', marginBottom: '16px' }}>ðŸ”</div>
                              <div style={{ fontSize: '16px', fontWeight: 600, marginBottom: '8px' }}>
                                No customers match filters
                              </div>
                              <div style={{ fontSize: '13px' }}>
                                Try adjusting your filter settings
                              </div>
                            </div>
                          );
                        }
                        
                        return visibleInMap.map((customer, index) => {
                        const isHovered = hoveredCustomer?.id === customer.id;
                        const isSelected = selectedCustomer?.id === customer.id;
                        
                        return (
                          <div
                            key={customer.id}
                            draggable
                            onDragStart={(e) => {
                              e.dataTransfer.setData('customer', JSON.stringify(customer));
                              e.currentTarget.style.opacity = '0.5';
                            }}
                            onDragEnd={(e) => {
                              e.currentTarget.style.opacity = '1';
                            }}
                            onMouseEnter={() => setHoveredCustomer(customer)}
                            onMouseLeave={() => setHoveredCustomer(null)}
                            onClick={() => { setProfileCustomer(customer); setShowCustomerProfile(true); }}
                            style={{
                              padding: '16px 20px',
                              borderBottom: '1px solid rgba(139, 92, 246, 0.1)',
                              cursor: 'grab',
                              transition: 'all 0.2s ease',
                              background: isSelected ? 'rgba(139, 92, 246, 0.15)' : 
                                         isHovered ? 'rgba(139, 92, 246, 0.1)' : 
                                         'transparent',
                              borderLeft: isSelected ? '3px solid #8b5cf6' : '3px solid transparent',
                              position: 'relative'
                            }}
                          >
                            {/* Satellite Preview on Hover */}
                            {isHovered && (
                              <div style={{
                                position: 'absolute',
                                left: '-420px',
                                top: '0',
                                width: '320px',
                                background: 'rgba(15, 23, 42, 0.98)',
                                border: '2px solid rgba(139, 92, 246, 0.4)',
                                borderRadius: '12px',
                                overflow: 'hidden',
                                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)',
                                zIndex: 1000,
                                animation: 'fadeIn 0.2s ease'
                              }}>
                                {/* Satellite Image */}
                                <div style={{ position: 'relative' }}>
                                  {(() => {
                                    const zoom = 20;
                                    const x = Math.floor((customer.lng + 180) / 360 * Math.pow(2, zoom));
                                    const y = Math.floor((1 - Math.log(Math.tan(customer.lat * Math.PI / 180) + 1 / Math.cos(customer.lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom));
                                    return (
                                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', width: '100%' }}>
                                        <img src={`https://mt1.google.com/vt/lyrs=y&x=${x}&y=${y}&z=${zoom}`} style={{ width: '100%', display: 'block' }} alt="" />
                                        <img src={`https://mt1.google.com/vt/lyrs=y&x=${x+1}&y=${y}&z=${zoom}`} style={{ width: '100%', display: 'block' }} alt="" />
                                        <img src={`https://mt1.google.com/vt/lyrs=y&x=${x}&y=${y+1}&z=${zoom}`} style={{ width: '100%', display: 'block' }} alt="" />
                                        <img src={`https://mt1.google.com/vt/lyrs=y&x=${x+1}&y=${y+1}&z=${zoom}`} style={{ width: '100%', display: 'block' }} alt="" />
                                      </div>
                                    );
                                  })()}
                                  
                                  <div style={{
                                    position: 'absolute',
                                    top: '12px',
                                    left: '12px',
                                    background: 'rgba(0,0,0,0.8)',
                                    padding: '6px 12px',
                                    borderRadius: '6px',
                                    fontSize: '11px',
                                    fontWeight: 600
                                  }}>
                                    ðŸ›°ï¸ Satellite View
                                  </div>
                                </div>
                                
                                {/* Quick Info */}
                                <div style={{ padding: '16px' }}>
                                  <div
                                    onClick={(e) => { e.stopPropagation(); setProfileCustomer(customer); setShowCustomerProfile(true); }}
                                    style={{ fontSize: '14px', fontWeight: 600, marginBottom: '8px', cursor: 'pointer' }}
                                    onMouseOver={(e) => e.currentTarget.style.color = '#a78bfa'}
                                    onMouseOut={(e) => e.currentTarget.style.color = '#f1f5f9'}
                                  >
                                    {customer.name}
                                  </div>
                                  <div style={{ fontSize: '12px', color: '#94a3b8' }}>{customer.address}</div>
                                </div>
                              </div>
                            )}
                            
                            {/* Card Content */}
                            <div style={{ display: 'flex', gap: '12px', alignItems: 'flex-start' }}>
                              {/* Satellite Thumbnail */}
                              {(() => {
                                const zoom = 19;
                                const x = Math.floor((customer.lng + 180) / 360 * Math.pow(2, zoom));
                                const y = Math.floor((1 - Math.log(Math.tan(customer.lat * Math.PI / 180) + 1 / Math.cos(customer.lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom));
                                return (
                                  <div style={{
                                    width: '52px',
                                    height: '52px',
                                    borderRadius: '8px',
                                    overflow: 'hidden',
                                    flexShrink: 0,
                                    border: '1px solid rgba(139, 92, 246, 0.3)',
                                    background: '#0a0e27'
                                  }}>
                                    <img 
                                      src={`https://mt1.google.com/vt/lyrs=y&x=${x}&y=${y}&z=${zoom}`} 
                                      style={{ width: '100%', height: '100%', objectFit: 'cover', display: 'block' }} 
                                      alt=""
                                    />
                                  </div>
                                );
                              })()}
                              
                              {/* Info */}
                              <div style={{ flex: 1, minWidth: 0 }}>
                                <div
                                  onClick={(e) => { e.stopPropagation(); setProfileCustomer(customer); setShowCustomerProfile(true); }}
                                  style={{
                                    fontSize: '14px', fontWeight: 600, color: '#f1f5f9',
                                    overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap',
                                    cursor: 'pointer', marginBottom: '3px'
                                  }}
                                  onMouseOver={(e) => e.currentTarget.style.color = '#a78bfa'}
                                  onMouseOut={(e) => e.currentTarget.style.color = '#f1f5f9'}
                                >
                                  {customer.name}
                                </div>
                                {(customer.phone || customer.email) && (
                                  <div style={{ fontSize: '11px', color: '#94a3b8', marginBottom: '3px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                    {customer.phone && <span>{customer.phone}</span>}
                                    {customer.phone && customer.email && <span style={{ margin: '0 6px', color: '#475569' }}>|</span>}
                                    {customer.email && <span>{customer.email}</span>}
                                  </div>
                                )}
                                <div style={{ fontSize: '11px', color: '#64748b', marginBottom: '6px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                  {customer.address}
                                </div>
                                
                                {/* Tags - dynamically show based on active sorts */}
                                <div style={{ display: 'flex', gap: '5px', flexWrap: 'wrap' }}>
                                  {(customer.isRecurring || customer.recurring) && (
                                    <span style={{
                                      fontSize: '10px', padding: '2px 7px',
                                      background: 'rgba(59, 130, 246, 0.2)', border: '1px solid rgba(59, 130, 246, 0.4)',
                                      borderRadius: '4px', color: '#3b82f6', fontWeight: 600
                                    }}>
                                      Recurring
                                    </span>
                                  )}
                                  {customer.lastServiceDate && (
                                    <span style={{
                                      fontSize: '10px', padding: '2px 7px',
                                      background: 'rgba(100, 116, 139, 0.15)', border: '1px solid rgba(100, 116, 139, 0.25)',
                                      borderRadius: '4px', color: '#94a3b8'
                                    }}>
                                      Last: {new Date(customer.lastServiceDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' })}
                                    </span>
                                  )}
                                  {activeSorts.includes('panels') && (
                                    <span style={{
                                      fontSize: '10px', padding: '2px 7px',
                                      background: 'rgba(251, 191, 36, 0.15)', border: '1px solid rgba(251, 191, 36, 0.3)',
                                      borderRadius: '4px', color: '#fbbf24', fontWeight: 600
                                    }}>
                                      {parseInt(customer.panelCount || customer.totalPanels) || 0} panels
                                    </span>
                                  )}
                                  {activeSorts.includes('zip') && customer.zip && (
                                    <span style={{
                                      fontSize: '10px', padding: '2px 7px',
                                      background: 'rgba(34, 197, 94, 0.15)', border: '1px solid rgba(34, 197, 94, 0.3)',
                                      borderRadius: '4px', color: '#22c55e'
                                    }}>
                                      ZIP: {customer.zip}
                                    </span>
                                  )}
                                  {activeSorts.includes('distance') && homeBase && customer.lat && customer.lng && (() => {
                                    const R = 3959;
                                    const dLat = (customer.lat - homeBase.lat) * Math.PI / 180;
                                    const dLng = (customer.lng - homeBase.lng) * Math.PI / 180;
                                    const a2 = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(homeBase.lat * Math.PI / 180) * Math.cos(customer.lat * Math.PI / 180) * Math.sin(dLng/2) * Math.sin(dLng/2);
                                    const dist = R * 2 * Math.atan2(Math.sqrt(a2), Math.sqrt(1 - a2));
                                    return (
                                      <span style={{
                                        fontSize: '10px', padding: '2px 7px',
                                        background: 'rgba(236, 72, 153, 0.15)', border: '1px solid rgba(236, 72, 153, 0.3)',
                                        borderRadius: '4px', color: '#f472b6'
                                      }}>
                                        {dist.toFixed(1)} mi
                                      </span>
                                    );
                                  })()}
                                  {customer.scheduledDate && new Date(customer.scheduledDate) >= new Date(new Date().toDateString()) && (
                                    <span style={{
                                      fontSize: '10px', padding: '2px 7px',
                                      background: 'rgba(34, 197, 94, 0.15)', border: '1px solid rgba(34, 197, 94, 0.3)',
                                      borderRadius: '4px', color: '#22c55e', fontWeight: 600
                                    }}>
                                      Upcoming: {new Date(customer.scheduledDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                    </span>
                                  )}
                                  {customer.nextScheduledDate && (customer.isRecurring || customer.recurring) && (
                                    <span style={{
                                      fontSize: '10px', padding: '2px 7px',
                                      background: 'rgba(59, 130, 246, 0.15)', border: '1px solid rgba(59, 130, 246, 0.3)',
                                      borderRadius: '4px', color: '#3b82f6'
                                    }}>
                                      Next: {new Date(customer.nextScheduledDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                    </span>
                                  )}
                                </div>
                              </div>
                              
                              {/* Actions */}
                              <div style={{
                                display: 'flex', flexDirection: 'column', gap: '4px', flexShrink: 0,
                                opacity: isHovered ? 1 : 0.3, transition: 'opacity 0.2s ease'
                              }}>
                                <button
                                  onClick={(e) => { e.stopPropagation(); openJobPopupForCustomer(customer); }}
                                  style={{
                                    padding: '4px 8px', borderRadius: '4px',
                                    background: 'rgba(34, 197, 94, 0.1)', border: '1px solid rgba(34, 197, 94, 0.3)',
                                    color: '#22c55e', fontSize: '10px', fontWeight: 600,
                                    cursor: 'pointer', fontFamily: 'inherit', whiteSpace: 'nowrap'
                                  }}
                                  title="Add Job"
                                >
                                  + Job
                                </button>
                                <div style={{ color: '#8b5cf6', fontSize: '18px', textAlign: 'center' }}>
                                  â†’
                                </div>
                              </div>
                            </div>
                          </div>
                        );
                      })})()}
                    </div>
                      </>
                    )}
                  </div>
                )}
                
                {/* Selected Customer Detail Modal */}
                {selectedCustomer && (
                  <div
                    style={{
                      position: 'fixed',
                      top: 0,
                      left: 0,
                      right: 0,
                      bottom: 0,
                      background: 'rgba(0, 0, 0, 0.7)',
                      backdropFilter: 'blur(4px)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      zIndex: 10000,
                      animation: 'fadeIn 0.2s ease'
                    }}
                    onClick={() => setSelectedCustomer(null)}
                  >
                    <div
                      onClick={(e) => e.stopPropagation()}
                      style={{
                        width: '500px',
                        maxHeight: '90vh',
                        background: 'rgba(15, 23, 42, 0.98)',
                        backdropFilter: 'blur(20px)',
                        border: '2px solid rgba(139, 92, 246, 0.3)',
                        borderRadius: '16px',
                        overflow: 'hidden',
                        boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)',
                        display: 'flex',
                        flexDirection: 'column'
                      }}
                    >
                      {/* Modal Header */}
                      <div style={{
                        padding: '20px 24px',
                        borderBottom: '1px solid rgba(139, 92, 246, 0.2)',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        background: 'rgba(139, 92, 246, 0.05)'
                      }}>
                        <h3 style={{ fontSize: '18px', fontWeight: 700, margin: 0 }}>Site Details</h3>
                        <button
                          onClick={() => setSelectedCustomer(null)}
                          style={{
                            background: 'transparent',
                            border: 'none',
                            color: '#94a3b8',
                            cursor: 'pointer',
                            fontSize: '24px',
                            padding: 0,
                            lineHeight: 1
                          }}
                        >
                          Ã—
                        </button>
                      </div>
                      
                      {/* Scrollable Content */}
                      <div className="scrollbar-custom" style={{ flex: 1, overflow: 'auto', padding: '24px' }}>
                        {/* Satellite Image */}
                        <div style={{ marginBottom: '24px' }}>
                          <div style={{
                            background: 'rgba(139, 92, 246, 0.05)',
                            borderRadius: '12px',
                            overflow: 'hidden',
                            border: '2px solid rgba(139, 92, 246, 0.2)',
                            position: 'relative'
                          }}>
                            {(() => {
                              const zoom = 20;
                              const x = Math.floor((selectedCustomer.lng + 180) / 360 * Math.pow(2, zoom));
                              const y = Math.floor((1 - Math.log(Math.tan(selectedCustomer.lat * Math.PI / 180) + 1 / Math.cos(selectedCustomer.lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom));
                              return (
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', width: '100%' }}>
                                  <img src={`https://mt1.google.com/vt/lyrs=y&x=${x}&y=${y}&z=${zoom}`} style={{ width: '100%', display: 'block' }} alt="" />
                                  <img src={`https://mt1.google.com/vt/lyrs=y&x=${x+1}&y=${y}&z=${zoom}`} style={{ width: '100%', display: 'block' }} alt="" />
                                  <img src={`https://mt1.google.com/vt/lyrs=y&x=${x}&y=${y+1}&z=${zoom}`} style={{ width: '100%', display: 'block' }} alt="" />
                                  <img src={`https://mt1.google.com/vt/lyrs=y&x=${x+1}&y=${y+1}&z=${zoom}`} style={{ width: '100%', display: 'block' }} alt="" />
                                </div>
                              );
                            })()}
                            {/* Solar Verification Badge */}
                            {selectedCustomer.solarVerified === 'yes' && (
                              <div style={{
                                position: 'absolute',
                                top: '16px',
                                right: '16px',
                                background: 'rgba(251, 191, 36, 0.95)',
                                borderRadius: '50%',
                                width: '36px',
                                height: '36px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '18px',
                                fontWeight: 700,
                                color: '#000',
                                boxShadow: '0 4px 12px rgba(0,0,0,0.4)'
                              }}>
                                âœ“
                              </div>
                            )}
                            {selectedCustomer.solarVerified === 'no' && (
                              <div style={{
                                position: 'absolute',
                                top: '16px',
                                right: '16px',
                                background: 'rgba(239, 68, 68, 0.95)',
                                borderRadius: '50%',
                                width: '36px',
                                height: '36px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '18px',
                                fontWeight: 700,
                                color: '#fff',
                                boxShadow: '0 4px 12px rgba(0,0,0,0.4)'
                              }}>
                                âœ•
                              </div>
                            )}
                          </div>
                        </div>
                        
                        {/* Customer Info */}
                        <div style={{ marginBottom: '20px' }}>
                          <div style={{ fontSize: '20px', fontWeight: 700, marginBottom: '12px' }}>{selectedCustomer.name}</div>
                          <div style={{ fontSize: '14px', color: '#94a3b8', marginBottom: '16px' }}>ðŸ“ {selectedCustomer.address}</div>
                          
                          {/* Verification Status */}
                          <div style={{ marginBottom: '16px' }}>
                            {selectedCustomer.solarVerified === 'yes' && (
                              <div style={{
                                padding: '12px 16px',
                                background: 'rgba(251, 191, 36, 0.1)',
                                border: '1px solid rgba(251, 191, 36, 0.3)',
                                borderRadius: '8px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px'
                              }}>
                                <span style={{ fontSize: '20px' }}>âœ“</span>
                                <span style={{ fontSize: '14px', color: '#fbbf24', fontWeight: 600 }}>Has Solar</span>
                              </div>
                            )}
                            {selectedCustomer.solarVerified === 'no' && (
                              <div style={{
                                padding: '12px 16px',
                                background: 'rgba(239, 68, 68, 0.1)',
                                border: '1px solid rgba(239, 68, 68, 0.3)',
                                borderRadius: '8px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px'
                              }}>
                                <span style={{ fontSize: '20px' }}>âŒ</span>
                                <span style={{ fontSize: '14px', color: '#ef4444', fontWeight: 600 }}>No Solar</span>
                              </div>
                            )}
                            {!selectedCustomer.solarVerified && (
                              <div style={{
                                padding: '12px 16px',
                                background: 'rgba(139, 92, 246, 0.1)',
                                border: '1px solid rgba(139, 92, 246, 0.3)',
                                borderRadius: '8px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px'
                              }}>
                                <span style={{ fontSize: '20px' }}>ðŸ”</span>
                                <span style={{ fontSize: '14px', color: '#c4b5fd', fontWeight: 600 }}>Not Confirmed</span>
                              </div>
                            )}
                          </div>
                          
                          {/* Status Section with Dropdown */}
                          <div style={{ marginBottom: '16px' }}>
                            <div style={{
                              padding: '12px 16px',
                              background: selectedCustomer.status === 'unscheduled' ? 'rgba(239, 68, 68, 0.1)' :
                                         selectedCustomer.status === 'scheduled' ? 'rgba(251, 191, 36, 0.1)' :
                                         'rgba(100, 116, 139, 0.1)',
                              border: selectedCustomer.status === 'unscheduled' ? '1px solid rgba(239, 68, 68, 0.3)' :
                                     selectedCustomer.status === 'scheduled' ? '1px solid rgba(251, 191, 36, 0.3)' :
                                     '1px solid rgba(100, 116, 139, 0.3)',
                              borderRadius: '8px',
                              marginBottom: '12px'
                            }}>
                              <div style={{ fontSize: '11px', color: '#64748b', marginBottom: '6px', fontWeight: 600 }}>
                                STATUS
                              </div>
                              <select
                                value={selectedCustomer.status || ''}
                                onChange={(e) => {
                                  const newStatus = e.target.value;
                                  if (newStatus === 'unscheduled' && !customerHasOpenJobs(selectedCustomer)) {
                                    alert('Cannot set to Unscheduled â€” this customer has no open jobs. Add a job first.');
                                    return;
                                  }
                                  setCustomers(prev => prev.map(c =>
                                    c.id === selectedCustomer.id ? { ...c, status: newStatus } : c
                                  ));
                                  setSelectedCustomer(prev => ({ ...prev, status: newStatus }));
                                  propagateCustomerUpdate(selectedCustomer.id, { status: newStatus });
                                }}
                                style={{
                                  width: '100%',
                                  padding: '10px 12px',
                                  background: 'rgba(15, 23, 42, 0.8)',
                                  border: '1px solid rgba(139, 92, 246, 0.3)',
                                  borderRadius: '6px',
                                  color: '#f1f5f9',
                                  fontSize: '14px',
                                  fontWeight: 600,
                                  cursor: 'pointer'
                                }}
                              >
                                <option value="">âšª No Status</option>
                                <option value="unscheduled">ðŸ”´ Unscheduled</option>
                                <option value="scheduled">ðŸŸ¡ Scheduled</option>
                              </select>

                              {selectedCustomer.scheduledDate && (
                                <div style={{ marginTop: '10px', padding: '8px 10px', background: 'rgba(34, 197, 94, 0.1)', border: '1px solid rgba(34, 197, 94, 0.2)', borderRadius: '8px' }}>
                                  <div style={{ fontSize: '12px', color: '#4ade80', fontWeight: 600 }}>
                                    ðŸ“… Scheduled: {new Date(selectedCustomer.scheduledDate).toLocaleDateString('en-US', {
                                      weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'
                                    })}
                                    {selectedCustomer.scheduledTime && (
                                      <span style={{ marginLeft: '8px', color: '#fbbf24' }}>
                                        ðŸ• {new Date(`2000-01-01T${selectedCustomer.scheduledTime}`).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}
                                      </span>
                                    )}
                                  </div>
                                </div>
                              )}
                              {selectedCustomer.status === 'unscheduled' && (
                                <div style={{ marginTop: '10px' }}>
                                  {selectedCustomer.preferredDate && (
                                    <div style={{ fontSize: '12px', color: '#94a3b8', marginBottom: '4px' }}>
                                      <strong style={{ color: '#fca5a5' }}>Preferred Date:</strong>{' '}
                                      {new Date(selectedCustomer.preferredDate).toLocaleDateString('en-US', {
                                        weekday: 'short',
                                        month: 'short',
                                        day: 'numeric',
                                        year: 'numeric'
                                      })}
                                    </div>
                                  )}
                                  {selectedCustomer.preferredTimeWindow && (
                                    <div style={{ fontSize: '12px', color: '#94a3b8' }}>
                                      <strong style={{ color: '#fca5a5' }}>Preferred Time:</strong>{' '}
                                      {selectedCustomer.preferredTimeWindow === 'morning' ? 'ðŸŒ… Morning (8am-12pm)' :
                                       selectedCustomer.preferredTimeWindow === 'afternoon' ? 'â˜€ï¸ Afternoon (12pm-4pm)' :
                                       selectedCustomer.preferredTimeWindow === 'evening' ? 'ðŸŒ† Evening (4pm-8pm)' :
                                       selectedCustomer.preferredTimeWindow}
                                    </div>
                                  )}
                                </div>
                              )}
                            </div>
                          </div>
                          
                          {/* Details Grid */}
                          <div style={{ display: 'grid', gap: '12px' }}>
                            {selectedCustomer.panelCount && (
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <span style={{ fontSize: '18px' }}>â˜€ï¸</span>
                                <span style={{ fontSize: '13px', color: '#94a3b8' }}>{selectedCustomer.panelCount} panels</span>
                              </div>
                            )}
                            {selectedCustomer.email && (
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <span style={{ fontSize: '18px' }}>ðŸ“§</span>
                                <span style={{ fontSize: '13px', color: '#94a3b8' }}>{selectedCustomer.email}</span>
                              </div>
                            )}
                            {selectedCustomer.phone && (
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <span style={{ fontSize: '18px' }}>ðŸ“±</span>
                                <span style={{ fontSize: '13px', color: '#94a3b8' }}>{selectedCustomer.phone}</span>
                              </div>
                            )}
                          </div>
                        </div>
                        
                        {/* Actions */}
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                          <button
                            className="button-primary"
                            onClick={() => {
                              handleCustomerClick(selectedCustomer);
                              setSelectedCustomer(null);
                            }}
                            style={{ width: '100%', justifyContent: 'center', padding: '14px' }}
                          >
                            {route.some(r => r.id === selectedCustomer.id) ? 'âŒ âŒ Remove from Route' : 'âž• ðŸ›¸ Add to Route'}
                          </button>
                          
                          {/* Manual Verification */}
                          {!verificationEditMode ? (
                            <div 
                              onClick={() => setVerificationEditMode(true)}
                              onMouseEnter={(e) => e.currentTarget.querySelector('.edit-icon').style.opacity = '1'}
                              onMouseLeave={(e) => e.currentTarget.querySelector('.edit-icon').style.opacity = '0'}
                              style={{
                                padding: '12px 16px',
                                background: selectedCustomer.solarVerified === 'yes' ? 'rgba(251, 191, 36, 0.1)' :
                                           selectedCustomer.solarVerified === 'no' ? 'rgba(239, 68, 68, 0.1)' :
                                           'rgba(139, 92, 246, 0.1)',
                                border: selectedCustomer.solarVerified === 'yes' ? '1px solid rgba(251, 191, 36, 0.3)' :
                                       selectedCustomer.solarVerified === 'no' ? '1px solid rgba(239, 68, 68, 0.3)' :
                                       '1px solid rgba(139, 92, 246, 0.3)',
                                borderRadius: '8px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between',
                                cursor: 'pointer',
                                transition: 'all 0.2s'
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <span style={{ fontSize: '20px' }}>
                                  {selectedCustomer.solarVerified === 'yes' ? 'âœ“' :
                                   selectedCustomer.solarVerified === 'no' ? 'âŒ' : 'ðŸ”'}
                                </span>
                                <span style={{ 
                                  fontSize: '14px', 
                                  fontWeight: 600,
                                  color: selectedCustomer.solarVerified === 'yes' ? '#fbbf24' :
                                         selectedCustomer.solarVerified === 'no' ? '#ef4444' :
                                         '#c4b5fd'
                                }}>
                                  {selectedCustomer.solarVerified === 'yes' ? 'Has Solar' :
                                   selectedCustomer.solarVerified === 'no' ? 'No Solar' :
                                   'Not Confirmed'}
                                </span>
                              </div>
                              <span className="edit-icon" style={{ fontSize: '16px', opacity: 0, transition: 'opacity 0.2s' }}>âœï¸</span>
                            </div>
                          ) : (
                            <div style={{
                              padding: '16px',
                              background: 'rgba(139, 92, 246, 0.05)',
                              border: '1px solid rgba(139, 92, 246, 0.2)',
                              borderRadius: '8px'
                            }}>
                              <div style={{ fontSize: '12px', fontWeight: 600, color: '#c4b5fd', marginBottom: '8px' }}>
                                Select Solar Status:
                              </div>
                              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '8px' }}>
                                <button
                                  className="button-secondary"
                                  onClick={() => {
                                    markVerified(selectedCustomer.id, 'yes');
                                    setSelectedCustomer(prev => ({ ...prev, solarVerified: 'yes' }));
                                    setVerificationEditMode(false);
                                  }}
                                  style={{ 
                                    background: 'rgba(251, 191, 36, 0.1)', 
                                    borderColor: 'rgba(251, 191, 36, 0.3)', 
                                    color: '#fbbf24', 
                                    padding: '10px', 
                                    fontSize: '12px' 
                                  }}
                                >
                                  âœ“ Yes
                                </button>
                                <button
                                  className="button-secondary"
                                  onClick={() => {
                                    markVerified(selectedCustomer.id, 'no');
                                    setSelectedCustomer(prev => ({ ...prev, solarVerified: 'no' }));
                                    setVerificationEditMode(false);
                                  }}
                                  style={{ 
                                    background: 'rgba(239, 68, 68, 0.1)', 
                                    borderColor: 'rgba(239, 68, 68, 0.3)', 
                                    color: '#ef4444', 
                                    padding: '10px', 
                                    fontSize: '12px' 
                                  }}
                                >
                                  âŒ No
                                </button>
                                <button
                                  className="button-secondary"
                                  onClick={() => {
                                    markVerified(selectedCustomer.id, null);
                                    setSelectedCustomer(prev => ({ ...prev, solarVerified: null }));
                                    setVerificationEditMode(false);
                                  }}
                                  style={{ 
                                    background: 'rgba(139, 92, 246, 0.1)', 
                                    borderColor: 'rgba(139, 92, 246, 0.3)', 
                                    color: '#8b5cf6', 
                                    padding: '10px', 
                                    fontSize: '12px' 
                                  }}
                                >
                                  ðŸ” Not Confirmed
                                </button>
                              </div>
                            </div>
                          )}
                          
                          {/* Existing Job Info - Show if marked as existing */}
                          {selectedCustomer.existingJob && (
                            <div style={{
                              padding: '16px',
                              background: 'rgba(34, 197, 94, 0.1)',
                              border: '1px solid rgba(34, 197, 94, 0.3)',
                              borderRadius: '8px',
                              marginTop: '12px'
                            }}>
                              <div style={{ 
                                fontSize: '13px', 
                                fontWeight: 700, 
                                color: '#22c55e', 
                                marginBottom: '12px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                              }}>
                                ðŸ¦• KNOWN CONTACT INTEL
                              </div>
                              
                              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                {selectedCustomer.totalPanels && (
                                  <div style={{ fontSize: '12px', color: '#94a3b8' }}>
                                    <strong style={{ color: '#22c55e' }}>Total Panels:</strong> {selectedCustomer.totalPanels}
                                  </div>
                                )}
                                {selectedCustomer.lastServiceDate && (
                                  <div style={{ fontSize: '12px', color: '#94a3b8' }}>
                                    <strong style={{ color: '#22c55e' }}>Last Customer:</strong> {new Date(selectedCustomer.lastServiceDate).toLocaleDateString()}
                                  </div>
                                )}
                                {selectedCustomer.amountPaid && (
                                  <div style={{ fontSize: '12px', color: '#94a3b8' }}>
                                    <strong style={{ color: '#22c55e' }}>Last Payment:</strong> ${parseFloat(selectedCustomer.amountPaid || 0).toFixed(2)}
                                  </div>
                                )}
                                {selectedCustomer.isRecurring && (
                                  <div style={{ fontSize: '12px', color: '#22c55e', fontWeight: 600 }}>
                                    ðŸŒ€ Recurring Customer
                                  </div>
                                )}
                              </div>
                            </div>
                          )}
                          
                          {/* Service History Section */}
                          {selectedCustomer.serviceHistory && selectedCustomer.serviceHistory.length > 0 && (
                            <div style={{
                              padding: '16px',
                              background: 'rgba(34, 197, 94, 0.1)',
                              border: '1px solid rgba(34, 197, 94, 0.3)',
                              borderRadius: '8px',
                              marginTop: '12px'
                            }}>
                              <div style={{ 
                                fontSize: '13px', 
                                fontWeight: 700, 
                                color: '#22c55e', 
                                marginBottom: '12px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                              }}>
                                ðŸ“‹ SERVICE HISTORY ({selectedCustomer.serviceHistory.length})
                              </div>
                              
                              <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                {selectedCustomer.serviceHistory.slice().reverse().map((job, index) => (
                                  <div 
                                    key={job.id}
                                    style={{
                                      padding: '12px',
                                      background: 'rgba(15, 23, 42, 0.5)',
                                      border: '1px solid rgba(34, 197, 94, 0.3)',
                                      borderRadius: '8px'
                                    }}
                                  >
                                    {/* Job Header */}
                                    <div style={{ marginBottom: '8px' }}>
                                      <div style={{ fontSize: '12px', fontWeight: 600, color: '#f1f5f9', marginBottom: '2px' }}>
                                        {job.jobType || 'Panel Cleaning'}
                                      </div>
                                      <div style={{ fontSize: '10px', color: '#94a3b8' }}>
                                        ðŸ“… {new Date(job.date).toLocaleDateString('en-US', { 
                                          month: 'short', 
                                          day: 'numeric', 
                                          year: 'numeric' 
                                        })}
                                      </div>
                                    </div>
                                    
                                    {/* Job Details Grid */}
                                    <div style={{ 
                                      display: 'grid', 
                                      gridTemplateColumns: '1fr 1fr',
                                      gap: '6px',
                                      marginBottom: '8px'
                                    }}>
                                      {job.cost > 0 && (
                                        <div style={{ fontSize: '11px', color: '#94a3b8' }}>
                                          <strong style={{ color: '#22c55e' }}>ðŸ’µ Cost:</strong> ${parseFloat(job.cost).toFixed(2)}
                                        </div>
                                      )}
                                      {job.panelCount > 0 && (
                                        <div style={{ fontSize: '11px', color: '#94a3b8' }}>
                                          <strong style={{ color: '#fbbf24' }}>â˜€ï¸ Panels:</strong> {job.panelCount}
                                        </div>
                                      )}
                                      {job.routeName && (
                                        <div style={{ fontSize: '11px', color: '#94a3b8', gridColumn: '1 / -1' }}>
                                          <strong style={{ color: '#8b5cf6' }}>ðŸ—ºï¸ Route:</strong> {job.routeName}
                                        </div>
                                      )}
                                    </div>
                                    
                                    {/* Notes */}
                                    {job.customerNotes && (
                                      <div style={{
                                        padding: '8px',
                                        background: 'rgba(139, 92, 246, 0.1)',
                                        border: '1px solid rgba(139, 92, 246, 0.2)',
                                        borderRadius: '4px',
                                        fontSize: '10px',
                                        color: '#c4b5fd',
                                        lineHeight: '1.5',
                                        marginTop: '6px'
                                      }}>
                                        <strong>ðŸ“ Notes:</strong> {job.customerNotes}
                                      </div>
                                    )}
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}
                          
                          {/* Past Notes Section (separate from service history) */}
                          {selectedCustomer.notesHistory && selectedCustomer.notesHistory.length > 0 && (
                            <div style={{
                              padding: '16px',
                              background: 'rgba(139, 92, 246, 0.1)',
                              border: '1px solid rgba(139, 92, 246, 0.3)',
                              borderRadius: '8px',
                              marginTop: '12px'
                            }}>
                              <div style={{ 
                                fontSize: '13px', 
                                fontWeight: 700, 
                                color: '#8b5cf6', 
                                marginBottom: '12px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                              }}>
                                ðŸ“ NOTES HISTORY
                              </div>
                              
                              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                {selectedCustomer.notesHistory.slice().reverse().map((noteEntry) => (
                                  <div 
                                    key={noteEntry.id}
                                    style={{
                                      padding: '10px',
                                      background: 'rgba(15, 23, 42, 0.4)',
                                      border: '1px solid rgba(139, 92, 246, 0.2)',
                                      borderRadius: '6px'
                                    }}
                                  >
                                    <div style={{ fontSize: '10px', color: '#94a3b8', marginBottom: '4px' }}>
                                      {new Date(noteEntry.date).toLocaleDateString()} - {noteEntry.addedBy}
                                    </div>
                                    <div style={{ fontSize: '11px', color: '#c4b5fd', lineHeight: '1.5' }}>
                                      {noteEntry.note}
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}
                          
                          {/* Mark as Existing Button */}
                          <button
                            onClick={() => {
                              // Pre-populate form with existing values
                              setExistingJobData({
                                totalPanels: selectedCustomer.totalPanels || '',
                                lastServiceDate: selectedCustomer.lastServiceDate || '',
                                amountPaid: selectedCustomer.amountPaid || '',
                                isRecurring: selectedCustomer.isRecurring || false,
                                nextScheduledDate: selectedCustomer.nextScheduledDate || ''
                              });
                              setShowExistingJobModal(true);
                            }}
                            style={{
                              width: '100%',
                              padding: '14px',
                              background: selectedCustomer.existingJob 
                                ? 'rgba(34, 197, 94, 0.2)' 
                                : 'rgba(139, 92, 246, 0.1)',
                              border: selectedCustomer.existingJob
                                ? '2px solid rgba(34, 197, 94, 0.5)'
                                : '2px solid rgba(139, 92, 246, 0.3)',
                              borderRadius: '12px',
                              color: selectedCustomer.existingJob ? '#22c55e' : '#c4b5fd',
                              fontSize: '14px',
                              fontWeight: 700,
                              cursor: 'pointer',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              gap: '8px',
                              transition: 'all 0.2s',
                              marginTop: '8px'
                            }}
                          >
                            {selectedCustomer.existingJob ? 'ðŸ¦• Known Customer' : 'ðŸ¦• Mark as Known Customer'}
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
                
                {/* Existing Job Modal */}
                {showExistingJobModal && (
                  <div
                    style={{
                      position: 'fixed',
                      top: 0,
                      left: 0,
                      right: 0,
                      bottom: 0,
                      background: 'rgba(0, 0, 0, 0.7)',
                      backdropFilter: 'blur(4px)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      zIndex: 10001,
                      animation: 'fadeIn 0.2s ease'
                    }}
                    onClick={() => setShowExistingJobModal(false)}
                  >
                    <div
                      onClick={(e) => e.stopPropagation()}
                      style={{
                        width: '480px',
                        maxHeight: '90vh',
                        background: 'rgba(15, 23, 42, 0.98)',
                        backdropFilter: 'blur(20px)',
                        border: '2px solid rgba(139, 92, 246, 0.3)',
                        borderRadius: '16px',
                        overflow: 'hidden',
                        boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)',
                        display: 'flex',
                        flexDirection: 'column'
                      }}
                    >
                      {/* Header */}
                      <div style={{
                        padding: '24px',
                        borderBottom: '1px solid rgba(34, 197, 94, 0.2)',
                        background: 'rgba(34, 197, 94, 0.05)'
                      }}>
                        <h2 style={{ fontSize: '20px', fontWeight: 700, margin: 0, color: '#f1f5f9' }}>
                          ðŸ¦• Past Customer Details
                        </h2>
                        <p style={{ fontSize: '13px', color: '#94a3b8', margin: '8px 0 0 0' }}>
                          {selectedCustomer?.name} - {selectedCustomer?.address}
                        </p>
                      </div>

                      {/* Form */}
                      <div style={{ 
                        padding: '24px', 
                        overflowY: 'auto',
                        flex: 1
                      }} className="scrollbar-custom">
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
                          
                          {/* Total Panels */}
                          <div>
                            <label style={{ 
                              fontSize: '13px', 
                              color: '#94a3b8', 
                              fontWeight: 600, 
                              marginBottom: '8px', 
                              display: 'block' 
                            }}>
                              Total Panels
                            </label>
                            <input
                              type="number"
                              value={existingJobData.totalPanels}
                              onChange={(e) => setExistingJobData(prev => ({ ...prev, totalPanels: e.target.value }))}
                              placeholder="e.g., 24"
                              min="0"
                              style={{
                                width: '100%',
                                padding: '12px',
                                background: 'rgba(30, 41, 59, 0.5)',
                                border: '1px solid rgba(34, 197, 94, 0.3)',
                                borderRadius: '8px',
                                color: '#f1f5f9',
                                fontSize: '14px',
                                outline: 'none'
                              }}
                            />
                          </div>

                          {/* Last Service Date */}
                          <div>
                            <label style={{ 
                              fontSize: '13px', 
                              color: '#94a3b8', 
                              fontWeight: 600, 
                              marginBottom: '8px', 
                              display: 'block' 
                            }}>
                              Last Service Date
                            </label>
                            <input
                              type="date"
                              value={existingJobData.lastServiceDate}
                              onChange={(e) => setExistingJobData(prev => ({ ...prev, lastServiceDate: e.target.value }))}
                              style={{
                                width: '100%',
                                padding: '12px',
                                background: 'rgba(30, 41, 59, 0.5)',
                                border: '1px solid rgba(34, 197, 94, 0.3)',
                                borderRadius: '8px',
                                color: '#f1f5f9',
                                fontSize: '14px',
                                outline: 'none'
                              }}
                            />
                          </div>

                          {/* Amount Paid */}
                          <div>
                            <label style={{ 
                              fontSize: '13px', 
                              color: '#94a3b8', 
                              fontWeight: 600, 
                              marginBottom: '8px', 
                              display: 'block' 
                            }}>
                              Amount Paid on Last Service
                            </label>
                            <div style={{ position: 'relative' }}>
                              <span style={{
                                position: 'absolute',
                                left: '12px',
                                top: '50%',
                                transform: 'translateY(-50%)',
                                color: '#94a3b8',
                                fontSize: '14px'
                              }}>
                                $
                              </span>
                              <input
                                type="number"
                                value={existingJobData.amountPaid}
                                onChange={(e) => setExistingJobData(prev => ({ ...prev, amountPaid: e.target.value }))}
                                placeholder="0.00"
                                min="0"
                                step="0.01"
                                style={{
                                  width: '100%',
                                  padding: '12px 12px 12px 28px',
                                  background: 'rgba(30, 41, 59, 0.5)',
                                  border: '1px solid rgba(139, 92, 246, 0.3)',
                                  borderRadius: '8px',
                                  color: '#f1f5f9',
                                  fontSize: '14px',
                                  outline: 'none'
                                }}
                              />
                            </div>
                          </div>

                          {/* Next Scheduled Service Date */}
                          {false && (
                            <div>
                              <label style={{ 
                                fontSize: '13px', 
                                color: '#94a3b8', 
                                fontWeight: 600, 
                                marginBottom: '8px', 
                                display: 'block' 
                              }}>
                                Next Scheduled Service Date
                              </label>
                              <input
                                type="date"
                                value={existingJobData.nextScheduledDate}
                                onChange={(e) => setExistingJobData(prev => ({ ...prev, nextScheduledDate: e.target.value }))}
                                style={{
                                  width: '100%',
                                  padding: '12px',
                                  background: 'rgba(30, 41, 59, 0.5)',
                                  border: '1px solid rgba(59, 130, 246, 0.3)',
                                  borderRadius: '8px',
                                  color: '#f1f5f9',
                                  fontSize: '14px',
                                  outline: 'none'
                                }}
                              />
                            </div>
                          )}

                          {/* Info Box */}
                          <div style={{
                            padding: '14px',
                            background: 'rgba(139, 92, 246, 0.1)',
                            border: '1px solid rgba(139, 92, 246, 0.3)',
                            borderRadius: '8px',
                            fontSize: '12px',
                            color: '#c4b5fd',
                            lineHeight: 1.6
                          }}>
                            ðŸ’¡ <strong>Note:</strong> All fields are optional. Fill out what you know and update later if needed.
                          </div>
                        </div>
                      </div>

                      {/* Footer Buttons */}
                      <div style={{
                        padding: '20px 24px',
                        borderTop: '1px solid rgba(139, 92, 246, 0.2)',
                        background: 'rgba(15, 23, 42, 0.8)',
                        display: 'flex',
                        gap: '12px'
                      }}>
                        <button
                          onClick={() => {
                            setShowExistingJobModal(false);
                            setExistingJobData({
                              totalPanels: '',
                              lastServiceDate: '',
                              amountPaid: '',
                              isRecurring: false,
                              nextScheduledDate: ''
                            });
                          }}
                          style={{
                            flex: 1,
                            padding: '14px',
                            background: 'rgba(100, 116, 139, 0.2)',
                            border: '1px solid rgba(100, 116, 139, 0.3)',
                            borderRadius: '10px',
                            color: '#94a3b8',
                            fontSize: '14px',
                            fontWeight: 600,
                            cursor: 'pointer'
                          }}
                        >
                          Cancel
                        </button>
                        <button
                          onClick={handleMarkExisting}
                          style={{
                            flex: 1,
                            padding: '14px',
                            background: 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',
                            border: 'none',
                            borderRadius: '10px',
                            color: '#fff',
                            fontSize: '14px',
                            fontWeight: 700,
                            cursor: 'pointer',
                            boxShadow: '0 4px 12px rgba(139, 92, 246, 0.4)'
                          }}
                        >
                          âœ… Submit
                        </button>
                      </div>
                    </div>
                  </div>
                )}
                
                {loading && (
                  <div style={{
                    position: 'absolute',
                    top: '50%',
                    left: '50%',
                    transform: 'translate(-50%, -50%)',
                    background: 'rgba(15, 23, 42, 0.98)',
                    backdropFilter: 'blur(20px)',
                    padding: '32px 48px',
                    borderRadius: '24px',
                    border: '1px solid rgba(139, 92, 246, 0.3)',
                    textAlign: 'center',
                    boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)'
                  }}>
                    <div style={{ width: '40px', height: '40px', border: '4px solid rgba(139, 92, 246, 0.2)', borderTopColor: '#8b5cf6', borderRadius: '50%', animation: 'spin 1s linear infinite', margin: '0 auto 16px' }}></div>
                    <div style={{ fontSize: '15px', fontWeight: 600 }}>Processing...</div>
                  </div>
                )}
              </div>
            </div>


            {/* ðŸ‘¤ Customer Profile Modal */}
            {showCustomerProfile && profileCustomer && (
              <div
                style={{
                  position: 'fixed',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  background: 'rgba(0, 0, 0, 0.85)',
                  backdropFilter: 'blur(8px)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  zIndex: 10005,
                  animation: 'fadeIn 0.2s ease'
                }}
                onClick={() => { setShowCustomerProfile(false); setProfileCustomer(null); setConfirmDeleteCustomer(false); }}
              >
                <div
                  onClick={(e) => e.stopPropagation()}
                  style={{
                    width: '100%',
                    maxWidth: '800px',
                    maxHeight: '90vh',
                    background: 'rgba(15, 23, 42, 0.98)',
                    backdropFilter: 'blur(20px)',
                    border: '2px solid rgba(139, 92, 246, 0.3)',
                    borderRadius: '16px',
                    overflow: 'hidden',
                    boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)',
                    display: 'flex',
                    flexDirection: 'column'
                  }}
                >
                  {/* Header */}
                  <div style={{
                    padding: '20px 24px',
                    background: 'linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(99, 102, 241, 0.1))',
                    borderBottom: '1px solid rgba(139, 92, 246, 0.2)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between'
                  }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px', flex: 1 }}>
                      <div style={{ fontSize: '28px' }}>
                        {(profileCustomer.isRecurring || profileCustomer.recurring === 'TRUE') ? 'ðŸ¦–' : 'ðŸ‘¤'}
                      </div>
                      <div style={{ flex: 1 }}>
                        <input
                          type="text"
                          value={profileCustomer.name || ''}
                          onChange={(e) => {
                            const updatedCustomer = { ...profileCustomer, name: e.target.value };
                            propagateCustomerUpdate(profileCustomer.id, { name: e.target.value });
                            setProfileCustomer(updatedCustomer);
                          }}
                          style={{
                            margin: 0,
                            fontSize: '20px',
                            fontWeight: 700,
                            color: '#f1f5f9',
                            background: 'transparent',
                            border: '1px solid transparent',
                            borderRadius: '6px',
                            padding: '4px 8px',
                            width: '100%',
                            maxWidth: '400px',
                            transition: 'border-color 0.2s'
                          }}
                          onFocus={(e) => e.target.style.borderColor = 'rgba(139, 92, 246, 0.5)'}
                          onBlur={(e) => e.target.style.borderColor = 'transparent'}
                          placeholder="Customer Name"
                        />
                        <input
                          type="text"
                          value={profileCustomer.address || ''}
                          onChange={(e) => {
                            const updatedCustomer = { ...profileCustomer, address: e.target.value };
                            propagateCustomerUpdate(profileCustomer.id, { address: e.target.value });
                            setProfileCustomer(updatedCustomer);
                          }}
                          style={{
                            fontSize: '12px',
                            color: '#94a3b8',
                            marginTop: '4px',
                            background: 'transparent',
                            border: '1px solid transparent',
                            borderRadius: '4px',
                            padding: '2px 8px',
                            width: '100%',
                            maxWidth: '400px',
                            transition: 'border-color 0.2s'
                          }}
                          onFocus={(e) => e.target.style.borderColor = 'rgba(139, 92, 246, 0.5)'}
                          onBlur={(e) => e.target.style.borderColor = 'transparent'}
                          placeholder="Address"
                        />
                      </div>
                    </div>
                    <button
                      onClick={() => { setShowCustomerProfile(false); setProfileCustomer(null); }}
                      style={{
                        background: 'none',
                        border: 'none',
                        color: '#94a3b8',
                        fontSize: '24px',
                        cursor: 'pointer',
                        padding: '0',
                        width: '32px',
                        height: '32px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                      }}
                    >
                      âœ•
                    </button>
                  </div>

                  {/* Content */}
                  <div style={{ padding: '24px', overflow: 'auto', flex: 1 }} className="scrollbar-custom">
                    {/* Customer Info Grid */}
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px', marginBottom: '24px' }}>
                      <div style={{ padding: '16px', background: 'rgba(139, 92, 246, 0.1)', borderRadius: '12px', border: '1px solid rgba(139, 92, 246, 0.2)' }}>
                        <div style={{ fontSize: '11px', color: '#94a3b8', marginBottom: '4px', textTransform: 'uppercase', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                          <span>Email</span>
                          <span style={{ fontSize: '10px', color: '#a78bfa' }}>click to edit</span>
                        </div>
                        <input
                          type="email"
                          value={profileCustomer.email || ''}
                          onChange={(e) => {
                            const updatedCustomer = { ...profileCustomer, email: e.target.value };
                            propagateCustomerUpdate(profileCustomer.id, { email: e.target.value });
                            setProfileCustomer(updatedCustomer);
                          }}
                          style={{
                            width: '100%',
                            padding: '4px 8px',
                            background: 'rgba(139, 92, 246, 0.2)',
                            border: '1px solid rgba(139, 92, 246, 0.3)',
                            borderRadius: '6px',
                            color: '#f1f5f9',
                            fontSize: '14px'
                          }}
                          placeholder="email@example.com"
                        />
                      </div>
                      <div style={{ padding: '16px', background: 'rgba(139, 92, 246, 0.1)', borderRadius: '12px', border: '1px solid rgba(139, 92, 246, 0.2)' }}>
                        <div style={{ fontSize: '11px', color: '#94a3b8', marginBottom: '4px', textTransform: 'uppercase', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                          <span>Phone</span>
                          <span style={{ fontSize: '10px', color: '#a78bfa' }}>click to edit</span>
                        </div>
                        <input
                          type="tel"
                          value={profileCustomer.phone || ''}
                          onChange={(e) => {
                            const updatedCustomer = { ...profileCustomer, phone: e.target.value };
                            propagateCustomerUpdate(profileCustomer.id, { phone: e.target.value });
                            setProfileCustomer(updatedCustomer);
                          }}
                          style={{
                            width: '100%',
                            padding: '4px 8px',
                            background: 'rgba(139, 92, 246, 0.2)',
                            border: '1px solid rgba(139, 92, 246, 0.3)',
                            borderRadius: '6px',
                            color: '#f1f5f9',
                            fontSize: '14px'
                          }}
                          placeholder="(555) 555-5555"
                        />
                      </div>
                      <div style={{ padding: '16px', background: 'rgba(139, 92, 246, 0.1)', borderRadius: '12px', border: '1px solid rgba(139, 92, 246, 0.2)' }}>
                        <div style={{ fontSize: '11px', color: '#94a3b8', marginBottom: '4px', textTransform: 'uppercase', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                          <span>Panels</span>
                          <span style={{ fontSize: '10px', color: '#a78bfa' }}>click to edit</span>
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                          <span>â˜€ï¸</span>
                          <input
                            type="number"
                            value={profileCustomer.panelCount || profileCustomer.totalPanels || ''}
                            onChange={(e) => {
                              const updatedCustomer = { ...profileCustomer, panelCount: e.target.value, totalPanels: e.target.value };
                              propagateCustomerUpdate(profileCustomer.id, { panelCount: e.target.value, totalPanels: e.target.value });
                              setProfileCustomer(updatedCustomer);
                            }}
                            style={{
                              width: '100%',
                              padding: '4px 8px',
                              background: 'rgba(139, 92, 246, 0.2)',
                              border: '1px solid rgba(139, 92, 246, 0.3)',
                              borderRadius: '6px',
                              color: '#f1f5f9',
                              fontSize: '14px'
                            }}
                            placeholder="0"
                            min="0"
                          />
                        </div>
                      </div>
                      <div style={{ padding: '16px', background: 'rgba(34, 197, 94, 0.1)', borderRadius: '12px', border: '1px solid rgba(34, 197, 94, 0.2)' }}>
                        <div style={{ fontSize: '11px', color: '#94a3b8', marginBottom: '4px', textTransform: 'uppercase', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                          <span>Status</span>
                          <span style={{ fontSize: '10px', color: '#4ade80' }}>click to edit</span>
                        </div>
                        <select
                          value={profileCustomer.status || ''}
                          onChange={(e) => {
                            const newStatus = e.target.value;
                            if (newStatus === 'unscheduled' && !customerHasOpenJobs(profileCustomer)) {
                              alert('Cannot set to Unscheduled â€” this customer has no open jobs. Add a job first.');
                              return;
                            }
                            const updatedCustomer = { ...profileCustomer, status: newStatus };
                            propagateCustomerUpdate(profileCustomer.id, { status: newStatus });
                            setProfileCustomer(updatedCustomer);
                          }}
                          style={{
                            width: '100%',
                            padding: '6px 8px',
                            background: 'rgba(34, 197, 94, 0.2)',
                            border: '1px solid rgba(34, 197, 94, 0.3)',
                            borderRadius: '6px',
                            color: '#22c55e',
                            fontSize: '14px',
                            cursor: 'pointer'
                          }}
                        >
                          <option value="">âšª No Status</option>
                          <option value="unscheduled">ðŸ”´ Unscheduled</option>
                          <option value="scheduled">ðŸŸ¡ Scheduled</option>
                        </select>
                        {(profileCustomer.isRecurring || profileCustomer.recurring === 'TRUE') && (
                          <div style={{ fontSize: '12px', color: '#22c55e', marginTop: '4px' }}>ðŸ¦– Recurring Customer</div>
                        )}
                      </div>
                      <div style={{ padding: '16px', background: 'rgba(99, 102, 241, 0.1)', borderRadius: '12px', border: '1px solid rgba(99, 102, 241, 0.2)' }}>
                        <div style={{ fontSize: '11px', color: '#94a3b8', marginBottom: '4px', textTransform: 'uppercase' }}>
                          Type
                        </div>
                        <select
                          value={profileCustomer.customerType || 'residential'}
                          onChange={(e) => {
                            const updatedCustomer = { ...profileCustomer, customerType: e.target.value };
                            propagateCustomerUpdate(profileCustomer.id, { customerType: e.target.value });
                            setProfileCustomer(updatedCustomer);
                          }}
                          style={{
                            width: '100%', padding: '6px 8px',
                            background: 'rgba(99, 102, 241, 0.2)', border: '1px solid rgba(99, 102, 241, 0.3)',
                            borderRadius: '6px', color: '#818cf8', fontSize: '14px', cursor: 'pointer'
                          }}
                        >
                          {allTypeTabs.filter(t => t.key !== 'all').map(t => (
                            <option key={t.key} value={t.key}>{t.label}</option>
                          ))}
                        </select>
                      </div>
                      <div style={{ padding: '16px', background: 'rgba(251, 191, 36, 0.1)', borderRadius: '12px', border: '1px solid rgba(251, 191, 36, 0.2)' }}>
                        <div style={{ fontSize: '11px', color: '#94a3b8', marginBottom: '4px', textTransform: 'uppercase', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                          <span>Last Service</span>
                          <span style={{ fontSize: '10px', color: '#fbbf24' }}>click to edit</span>
                        </div>
                        <input
                          type="date"
                          value={profileCustomer.lastServiceDate || ''}
                          onChange={(e) => {
                            const updatedCustomer = { ...profileCustomer, lastServiceDate: e.target.value };
                            propagateCustomerUpdate(profileCustomer.id, { lastServiceDate: e.target.value });
                            setProfileCustomer(updatedCustomer);
                          }}
                          style={{
                            width: '100%',
                            padding: '4px 8px',
                            background: 'rgba(251, 191, 36, 0.2)',
                            border: '1px solid rgba(251, 191, 36, 0.3)',
                            borderRadius: '6px',
                            color: '#fbbf24',
                            fontSize: '14px',
                            cursor: 'pointer'
                          }}
                        />
                      </div>
                      <div style={{ padding: '16px', background: 'rgba(59, 130, 246, 0.1)', borderRadius: '12px', border: '1px solid rgba(59, 130, 246, 0.2)' }}>
                        <div style={{ fontSize: '11px', color: '#94a3b8', marginBottom: '4px', textTransform: 'uppercase' }}>
                          <span>Next Service</span>
                        </div>
                        <div style={{ fontSize: '14px', color: '#60a5fa', padding: '4px 0' }}>
                          {(() => {
                            if (profileCustomer.scheduledDate) {
                              return new Date(profileCustomer.scheduledDate).toLocaleDateString();
                            }
                            const upcoming = (profileCustomer.serviceHistory || [])
                              .filter(j => j.status && j.status.toLowerCase() !== 'completed' && j.status.toLowerCase() !== 'cancelled')
                              .filter(j => j.scheduledDate || j.nextServiceDate)
                              .sort((a, b) => {
                                const da = new Date(a.scheduledDate || a.nextServiceDate || '9999');
                                const db = new Date(b.scheduledDate || b.nextServiceDate || '9999');
                                return da - db;
                              });
                            const nearest = upcoming[0];
                            const dateStr = nearest ? (nearest.scheduledDate || nearest.nextServiceDate) : '';
                            return dateStr ? new Date(dateStr).toLocaleDateString() : 'Not scheduled';
                          })()}
                        </div>
                      </div>
                    </div>

                    {/* Job History Section */}
                    <div style={{ marginBottom: '24px' }}>
                      <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '16px' }}>
                        <h3 style={{ fontSize: '16px', fontWeight: 700, color: '#f1f5f9', display: 'flex', alignItems: 'center', gap: '8px', margin: 0 }}>
                          ðŸ“‹ Jobs
                        </h3>
                        <button
                          onClick={() => {
                            openJobPopupForCustomer(profileCustomer);
                          }}
                          style={{
                            padding: '8px 16px', borderRadius: '8px',
                            background: 'linear-gradient(135deg, #8b5cf6, #6d28d9)',
                            border: 'none', color: '#fff', fontSize: '13px',
                            fontWeight: 600, cursor: 'pointer', fontFamily: 'inherit'
                          }}
                        >
                          + Add Job
                        </button>
                      </div>
                      {(() => {
                        const allJobs = profileCustomer.serviceHistory || [];
                        const activeJobs = allJobs.filter(j => j.status && j.status.toLowerCase() !== 'completed' && j.status.toLowerCase() !== 'cancelled');
                        const upcomingJobs = activeJobs.filter(j => j.scheduledDate || j.nextServiceDate || j.date);
                        const unscheduledJobs = activeJobs.filter(j => !j.scheduledDate && !j.nextServiceDate && !j.date);
                        const pastJobs = allJobs.filter(j => !j.status || j.status.toLowerCase() === 'completed' || j.status.toLowerCase() === 'cancelled');
                        const sortByDate = (a, b) => {
                          const da = new Date(a.scheduledDate || a.nextServiceDate || a.date || '1970-01-01').getTime();
                          const db = new Date(b.scheduledDate || b.nextServiceDate || b.date || '1970-01-01').getTime();
                          return db - da;
                        };
                        const renderJobCard = (job, idx, sectionType) => (
                            <div key={idx} style={{
                              padding: '16px',
                              background: 'rgba(30, 41, 59, 0.5)',
                              borderRadius: '12px',
                              border: sectionType === 'upcoming' ? '1px solid rgba(251, 191, 36, 0.3)' : '1px solid rgba(139, 92, 246, 0.2)'
                            }}>
                              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '8px' }}>
                                <div>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    <span style={{ fontSize: '14px', fontWeight: 600, color: '#f1f5f9' }}>
                                      {job.jobDescription || 'Service'}
                                    </span>
                                    {job.status && (
                                      <span style={{ fontSize: '10px', padding: '2px 6px', borderRadius: '4px', fontWeight: 600, background: job.status.toLowerCase() === 'completed' ? 'rgba(34,197,94,0.2)' : job.status.toLowerCase() === 'scheduled' ? 'rgba(251,191,36,0.2)' : 'rgba(239,68,68,0.2)', color: job.status.toLowerCase() === 'completed' ? '#22c55e' : job.status.toLowerCase() === 'scheduled' ? '#fbbf24' : '#ef4444' }}>
                                        {job.status}
                                      </span>
                                    )}
                                  </div>
                                  {sectionType === 'upcoming' ? (
                                    <div style={{ fontSize: '12px', color: '#94a3b8', marginTop: '4px', display: 'flex', alignItems: 'center', gap: '4px' }}>
                                      ðŸ“… <input
                                        type="date"
                                        value={job.scheduledDate || job.date || ''}
                                        onChange={async (ev) => {
                                          ev.stopPropagation();
                                          const newDate = ev.target.value;
                                          if (job.jobId) {
                                            try {
                                              await apiFetch(`/jobs/${job.jobId}`, {
                                                method: 'PATCH',
                                                body: JSON.stringify({ scheduled_date: newDate, next_service_date: newDate })
                                              });
                                              job.date = newDate;
                                              job.scheduledDate = newDate;
                                              const allJobs = (profileCustomer.serviceHistory || []).map(j => j.jobId === job.jobId ? {...j, date: newDate, scheduledDate: newDate} : j);
                                              const upcomingAfterEdit = allJobs.filter(j => j.status && j.status.toLowerCase() !== 'completed' && j.status.toLowerCase() !== 'cancelled');
                                              const nearestDate = upcomingAfterEdit.reduce((min, j) => {
                                                const d = j.scheduledDate || j.date;
                                                return d && (!min || new Date(d) < new Date(min)) ? d : min;
                                              }, null);
                                              const customerPatch = { next_service_date: nearestDate || null };
                                              const isRecurring = profileCustomer.isRecurring || profileCustomer.recurring;
                                              if (isRecurring && nearestDate) {
                                                const daysUntil = Math.floor((new Date(nearestDate) - new Date()) / (1000 * 60 * 60 * 24));
                                                customerPatch.status = daysUntil <= 30 ? 'scheduled' : '';
                                              } else if (!isRecurring && upcomingAfterEdit.length > 0) {
                                                customerPatch.status = 'scheduled';
                                              }
                                              await apiFetch(`/customers/${profileCustomer.id}`, {
                                                method: 'PATCH',
                                                body: JSON.stringify(customerPatch)
                                              });
                                              propagateCustomerUpdate(profileCustomer.id, { nextServiceDate: nearestDate, status: customerPatch.status });
                                              setProfileCustomer(prev => ({...prev, nextServiceDate: nearestDate, status: customerPatch.status, serviceHistory: allJobs}));
                                            } catch (err) { console.error('Failed to update job date:', err); }
                                          }
                                        }}
                                        style={{
                                          background: 'transparent',
                                          border: '1px solid rgba(251, 191, 36, 0.3)',
                                          borderRadius: '4px',
                                          color: '#fbbf24',
                                          fontSize: '12px',
                                          padding: '2px 4px',
                                          cursor: 'pointer'
                                        }}
                                      />
                                    </div>
                                  ) : (
                                    <div style={{ fontSize: '12px', color: '#94a3b8', marginTop: '4px' }}>
                                      ðŸ“… {job.date ? new Date(job.date).toLocaleDateString() : 'No date set'}
                                    </div>
                                  )}
                                </div>
                                <div style={{ display: 'flex', alignItems: 'start', gap: '10px' }}>
                                  <div style={{ textAlign: 'right' }}>
                                    <div style={{ fontSize: '14px', fontWeight: 600, color: '#22c55e' }}>
                                      ${job.price || job.amount || 0}
                                    </div>
                                    {job.tip > 0 && (
                                      <div style={{ fontSize: '12px', color: '#fbbf24' }}>
                                        + ${job.tip} tip
                                      </div>
                                    )}
                                  </div>
                                  {(
                                    <div style={{ display: 'flex', gap: '4px' }}>
                                      {job.jobId && <button
                                        onClick={(e) => { e.stopPropagation(); editJobFromHistory(job, profileCustomer); }}
                                        style={{
                                          padding: '4px 8px', borderRadius: '5px', fontSize: '11px', fontWeight: 600,
                                          background: 'rgba(139,92,246,0.1)', border: '1px solid rgba(139,92,246,0.25)',
                                          color: '#a78bfa', cursor: 'pointer'
                                        }}
                                      >Edit</button>}
                                      {confirmDeleteJobId === (job.jobId || job.jobDescription + idx) ? (
                                        <React.Fragment>
                                          <button
                                            onClick={async (e) => {
                                              e.stopPropagation();
                                              try {
                                                if (job.jobId) {
                                                  await apiFetch(`/jobs/${job.jobId}`, { method: 'DELETE' });
                                                }
                                                const custJobsData = await apiFetch(`/jobs?customer_id=${profileCustomer.id}`);
                                                const remainingJobs = (custJobsData.jobs || []);
                                                const remainingActive = remainingJobs.filter(j => j.status !== 'completed' && j.status !== 'cancelled');
                                                let newStatus = '';
                                                if (remainingActive.length > 0) {
                                                  const hasScheduled = remainingActive.some(j => j.scheduled_date || j.next_service_date);
                                                  newStatus = hasScheduled ? 'scheduled' : 'unscheduled';
                                                }
                                                const completedJobs = remainingJobs.filter(j => j.completed_date || j.scheduled_date);
                                                const jobDates = completedJobs.map(j => j.completed_date || j.scheduled_date).filter(Boolean).sort((a, b) => new Date(b) - new Date(a));
                                                const newLastServiceDate = jobDates.length > 0 ? jobDates[0] : '';
                                                await apiFetch(`/customers/${profileCustomer.id}`, {
                                                  method: 'PATCH',
                                                  body: JSON.stringify({ status: newStatus, last_service_date: newLastServiceDate })
                                                });
                                                await loadFromDatabase();
                                                setJobRefreshKey(k => k + 1);
                                                setConfirmDeleteJobId(null);
                                              } catch (err) {
                                                console.error('Failed to delete job:', err);
                                                setConfirmDeleteJobId(null);
                                              }
                                            }}
                                            style={{
                                              padding: '4px 8px', borderRadius: '5px', fontSize: '11px', fontWeight: 600,
                                              background: 'rgba(239,68,68,0.3)', border: '1px solid rgba(239,68,68,0.5)',
                                              color: '#fca5a5', cursor: 'pointer'
                                            }}
                                          >Yes, Delete</button>
                                          <button
                                            onClick={(e) => { e.stopPropagation(); setConfirmDeleteJobId(null); }}
                                            style={{
                                              padding: '4px 8px', borderRadius: '5px', fontSize: '11px', fontWeight: 600,
                                              background: 'rgba(148,163,184,0.1)', border: '1px solid rgba(148,163,184,0.25)',
                                              color: '#94a3b8', cursor: 'pointer'
                                            }}
                                          >Cancel</button>
                                        </React.Fragment>
                                      ) : (
                                        <button
                                          onClick={(e) => { e.stopPropagation(); setConfirmDeleteJobId(job.jobId || job.jobDescription + idx); }}
                                          style={{
                                            padding: '4px 8px', borderRadius: '5px', fontSize: '11px', fontWeight: 600,
                                            background: 'rgba(239,68,68,0.1)', border: '1px solid rgba(239,68,68,0.25)',
                                            color: '#f87171', cursor: 'pointer'
                                          }}
                                        >Delete</button>
                                      )}
                                    </div>
                                  )}
                                </div>
                              </div>
                              {(job.preferredDays || job.preferredTime || job.technician || job.isRecurring) && (
                                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '4px', marginTop: '8px' }}>
                                  {job.preferredDays && (
                                    <span style={{ fontSize: '10px', padding: '2px 6px', borderRadius: '4px', background: 'rgba(34,197,94,0.15)', color: '#4ade80', fontWeight: 600 }}>
                                      {job.preferredDays}
                                    </span>
                                  )}
                                  {job.preferredTime && (
                                    <span style={{ fontSize: '10px', padding: '2px 6px', borderRadius: '4px', background: 'rgba(59,130,246,0.15)', color: '#60a5fa', fontWeight: 600 }}>
                                      {job.preferredTime}
                                    </span>
                                  )}
                                  {job.technician && (
                                    <span style={{ fontSize: '10px', padding: '2px 6px', borderRadius: '4px', background: 'rgba(148,163,184,0.15)', color: '#94a3b8', fontWeight: 600 }}>
                                      {job.technician}
                                    </span>
                                  )}
                                  {job.isRecurring && (
                                    <span style={{ fontSize: '10px', padding: '2px 6px', borderRadius: '4px', background: 'rgba(251,191,36,0.15)', color: '#fbbf24', fontWeight: 600 }}>
                                      {job.recurrenceInterval === '6months' ? 'Every 6 Mo' : 'Yearly'}
                                    </span>
                                  )}
                                </div>
                              )}
                              {job.notes && (() => {
                                const displayNotes = job.notes.replace(/Preferred days?:\s*[^|]*/gi, '').replace(/Preferred time:\s*[^|]*/gi, '').replace(/Technician:\s*[^|]*/gi, '').split('|').map(s => s.trim()).filter(Boolean).join(' | ');
                                return displayNotes ? (
                                  <div style={{ fontSize: '12px', color: '#94a3b8', marginTop: '6px', padding: '8px', background: 'rgba(0,0,0,0.2)', borderRadius: '6px' }}>
                                    ðŸ“ {displayNotes}
                                  </div>
                                ) : null;
                              })()}
                            </div>
                        );
                        return (
                          <React.Fragment>
                            {unscheduledJobs.length > 0 && (
                              <div style={{ marginBottom: '20px' }}>
                                <div style={{ fontSize: '13px', fontWeight: 700, color: '#ef4444', marginBottom: '10px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                                  Needs Scheduling ({unscheduledJobs.length})
                                </div>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                                  {unscheduledJobs.map((job, idx) => renderJobCard(job, idx, 'upcoming'))}
                                </div>
                              </div>
                            )}
                            {upcomingJobs.length > 0 && (
                              <div style={{ marginBottom: '20px' }}>
                                <div style={{ fontSize: '13px', fontWeight: 700, color: '#fbbf24', marginBottom: '10px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                                  Scheduled ({upcomingJobs.length})
                                </div>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                                  {[...upcomingJobs].sort(sortByDate).map((job, idx) => renderJobCard(job, idx, 'upcoming'))}
                                </div>
                              </div>
                            )}
                            {pastJobs.length > 0 && (
                              <div>
                                <div style={{ fontSize: '13px', fontWeight: 700, color: '#94a3b8', marginBottom: '10px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                                  Job History ({pastJobs.length})
                                </div>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                                  {[...pastJobs].sort(sortByDate).map((job, idx) => renderJobCard(job, idx, 'history'))}
                                </div>
                              </div>
                            )}
                            {unscheduledJobs.length === 0 && upcomingJobs.length === 0 && pastJobs.length === 0 && (
                              <div style={{ padding: '24px', textAlign: 'center', color: '#64748b', background: 'rgba(30, 41, 59, 0.3)', borderRadius: '12px' }}>
                                No jobs yet
                              </div>
                            )}
                          </React.Fragment>
                        );
                      })()}
                    </div>

                    {/* General Customer Notes Section */}
                    <div>
                      <h3 style={{ fontSize: '16px', fontWeight: 700, color: '#f1f5f9', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                        ðŸ“ Customer Notes
                      </h3>
                      <div style={{ marginBottom: '12px' }}>
                        <textarea
                          value={newCustomerNote}
                          onChange={(e) => setNewCustomerNote(e.target.value)}
                          placeholder="Add a general note about this customer..."
                          style={{
                            width: '100%',
                            padding: '12px',
                            background: 'rgba(15, 23, 42, 0.8)',
                            border: '1px solid rgba(139, 92, 246, 0.3)',
                            borderRadius: '8px',
                            color: '#f1f5f9',
                            fontSize: '13px',
                            minHeight: '80px',
                            resize: 'vertical',
                            boxSizing: 'border-box'
                          }}
                        />
                        <button
                          onClick={() => {
                            if (!newCustomerNote.trim()) return;
                            const newNotes = (profileCustomer.customerNotes || '') +
                              (profileCustomer.customerNotes ? '\n' : '') +
                              `[${new Date().toLocaleDateString()}] ${newCustomerNote}`;
                            const updatedCustomer = {
                              ...profileCustomer,
                              customerNotes: newNotes
                            };
                            // Propagate to all views
                            propagateCustomerUpdate(profileCustomer.id, { customerNotes: newNotes });
                            setProfileCustomer(updatedCustomer);
                            setNewCustomerNote('');
                            // Protect from sheet sync overwriting notes
                          }}
                          disabled={!newCustomerNote.trim()}
                          style={{
                            marginTop: '8px',
                            padding: '10px 20px',
                            background: newCustomerNote.trim() ? 'linear-gradient(135deg, #8b5cf6, #7c3aed)' : 'rgba(100, 116, 139, 0.3)',
                            border: 'none',
                            borderRadius: '8px',
                            color: '#fff',
                            fontSize: '13px',
                            fontWeight: 600,
                            cursor: newCustomerNote.trim() ? 'pointer' : 'not-allowed'
                          }}
                        >
                          ðŸ’¾ Save Note
                        </button>
                      </div>
                      {profileCustomer.customerNotes && (
                        <div style={{
                          padding: '16px',
                          background: 'rgba(30, 41, 59, 0.5)',
                          borderRadius: '12px',
                          border: '1px solid rgba(139, 92, 246, 0.2)',
                          whiteSpace: 'pre-wrap',
                          fontSize: '13px',
                          color: '#cbd5e1'
                        }}>
                          {profileCustomer.customerNotes}
                        </div>
                      )}
                    </div>

                    <div style={{ marginTop: '24px', paddingTop: '20px', borderTop: '1px solid rgba(239, 68, 68, 0.2)' }}>
                      {!confirmDeleteCustomer ? (
                        <button
                          onClick={() => setConfirmDeleteCustomer(true)}
                          style={{
                            width: '100%', padding: '12px', borderRadius: '10px',
                            background: 'rgba(239, 68, 68, 0.1)', border: '1px solid rgba(239, 68, 68, 0.3)',
                            color: '#f87171', fontSize: '13px', fontWeight: 600, cursor: 'pointer', fontFamily: 'inherit'
                          }}
                        >
                          ðŸ—‘ï¸ Delete Customer
                        </button>
                      ) : (
                        <div style={{ textAlign: 'center' }}>
                          <div style={{ fontSize: '13px', color: '#fca5a5', marginBottom: '10px', fontWeight: 600 }}>
                            Are you sure? This will permanently delete this customer and all their jobs.
                          </div>
                          <div style={{ display: 'flex', gap: '10px', justifyContent: 'center' }}>
                            <button
                              onClick={async () => {
                                try {
                                  await apiFetch(`/customers/${profileCustomer.id}`, { method: 'DELETE' });
                                  setCustomers(prev => prev.filter(c => c.id !== profileCustomer.id));
                                  setSavedLists(prev => prev.map(list => ({
                                    ...list,
                                    customers: list.customers.filter(c => c.id !== profileCustomer.id)
                                  })));
                                  setSavedRoutes(prev => prev.map(route => ({
                                    ...route,
                                    customers: (route.customers || []).filter(c => c.id !== profileCustomer.id)
                                  })));
                                  setPipelineCustomers(prev => prev.filter(c => c.id !== profileCustomer.id));
                                  setShowCustomerProfile(false);
                                  setProfileCustomer(null);
                                  setConfirmDeleteCustomer(false);
                                } catch (err) {
                                  console.error('Failed to delete customer:', err);
                                  setConfirmDeleteCustomer(false);
                                }
                              }}
                              style={{
                                padding: '10px 24px', borderRadius: '8px',
                                background: 'rgba(239, 68, 68, 0.3)', border: '1px solid rgba(239, 68, 68, 0.5)',
                                color: '#fca5a5', fontSize: '13px', fontWeight: 600, cursor: 'pointer', fontFamily: 'inherit'
                              }}
                            >Yes, Delete Forever</button>
                            <button
                              onClick={() => setConfirmDeleteCustomer(false)}
                              style={{
                                padding: '10px 24px', borderRadius: '8px',
                                background: 'rgba(148, 163, 184, 0.1)', border: '1px solid rgba(148, 163, 184, 0.3)',
                                color: '#94a3b8', fontSize: '13px', fontWeight: 600, cursor: 'pointer', fontFamily: 'inherit'
                              }}
                            >Cancel</button>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* âž• Job Creation Modal */}

            {/* âš ï¸ Failed Customers Modal */}
            {showFailedCustomersModal && (
              <div
                style={{
                  position: 'fixed',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  background: 'rgba(0, 0, 0, 0.7)',
                  backdropFilter: 'blur(4px)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  zIndex: 10002,
                  animation: 'fadeIn 0.2s ease'
                }}
                onClick={() => setShowFailedCustomersModal(false)}
              >
                <div
                  onClick={(e) => e.stopPropagation()}
                  style={{
                    width: '900px',
                    maxHeight: '90vh',
                    background: 'rgba(15, 23, 42, 0.98)',
                    backdropFilter: 'blur(20px)',
                    border: '2px solid rgba(251, 191, 36, 0.3)',
                    borderRadius: '16px',
                    overflow: 'hidden',
                    boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)',
                    display: 'flex',
                    flexDirection: 'column'
                  }}
                >
                  {/* Header */}
                  <div style={{
                    padding: '24px',
                    borderBottom: '1px solid rgba(251, 191, 36, 0.2)',
                    background: 'rgba(251, 191, 36, 0.05)',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'start'
                  }}>
                    <div>
                      <h2 style={{ fontSize: '20px', fontWeight: 700, margin: 0, color: '#f1f5f9' }}>
                        âš ï¸ Failed Addresses ({failedCustomers.length})
                      </h2>
                      <p style={{ fontSize: '13px', color: '#94a3b8', margin: '8px 0 0 0' }}>
                        These addresses couldn't be mapped. Edit them below and click "Retry" to try geocoding again.
                      </p>
                    </div>
                    <button
                      onClick={() => setShowFailedCustomersModal(false)}
                      style={{
                        background: 'none',
                        border: 'none',
                        color: '#94a3b8',
                        fontSize: '24px',
                        cursor: 'pointer',
                        padding: '0',
                        lineHeight: 1
                      }}
                    >
                      Ã—
                    </button>
                  </div>

                  {/* Customers List */}
                  <div style={{ 
                    padding: '24px', 
                    overflowY: 'auto',
                    flex: 1
                  }} className="scrollbar-custom">
                    <div style={{ display: 'grid', gap: '16px' }}>
                      {failedCustomers.map((customer, index) => (
                        <div key={customer.id} className="glass-card" style={{ padding: '16px' }}>
                          <div style={{ display: 'flex', gap: '16px', marginBottom: '12px', alignItems: 'start' }}>
                            <div style={{
                              width: '32px',
                              height: '32px',
                              background: 'rgba(251, 191, 36, 0.2)',
                              borderRadius: '8px',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              fontSize: '12px',
                              fontWeight: 600,
                              color: '#fbbf24',
                              flexShrink: 0
                            }}>
                              {index + 1}
                            </div>
                            <div style={{ flex: 1 }}>
                              <div style={{ fontSize: '14px', fontWeight: 600, color: '#f1f5f9', marginBottom: '4px' }}>
                                {customer.name}
                              </div>
                              <div style={{ fontSize: '11px', color: '#ef4444', marginBottom: '12px' }}>
                                {customer.reason}
                              </div>
                              
                              {/* Editable Fields */}
                              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                <div>
                                  <label style={{ fontSize: '11px', color: '#94a3b8', display: 'block', marginBottom: '4px' }}>
                                    Street Address
                                  </label>
                                  <input
                                    type="text"
                                    value={customer.street}
                                    onChange={(e) => {
                                      const updated = [...failedCustomers];
                                      updated[index].street = e.target.value;
                                      updated[index].address = `${e.target.value}, ${customer.city}, ${customer.state} ${customer.zip}`.trim();
                                      setFailedCustomers(updated);
                                    }}
                                    style={{
                                      width: '100%',
                                      padding: '8px',
                                      background: 'rgba(30, 41, 59, 0.5)',
                                      border: '1px solid rgba(251, 191, 36, 0.3)',
                                      borderRadius: '6px',
                                      color: '#f1f5f9',
                                      fontSize: '12px'
                                    }}
                                  />
                                </div>
                                <div>
                                  <label style={{ fontSize: '11px', color: '#94a3b8', display: 'block', marginBottom: '4px' }}>
                                    City
                                  </label>
                                  <input
                                    type="text"
                                    value={customer.city}
                                    onChange={(e) => {
                                      const updated = [...failedCustomers];
                                      updated[index].city = e.target.value;
                                      updated[index].address = `${customer.street}, ${e.target.value}, ${customer.state} ${customer.zip}`.trim();
                                      setFailedCustomers(updated);
                                    }}
                                    style={{
                                      width: '100%',
                                      padding: '8px',
                                      background: 'rgba(30, 41, 59, 0.5)',
                                      border: '1px solid rgba(251, 191, 36, 0.3)',
                                      borderRadius: '6px',
                                      color: '#f1f5f9',
                                      fontSize: '12px'
                                    }}
                                  />
                                </div>
                                <div>
                                  <label style={{ fontSize: '11px', color: '#94a3b8', display: 'block', marginBottom: '4px' }}>
                                    State
                                  </label>
                                  <input
                                    type="text"
                                    value={customer.state}
                                    onChange={(e) => {
                                      const updated = [...failedCustomers];
                                      updated[index].state = e.target.value;
                                      updated[index].address = `${customer.street}, ${customer.city}, ${e.target.value} ${customer.zip}`.trim();
                                      setFailedCustomers(updated);
                                    }}
                                    style={{
                                      width: '100%',
                                      padding: '8px',
                                      background: 'rgba(30, 41, 59, 0.5)',
                                      border: '1px solid rgba(251, 191, 36, 0.3)',
                                      borderRadius: '6px',
                                      color: '#f1f5f9',
                                      fontSize: '12px'
                                    }}
                                  />
                                </div>
                                <div>
                                  <label style={{ fontSize: '11px', color: '#94a3b8', display: 'block', marginBottom: '4px' }}>
                                    ZIP Code
                                  </label>
                                  <input
                                    type="text"
                                    value={customer.zip}
                                    onChange={(e) => {
                                      const updated = [...failedCustomers];
                                      updated[index].zip = e.target.value;
                                      updated[index].address = `${customer.street}, ${customer.city}, ${customer.state} ${e.target.value}`.trim();
                                      setFailedCustomers(updated);
                                    }}
                                    style={{
                                      width: '100%',
                                      padding: '8px',
                                      background: 'rgba(30, 41, 59, 0.5)',
                                      border: '1px solid rgba(251, 191, 36, 0.3)',
                                      borderRadius: '6px',
                                      color: '#f1f5f9',
                                      fontSize: '12px'
                                    }}
                                  />
                                </div>
                              </div>
                              
                              {/* Action Buttons */}
                              <div style={{ display: 'flex', gap: '8px', marginTop: '12px' }}>
                                <button
                                  onClick={async () => {
                                    try {
                                      const coords = await geocodeAddress(customer.address);
                                      if (coords) {
                                        // Add to map
                                        const newCustomer = {
                                          ...customer,
                                          lat: coords.lat,
                                          lng: coords.lng,
                                          id: Math.random().toString(36).substr(2, 9),
                                          fileId: Date.now() + Math.random()
                                        };
                                        
                                        setUploadedFiles(prev => [...prev, {
                                          id: newCustomer.fileId,
                                          name: customer.fileName || 'Fixed Addresses',
                                          customers: [newCustomer],
                                          visible: true,
                                          count: 1
                                        }]);
                                        
                                        // Remove from failed
                                        setFailedCustomers(prev => prev.filter(c => c.id !== customer.id));
                                      } else {
                                        alert('Still unable to geocode this address. Please check the address details.');
                                      }
                                    } catch (err) {
                                      alert('Error geocoding address: ' + err.message);
                                    }
                                  }}
                                  style={{
                                    flex: 1,
                                    padding: '8px',
                                    background: 'rgba(34, 197, 94, 0.2)',
                                    border: '1px solid rgba(34, 197, 94, 0.3)',
                                    borderRadius: '6px',
                                    color: '#22c55e',
                                    fontSize: '12px',
                                    fontWeight: 600,
                                    cursor: 'pointer'
                                  }}
                                >
                                  âœ“ Retry Geocode
                                </button>
                                <button
                                  onClick={() => {
                                    setFailedCustomers(prev => prev.filter(c => c.id !== customer.id));
                                  }}
                                  style={{
                                    padding: '8px 12px',
                                    background: 'rgba(239, 68, 68, 0.1)',
                                    border: '1px solid rgba(239, 68, 68, 0.2)',
                                    borderRadius: '6px',
                                    color: '#ef4444',
                                    fontSize: '12px',
                                    cursor: 'pointer'
                                  }}
                                >
                                  ðŸ—‘ï¸
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* Footer */}
                  <div style={{
                    padding: '20px 24px',
                    borderTop: '1px solid rgba(251, 191, 36, 0.2)',
                    background: 'rgba(15, 23, 42, 0.8)',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center'
                  }}>
                    <div style={{ fontSize: '12px', color: '#94a3b8' }}>
                      {failedCustomers.length} {failedCustomers.length === 1 ? 'address' : 'addresses'} remaining
                    </div>
                    <button
                      onClick={() => setShowFailedCustomersModal(false)}
                      style={{
                        padding: '12px 24px',
                        background: 'rgba(100, 116, 139, 0.2)',
                        border: '1px solid rgba(100, 116, 139, 0.3)',
                        borderRadius: '10px',
                        color: '#94a3b8',
                        fontSize: '14px',
                        fontWeight: 600,
                        cursor: 'pointer'
                      }}
                    >
                      Close
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* ðŸ“ Saved Routes View */}
            {currentView === 'saved' && (
              <div style={{ 
                position: 'absolute',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                overflow: 'auto',
                padding: '24px'
              }} className="scrollbar-custom">
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px', flexWrap: 'wrap', gap: '12px' }}>
                  <h2 style={{ fontSize: '20px', fontWeight: 800, margin: 0 }}>ðŸ“ Saved Routes</h2>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <span style={{ fontSize: '12px', color: '#94a3b8', whiteSpace: 'nowrap' }}>ðŸ“§ Send to:</span>
                    <input
                      type="email"
                      value={techEmail}
                      onChange={(e) => {
                        setTechEmail(e.target.value);
                        localStorage.setItem('techEmail', e.target.value);
                      }}
                      className="input-field"
                      style={{ width: '220px', height: '32px', fontSize: '12px' }}
                      placeholder="technician@email.com"
                    />
                  </div>
                </div>
                
                {savedRoutes.filter(r => !r.sentToTech).length === 0 ? (
                  <div style={{ textAlign: 'center', padding: '80px 20px', color: '#64748b' }}>
                    <div style={{ fontSize: '64px', marginBottom: '16px' }}>ðŸ“</div>
                    <div style={{ fontSize: '18px', fontWeight: 600, marginBottom: '8px' }}>No saved routes</div>
                    <div style={{ fontSize: '14px' }}>Build a route on the Map tab and save it!</div>
                  </div>
                ) : (
                  <div style={{ display: 'flex', gap: '16px', flexWrap: 'wrap', alignItems: 'flex-start' }}>
                    {savedRoutes
                      .filter(r => !r.sentToTech)
                      .sort((a, b) => new Date(a.scheduledDate || a.date) - new Date(b.scheduledDate || b.date))
                      .map((savedRoute) => {
                        const schedDate = savedRoute.scheduledDate ? new Date(savedRoute.scheduledDate) : null;
                        const dayLabel = schedDate ? schedDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) : 'Unscheduled';
                        return (
                      <div key={savedRoute.id} className="glass-card" style={{ 
                        padding: '0', 
                        width: '280px',
                        minWidth: '260px',
                        flex: '0 0 280px',
                        display: 'flex',
                        flexDirection: 'column',
                        overflow: 'hidden'
                      }}>
                        <div style={{ 
                          padding: '12px 14px',
                          background: 'rgba(139, 92, 246, 0.15)',
                          borderBottom: '1px solid rgba(139, 92, 246, 0.2)'
                        }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '6px' }}>
                            {editingRouteId === savedRoute.id ? (
                              <input
                                type="text"
                                value={editedRouteName}
                                onChange={(e) => setEditedRouteName(e.target.value)}
                                onBlur={() => {
                                  if (editedRouteName.trim()) {
                                    setSavedRoutes(prev => prev.map(r => 
                                      r.id === savedRoute.id ? { ...r, name: editedRouteName } : r
                                    ));
                                  }
                                  setEditingRouteId(null);
                                }}
                                onKeyPress={(e) => {
                                  if (e.key === 'Enter' && editedRouteName.trim()) {
                                    setSavedRoutes(prev => prev.map(r => 
                                      r.id === savedRoute.id ? { ...r, name: editedRouteName } : r
                                    ));
                                    setEditingRouteId(null);
                                  }
                                }}
                                autoFocus
                                style={{
                                  fontSize: '14px', fontWeight: 700,
                                  background: 'rgba(139, 92, 246, 0.1)',
                                  border: '1px solid rgba(139, 92, 246, 0.3)',
                                  borderRadius: '4px', padding: '2px 6px',
                                  color: '#f1f5f9', flex: 1, width: '100%'
                                }}
                              />
                            ) : (
                              <h3 
                                onClick={() => { setEditingRouteId(savedRoute.id); setEditedRouteName(savedRoute.name); }}
                                style={{ fontSize: '14px', fontWeight: 700, margin: 0, cursor: 'pointer', flex: 1 }}
                                title="Click to rename"
                              >{savedRoute.name}</h3>
                            )}
                          </div>
                          <div style={{ fontSize: '12px', fontWeight: 600, color: '#a78bfa', marginBottom: '4px' }}>
                            ðŸ“… {dayLabel}
                          </div>
                          <div style={{ fontSize: '11px', color: '#94a3b8' }}>
                            {savedRoute.customers.length} stops â€¢ {(savedRoute.totalDistance || 0).toFixed(1)} mi
                            {savedRoute.sentToTech && <span style={{ color: '#22c55e', marginLeft: '6px' }}>âœ“ Sent</span>}
                          </div>
                          <div style={{ display: 'flex', gap: '6px', marginTop: '8px' }}>
                            <button
                              onClick={() => {
                                if (savedRoute.sentToTech) {
                                  alert('This route has already been sent to the technician.');
                                  return;
                                }
                                const routeDateKey = new Date(savedRoute.scheduledDate).toDateString();
                                setRoutesByDay(prev => ({ ...prev, [routeDateKey]: savedRoute.customers }));
                                setEditingSavedRouteId(savedRoute.id);
                                setSelectedDate(new Date(savedRoute.scheduledDate));
                                setCustomers(prev => {
                                  const rcMap = new Map();
                                  savedRoute.customers.forEach(rc => rcMap.set(rc.id, rc));
                                  return prev.map(c => {
                                    const rc = rcMap.get(c.id);
                                    if (rc) return { ...c, scheduledTime: rc.scheduledTime || c.scheduledTime, scheduledDate: savedRoute.scheduledDate || rc.scheduledDate || c.scheduledDate, status: 'scheduled', routeConfirmed: true };
                                    return c;
                                  });
                                });
                                setSavedViewDays(prev => ({ ...prev, [routeDateKey]: false }));
                                setCurrentView('map');
                              }}
                              disabled={savedRoute.sentToTech}
                              style={{
                                padding: '4px 10px', fontSize: '11px', fontWeight: 600,
                                background: savedRoute.sentToTech ? 'rgba(100, 116, 139, 0.1)' : 'rgba(139, 92, 246, 0.15)',
                                border: savedRoute.sentToTech ? '1px solid rgba(100, 116, 139, 0.2)' : '1px solid rgba(139, 92, 246, 0.3)',
                                borderRadius: '5px',
                                color: savedRoute.sentToTech ? '#64748b' : '#a78bfa',
                                cursor: savedRoute.sentToTech ? 'not-allowed' : 'pointer',
                                opacity: savedRoute.sentToTech ? 0.5 : 1
                              }}
                            >âœï¸ Edit</button>
                            <button
                              onClick={() => emailRouteToTech(savedRoute)}
                              disabled={sendingEmail || savedRoute.sentToTech}
                              style={{
                                padding: '4px 10px', fontSize: '11px', fontWeight: 600,
                                background: savedRoute.sentToTech ? 'rgba(34, 197, 94, 0.05)' : sendingEmail ? 'rgba(34, 197, 94, 0.05)' : 'rgba(34, 197, 94, 0.15)', 
                                border: '1px solid rgba(34, 197, 94, 0.3)',
                                borderRadius: '5px', color: '#22c55e',
                                cursor: (sendingEmail || savedRoute.sentToTech) ? 'not-allowed' : 'pointer',
                                opacity: (sendingEmail || savedRoute.sentToTech) ? 0.5 : 1
                              }}
                            >{savedRoute.sentToTech ? 'âœ“ Sent' : sendingEmail ? 'â³ Sending...' : 'ðŸ“§ Send'}</button>
                            <button
                              onClick={() => {
                                if (window.confirm(`Delete route "${savedRoute.name}"?`)) {
                                  const routeCustomerIds = new Set(savedRoute.customers.map(c => c.id));
                                  savedRoute.customers.forEach(async (rc) => {
                                    const fullCustomer = customers.find(c => c.id === rc.id);
                                    propagateCustomerUpdate(rc.id, { scheduledDate: null, scheduledTime: null, status: 'unscheduled', routeConfirmed: false, confirmedRouteName: null });
                                    try {
                                      await apiFetch(`/customers/${rc.id}`, {
                                        method: 'PATCH',
                                        body: JSON.stringify({ status: 'unscheduled', scheduled_date: null })
                                      });
                                      const custJobsData = await apiFetch(`/jobs?customer_id=${rc.id}`);
                                      const activeJobs = (custJobsData.jobs || []).filter(j => j.status !== 'completed' && j.status !== 'cancelled');
                                      for (const j of activeJobs) {
                                        if (j.scheduled_date) {
                                          await apiFetch(`/jobs/${j.id}`, {
                                            method: 'PATCH',
                                            body: JSON.stringify({ scheduled_date: '', status: 'unscheduled' })
                                          });
                                        }
                                      }
                                    } catch (err) {
                                      console.error('Failed to clear job scheduled dates:', err);
                                    }
                                  });
                                  setCustomers(prev => prev.map(c => routeCustomerIds.has(c.id) ? { ...c, scheduledDate: null, scheduledTime: null, status: 'unscheduled', routeConfirmed: false, confirmedRouteName: null } : c));
                                  const routeDateKey = new Date(savedRoute.scheduledDate).toDateString();
                                  setRoutesByDay(prev => ({ ...prev, [routeDateKey]: [] }));
                                  setSavedViewDays(prev => ({ ...prev, [routeDateKey]: false }));
                                  setSavedRoutes(prev => prev.filter(r => r.id !== savedRoute.id));
                                }
                              }}
                              style={{
                                padding: '4px 8px', fontSize: '11px', fontWeight: 600,
                                background: 'rgba(239, 68, 68, 0.1)', border: '1px solid rgba(239, 68, 68, 0.3)',
                                borderRadius: '5px', color: '#fca5a5', cursor: 'pointer', marginLeft: 'auto'
                              }}
                            >ðŸ—‘ï¸</button>
                          </div>
                        </div>

                        {(() => {
                          const isExpanded = expandedSavedRouteId === savedRoute.id;
                          return (
                          <>
                        <div 
                          onClick={() => setExpandedSavedRouteId(isExpanded ? null : savedRoute.id)}
                          style={{ 
                            padding: '6px 14px', fontSize: '11px', color: '#94a3b8', cursor: 'pointer',
                            display: 'flex', alignItems: 'center', justifyContent: 'space-between',
                            background: 'rgba(15, 23, 42, 0.3)', borderBottom: isExpanded ? '1px solid rgba(139, 92, 246, 0.1)' : 'none'
                          }}
                          onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(139, 92, 246, 0.08)'}
                          onMouseLeave={(e) => e.currentTarget.style.background = 'rgba(15, 23, 42, 0.3)'}
                        >
                          <span style={{ fontWeight: 600 }}>{isExpanded ? 'â–¼' : 'â–¶'} {savedRoute.customers.length} stops</span>
                          <span style={{ fontSize: '10px' }}>{isExpanded ? 'Collapse' : 'Expand'}</span>
                        </div>

                        {!isExpanded && (
                        <div style={{ padding: '6px 8px', display: 'flex', flexDirection: 'column', gap: '2px' }}>
                          {savedRoute.customers.map((customer, index) => {
                            const timeSlot = customer.scheduledTime || '';
                            return (
                            <div key={customer.id} style={{ display: 'flex', gap: '6px', alignItems: 'center', padding: '3px 4px' }}>
                              <div style={{
                                width: '18px', height: '18px', borderRadius: '50%',
                                background: 'linear-gradient(135deg, #8b5cf6, #6d28d9)',
                                display: 'flex', alignItems: 'center', justifyContent: 'center',
                                fontSize: '9px', fontWeight: 700, color: 'white', flexShrink: 0
                              }}>{index + 1}</div>
                              <div style={{ flex: 1, minWidth: 0, fontSize: '11px', fontWeight: 600, color: '#e2e8f0', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                                {customer.name}
                              </div>
                              {timeSlot && (
                                <div style={{
                                  padding: '1px 5px', fontSize: '9px', fontWeight: 700,
                                  background: 'rgba(251, 191, 36, 0.2)', border: '1px solid rgba(251, 191, 36, 0.3)',
                                  borderRadius: '3px', color: '#fbbf24', flexShrink: 0, whiteSpace: 'nowrap'
                                }}>{formatTime12h(timeSlot)}</div>
                              )}
                            </div>
                            );
                          })}
                        </div>
                        )}

                        {isExpanded && (
                        <div style={{ padding: '8px', display: 'flex', flexDirection: 'column', gap: '0px', maxHeight: '500px', overflowY: 'auto' }} className="scrollbar-custom">
                          {savedRoute.customers.map((customer, index) => {
                            const timeSlot = customer.scheduledTime || '';
                            const prevPoint = index === 0 ? homeBase : savedRoute.customers[index - 1];
                            const legDist = (prevPoint && prevPoint.lat && prevPoint.lng && customer.lat && customer.lng)
                              ? calculateDistance(prevPoint.lat, prevPoint.lng, customer.lat, customer.lng) : null;
                            return (
                            <React.Fragment key={customer.id}>
                            {legDist !== null && (
                              <div style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '2px 0', justifyContent: 'center' }}>
                                <div style={{ flex: 1, height: '1px', background: 'rgba(139, 92, 246, 0.15)' }}></div>
                                <span style={{ fontSize: '9px', color: '#64748b', fontWeight: 600, whiteSpace: 'nowrap' }}>
                                  {index === 0 ? 'ðŸ ' : 'â†“'} {legDist.toFixed(1)} mi
                                </span>
                                <div style={{ flex: 1, height: '1px', background: 'rgba(139, 92, 246, 0.15)' }}></div>
                              </div>
                            )}
                            <div
                              style={{
                                padding: '10px',
                                background: 'rgba(15, 23, 42, 0.4)',
                                borderRadius: '8px',
                                border: '1px solid rgba(139, 92, 246, 0.15)'
                              }}
                            >
                              <div style={{ display: 'flex', gap: '8px', alignItems: 'center', marginBottom: '6px' }}>
                                <div style={{
                                  width: '24px', height: '24px', borderRadius: '50%',
                                  background: 'linear-gradient(135deg, #8b5cf6, #6d28d9)',
                                  display: 'flex', alignItems: 'center', justifyContent: 'center',
                                  fontSize: '11px', fontWeight: 700, color: 'white', flexShrink: 0
                                }}>{index + 1}</div>
                                <div style={{ flex: 1, minWidth: 0 }}>
                                  <div 
                                    onClick={() => {
                                      const fullCustomer = customers.find(c => c.id === customer.id) || customer;
                                      setProfileCustomer(fullCustomer);
                                      setShowCustomerProfile(true);
                                    }}
                                    style={{ fontSize: '13px', fontWeight: 600, color: '#c4b5fd', cursor: 'pointer' }}
                                    onMouseEnter={(e) => e.currentTarget.style.textDecoration = 'underline'}
                                    onMouseLeave={(e) => e.currentTarget.style.textDecoration = 'none'}
                                  >{customer.name}</div>
                                </div>
                              </div>

                              <div style={{ marginLeft: '32px' }}>
                                <div style={{ fontSize: '10px', color: '#94a3b8', marginBottom: '4px' }}>
                                  ðŸ“ {customer.address}
                                </div>
                                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px', fontSize: '10px', color: '#94a3b8', marginBottom: '6px' }}>
                                  {customer.phone && <span>ðŸ“ž {customer.phone}</span>}
                                  {customer.email && <span>ðŸ“§ {customer.email}</span>}
                                </div>

                                <div style={{ display: 'flex', alignItems: 'center', gap: '6px', marginBottom: '6px' }}>
                                  <span style={{ fontSize: '10px', color: '#94a3b8', fontWeight: 600 }}>Time:</span>
                                  <input
                                    type="time"
                                    value={timeSlot}
                                    onChange={(e) => {
                                      const newTime = e.target.value;
                                      setSavedRoutes(prev => prev.map(r => {
                                        if (r.id === savedRoute.id) {
                                          return { ...r, customers: r.customers.map(c =>
                                            c.id === customer.id ? { ...c, scheduledTime: newTime } : c
                                          )};
                                        }
                                        return r;
                                      }));
                                      setCustomers(prev => prev.map(c =>
                                        c.id === customer.id ? { ...c, scheduledTime: newTime } : c
                                      ));
                                      propagateCustomerUpdate(customer.id, { scheduledTime: newTime });
                                    }}
                                    style={{
                                      padding: '3px 6px', fontSize: '11px', fontWeight: 600,
                                      background: 'rgba(251, 191, 36, 0.1)', border: '1px solid rgba(251, 191, 36, 0.3)',
                                      borderRadius: '4px', color: '#fbbf24', fontFamily: 'inherit'
                                    }}
                                  />
                                </div>

                                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '4px', marginBottom: '6px' }}>
                                  {customer.panelCount && (
                                    <span style={{ fontSize: '9px', padding: '2px 6px', background: 'rgba(251, 191, 36, 0.15)', borderRadius: '3px', color: '#fbbf24' }}>
                                      â˜€ï¸ {customer.panelCount} panels
                                    </span>
                                  )}
                                  {(customer.isRecurring || customer.recurring) && (
                                    <span style={{ fontSize: '9px', padding: '2px 6px', background: 'rgba(59, 130, 246, 0.15)', borderRadius: '3px', color: '#3b82f6' }}>Recurring</span>
                                  )}
                                  {customer.lastServiceDate && (
                                    <span style={{ fontSize: '9px', padding: '2px 6px', background: 'rgba(100, 116, 139, 0.15)', borderRadius: '3px', color: '#94a3b8' }}>
                                      Last: {new Date(customer.lastServiceDate).toLocaleDateString()}
                                    </span>
                                  )}
                                </div>

                                {editingCustomerNotes?.routeId === savedRoute.id && editingCustomerNotes?.customerId === customer.id ? (
                                  <div>
                                    <textarea
                                      value={editedNotes}
                                      onChange={(e) => setEditedNotes(e.target.value)}
                                      placeholder="Gate codes, instructions..."
                                      autoFocus rows="2"
                                      style={{
                                        width: '100%', padding: '6px', background: 'rgba(15, 23, 42, 0.5)',
                                        border: '1px solid rgba(139, 92, 246, 0.3)', borderRadius: '4px',
                                        color: '#f1f5f9', fontSize: '10px', resize: 'vertical', fontFamily: 'inherit', marginBottom: '4px'
                                      }}
                                    />
                                    <div style={{ display: 'flex', gap: '6px', justifyContent: 'flex-end' }}>
                                      <button onClick={() => { setEditingCustomerNotes(null); setEditedNotes(''); }}
                                        style={{ padding: '3px 8px', background: 'rgba(100,116,139,0.2)', border: '1px solid rgba(100,116,139,0.3)', borderRadius: '4px', color: '#94a3b8', fontSize: '10px', cursor: 'pointer', fontWeight: 600 }}>Cancel</button>
                                      <button onClick={() => {
                                        setSavedRoutes(prev => prev.map(r => r.id === savedRoute.id ? { ...r, customers: r.customers.map(c => c.id === customer.id ? { ...c, jobNotes: editedNotes } : c) } : r));
                                        apiFetch('/jobs?customer_id=' + customer.id).then(data => {
                                          if (data && data.jobs) {
                                            const activeJob = data.jobs.find(j => j.status !== 'completed' && j.status !== 'cancelled');
                                            if (activeJob) {
                                              apiFetch(`/jobs/${activeJob.id}`, {
                                                method: 'PATCH',
                                                body: JSON.stringify({ notes: editedNotes })
                                              }).catch(e => console.error('Failed to sync notes to job:', e));
                                            }
                                          }
                                        }).catch(e => console.error('Failed to fetch jobs for note sync:', e));
                                        setEditingCustomerNotes(null); setEditedNotes('');
                                      }}
                                        style={{ padding: '3px 8px', background: 'rgba(34,197,94,0.2)', border: '1px solid rgba(34,197,94,0.3)', borderRadius: '4px', color: '#22c55e', fontSize: '10px', cursor: 'pointer', fontWeight: 600 }}>Save</button>
                                    </div>
                                  </div>
                                ) : (
                                  <div 
                                    onClick={() => { setEditingCustomerNotes({ routeId: savedRoute.id, customerId: customer.id }); setEditedNotes(customer.jobNotes || ''); }}
                                    style={{ padding: '4px 6px', background: 'rgba(139,92,246,0.08)', borderRadius: '4px', fontSize: '10px', color: '#c4b5fd', cursor: 'pointer', lineHeight: '1.4' }}
                                  >
                                    ðŸ“ {customer.jobNotes || <span style={{ fontStyle: 'italic', opacity: 0.5 }}>Add job notes...</span>}
                                  </div>
                                )}
                              </div>
                            </div>
                            </React.Fragment>
                            );
                          })}
                          {(() => {
                            const lastCustomer = savedRoute.customers[savedRoute.customers.length - 1];
                            const returnDist = (homeBase && lastCustomer && lastCustomer.lat && lastCustomer.lng)
                              ? calculateDistance(lastCustomer.lat, lastCustomer.lng, homeBase.lat, homeBase.lng) : null;
                            return returnDist !== null ? (
                              <div style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '2px 0', justifyContent: 'center' }}>
                                <div style={{ flex: 1, height: '1px', background: 'rgba(139, 92, 246, 0.15)' }}></div>
                                <span style={{ fontSize: '9px', color: '#64748b', fontWeight: 600, whiteSpace: 'nowrap' }}>
                                  ðŸ  {returnDist.toFixed(1)} mi
                                </span>
                                <div style={{ flex: 1, height: '1px', background: 'rgba(139, 92, 246, 0.15)' }}></div>
                              </div>
                            ) : null;
                          })()}
                        </div>
                        )}
                          </>
                          );
                        })()}
                      </div>
                        );
                    })}
                  </div>
                )}
              </div>
            )}

            {/* ðŸ“œ Route History View */}
            {currentView === 'history' && (
              <div style={{ 
                position: 'absolute',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                overflow: 'auto',
                padding: '24px'
              }} className="scrollbar-custom">
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px', flexWrap: 'wrap', gap: '12px' }}>
                  <h2 style={{ fontSize: '20px', fontWeight: 800, margin: 0 }}>ðŸ“œ Route History</h2>
                  <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                    <span style={{ fontSize: '12px', color: '#64748b' }}>Routes sent to technician</span>
                    <button onClick={refreshRouteStopStatus} style={{ padding: '4px 10px', fontSize: '11px', fontWeight: 600, background: 'rgba(99, 102, 241, 0.15)', border: '1px solid rgba(99, 102, 241, 0.3)', borderRadius: '6px', color: '#818cf8', cursor: 'pointer' }}>â†» Refresh</button>
                  </div>
                </div>
                
                {savedRoutes.filter(r => r.sentToTech).length === 0 ? (
                  <div style={{ textAlign: 'center', padding: '80px 20px', color: '#64748b' }}>
                    <div style={{ fontSize: '64px', marginBottom: '16px' }}>ðŸ“œ</div>
                    <div style={{ fontSize: '18px', fontWeight: 600, marginBottom: '8px' }}>No route history yet</div>
                    <div style={{ fontSize: '14px' }}>Routes will appear here after being sent to the technician.</div>
                  </div>
                ) : (
                  <div style={{ display: 'flex', gap: '16px', flexWrap: 'wrap', alignItems: 'flex-start' }}>
                    {savedRoutes
                      .filter(r => r.sentToTech)
                      .sort((a, b) => new Date(b.scheduledDate || b.date) - new Date(a.scheduledDate || a.date))
                      .map((savedRoute) => {
                        const schedDate = savedRoute.scheduledDate ? new Date(savedRoute.scheduledDate) : null;
                        const dayLabel = schedDate ? schedDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) : 'Unscheduled';
                        const totalMiles = (() => {
                          let total = 0;
                          const stops = savedRoute.customers || [];
                          if (homeBase && stops.length > 0 && stops[0].lat && stops[0].lng) {
                            total += calculateDistance(homeBase.lat, homeBase.lng, stops[0].lat, stops[0].lng);
                          }
                          for (let i = 0; i < stops.length - 1; i++) {
                            if (stops[i].lat && stops[i].lng && stops[i+1].lat && stops[i+1].lng) {
                              total += calculateDistance(stops[i].lat, stops[i].lng, stops[i+1].lat, stops[i+1].lng);
                            }
                          }
                          if (homeBase && stops.length > 0) {
                            const last = stops[stops.length - 1];
                            if (last.lat && last.lng) total += calculateDistance(last.lat, last.lng, homeBase.lat, homeBase.lng);
                          }
                          return total;
                        })();
                        return (
                      <div key={savedRoute.id} className="glass-card" style={{ 
                        padding: '0', 
                        width: '280px',
                        minWidth: '260px',
                        flex: '0 0 280px',
                        display: 'flex',
                        flexDirection: 'column',
                        overflow: 'hidden',
                        opacity: 0.85
                      }}>
                        <div style={{ 
                          padding: '12px 14px',
                          background: 'rgba(34, 197, 94, 0.12)',
                          borderBottom: '1px solid rgba(34, 197, 94, 0.2)'
                        }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '6px' }}>
                            <span style={{ fontSize: '14px', fontWeight: 700, color: '#f1f5f9' }}>{savedRoute.name}</span>
                            {savedRoute.completedAt ? (
                              <span style={{ fontSize: '10px', padding: '2px 8px', background: 'rgba(34, 197, 94, 0.2)', borderRadius: '10px', color: '#22c55e', fontWeight: 600 }}>âœ“ Completed</span>
                            ) : (
                              <span style={{ fontSize: '10px', padding: '2px 8px', background: 'rgba(251, 191, 36, 0.2)', borderRadius: '10px', color: '#fbbf24', fontWeight: 600 }}>In Progress</span>
                            )}
                          </div>
                          <div style={{ display: 'flex', gap: '8px', alignItems: 'center', flexWrap: 'wrap' }}>
                            <span style={{ fontSize: '11px', color: '#94a3b8' }}>ðŸ“… {dayLabel}</span>
                            <span style={{ fontSize: '11px', color: '#94a3b8' }}>ðŸ‘¥ {savedRoute.customers.length} stops</span>
                            {totalMiles > 0 && <span style={{ fontSize: '11px', color: '#94a3b8' }}>ðŸš— {totalMiles.toFixed(1)} mi</span>}
                            {savedRoute.sentAt && <span style={{ fontSize: '10px', color: '#64748b' }}>Sent {new Date(savedRoute.sentAt).toLocaleDateString()}</span>}
                            {savedRoute.completedAt && <span style={{ fontSize: '10px', color: '#22c55e' }}>Done {new Date(savedRoute.completedAt).toLocaleDateString()}</span>}
                          </div>
                          {!savedRoute.completedAt && savedRoute._completedStopCount !== undefined && savedRoute._totalStopCount > 0 && (
                            <div style={{ marginTop: '8px' }}>
                              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                                <span style={{ fontSize: '11px', color: '#94a3b8' }}>{savedRoute._completedStopCount} of {savedRoute._totalStopCount} done by tech</span>
                                <span style={{ fontSize: '11px', color: '#22c55e', fontWeight: 600 }}>{Math.round((savedRoute._completedStopCount / savedRoute._totalStopCount) * 100)}%</span>
                              </div>
                              <div style={{ height: '4px', background: 'rgba(255,255,255,0.1)', borderRadius: '2px', overflow: 'hidden' }}>
                                <div style={{ height: '100%', width: `${(savedRoute._completedStopCount / savedRoute._totalStopCount) * 100}%`, background: '#22c55e', borderRadius: '2px', transition: 'width 0.3s' }}></div>
                              </div>
                            </div>
                          )}
                          {!savedRoute.completedAt && (
                            <button
                              onClick={() => completeRoute(savedRoute)}
                              style={{
                                marginTop: '8px', padding: '6px 12px', fontSize: '12px', fontWeight: 700,
                                background: 'rgba(34, 197, 94, 0.2)', border: '1px solid rgba(34, 197, 94, 0.4)',
                                borderRadius: '6px', color: '#22c55e', cursor: 'pointer', width: '100%'
                              }}
                            >âœ“ Mark Complete</button>
                          )}
                        </div>

                        <div style={{ padding: '8px 10px', display: 'flex', flexDirection: 'column', gap: '6px', flex: 1, overflowY: 'auto', maxHeight: '300px' }} className="scrollbar-custom">
                          {savedRoute.customers.map((customer, idx) => {
                            const timeSlot = customer.scheduledTime || '';
                            return (
                              <div key={customer.id} style={{ 
                                padding: '8px 10px',
                                background: customer._stopCompleted ? 'rgba(34, 197, 94, 0.08)' : 'rgba(15, 23, 42, 0.4)',
                                borderRadius: '6px',
                                borderLeft: `3px solid ${customer._stopCompleted ? 'rgba(34, 197, 94, 0.8)' : 'rgba(34, 197, 94, 0.4)'}`,
                                opacity: customer._stopCompleted ? 0.7 : 1
                              }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '6px', marginBottom: '4px' }}>
                                  <span style={{ fontSize: '10px', fontWeight: 700, color: '#22c55e', width: '18px', height: '18px', display: 'flex', alignItems: 'center', justifyContent: 'center', background: customer._stopCompleted ? 'rgba(34, 197, 94, 0.3)' : 'rgba(34, 197, 94, 0.15)', borderRadius: '50%' }}>{customer._stopCompleted ? 'âœ“' : idx + 1}</span>
                                  <span style={{ fontSize: '12px', fontWeight: 600, color: customer._stopCompleted ? '#86efac' : '#e2e8f0', textDecoration: customer._stopCompleted ? 'line-through' : 'none' }}>{customer.name}</span>
                                  {timeSlot && <span style={{ fontSize: '10px', color: '#fbbf24', marginLeft: 'auto' }}>â° {timeSlot}</span>}
                                </div>
                                <div style={{ fontSize: '10px', color: '#94a3b8', marginLeft: '24px' }}>
                                  ðŸ“ {customer.address}
                                </div>
                                {customer.phone && <div style={{ fontSize: '10px', color: '#94a3b8', marginLeft: '24px' }}>ðŸ“ž {customer.phone}</div>}
                                {customer.panelCount && (
                                  <span style={{ fontSize: '9px', padding: '2px 6px', background: 'rgba(251, 191, 36, 0.15)', borderRadius: '3px', color: '#fbbf24', marginLeft: '24px', display: 'inline-block', marginTop: '2px' }}>
                                    â˜€ï¸ {customer.panelCount} panels
                                  </span>
                                )}
                                {customer.customerNotes && (
                                  <div style={{ fontSize: '10px', color: '#93c5fd', marginLeft: '24px', marginTop: '3px' }}>ðŸ‘¤ {customer.customerNotes}</div>
                                )}
                                {customer.jobNotes && (
                                  <div style={{ fontSize: '10px', color: '#fde68a', marginLeft: '24px', marginTop: '2px' }}>ðŸ“ {customer.jobNotes}</div>
                                )}
                              </div>
                            );
                          })}
                        </div>
                      </div>
                        );
                    })}
                  </div>
                )}
              </div>
            )}

            {/* Pipeline View - Database Customers */}
            {currentView === 'pipeline' && (
              <div style={{
                position: 'absolute',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                overflow: 'auto',
                padding: '32px'
              }} className="scrollbar-custom">
                {/* Customer Type Tabs */}
                <div style={{ display: 'flex', gap: '4px', alignItems: 'center', marginBottom: '16px', flexWrap: 'wrap' }}>
                  {allTypeTabs.map(tab => {
                    const count = tab.key === 'all' ? customers.length : customers.filter(c => (c.customerType || 'residential') === tab.key).length;
                    return (
                      <button
                        key={tab.key}
                        onClick={() => setActiveCustomerType(tab.key)}
                        style={{
                          padding: '6px 14px',
                          background: activeCustomerType === tab.key ? 'rgba(139, 92, 246, 0.25)' : 'transparent',
                          border: activeCustomerType === tab.key ? '1px solid rgba(139, 92, 246, 0.5)' : '1px solid transparent',
                          borderBottom: activeCustomerType === tab.key ? '2px solid #8b5cf6' : '2px solid transparent',
                          borderRadius: '8px 8px 0 0',
                          color: activeCustomerType === tab.key ? '#a78bfa' : '#94a3b8',
                          fontSize: '13px',
                          fontWeight: activeCustomerType === tab.key ? 700 : 500,
                          cursor: 'pointer',
                          transition: 'all 0.2s'
                        }}
                      >
                        {tab.label} <span style={{ fontSize: '11px', opacity: 0.7 }}>({count})</span>
                      </button>
                    );
                  })}
                  {showAddTabInput ? (
                    <div style={{ display: 'flex', gap: '4px', alignItems: 'center' }}>
                      <input
                        type="text"
                        value={newTabName}
                        onChange={(e) => setNewTabName(e.target.value)}
                        onKeyDown={(e) => {
                          if (e.key === 'Enter' && newTabName.trim()) {
                            const key = newTabName.trim().toLowerCase().replace(/[^a-z0-9]/g, '_');
                            const newTab = { key, label: newTabName.trim() };
                            const updated = [...customTypeTabs, newTab];
                            setCustomTypeTabs(updated);
                            localStorage.setItem('customTypeTabs', JSON.stringify(updated));
                            setNewTabName('');
                            setShowAddTabInput(false);
                            setActiveCustomerType(key);
                          }
                          if (e.key === 'Escape') { setShowAddTabInput(false); setNewTabName(''); }
                        }}
                        placeholder="Tab name..."
                        autoFocus
                        style={{
                          padding: '4px 8px', fontSize: '12px', background: 'rgba(30,41,59,0.8)',
                          border: '1px solid rgba(139,92,246,0.3)', borderRadius: '6px', color: '#f1f5f9', width: '100px'
                        }}
                      />
                      <button onClick={() => { setShowAddTabInput(false); setNewTabName(''); }} style={{ background: 'none', border: 'none', color: '#94a3b8', cursor: 'pointer', fontSize: '14px' }}>âœ•</button>
                    </div>
                  ) : (
                    <button
                      onClick={() => setShowAddTabInput(true)}
                      style={{
                        padding: '4px 8px', background: 'none', border: '1px dashed rgba(148,163,184,0.3)',
                        borderRadius: '6px', color: '#64748b', fontSize: '12px', cursor: 'pointer'
                      }}
                      title="Add custom tab"
                    >+</button>
                  )}
                </div>

                {/* Pipeline Header */}
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <h2 style={{ fontSize: '20px', fontWeight: 800, margin: 0 }}>ðŸ“‹ Customer Database</h2>
                    <span style={{ fontSize: '11px', padding: '3px 8px', background: 'rgba(139, 92, 246, 0.2)', border: '1px solid rgba(139, 92, 246, 0.3)', borderRadius: '12px', color: '#a78bfa' }}>
                      {typeFilteredCustomers.length}
                    </span>
                  </div>
                  <div style={{ display: 'flex', gap: '6px', alignItems: 'center' }}>
                    {/* Search */}
                    <div style={{ position: 'relative', width: '180px' }}>
                      <input
                        type="text"
                        placeholder="Search..."
                        value={pipelineGlobalSearch}
                        onChange={(e) => setPipelineGlobalSearch(e.target.value)}
                        style={{
                          width: '100%', padding: '6px 10px 6px 28px',
                          background: 'rgba(30, 41, 59, 0.8)', border: '1px solid rgba(148, 163, 184, 0.2)',
                          borderRadius: '8px', color: '#f1f5f9', fontSize: '12px', outline: 'none'
                        }}
                      />
                      <span style={{ position: 'absolute', left: '8px', top: '50%', transform: 'translateY(-50%)', fontSize: '12px', color: '#64748b' }}>ðŸ”</span>
                    </div>
                    {/* Filter Icon */}
                    <button
                      onClick={() => setShowPipelineFilterPanel(!showPipelineFilterPanel)}
                      title="Filters & Columns"
                      style={{
                        padding: '6px 8px',
                        background: (showPipelineFilterPanel || pipelineQuickFilter !== 'all') ? 'rgba(139, 92, 246, 0.3)' : 'rgba(30, 41, 59, 0.5)',
                        border: '1px solid ' + ((showPipelineFilterPanel || pipelineQuickFilter !== 'all') ? 'rgba(139, 92, 246, 0.5)' : 'rgba(148, 163, 184, 0.15)'),
                        borderRadius: '8px',
                        color: (showPipelineFilterPanel || pipelineQuickFilter !== 'all') ? '#a78bfa' : '#94a3b8',
                        fontSize: '16px', cursor: 'pointer', lineHeight: 1, position: 'relative'
                      }}
                    >
                      âš™ï¸
                      {pipelineQuickFilter !== 'all' && (
                        <span style={{ position: 'absolute', top: '-2px', right: '-2px', width: '8px', height: '8px', background: '#8b5cf6', borderRadius: '50%' }} />
                      )}
                    </button>
                    {/* Action buttons */}
                    <button onClick={() => fileInputRef.current?.click()} style={{ padding: '6px 10px', background: 'rgba(139, 92, 246, 0.2)', border: '1px solid rgba(139, 92, 246, 0.3)', borderRadius: '8px', color: '#a78bfa', fontSize: '12px', fontWeight: 600, cursor: 'pointer' }}>ðŸ“¤ CSV</button>
                    <button onClick={() => setShowNewCustomerForm(true)} style={{ padding: '6px 10px', background: 'rgba(34, 197, 94, 0.2)', border: '1px solid rgba(34, 197, 94, 0.3)', borderRadius: '8px', color: '#22c55e', fontSize: '12px', fontWeight: 600, cursor: 'pointer' }}>+ New</button>
                    <button onClick={() => window.open('/api/export/csv', '_blank')} style={{ padding: '6px 10px', background: 'rgba(34, 197, 94, 0.2)', border: '1px solid rgba(34, 197, 94, 0.3)', borderRadius: '8px', color: '#22c55e', fontSize: '12px', fontWeight: 600, cursor: 'pointer' }}>ðŸ“¥ Export</button>
                    {csvUploadStatus && (
                      <span style={{ color: '#fbbf24', fontSize: '11px', padding: '4px 8px', background: 'rgba(251, 191, 36, 0.1)', borderRadius: '6px', border: '1px solid rgba(251, 191, 36, 0.2)' }}>â³ {csvUploadStatus}</span>
                    )}
                  </div>
                </div>

                {/* Filter & Column Panel - toggled by filter icon */}
                {showPipelineFilterPanel && (
                  <div style={{ marginBottom: '12px', padding: '12px 16px', background: 'rgba(15, 23, 42, 0.6)', border: '1px solid rgba(148, 163, 184, 0.15)', borderRadius: '10px' }}>
                    <div style={{ display: 'flex', gap: '12px', alignItems: 'center', flexWrap: 'wrap' }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                        <span style={{ fontSize: '11px', color: '#94a3b8', fontWeight: 600, textTransform: 'uppercase' }}>Quick Filter</span>
                        <select
                          value={pipelineQuickFilter}
                          onChange={(e) => {
                            const key = e.target.value;
                            setPipelineQuickFilter(key);
                            const matchCol = quickFilterColumnMap[key];
                            if (key === 'all') { setTempUnhiddenColumns([]); }
                            else if (matchCol && savedHiddenColumns.includes(matchCol)) { setTempUnhiddenColumns([matchCol]); }
                            else { setTempUnhiddenColumns([]); }
                          }}
                          style={{
                            padding: '5px 8px', background: 'rgba(30, 41, 59, 0.8)',
                            border: '1px solid rgba(139, 92, 246, 0.3)', borderRadius: '6px',
                            color: pipelineQuickFilter !== 'all' ? '#a78bfa' : '#94a3b8',
                            fontSize: '12px', fontWeight: 600, cursor: 'pointer'
                          }}
                        >
                          <option value="all">All</option>
                          <option value="unscheduled">Unscheduled</option>
                          <option value="scheduled">Scheduled</option>
                          <option value="recurring">Recurring</option>
                          <option value="has_email">Has Email</option>
                          <option value="has_phone">Has Phone</option>
                        </select>
                      </div>
                      <div style={{ width: '1px', height: '20px', background: 'rgba(148,163,184,0.15)' }} />
                      <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                        <span style={{ fontSize: '11px', color: '#94a3b8', fontWeight: 600, textTransform: 'uppercase' }}>Columns</span>
                        <button
                          onClick={() => setShowColumnManager(!showColumnManager)}
                          style={{
                            padding: '5px 8px', background: showColumnManager ? 'rgba(139, 92, 246, 0.3)' : 'rgba(30, 41, 59, 0.5)',
                            border: '1px solid ' + (showColumnManager ? 'rgba(139, 92, 246, 0.5)' : 'rgba(148, 163, 184, 0.15)'),
                            borderRadius: '6px', color: showColumnManager ? '#a78bfa' : '#94a3b8',
                            fontSize: '12px', fontWeight: 600, cursor: 'pointer'
                          }}
                        >
                          {pipelineColumns.length}/{pipelineColumnsAll.length} visible
                        </button>
                      </div>
                      {(pipelineGlobalSearch || pipelineQuickFilter !== 'all' || Object.values(pipelineFilters).some(f => f)) && (
                        <React.Fragment>
                          <div style={{ width: '1px', height: '20px', background: 'rgba(148,163,184,0.15)' }} />
                          <button
                            onClick={() => {
                              setPipelineGlobalSearch('');
                              setPipelineQuickFilter('all');
                              setPipelineFilters({});
                              setPipelineSortColumn(null);
                              setTempUnhiddenColumns([]);
                            }}
                            style={{
                              padding: '5px 10px', background: 'rgba(239, 68, 68, 0.15)',
                              border: '1px solid rgba(239, 68, 68, 0.3)', borderRadius: '6px',
                              color: '#ef4444', fontSize: '11px', fontWeight: 600, cursor: 'pointer'
                            }}
                          >
                            Clear All
                          </button>
                        </React.Fragment>
                      )}
                    </div>
                  </div>
                )}

                {/* Column Manager Panel */}
                {showColumnManager && (
                  <div style={{
                    marginBottom: '16px',
                    padding: '16px',
                    background: 'rgba(15, 23, 42, 0.6)',
                    border: '1px solid rgba(148, 163, 184, 0.15)',
                    borderRadius: '12px'
                  }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                      <span style={{ fontSize: '13px', fontWeight: 600, color: '#e2e8f0' }}>Show/Hide Columns</span>
                      <div style={{ display: 'flex', gap: '8px' }}>
                        <button onClick={() => saveColumnView([])} style={{ padding: '4px 12px', background: 'rgba(34, 197, 94, 0.2)', border: '1px solid rgba(34, 197, 94, 0.3)', borderRadius: '6px', color: '#22c55e', fontSize: '11px', fontWeight: 600, cursor: 'pointer' }}>Show All</button>
                        <button onClick={() => setShowColumnManager(false)} style={{ padding: '4px 12px', background: 'rgba(100, 116, 139, 0.2)', border: '1px solid rgba(100, 116, 139, 0.3)', borderRadius: '6px', color: '#94a3b8', fontSize: '11px', fontWeight: 600, cursor: 'pointer' }}>Done</button>
                      </div>
                    </div>
                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                      {pipelineColumnsAll.map(col => {
                        const isVisible = !savedHiddenColumns.includes(col.key);
                        return (
                          <button
                            key={col.key}
                            onClick={() => {
                              const newHidden = isVisible
                                ? [...savedHiddenColumns, col.key]
                                : savedHiddenColumns.filter(k => k !== col.key);
                              const visibleAfter = allColumnKeys.filter(k => !newHidden.includes(k));
                              if (visibleAfter.length === 0) return;
                              saveColumnView(newHidden);
                            }}
                            style={{
                              padding: '6px 14px',
                              background: isVisible ? 'rgba(139, 92, 246, 0.25)' : 'rgba(30, 41, 59, 0.5)',
                              border: isVisible ? '1px solid rgba(139, 92, 246, 0.5)' : '1px solid rgba(100, 116, 139, 0.2)',
                              borderRadius: '20px',
                              color: isVisible ? '#a78bfa' : '#64748b',
                              fontSize: '12px',
                              fontWeight: 600,
                              cursor: 'pointer',
                              transition: 'all 0.2s'
                            }}
                          >
                            {isVisible ? 'âœ“' : ''} {col.label}
                          </button>
                        );
                      })}
                    </div>
                  </div>
                )}

                                {/* Results Info */}
                {customers.length === 0 ? (
                  <div style={{ textAlign: 'center', padding: '80px 20px', color: '#64748b' }}>
                    <div style={{ fontSize: '64px', marginBottom: '16px' }}>ðŸ“‹</div>
                    <div style={{ fontSize: '18px', fontWeight: 600, marginBottom: '8px' }}>No customers yet</div>
                    <div style={{ fontSize: '14px', marginBottom: '24px' }}>
                      Upload a CSV file or create a new customer to get started.
                    </div>
                    <div style={{ display: 'flex', gap: '12px', justifyContent: 'center' }}>
                      <button
                        onClick={() => fileInputRef.current?.click()}
                        style={{
                          padding: '10px 20px',
                          background: 'rgba(139, 92, 246, 0.2)',
                          border: '1px solid rgba(139, 92, 246, 0.3)',
                          borderRadius: '8px',
                          color: '#a78bfa',
                          fontSize: '14px',
                          fontWeight: 600,
                          cursor: 'pointer'
                        }}
                      >
                        ðŸ“¤ Upload CSV
                      </button>
                      <button
                        onClick={() => setShowNewCustomerForm(true)}
                        style={{
                          padding: '10px 20px',
                          background: 'rgba(34, 197, 94, 0.2)',
                          border: '1px solid rgba(34, 197, 94, 0.3)',
                          borderRadius: '8px',
                          color: '#22c55e',
                          fontSize: '14px',
                          fontWeight: 600,
                          cursor: 'pointer'
                        }}
                      >
                        + New Customer
                      </button>
                    </div>
                  </div>
                ) : (
                  <div style={{ overflowX: 'auto' }}>
                    <div style={{
                      marginBottom: '12px',
                      fontSize: '13px',
                      color: '#94a3b8',
                      display: 'flex',
                      justifyContent: 'space-between',
                      alignItems: 'center'
                    }}>
                      <span>{(() => { const filtered = getFilteredPipelineData(); return filtered.length !== customers.length ? `Showing ${filtered.length} of ${customers.length}` : `${customers.length}`; })()} customers</span>
                      {pipelineSortColumn && (
                        <span style={{ color: '#a78bfa' }}>
                          Sorted by: {pipelineColumnsAll.find(c => c.key === pipelineSortColumn)?.label} ({pipelineSortOrder === 'asc' ? 'A-Z' : 'Z-A'})
                        </span>
                      )}
                    </div>
                    <table className="pipeline-table">
                      <thead>
                        <tr>
                          {pipelineColumns.map(col => (
                            <th
                              key={col.key}
                              onClick={() => sortPipelineData(col.key)}
                              style={{
                                cursor: 'pointer',
                                userSelect: 'none',
                                whiteSpace: 'nowrap',
                                minWidth: col.width,
                                background: pipelineSortColumn === col.key ? 'rgba(139, 92, 246, 0.3)' : undefined
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'center', gap: '4px', width: '100%' }}>
                                <span style={{ flex: 1 }}>{col.label}</span>
                                <span style={{
                                  fontSize: '10px',
                                  opacity: pipelineSortColumn === col.key ? 1 : 0.4,
                                  color: pipelineSortColumn === col.key ? '#a78bfa' : '#64748b'
                                }}>
                                  {pipelineSortColumn === col.key
                                    ? (pipelineSortOrder === 'asc' ? 'â–²' : 'â–¼')
                                    : 'â‡…'
                                  }
                                </span>
                                <span
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    const newHidden = [...savedHiddenColumns, col.key];
                                    const visibleAfter = allColumnKeys.filter(k => !newHidden.includes(k));
                                    if (visibleAfter.length === 0) return;
                                    saveColumnView(newHidden);
                                  }}
                                  title={'Hide ' + col.label}
                                  style={{
                                    fontSize: '11px',
                                    color: '#64748b',
                                    cursor: 'pointer',
                                    padding: '0 2px',
                                    borderRadius: '3px',
                                    lineHeight: 1,
                                    opacity: 0.5,
                                    transition: 'opacity 0.15s'
                                  }}
                                  onMouseEnter={(e) => e.target.style.opacity = 1}
                                  onMouseLeave={(e) => e.target.style.opacity = 0.5}
                                >âœ•</span>
                              </div>
                            </th>
                          ))}
                          <th style={{ whiteSpace: 'nowrap', minWidth: '70px', textAlign: 'center' }}>Actions</th>
                        </tr>

                      </thead>
                      <tbody>
                        {getFilteredPipelineData().map((customer) => (
                          <tr key={customer.id || customer.address}>
                            {pipelineColumns.map(col => {
                              const cellId = customer.id + '_' + col.key;
                              const isEditing = editingCell === cellId;
                              const cellValue = getCustomerFieldValue(customer, col.key);

                              const startEdit = (e) => {
                                e.stopPropagation();
                                if (col.key === 'name') return;
                                setEditingCell(cellId);
                                setEditingCellValue(String(cellValue || ''));
                              };

                              const confirmEdit = () => {
                                const fieldKey = col.key === 'panelCount' ? 'panelCount' : col.key;
                                let updateVal = editingCellValue;
                                if (col.key === 'isRecurring') {
                                  updateVal = (editingCellValue === 'Yes' || editingCellValue === 'true' || editingCellValue === 'TRUE');
                                } else if (col.key === 'panelCount' || col.key === 'amountPaid') {
                                  updateVal = editingCellValue ? parseFloat(editingCellValue) || 0 : '';
                                }
                                if (fieldKey === 'status' && updateVal === 'unscheduled' && !customerHasOpenJobs(customer)) {
                                  alert('Cannot set to Unscheduled â€” this customer has no open jobs. Add a job first.');
                                  setEditingCell(null);
                                  return;
                                }
                                const updates = {};
                                updates[fieldKey] = updateVal;
                                if (fieldKey === 'panelCount') updates.totalPanels = updateVal;
                                propagateCustomerUpdate(customer.id, updates);
                                setEditingCell(null);
                              };

                              const cancelEdit = () => {
                                setEditingCell(null);
                              };

                              if (isEditing) {
                                return (
                                  <td key={col.key} style={{ padding: '2px 4px' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                      {col.key === 'status' ? (
                                        <select
                                          value={editingCellValue}
                                          onChange={(e) => setEditingCellValue(e.target.value)}
                                          autoFocus
                                          style={{ flex: 1, padding: '4px 6px', background: 'rgba(30, 41, 59, 0.9)', border: '1px solid rgba(139, 92, 246, 0.5)', borderRadius: '4px', color: '#f1f5f9', fontSize: '12px', outline: 'none' }}
                                        >
                                          <option value="">None</option>
                                          <option value="unscheduled">Unscheduled</option>
                                          <option value="scheduled">Scheduled</option>
                                          <option value="in progress">In Progress</option>
                                        </select>
                                      ) : col.key === 'isRecurring' ? (
                                        <select
                                          value={editingCellValue === 'Yes' || editingCellValue === 'true' ? 'Yes' : ''}
                                          onChange={(e) => setEditingCellValue(e.target.value)}
                                          autoFocus
                                          style={{ flex: 1, padding: '4px 6px', background: 'rgba(30, 41, 59, 0.9)', border: '1px solid rgba(139, 92, 246, 0.5)', borderRadius: '4px', color: '#f1f5f9', fontSize: '12px', outline: 'none' }}
                                        >
                                          <option value="">No</option>
                                          <option value="Yes">Yes</option>
                                        </select>
                                      ) : (
                                        <input
                                          type={col.key.includes('Date') ? 'date' : 'text'}
                                          value={editingCellValue}
                                          onChange={(e) => setEditingCellValue(e.target.value)}
                                          onKeyDown={(e) => { if (e.key === 'Enter') confirmEdit(); if (e.key === 'Escape') cancelEdit(); }}
                                          autoFocus
                                          style={{ flex: 1, padding: '4px 6px', background: 'rgba(30, 41, 59, 0.9)', border: '1px solid rgba(139, 92, 246, 0.5)', borderRadius: '4px', color: '#f1f5f9', fontSize: '12px', outline: 'none', minWidth: '60px' }}
                                        />
                                      )}
                                      <span onClick={confirmEdit} style={{ cursor: 'pointer', color: '#22c55e', fontSize: '16px', lineHeight: 1 }} title="Save">âœ“</span>
                                      <span onClick={cancelEdit} style={{ cursor: 'pointer', color: '#ef4444', fontSize: '14px', lineHeight: 1 }} title="Cancel">âœ•</span>
                                    </div>
                                  </td>
                                );
                              }

                              return (
                                <td key={col.key} onClick={startEdit} style={{ cursor: col.key !== 'name' ? 'pointer' : 'default' }} title={col.key !== 'name' ? 'Click to edit' : ''}>
                                  {col.key === 'name' ? (
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                      <span
                                        style={{ cursor: 'pointer', color: '#a78bfa', fontWeight: 600, fontSize: '12px' }}
                                        onClick={() => {
                                          setProfileCustomer(customer);
                                          setShowCustomerProfile(true);
                                        }}
                                      >
                                        {cellValue || 'Unnamed'}
                                      </span>
                                    </div>
                                  ) : col.key === 'status' ? (
                                    <span style={{
                                      padding: '3px 8px',
                                      borderRadius: '12px',
                                      fontSize: '11px',
                                      fontWeight: 600,
                                      background: (() => {
                                        const s = (customer.status || '').toLowerCase();
                                        if (s === 'in progress') return 'rgba(59, 130, 246, 0.2)';
                                        if (s.includes('scheduled') && !s.includes('unscheduled')) return 'rgba(59, 130, 246, 0.2)';
                                        if (s.includes('unscheduled')) return 'rgba(245, 158, 11, 0.2)';
                                        if (!s) return 'rgba(100, 116, 139, 0.2)';
                                        return 'rgba(100, 116, 139, 0.2)';
                                      })(),
                                      color: (() => {
                                        const s = (customer.status || '').toLowerCase();
                                        if (s === 'in progress') return '#3b82f6';
                                        if (s.includes('scheduled') && !s.includes('unscheduled')) return '#3b82f6';
                                        if (s.includes('unscheduled')) return '#f59e0b';
                                        if (!s) return '#94a3b8';
                                        return '#94a3b8';
                                      })(),
                                      border: (() => {
                                        const s = (customer.status || '').toLowerCase();
                                        if (s === 'in progress') return '1px solid rgba(59, 130, 246, 0.3)';
                                        if (s.includes('scheduled') && !s.includes('unscheduled')) return '1px solid rgba(59, 130, 246, 0.3)';
                                        if (s.includes('unscheduled')) return '1px solid rgba(245, 158, 11, 0.3)';
                                        if (!s) return '1px solid rgba(100, 116, 139, 0.3)';
                                        return '1px solid rgba(100, 116, 139, 0.3)';
                                      })()
                                    }}>
                                      {customer.status || 'None'}
                                    </span>
                                  ) : col.key === 'isRecurring' ? (
                                    <span style={{
                                      color: getCustomerFieldValue(customer, 'isRecurring') === 'Yes' ? '#22c55e' : '#475569',
                                      fontWeight: getCustomerFieldValue(customer, 'isRecurring') === 'Yes' ? 600 : 400,
                                      fontSize: '12px'
                                    }}>
                                      {getCustomerFieldValue(customer, 'isRecurring') || '-'}
                                    </span>
                                  ) : col.key === 'amountPaid' ? (
                                    <span style={{ fontSize: '12px', color: customer.amountPaid ? '#22c55e' : '#475569' }}>
                                      {customer.amountPaid ? `${customer.amountPaid}` : '-'}
                                    </span>
                                  ) : (
                                    <span style={{ fontSize: '12px', color: '#cbd5e1' }}>
                                      {String(cellValue || '-')}
                                    </span>
                                  )}
                                </td>
                              );
                            })}
                            <td style={{ padding: '4px 8px', textAlign: 'center' }}>
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  openJobPopupForCustomer(customer);
                                }}
                                style={{
                                  padding: '4px 10px', borderRadius: '4px',
                                  background: 'rgba(34, 197, 94, 0.1)',
                                  border: '1px solid rgba(34, 197, 94, 0.3)',
                                  color: '#22c55e', fontSize: '11px',
                                  fontWeight: 600, cursor: 'pointer',
                                  fontFamily: 'inherit', whiteSpace: 'nowrap'
                                }}
                                title="Add Job"
                              >
                                + Job
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            )}


            {showNewCustomerForm && (() => {
              const inputStyle = {
                width: '100%', padding: '10px',
                background: 'rgba(15, 23, 42, 0.8)',
                border: '1px solid rgba(148, 163, 184, 0.2)',
                borderRadius: '8px', color: '#f1f5f9',
                fontSize: '14px', outline: 'none', fontFamily: 'inherit'
              };
              const labelStyle = { fontSize: '12px', color: '#94a3b8', fontWeight: 600, marginBottom: '4px', display: 'block' };

              const handleAddressChange = (val) => {
                setNewCustomerData(prev => ({
                  ...prev, address: val,
                  _geocodeStatus: null, _lat: null, _lng: null
                }));
              };

              const handleAddressBlur = () => {
                const d = newCustomerData;
                if (d._lat && d._lng) return;
                if (!d.address || d.address.length < 5) return;
                if (googleMapsLoaded) return;
                const full = [d.address, d.city, d.state, d.zip].filter(Boolean).join(', ');
                setNewCustomerData(prev => ({ ...prev, _geocodeStatus: 'looking up...' }));
                apiFetch('/customers/geocode', {
                  method: 'POST',
                  body: JSON.stringify({ address: full })
                }).then(res => {
                  if (res.success) {
                    setNewCustomerData(prev => ({
                      ...prev,
                      _lat: res.lat, _lng: res.lng,
                      city: res.city || prev.city,
                      state: res.state || prev.state,
                      zip: res.zip || prev.zip,
                      address: res.street || prev.address,
                      _geocodeStatus: res.approximate ? 'approximate' : 'found'
                    }));
                  } else {
                    setNewCustomerData(prev => ({ ...prev, _geocodeStatus: 'not found', _lat: null, _lng: null }));
                  }
                }).catch(() => {
                  setNewCustomerData(prev => ({ ...prev, _geocodeStatus: 'error', _lat: null, _lng: null }));
                });
              };

              return (
              <div style={{
                position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                background: 'rgba(0,0,0,0.7)',
                display: 'flex', alignItems: 'center', justifyContent: 'center',
                zIndex: 10000
              }} onClick={() => setShowNewCustomerForm(false)}>
                <div style={{
                  background: '#1e293b', borderRadius: '16px', padding: '28px',
                  width: '480px', maxHeight: '85vh', overflowY: 'auto',
                  border: '1px solid rgba(148, 163, 184, 0.2)'
                }} onClick={(e) => e.stopPropagation()} className="scrollbar-custom">
                  <h3 style={{ fontSize: '20px', fontWeight: 700, color: '#f1f5f9', marginBottom: '20px', display: 'flex', alignItems: 'center', gap: '10px' }}>
                    + Quick Add Customer
                    {newCustomerData._geocodeStatus === 'found' && (
                      <span style={{ fontSize: '12px', color: '#22c55e', fontWeight: 600, background: 'rgba(34,197,94,0.15)', padding: '3px 10px', borderRadius: '6px' }}>
                        Location Found
                      </span>
                    )}
                    {newCustomerData._geocodeStatus === 'approximate' && (
                      <span style={{ fontSize: '12px', color: '#fbbf24', fontWeight: 600, background: 'rgba(251,191,36,0.15)', padding: '3px 10px', borderRadius: '6px' }}>
                        Approximate Location
                      </span>
                    )}
                  </h3>

                  <div style={{ 
                    padding: '14px', marginBottom: '16px',
                    background: 'rgba(139, 92, 246, 0.08)', border: '1px solid rgba(139, 92, 246, 0.2)',
                    borderRadius: '10px'
                  }}>
                    <label style={{ ...labelStyle, color: '#a78bfa', fontSize: '13px' }}>Start typing address...</label>
                    <div style={{ position: 'relative' }}>
                      <input
                        ref={quickAddInputRef}
                        type="text"
                        value={newCustomerData.address}
                        onChange={(e) => handleAddressChange(e.target.value)}
                        onBlur={handleAddressBlur}
                        placeholder="800 Henslee Dr, Euless, TX"
                        autoFocus
                        style={{
                          ...inputStyle,
                          fontSize: '15px', padding: '12px',
                          background: 'rgba(15, 23, 42, 0.6)',
                          border: newCustomerData._geocodeStatus === 'found'
                            ? '2px solid rgba(34, 197, 94, 0.5)'
                            : newCustomerData._geocodeStatus === 'approximate'
                            ? '2px solid rgba(251, 191, 36, 0.5)'
                            : newCustomerData._geocodeStatus === 'not found'
                            ? '2px solid rgba(239, 68, 68, 0.5)'
                            : '1px solid rgba(139, 92, 246, 0.3)'
                        }}
                      />
                      {!googleMapsLoaded && newCustomerData._showSuggestions && newCustomerData._suggestions?.length > 0 && (
                        <div style={{
                          position: 'absolute', top: '100%', left: 0, right: 0,
                          background: '#1e293b', border: '1px solid rgba(139, 92, 246, 0.4)',
                          borderRadius: '0 0 8px 8px', zIndex: 100, maxHeight: '200px',
                          overflowY: 'auto', boxShadow: '0 8px 24px rgba(0,0,0,0.4)'
                        }}>
                          {newCustomerData._suggestions.map((s, i) => (
                            <div key={i}
                              onMouseDown={(e) => { e.preventDefault(); }}
                              style={{
                                padding: '10px 14px', cursor: 'pointer', fontSize: '13px',
                                color: '#e2e8f0', borderBottom: '1px solid rgba(148,163,184,0.1)',
                                transition: 'background 0.15s'
                              }}
                              onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(139,92,246,0.15)'}
                              onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                            >
                              <div style={{ fontWeight: 600, marginBottom: '2px' }}>
                                {s.street ? `${s.street}` : s.display.split(',')[0]}
                              </div>
                              <div style={{ fontSize: '11px', color: '#94a3b8' }}>
                                {[s.city, s.state, s.zip].filter(Boolean).join(', ')}
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginTop: '6px' }}>
                      {newCustomerData._geocodeStatus === 'looking up...' && (
                        <span style={{ fontSize: '11px', color: '#fbbf24' }}>Looking up location...</span>
                      )}
                      {newCustomerData._geocodeStatus === 'found' && (
                        <span style={{ fontSize: '11px', color: '#22c55e' }}>
                          Coordinates: {newCustomerData._lat?.toFixed(5)}, {newCustomerData._lng?.toFixed(5)}
                        </span>
                      )}
                      {newCustomerData._geocodeStatus === 'approximate' && (
                        <span style={{ fontSize: '11px', color: '#fbbf24' }}>
                          Approximate match (city area) â€” {newCustomerData._lat?.toFixed(5)}, {newCustomerData._lng?.toFixed(5)}
                        </span>
                      )}
                      {newCustomerData._geocodeStatus === 'not found' && (
                        <span style={{ fontSize: '11px', color: '#ef4444' }}>Could not find location. Try a more complete address.</span>
                      )}
                      {newCustomerData._geocodeStatus === 'error' && (
                        <span style={{ fontSize: '11px', color: '#ef4444' }}>Lookup failed. Try again.</span>
                      )}
                      {!newCustomerData._geocodeStatus && (
                        <span style={{ fontSize: '11px', color: '#64748b' }}>Type full address and click out to auto-locate</span>
                      )}
                    </div>
                  </div>

                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '12px' }}>
                    <div>
                      <label style={labelStyle}>First Name</label>
                      <input type="text" value={newCustomerData.firstName} onChange={(e) => setNewCustomerData(prev => ({...prev, firstName: e.target.value}))} placeholder="John" style={inputStyle} />
                    </div>
                    <div>
                      <label style={labelStyle}>Last Name</label>
                      <input type="text" value={newCustomerData.lastName} onChange={(e) => setNewCustomerData(prev => ({...prev, lastName: e.target.value}))} placeholder="Doe" style={inputStyle} />
                    </div>
                  </div>

                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '12px' }}>
                    <div>
                      <label style={labelStyle}>Phone</label>
                      <input type="text" value={newCustomerData.phone} onChange={(e) => setNewCustomerData(prev => ({...prev, phone: e.target.value}))} placeholder="(555) 123-4567" style={inputStyle} />
                    </div>
                    <div>
                      <label style={labelStyle}>Email</label>
                      <input type="text" value={newCustomerData.email} onChange={(e) => setNewCustomerData(prev => ({...prev, email: e.target.value}))} placeholder="john@example.com" style={inputStyle} />
                    </div>
                  </div>

                  <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', gap: '12px', marginBottom: '12px' }}>
                    <div>
                      <label style={labelStyle}>City</label>
                      <input type="text" value={newCustomerData.city} onChange={(e) => setNewCustomerData(prev => ({...prev, city: e.target.value}))} onBlur={handleAddressBlur} placeholder="Fort Worth" style={inputStyle} />
                    </div>
                    <div>
                      <label style={labelStyle}>State</label>
                      <input type="text" value={newCustomerData.state} onChange={(e) => setNewCustomerData(prev => ({...prev, state: e.target.value}))} onBlur={handleAddressBlur} placeholder="TX" style={inputStyle} />
                    </div>
                    <div>
                      <label style={labelStyle}>ZIP</label>
                      <input type="text" value={newCustomerData.zip} onChange={(e) => setNewCustomerData(prev => ({...prev, zip: e.target.value}))} onBlur={handleAddressBlur} placeholder="76131" style={inputStyle} />
                    </div>
                  </div>

                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '12px' }}>
                    <div>
                      <label style={labelStyle}>Panels</label>
                      <input type="number" value={newCustomerData.panels} onChange={(e) => setNewCustomerData(prev => ({...prev, panels: e.target.value}))} placeholder="0" style={inputStyle} />
                    </div>
                    <div style={{ display: 'flex', alignItems: 'flex-end' }}>
                      <button
                        type="button"
                        onClick={() => setNewCustomerData(prev => ({...prev, addJob: !prev.addJob}))}
                        style={{
                          width: '100%', padding: '10px', borderRadius: '8px',
                          fontSize: '14px', fontWeight: 600, cursor: 'pointer',
                          border: newCustomerData.addJob ? '2px solid rgba(139,92,246,0.6)' : '1px solid rgba(148,163,184,0.2)',
                          background: newCustomerData.addJob ? 'rgba(139,92,246,0.15)' : 'rgba(15,23,42,0.8)',
                          color: newCustomerData.addJob ? '#a78bfa' : '#94a3b8',
                          transition: 'all 0.2s'
                        }}
                      >
                        {newCustomerData.addJob ? '+ Job will be added' : '+ Add Job?'}
                      </button>
                    </div>
                  </div>

                  <div style={{ marginBottom: '16px' }}>
                    <label style={labelStyle}>Notes</label>
                    <textarea value={newCustomerData.notes} onChange={(e) => setNewCustomerData(prev => ({...prev, notes: e.target.value}))} placeholder="Gate code, special instructions..." rows={2} style={{ ...inputStyle, resize: 'vertical' }} />
                  </div>

                  <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                    <button
                      onClick={() => setShowNewCustomerForm(false)}
                      style={{
                        padding: '10px 20px', background: 'rgba(100, 116, 139, 0.2)',
                        border: '1px solid rgba(100, 116, 139, 0.3)', borderRadius: '8px',
                        color: '#94a3b8', fontSize: '14px', fontWeight: 600, cursor: 'pointer'
                      }}
                    >Cancel</button>
                    <button
                      onClick={async () => {
                        try {
                          const fullName = `${newCustomerData.firstName} ${newCustomerData.lastName}`.trim();
                          if (!fullName) { alert('Please enter a name'); return; }

                          let lat = newCustomerData._lat;
                          let lng = newCustomerData._lng;

                          if (!lat && newCustomerData.address) {
                            const full = [newCustomerData.address, newCustomerData.city, newCustomerData.state, newCustomerData.zip].filter(Boolean).join(', ');
                            const geoRes = await apiFetch('/customers/geocode', { method: 'POST', body: JSON.stringify({ address: full }) });
                            if (geoRes.success) { lat = geoRes.lat; lng = geoRes.lng; }
                          }

                          const fullAddr = [newCustomerData.address, newCustomerData.city, newCustomerData.state, newCustomerData.zip].filter(Boolean).join(', ');
                          const wantsJob = newCustomerData.addJob;
                          const customerPayload = {
                            first_name: newCustomerData.firstName,
                            last_name: newCustomerData.lastName,
                            full_name: fullName,
                            address: fullAddr,
                            street: newCustomerData.address,
                            city: newCustomerData.city,
                            state: newCustomerData.state,
                            zip: newCustomerData.zip,
                            lat: lat, lng: lng,
                            phone: newCustomerData.phone,
                            email: newCustomerData.email,
                            status: '',
                            panel_count: parseInt(newCustomerData.panels) || 0,
                            notes: newCustomerData.notes,
                            source: 'quick-add'
                          };
                          const savedCustomer = await apiFetch('/customers', { method: 'POST', body: JSON.stringify(customerPayload) });
                          await loadFromDatabase();
                          setShowNewCustomerForm(false);

                          const panelCount = newCustomerData.panels;
                          const savedPhone = newCustomerData.phone;
                          const savedEmail = newCustomerData.email;

                          if (lat && lng && mapInstanceRef.current) {
                            mapInstanceRef.current.setView([lat, lng], 14);
                          }

                          if (wantsJob && savedCustomer) {
                            openJobPopupForCustomer({
                              ...savedCustomer, name: fullName,
                              phone: savedPhone, email: savedEmail,
                              address: fullAddr,
                              panelCount: parseInt(panelCount) || 0,
                              lat: lat, lng: lng
                            });
                          }

                          setNewCustomerData({
                            firstName: '', lastName: '', phone: '', email: '',
                            address: '', city: '', state: '', zip: '',
                            addJob: false, panels: '0', notes: '',
                            _lat: null, _lng: null, _geocodeStatus: null,
                            _suggestions: [], _showSuggestions: false
                          });
                        } catch (err) {
                          console.error('Failed to create customer:', err);
                          alert('Failed to create customer: ' + err.message);
                        }
                      }}
                      style={{
                        padding: '10px 24px',
                        background: (newCustomerData._geocodeStatus === 'found' || newCustomerData._geocodeStatus === 'approximate')
                          ? 'linear-gradient(135deg, #22c55e, #16a34a)'
                          : 'linear-gradient(135deg, #8b5cf6, #6d28d9)',
                        border: 'none', borderRadius: '8px',
                        color: '#fff', fontSize: '14px', fontWeight: 600, cursor: 'pointer'
                      }}
                    >
                      {newCustomerData.addJob
                        ? (newCustomerData._geocodeStatus === 'found' || newCustomerData._geocodeStatus === 'approximate' ? 'Save & Add Job' : 'Save & Add Job')
                        : (newCustomerData._geocodeStatus === 'found' || newCustomerData._geocodeStatus === 'approximate' ? 'Save & Show on Map' : 'Save Customer')
                      }
                    </button>
                  </div>
                </div>
              </div>
              );
            })()}
          </div>

          {dayPickerPopup && (
            <div style={{
              position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
              background: 'rgba(0,0,0,0.6)', zIndex: 10000,
              display: 'flex', alignItems: 'center', justifyContent: 'center'
            }} onClick={() => setDayPickerPopup(null)}>
              <div onClick={(e) => e.stopPropagation()} style={{
                background: 'linear-gradient(135deg, #1e293b, #0f172a)',
                border: '1px solid rgba(139, 92, 246, 0.3)',
                borderRadius: '16px', padding: '24px', minWidth: '300px', maxWidth: '400px',
                boxShadow: '0 25px 50px rgba(0,0,0,0.5)'
              }}>
                <h3 style={{ margin: '0 0 6px', fontSize: '16px', fontWeight: 700, color: '#f1f5f9' }}>
                  Schedule to Route
                </h3>
                <p style={{ margin: '0 0 16px', fontSize: '13px', color: '#94a3b8' }}>
                  Add <strong style={{ color: '#e2e8f0' }}>{dayPickerPopup.customer.name}</strong> to which day?
                </p>
                {dayPickerPopup.customer.preferredDate && (
                  <div style={{ marginBottom: '12px', padding: '8px 12px', background: 'rgba(34, 197, 94, 0.1)', border: '1px solid rgba(34, 197, 94, 0.25)', borderRadius: '8px' }}>
                    <span style={{ fontSize: '11px', color: '#4ade80', fontWeight: 600 }}>Preferred: {dayPickerPopup.customer.preferredDate}</span>
                    {dayPickerPopup.customer.preferredTimeWindow && (
                      <span style={{ fontSize: '11px', color: '#94a3b8', marginLeft: '8px' }}>{dayPickerPopup.customer.preferredTimeWindow}</span>
                    )}
                  </div>
                )}
                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                  {dayPickerPopup.days.map((day, idx) => {
                    const dayLabel = day.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
                    const isToday = day.toDateString() === new Date().toDateString();
                    const routesOnDay = savedRoutes.filter(r => !r.sentToTech && new Date(r.scheduledDate).toDateString() === day.toDateString());
                    const stopCount = routesOnDay.reduce((sum, r) => sum + (r.customers || []).length, 0);
                    return (
                      <button
                        key={idx}
                        onClick={async () => {
                          const chosenDate = new Date(day);
                          chosenDate.setHours(0,0,0,0);
                          setSelectedDate(chosenDate);
                          setDayPickerPopup(null);
                          setTimeout(() => {
                            handleCustomerClick(dayPickerPopup.customer);
                          }, 100);
                        }}
                        style={{
                          display: 'flex', alignItems: 'center', justifyContent: 'space-between',
                          padding: '12px 16px', borderRadius: '10px', cursor: 'pointer',
                          background: isToday ? 'rgba(59, 130, 246, 0.15)' : 'rgba(30, 41, 59, 0.5)',
                          border: isToday ? '1px solid rgba(59, 130, 246, 0.4)' : '1px solid rgba(148, 163, 184, 0.15)',
                          color: '#f1f5f9', fontSize: '14px', fontWeight: 600,
                          transition: 'all 0.15s'
                        }}
                        onMouseOver={(e) => { e.currentTarget.style.background = 'rgba(139, 92, 246, 0.2)'; e.currentTarget.style.borderColor = 'rgba(139, 92, 246, 0.5)'; }}
                        onMouseOut={(e) => { e.currentTarget.style.background = isToday ? 'rgba(59, 130, 246, 0.15)' : 'rgba(30, 41, 59, 0.5)'; e.currentTarget.style.borderColor = isToday ? 'rgba(59, 130, 246, 0.4)' : 'rgba(148, 163, 184, 0.15)'; }}
                      >
                        <span>{dayLabel}</span>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                          {isToday && <span style={{ fontSize: '10px', color: '#93c5fd', fontWeight: 700 }}>TODAY</span>}
                          <span style={{ fontSize: '12px', color: '#94a3b8' }}>{stopCount} stop{stopCount !== 1 ? 's' : ''}</span>
                        </div>
                      </button>
                    );
                  })}
                </div>
                <button
                  onClick={() => setDayPickerPopup(null)}
                  style={{
                    marginTop: '16px', width: '100%', padding: '10px',
                    background: 'rgba(148, 163, 184, 0.1)', border: '1px solid rgba(148, 163, 184, 0.2)',
                    borderRadius: '8px', color: '#94a3b8', fontSize: '13px', fontWeight: 600, cursor: 'pointer'
                  }}
                >Cancel</button>
              </div>
            </div>
          )}

          {quickAddJobPopup && (() => {
              const jobInputStyle = {
                width: '100%', padding: '10px',
                background: 'rgba(15, 23, 42, 0.8)',
                border: '1px solid rgba(148, 163, 184, 0.2)',
                borderRadius: '8px', color: '#f1f5f9',
                fontSize: '14px', outline: 'none', fontFamily: 'inherit',
                boxSizing: 'border-box'
              };
              const jobLabelStyle = { fontSize: '12px', color: '#94a3b8', fontWeight: 600, marginBottom: '4px', display: 'block' };

              const serviceTypes = [
                'Residential Panel Cleaning',
                'Commercial Panel Cleaning',
                'Critter Guard Installation',
                'Critter Guard Repair',
                'General Repair',
                'Pressure Washing',
                'Site Visit'
              ];

              const daysOfWeek = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

              const toggleDay = (day) => {
                setQuickJobData(prev => {
                  const days = prev.preferredDays.includes(day)
                    ? prev.preferredDays.filter(d => d !== day)
                    : [...prev.preferredDays, day];
                  return { ...prev, preferredDays: days };
                });
              };

              const isResidential = quickJobData.serviceType === 'Residential Panel Cleaning';

              return (
                <div style={{
                  position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                  background: 'rgba(0,0,0,0.7)',
                  display: 'flex', alignItems: 'center', justifyContent: 'center',
                  zIndex: 10010
                }} onClick={() => setQuickAddJobPopup(null)}>
                  <div style={{
                    background: '#1e293b', borderRadius: '16px', padding: '28px',
                    width: '420px', maxHeight: '90vh', overflowY: 'auto',
                    border: '1px solid rgba(148, 163, 184, 0.2)'
                  }} onClick={(e) => e.stopPropagation()}>

                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '14px' }}>
                      <h3 style={{ fontSize: '18px', fontWeight: 700, color: '#f1f5f9', margin: 0 }}>{quickJobData.editingJobId ? 'Edit Job' : 'Add Job'}</h3>
                      <button onClick={() => setQuickAddJobPopup(null)} style={{
                        background: 'none', border: 'none', color: '#64748b', fontSize: '20px', cursor: 'pointer', padding: '4px'
                      }}>&times;</button>
                    </div>

                    <div style={{
                      display: 'flex', alignItems: 'center', gap: '10px',
                      padding: '10px 12px', marginBottom: '16px',
                      background: 'rgba(15, 23, 42, 0.4)', borderRadius: '8px',
                      border: '1px solid rgba(148, 163, 184, 0.08)'
                    }}>
                      <div style={{ flex: 1, minWidth: 0 }}>
                        <div style={{ fontSize: '14px', fontWeight: 600, color: '#f1f5f9', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                          {quickAddJobPopup.customerName}
                        </div>
                        <div style={{ fontSize: '12px', color: '#64748b', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                          {[quickAddJobPopup.customerPhone, quickAddJobPopup.customerEmail].filter(Boolean).join(' \u00b7 ')}
                        </div>
                      </div>
                    </div>

                    <div style={{ marginBottom: '16px' }}>
                      <label style={jobLabelStyle}>Service</label>
                      <select
                        value={quickJobData.serviceType}
                        onChange={(e) => setQuickJobData(prev => ({...prev, serviceType: e.target.value}))}
                        style={jobInputStyle}
                      >
                        <option value="">Select a service...</option>
                        {serviceTypes.map(type => (
                          <option key={type} value={type}>{type}</option>
                        ))}
                      </select>
                    </div>

                    {isResidential && (
                      <div style={{
                        padding: '14px', marginBottom: '16px', borderRadius: '8px',
                        background: 'rgba(139, 92, 246, 0.04)',
                        border: '1px solid rgba(139, 92, 246, 0.12)'
                      }}>
                        <div style={{ display: 'flex', gap: '10px', marginBottom: '12px' }}>
                          <div style={{ flex: 1 }}>
                            <label style={jobLabelStyle}>Panels</label>
                            <input
                              type="number"
                              value={quickJobData.panels}
                              onChange={(e) => {
                                const panels = e.target.value;
                                const count = parseInt(panels) || 0;
                                const ppp = parseFloat(quickJobData.pricePerPanel) || 9;
                                setQuickJobData(prev => ({
                                  ...prev, panels,
                                  totalPrice: prev.priceOverridden ? prev.totalPrice : String(count * ppp)
                                }));
                              }}
                              placeholder="0" min="0"
                              style={{ ...jobInputStyle, padding: '8px 10px' }}
                            />
                          </div>
                          <div style={{ width: '80px' }}>
                            <label style={jobLabelStyle}>$/Panel</label>
                            <select
                              value={quickJobData.pricePerPanel}
                              onChange={(e) => {
                                const ppp = parseFloat(e.target.value);
                                const count = parseInt(quickJobData.panels) || 0;
                                setQuickJobData(prev => ({
                                  ...prev, pricePerPanel: e.target.value,
                                  totalPrice: prev.priceOverridden ? prev.totalPrice : String(count * ppp)
                                }));
                              }}
                              style={{ ...jobInputStyle, padding: '8px 10px' }}
                            >
                              <option value="9">$9</option>
                              <option value="8">$8</option>
                              <option value="7">$7</option>
                              <option value="6">$6</option>
                            </select>
                          </div>
                          <div style={{ flex: 1 }}>
                            <label style={jobLabelStyle}>
                              Total{quickJobData.priceOverridden && (
                                <button onClick={() => {
                                  const count = parseInt(quickJobData.panels) || 0;
                                  const ppp = parseFloat(quickJobData.pricePerPanel) || 9;
                                  setQuickJobData(prev => ({ ...prev, totalPrice: String(count * ppp), priceOverridden: false }));
                                }} style={{ marginLeft: '6px', fontSize: '10px', color: '#8b5cf6', background: 'none', border: 'none', cursor: 'pointer', padding: 0 }}>reset</button>
                              )}
                            </label>
                            <div style={{ position: 'relative' }}>
                              <span style={{ position: 'absolute', left: '10px', top: '50%', transform: 'translateY(-50%)', color: '#94a3b8', fontSize: '13px', pointerEvents: 'none' }}>$</span>
                              <input
                                type="number"
                                value={quickJobData.totalPrice}
                                onChange={(e) => setQuickJobData(prev => ({ ...prev, totalPrice: e.target.value, priceOverridden: true }))}
                                style={{ ...jobInputStyle, padding: '8px 10px 8px 22px' }}
                              />
                            </div>
                          </div>
                        </div>

                        <div style={{ marginBottom: '10px' }}>
                          <label style={jobLabelStyle}>Preferred Days</label>
                          <div style={{ display: 'flex', gap: '4px' }}>
                            {daysOfWeek.map(day => (
                              <button key={day} type="button" onClick={() => toggleDay(day)}
                                style={{
                                  flex: 1, padding: '6px 2px', borderRadius: '5px',
                                  fontSize: '11px', fontWeight: 600, cursor: 'pointer',
                                  border: quickJobData.preferredDays.includes(day) ? '1.5px solid rgba(34,197,94,0.5)' : '1px solid rgba(148,163,184,0.12)',
                                  background: quickJobData.preferredDays.includes(day) ? 'rgba(34,197,94,0.12)' : 'transparent',
                                  color: quickJobData.preferredDays.includes(day) ? '#4ade80' : '#94a3b8',
                                  transition: 'all 0.15s'
                                }}
                              >{day}</button>
                            ))}
                          </div>
                        </div>

                        <div>
                          <label style={jobLabelStyle}>Preferred Time</label>
                          <div style={{ display: 'flex', gap: '6px' }}>
                            {['AM', 'PM'].map(t => (
                              <button key={t} type="button"
                                onClick={() => setQuickJobData(prev => ({...prev, preferredTime: prev.preferredTime === t ? '' : t}))}
                                style={{
                                  flex: 1, padding: '6px', borderRadius: '5px',
                                  fontSize: '12px', fontWeight: 600, cursor: 'pointer',
                                  border: quickJobData.preferredTime === t ? '1.5px solid rgba(59,130,246,0.5)' : '1px solid rgba(148,163,184,0.12)',
                                  background: quickJobData.preferredTime === t ? 'rgba(59,130,246,0.12)' : 'transparent',
                                  color: quickJobData.preferredTime === t ? '#60a5fa' : '#94a3b8',
                                  transition: 'all 0.15s'
                                }}
                              >{t}</button>
                            ))}
                          </div>
                        </div>
                      </div>
                    )}

                    <div style={{ marginBottom: '12px' }}>
                      <label style={jobLabelStyle}>Notes <span style={{ fontWeight: 400, color: '#475569' }}>(optional)</span></label>
                      <textarea
                        value={quickJobData.notes}
                        onChange={(e) => setQuickJobData(prev => ({...prev, notes: e.target.value}))}
                        placeholder="Special instructions, access details..."
                        rows={2}
                        style={{ ...jobInputStyle, resize: 'vertical', padding: '8px 10px' }}
                      />
                    </div>

                    <div style={{ marginBottom: '12px' }}>
                      <div
                        onClick={() => {
                          setQuickJobData(prev => {
                            if (prev.isRecurring) {
                              return { ...prev, isRecurring: false, recurrenceInterval: '', nextServiceDate: '' };
                            }
                            const d = new Date(); d.setMonth(d.getMonth() + 6);
                            return { ...prev, isRecurring: true, recurrenceInterval: '6months', nextServiceDate: d.toISOString().split('T')[0] };
                          });
                        }}
                        style={{
                          display: 'flex', alignItems: 'center', gap: '8px',
                          padding: '10px 12px', borderRadius: '8px', cursor: 'pointer',
                          border: quickJobData.isRecurring ? '1.5px solid rgba(251,191,36,0.4)' : '1px solid rgba(148,163,184,0.12)',
                          background: quickJobData.isRecurring ? 'rgba(251,191,36,0.08)' : 'transparent',
                          transition: 'all 0.15s'
                        }}
                      >
                        <div style={{
                          width: '18px', height: '18px', borderRadius: '4px',
                          border: quickJobData.isRecurring ? '2px solid #fbbf24' : '2px solid #475569',
                          background: quickJobData.isRecurring ? '#fbbf24' : 'transparent',
                          display: 'flex', alignItems: 'center', justifyContent: 'center',
                          flexShrink: 0, transition: 'all 0.15s'
                        }}>
                          {quickJobData.isRecurring && <span style={{ color: '#1e293b', fontSize: '12px', fontWeight: 700 }}>{'\u2713'}</span>}
                        </div>
                        <span style={{ fontSize: '13px', fontWeight: 600, color: quickJobData.isRecurring ? '#fbbf24' : '#94a3b8' }}>
                          Recurring Service
                        </span>
                      </div>

                      {quickJobData.isRecurring && (
                        <div style={{
                          marginTop: '10px', padding: '12px', borderRadius: '8px',
                          background: 'rgba(251,191,36,0.04)',
                          border: '1px solid rgba(251,191,36,0.1)'
                        }}>
                          <div style={{ marginBottom: '10px' }}>
                            <label style={jobLabelStyle}>Frequency</label>
                            <div style={{ display: 'flex', gap: '6px' }}>
                              {[{val: '6months', label: 'Every 6 Months'}, {val: 'yearly', label: 'Yearly'}].map(opt => (
                                <button key={opt.val} type="button"
                                  onClick={() => {
                                    const today = new Date();
                                    const nextDate = new Date(today);
                                    if (opt.val === '6months') nextDate.setMonth(nextDate.getMonth() + 6);
                                    else nextDate.setFullYear(nextDate.getFullYear() + 1);
                                    setQuickJobData(prev => ({
                                      ...prev, recurrenceInterval: opt.val,
                                      nextServiceDate: nextDate.toISOString().split('T')[0]
                                    }));
                                  }}
                                  style={{
                                    flex: 1, padding: '7px', borderRadius: '6px',
                                    fontSize: '12px', fontWeight: 600, cursor: 'pointer',
                                    border: quickJobData.recurrenceInterval === opt.val ? '1.5px solid rgba(251,191,36,0.5)' : '1px solid rgba(148,163,184,0.12)',
                                    background: quickJobData.recurrenceInterval === opt.val ? 'rgba(251,191,36,0.12)' : 'transparent',
                                    color: quickJobData.recurrenceInterval === opt.val ? '#fbbf24' : '#94a3b8',
                                    transition: 'all 0.15s'
                                  }}
                                >{opt.label}</button>
                              ))}
                            </div>
                          </div>
                          <div>
                            <label style={jobLabelStyle}>Next Service Date</label>
                            <input
                              type="date"
                              value={quickJobData.nextServiceDate}
                              onChange={(e) => setQuickJobData(prev => ({...prev, nextServiceDate: e.target.value}))}
                              style={{ ...jobInputStyle, padding: '8px 10px' }}
                            />
                          </div>
                        </div>
                      )}
                    </div>

                    <div style={{ marginBottom: '16px' }}>
                      <label style={jobLabelStyle}>Technician</label>
                      <select
                        value={quickJobData.technician}
                        onChange={(e) => setQuickJobData(prev => ({...prev, technician: e.target.value}))}
                        style={{ ...jobInputStyle, padding: '8px 10px' }}
                      >
                        <option value="Chance T">Chance T</option>
                      </select>
                    </div>

                    <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                      <button
                        onClick={() => setQuickAddJobPopup(null)}
                        style={{
                          padding: '10px 20px', background: 'rgba(100, 116, 139, 0.2)',
                          border: '1px solid rgba(100, 116, 139, 0.3)', borderRadius: '8px',
                          color: '#94a3b8', fontSize: '14px', fontWeight: 600, cursor: 'pointer'
                        }}
                      >Cancel</button>
                      <button
                        disabled={!quickJobData.serviceType}
                        onClick={async () => {
                          try {
                            const combinedNotes = quickJobData.notes || '';

                            const isEditing = !!quickJobData.editingJobId;

                            const hasServiceDate = quickJobData.isRecurring && quickJobData.nextServiceDate;
                            const jobPayload = {
                              customer_id: quickAddJobPopup.customerId,
                              job_description: quickJobData.serviceType,
                              notes: combinedNotes,
                              panel_count: parseInt(quickJobData.panels) || 0,
                              price: parseFloat(quickJobData.totalPrice) || 0,
                              price_per_panel: parseFloat(quickJobData.pricePerPanel) || 0,
                              preferred_days: quickJobData.preferredDays.join(','),
                              preferred_time: quickJobData.preferredTime,
                              technician: quickJobData.technician,
                              is_recurring: quickJobData.isRecurring,
                              recurrence_interval: quickJobData.isRecurring ? quickJobData.recurrenceInterval : '',
                              next_service_date: hasServiceDate ? quickJobData.nextServiceDate : ''
                            };
                            if (!isEditing) {
                              jobPayload.scheduled_date = '';
                            }

                            if (!isEditing) {
                              jobPayload.status = 'unscheduled';
                            }

                            if (isEditing) {
                              await apiFetch(`/jobs/${quickJobData.editingJobId}`, {
                                method: 'PATCH',
                                body: JSON.stringify(jobPayload)
                              });
                              const editedStatus = (jobPayload.status || '').toLowerCase();
                              if (editedStatus !== 'completed' && editedStatus !== 'cancelled') {
                                const custJobsData = await apiFetch(`/jobs?customer_id=${quickAddJobPopup.customerId}`);
                                const allUpcoming = (custJobsData.jobs || []).filter(j => j.status !== 'completed' && j.status !== 'cancelled');
                                const nearestDate = allUpcoming.reduce((min, j) => {
                                  const d = j.scheduled_date || j.next_service_date;
                                  return d && d !== '' && (!min || new Date(d) < new Date(min)) ? d : min;
                                }, null);
                                const isRecurring = quickJobData.isRecurring;
                                let custStatus = '';
                                if (allUpcoming.length === 0) {
                                  custStatus = '';
                                } else if (nearestDate) {
                                  if (isRecurring) {
                                    const daysUntil = Math.floor((new Date(nearestDate) - new Date()) / (1000 * 60 * 60 * 24));
                                    custStatus = daysUntil <= 30 ? 'scheduled' : '';
                                  } else {
                                    custStatus = 'scheduled';
                                  }
                                } else {
                                  custStatus = 'unscheduled';
                                }
                                await apiFetch(`/customers/${quickAddJobPopup.customerId}`, {
                                  method: 'PATCH',
                                  body: JSON.stringify({ next_service_date: nearestDate || null, status: custStatus })
                                });
                              }
                            } else {
                              await apiFetch('/jobs', {
                                method: 'POST',
                                body: JSON.stringify(jobPayload)
                              });
                              const customerPatch = {
                                status: 'unscheduled',
                                job_description: quickJobData.serviceType,
                                is_recurring: quickJobData.isRecurring
                              };
                              await apiFetch(`/customers/${quickAddJobPopup.customerId}`, {
                                method: 'PATCH',
                                body: JSON.stringify(customerPatch)
                              });
                            }

                            const custLat = quickAddJobPopup.lat;
                            const custLng = quickAddJobPopup.lng;
                            const prefDays = quickJobData.preferredDays;
                            const prefTime = quickJobData.preferredTime;

                            setSavedRoutes(prev => prev.map(r => ({
                              ...r,
                              customers: (r.customers || []).map(c =>
                                c.id === quickAddJobPopup.customerId
                                  ? { ...c, jobNotes: combinedNotes }
                                  : c
                              )
                            })));

                            await loadFromDatabase();
                            setJobRefreshKey(k => k + 1);
                            setQuickAddJobPopup(null);
                            setQuickJobData({
                              serviceType: '', notes: '', panels: '0',
                              pricePerPanel: '9', totalPrice: '0', priceOverridden: false,
                              preferredDays: [], preferredTime: '', technician: 'Chance T',
                              isRecurring: false, recurrenceInterval: '', nextServiceDate: '',
                              editingJobId: null
                            });

                            setProfileCustomer(null);
                            setShowCustomerProfile(false);

                            if (!isEditing) {
                              setCurrentView('map');
                              setStatusFilter('scheduled');
                              const today = new Date(); today.setHours(0,0,0,0);
                              setFocusedDays([today]);
                              setRoutePlannerEditMode(true);
                            }
                          } catch (err) {
                            console.error('Failed to save job:', err);
                            alert('Failed to save job: ' + err.message);
                          }
                        }}
                        style={{
                          padding: '10px 24px',
                          background: quickJobData.serviceType
                            ? 'linear-gradient(135deg, #8b5cf6, #6d28d9)'
                            : 'rgba(100, 116, 139, 0.3)',
                          border: 'none', borderRadius: '8px',
                          color: quickJobData.serviceType ? '#fff' : '#64748b',
                          fontSize: '14px', fontWeight: 600,
                          cursor: quickJobData.serviceType ? 'pointer' : 'not-allowed'
                        }}
                      >
                        {quickJobData.editingJobId ? 'Save Changes' : 'Schedule Job'}
                      </button>
                    </div>
                  </div>
                </div>
              );
          })()}

          {/* Radius Search Floating Control Panel */}
          {radiusMode && (
            <div style={{
              position: 'absolute',
              top: '80px',
              right: '20px',
              zIndex: 1000,
              background: 'rgba(15, 23, 42, 0.95)',
              backdropFilter: 'blur(20px)',
              border: '1px solid rgba(139, 92, 246, 0.3)',
              borderRadius: '12px',
              padding: '20px',
              width: '320px',
              boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)'
            }}>
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '16px' }}>
                <h3 style={{ fontSize: '16px', fontWeight: 700, margin: 0, color: '#f1f5f9' }}>ðŸŽ¯ Radius Search</h3>
                <button
onClick={exitRadiusMode}
                  style={{ background: 'transparent', border: 'none', color: '#94a3b8', cursor: 'pointer', padding: 0, fontSize: '20px' }}
                >
                  âœ•
                </button>
              </div>

              {/* Radius Slider */}
              <div style={{ marginBottom: '16px' }}>
                <label style={{ fontSize: '12px', color: '#94a3b8', fontWeight: 600, marginBottom: '8px', display: 'block' }}>
                  Radius (miles)
                </label>
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                  <input
                    type="range"
                    min="1"
                    max="100"
                    value={radiusMiles}
                    onChange={(e) => {
                      const newRadius = parseInt(e.target.value);
                      setRadiusMiles(newRadius);
                      // Update circle if one exists
                      if (referencePoint) {
                        clearRadius();
                        drawRadius(referencePoint, newRadius * 1609.34, referenceAddress);
                      }
                    }}
                    style={{ flex: 1 }}
                  />
                  <div style={{
                    fontSize: '18px',
                    fontWeight: 700,
                    color: '#8b5cf6',
                    minWidth: '60px',
                    textAlign: 'right'
                  }}>
                    {radiusMiles} mi
                  </div>
                </div>
              </div>

              {/* Address Input */}
              <div style={{ marginBottom: '16px' }}>
                <label style={{ fontSize: '12px', color: '#94a3b8', fontWeight: 600, marginBottom: '8px', display: 'block' }}>
                  Search Address
                </label>
                <input
                  type="text"
                  value={radiusAddress}
                  onChange={(e) => setRadiusAddress(e.target.value)}
                  onKeyPress={(e) => {
                    if (e.key === 'Enter' && radiusAddress) {
                      handleRadiusSearch(false);
                    }
                  }}
                  placeholder="123 Main St, Austin, TX"
                  style={{
                    width: '100%',
                    padding: '10px 12px',
                    background: 'rgba(30, 41, 59, 0.5)',
                    border: '1px solid rgba(139, 92, 246, 0.3)',
                    borderRadius: '6px',
                    color: '#f1f5f9',
                    fontSize: '13px',
                    outline: 'none'
                  }}
                />
              </div>

              {/* Action Buttons */}
              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                <button
                  className="button-primary"
                  onClick={() => {
                    setDrawMode(false);
                    clearDrawnArea();
                    if (radiusAddress) {
                      handleRadiusSearch(false);
                    }
                  }}
                  disabled={!radiusAddress}
                  style={{ 
                    width: '100%', 
                    justifyContent: 'center',
                    opacity: radiusAddress ? 1 : 0.5,
                    cursor: radiusAddress ? 'pointer' : 'not-allowed'
                  }}
                >
                  ðŸ” Search Address
                </button>
                <button
                  className="button-secondary"
                  onClick={() => {
                    setDrawMode(false);
                    clearDrawnArea();
                    if (homeBase) {
                      clearRadius();
                      drawRadius(homeBase, radiusMiles * 1609.34, 'Home Base');
                    } else {
                      alert('Home base not set');
                    }
                  }}
                  style={{ width: '100%', justifyContent: 'center' }}
                >
                  ðŸ  From Home Base
                </button>
                <button
                  className="button-secondary"
                  onClick={() => {
                    setDrawMode(false);
                    clearDrawnArea();
                    setAwaitingMapClick(true);
                  }}
                  style={{
                    width: '100%',
                    justifyContent: 'center',
                    background: awaitingMapClick ? 'rgba(139, 92, 246, 0.2)' : 'rgba(30, 41, 59, 0.5)',
                    borderColor: awaitingMapClick ? 'rgba(139, 92, 246, 0.5)' : 'rgba(139, 92, 246, 0.3)'
                  }}
                >
                  ðŸ“ {awaitingMapClick ? 'Click on Map...' : 'Click on Map'}
                </button>

                {/* Draw Area Button */}
                <button
                  className="button-secondary"
                  onClick={() => {
                    if (drawMode) {
                      setDrawMode(false);
                    } else {
                      clearRadius();
                      clearDrawnArea();
                      setDrawMode(true);
                    }
                  }}
                  style={{
                    width: '100%',
                    justifyContent: 'center',
                    background: drawMode ? 'rgba(251, 191, 36, 0.2)' : 'rgba(30, 41, 59, 0.5)',
                    borderColor: drawMode ? 'rgba(251, 191, 36, 0.5)' : 'rgba(139, 92, 246, 0.3)',
                    color: drawMode ? '#fbbf24' : undefined
                  }}
                >
                  âœï¸ {drawMode ? 'Drawing... (drag to draw)' : 'Draw Custom Area'}
                </button>

                {/* Clear Drawn Area Button */}
                {drawnArea && (
                  <button
                    className="button-secondary"
                    onClick={clearDrawnArea}
                    style={{
                      width: '100%',
                      justifyContent: 'center',
                      background: 'rgba(239, 68, 68, 0.1)',
                      borderColor: 'rgba(239, 68, 68, 0.4)',
                      color: '#fca5a5'
                    }}
                  >
                    âœ• Clear Drawn Area ({filteredCustomers.length} customers)
                  </button>
                )}

                {/* Exit and Show All Customers Button */}
                <button
                  className="button-secondary"
                  onClick={exitRadiusMode}
                  style={{
                    width: '100%',
                    justifyContent: 'center',
                    marginTop: '8px',
                    background: 'rgba(34, 197, 94, 0.1)',
                    borderColor: 'rgba(34, 197, 94, 0.4)',
                    color: '#22c55e'
                  }}
                >
                  ðŸ”™ Exit & Show All Customers
                </button>

                {/* Time Filter - Always visible in radius mode */}
                <div style={{
                  marginTop: '12px',
                  padding: '12px',
                  background: 'rgba(251, 191, 36, 0.1)',
                  border: '1px solid rgba(251, 191, 36, 0.3)',
                  borderRadius: '8px'
                }}>
                  <div style={{ fontSize: '11px', fontWeight: 600, color: '#fbbf24', marginBottom: '8px' }}>
                    â° Filter by Last Service
                  </div>
                  <select
                    value={lastServiceFilter}
                    onChange={(e) => setLastServiceFilter(e.target.value)}
                    style={{
                      width: '100%',
                      padding: '8px',
                      background: 'rgba(15, 23, 42, 0.8)',
                      border: '1px solid rgba(251, 191, 36, 0.3)',
                      borderRadius: '6px',
                      color: '#f1f5f9',
                      fontSize: '12px'
                    }}
                  >
                    <option value="">All Customers</option>
                    <option value="3months">Not serviced in 3+ months</option>
                    <option value="6months">Not serviced in 6+ months</option>
                    <option value="12months">Not serviced in 12+ months</option>
                  </select>
                </div>

                {/* Save List & Download Buttons - Show for radius or drawn area */}
                {(referencePoint || drawnArea) && filteredCustomers.length > 0 && (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    <button
                      className="button-primary"
                      onClick={() => {
                        const defaultName = drawnArea
                          ? `Drawn Area - ${new Date().toLocaleDateString()}`
                          : `Radius - ${referenceAddress || 'Search'}`;
                        const listName = prompt(`Save results as list (${filteredCustomers.length} customers)`, defaultName);
                        if (listName && listName.trim()) {
                          const listId = Date.now() + Math.random();
                          const customersToSave = filteredCustomers.map(c => ({
                            ...c,
                            fileId: listId,
                            fileName: listName.trim()
                          }));

                          setSavedLists(prev => [...prev.map(l => ({ ...l, visible: false })), {
                            id: listId,
                            name: listName.trim(),
                            customers: customersToSave,
                            visible: true,
                            createdDate: new Date().toISOString()
                          }]);
                          // Hide uploaded files too
                          setUploadedFiles(prev => prev.map(f => ({ ...f, visible: false })));

                          // Fully exit radius/draw mode and clear visual layers
                          setRadiusMode(false);
                          setAwaitingMapClick(false);
                          setDrawMode(false);
                          clearRadius();
                          clearDrawnArea();
                        }
                      }}
                      style={{
                        width: '100%',
                        justifyContent: 'center',
                        background: 'rgba(34, 197, 94, 0.2)',
                        borderColor: 'rgba(34, 197, 94, 0.3)',
                        color: '#22c55e'
                      }}
                    >
                      ðŸ’¾ Save List ({filteredCustomers.length})
                    </button>

                    <button
                      className="button-primary"
                      onClick={() => {
                        // Generate CSV from filtered customers
                        const headers = ['Name', 'Phone', 'Email', 'Address', 'City', 'State', 'Zip', 'Panel Count', 'Last Service', 'Next Service', 'Recurring', 'Notes'];
                        const csvRows = [headers.join(',')];

                        filteredCustomers.forEach(c => {
                          const row = [
                            `"${(c.name || c.contactName || '').replace(/"/g, '""')}"`,
                            `"${(c.phone || c.phoneNumber || '').replace(/"/g, '""')}"`,
                            `"${(c.email || '').replace(/"/g, '""')}"`,
                            `"${(c.address || c.fullAddress || '').replace(/"/g, '""')}"`,
                            `"${(c.city || '').replace(/"/g, '""')}"`,
                            `"${(c.state || '').replace(/"/g, '""')}"`,
                            `"${(c.zip || c.zipCode || '').replace(/"/g, '""')}"`,
                            `"${(c.panelCount || c.totalPanels || '').toString().replace(/"/g, '""')}"`,
                            `"${(c.lastServiceDate || c.lastService || '').replace(/"/g, '""')}"`,
                            `"${(c.nextServiceDate || '').replace(/"/g, '""')}"`,
                            `"${(c.isRecurring || c.recurring) ? 'Yes' : 'No'}"`,
                            `"${(c.notes || '').replace(/"/g, '""')}"`
                          ];
                          csvRows.push(row.join(','));
                        });

                        const csvContent = csvRows.join('\n');
                        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.setAttribute('href', url);
                        const filename = drawnArea
                          ? `drawn-area-customers-${new Date().toISOString().split('T')[0]}.csv`
                          : `radius-customers-${new Date().toISOString().split('T')[0]}.csv`;
                        link.setAttribute('download', filename);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                      }}
                      style={{
                        width: '100%',
                        justifyContent: 'center',
                        background: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 0.3)',
                        color: '#60a5fa'
                      }}
                    >
                      ðŸ“¥ Download CSV ({filteredCustomers.length})
                    </button>
                  </div>
                )}
              </div>

              {/* Results Count */}
              {(referencePoint || drawnArea) && (
                <div style={{
                  marginTop: '16px',
                  padding: '12px',
                  background: 'rgba(139, 92, 246, 0.1)',
                  border: '1px solid rgba(139, 92, 246, 0.3)',
                  borderRadius: '8px',
                  fontSize: '13px',
                  color: '#c4b5fd',
                  textAlign: 'center'
                }}>
                  ðŸ“Š {filteredCustomers.length} customers {drawnArea ? 'in drawn area' : 'in radius'}
                </div>
              )}
            </div>
          )}

          {/* Save List Modal */}
          {showSaveListModal && (
            <div className="modal" onClick={() => setShowSaveListModal(false)}>
              <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '24px' }}>
                  <h2 style={{ fontSize: '20px', fontWeight: 700, margin: 0 }}>Save as List</h2>
                  <button
                    onClick={() => setShowSaveListModal(false)}
                    style={{ background: 'transparent', border: 'none', color: '#94a3b8', cursor: 'pointer', padding: 0, fontSize: '24px' }}
                  >
                    âŒ
                  </button>
                </div>

                <div style={{ marginBottom: '24px' }}>
                  <label style={{ fontSize: '13px', color: '#94a3b8', fontWeight: 600, marginBottom: '10px', display: 'block' }}>
                    List Name
                  </label>
                  <input
                    type="text"
                    value={listName}
                    onChange={(e) => setListName(e.target.value)}
                    onKeyPress={(e) => {
                      if (e.key === 'Enter' && listName.trim()) {
                        handleSaveList();
                      }
                    }}
                    placeholder="e.g., Austin High-Value Leads"
                    className="input-field"
                    autoFocus
                  />
                </div>

                <div style={{
                  padding: '16px',
                  background: 'rgba(139, 92, 246, 0.1)',
                  border: '1px solid rgba(139, 92, 246, 0.2)',
                  borderRadius: '12px',
                  marginBottom: '24px',
                  fontSize: '13px',
                  color: '#c4b5fd'
                }}>
                  ðŸ’¡ This will save {visibleCustomers.length} {visibleCustomers.length === 1 ? 'customer' : 'customers'} as a reusable list
                </div>

                <div style={{ display: 'flex', gap: '12px' }}>
                  <button
                    className="button-secondary"
                    onClick={() => setShowSaveListModal(false)}
                    style={{ flex: 1, justifyContent: 'center' }}
                  >
                    Cancel
                  </button>
                  <button
                    className="button-primary"
                    onClick={handleSaveList}
                    disabled={!listName.trim()}
                    style={{ 
                      flex: 1, 
                      justifyContent: 'center',
                      opacity: listName.trim() ? 1 : 0.5,
                      cursor: listName.trim() ? 'pointer' : 'not-allowed'
                    }}
                  >
                    ðŸ’¾ Save List
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Unsaved Route Warning Modal */}
          {pendingViewChange && (
            <div className="modal" onClick={cancelDiscardRoute}>
              <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '460px' }}>
                <div style={{ textAlign: 'center', padding: '8px 0' }}>
                  <div style={{ fontSize: '48px', marginBottom: '16px' }}>âš ï¸</div>
                  <h2 style={{ fontSize: '20px', fontWeight: 700, margin: '0 0 12px 0' }}>Unsaved Route Changes</h2>
                  <p style={{ color: '#94a3b8', fontSize: '14px', lineHeight: '1.6', margin: '0 0 16px 0' }}>
                    You have unsaved route changes on {Object.keys(unsavedRouteDays).filter(k => unsavedRouteDays[k]).length} day{Object.keys(unsavedRouteDays).filter(k => unsavedRouteDays[k]).length > 1 ? 's' : ''}.
                    If you leave, these changes will be discarded.
                  </p>
                  {Object.keys(unsavedRouteDays).filter(k => unsavedRouteDays[k]).length > 0 && (
                    <div style={{
                      margin: '0 0 16px 0',
                      padding: '10px',
                      background: 'rgba(245, 158, 11, 0.1)',
                      border: '1px solid rgba(245, 158, 11, 0.2)',
                      borderRadius: '8px',
                      fontSize: '12px',
                      color: '#fbbf24'
                    }}>
                      {Object.keys(unsavedRouteDays).filter(k => unsavedRouteDays[k]).map(dayKey => {
                        const dayStops = (routesByDay[dayKey] || []).length;
                        return (
                          <div key={dayKey} style={{ padding: '2px 0' }}>
                            {new Date(dayKey).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })} â€” {dayStops} stop{dayStops !== 1 ? 's' : ''}
                          </div>
                        );
                      })}
                    </div>
                  )}
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '10px', alignItems: 'center' }}>
                    {Object.keys(unsavedRouteDays).filter(k => unsavedRouteDays[k]).length > 0 && (
                      <button
                        onClick={async () => {
                          await handleSaveAllRoutes();
                          if (pendingViewChange) {
                            setCurrentView(pendingViewChange);
                            setPendingViewChange(null);
                          }
                        }}
                        style={{
                          padding: '10px 24px',
                          fontSize: '14px',
                          fontWeight: 700,
                          background: 'linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(59, 130, 246, 0.2))',
                          border: '1px solid rgba(16, 185, 129, 0.4)',
                          borderRadius: '12px',
                          color: '#6ee7b7',
                          cursor: 'pointer',
                          width: '100%'
                        }}
                      >
                        ðŸ’¾ Save All Routes & Continue
                      </button>
                    )}
                    <div style={{ display: 'flex', gap: '12px', width: '100%' }}>
                      <button
                        onClick={cancelDiscardRoute}
                        className="button-primary"
                        style={{ padding: '10px 24px', fontSize: '14px', flex: 1 }}
                      >
                        Go Back
                      </button>
                      <button
                        onClick={confirmDiscardRoute}
                        style={{
                          padding: '10px 24px',
                          fontSize: '14px',
                          background: 'rgba(239, 68, 68, 0.15)',
                          border: '1px solid rgba(239, 68, 68, 0.3)',
                          borderRadius: '12px',
                          color: '#f87171',
                          cursor: 'pointer',
                          fontWeight: 600,
                          flex: 1
                        }}
                      >
                        Discard & Leave
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Save Route Modal */}
          {showSaveModal && (
            <div className="modal" onClick={() => setShowSaveModal(false)}>
              <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '24px' }}>
                  <h2 style={{ fontSize: '20px', fontWeight: 700, margin: 0 }}>{editingSavedRouteId ? 'Update Route' : 'Save Route'}</h2>
                  <button
                    onClick={() => setShowSaveModal(false)}
                    style={{ background: 'transparent', border: 'none', color: '#94a3b8', cursor: 'pointer', padding: 0, fontSize: '24px' }}
                  >
                    âŒ
                  </button>
                </div>

                <div style={{ marginBottom: '24px' }}>
                  <label style={{ fontSize: '13px', color: '#94a3b8', fontWeight: 600, marginBottom: '10px', display: 'block' }}>
                    Route Name
                  </label>
                  <input
                    type="text"
                    value={routeName}
                    onChange={(e) => setRouteName(e.target.value)}
                    placeholder="e.g., Austin Morning Route"
                    className="input-field"
                    autoFocus
                  />
                </div>

                <div style={{
                  padding: '16px',
                  background: 'rgba(139, 92, 246, 0.1)',
                  border: '1px solid rgba(139, 92, 246, 0.2)',
                  borderRadius: '16px',
                  fontSize: '13px',
                  color: '#c4b5fd',
                  marginBottom: '24px'
                }}>
                  <div style={{ marginBottom: '12px' }}>
                    ðŸ“… <strong>Scheduled:</strong> {selectedDate.toLocaleDateString('en-US', { 
                      weekday: 'long',
                      month: 'long', 
                      day: 'numeric',
                      year: 'numeric'
                    })}
                  </div>
                  This route has <strong>{route.length} stops</strong> and <strong>{(stats.totalRouteDistance || 0).toFixed(1)} miles</strong>.
                  <br /><br />
                  Customers will be added to your pipeline as "New" leads.
                </div>

                {/* Show other unsaved days info */}
                {Object.keys(unsavedRouteDays).filter(k => unsavedRouteDays[k] && k !== selectedDate.toDateString()).length > 0 && (
                  <div style={{
                    padding: '12px',
                    background: 'rgba(245, 158, 11, 0.1)',
                    border: '1px solid rgba(245, 158, 11, 0.2)',
                    borderRadius: '12px',
                    marginBottom: '16px',
                    fontSize: '12px',
                    color: '#fbbf24'
                  }}>
                    You also have unsaved routes on {Object.keys(unsavedRouteDays).filter(k => unsavedRouteDays[k] && k !== selectedDate.toDateString()).length} other day{Object.keys(unsavedRouteDays).filter(k => unsavedRouteDays[k] && k !== selectedDate.toDateString()).length > 1 ? 's' : ''}.
                  </div>
                )}

                <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                  <div style={{ display: 'flex', gap: '12px' }}>
                    <button
                      className="button-secondary"
                      onClick={() => setShowSaveModal(false)}
                      style={{ flex: 1, justifyContent: 'center' }}
                    >
                      Cancel
                    </button>
                    <button
                      className="button-primary"
                      onClick={handleSaveRoute}
                      style={{ flex: 1, justifyContent: 'center' }}
                    >
                      {editingSavedRouteId ? 'ðŸ’¾ Update Route' : 'ðŸ’¾ Save This Day'}
                    </button>
                  </div>
                  {Object.keys(unsavedRouteDays).filter(k => unsavedRouteDays[k]).length > 1 && (
                    <button
                      onClick={handleSaveAllRoutes}
                      style={{
                        padding: '10px 16px',
                        fontSize: '13px',
                        fontWeight: 700,
                        background: 'linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(59, 130, 246, 0.2))',
                        border: '1px solid rgba(16, 185, 129, 0.4)',
                        borderRadius: '12px',
                        color: '#6ee7b7',
                        cursor: 'pointer',
                        width: '100%'
                      }}
                    >
                      ðŸ’¾ Save All Routes ({Object.keys(unsavedRouteDays).filter(k => unsavedRouteDays[k]).length} days)
                    </button>
                  )}
                </div>
              </div>
            </div>
          )}

        </div>
        
        {/* Footer Section - Scroll down to see */}
        <div style={{
          width: '100vw',
          minHeight: '60vh',
          background: 'linear-gradient(135deg, #1a1f3a 0%, #0a0e27 100%)',
          borderTop: '2px solid rgba(139, 92, 246, 0.3)',
          padding: '48px 24px',
          display: 'flex',
          gap: '48px'
        }}>
          {/* Left Section - File Management */}
          <div style={{
            width: '380px',
            display: 'flex',
            flexDirection: 'column',
            gap: '24px'
          }}>
            <h2 style={{ fontSize: '20px', fontWeight: 700, color: '#f1f5f9', marginBottom: '8px' }}>
              ðŸ“ Data Management
            </h2>

            {/* Upload Button */}
            <button
              onClick={() => fileInputRef.current?.click()}
              className="button-primary"
              style={{
                width: '100%',
                marginBottom: '16px',
                justifyContent: 'center',
                padding: '14px'
              }}
            >
              ðŸ“¤ ðŸ“¡ Upload CSV File
            </button>

            {/* Files Section */}
            {uploadedFiles.length > 0 && (
              <div style={{ marginBottom: '16px' }}>
                <h3 style={{
                  fontSize: '14px',
                  fontWeight: 700,
                  textTransform: 'uppercase',
                  letterSpacing: '0.5px',
                  color: '#94a3b8',
                  marginBottom: '12px'
                }}>
                  ðŸ“ Files ({uploadedFiles.length})
                </h3>
                
                <div style={{ maxHeight: '300px', overflowY: 'auto' }} className="scrollbar-custom">
                  {uploadedFiles.map((file) => (
                    <div key={file.id} className="glass-card" style={{ 
                      padding: '14px', 
                      marginBottom: '10px', 
                      display: 'flex', 
                      alignItems: 'center', 
                      gap: '12px',
                      opacity: file.visible ? 1 : 0.5,
                      transition: 'opacity 0.2s',
                      border: file.visible ? '1px solid rgba(139, 92, 246, 0.3)' : '1px solid rgba(100, 116, 139, 0.2)'
                    }}>
                      <input
                        type="checkbox"
                        checked={file.visible}
                        onChange={(e) => {
                          if (e.target.checked) {
                            setUploadedFiles(prev => prev.map(f => 
                              f.id === file.id ? { ...f, visible: true } : { ...f, visible: false }
                            ));
                            setSavedLists(prev => prev.map(l => ({ ...l, visible: false })));
                          } else {
                            setUploadedFiles(prev => prev.map(f => 
                              f.id === file.id ? { ...f, visible: false } : f
                            ));
                          }
                        }}
                        style={{
                          width: '18px',
                          height: '18px',
                          cursor: 'pointer',
                          accentColor: '#8b5cf6',
                          flexShrink: 0
                        }}
                      />
                      <div style={{
                        width: '36px',
                        height: '36px',
                        background: file.visible ? 'rgba(139, 92, 246, 0.2)' : 'rgba(100, 116, 139, 0.2)',
                        borderRadius: '10px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '18px',
                        flexShrink: 0
                      }}>
                        ðŸ“„
                      </div>
                      <div style={{ flex: 1, overflow: 'hidden' }}>
                        <div style={{ 
                          fontSize: '13px', 
                          color: file.visible ? '#f1f5f9' : '#94a3b8', 
                          marginBottom: '4px', 
                          fontWeight: 600,
                          overflow: 'hidden',
                          textOverflow: 'ellipsis',
                          whiteSpace: 'nowrap'
                        }}>
                          {file.name}
                        </div>
                        <div style={{ fontSize: '11px', color: '#64748b' }}>
                          {file.count} customers
                        </div>
                      </div>
                      <button
                        onClick={() => setUploadedFiles(prev => prev.filter(f => f.id !== file.id))}
                        style={{
                          background: 'rgba(239, 68, 68, 0.1)',
                          border: '1px solid rgba(239, 68, 68, 0.2)',
                          borderRadius: '8px',
                          width: '32px',
                          height: '32px',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          color: '#fca5a5',
                          cursor: 'pointer',
                          fontSize: '14px',
                          flexShrink: 0
                        }}
                      >
                        ðŸ—‘ï¸
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}
            
            {/* Saved Lists Section */}
            {savedLists.length > 0 && (
              <div>
                <h3 style={{
                  fontSize: '14px',
                  fontWeight: 700,
                  textTransform: 'uppercase',
                  letterSpacing: '0.5px',
                  color: '#94a3b8',
                  marginBottom: '12px'
                }}>
                  ðŸ“¡ Saved Lists ({savedLists.length})
                </h3>
                
                <div style={{ maxHeight: '300px', overflowY: 'auto' }} className="scrollbar-custom">
                  {savedLists.map((list) => (
                    <div key={list.id} className="glass-card" style={{ 
                      padding: '14px', 
                      marginBottom: '10px', 
                      display: 'flex', 
                      alignItems: 'center', 
                      gap: '12px',
                      opacity: list.visible ? 1 : 0.5,
                      transition: 'opacity 0.2s',
                      border: list.visible ? '1px solid rgba(34, 197, 94, 0.3)' : '1px solid rgba(100, 116, 139, 0.2)'
                    }}>
                      <input
                        type="checkbox"
                        checked={list.visible}
                        onChange={(e) => {
                          if (e.target.checked) {
                            setSavedLists(prev => prev.map(l => 
                              l.id === list.id ? { ...l, visible: true } : { ...l, visible: false }
                            ));
                            setUploadedFiles(prev => prev.map(f => ({ ...f, visible: false })));
                          } else {
                            setSavedLists(prev => prev.map(l => 
                              l.id === list.id ? { ...l, visible: false } : l
                            ));
                          }
                        }}
                        style={{
                          width: '18px',
                          height: '18px',
                          cursor: 'pointer',
                          accentColor: '#22c55e',
                          flexShrink: 0
                        }}
                      />
                      <div style={{
                        width: '36px',
                        height: '36px',
                        background: list.visible ? 'rgba(34, 197, 94, 0.2)' : 'rgba(100, 116, 139, 0.2)',
                        borderRadius: '10px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '18px',
                        flexShrink: 0
                      }}>
                        ðŸ“‹
                      </div>
                      <div style={{ flex: 1, overflow: 'hidden' }}>
                        <div style={{ 
                          fontSize: '12px', 
                          color: list.visible ? '#f1f5f9' : '#94a3b8', 
                          marginBottom: '3px', 
                          fontWeight: 600 
                        }}>
                          {list.count} customers
                        </div>
                        <div style={{
                          fontSize: '11px',
                          color: '#64748b',
                          overflow: 'hidden',
                          textOverflow: 'ellipsis',
                          whiteSpace: 'nowrap'
                        }}>
                          {list.name}
                        </div>
                      </div>
                      <button
                        onClick={() => {
                          const remaining = savedLists.filter(l => l.id !== list.id);
                          setSavedLists(remaining);
                          // If deleted list was visible, show the first remaining list or first uploaded file
                          if (list.visible) {
                            if (remaining.length > 0) {
                              setSavedLists(remaining.map((l, i) => ({ ...l, visible: i === 0 })));
                            } else if (uploadedFiles.length > 0) {
                              setUploadedFiles(prev => prev.map((f, i) => ({ ...f, visible: i === 0 })));
                            }
                          }
                        }}
                        style={{
                          background: 'rgba(239, 68, 68, 0.1)',
                          border: '1px solid rgba(239, 68, 68, 0.2)',
                          borderRadius: '8px',
                          width: '32px',
                          height: '32px',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          color: '#fca5a5',
                          cursor: 'pointer',
                          fontSize: '14px',
                          flexShrink: 0
                        }}
                      >
                        ðŸ—‘ï¸
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
          
          {/* Right Section - Info */}
          <div style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', gap: '24px' }}>
          <div style={{ textAlign: 'center', maxWidth: '800px' }}>
            <h2 style={{ fontSize: '28px', fontWeight: 700, marginBottom: '16px', color: '#f1f5f9' }}>
              ðŸ›¸ Route Planning System
            </h2>
            <p style={{ fontSize: '16px', color: '#94a3b8', lineHeight: '1.6' }}>
              Complete route management and customer relationship tools for your business.
            </p>
          </div>
          
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '24px', width: '100%', maxWidth: '1000px' }}>
            <div style={{ 
              background: 'rgba(139, 92, 246, 0.1)', 
              border: '1px solid rgba(139, 92, 246, 0.3)',
              borderRadius: '12px',
              padding: '24px',
              textAlign: 'center'
            }}>
              <div style={{ fontSize: '32px', marginBottom: '12px' }}>ðŸ“…</div>
              <h3 style={{ fontSize: '16px', fontWeight: 600, color: '#f1f5f9', marginBottom: '8px' }}>Schedule Management</h3>
              <p style={{ fontSize: '13px', color: '#94a3b8' }}>Organize routes by day with drag-and-drop time slots</p>
            </div>
            
            <div style={{ 
              background: 'rgba(139, 92, 246, 0.1)', 
              border: '1px solid rgba(139, 92, 246, 0.3)',
              borderRadius: '12px',
              padding: '24px',
              textAlign: 'center'
            }}>
              <div style={{ fontSize: '32px', marginBottom: '12px' }}>ðŸ—ºï¸</div>
              <h3 style={{ fontSize: '16px', fontWeight: 600, color: '#f1f5f9', marginBottom: '8px' }}>Interactive Maps</h3>
              <p style={{ fontSize: '13px', color: '#94a3b8' }}>Satellite views and route optimization</p>
            </div>
            
            <div style={{ 
              background: 'rgba(139, 92, 246, 0.1)', 
              border: '1px solid rgba(139, 92, 246, 0.3)',
              borderRadius: '12px',
              padding: '24px',
              textAlign: 'center'
            }}>
              <div style={{ fontSize: '32px', marginBottom: '12px' }}>ðŸ’¾</div>
              <h3 style={{ fontSize: '16px', fontWeight: 600, color: '#f1f5f9', marginBottom: '8px' }}>Route Saving</h3>
              <p style={{ fontSize: '13px', color: '#94a3b8' }}>Save and manage multiple route configurations</p>
            </div>
          </div>
          
          <div style={{ fontSize: '12px', color: '#64748b', marginTop: '24px' }}>
            Â© 2026 Route Planning System â€¢ All Rights Reserved
          </div>
          </div>
        </div>
        </>
      );
    };

    ReactDOM.render(<CustomerMap />, document.getElementById('root'));
  </script>
</body></html>
