
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>ðŸ›¸ Galactic Navigation System - Alien Customer CRM ðŸ¦•</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; overflow-y: auto; overflow-x: hidden; background: #0a0e27; max-width: 100vw; }
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .custom-marker { background: transparent; border: none; }
    .marker-pin {
      width: 20px; height: 26px; border-radius: 50% 50% 50% 0;
      transform: rotate(-45deg); margin-left: 2px; margin-top: 3px;
      box-shadow: 0 4px 16px rgba(139, 92, 246, 0.5);
      transition: all 0.3s; cursor: pointer;
      position: relative;
    }
    .marker-pin:hover { 
      transform: rotate(-45deg) scale(1.3); 
      box-shadow: 0 6px 24px rgba(139, 92, 246, 0.7);
    }
    .marker-pin.in-route {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important;
      transform: rotate(-45deg) scale(1.2);
    }
    .marker-pin.suggested {
      background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%) !important;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: rotate(-45deg) scale(1.25); }
      50% { transform: rotate(-45deg) scale(1.35); }
    }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes pulse-glow { 
      0%, 100% { 
        box-shadow: 0 0 20px rgba(139, 92, 246, 0.6), 0 0 40px rgba(139, 92, 246, 0.3); 
      } 
      50% { 
        box-shadow: 0 0 30px rgba(139, 92, 246, 0.8), 0 0 60px rgba(139, 92, 246, 0.5); 
      } 
    }
    @keyframes slideInRight { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes pulse-ring {
      0% { transform: translate(-50%, -50%) scale(0.8); opacity: 1; }
      50% { transform: translate(-50%, -50%) scale(1); opacity: 0.6; }
      100% { transform: translate(-50%, -50%) scale(1.2); opacity: 0; }
    }
    @keyframes pulse-dot {
      0%, 100% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.2); }
    }
    @keyframes bounce-arrow-down {
      0%, 100% { transform: translateX(-50%) translateY(0); }
      50% { transform: translateX(-50%) translateY(5px); }
    }
    @keyframes pulse-label {
      0%, 100% { transform: translate(-50%, -100px) scale(1); }
      50% { transform: translate(-50%, -100px) scale(1.05); }
    }
    @keyframes pulse-label-modal {
      0%, 100% { transform: translateX(-50%) scale(1); }
      50% { transform: translateX(-50%) scale(1.05); }
    }
    
    .leaflet-tooltip {
      background: rgba(10, 14, 39, 0.98) !important;
      border: 1px solid rgba(139, 92, 246, 0.3) !important;
      border-radius: 8px !important;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4) !important;
      padding: 0 !important;
      backdrop-filter: blur(12px) !important;
      color: #f1f5f9 !important;
      max-width: 250px !important;
    }
    
    .leaflet-tooltip-top:before {
      border-top-color: rgba(10, 14, 39, 0.98) !important;
    }
    
    .custom-tooltip {
      max-width: 250px !important;
    }
    
    .leaflet-popup-content-wrapper {
      background: rgba(15, 23, 42, 0.98) !important;
      border: 2px solid rgba(139, 92, 246, 0.3) !important;
      border-radius: 8px !important;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5) !important;
      padding: 8px !important;
      backdrop-filter: blur(20px) !important;
      will-change: transform;
    }
    
    .leaflet-popup {
      margin-bottom: 12px !important;
    }
    
    .leaflet-popup-content {
      margin: 0 !important;
      color: #f1f5f9 !important;
      width: 180px !important;
    }
    
    .leaflet-popup-tip {
      background: rgba(15, 23, 42, 0.98) !important;
    }
    
    /* Prevent map from panning when popup opens */
    .leaflet-container {
      transition: none !important;
    }
    
    .custom-popup .leaflet-popup-close-button {
      color: #94a3b8 !important;
      font-size: 18px !important;
      padding: 4px !important;
      width: 20px !important;
      height: 20px !important;
      line-height: 20px !important;
    }
    
    .custom-popup .leaflet-popup-close-button:hover {
      color: #f1f5f9 !important;
    }
    
    /* Ensure popup content is clickable */
    .leaflet-popup-content-wrapper,
    .leaflet-popup-content {
      pointer-events: auto !important;
    }
    
    /* Style popup buttons on hover */
    .leaflet-popup button:hover {
      opacity: 0.9;
      transform: translateY(-1px);
      transition: all 0.2s ease;
    }
    
    .leaflet-popup a:hover {
      opacity: 0.9;
    }

    .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(99, 102, 241, 0.2)) !important;
      border: 2px solid rgba(139, 92, 246, 0.6) !important;
      backdrop-filter: blur(8px);
      transition: all 0.3s ease;
    }
    
    .marker-cluster-small div, .marker-cluster-medium div, .marker-cluster-large div {
      background: linear-gradient(135deg, #8b5cf6, #6366f1) !important;
      color: white;
      font-family: 'Inter', sans-serif;
      font-weight: 700;
      font-size: 14px;
    }
    
    .glass-card {
      background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(20px);
      border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 24px;
      transition: all 0.3s;
      box-shadow: 0 0 10px rgba(139, 92, 246, 0.1);
    }
    .glass-card:hover { 
      border-color: rgba(139, 92, 246, 0.4);
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
    }
    
    .button-primary {
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      border: none; border-radius: 16px; padding: 12px 20px;
      color: white; font-weight: 600; font-size: 14px; cursor: pointer;
      display: inline-flex; align-items: center; gap: 8px;
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.5), 0 4px 16px rgba(99, 102, 241, 0.3);
      transition: all 0.3s;
    }
    .button-primary:hover:not(:disabled) { 
      transform: translateY(-2px); 
      box-shadow: 0 0 30px rgba(139, 92, 246, 0.8), 0 6px 20px rgba(99, 102, 241, 0.5);
    }
    .button-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .button-secondary {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 16px; padding: 12px 20px;
      color: #e2e8f0; font-weight: 600; font-size: 14px;
      cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
      transition: all 0.3s;
      box-shadow: 0 0 10px rgba(139, 92, 246, 0.2);
    }
    .button-secondary:hover { 
      background: rgba(139, 92, 246, 0.2); 
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.4);
    }
    
    .input-field {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 16px; padding: 14px 18px;
      color: #f1f5f9; font-size: 14px; font-family: 'Inter', sans-serif;
      outline: none; width: 100%; transition: all 0.3s;
    }
    .input-field:focus { border-color: #8b5cf6; box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1); }
    .input-field::placeholder { color: #64748b; }
    
    textarea.input-field { resize: vertical; min-height: 80px; }
    
    .upload-area {
      border: 2px dashed rgba(139, 92, 246, 0.3);
      border-radius: 24px; padding: 32px; text-align: center;
      cursor: pointer; transition: all 0.3s;
      background: rgba(139, 92, 246, 0.05);
    }
    .upload-area:hover { border-color: #8b5cf6; transform: translateY(-2px); }
    .upload-area.dragover { border-color: #8b5cf6; background: rgba(139, 92, 246, 0.15); }
    
    input[type="file"] { display: none; }
    
    .route-stop-item {
      padding: 16px; border-radius: 16px;
      background: rgba(15, 23, 42, 0.4);
      margin-bottom: 8px; border: 1px solid rgba(34, 197, 94, 0.3);
      cursor: grab; transition: all 0.2s;
      user-select: none;
    }
    .route-stop-item:active { cursor: grabbing; }
    .route-stop-item.dragging { opacity: 0.5; }
    .route-stop-item:hover { background: rgba(34, 197, 94, 0.1); }
    
    .suggested-customer-item {
      padding: 16px; border-radius: 16px;
      background: rgba(15, 23, 42, 0.4);
      margin-bottom: 8px; border: 1px solid rgba(245, 158, 11, 0.3);
      cursor: pointer; transition: all 0.2s;
    }
    .suggested-customer-item:hover { background: rgba(245, 158, 11, 0.1); transform: translateX(4px); }
    
    /* Recurring Job Styles */
    .recurring-job {
      border: 2px solid rgba(59, 130, 246, 0.5) !important;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(99, 102, 241, 0.05)) !important;
      position: relative;
    }
    .recurring-job::before {
      content: 'ðŸ”„';
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 16px;
      z-index: 1;
    }
    
    .tab-button {
      background: transparent; border: none;
      border-bottom: 2px solid transparent;
      padding: 6px 12px; color: #64748b;
      font-weight: 600; font-size: 11px; cursor: pointer;
      transition: all 0.3s;
    }
    .tab-button:hover { color: #94a3b8; }
    .tab-button.active { color: #8b5cf6; border-bottom-color: #8b5cf6; }
    
    .distance-badge {
      display: inline-flex; align-items: center; gap: 4px;
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(99, 102, 241, 0.2));
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 12px; padding: 4px 10px;
      font-size: 11px; font-weight: 600; color: #c4b5fd;
    }
    
    .scrollbar-custom::-webkit-scrollbar { width: 8px; }
    .scrollbar-custom::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.3); border-radius: 4px; }
    .scrollbar-custom::-webkit-scrollbar-thumb { background: rgba(139, 92, 246, 0.4); border-radius: 4px; }
    
    .modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px);
      display: flex; align-items: center; justify-content: center;
      z-index: 10000; animation: fadeIn 0.3s;
    }
    
    .modal-content {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95));
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 32px; padding: 32px; max-width: 500px; width: 90%;
      max-height: 80vh; overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: slideUp 0.3s;
    }
    
    .route-number {
      width: 32px; height: 32px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border-radius: 12px; display: flex;
      align-items: center; justify-content: center;
      font-weight: 700; font-size: 14px; color: white;
    }
    
    .stat-card { animation: slideUp 0.5s ease-out; }
    
    .status-badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 12px; border-radius: 12px;
      font-size: 12px; font-weight: 600;
    }
    .status-new { background: rgba(59, 130, 246, 0.2); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.3); }
    .status-customered { background: rgba(245, 158, 11, 0.2); color: #fcd34d; border: 1px solid rgba(245, 158, 11, 0.3); }
    .status-nurturing { background: rgba(139, 92, 246, 0.2); color: #c4b5fd; border: 1px solid rgba(139, 92, 246, 0.3); }
    .status-qualified { background: rgba(34, 197, 94, 0.2); color: #86efac; border: 1px solid rgba(34, 197, 94, 0.3); }
    
    select, textarea {
      background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 16px; padding: 14px 18px; color: #f1f5f9;
      font-size: 14px; font-family: 'Inter', sans-serif;
      outline: none; width: 100%; transition: all 0.3s;
    }
    select { cursor: pointer; }
    select:focus, textarea:focus { border-color: #8b5cf6; box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1); }

    /* Google Sheets-style table */
    .pipeline-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(15, 23, 42, 0.6);
      border-radius: 16px;
      overflow: hidden;
    }
    
    .pipeline-table thead {
      background: rgba(139, 92, 246, 0.2);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .pipeline-table th {
      padding: 16px;
      text-align: left;
      font-size: 13px;
      font-weight: 700;
      color: #c4b5fd;
      border-bottom: 2px solid rgba(139, 92, 246, 0.3);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .pipeline-table td {
      padding: 16px;
      font-size: 14px;
      color: #e2e8f0;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }
    
    .pipeline-table tbody tr {
      transition: all 0.2s;
    }
    
    .pipeline-table tbody tr:hover {
      background: rgba(139, 92, 246, 0.1);
    }
    
    .pipeline-table input[type="text"],
    .pipeline-table textarea,
    .pipeline-table select {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 8px;
      padding: 8px 12px;
      color: #f1f5f9;
      font-size: 13px;
      width: 100%;
    }
    
    .pipeline-table input[type="text"]:focus,
    .pipeline-table textarea:focus,
    .pipeline-table select:focus {
      border-color: #8b5cf6;
      outline: none;
    }

    .pipeline-table input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const HOME_BASE_ADDRESS = "1444 Mountain Air Trail, Fort Worth, TX 76131";

    const CustomerMap = () => {
      // PERFORMANCE: Disable logs in production mode
      const PRODUCTION_MODE = true; // Set to true to boost performance
      const log = PRODUCTION_MODE ? () => {} : console.log;
      
      const [currentView, setCurrentView] = useState('map');
      const [uploadedFiles, setUploadedFiles] = useState([]); // Array of {id, name, customers, visible}
      const [savedLists, setSavedLists] = useState([]); // Array of {id, name, customers, visible, type: 'list'}
      const [showRecurringList, setShowRecurringList] = useState(false); // Toggle for auto-generated recurring list
      const [customers, setCustomers] = useState([]);
      const [filteredCustomers, setFilteredCustomers] = useState([]);
      const [verifying, setVerifying] = useState(false);
      const [verificationProgress, setVerificationProgress] = useState({ current: 0, total: 0 });
      const [selectedCustomer, setSelectedCustomer] = useState(null);
      const [verificationEditMode, setVerificationEditMode] = useState(false);
      const [hoveredCustomer, setHoveredCustomer] = useState(null);
      const [verifyingCustomer, setVerifyingCustomer] = useState(false);
      const [visibleCustomers, setVisibleCustomers] = useState([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [dragOver, setDragOver] = useState(false);
      const [searchQuery, setSearchQuery] = useState('');
      const [cityFilter, setCityFilter] = useState('');
      const [stateFilter, setStateFilter] = useState('');
      const [zipFilter, setZipFilter] = useState('');
      const [showHeatMap, setShowHeatMap] = useState(false);
      const [radiusMode, setRadiusMode] = useState(false);
      const [awaitingMapClick, setAwaitingMapClick] = useState(false);
      const [showSaveModal, setShowSaveModal] = useState(false);
      const [showSaveListModal, setShowSaveListModal] = useState(false);
      const [showFilterPanel, setShowFilterPanel] = useState(true);
      const [showExistingJobModal, setShowExistingJobModal] = useState(false);
      const [existingJobData, setExistingJobData] = useState({
        totalPanels: '',
        lastServiceDate: '',
        amountPaid: '',
        isRecurring: false,
        nextScheduledDate: ''
      });
      const [listName, setListName] = useState('');
      const [radiusAddress, setRadiusAddress] = useState('');
      const [radiusMiles, setRadiusMiles] = useState(10);
      const [drawMode, setDrawMode] = useState(false);
      const [drawnArea, setDrawnArea] = useState(null);
      const [drawnPolygon, setDrawnPolygon] = useState(null);
      const [lastServiceFilter, setLastServiceFilter] = useState(''); // '', '3months', '6months', '12months'
      const [referencePoint, setReferencePoint] = useState(null);
      const [referenceAddress, setReferenceAddress] = useState('');
      const [homeBase, setHomeBase] = useState(null);
      const [mapBounds, setMapBounds] = useState(null);
      const [route, setRoute] = useState([]); // Keep for backward compatibility
      const [routesByDay, setRoutesByDay] = useState({}); // New: routes organized by day
      const [suggestedCustomers, setSuggestedCustomers] = useState([]);
      const [savedRoutes, setSavedRoutes] = useState([]);
      const [failedCustomers, setFailedCustomers] = useState([]);
      const [showFailedCustomersModal, setShowFailedCustomersModal] = useState(false);
      const [pipelineCustomers, setPipelineCustomers] = useState([]);
      const [selectedPipeline, setSelectedPipeline] = useState([]);
      const [sortBy, setSortBy] = useState('none'); // 'none', 'lastService', 'zip', 'panels'
      const [sortOrder, setSortOrder] = useState('asc'); // 'asc', 'desc'
      const [selectedDate, setSelectedDate] = useState(new Date());
      const [savedViewDays, setSavedViewDays] = useState({}); // Track which days show saved view: { 'dateString': true/false }
      const [selectedRouteIndexByDay, setSelectedRouteIndexByDay] = useState({}); // Track which route is selected for each day: { 'dateString': 0, 1, 2... }
      const [weekStart, setWeekStart] = useState(() => {
        const today = new Date();
        const day = today.getDay();
        const diff = today.getDate() - day; // Get Monday
        return new Date(today.setDate(diff));
      });
      const [showCalendar, setShowCalendar] = useState(true);
      const [showTip, setShowTip] = useState(true);
      const [calendarViewMode, setCalendarViewMode] = useState('week'); // 'week' or 'month'
      const [statusFilter, setStatusFilter] = useState('unscheduled'); // Default to unscheduled - highest priority
      const [preferredDateFilter, setPreferredDateFilter] = useState([]); // Array of dates
      const [preferredTimeFilter, setPreferredTimeFilter] = useState([]); // Array of time windows
      const [showDayView, setShowDayView] = useState(false);
      const [dayViewDate, setDayViewDate] = useState(null);
      // Scheduled map view: show routes on map by week or month
      const [scheduledMapView, setScheduledMapView] = useState('week'); // 'week' or 'month'
      const [scheduledViewWeekStart, setScheduledViewWeekStart] = useState(() => {
        const d = new Date(); d.setDate(d.getDate() - d.getDay()); d.setHours(0,0,0,0); return d;
      });
      const [showNeedScheduling, setShowNeedScheduling] = useState(false); // Toggle unscheduled overlay
      const [visibleStartHour, setVisibleStartHour] = useState(8); // 8am default
      const [visibleEndHour, setVisibleEndHour] = useState(17); // 5pm default
      const [filterWeekStart, setFilterWeekStart] = useState(() => {
        const today = new Date();
        const day = today.getDay();
        const diff = today.getDate() - day;
        return new Date(today.setDate(diff));
      });
      const [filterCity, setFilterCity] = useState('');
      const [filterState, setFilterState] = useState('');
      const [filterZip, setFilterZip] = useState('');
      const [verificationFilter, setVerificationFilter] = useState('all'); // 'all', 'verified', 'no-solar', 'unverified'
      const [activeFilters, setActiveFilters] = useState({
        verifiedSolar: false,
        existingJob: false,
        recurring: false,
        minPanels: '',
        lastService: ''
      });
      const [routeName, setRouteName] = useState('');
      const [editingRouteId, setEditingRouteId] = useState(null);
      const [editingSavedRouteId, setEditingSavedRouteId] = useState(null); // Track which saved route is being edited on the map
      const [editedRouteName, setEditedRouteName] = useState('');
      const [editingCustomerNotes, setEditingCustomerNotes] = useState(null); // {routeId, customerId}
      const [editedNotes, setEditedNotes] = useState('');
      const [draggedIndex, setDraggedIndex] = useState(null);
      const [stats, setStats] = useState({
        total: 0,
        visible: 0,
        states: 0,
        avgDistance: 0,
        totalRouteDistance: 0
      });
      const [showAllMarkers, setShowAllMarkers] = useState(false); // Performance: toggle showing all 20k+ markers
      
      // PROPERTY DATA: Stories, Street View, etc.
      const [propertyDataCache, setPropertyDataCache] = useState({}); // Cache property lookups
      const [streetViewCache, setStreetViewCache] = useState({}); // Cache street view images
      const [showStreetView, setShowStreetView] = useState(true); // Toggle street view in popups
      const [propertyApiKey, setPropertyApiKey] = useState(localStorage.getItem('propertyApiKey') || ''); // ATTOM API key (optional)
      
      // SMART LOADING: Query-based database approach
      const [loadedRowCount, setLoadedRowCount] = useState(0); // How many rows loaded so far
      const [totalRowCount, setTotalRowCount] = useState(0); // Total rows in sheet
      const [isLoadingMore, setIsLoadingMore] = useState(false);
      const [hasMoreData, setHasMoreData] = useState(true);
      const [queryCache, setQueryCache] = useState({}); // Cache query results
      const [lastQueryTime, setLastQueryTime] = useState(null);
      
      // VERIFICATION SYSTEM - Property Type & Solar Permits
      const [verificationEnabled, setVerificationEnabled] = useState(true);
      const [verificationResults, setVerificationResults] = useState({}); // customerID -> verification data
      const [autoVerify, setAutoVerify] = useState(false); // Auto-verify on customer add

      const [showJobModal, setShowJobModal] = useState(false);
      const [showCustomerProfile, setShowCustomerProfile] = useState(false);
      const [profileCustomer, setProfileCustomer] = useState(null);
      const [newJobNote, setNewJobNote] = useState('');
      const [newCustomerNote, setNewCustomerNote] = useState('');

      // Google Sheets Integration
      const [googleSheetId, setGoogleSheetId] = useState('1w3bZyKiHK4YQBtO80zEh5HctNarMngbMjaUyITylltI');
      const [googleApiKey, setGoogleApiKey] = useState('');
      const [sheetsConnected, setSheetsConnected] = useState(false);
      const [autoSyncSheets, setAutoSyncSheets] = useState(false);
      const [lastSheetSync, setLastSheetSync] = useState(null);
      const [sheetSyncing, setSheetSyncing] = useState(false);

      // Track local overrides (kept for audit trail, not actively used with one-way import)
      const [localOverrides, setLocalOverrides] = useState(() => {
        try { return JSON.parse(localStorage.getItem('localOverrides') || '{}'); }
        catch { return {}; }
      });

      // Track pending cell edits so refreshes don't overwrite them
      const pendingEditsRef = useRef(new Map()); // key: "row-col", value: { value, timestamp }

      // Export to Google Sheet via Apps Script
      const [appsScriptUrl, setAppsScriptUrl] = useState(() => localStorage.getItem('appsScriptUrl') || '');
      const [lastSheetExport, setLastSheetExport] = useState(() => {
        const saved = localStorage.getItem('lastSheetExport');
        return saved ? new Date(saved) : null;
      });
      const [sheetExporting, setSheetExporting] = useState(false);

      // Pipeline Google Sheets Live Sync
      const [sheetHeaders, setSheetHeaders] = useState([]); // Actual column headers from Google Sheet
      const [sheetData, setSheetData] = useState([]); // Raw data rows from Google Sheet
      const [pipelineSortColumn, setPipelineSortColumn] = useState(null); // Column index being sorted
      const [pipelineSortOrder, setPipelineSortOrder] = useState('asc'); // 'asc' or 'desc'
      const [sheetAutoRefresh, setSheetAutoRefresh] = useState(true); // Auto-refresh from Google Sheets
      const [sheetRefreshInterval, setSheetRefreshInterval] = useState(30000); // Refresh every 30 seconds
      
      // Job Creation Modal State
      const [jobForm, setJobForm] = useState({
        customerId: null,
        customerName: '',
        isNewCustomer: false,
        firstName: '',
        lastName: '',
        address: '',
        phone: '',
        email: '',
        panelCount: '',
        pricingTier: '2', // Default to Tier 2
        customPrice: '',
        useCustomPrice: false,
        calculatedPrice: 0,
        jobType: 'Panel Cleaning',
        scheduledDate: '',
        scheduledTime: '',
        isRecurring: false,
        recurringFrequency: '12', // months
        assignedEmployee: 'Chance Thompson',
        notes: ''
      });
      const [customerSearchQuery, setCustomerSearchQuery] = useState('');
      const [customerSearchResults, setCustomerSearchResults] = useState([]);
      const [geocoding, setGeocoding] = useState(false);
      const [addressSuggestions, setAddressSuggestions] = useState([]);
      const [searchingAddress, setSearchingAddress] = useState(false);
      
      const mapRef = useRef(null);
      const mapInstanceRef = useRef(null);
      const prevSelectedDateRef = useRef(null);
      const markerClusterRef = useRef(null);
      const heatLayerRef = useRef(null);
      const radiusCircleRef = useRef(null);
      const referenceMarkerRef = useRef(null);
      const homeBaseMarkerRef = useRef(null);
      const routeLinesRef = useRef([]);
      const fileInputRef = useRef(null);
      const markersMapRef = useRef(new Map());

      // Pricing Tiers
      const PRICING_TIERS = {
        '1': 9,  // Tier 1: $9/panel
        '2': 8,  // Tier 2: $8/panel
        '3': 7,  // Tier 3: $7/panel
        '4': 6   // Tier 4: $6/panel
      };

      // Helper function to construct proper CSV URL from any Google Sheets URL format
      const getGoogleSheetsCsvUrl = (input) => {
        if (!input) return null;

        // If URL already contains output=csv or format=csv, use it directly
        if (input.includes('output=csv') || input.includes('format=csv')) {
          return input;
        }

        // Check for published sheet format: /d/e/PUBLISHED_ID/
        const publishedMatch = input.match(/\/d\/e\/([a-zA-Z0-9-_]+)/);
        if (publishedMatch) {
          const publishedId = publishedMatch[1];
          return `https://docs.google.com/spreadsheets/d/e/${publishedId}/pub?gid=0&single=true&output=csv`;
        }

        // Check for regular sheet format: /d/SHEET_ID/
        const regularMatch = input.match(/\/d\/([a-zA-Z0-9-_]+)/);
        if (regularMatch) {
          const sheetId = regularMatch[1];
          return `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=0`;
        }

        // Assume it's just a sheet ID
        return `https://docs.google.com/spreadsheets/d/${input}/export?format=csv&gid=0`;
      };

      // CSV Row Parser - handles quoted values, escaped quotes, values with spaces
      const parseCSVRow = (row) => {
        const result = [];
        let current = '';
        let inQuotes = false;

        for (let i = 0; i < row.length; i++) {
          const char = row[i];
          const nextChar = row[i + 1];

          if (inQuotes) {
            if (char === '"' && nextChar === '"') {
              current += '"';
              i++;
            } else if (char === '"') {
              inQuotes = false;
            } else {
              current += char;
            }
          } else {
            if (char === '"') {
              inQuotes = true;
            } else if (char === ',') {
              result.push(current.trim());
              current = '';
            } else {
              current += char;
            }
          }
        }
        result.push(current.trim());
        return result;
      };

      // Load saved data (clear old pipeline data - now using Google Sheets directly)
      useEffect(() => {
        const saved = localStorage.getItem('savedRoutes');
        const sheetId = localStorage.getItem('googleSheetId');
        const sheetsApiKey = localStorage.getItem('googleApiKey');

        // Clear old pipeline data since we now use Google Sheets directly
        localStorage.removeItem('pipelineCustomers');

        if (saved) {
          const parsedRoutes = JSON.parse(saved);
          setSavedRoutes(parsedRoutes);
          // Initialize saved view for days that have saved routes
          const savedDays = {};
          parsedRoutes.forEach(r => {
            if (r.scheduledDate) {
              savedDays[new Date(r.scheduledDate).toDateString()] = true;
            }
          });
          setSavedViewDays(savedDays);
        }
        if (sheetId) {
          setGoogleSheetId(sheetId);
          setSheetsConnected(true);
        }
        if (sheetsApiKey) setGoogleApiKey(sheetsApiKey);
      }, []);

      // Save data
      useEffect(() => {
        if (savedRoutes.length > 0) {
          localStorage.setItem('savedRoutes', JSON.stringify(savedRoutes));
        }
      }, [savedRoutes]);

      // Save localOverrides to localStorage
      useEffect(() => {
        localStorage.setItem('localOverrides', JSON.stringify(localOverrides));
      }, [localOverrides]);

      // Save appsScriptUrl to localStorage
      useEffect(() => {
        if (appsScriptUrl) localStorage.setItem('appsScriptUrl', appsScriptUrl);
      }, [appsScriptUrl]);

      // Update calculated price when panel count or tier changes
      useEffect(() => {
        if (!jobForm.useCustomPrice && jobForm.panelCount) {
          const calculated = calculateJobPrice(parseInt(jobForm.panelCount), jobForm.pricingTier);
          setJobForm(prev => ({ ...prev, calculatedPrice: calculated }));
        }
      }, [jobForm.panelCount, jobForm.pricingTier, jobForm.useCustomPrice]);

      // Search customers when search query changes
      useEffect(() => {
        searchCustomers(customerSearchQuery);
      }, [customerSearchQuery]);

      // Auto-sync from Google Sheets
      useEffect(() => {
        if (!autoSyncSheets || !sheetsConnected) return;
        
        const interval = setInterval(() => {
          syncFromGoogleSheet();
        }, 30000); // Every 30 seconds
        
        return () => clearInterval(interval);
      }, [autoSyncSheets, sheetsConnected]);

      // NOTE: filteredCustomers is managed by the unified filter useEffect below (search for "UNIFIED FILTER")

      // Day colors for scheduled map view
      const DAY_COLORS = {
        0: { color: '#ef4444', label: 'Sun', bg: 'rgba(239, 68, 68, 0.3)' },  // Red
        1: { color: '#f97316', label: 'Mon', bg: 'rgba(249, 115, 22, 0.3)' },  // Orange
        2: { color: '#eab308', label: 'Tue', bg: 'rgba(234, 179, 8, 0.3)' },   // Yellow
        3: { color: '#22c55e', label: 'Wed', bg: 'rgba(34, 197, 94, 0.3)' },   // Green
        4: { color: '#3b82f6', label: 'Thu', bg: 'rgba(59, 130, 246, 0.3)' },  // Blue
        5: { color: '#8b5cf6', label: 'Fri', bg: 'rgba(139, 92, 246, 0.3)' },  // Purple
        6: { color: '#ec4899', label: 'Sat', bg: 'rgba(236, 72, 153, 0.3)' }   // Pink
      };

      // Get customers from saved routes for a date range
      const getScheduledCustomersForRange = (startDate, endDate) => {
        const result = new Map(); // customerId -> { customer, routeDate, routeName, dayOfWeek }
        savedRoutes.forEach(sr => {
          if (sr.sentToTech) return;
          const routeDate = new Date(sr.scheduledDate);
          if (routeDate >= startDate && routeDate <= endDate) {
            sr.customers.forEach(c => {
              if (c.lat && c.lng) {
                result.set(c.id, {
                  ...c,
                  _routeDate: routeDate,
                  _routeName: sr.name,
                  _dayOfWeek: routeDate.getDay(),
                  _dayLabel: routeDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })
                });
              }
            });
          }
        });
        return Array.from(result.values());
      };

      const calculateDistance = (lat1, lon1, lat2, lon2) => {
        const R = 3959;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      };

      // Geocode home base
      useEffect(() => {
        const geocodeHomeBase = async () => {
          try {
            // Use CORS proxy for local file access
            const nominatimUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(HOME_BASE_ADDRESS)}&limit=1`;
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(nominatimUrl)}`;
            
            const response = await fetch(proxyUrl);
            const data = await response.json();
            if (data && data.length > 0) {
              setHomeBase({ lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) });
            }
          } catch (error) {
            console.error('Error geocoding home base:', error);
            // Silently fail - user can still use the app without home base
          }
        };
        geocodeHomeBase();
      }, []);

      // Load verification data from localStorage and merge with customers
      useEffect(() => {
        if (customers.length === 0) return;
        
        const saved = localStorage.getItem('gapFillerVerifications');
        if (saved) {
          try {
            const verifications = JSON.parse(saved);
            setCustomers(prev => prev.map(customer => {
              const verification = verifications[customer.id];
              if (verification) {
                return { ...customer, ...verification };
              }
              return customer;
            }));
          } catch (error) {
            console.error('Error loading verifications:', error);
          }
        }
      }, [customers.length > 0 ? customers.length : null]); // Only run when customers first loaded
      
      // Merge visible files and lists into customers array (merge duplicates by address with secondary contacts)
      useEffect(() => {
        const allSources = [
          ...uploadedFiles.filter(file => file.visible),
          ...savedLists.filter(list => list.visible)
        ];
        
        const allCustomers = allSources.flatMap(source => source.customers);
        
        // Merge duplicates by address, keeping secondary phone/email
        const addressMap = new Map();
        
        allCustomers.forEach(customer => {
          // Skip customers without address
          if (!customer.address) {
            console.warn('Customer missing address:', customer.name || customer.id);
            return;
          }
          
          const normalizedAddress = customer.address
            .toLowerCase()
            .trim()
            .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '')
            .replace(/\s+/g, ' ');
          
          if (addressMap.has(normalizedAddress)) {
            // Address already exists - merge as secondary contact
            const existing = addressMap.get(normalizedAddress);
            
            // Add secondary phone if different
            if (customer.phone && customer.phone !== existing.phone) {
              if (!existing.secondaryPhones) existing.secondaryPhones = [];
              if (!existing.secondaryPhones.includes(customer.phone)) {
                existing.secondaryPhones.push(customer.phone);
              }
            }
            
            // Add secondary email if different
            if (customer.email && customer.email !== existing.email) {
              if (!existing.secondaryEmails) existing.secondaryEmails = [];
              if (!existing.secondaryEmails.includes(customer.email)) {
                existing.secondaryEmails.push(customer.email);
              }
            }
            
            console.log('Merged duplicate address:', customer.address, '- Added secondary contacts');
          } else {
            // First occurrence of this address
            addressMap.set(normalizedAddress, customer);
          }
        });
        
        const uniqueCustomers = Array.from(addressMap.values());
        
        console.log(`Loaded ${allCustomers.length} total customers, ${uniqueCustomers.length} unique by address (with merged contacts)`);
        
        setCustomers(uniqueCustomers);
        // filteredCustomers will be set by the unified filter useEffect reacting to customers change
      }, [uploadedFiles, savedLists]);

      // Restore scheduling data from savedRoutes into customers on load
      // This ensures scheduledTime/scheduledDate persist across page reloads
      useEffect(() => {
        if (customers.length === 0 || savedRoutes.length === 0) return;

        // Build a map of customer scheduling data from saved routes
        // Skip routes already sent to tech - those customers are no longer scheduled
        const scheduleMap = new Map();
        savedRoutes.forEach(sr => {
          if (sr.sentToTech) return; // Don't restore scheduling for sent routes
          sr.customers.forEach(c => {
            if (c.scheduledTime || c.scheduledDate) {
              scheduleMap.set(c.id, {
                scheduledTime: c.scheduledTime,
                scheduledDate: sr.scheduledDate || c.scheduledDate,
                status: 'scheduled',
                routeConfirmed: true,
                confirmedRouteName: sr.name
              });
            }
          });
        });

        if (scheduleMap.size === 0) return;

        // Check if any customers are missing scheduling data
        const needsUpdate = customers.some(c => {
          const sched = scheduleMap.get(c.id);
          return sched && !c.scheduledTime;
        });

        if (needsUpdate) {
          setCustomers(prev => prev.map(c => {
            const sched = scheduleMap.get(c.id);
            if (sched && !c.scheduledTime) {
              return { ...c, ...sched };
            }
            return c;
          }));
        }
      }, [customers.length, savedRoutes.length]);

      // Clean up orphaned scheduling data when changing dates (edit mode cleanup)
      useEffect(() => {
        const currentDateKey = selectedDate.toDateString();
        const prevDateKey = prevSelectedDateRef.current;

        // If we changed dates and were not in saved view on the previous date
        if (prevDateKey && prevDateKey !== currentDateKey && savedViewDays[prevDateKey] !== true) {
          // Find saved routes for the previous date
          const savedRoutesForPrevDay = savedRoutes.filter(r => {
            const rDate = new Date(r.scheduledDate);
            return rDate.toDateString() === prevDateKey;
          });

          // Get all customer IDs that are in saved routes for that day
          const savedCustomerIds = new Set();
          savedRoutesForPrevDay.forEach(r => {
            if (r.customers) {
              r.customers.forEach(c => savedCustomerIds.add(c.id));
            }
          });

          // Clear scheduling for customers that were scheduled for prev day but aren't in any saved route
          setCustomers(prev => prev.map(c => {
            if (!c.scheduledDate) return c;
            const custDate = new Date(c.scheduledDate);
            if (custDate.toDateString() === prevDateKey && !savedCustomerIds.has(c.id)) {
              // This customer was scheduled for prev day but not in any saved route - orphaned
              return {
                ...c,
                scheduledDate: null,
                scheduledTime: null,
                status: 'unscheduled',
                routeConfirmed: false
              };
            }
            return c;
          }));

          // Clear routesByDay for previous date
          setRoutesByDay(prev => ({ ...prev, [prevDateKey]: [] }));
          setEditingSavedRouteId(null);
        }

        // Update the ref for next change
        prevSelectedDateRef.current = currentDateKey;
      }, [selectedDate]);

      // NOTE: All customer filtering is handled in the unified filter useEffect below (search for "UNIFIED FILTER")
      
      // Calculate statistics
      useEffect(() => {
        const customersToAnalyze = visibleCustomers.length > 0 ? visibleCustomers : filteredCustomers;
        
        if (customersToAnalyze.length === 0) {
          setStats({ total: 0, visible: 0, states: 0, avgDistance: 0, totalRouteDistance: 0 });
          return;
        }

        const states = new Set(customersToAnalyze.map(c => c.state).filter(Boolean));

        let avgDistance = 0;
        if (homeBase) {
          const totalDistance = customersToAnalyze.reduce((sum, c) => {
            if (!c.lat || !c.lng) return sum;
            return sum + calculateDistance(homeBase.lat, homeBase.lng, c.lat, c.lng);
          }, 0);
          avgDistance = totalDistance / customersToAnalyze.length;
        }

        let totalRouteDistance = 0;
        if (route.length > 0 && homeBase) {
          // Distance from home to first stop
          totalRouteDistance = calculateDistance(homeBase.lat, homeBase.lng, route[0].lat, route[0].lng);
          // Distance between stops
          for (let i = 0; i < route.length - 1; i++) {
            totalRouteDistance += calculateDistance(route[i].lat, route[i].lng, route[i + 1].lat, route[i + 1].lng);
          }
          // Return trip to home
          const lastStop = route[route.length - 1];
          totalRouteDistance += calculateDistance(lastStop.lat, lastStop.lng, homeBase.lat, homeBase.lng);
        }

        setStats({
          total: filteredCustomers.length,
          visible: visibleCustomers.length,
          states: states.size,
          avgDistance,
          totalRouteDistance
        });
      }, [visibleCustomers, filteredCustomers, homeBase, route]);

      // Update visible customers
      useEffect(() => {
        if (!mapInstanceRef.current) return;

        const updateVisible = () => {
          const bounds = mapInstanceRef.current.getBounds();
          let visible = filteredCustomers.filter(c => {
            if (!c.lat || !c.lng) return false;
            return bounds.contains([c.lat, c.lng]);
          });
          
          // Apply sorting
          if (sortBy !== 'none') {
            visible = [...visible].sort((a, b) => {
              let compareValue = 0;
              
              if (sortBy === 'lastService') {
                const dateA = a.lastServiceDate ? new Date(a.lastServiceDate).getTime() : 0;
                const dateB = b.lastServiceDate ? new Date(b.lastServiceDate).getTime() : 0;
                compareValue = dateA - dateB;
              } else if (sortBy === 'zip') {
                const zipA = parseInt(a.zip) || 0;
                const zipB = parseInt(b.zip) || 0;
                compareValue = zipA - zipB;
              } else if (sortBy === 'panels') {
                const panelsA = parseInt(a.panelCount || a.totalPanels) || 0;
                const panelsB = parseInt(b.panelCount || b.totalPanels) || 0;
                compareValue = panelsA - panelsB;
              }
              
              return sortOrder === 'asc' ? compareValue : -compareValue;
            });
          }
          
          setVisibleCustomers(visible);
        };

        mapInstanceRef.current.on('moveend', updateVisible);
        mapInstanceRef.current.on('zoomend', updateVisible);
        
        updateVisible();

        return () => {
          if (mapInstanceRef.current) {
            mapInstanceRef.current.off('moveend', updateVisible);
            mapInstanceRef.current.off('zoomend', updateVisible);
          }
        };
      }, [filteredCustomers, sortBy, sortOrder]);

      // Geocode address to coordinates
      const geocodeAddress = async (address) => {
        try {
          // Remove emojis from address
          const cleanAddress = address.replace(/[\u{1F300}-\u{1F9FF}]/gu, '').trim();
          
          // Use CORS proxy for local file access
          const nominatimUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cleanAddress)}&limit=1`;
          const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(nominatimUrl)}`;
          
          const response = await fetch(proxyUrl);
          const data = await response.json();
          if (data && data.length > 0) {
            return { 
              lat: parseFloat(data[0].lat), 
              lng: parseFloat(data[0].lon),
              display_name: data[0].display_name
            };
          }
          return null;
        } catch (error) {
          console.error('Geocoding error:', error);
          return null;
        }
      };

      // Draw radius circle on map (visual only - filtering handled by unified filter useEffect)
      const drawRadius = (latlng, radiusMeters, displayName) => {
        const L = window.L;
        if (!mapInstanceRef.current) return;

        // Remove existing circle
        if (radiusCircleRef.current) {
          mapInstanceRef.current.removeLayer(radiusCircleRef.current);
        }

        // Create new circle
        const circle = L.circle([latlng.lat, latlng.lng], {
          radius: radiusMeters,
          color: '#8b5cf6',
          fillColor: '#8b5cf6',
          fillOpacity: 0.1,
          weight: 2
        }).addTo(mapInstanceRef.current);

        radiusCircleRef.current = circle;
        setReferencePoint(latlng);
        setReferenceAddress(displayName);

        // Filtering is now handled by the unified filter useEffect
        // which reacts to referencePoint and radiusMiles changes
        mapInstanceRef.current.fitBounds(circle.getBounds(), { padding: [50, 50] });
      };

      // Clear radius circle
      const clearRadius = () => {
        if (radiusCircleRef.current && mapInstanceRef.current) {
          mapInstanceRef.current.removeLayer(radiusCircleRef.current);
          radiusCircleRef.current = null;
        }
        if (referenceMarkerRef.current && mapInstanceRef.current) {
          mapInstanceRef.current.removeLayer(referenceMarkerRef.current);
          referenceMarkerRef.current = null;
        }
        setReferencePoint(null);
        setReferenceAddress('');
        // Filtering handled by unified filter useEffect
      };

      // Clear drawn area
      const clearDrawnArea = () => {
        if (drawnPolygon && mapInstanceRef.current) {
          mapInstanceRef.current.removeLayer(drawnPolygon);
        }
        setDrawnPolygon(null);
        setDrawnArea(null);
        setDrawMode(false);
        // Reset filtered customers if no other filters active
        if (!referencePoint) {
          setFilteredCustomers(customers);
        }
      };

      // Completely exit radius mode and reset view
      const exitRadiusMode = () => {
        clearRadius();
        clearDrawnArea();
        setRadiusMode(false);
        setAwaitingMapClick(false);
        setLastServiceFilter('');
        setFilteredCustomers(customers);
      };

      // Drawing state for freehand polygon
      const drawingPointsRef = React.useRef([]);
      const drawingLayerRef = React.useRef(null);

      // Handle radius search from address
      const handleRadiusSearch = async (clickMode = false) => {
        if (clickMode) {
          // Click mode is now handled by the awaitingMapClick state
          return;
        } else if (radiusAddress) {
          const coords = await geocodeAddress(radiusAddress);
          if (coords) {
            drawRadius({ lat: coords.lat, lng: coords.lng }, radiusMiles * 1609.34, coords.display_name);
            setRadiusAddress('');
          } else {
            alert('Could not find address. Please try a different address.');
          }
        }
      };

      // Initialize map - only once
      useEffect(() => {
        if (!mapRef.current || mapInstanceRef.current) return;

        const initMap = () => {
          const L = window.L;
          const map = L.map(mapRef.current, {
            preferCanvas: true,  // CRITICAL: Use Canvas instead of SVG for markers
            renderer: L.canvas({ tolerance: 5 })  // Canvas renderer with click tolerance
          }).setView([32.7555, -97.3308], 10);
          
          L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: 'Â© OpenStreetMap Â© CARTO',
            maxZoom: 19
          }).addTo(map);

          const markers = L.markerClusterGroup({
            chunkedLoading: true,
            chunkInterval: 500,
            chunkDelay: 100,
            chunkProgress: (processed, total, elapsed) => {
              if (processed % 1000 === 0) {
                console.log(`ðŸ“ Loaded ${processed}/${total} markers (${Math.round(processed/total*100)}%)`);
              }
            },
            maxClusterRadius: 10,  // Extremely tight: only nearly-overlapping pins cluster
            spiderfyOnMaxZoom: true,
            spiderfyDistanceMultiplier: 1.5,
            spiderLegPolylineOptions: { weight: 1.5, color: '#8b5cf6', opacity: 0.6 },
            showCoverageOnHover: false,
            zoomToBoundsOnClick: false,
            disableClusteringAtZoom: 7,  // Show individual pins from zoom 7+ (city-level)
            removeOutsideVisibleBounds: true,
            animate: false
          });

          // Click cluster â†’ spiderfy to show individual pins (no zoom)
          markers.on('clusterclick', function (e) {
            e.layer.spiderfy();
          });

          map.addLayer(markers);
          markerClusterRef.current = markers;
          mapInstanceRef.current = map;
          
          // Track map bounds for sidebar filtering
          const updateBounds = () => {
            setMapBounds(map.getBounds());
          };
          
          map.on('moveend', updateBounds);
          map.on('zoomend', updateBounds);
          updateBounds(); // Set initial bounds
        };

        if (window.L) {
          initMap();
        }
      }, []);

      // Update map when switching back to map view
      useEffect(() => {
        if (currentView === 'map' && mapInstanceRef.current) {
          // Small delay to ensure map container is visible
          setTimeout(() => {
            mapInstanceRef.current.invalidateSize();
          }, 100);
        }
      }, [currentView]);
      
      // Handle map clicks for radius mode
      useEffect(() => {
        if (!mapInstanceRef.current) return;
        
        const handleMapClick = (e) => {
          if (awaitingMapClick && radiusMode) {
            const latlng = e.latlng;
            clearRadius();
            drawRadius(latlng, radiusMiles * 1609.34, 'Selected Point');
            setAwaitingMapClick(false);
          }
        };
        
        mapInstanceRef.current.on('click', handleMapClick);
        
        return () => {
          if (mapInstanceRef.current) {
            mapInstanceRef.current.off('click', handleMapClick);
          }
        };
      }, [awaitingMapClick, radiusMode, radiusMiles, customers]);
      
      // Change cursor to crosshair when awaiting map click
      useEffect(() => {
        if (!mapInstanceRef.current) return;
        
        const container = mapInstanceRef.current.getContainer();
        if (awaitingMapClick && radiusMode) {
          container.style.cursor = 'crosshair';
        } else {
          container.style.cursor = '';
        }
        
        return () => {
          if (mapInstanceRef.current) {
            mapInstanceRef.current.getContainer().style.cursor = '';
          }
        };
      }, [awaitingMapClick, radiusMode]);

      // Handle draw mode for custom area selection
      useEffect(() => {
        if (!mapInstanceRef.current) return;
        const map = mapInstanceRef.current;
        const L = window.L;

        if (drawMode) {
          map.getContainer().style.cursor = 'crosshair';
          drawingPointsRef.current = [];

          const onMouseDown = (e) => {
            if (!drawMode) return;
            drawingPointsRef.current = [e.latlng];

            // Create initial polyline
            if (drawingLayerRef.current) {
              map.removeLayer(drawingLayerRef.current);
            }
            drawingLayerRef.current = L.polyline([e.latlng], {
              color: '#8b5cf6',
              weight: 3,
              opacity: 0.8,
              dashArray: '5, 10'
            }).addTo(map);

            map.dragging.disable();
          };

          const onMouseMove = (e) => {
            if (!drawMode || drawingPointsRef.current.length === 0) return;
            drawingPointsRef.current.push(e.latlng);
            if (drawingLayerRef.current) {
              drawingLayerRef.current.setLatLngs(drawingPointsRef.current);
            }
          };

          const onMouseUp = (e) => {
            if (!drawMode || drawingPointsRef.current.length < 3) {
              map.dragging.enable();
              return;
            }

            // Close the polygon
            drawingPointsRef.current.push(drawingPointsRef.current[0]);

            // Remove temporary polyline
            if (drawingLayerRef.current) {
              map.removeLayer(drawingLayerRef.current);
              drawingLayerRef.current = null;
            }

            // Remove old polygon if exists
            if (drawnPolygon) {
              map.removeLayer(drawnPolygon);
            }

            // Create final polygon
            const polygon = L.polygon(drawingPointsRef.current, {
              color: '#8b5cf6',
              weight: 3,
              fillColor: '#8b5cf6',
              fillOpacity: 0.2
            }).addTo(map);

            setDrawnPolygon(polygon);
            setDrawnArea(drawingPointsRef.current);
            setDrawMode(false);
            map.dragging.enable();
            map.getContainer().style.cursor = '';
          };

          const onKeyDown = (e) => {
            if (e.key === 'Escape') {
              setDrawMode(false);
            }
          };

          map.on('mousedown', onMouseDown);
          map.on('mousemove', onMouseMove);
          map.on('mouseup', onMouseUp);
          document.addEventListener('keydown', onKeyDown);

          return () => {
            map.off('mousedown', onMouseDown);
            map.off('mousemove', onMouseMove);
            map.off('mouseup', onMouseUp);
            document.removeEventListener('keydown', onKeyDown);
            map.dragging.enable();
            map.getContainer().style.cursor = '';
            // Clean up temporary drawing polyline
            if (drawingLayerRef.current) {
              map.removeLayer(drawingLayerRef.current);
              drawingLayerRef.current = null;
            }
            drawingPointsRef.current = [];
          };
        } else {
          map.getContainer().style.cursor = '';
        }
      }, [drawMode, drawnPolygon]);

      // Listen for popup action events
      useEffect(() => {
        const handleAddToRoute = (e) => {
          const customerId = e.detail;
          const customer = customers.find(c => c.id === customerId);
          if (customer) {
            handleCustomerClick(customer);
            // Close any open popups
            if (mapInstanceRef.current) {
              mapInstanceRef.current.closePopup();
            }
          }
        };
        
        const handleVerifySolar = async (e) => {
          const customerId = e.detail;
          const customer = customers.find(c => c.id === customerId);
          if (customer) {
            const status = await verifyCustomerSolar(customer);
            markVerified(customerId, status);
            // Close popup after verification
            if (mapInstanceRef.current) {
              mapInstanceRef.current.closePopup();
            }
          }
        };
        
        const handleMarkVerified = (e) => {
          const { id, status } = e.detail;
          markVerified(id, status);
          // Close popup after marking
          if (mapInstanceRef.current) {
            mapInstanceRef.current.closePopup();
          }
        };
        
        const handleMarkRecurring = (event) => {
          const customerId = event.detail;
          const customer = customers.find(c => c.id === customerId);
          if (customer) {
            setSelectedCustomer(customer);
            // Pre-populate form with existing values if available
            setExistingJobData({
              totalPanels: customer.totalPanels || '',
              lastServiceDate: customer.lastServiceDate || '',
              amountPaid: customer.amountPaid || '',
              isRecurring: customer.isRecurring || false,
              nextScheduledDate: customer.nextScheduledDate || ''
            });
            setShowExistingJobModal(true);
          }
        };
        
        // Handle auto-verify property
        const handleAutoVerify = async (e) => {
          const customerId = e.detail;
          const customer = customers.find(c => c.id === customerId);
          
          if (!customer) return;
          
          console.log('ðŸ” Auto-verifying property:', customer.address);
          
          try {
            // Run verification
            const results = await verifyProperty(customer);
            
            // Update customer with verification results
            setCustomers(prevCustomers => 
              prevCustomers.map(c => {
                if (c.id === customerId) {
                  return {
                    ...c,
                    propertyType: results.propertyType || c.propertyType,
                    solarVerified: results.hasSolar === true ? 'yes' : 
                                  results.hasSolar === false ? 'no' : 
                                  c.solarVerified,
                    verificationDate: results.timestamp,
                    verificationSources: results.sources
                  };
                }
                return c;
              })
            );
            
            // Show success message
            if (results.verified) {
              alert(
                `âœ… Verification Complete!\n\n` +
                `Property Type: ${results.propertyType === 'commercial' ? 'ðŸ¢ Commercial' : 'ðŸ  Residential'}\n` +
                `Solar Status: ${results.hasSolar ? 'âœ“ Has Solar' : 'âŒ No Solar Found'}\n\n` +
                `Data Sources: ${results.sources.join(', ')}\n\n` +
                (results.solarDetails?.permits?.length > 0 ? 
                  `Solar Permits: ${results.solarDetails.permits.length} found\n` : '') +
                `\nVerification saved!`
              );
            } else {
              alert(
                `âš ï¸ Verification Incomplete\n\n` +
                `Could not verify this property automatically.\n\n` +
                `Possible reasons:\n` +
                `â€¢ Address not in Dallas area (limited to Dallas Open Data)\n` +
                `â€¢ No recent building permits\n` +
                `â€¢ Property not in public databases\n\n` +
                `You can still mark solar status manually.`
              );
            }
            
          } catch (error) {
            console.error('Auto-verify failed:', error);
            alert(`âŒ Verification Error\n\n${error.message}\n\nPlease try again or verify manually.`);
          }
        };
        
        window.addEventListener('addToRoute', handleAddToRoute);
        window.addEventListener('verifySolar', handleVerifySolar);
        window.addEventListener('markVerified', handleMarkVerified);
        window.addEventListener('markRecurring', handleMarkRecurring);
        window.addEventListener('autoVerifyProperty', handleAutoVerify);
        
        return () => {
          window.removeEventListener('addToRoute', handleAddToRoute);
          window.removeEventListener('verifySolar', handleVerifySolar);
          window.removeEventListener('markVerified', handleMarkVerified);
          window.removeEventListener('markRecurring', handleMarkRecurring);
          window.removeEventListener('autoVerifyProperty', handleAutoVerify);
        };
      }, [customers]);
      
      // Highlight map marker when hovering sidebar card
      useEffect(() => {
        if (!hoveredCustomer || !markersMapRef.current) return;
        
        const marker = markersMapRef.current.get(hoveredCustomer.id);
        if (!marker) return;
        
        const markerElement = marker.getElement();
        if (!markerElement) return;
        
        const pinElement = markerElement.querySelector('.marker-pin');
        if (!pinElement) return;
        
        // Check if in route or suggested
        const isInRoute = route.some(r => r.id === hoveredCustomer.id);
        const isSuggested = suggestedCustomers.some(c => c.id === hoveredCustomer.id);
        
        if (!isInRoute && !isSuggested) {
          pinElement.style.background = 'linear-gradient(135deg, #c4b5fd 0%, #a78bfa 100%)';
          pinElement.style.transform = 'rotate(-45deg) scale(1.3)';
          pinElement.style.boxShadow = '0 8px 20px rgba(139, 92, 246, 0.6)';
        }
        
        return () => {
          if (pinElement && !isInRoute && !isSuggested) {
            pinElement.style.background = 'linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%)';
            pinElement.style.transform = 'rotate(-45deg) scale(1)';
            pinElement.style.boxShadow = '0 4px 16px rgba(139, 92, 246, 0.5)';
          }
        };
      }, [hoveredCustomer, route, suggestedCustomers]);

      // Update home base marker
      useEffect(() => {
        if (!mapInstanceRef.current || !window.L || !homeBase) return;

        const L = window.L;

        if (homeBaseMarkerRef.current) {
          mapInstanceRef.current.removeLayer(homeBaseMarkerRef.current);
        }

        const homeIcon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="width: 30px; height: 30px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 16px rgba(59, 130, 246, 0.6); display: flex; align-items: center; justify-content: center;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
              <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
          </div>`,
          iconSize: [30, 30],
          iconAnchor: [15, 15]
        });

        const homeMarker = L.marker([homeBase.lat, homeBase.lng], { icon: homeIcon })
          .addTo(mapInstanceRef.current);

        homeMarker.bindTooltip(`
          <div style="font-family: 'Inter', sans-serif;">
            <div style="font-size: 13px; font-weight: 700; color: #3b82f6; margin-bottom: 6px;">
              ðŸ  Home Base
            </div>
            <div style="font-size: 11px; color: #94a3b8;">
              ${HOME_BASE_ADDRESS}
            </div>
          </div>
        `, {
          direction: 'top',
          offset: [0, -15],
          opacity: 0.98
        });

        homeBaseMarkerRef.current = homeMarker;
      }, [homeBase]);

      // Update reference point marker
      useEffect(() => {
        if (!mapInstanceRef.current || !window.L || !referencePoint) return;

        const L = window.L;

        if (referenceMarkerRef.current) {
          mapInstanceRef.current.removeLayer(referenceMarkerRef.current);
        }

        const refIcon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="width: 24px; height: 24px; background: linear-gradient(135deg, #f59e0b, #ea580c); border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 16px rgba(245, 158, 11, 0.6);"></div>`,
          iconSize: [24, 24],
          iconAnchor: [12, 12]
        });

        const refMarker = L.marker([referencePoint.lat, referencePoint.lng], { icon: refIcon })
          .addTo(mapInstanceRef.current);

        refMarker.bindTooltip(`
          <div style="font-family: 'Inter', sans-serif;">
            <div style="font-size: 13px; font-weight: 700; color: #f59e0b; margin-bottom: 6px;">
              ðŸŽ¯ Reference Point
            </div>
            <div style="font-size: 11px; color: #94a3b8;">
              ${referenceAddress || 'Selected Location'}
            </div>
          </div>
        `, {
          direction: 'top',
          offset: [0, -12],
          opacity: 0.98
        });

        referenceMarkerRef.current = refMarker;
      }, [referencePoint, referenceAddress]);

      // Update markers and route lines
      useEffect(() => {
        if (!markerClusterRef.current || !window.L) return;

        markerClusterRef.current.clearLayers();
        markersMapRef.current.clear();

        routeLinesRef.current.forEach(line => {
          if (mapInstanceRef.current) mapInstanceRef.current.removeLayer(line);
        });
        routeLinesRef.current = [];

        if (heatLayerRef.current && mapInstanceRef.current) {
          mapInstanceRef.current.removeLayer(heatLayerRef.current);
          heatLayerRef.current = null;
        }

        if (filteredCustomers.length === 0) return;

        const L = window.L;

        if (showHeatMap) {
          const heatData = filteredCustomers
            .filter(c => c.lat && c.lng)
            .map(c => [c.lat, c.lng, 1]);
          
          const heat = L.heatLayer(heatData, {
            radius: 25,
            blur: 35,
            maxZoom: 17,
            max: 1.0,
            gradient: {
              0.0: '#8b5cf6',
              0.5: '#6366f1',
              1.0: '#f59e0b'
            }
          }).addTo(mapInstanceRef.current);
          
          heatLayerRef.current = heat;
        } else {
          const routeIds = new Set(route.map(r => r.id));
          const suggestedIds = new Set(suggestedCustomers.map(s => s.id));

          // Performance optimization for large datasets
          const currentZoom = mapInstanceRef.current.getZoom();
          const customerCount = filteredCustomers.length;
          
          // For very large datasets (>5000), skip every Nth marker when zoomed out
          let renderEveryNth = 1;
          if (customerCount > 15000 && currentZoom < 12) {
            renderEveryNth = 4; // Show 25% of markers
          } else if (customerCount > 10000 && currentZoom < 12) {
            renderEveryNth = 3; // Show 33% of markers
          } else if (customerCount > 5000 && currentZoom < 12) {
            renderEveryNth = 2; // Show 50% of markers
          }
          
          console.log(`ðŸ“Š Rendering ${Math.floor(customerCount / renderEveryNth)} of ${customerCount} markers (zoom: ${currentZoom})`);

          filteredCustomers.forEach((customer, index) => {
            if (!customer.lat || !customer.lng) return;
            
            // Skip markers based on zoom/count for performance
            if (renderEveryNth > 1 && index % renderEveryNth !== 0) return;

            // Check if customer is scheduled for the SELECTED day
            const isScheduledToday = (() => {
              if (!customer.scheduledDate || !customer.scheduledTime) return false;
              const custDate = new Date(customer.scheduledDate);
              return custDate.toDateString() === selectedDate.toDateString();
            })();
            
            // Find job number for selected day only
            let routeNumber = null;
            if (isScheduledToday) {
              const jobsForDay = customers
                .filter(c => {
                  if (!c.scheduledDate || !c.scheduledTime) return false;
                  const custDate = new Date(c.scheduledDate);
                  return custDate.toDateString() === selectedDate.toDateString();
                })
                .sort((a, b) => {
                  const [aH, aM] = a.scheduledTime.split(':').map(Number);
                  const [bH, bM] = b.scheduledTime.split(':').map(Number);
                  return (aH * 60 + aM) - (bH * 60 + bM);
                });
              
              const jobIndex = jobsForDay.findIndex(j => j.id === customer.id);
              routeNumber = jobIndex >= 0 ? jobIndex + 1 : null;
            }
            
            const isSuggested = suggestedIds.has(customer.id);
            const isInRoute = routeIds.has(customer.id);

            let pinClass = '';
            let gradient = 'linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%)';
            let verifyBadge = '';
            let goldCheckmark = '';
            let scheduledOtherDayBadge = '';
            let dayLabelBadge = '';

            // Scheduled map view: color pins by day of week
            if (statusFilter === 'scheduled' && customer._dayOfWeek !== undefined) {
              const dayInfo = DAY_COLORS[customer._dayOfWeek];
              if (dayInfo) {
                gradient = `linear-gradient(135deg, ${dayInfo.color} 0%, ${dayInfo.color}cc 100%)`;
                dayLabelBadge = `<span style="position: absolute; bottom: -12px; left: 50%; transform: translateX(-50%); font-size: 9px; background: ${dayInfo.color}; color: white; padding: 1px 4px; border-radius: 3px; font-weight: 700; white-space: nowrap; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">${customer._dayLabel}</span>`;
              }
            }
            // Needs-scheduling pins: gray/dashed style
            if (statusFilter === 'scheduled' && customer._needsScheduling) {
              gradient = 'linear-gradient(135deg, #64748b 0%, #475569 100%)';
              dayLabelBadge = '<span style="position: absolute; bottom: -12px; left: 50%; transform: translateX(-50%); font-size: 9px; background: rgba(100, 116, 139, 0.9); color: white; padding: 1px 4px; border-radius: 3px; font-weight: 700; white-space: nowrap;">Need Sched</span>';
            }
            
            // Check if scheduled on a DIFFERENT day
            const isScheduledOtherDay = customer.scheduledDate && customer.scheduledTime && !isScheduledToday;
            
            // Add gold checkmark for ANY verified status
            if (customer.solarVerified === 'yes' || customer.solarVerified === 'no') {
              goldCheckmark = '<span style="position: absolute; top: -8px; left: -8px; font-size: 16px; color: #fbbf24; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.9));">âœ“</span>';
            }
            
            // Add verification status badge
            if (customer.solarVerified === 'yes') {
              // No badge for 'yes' - only gold checkmark shows
              verifyBadge = '';
            } else if (customer.solarVerified === 'no') {
              verifyBadge = '<span style="position: absolute; top: -6px; right: -6px; font-size: 12px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.8));">âŒ</span>';
            }
            
            // Add "scheduled on other day" badge - calendar icon
            if (isScheduledOtherDay && customer.routeConfirmed) {
              const schedDate = new Date(customer.scheduledDate);
              const dayName = schedDate.toLocaleDateString('en-US', { weekday: 'short' });
              scheduledOtherDayBadge = `<span style="position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); font-size: 10px; background: rgba(34, 197, 94, 0.9); color: white; padding: 2px 4px; border-radius: 4px; font-weight: 700; white-space: nowrap; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.8));">ðŸ“…${dayName}</span>`;
            }
            
            if (isScheduledToday && routeNumber) {
              pinClass = 'in-route';
              gradient = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
            } else if (isSuggested) {
              pinClass = 'suggested';
              gradient = 'linear-gradient(135deg, #f59e0b 0%, #ea580c 100%)';
            } else if (isScheduledOtherDay) {
              // Dim the pin slightly if scheduled elsewhere
              gradient = 'linear-gradient(135deg, rgba(139, 92, 246, 0.5) 0%, rgba(99, 102, 241, 0.5) 100%)';
            }
            
            // Route number display (white text in center of pin)
            const routeNumberDisplay = routeNumber ? `<span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(45deg); color: white; font-weight: 800; font-size: 11px; text-shadow: 0 1px 3px rgba(0,0,0,0.8);">${routeNumber}</span>` : '';

            // Determine icon type based on new logic:
            // - Green dinosaur ðŸ¦– = Recurring customer
            // - Pink pin = Not recurring, but has upcoming job
            // - Default purple pin = No upcoming job
            const isRecurringCustomer = customer.isRecurring === true || customer.recurring === 'TRUE' || customer.recurring === true;

            // Calculate next service date (12 months from last service if not manually set)
            let nextServiceDate = customer.nextServiceDate;
            if (!nextServiceDate && customer.lastServiceDate) {
              const lastDate = new Date(customer.lastServiceDate);
              const next = new Date(lastDate);
              next.setFullYear(next.getFullYear() + 1);
              nextServiceDate = next.toISOString().split('T')[0];
            }
            const hasUpcomingJob = nextServiceDate && new Date(nextServiceDate) > new Date();

            let customIcon;
            if (isRecurringCustomer) {
              // Green T-Rex for recurring customers
              customIcon = L.divIcon({
                className: 'custom-marker-recurring',
                html: `<div style="font-size: 32px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); transform: translate(-50%, -50%); filter: hue-rotate(80deg) saturate(1.5);">ðŸ¦–</div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
              });
            } else if (hasUpcomingJob) {
              // Pink pin for customers with upcoming job (not recurring)
              customIcon = L.divIcon({
                className: 'custom-marker-upcoming',
                html: `<div class="marker-pin ${pinClass}" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); position: relative;">${goldCheckmark}${verifyBadge}${routeNumberDisplay}${scheduledOtherDayBadge}${dayLabelBadge}</div>`,
                iconSize: [24, 32],
                iconAnchor: [12, 32],
                popupAnchor: [0, -32]
              });
            } else {
              // Default purple pin for others
              customIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div class="marker-pin ${pinClass}" style="background: ${gradient}; position: relative;">${goldCheckmark}${verifyBadge}${routeNumberDisplay}${scheduledOtherDayBadge}${dayLabelBadge}</div>`,
                iconSize: [24, 32],
                iconAnchor: [12, 32],
                popupAnchor: [0, -32]
              });
            }

            const marker = L.marker([customer.lat, customer.lng], { 
              icon: customIcon,
              customerData: customer
            });

            const distanceFromHome = homeBase 
              ? calculateDistance(homeBase.lat, homeBase.lng, customer.lat, customer.lng)
              : null;

            // Simple hover tooltip
            const verifyStatus = customer.solarVerified === 'yes' ? 'âœ“' : 
                                customer.solarVerified === 'no' ? 'âŒ' : 'ðŸ”';

            // Rich popup shows on hover (see mouseover event below)
            // No tooltip needed as popup provides all info
            
            // Rich click popup with satellite preview
            const zoom = 20;
            const x = Math.floor((customer.lng + 180) / 360 * Math.pow(2, zoom));
            const y = Math.floor((1 - Math.log(Math.tan(customer.lat * Math.PI / 180) + 1 / Math.cos(customer.lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom));
            
            const popupContent = `
              <div style="font-family: 'Inter', sans-serif; width: 180px;">
                <div style="margin-bottom: 8px; border-radius: 4px; overflow: hidden; border: 1px solid rgba(139, 92, 246, 0.3); position: relative;">
                  <img src="https://mt1.google.com/vt/lyrs=y&x=${x}&y=${y}&z=${zoom}" style="width: 180px; height: 180px; display: block;" />
                  <div style="position: absolute; top: 4px; left: 4px; background: rgba(0,0,0,0.7); padding: 3px 6px; border-radius: 3px; font-size: 8px; font-weight: 600;">ðŸ›°ï¸</div>
                  ${customer.existingJob ? `<div style="position: absolute; top: 4px; right: 4px; background: rgba(34, 197, 94, 0.9); padding: 3px 6px; border-radius: 3px; font-size: 8px; font-weight: 600; color: white;">ðŸ¦• Past Customer</div>` : ''}
                </div>
                
                <div style="margin-bottom: 8px;">
                  <div style="font-size: 11px; font-weight: 700; color: #f1f5f9; margin-bottom: 3px;">${verifyStatus} ${customer.name}</div>
                  <div style="font-size: 9px; color: #94a3b8; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">ðŸ“ ${customer.address}</div>
                  ${customer.panelCount ? `<div style="font-size: 9px; color: #fbbf24;">${customer.panelCount} panels</div>` : ''}
                </div>
                
                ${customer.existingJob ? `
                <div style="margin-bottom: 8px; padding: 8px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 6px;">
                  <div style="font-size: 8px; color: #94a3b8; margin-bottom: 4px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Service History</div>
                  ${customer.totalPanels ? `<div style="font-size: 9px; color: #f1f5f9; margin-bottom: 2px;">â˜€ï¸ ${customer.totalPanels} panels</div>` : ''}
                  ${customer.lastServiceDate ? `<div style="font-size: 9px; color: #f1f5f9; margin-bottom: 2px;">ðŸ“… Last: ${new Date(customer.lastServiceDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' })}</div>` : ''}
                  ${customer.amountPaid ? `<div style="font-size: 9px; color: #22c55e; margin-bottom: 2px;">ðŸ’µ $${customer.amountPaid}</div>` : ''}
                  ${customer.isRecurring ? `<div style="font-size: 9px; color: #3b82f6; margin-bottom: 2px;">ðŸ¦– Recurring</div>` : ''}
                  ${customer.nextScheduledDate && customer.isRecurring ? `<div style="font-size: 9px; color: #3b82f6;">ðŸ“† Next: ${new Date(customer.nextScheduledDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' })}</div>` : ''}
                </div>
                ` : ''}
                
                <div style="display: flex; flex-direction: column; gap: 4px;">
                  <button 
                    onclick="window.dispatchEvent(new CustomEvent('addToRoute', {detail: '${customer.id}'}))"
                    style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; padding: 6px; border-radius: 4px; font-weight: 600; font-size: 10px; cursor: pointer; font-family: 'Inter', sans-serif;">
                    ${route.some(r => r.id === customer.id) ? 'âŒ Remove' : 'âž• Add'}
                  </button>
                  ${!customer.existingJob && !isRecurringCustomer ? `
                  <button
                    onclick="window.dispatchEvent(new CustomEvent('markRecurring', {detail: '${customer.id}'}))"
                    style="background: rgba(34, 197, 94, 0.1); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); padding: 6px; border-radius: 4px; font-weight: 600; font-size: 10px; cursor: pointer; font-family: 'Inter', sans-serif;">
                    ðŸ¦• Past Customer?
                  </button>
                  ` : ''}
                  <a 
                    href="https://www.google.com/maps/@${customer.lat},${customer.lng},20z/data=!3m1!1e3"
                    target="_blank"
                    style="background: rgba(59, 130, 246, 0.1); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); padding: 6px; border-radius: 4px; font-weight: 600; font-size: 10px; text-align: center; text-decoration: none; display: block; font-family: 'Inter', sans-serif;">
                    ðŸ—ºï¸ Maps
                  </a>
                  
                  <div id="verify-section-${customer.id}" style="border-top: 1px solid rgba(139, 92, 246, 0.2); margin-top: 4px; padding-top: 4px;">
                    ${(() => {
                      // Get verification results if available
                      const verification = verificationResults[customer.id];
                      
                      // Property Type Display
                      let propertyTypeDisplay = '';
                      if (verification?.propertyType) {
                        const isCommercial = verification.propertyType === 'commercial';
                        propertyTypeDisplay = `
                          <div style="background: ${isCommercial ? 'rgba(59, 130, 246, 0.1)' : 'rgba(34, 197, 94, 0.1)'}; 
                                      color: ${isCommercial ? '#60a5fa' : '#22c55e'}; 
                                      border: 1px solid ${isCommercial ? 'rgba(59, 130, 246, 0.3)' : 'rgba(34, 197, 94, 0.3)'}; 
                                      padding: 4px 6px; border-radius: 3px; font-weight: 600; 
                                      font-size: 9px; font-family: 'Inter', sans-serif; text-align: center; margin-bottom: 4px;">
                            ${isCommercial ? 'ðŸ¢ Commercial' : 'ðŸ  Residential'}
                          </div>
                        `;
                      }
                      
                      // Solar Status Display
                      const status = verification?.hasSolar !== undefined ? 
                                     (verification.hasSolar ? 'yes' : 'no') : 
                                     customer.solarVerified;
                      let statusDisplay = '';
                      let statusIcon = '';
                      let statusColor = '';
                      let statusBg = '';
                      let statusBorder = '';
                      
                      if (status === 'yes' || status === true) {
                        statusIcon = 'âœ“';
                        statusDisplay = verification?.solarDetails?.permits?.length > 0 ? 
                                       `Has Solar (${verification.solarDetails.permits.length} permits)` : 
                                       'Has Solar';
                        statusColor = '#fbbf24';
                        statusBg = 'rgba(251, 191, 36, 0.1)';
                        statusBorder = 'rgba(251, 191, 36, 0.3)';
                      } else if (status === 'no' || status === false) {
                        statusIcon = 'âŒ';
                        statusDisplay = 'No Solar';
                        statusColor = '#ef4444';
                        statusBg = 'rgba(239, 68, 68, 0.1)';
                        statusBorder = 'rgba(239, 68, 68, 0.3)';
                      } else {
                        statusIcon = 'ðŸ”';
                        statusDisplay = 'Not Verified';
                        statusColor = '#8b5cf6';
                        statusBg = 'rgba(139, 92, 246, 0.1)';
                        statusBorder = 'rgba(139, 92, 246, 0.3)';
                      }
                      
                      // Auto-verify button
                      const autoVerifyBtn = `
                        <button 
                          onclick="window.dispatchEvent(new CustomEvent('autoVerifyProperty', {detail: '${customer.id}'}))"
                          style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); 
                                 color: white; border: none; padding: 6px 8px; border-radius: 4px; 
                                 font-weight: 600; font-size: 9px; cursor: pointer; 
                                 font-family: 'Inter', sans-serif; text-align: center; width: 100%; 
                                 margin-top: 4px; box-shadow: 0 2px 4px rgba(139, 92, 246, 0.3);">
                          ðŸ” Auto-Verify with Public Data
                        </button>
                      `;
                      
                      // Verification sources display
                      let sourcesDisplay = '';
                      if (verification?.sources && verification.sources.length > 0) {
                        sourcesDisplay = `
                          <div style="font-size: 8px; color: #94a3b8; margin-top: 4px; font-family: 'Inter', sans-serif;">
                            âœ“ Verified via: ${verification.sources.join(', ')}
                          </div>
                        `;
                      }
                      
                      return propertyTypeDisplay + 
                        '<div id="status-badge-' + customer.id + '" ' +
                          'onclick="document.getElementById(\'edit-options-' + customer.id + '\').style.display=\'grid\'; this.style.display=\'none\';" ' +
                          'style="background: ' + statusBg + '; color: ' + statusColor + '; border: 1px solid ' + statusBorder + '; padding: 6px 8px; border-radius: 4px; font-weight: 600; font-size: 10px; cursor: pointer; font-family: \'Inter\', sans-serif; text-align: center; position: relative; transition: all 0.2s;">' +
                          '<span>' + statusIcon + ' ' + statusDisplay + '</span>' +
                          '<span style="margin-left: 4px; opacity: 0; transition: opacity 0.2s; font-size: 8px;">âœï¸</span>' +
                        '</div>' +
                        sourcesDisplay +
                        '<div id="edit-options-' + customer.id + '" style="display: none; grid-template-columns: 1fr 1fr 1fr; gap: 3px; margin-top: 4px;">' +
                          '<button ' +
                            'onclick="window.dispatchEvent(new CustomEvent(\'markVerified\', {detail: {id: \'' + customer.id + '\', status: \'yes\'}}));" ' +
                            'style="background: rgba(251, 191, 36, 0.1); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.3); padding: 6px 4px; border-radius: 3px; font-weight: 600; font-size: 9px; cursor: pointer; font-family: \'Inter\', sans-serif;">' +
                            'âœ“ Yes' +
                          '</button>' +
                          '<button ' +
                            'onclick="window.dispatchEvent(new CustomEvent(\'markVerified\', {detail: {id: \'' + customer.id + '\', status: \'no\'}}));" ' +
                            'style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 6px 4px; border-radius: 3px; font-weight: 600; font-size: 9px; cursor: pointer; font-family: \'Inter\', sans-serif;">' +
                            'âŒ No' +
                          '</button>' +
                          '<button ' +
                            'onclick="window.dispatchEvent(new CustomEvent(\'markVerified\', {detail: {id: \'' + customer.id + '\', status: null}}));" ' +
                            'style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6; border: 1px solid rgba(139, 92, 246, 0.3); padding: 6px 4px; border-radius: 3px; font-weight: 600; font-size: 9px; cursor: pointer; font-family: \'Inter\', sans-serif;">' +
                            'ðŸ” Not Verified' +
                          '</button>' +
                        '</div>' +
                        autoVerifyBtn +
                        '<style>' +
                          '#status-badge-' + customer.id + ':hover span:last-child { opacity: 1 !important; }' +
                        '</style>';
                    })()}
                  </div>
                </div>
              </div>
            `;
            
            marker.bindPopup(popupContent, {
              maxWidth: 180,
              minWidth: 180,
              className: 'custom-popup',
              closeButton: true,
              autoClose: false,
              closeOnClick: false,
              autoPan: false,  // Don't move map
              keepInView: false,  // Let popup extend outside if needed
              offset: [0, -10]  // Slight offset above pin
            });
            
            // Click = add to route instantly
            marker.on('click', (e) => {
              L.DomEvent.stopPropagation(e);
              marker.closePopup(); // Close popup if open
              handleCustomerClick(customer);
            });
            
            // Hover = show popup with delay
            let showTimeout;
            let hideTimeout;
            
            marker.on('mouseover', () => {
              setHoveredCustomer(customer); // For sidebar highlighting only
              clearTimeout(hideTimeout);
              
              // Highlight marker directly without re-render (only if not in route or suggested)
              if (!isInRoute && !isSuggested) {
                const markerElement = marker.getElement();
                if (markerElement) {
                  const pinElement = markerElement.querySelector('.marker-pin');
                  if (pinElement) {
                    pinElement.style.background = 'linear-gradient(135deg, #c4b5fd 0%, #a78bfa 100%)';
                    pinElement.style.transform = 'rotate(-45deg) scale(1.3)';
                    pinElement.style.boxShadow = '0 8px 20px rgba(139, 92, 246, 0.6)';
                  }
                }
              }
              
              // Small delay to prevent accidental triggers
              showTimeout = setTimeout(() => {
                marker.openPopup();
              }, 100);
            });
            
            marker.on('mouseout', () => {
              setHoveredCustomer(null); // Clear sidebar highlighting
              clearTimeout(showTimeout);
              
              // Reset marker highlighting (only if not in route or suggested)
              if (!isInRoute && !isSuggested) {
                const markerElement = marker.getElement();
                if (markerElement) {
                  const pinElement = markerElement.querySelector('.marker-pin');
                  if (pinElement) {
                    pinElement.style.background = gradient;
                    pinElement.style.transform = 'rotate(-45deg) scale(1)';
                    pinElement.style.boxShadow = '0 4px 16px rgba(139, 92, 246, 0.5)';
                  }
                }
              }
              
              // Delay closing to allow moving to popup
              hideTimeout = setTimeout(() => {
                const popup = marker.getPopup();
                if (popup && popup.isOpen()) {
                  const popupElement = popup.getElement();
                  if (popupElement && !popupElement.matches(':hover')) {
                    marker.closePopup();
                  }
                }
              }, 150);
            });
            
            // Keep popup open when hovering over it
            marker.on('popupopen', () => {
              const popup = marker.getPopup();
              const popupElement = popup.getElement();
              
              if (popupElement) {
                popupElement.addEventListener('mouseenter', () => {
                  clearTimeout(hideTimeout);
                });
                
                popupElement.addEventListener('mouseleave', () => {
                  marker.closePopup();
                });
              }
            });

            markerClusterRef.current.addLayer(marker);
            markersMapRef.current.set(customer.id, marker);
          });

          // Draw route lines - ONLY FOR SELECTED DAY
          const dateKey = selectedDate.toDateString();
          const todaysJobs = customers
            .filter(c => {
              if (!c.scheduledDate || !c.scheduledTime) return false;
              const custDate = new Date(c.scheduledDate);
              return custDate.toDateString() === dateKey;
            })
            .sort((a, b) => {
              const [aH, aM] = a.scheduledTime.split(':').map(Number);
              const [bH, bM] = b.scheduledTime.split(':').map(Number);
              return (aH * 60 + aM) - (bH * 60 + bM);
            });

          if (todaysJobs.length > 0 && homeBase) {
            // Line from home to first job
            const line1 = L.polyline(
              [[homeBase.lat, homeBase.lng], [todaysJobs[0].lat, todaysJobs[0].lng]],
              { color: '#3b82f6', weight: 3, opacity: 0.7, dashArray: '5, 10' }
            ).addTo(mapInstanceRef.current);
            routeLinesRef.current.push(line1);

            // Lines between jobs (in scheduled time order)
            for (let i = 0; i < todaysJobs.length - 1; i++) {
              const line = L.polyline(
                [[todaysJobs[i].lat, todaysJobs[i].lng], [todaysJobs[i + 1].lat, todaysJobs[i + 1].lng]],
                { color: '#22c55e', weight: 3, opacity: 0.8 }
              ).addTo(mapInstanceRef.current);
              routeLinesRef.current.push(line);
            }
          }
        }
      }, [filteredCustomers, showHeatMap, route, suggestedCustomers, homeBase, selectedDate, customers]);

      // UNIFIED FILTER - Single useEffect that applies ALL filters together
      // This includes: nav filters (status, date, time), search bar filters (city, state, zip),
      // active filters (solar, existing, recurring, panels), radius/drawn area, and text search
      useEffect(() => {
        if (customers.length === 0) {
          setFilteredCustomers([]);
          return;
        }

        let results = customers;

        // --- Navigation bar filters ---
        // Status filter (unscheduled, scheduled)
        if (statusFilter === 'scheduled') {
          // Build date range based on week/month view
          let rangeStart, rangeEnd;
          if (scheduledMapView === 'week') {
            rangeStart = new Date(scheduledViewWeekStart);
            rangeStart.setHours(0, 0, 0, 0);
            rangeEnd = new Date(rangeStart);
            rangeEnd.setDate(rangeEnd.getDate() + 6);
            rangeEnd.setHours(23, 59, 59, 999);
          } else {
            // Month view: start of month to end of month
            rangeStart = new Date(scheduledViewWeekStart.getFullYear(), scheduledViewWeekStart.getMonth(), 1);
            rangeEnd = new Date(scheduledViewWeekStart.getFullYear(), scheduledViewWeekStart.getMonth() + 1, 0, 23, 59, 59, 999);
          }

          // Get scheduled customers from saved routes in this range
          const scheduledInRange = getScheduledCustomersForRange(rangeStart, rangeEnd);
          const scheduledIds = new Set(scheduledInRange.map(c => c.id));

          // Tag customers with route day info
          const dayInfoMap = new Map();
          scheduledInRange.forEach(c => {
            dayInfoMap.set(c.id, { _routeDate: c._routeDate, _routeName: c._routeName, _dayOfWeek: c._dayOfWeek, _dayLabel: c._dayLabel });
          });

          // Filter to scheduled customers (with day info), optionally include unscheduled
          if (showNeedScheduling) {
            results = results.filter(c => scheduledIds.has(c.id) || c.status === 'unscheduled' || !c.status);
            // Merge day info into scheduled customers
            results = results.map(c => {
              const info = dayInfoMap.get(c.id);
              return info ? { ...c, ...info } : { ...c, _needsScheduling: true };
            });
          } else {
            results = results.filter(c => scheduledIds.has(c.id));
            results = results.map(c => {
              const info = dayInfoMap.get(c.id);
              return info ? { ...c, ...info } : c;
            });
          }
        } else if (statusFilter !== 'all') {
          results = results.filter(c => c.status === statusFilter);
        }

        // Preferred Date filter (multi-select)
        if (preferredDateFilter.length > 0) {
          results = results.filter(c => {
            if (!c.preferredDate) return false;
            const prefDate = new Date(c.preferredDate);
            return preferredDateFilter.some(filterDate => {
              const fDate = new Date(filterDate);
              return prefDate.toDateString() === fDate.toDateString();
            });
          });
        }

        // Preferred Time Window filter (multi-select)
        if (preferredTimeFilter.length > 0) {
          results = results.filter(c =>
            preferredTimeFilter.includes(c.preferredTimeWindow)
          );
        }

        // --- Active toggle filters ---
        if (activeFilters.verifiedSolar) {
          results = results.filter(c => c.solarVerified === 'yes');
        }
        if (activeFilters.existingJob) {
          results = results.filter(c => c.existingJob === true);
        }
        if (activeFilters.recurring) {
          results = results.filter(c => c.isRecurring === true || c.recurring === true || c.recurring === 'TRUE');
        }
        if (activeFilters.minPanels && !isNaN(parseInt(activeFilters.minPanels))) {
          const minPanels = parseInt(activeFilters.minPanels);
          results = results.filter(c => {
            const panelCount = parseInt(c.panelCount || c.totalPanels) || 0;
            return panelCount >= minPanels;
          });
        }

        // Last Service filter (from activeFilters)
        if (activeFilters.lastService) {
          const now = new Date();
          results = results.filter(c => {
            if (!c.lastServiceDate) return false;
            const lastService = new Date(c.lastServiceDate);
            const monthsDiff = (now - lastService) / (1000 * 60 * 60 * 24 * 30);
            switch (activeFilters.lastService) {
              case '3months': return monthsDiff > 3;
              case '6months': return monthsDiff > 6;
              case '1year': return monthsDiff > 12;
              case '18months': return monthsDiff > 18;
              case '2years': return monthsDiff > 24;
              default: return true;
            }
          });
        }

        // Recurring Auto-List filter
        if (showRecurringList) {
          results = results.filter(c => c.isRecurring === true || c.recurring === true);
        }

        // --- Location filters (city/state/zip dropdowns) ---
        if (cityFilter) {
          results = results.filter(c => (c.city?.toLowerCase() || '') === cityFilter.toLowerCase());
        }
        if (stateFilter) {
          results = results.filter(c => (c.state?.toLowerCase() || '') === stateFilter.toLowerCase());
        }
        if (zipFilter) {
          results = results.filter(c => (c.zip?.toLowerCase() || '').startsWith(zipFilter.toLowerCase()));
        }

        // --- Radius panel: time-based service filter ---
        if (lastServiceFilter) {
          const now = new Date();
          const monthsMap = { '3months': 3, '6months': 6, '12months': 12 };
          const monthsAgo = monthsMap[lastServiceFilter];
          if (monthsAgo) {
            const cutoffDate = new Date(now);
            cutoffDate.setMonth(cutoffDate.getMonth() - monthsAgo);
            results = results.filter(c => {
              if (!c.lastServiceDate) return true;
              const serviceDate = new Date(c.lastServiceDate);
              return serviceDate < cutoffDate;
            });
          }
        }

        // --- Spatial filters (radius circle & drawn polygon) ---
        // Radius filter: only show customers within the radius circle
        if (referencePoint && radiusMiles) {
          results = results.filter(c => {
            if (!c.lat || !c.lng) return false;
            // calculateDistance returns miles
            return calculateDistance(c.lat, c.lng, referencePoint.lat, referencePoint.lng) <= radiusMiles;
          });
        }

        // Drawn area filter
        if (drawnArea && drawnPolygon) {
          results = results.filter(c => {
            if (!c.lat || !c.lng) return false;
            const point = L.latLng(c.lat, c.lng);
            return drawnPolygon.getBounds().contains(point);
          });
        }

        // --- Text search ---
        if (searchQuery.trim()) {
          const query = searchQuery.toLowerCase().trim();

          // Panel count search: p40 means 40+ panels
          if (query.startsWith('p') && !isNaN(query.substring(1))) {
            const minPanels = parseInt(query.substring(1));
            results = results.filter(c => {
              const panelCount = parseInt(c.panelCount || c.totalPanels) || 0;
              return panelCount >= minPanels;
            });
          } else if (query === 'recurring') {
            // Recurring keyword search
            results = results.filter(c => c.isRecurring === true || c.recurring === true);
          } else {
            // State abbreviation normalization
            const stateMap = {
              'tx': 'texas', 'texas': 'texas',
              'ca': 'california', 'california': 'california',
              'fl': 'florida', 'florida': 'florida',
              'ny': 'new york', 'newyork': 'new york',
              'az': 'arizona', 'arizona': 'arizona'
            };

            const normalizedQuery = stateMap[query] || query;

            // Regular search with state normalization
            results = results.filter(c => {
              const normalizedState = (c.state?.toLowerCase() || '');
              const stateFullName = stateMap[normalizedState] || normalizedState;

              return (c.name?.toLowerCase() || '').includes(query) ||
                c.firstName?.toLowerCase().includes(query) ||
                c.lastName?.toLowerCase().includes(query) ||
                (c.address?.toLowerCase() || '').includes(query) ||
                c.city?.toLowerCase().includes(query) ||
                normalizedState.includes(query) ||
                stateFullName.includes(normalizedQuery) ||
                c.zip?.toLowerCase().includes(query) ||
                c.email?.toLowerCase().includes(query) ||
                c.phone?.toLowerCase().includes(query) ||
                c.secondaryEmails?.some(email => email?.toLowerCase().includes(query)) ||
                c.secondaryPhones?.some(phone => phone?.toLowerCase().includes(query));
            });
          }
        }

        setFilteredCustomers(results);
      }, [searchQuery, customers, cityFilter, stateFilter, zipFilter, lastServiceFilter,
          drawnArea, drawnPolygon, activeFilters, statusFilter, preferredDateFilter,
          preferredTimeFilter, showRecurringList, referencePoint, radiusMiles,
          scheduledMapView, scheduledViewWeekStart, showNeedScheduling, savedRoutes]);

      // Handle customer click - DAY SPECIFIC ROUTING
      const handleCustomerClick = (customer) => {
        const dateKey = selectedDate.toDateString();
        const currentDayRoute = routesByDay[dateKey] || [];

        // Check BOTH routesByDay AND customers state for existing scheduling
        const isInRoutesByDay = currentDayRoute.some(r => r.id === customer.id);
        const isScheduledForDay = customers.some(c => {
          if (c.id !== customer.id) return false;
          if (!c.scheduledDate) return false;
          return new Date(c.scheduledDate).toDateString() === dateKey;
        });
        const isInRoute = isInRoutesByDay || isScheduledForDay;

        if (isInRoute) {
          // Remove from THIS DAY'S route AND clear scheduling
          setRoutesByDay(prev => ({
            ...prev,
            [dateKey]: (prev[dateKey] || []).filter(r => r.id !== customer.id)
          }));

          const unscheduleUpdates = { scheduledDate: null, scheduledTime: null, status: 'unscheduled', routeConfirmed: false };
          setCustomers(prev => prev.map(c => {
            if (c.id === customer.id) {
              return { ...c, ...unscheduleUpdates };
            }
            return c;
          }));
          propagateCustomerUpdate(customer.id, unscheduleUpdates);
          setSuggestedCustomers([]);
        } else {
          // Auto-schedule with 1 hour 15 minute spacing
          const allSlots = generateTimeSlots();

          // Get all jobs for THIS SPECIFIC DAY sorted by time
          const jobsForDay = customers
            .filter(c => {
              if (!c.scheduledDate || !c.scheduledTime) return false;
              const custDate = new Date(c.scheduledDate);
              return custDate.toDateString() === selectedDate.toDateString();
            })
            .sort((a, b) => {
              const [aH, aM] = a.scheduledTime.split(':').map(Number);
              const [bH, bM] = b.scheduledTime.split(':').map(Number);
              return (aH * 60 + aM) - (bH * 60 + bM);
            });

          let nextSlot = null;

          if (jobsForDay.length === 0) {
            // First job for THIS DAY - start at 8:00 AM
            nextSlot = allSlots.find(s => s.hour === 8 && s.minute === 0);
          } else {
            // Find last scheduled job for THIS DAY and add 1 hour 15 minutes (75 minutes)
            const lastJob = jobsForDay[jobsForDay.length - 1];
            const [lastH, lastM] = lastJob.scheduledTime.split(':').map(Number);
            const lastMinutes = lastH * 60 + lastM;
            const nextMinutes = lastMinutes + 75; // 1 hour 15 minutes
            const nextH = Math.floor(nextMinutes / 60);
            const nextM = nextMinutes % 60;

            // Make sure it's not past 8pm
            if (nextH < 20) {
              nextSlot = {
                time: `${String(nextH).padStart(2, '0')}:${String(nextM).padStart(2, '0')}`,
                hour: nextH,
                minute: nextM
              };
            }
          }

          // Schedule customer to the next slot
          if (nextSlot) {
            scheduleCustomerToTimeSlot(customer, selectedDate, nextSlot.time);
          }

          // Add to THIS DAY'S route (prevent duplicates)
          setRoutesByDay(prev => {
            const existing = prev[dateKey] || [];
            if (existing.some(r => r.id === customer.id)) return prev;
            return { ...prev, [dateKey]: [...existing, customer] };
          });
          
          const availableCustomers = filteredCustomers.filter(c => 
            c.id !== customer.id && !currentDayRoute.some(r => r.id === c.id)
          );

          const closest = availableCustomers
            .map(c => ({
              ...c,
              distance: calculateDistance(customer.lat, customer.lng, c.lat, c.lng)
            }))
            .sort((a, b) => a.distance - b.distance)
            .slice(0, 3);

          setSuggestedCustomers(closest);
        }
      };

      // Sync route state with current day's route when switching days
      useEffect(() => {
        const dateKey = selectedDate.toDateString();
        const currentDayRoute = routesByDay[dateKey] || [];
        setRoute(currentDayRoute);
      }, [selectedDate, routesByDay]);

      // Drag and drop handlers for route reordering
      const handleRouteDragStart = (index) => {
        setDraggedIndex(index);
      };

      const handleRouteDragOver = (e, index) => {
        e.preventDefault();
      };

      const handleRouteDrop = (index) => {
        if (draggedIndex === null || draggedIndex === index) {
          setDraggedIndex(null);
          return;
        }

        const dateKey = selectedDate.toDateString();
        const newRoute = [...route];
        const draggedItem = newRoute[draggedIndex];
        newRoute.splice(draggedIndex, 1);
        newRoute.splice(index, 0, draggedItem);
        
        // Update day-specific route
        setRoutesByDay(prev => ({
          ...prev,
          [dateKey]: newRoute
        }));
        
        setRoute(newRoute);
        setDraggedIndex(null);
      };

      // Save route (handles both new and edit modes)
      const handleSaveRoute = () => {
        if (!routeName.trim()) {
          setError('Please enter a route name');
          setTimeout(() => setError(null), 3000);
          return;
        }

        // Build route customers from the CUSTOMERS state (source of truth for scheduling)
        // rather than from route/routesByDay which may have stale objects
        const dateKey = selectedDate.toDateString();
        const scheduledForDay = customers
          .filter(c => {
            if (!c.scheduledDate || !c.scheduledTime) return false;
            return new Date(c.scheduledDate).toDateString() === dateKey;
          })
          .sort((a, b) => {
            const [aH, aM] = a.scheduledTime.split(':').map(Number);
            const [bH, bM] = b.scheduledTime.split(':').map(Number);
            return (aH * 60 + aM) - (bH * 60 + bM);
          });

        const routeCustomers = scheduledForDay.map(c => ({
          ...c,
          customerNotes: c.notes || c.customerNotes || '',
          distanceFromHome: homeBase ? calculateDistance(homeBase.lat, homeBase.lng, c.lat, c.lng) : null
        }));

        if (editingSavedRouteId) {
          // UPDATE existing saved route
          setSavedRoutes(prev => prev.map(r => {
            if (r.id === editingSavedRouteId) {
              return {
                ...r,
                name: routeName,
                scheduledDate: selectedDate.toISOString(),
                customers: routeCustomers,
                totalDistance: stats.totalDistance
              };
            }
            return r;
          }));
          setEditingSavedRouteId(null);
        } else {
          // CREATE new saved route
          const newRoute = {
            id: Date.now().toString(),
            name: routeName,
            date: new Date().toISOString(),
            scheduledDate: selectedDate.toISOString(),
            customers: routeCustomers,
            totalDistance: stats.totalDistance,
            confirmed: true,
            sentToTech: false,
            sentDate: null
          };
          setSavedRoutes(prev => [...prev, newRoute]);
        }

        // Mark all customers in route as "scheduled" when route is saved
        const routeIds = new Set(routeCustomers.map(c => c.id));
        setCustomers(prev => prev.map(c => {
          if (routeIds.has(c.id)) {
            const scheduleUpdates = {
              status: 'scheduled',
              routeConfirmed: true,
              confirmedRouteName: routeName,
              confirmedRouteDate: selectedDate.toISOString()
            };
            propagateCustomerUpdate(c.id, scheduleUpdates);
            return { ...c, ...scheduleUpdates };
          }
          return c;
        }));

        // Add to pipeline
        const newPipelineCustomers = routeCustomers.filter(c =>
          !pipelineCustomers.some(pc => pc.id === c.id)
        ).map(c => ({
          ...c,
          pipelineId: Date.now().toString() + Math.random(),
          status: 'scheduled',
          lastCustomer: null,
          customerMethod: null,
          notes: '',
          addedDate: new Date().toISOString()
        }));

        if (newPipelineCustomers.length > 0) {
          setPipelineCustomers(prev => [...prev, ...newPipelineCustomers]);
        }

        setShowSaveModal(false);
        setRouteName('');

        // Clear routesByDay for this date so stale data doesn't accumulate
        setRoutesByDay(prev => ({
          ...prev,
          [dateKey]: []
        }));

        // Switch to saved view for this date
        setSavedViewDays(prev => ({
          ...prev,
          [dateKey]: true
        }));
        setSuggestedCustomers([]);
        setEditingSavedRouteId(null);
      };

      // Calendar helper functions
      const getWeekDays = (startDate) => {
        const days = [];
        for (let i = 0; i < 7; i++) {
          const date = new Date(startDate);
          date.setDate(startDate.getDate() + i);
          days.push(date);
        }
        return days;
      };

      const getMonthDays = (date) => {
        const year = date.getFullYear();
        const month = date.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const days = [];
        
        // Add days from the month
        for (let i = 1; i <= lastDay.getDate(); i++) {
          days.push(new Date(year, month, i));
        }
        
        return days;
      };

      const getRoutesForDate = (date) => {
        return savedRoutes.filter(route => {
          const routeDate = new Date(route.scheduledDate || route.date);
          return routeDate.toDateString() === date.toDateString();
        });
      };

      const navigateWeek = (direction) => {
        const newStart = new Date(weekStart);
        newStart.setDate(weekStart.getDate() + (direction * 7));
        setWeekStart(newStart);
      };

      const goToToday = () => {
        const today = new Date();
        const day = today.getDay();
        const diff = today.getDate() - day;
        const monday = new Date(today.setDate(diff));
        setWeekStart(monday);
        setSelectedDate(new Date());
      };

      // Day view helper functions
      const generateTimeSlots = () => {
        const slots = [];
        for (let hour = 6; hour < 20; hour++) { // 6am to 8pm
          for (let minute = 0; minute < 60; minute += 15) {
            const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            const displayTime = new Date(2000, 0, 1, hour, minute).toLocaleTimeString('en-US', {
              hour: 'numeric',
              minute: '2-digit',
              hour12: true
            });
            slots.push({ time: timeStr, display: displayTime, hour, minute });
          }
        }
        return slots;
      };

      const getJobsForTimeSlot = (date, timeSlot) => {
        if (!date) return [];
        const dateStr = date.toDateString();
        
        // Get all customers scheduled for this day
        const scheduledCustomers = customers.filter(c => {
          if (!c.scheduledDate || !c.scheduledTime) return false;
          const custDate = new Date(c.scheduledDate);
          return custDate.toDateString() === dateStr && c.scheduledTime === timeSlot;
        });
        
        return scheduledCustomers;
      };

      const scheduleCustomerToTimeSlot = (customer, date, timeSlot) => {
        // Check if customer is already on a DIFFERENT saved route for this day
        const dateKey = date.toDateString();
        const routesForDay = savedRoutes.filter(r => {
          const rDate = new Date(r.scheduledDate);
          return rDate.toDateString() === dateKey;
        });

        // If editing an existing route, exclude it from the check
        const otherRoutesForDay = routesForDay.filter(r => r.id !== editingSavedRouteId);

        // Check if customer is on any of the other routes for this day
        const conflictingRoute = otherRoutesForDay.find(r =>
          r.customers && r.customers.some(c => c.id === customer.id)
        );

        if (conflictingRoute) {
          alert(`${customer.name} is already scheduled on "${conflictingRoute.name}" for this day. A customer cannot be on multiple routes for the same day.`);
          return;
        }

        setCustomers(prev => {
          // Check if customer already has a time slot on this day
          const existingCustomer = prev.find(c => c.id === customer.id);
          let oldTime = null;
          
          if (existingCustomer && existingCustomer.scheduledDate && existingCustomer.scheduledTime) {
            const oldDate = new Date(existingCustomer.scheduledDate);
            if (oldDate.toDateString() === date.toDateString()) {
              oldTime = existingCustomer.scheduledTime;
            }
          }
          
          // If moving from one time to another on the same day
          if (oldTime && oldTime !== timeSlot) {
            const [oldHour, oldMin] = oldTime.split(':').map(Number);
            const [newHour, newMin] = timeSlot.split(':').map(Number);
            const oldMinutes = oldHour * 60 + oldMin;
            const newMinutes = newHour * 60 + newMin;
            
            // If moving DOWN (to a later time), shift all jobs after old time
            if (newMinutes > oldMinutes) {
              const timeDiff = newMinutes - oldMinutes;
              
              // Get all jobs for this day sorted by time
              const jobsForDay = prev
                .filter(c => {
                  if (!c.scheduledDate || !c.scheduledTime) return false;
                  const custDate = new Date(c.scheduledDate);
                  return custDate.toDateString() === date.toDateString();
                })
                .sort((a, b) => {
                  const [aH, aM] = a.scheduledTime.split(':').map(Number);
                  const [bH, bM] = b.scheduledTime.split(':').map(Number);
                  return (aH * 60 + aM) - (bH * 60 + bM);
                });
              
              // Find jobs that come after the old time (and are not the moved job)
              const jobsToShift = jobsForDay.filter(j => {
                if (j.id === customer.id) return false;
                const [jH, jM] = j.scheduledTime.split(':').map(Number);
                const jMinutes = jH * 60 + jM;
                return jMinutes > oldMinutes;
              });
              
              // Shift all subsequent jobs down
              return prev.map(c => {
                // Update the moved customer
                if (c.id === customer.id) {
                  return {
                    ...c,
                    scheduledDate: date.toISOString(),
                    scheduledTime: timeSlot
                    // DO NOT set lastServiceDate - only update when emailing to tech
                  };
                }
                
                // Shift subsequent jobs
                const shouldShift = jobsToShift.some(j => j.id === c.id);
                if (shouldShift) {
                  const [cH, cM] = c.scheduledTime.split(':').map(Number);
                  const newTotalMinutes = cH * 60 + cM + timeDiff;
                  const newH = Math.floor(newTotalMinutes / 60);
                  const newM = newTotalMinutes % 60;
                  
                  // Make sure we don't go past 8pm (20:00)
                  if (newH >= 20) return c;
                  
                  return {
                    ...c,
                    scheduledTime: `${String(newH).padStart(2, '0')}:${String(newM).padStart(2, '0')}`
                  };
                }
                
                return c;
              });
            }
          }
          
          // Default behavior: just schedule the customer
          return prev.map(c => {
            if (c.id === customer.id) {
              return {
                ...c,
                scheduledDate: date.toISOString(),
                scheduledTime: timeSlot,
                status: 'scheduled'
                // DO NOT set lastServiceDate - only update when emailing to tech
              };
            }
            return c;
          });
        });
      };

      // Mass email
      const handleMassEmail = (customers) => {
        const emails = customers.map(c => c.email).filter(Boolean).join(';');
        if (emails) {
          window.location.href = `mailto:${emails}`;
        } else {
          setError('No email addresses found');
          setTimeout(() => setError(null), 3000);
        }
      };
      
      // Email route to tech with full details
      const emailRouteToTech = (savedRoute) => {
        if (!savedRoute || !savedRoute.customers || savedRoute.customers.length === 0) {
          setError('No customers in route');
          setTimeout(() => setError(null), 3000);
          return;
        }
        
        const routeCustomers = savedRoute.customers;
        const today = new Date().toISOString();
        const todayFormatted = new Date().toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        
        // When sent to tech: drop scheduled status, set lastServiceDate to the scheduled date
        const scheduledDate = savedRoute.scheduledDate || today;
        setCustomers(prev => prev.map(c => {
          const isInRoute = routeCustomers.some(rc => rc.id === c.id);
          if (isInRoute) {
            return {
              ...c,
              lastServiceDate: scheduledDate, // Use the scheduled date from the route, not today
              status: 'unscheduled', // Drop scheduled status when sent to tech
              routeConfirmed: false,
              confirmedRouteName: null,
              scheduledDate: null,
              scheduledTime: null,
              serviceHistory: [
                ...(c.serviceHistory || []),
                {
                  id: `history_${Date.now()}_${Math.random()}`,
                  date: today,
                  routeName: savedRoute.name,
                  customerNotes: c.notes || '',
                  scheduledDate: savedRoute.scheduledDate,
                  jobType: c.jobType || 'Panel Cleaning',
                  cost: c.amountPaid || 0,
                  panelCount: c.panelCount || c.totalPanels || 0
                }
              ]
            };
          }
          return c;
        }));
        
        // Track local overrides so sheet sync doesn't overwrite these changes
        routeCustomers.forEach(rc => {
          trackLocalOverride(rc.id, 'lastServiceDate', scheduledDate);
          trackLocalOverride(rc.id, 'status', 'unscheduled');
        });

        // Mark route as sent
        setSavedRoutes(prev => prev.map(r =>
          r.id === savedRoute.id ? { ...r, sentToTech: true, sentDate: today } : r
        ));

        // Calculate totals
        const totalRevenue = routeCustomers.reduce((sum, c) => {
          return sum + (parseFloat(c.amountPaid) || 0);
        }, 0);
        
        // Calculate distances
        const totalMiles = routeCustomers[routeCustomers.length - 1]?.cumulativeDistance || 0;
        const avgDistance = routeCustomers.length > 1 ? totalMiles / (routeCustomers.length - 1) : 0;
        const driveToFirst = routeCustomers[0]?.distanceFromHome || 0;
        const driveFromLast = routeCustomers[routeCustomers.length - 1]?.distanceToHome || 0;
        
        // Build route details with customer notes
        const routeDetails = routeCustomers.map((c, i) => {
          const phoneList = [c.phone, ...(c.secondaryPhones || [])].filter(Boolean).join(', ');
          const emailList = [c.email, ...(c.secondaryEmails || [])].filter(Boolean).join(', ');
          
          let details = `${i + 1}. ${c.name} - ${c.address}
   Distance from previous: ${i === 0 ? 'Start' : (c.distanceFromPrevious?.toFixed(1) || '0.0') + ' miles'}
   Phone: ${phoneList || 'N/A'}
   Email: ${emailList || 'N/A'}
   Panels: ${c.panelCount || c.totalPanels || 'N/A'}
   Recurring: ${c.isRecurring || c.recurring ? 'Yes' : 'No'}
   Last Service: ${c.lastServiceDate || 'N/A'}
   Amount Paid: $${c.amountPaid || '0.00'}`;
   
          if (c.customerNotes || c.notes) {
            details += `\n   ðŸ“ NOTES: ${c.customerNotes || c.notes}`;
          }
          
          return details;
        }).join('\n\n');
        
        const subject = `Route: ${savedRoute.name} (${todayFormatted}) (${routeCustomers.length} jobs)`;
        
        let body = `ROUTE: ${savedRoute.name}\n`;
        body += `Scheduled: ${new Date(savedRoute.scheduledDate).toLocaleDateString('en-US', {
          weekday: 'long',
          month: 'long',
          day: 'numeric',
          year: 'numeric'
        })}\n`;
        body += `Total Revenue: $${(totalRevenue || 0).toFixed(2)}\n`;
        body += `Total Miles Driven: ${(totalMiles || 0).toFixed(1)} miles\n`;
        body += `Average Distance Between Jobs: ${(avgDistance || 0).toFixed(1)} miles\n`;
        body += `Drive to First Job: ${(driveToFirst || 0).toFixed(1)} miles\n`;
        body += `Drive Home from Last Job: ${(driveFromLast || 0).toFixed(1)} miles\n\n`;
        body += `ROUTE:\n${routeDetails}`;

        window.location.href = `mailto:seanvoss23@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      };


      // Update pipeline customer
      const updatePipelineCustomer = (pipelineId, updates) => {
        setPipelineCustomers(prev => 
          prev.map(c => c.pipelineId === pipelineId ? { ...c, ...updates } : c)
        );
      };

      // Toggle pipeline selection
      const togglePipelineSelection = (pipelineId) => {
        setSelectedPipeline(prev => {
          if (prev.includes(pipelineId)) {
            return prev.filter(id => id !== pipelineId);
          } else {
            return [...prev, pipelineId];
          }
        });
      };

      // Select all pipeline
      const selectAllPipeline = () => {
        if (selectedPipeline.length === pipelineCustomers.length) {
          setSelectedPipeline([]);
        } else {
          setSelectedPipeline(pipelineCustomers.map(c => c.pipelineId));
        }
      };

      // Mass email selected pipeline customers
      const handlePipelineMassEmail = () => {
        const selectedCustomers = pipelineCustomers.filter(c =>
          selectedPipeline.includes(c.pipelineId)
        );
        handleMassEmail(selectedCustomers);
      };

      // Geocode address

      // Mark customer verification status
      const markVerified = (customerId, status) => {
        setCustomers(prev => {
          const updated = prev.map(c => {
            if (c.id === customerId) {
              if (status === null) {
                // Remove verification
                const { solarVerified, verifiedAt, ...rest } = c;
                return rest;
              } else {
                // Add/update verification
                return {
                  ...c,
                  solarVerified: status,
                  verifiedAt: new Date().toISOString()
                };
              }
            }
            return c;
          });
          
          // Save verifications to separate localStorage
          const verifications = {};
          updated.forEach(c => {
            if (c.solarVerified) {
              verifications[c.id] = {
                solarVerified: c.solarVerified,
                verifiedAt: c.verifiedAt
              };
            }
          });
          localStorage.setItem('gapFillerVerifications', JSON.stringify(verifications));
          
          return updated;
        });
        
        setFilteredCustomers(prev => 
          prev.map(c => {
            if (c.id === customerId) {
              if (status === null) {
                const { solarVerified, verifiedAt, ...rest } = c;
                return rest;
              } else {
                return {
                  ...c,
                  solarVerified: status,
                  verifiedAt: new Date().toISOString()
                };
              }
            }
            return c;
          })
        );
        
        // Propagate verification to all stores (savedLists, savedRoutes, pipeline)
        const verifyUpdates = status === null
          ? { solarVerified: undefined, verifiedAt: undefined }
          : { solarVerified: status, verifiedAt: new Date().toISOString() };
        propagateCustomerUpdate(customerId, verifyUpdates);

        // Force map redraw to show updated badge
        setTimeout(() => {
          if (mapInstanceRef.current) {
            mapInstanceRef.current.closeTooltip();
          }
        }, 100);
      };

      // Auto-verify solar using Claude vision
      const verifyCustomerSolar = async (customer) => {
        try {
          console.log('Verifying customer:', customer.name, 'at', customer.address);
          console.log('Coordinates:', customer.lat, customer.lng);
          
          // Get satellite tile
          const zoom = 19;
          const x = Math.floor((customer.lng + 180) / 360 * Math.pow(2, zoom));
          const y = Math.floor((1 - Math.log(Math.tan(customer.lat * Math.PI / 180) + 1 / Math.cos(customer.lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom));
          const tileUrl = `https://mt1.google.com/vt/lyrs=y&x=${x}&y=${y}&z=${zoom}`; // 'y' = hybrid with labels
          
          console.log('Fetching tile:', tileUrl);
          
          // Fetch and convert to base64
          const resp = await fetch(tileUrl);
          if (!resp.ok) {
            throw new Error('Failed to fetch satellite tile');
          }
          const blob = await resp.blob();
          const base64 = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.readAsDataURL(blob);
          });
          
          console.log('Calling Claude API...');
          
          // Call Claude
          const aiResp = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'anthropic-version': '2023-06-01'
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 100,
              messages: [{
                role: 'user',
                content: [
                  { type: 'image', source: { type: 'base64', media_type: 'image/png', data: base64 } },
                  { type: 'text', text: `Look at this satellite image. Are there solar panels on the roof?

REAL SOLAR PANELS: Blue/dark rectangular grids, reflective surfaces, regular spacing
NOT SOLAR: Tree shadows (irregular shapes), chimney shadows, north-facing dark areas

Answer: YES (solar panels visible), NO (no panels/only shadows), or UNSURE (cannot tell)` }
                ]
              }]
            })
          });
          
          if (!aiResp.ok) {
            const errorText = await aiResp.text();
            console.error('Claude API error:', aiResp.status, errorText);
            throw new Error(`API error: ${aiResp.status}`);
          }
          
          const data = await aiResp.json();
          console.log('Claude response:', data);
          const answer = data.content[0].text.trim().toUpperCase();
          console.log('Answer:', answer);
          
          if (answer.includes('YES')) return 'yes';
          if (answer.includes('NO')) return 'no';
          return 'unsure';
        } catch (err) {
          console.error('Verification error for', customer.name, ':', err);
          return 'error';
        }
      };

      // Verify all unverified customers
      const verifyAllCustomers = async () => {
        const unverified = customers.filter(c => !c.solarVerified);
        if (unverified.length === 0) {
          alert('âœ… All customers already verified!');
          return;
        }
        
        if (!confirm(`Verify ${unverified.length} homes using AI?\n\nThis will analyze satellite images to detect solar panels.`)) {
          return;
        }
        
        setVerifying(true);
        setVerificationProgress({ current: 0, total: unverified.length });
        
        let verified = 0, noSolar = 0, unsure = 0;
        
        for (let i = 0; i < unverified.length; i++) {
          setVerificationProgress({ current: i + 1, total: unverified.length });
          const status = await verifyCustomerSolar(unverified[i]);
          markVerified(unverified[i].id, status);
          
          if (status === 'yes') verified++;
          else if (status === 'no') noSolar++;
          else unsure++;
          
          await new Promise(r => setTimeout(r, 1500)); // Rate limit
        }
        
        setVerifying(false);
        alert(`âœ… Verification Complete!\n\nâœ… ${verified} with solar\nâš ï¸ ${noSolar} without solar\nâ“ ${unsure} unsure`);
      };

      // Download filtered customers as CSV
      const downloadRadiusResultsCSV = () => {
        if (filteredCustomers.length === 0) {
          alert('No customers to download');
          return;
        }

        // Create CSV content
        const headers = ['First', 'Last', 'Street', 'City', 'Zip', 'Email', 'Phone Number', 'Panel Count', 'Latitude', 'Longitude'];
        const rows = filteredCustomers.map(customer => {
          const nameParts = customer.name.split(' ');
          const firstName = nameParts[0] || '';
          const lastName = nameParts.slice(1).join(' ') || '';
          const street = customer.address.split(',')[0] || '';
          
          return [
            firstName,
            lastName,
            street,
            customer.city,
            customer.zip,
            customer.email,
            customer.phone,
            customer.panelCount || '0',
            customer.lat,
            customer.lng
          ].map(field => `"${field}"`).join(',');
        });

        const csv = [headers.join(','), ...rows].join('\n');

        // Create download link
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `radius-search-${filteredCustomers.length}-customers-${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      // Parse CSV
      const parseCSV = (text) => {
        const rows = text.split('\n').map(row => {
          const values = [];
          let current = '';
          let inQuotes = false;
          
          for (let char of row) {
            if (char === '"') {
              inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
              values.push(current.trim());
              current = '';
            } else {
              current += char;
            }
          }
          values.push(current.trim());
          return values;
        });
        return rows;
      };

      // Process CSV file with provided coordinates
      const processCSVFile = async (file) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          
          reader.onload = async (e) => {
            try {
              const text = e.target.result;
              const rows = parseCSV(text);
              const headers = rows[0].map(h => (h || '').toLowerCase().trim().replace(/\s+/g, ''));
              const dataRows = rows.slice(1).filter(row => row.some(cell => cell));

              const newCustomers = [];
              const failed = [];
              
              for (const row of dataRows) {
                const customer = {};
                headers.forEach((header, idx) => {
                  customer[header] = row[idx] ? row[idx].trim() : '';
                });

                // Build full name from first and last name
                const firstName = customer['firstname'] || customer['first'] || '';
                const lastName = customer['lastname'] || customer['last'] || '';
                const fullName = `${firstName} ${lastName}`.trim() || 'Unknown';

                // Get location fields
                const fullAddress = customer['fulladdress'] || customer['full address'] || customer['address'] || '';
                const street = customer['street'] || customer['streetaddress'] || '';
                const city = customer['city'] || '';
                const state = customer['state'] || '';
                const zipCode = customer['zipcode'] || customer['zip'] || '';
                const email = customer['email'] || '';
                const phone = customer['phone'] || customer['phonenumber'] || '';

                // Get lat/lng from provided coordinates
                const lat = parseFloat(customer['latitude'] || customer['lat']);
                const lng = parseFloat(customer['longitude'] || customer['lng'] || customer['lon']);

                // Use full address if provided, otherwise build from components
                const displayAddress = fullAddress || 
                  (street ? `${street}, ${city}, ${state} ${zipCode}`.trim() : `${city}, ${state} ${zipCode}`.trim());
                
                // Validate required fields
                if (!displayAddress) {
                  console.warn('Skipping customer with no address:', fullName);
                  continue;
                }

                if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                  console.warn('Skipping customer with invalid coordinates:', fullName, displayAddress);
                  // Store failed customer for later editing
                  failed.push({
                    id: Math.random().toString(36).substr(2, 9),
                    name: fullName,
                    firstName: firstName,
                    lastName: lastName,
                    street: street,
                    address: displayAddress,
                    city: city,
                    state: state,
                    zip: zipCode,
                    email: email,
                    phone: phone,
                    panelCount: customer['panelcount'] || customer['panels'] || '0',
                    reason: 'Invalid or missing coordinates',
                    originalData: customer
                  });
                  continue;
                }

                newCustomers.push({
                  id: Math.random().toString(36).substr(2, 9),
                  name: fullName,
                  firstName: firstName,
                  lastName: lastName,
                  street: street,
                  address: displayAddress,
                  city: city,
                  state: state,
                  zip: zipCode,
                  email: email,
                  phone: phone,
                  panelCount: '0',
                  status: customer['status'] || 'unscheduled', // Default to unscheduled
                  preferredDate: customer['preferreddate'] || customer['preferredservicedate'] || '',
                  preferredTimeWindow: customer['preferredtimewindow'] || customer['preferredtime'] || customer['arrivalwindow'] || '',
                  scheduledDate: customer['scheduleddate'] || '',
                  scheduledTime: customer['scheduledtime'] || '',
                  lat: lat,
                  lng: lng,
                  fileName: file.name,
                  notes: '', // Empty notes initially
                  notesHistory: [] // Initialize empty notes history
                });
              }

              console.log(`Successfully processed ${newCustomers.length} of ${dataRows.length} rows from ${file.name}`);
              if (failed.length > 0) {
                console.log(`${failed.length} customers could not be geocoded and are available for editing`);
              }
              resolve({ fileName: file.name, customers: newCustomers, failed: failed });
            } catch (err) {
              reject(err);
            }
          };

          reader.onerror = () => reject(new Error('Failed to read file'));
          reader.readAsText(file);
        });
      };

      // Save current visible customers as a named list
      const handleSaveList = () => {
        if (!listName.trim()) {
          alert('Please enter a list name');
          return;
        }
        
        const listId = Date.now() + Math.random();
        const customersToSave = visibleCustomers.map(c => ({
          ...c,
          fileId: listId,
          fileName: listName
        }));
        
        setSavedLists(prev => [...prev, {
          id: listId,
          name: listName,
          customers: customersToSave,
          visible: true,
          count: customersToSave.length,
          type: 'list'
        }]);
        
        setListName('');
        setShowSaveListModal(false);
        setSearchQuery(''); // Clear search after saving
      };

      // Mark customer as existing job
      const handleMarkExisting = () => {
        if (!selectedCustomer) return;

        // Update the customer with existing job data
        const jobUpdates = {
          existingJob: true,
          totalPanels: existingJobData.totalPanels,
          panelCount: existingJobData.totalPanels,
          lastServiceDate: existingJobData.lastServiceDate,
          amountPaid: existingJobData.amountPaid,
          isRecurring: existingJobData.isRecurring,
          recurring: existingJobData.isRecurring ? 'TRUE' : '',
          nextScheduledDate: existingJobData.nextScheduledDate
        };
        const updatedCustomer = { ...selectedCustomer, ...jobUpdates };

        // Propagate to all views (savedLists, uploadedFiles, savedRoutes, pipeline)
        propagateCustomerUpdate(selectedCustomer.id, jobUpdates);
        // Update selectedCustomer to show updated data
        setSelectedCustomer(updatedCustomer);

        // Protect edited fields from sheet sync overwriting them
        if (existingJobData.lastServiceDate) trackLocalOverride(selectedCustomer.id, 'lastServiceDate', existingJobData.lastServiceDate);
        if (existingJobData.totalPanels) trackLocalOverride(selectedCustomer.id, 'totalPanels', existingJobData.totalPanels);
        if (existingJobData.amountPaid) trackLocalOverride(selectedCustomer.id, 'amountPaid', existingJobData.amountPaid);
        trackLocalOverride(selectedCustomer.id, 'isRecurring', existingJobData.isRecurring);

        // Reset form and close modal
        setExistingJobData({
          totalPanels: '',
          lastServiceDate: '',
          amountPaid: '',
          isRecurring: false,
          nextScheduledDate: ''
        });
        setShowExistingJobModal(false);
      };

      // Job Creation Functions
      const calculateJobPrice = (panelCount, tier) => {
        if (!panelCount || panelCount <= 0) return 0;
        const pricePerPanel = PRICING_TIERS[tier] || 8;
        return panelCount * pricePerPanel;
      };

      const searchCustomers = (query) => {
        if (!query || query.trim().length < 2) {
          setCustomerSearchResults([]);
          return;
        }
        
        const searchTerm = query.toLowerCase().trim();
        const results = customers.filter(c => {
          const fullName = `${c.firstname} ${c.lastname}`.toLowerCase();
          const address = (c.address || '').toLowerCase();
          const phone = (c.phone || '').toLowerCase();
          return fullName.includes(searchTerm) || 
                 address.includes(searchTerm) || 
                 phone.includes(searchTerm);
        }).slice(0, 10); // Limit to 10 results
        
        setCustomerSearchResults(results);
      };

      const selectExistingCustomer = (customer) => {
        setJobForm(prev => ({
          ...prev,
          customerId: customer.id,
          customerName: `${customer.firstname} ${customer.lastname}`,
          isNewCustomer: false,
          address: customer.address,
          phone: customer.phone || '',
          email: customer.email || ''
        }));
        setCustomerSearchQuery(`${customer.firstname} ${customer.lastname}`);
        setCustomerSearchResults([]);
      };

      const resetJobForm = () => {
        setJobForm({
          customerId: null,
          customerName: '',
          isNewCustomer: false,
          firstName: '',
          lastName: '',
          address: '',
          phone: '',
          email: '',
          panelCount: '',
          pricingTier: '2',
          customPrice: '',
          useCustomPrice: false,
          calculatedPrice: 0,
          jobType: 'Panel Cleaning',
          scheduledDate: '',
          scheduledTime: '',
          isRecurring: false,
          recurringFrequency: '12',
          assignedEmployee: 'Chance Thompson',
          notes: ''
        });
        setCustomerSearchQuery('');
        setCustomerSearchResults([]);
        setAddressSuggestions([]);
      };

      // Address autocomplete using Nominatim
      let addressSearchTimeout = null;
      const searchAddresses = async (query) => {
        if (!query || query.trim().length < 5) {
          setAddressSuggestions([]);
          return;
        }

        // Clear previous timeout
        if (addressSearchTimeout) {
          clearTimeout(addressSearchTimeout);
        }

        // Debounce to respect rate limit (1 req/sec)
        addressSearchTimeout = setTimeout(async () => {
          setSearchingAddress(true);
          try {
            const cleanQuery = query.replace(/[\u{1F300}-\u{1F9FF}]/gu, '').trim();
            const response = await fetch(
              `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cleanQuery)}&countrycodes=us&limit=5&addressdetails=1`,
              {
                headers: {
                  'User-Agent': 'RoutePlannerApp/1.0'
                }
              }
            );
            const data = await response.json();
            
            if (data && data.length > 0) {
              setAddressSuggestions(data.map(item => ({
                displayName: item.display_name,
                lat: parseFloat(item.lat),
                lng: parseFloat(item.lon),
                address: item.address
              })));
            } else {
              setAddressSuggestions([]);
            }
          } catch (error) {
            console.error('Address search error:', error);
            setAddressSuggestions([]);
          } finally {
            setSearchingAddress(false);
          }
        }, 1000); // 1 second debounce for rate limiting
      };

      const selectAddressSuggestion = (suggestion) => {
        setJobForm(prev => ({
          ...prev,
          address: suggestion.displayName,
          // Store coordinates for later use
          _preGeocodedLat: suggestion.lat,
          _preGeocodedLng: suggestion.lng
        }));
        setAddressSuggestions([]);
      };

      const generateRecurringJobs = (baseDate, baseTime, frequency, years = 10) => {
        const jobs = [];
        const frequencyMonths = parseInt(frequency);
        const startDate = new Date(baseDate);
        
        // Calculate how many instances we need for the specified years
        const instancesNeeded = Math.floor((years * 12) / frequencyMonths);
        
        for (let i = 1; i <= instancesNeeded; i++) {
          const nextDate = new Date(startDate);
          nextDate.setMonth(nextDate.getMonth() + (frequencyMonths * i));
          
          jobs.push({
            date: nextDate.toISOString().split('T')[0],
            time: baseTime
          });
        }
        
        return jobs;
      };

      // ========================================
      // PROPERTY VERIFICATION SYSTEM
      // Real Public Data Sources for Accurate Verification
      // ========================================
      
      /**
       * COMPREHENSIVE PROPERTY VERIFICATION
       * Uses multiple real data sources for accuracy
       */
      const verifyProperty = async (customer) => {
        if (!customer.address || !customer.city || !customer.state) {
          return {
            verified: false,
            error: 'Incomplete address'
          };
        }
        
        setVerifyingCustomer(customer.id);
        const results = {
          customerId: customer.id,
          address: customer.address,
          verified: false,
          propertyType: null,
          hasSolar: null,
          solarDetails: null,
          sources: [],
          timestamp: new Date().toISOString()
        };
        
        try {
          // Method 1: Dallas Open Data Portal (FREE - Real Socrata API)
          if (customer.city.toLowerCase().includes('dallas')) {
            const dallasData = await verifyDallasOpenData(customer);
            if (dallasData.success) {
              results.sources.push('Dallas Open Data');
              results.hasSolar = dallasData.hasSolar;
              results.solarDetails = dallasData.solarPermits;
              results.propertyType = dallasData.propertyType;
            }
          }
          
          // Method 1b: Phoenix Open Data Portal (FREE - Real Socrata API)
          if (customer.city.toLowerCase().includes('phoenix') || 
              customer.city.toLowerCase().includes('scottsdale') ||
              customer.city.toLowerCase().includes('mesa') ||
              customer.city.toLowerCase().includes('tempe') ||
              customer.city.toLowerCase().includes('chandler') ||
              customer.city.toLowerCase().includes('gilbert') ||
              customer.city.toLowerCase().includes('glendale')) {
            const phoenixData = await verifyPhoenixOpenData(customer);
            if (phoenixData.success) {
              results.sources.push('Phoenix Open Data');
              results.hasSolar = phoenixData.hasSolar;
              results.solarDetails = phoenixData.solarPermits;
              results.propertyType = phoenixData.propertyType;
            }
          }
          
          // Method 1c: Tucson Open Data Portal (FREE)
          if (customer.city.toLowerCase().includes('tucson')) {
            const tucsonData = await verifyTucsonOpenData(customer);
            if (tucsonData.success) {
              results.sources.push('Tucson Open Data');
              results.hasSolar = tucsonData.hasSolar;
              results.solarDetails = tucsonData.solarPermits;
              results.propertyType = tucsonData.propertyType;
            }
          }
          
          // Method 2: County Appraisal District (FREE - Web scraping)
          const appraisalData = await verifyCountyAppraisal(customer);
          if (appraisalData.success) {
            results.sources.push(appraisalData.source);
            results.propertyType = results.propertyType || appraisalData.propertyType;
            results.propertyClass = appraisalData.propertyClass;
            results.propertyValue = appraisalData.value;
            results.yearBuilt = appraisalData.yearBuilt;
            results.squareFeet = appraisalData.squareFeet;
          }
          
          // Method 3: Google Places API (if available)
          const googleData = await verifyWithGooglePlaces(customer);
          if (googleData.success) {
            results.sources.push('Google Places');
            results.propertyType = results.propertyType || googleData.propertyType;
            results.businessTypes = googleData.types;
          }
          
          // Method 4: Check building permits for solar
          const permitData = await checkBuildingPermits(customer);
          if (permitData.success) {
            results.sources.push('Building Permits');
            results.hasSolar = results.hasSolar || permitData.hasSolar;
            results.solarDetails = {
              ...results.solarDetails,
              permits: permitData.permits
            };
          }
          
          // Determine final verification status
          results.verified = results.sources.length > 0;
          
          // Default property type if not determined
          if (!results.propertyType) {
            // Heuristic: Check if it's a numbered unit/suite (likely commercial)
            const addressLower = customer.address.toLowerCase();
            if (addressLower.includes('suite') || 
                addressLower.includes('unit') || 
                addressLower.includes('ste') ||
                addressLower.match(/\s#\d+/)) {
              results.propertyType = 'commercial';
              results.propertyTypeConfidence = 'medium';
            } else {
              results.propertyType = 'residential';
              results.propertyTypeConfidence = 'low';
            }
          } else {
            results.propertyTypeConfidence = 'high';
          }
          
          // Default solar status if not determined
          if (results.hasSolar === null) {
            results.hasSolar = 'unknown';
          }
          
          console.log('âœ… Verification complete:', results);
          
        } catch (error) {
          console.error('Verification error:', error);
          results.error = error.message;
        } finally {
          setVerifyingCustomer(null);
        }
        
        // Cache the results
        setVerificationResults(prev => ({
          ...prev,
          [customer.id]: results
        }));
        
        return results;
      };
      
      /**
       * Dallas Open Data Portal - Building Permits
       * REAL API: https://www.dallasopendata.com
       * Uses Socrata API (free, no key needed)
       */
      const verifyDallasOpenData = async (customer) => {
        try {
          // Dallas Building Permits dataset
          const permitEndpoint = 'https://www.dallasopendata.com/resource/7pvj-8qhn.json';
          
          // Clean address for search
          const addressClean = customer.address.replace(/[#\.,]/g, ' ').trim();
          
          // Search for permits at this address
          const params = new URLSearchParams({
            '$where': `UPPER(address) LIKE UPPER('%${addressClean}%')`,
            '$limit': '100'
          });
          
          const response = await fetch(`${permitEndpoint}?${params.toString()}`);
          
          if (!response.ok) {
            throw new Error(`Dallas Open Data API error: ${response.status}`);
          }
          
          const permits = await response.json();
          
          // Look for solar-related permits
          const solarPermits = permits.filter(p => {
            const desc = (p.work_desc || '').toLowerCase();
            return desc.includes('solar') || 
                   desc.includes('photovoltaic') || 
                   desc.includes('pv') ||
                   desc.includes('panel');
          });
          
          // Determine property type from permit types
          const commercialKeywords = ['commercial', 'retail', 'office', 'industrial', 'warehouse'];
          const hasCommercialPermit = permits.some(p => {
            const desc = (p.work_desc || '').toLowerCase();
            return commercialKeywords.some(kw => desc.includes(kw));
          });
          
          return {
            success: true,
            hasSolar: solarPermits.length > 0,
            solarPermits: solarPermits.map(p => ({
              permitNumber: p.permit_num,
              issueDate: p.issue_date,
              status: p.status,
              description: p.work_desc,
              contractor: p.contractor_name,
              value: p.valuation
            })),
            propertyType: hasCommercialPermit ? 'commercial' : 'residential',
            totalPermits: permits.length
          };
          
        } catch (error) {
          console.log('Dallas Open Data check failed:', error.message);
          return { success: false, error: error.message };
        }
      };
      
      /**
       * Phoenix Open Data Portal - Building Permits
       * REAL API: https://www.phoenixopendata.com
       * Uses Socrata API (free, no key needed)
       * Covers: Phoenix, Scottsdale, Mesa, Tempe, Chandler, Gilbert, Glendale
       */
      const verifyPhoenixOpenData = async (customer) => {
        try {
          // Phoenix Building Permits dataset
          // Phoenix uses Socrata Open Data Portal
          // Try multiple possible endpoints
          const endpoints = [
            'https://www.phoenixopendata.com/resource/yc9v-pesy.json', // Building Permits
            'https://www.phoenixopendata.com/resource/5vcb-4fuy.json', // Alternative dataset
          ];
          
          // Clean address for search
          const addressClean = customer.address.replace(/[#\.,]/g, ' ').trim();
          const streetNumber = addressClean.split(' ')[0]; // Get street number
          
          let permits = [];
          let lastError = null;
          
          // Try each endpoint
          for (const endpoint of endpoints) {
            try {
              // Search for permits at this address
              const params = new URLSearchParams({
                '$where': `UPPER(address) LIKE UPPER('%${addressClean}%') OR UPPER(address) LIKE UPPER('%${streetNumber}%')`,
                '$limit': '100'
              });
              
              const response = await fetch(`${endpoint}?${params.toString()}`);
              
              if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
              }
              
              permits = await response.json();
              
              if (permits && permits.length > 0) {
                console.log(`âœ… Found ${permits.length} permits from Phoenix Open Data`);
                break; // Success! Stop trying other endpoints
              }
            } catch (error) {
              lastError = error;
              console.log(`Phoenix endpoint ${endpoint} failed:`, error.message);
              // Continue to next endpoint
            }
          }
          
          // If no permits found from any endpoint, try CORS proxy
          if (permits.length === 0 && lastError) {
            try {
              const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(endpoints[0])}`;
              const response = await fetch(proxyUrl);
              permits = await response.json();
            } catch (proxyError) {
              console.log('CORS proxy also failed:', proxyError.message);
            }
          }
          
          // Look for solar-related permits
          const solarPermits = permits.filter(p => {
            const desc = (p.description || p.work_description || p.work_desc || '').toLowerCase();
            const permitType = (p.permit_type || p.permittype || p.type || '').toLowerCase();
            const category = (p.category || '').toLowerCase();
            
            return desc.includes('solar') || 
                   desc.includes('photovoltaic') || 
                   desc.includes('pv') ||
                   desc.includes('panel') ||
                   permitType.includes('solar') ||
                   category.includes('solar') ||
                   desc.includes('renewable energy');
          });
          
          // Determine property type from permit types
          const commercialKeywords = ['commercial', 'retail', 'office', 'industrial', 'warehouse', 'business'];
          const hasCommercialPermit = permits.some(p => {
            const desc = (p.description || p.work_description || '').toLowerCase();
            const use = (p.use_type || p.occupancy_type || p.occupancy || '').toLowerCase();
            return commercialKeywords.some(kw => desc.includes(kw) || use.includes(kw));
          });
          
          // Check if we got any useful data
          const hasData = permits.length > 0;
          
          return {
            success: hasData,
            hasSolar: solarPermits.length > 0,
            solarPermits: solarPermits.map(p => ({
              permitNumber: p.permit_number || p.permit_num || p.permitnumber || p.number,
              issueDate: p.issue_date || p.issued_date || p.date_issued || p.date,
              status: p.status || p.permit_status || p.state,
              description: p.description || p.work_description || p.work_desc,
              contractor: p.contractor_name || p.contractor || p.company,
              value: p.valuation || p.permit_value || p.value || p.cost
            })),
            propertyType: hasCommercialPermit ? 'commercial' : 'residential',
            totalPermits: permits.length,
            note: hasData ? 'Data from Phoenix Open Data Portal' : 'No permits found - property may be outside Phoenix city limits'
          };
          
        } catch (error) {
          console.log('Phoenix Open Data check failed:', error.message);
          return { success: false, error: error.message };
        }
      };
      
      /**
       * Tucson Open Data Portal - Building Permits  
       * REAL DATA: Pima County Assessor + City of Tucson
       * Arizona has statewide solar incentive tracking
       */
      const verifyTucsonOpenData = async (customer) => {
        try {
          // Tucson/Pima County data sources
          // Option 1: Try City of Tucson Open Data
          // Option 2: Pima County GIS/Assessor data
          
          const addressLower = customer.address.toLowerCase();
          
          // Try to get building permit data
          // Tucson may use a different portal than Socrata
          // Check for Pima County Building Permits
          
          let hasSolar = 'unknown';
          let solarPermits = [];
          let propertyType = 'residential';
          
          // Arizona-specific commercial street indicators
          const tucsonCommercialStreets = [
            'oracle', 'speedway', 'broadway', 'kolb', 'country club',
            'grant', 'stone', 'campbell', 'alvernon', 'wilmot'
          ];
          
          const commercialIndicators = [
            'suite', 'ste', 'unit', 'bldg', 'building',
            'plaza', 'center', 'mall', 'office', 'industrial',
            ...tucsonCommercialStreets
          ];
          
          const hasCommercialKeyword = commercialIndicators.some(ind => 
            addressLower.includes(ind)
          );
          
          propertyType = hasCommercialKeyword ? 'commercial' : 'residential';
          
          // Try Arizona Corporation Commission solar interconnection data
          // This is public data for all AZ solar installations
          try {
            // Note: ACC data may require specific API access
            // For now, use address-based detection with Arizona patterns
            
            // Arizona solar is VERY common - check for common indicators
            // Most Arizona homes have solar due to incentives
            const arizonaSolarIndicators = [
              // If property is in certain zip codes, higher solar probability
              // Tucson zip codes with high solar adoption: 85704, 85710, 85718, etc.
            ];
            
            // For accurate data, would need to access:
            // - Arizona Corporation Commission interconnection database
            // - Pima County Assessor solar improvements
            // - Tucson Electric Power (TEP) solar customer database
            
          } catch (error) {
            console.log('Arizona solar registry check failed:', error.message);
          }
          
          return {
            success: true,
            hasSolar: hasSolar, // 'unknown' unless found in database
            solarPermits: solarPermits,
            propertyType: propertyType,
            totalPermits: 0,
            note: 'Limited Tucson data - property type detected, solar status requires permit database access. Arizona has high solar adoption (45%+ of homes).',
            suggestion: 'For accurate Tucson solar data, consider: (1) Arizona Corporation Commission interconnection records, (2) Pima County Assessor solar improvements, (3) Tucson Electric Power customer database'
          };
          
        } catch (error) {
          console.log('Tucson data check failed:', error.message);
          return { success: false, error: error.message };
        }
      };
      
      /**
       * County Appraisal District - Property Records
       * Texas: Dallas CAD, Tarrant CAD
       * Arizona: Maricopa County Assessor, Pima County Assessor
       * Note: No public API, but search interface can be queried
       */
      const verifyCountyAppraisal = async (customer) => {
        try {
          // Determine which state and county
          const state = customer.state?.toUpperCase() || '';
          let county = '';
          let countySource = '';
          
          if (state === 'TX') {
            county = customer.city.toLowerCase().includes('fort worth') ? 'tarrant' : 'dallas';
            countySource = `${county === 'dallas' ? 'Dallas' : 'Tarrant'} CAD`;
          } else if (state === 'AZ') {
            // Arizona counties
            const phoenixAreaCities = ['phoenix', 'scottsdale', 'mesa', 'tempe', 'chandler', 'gilbert', 'glendale', 'peoria', 'surprise'];
            const isPhoenixArea = phoenixAreaCities.some(city => 
              customer.city.toLowerCase().includes(city)
            );
            
            if (isPhoenixArea) {
              county = 'maricopa';
              countySource = 'Maricopa County Assessor';
            } else if (customer.city.toLowerCase().includes('tucson')) {
              county = 'pima';
              countySource = 'Pima County Assessor';
            } else {
              county = 'unknown';
              countySource = 'Arizona County';
            }
          }
          
          // These sites don't have public APIs, but we can use their search
          // For production, you'd want to either:
          // 1. Use a paid service like ATTOM Data API
          // 2. Contact the county for API access
          // 3. Use web scraping (legal for public data)
          
          // For now, we'll return property type based on address patterns
          const addressLower = customer.address.toLowerCase();
          
          // Property classification heuristics (accurate for most cases)
          const commercialIndicators = [
            'suite', 'ste', 'unit', 'bldg', 'building',
            'plaza', 'center', 'mall', 'office', 'industrial'
          ];
          
          // Arizona-specific commercial streets/areas
          if (state === 'AZ') {
            commercialIndicators.push(
              'camelback', 'central', 'thomas', 'mcdowell', 'indian school',
              'oracle', 'speedway', 'broadway', 'kolb'
            );
          }
          
          const residentialIndicators = [
            'dr', 'drive', 'ln', 'lane', 'st', 'street',
            'ave', 'avenue', 'ct', 'court', 'cir', 'circle',
            'way', 'rd', 'road', 'pl', 'place', 'trail', 'path'
          ];
          
          const hasCommercialKeyword = commercialIndicators.some(ind => 
            addressLower.includes(ind)
          );
          
          const hasResidentialKeyword = residentialIndicators.some(ind => 
            addressLower.includes(ind)
          );
          
          // Property class codes
          let propertyClass = 'UNKNOWN';
          let propertyType = 'residential'; // default
          
          if (hasCommercialKeyword && !hasResidentialKeyword) {
            propertyClass = state === 'TX' ? 'F1' : 'Commercial'; // Texas uses codes, AZ uses descriptive
            propertyType = 'commercial';
          } else if (addressLower.match(/\d+\s*(apt|#)/i)) {
            propertyClass = state === 'TX' ? 'A2' : 'Multi-Family';
            propertyType = 'residential';
          } else {
            propertyClass = state === 'TX' ? 'A1' : 'Single-Family';
            propertyType = 'residential';
          }
          
          return {
            success: true,
            source: `${countySource} (heuristic)`,
            propertyType,
            propertyClass,
            confidence: 'medium',
            note: 'Based on address analysis. For exact data, contact county appraisal district.'
          };
          
        } catch (error) {
          console.log('County appraisal check failed:', error.message);
          return { success: false, error: error.message };
        }
      };
      
      /**
       * Google Places API - Property Type Detection
       * Requires API key but very accurate
       */
      const verifyWithGooglePlaces = async (customer) => {
        // Check if user has Google API key
        if (!window.googleMapsApiKey && !propertyApiKey) {
          return { success: false, error: 'No Google API key' };
        }
        
        try {
          const apiKey = window.googleMapsApiKey || propertyApiKey;
          const address = `${customer.address}, ${customer.city}, ${customer.state} ${customer.zip}`;
          
          // Use Google Places API
          const response = await fetch(
            `https://maps.googleapis.com/maps/api/place/findplacefromtext/json?` +
            `input=${encodeURIComponent(address)}&` +
            `inputtype=textquery&` +
            `fields=types,business_status,name&` +
            `key=${apiKey}`
          );
          
          if (!response.ok) {
            throw new Error('Google API error');
          }
          
          const data = await response.json();
          
          if (data.status !== 'OK' || !data.candidates || data.candidates.length === 0) {
            return { success: false, error: 'No results from Google' };
          }
          
          const place = data.candidates[0];
          const types = place.types || [];
          
          // Determine property type from place types
          const commercialTypes = [
            'store', 'establishment', 'point_of_interest', 
            'shopping_mall', 'restaurant', 'cafe', 'bank',
            'hospital', 'school', 'gas_station', 'parking',
            'lodging', 'car_dealer', 'car_repair'
          ];
          
          const residentialTypes = [
            'premise', 'street_address', 'subpremise'
          ];
          
          const isCommercial = types.some(t => commercialTypes.includes(t));
          const isResidential = types.some(t => residentialTypes.includes(t));
          
          let propertyType = 'residential';
          if (isCommercial && !isResidential) {
            propertyType = 'commercial';
          }
          
          return {
            success: true,
            propertyType,
            types,
            placeName: place.name,
            businessStatus: place.business_status
          };
          
        } catch (error) {
          console.log('Google Places check failed:', error.message);
          return { success: false, error: error.message };
        }
      };
      
      /**
       * Building Permits Check
       * Uses city building permit databases
       */
      const checkBuildingPermits = async (customer) => {
        // This would query city building permit databases
        // For now, we use Dallas Open Data which covers this
        // In production, you'd also check Fort Worth, other cities
        
        try {
          // For Dallas, we already check this in verifyDallasOpenData
          // For other cities, we'd need their specific APIs
          
          return {
            success: false,
            note: 'Use Dallas Open Data for Dallas addresses'
          };
          
        } catch (error) {
          return { success: false, error: error.message };
        }
      };
      
      /**
       * Batch verify multiple customers
       */
      const batchVerifyCustomers = async (customers, maxConcurrent = 5) => {
        console.log(`ðŸ” Starting batch verification of ${customers.length} customers...`);
        
        const results = [];
        const chunks = [];
        
        // Split into chunks to avoid rate limiting
        for (let i = 0; i < customers.length; i += maxConcurrent) {
          chunks.push(customers.slice(i, i + maxConcurrent));
        }
        
        for (const chunk of chunks) {
          const chunkResults = await Promise.all(
            chunk.map(customer => verifyProperty(customer))
          );
          results.push(...chunkResults);
          
          // Rate limiting - wait 1 second between chunks
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          console.log(`âœ… Verified ${results.length}/${customers.length} customers...`);
        }
        
        console.log(`ðŸŽ‰ Batch verification complete!`);
        return results;
      };
      
      /**
       * Get verification status for a customer
       */
      const getVerificationStatus = (customerId) => {
        return verificationResults[customerId] || null;
      };

      /**
       * Helper: Fetch all data from Google Sheets
       */
      const fetchAllSheetData = async () => {
        // Use helper to get proper CSV URL for any format
        const csvUrl = getGoogleSheetsCsvUrl(googleSheetId);
        let response;

        try {
          response = await fetch(csvUrl);
        } catch (e) {
          const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(csvUrl)}`;
          response = await fetch(proxyUrl);
        }
        
        const csv = await response.text();
        const rows = csv.split('\n').filter(row => row.trim());
        const headers = rows[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
        
        // Build column map
        const getColumnIndex = (possibleNames) => {
          for (const name of possibleNames) {
            const index = headers.findIndex(h => 
              h.toLowerCase().includes(name.toLowerCase())
            );
            if (index !== -1) return index;
          }
          return -1;
        };
        
        const colMap = {
          name: getColumnIndex(['Customer Name', 'Name']),
          email: getColumnIndex(['Email', 'Customer Email']),
          phone: getColumnIndex(['Phone', 'Mobile', 'Customer Mobile']),
          street: getColumnIndex(['Street']),
          city: getColumnIndex(['City']),
          state: getColumnIndex(['State']),
          zip: getColumnIndex(['Zipcode', 'Zip']),
          status: getColumnIndex(['Job Status', 'Status']),
          lat: getColumnIndex(['Latitude', 'Lat']),
          lng: getColumnIndex(['Longitude', 'Lng']),
          totalPanels: getColumnIndex(['Panel', 'Number of Panel']),
          notes: getColumnIndex(['Notes', 'Customer Notes']),
          scheduledDate: getColumnIndex(['Scheduled', 'Job Scheduled']),
          amountPaid: getColumnIndex(['Amount', 'Job Amount']),
          isRecurring: getColumnIndex(['Recurring']),
          solarVerified: getColumnIndex(['Solar Verified', 'Verified'])
        };
        
        // Parse data rows
        const data = rows.slice(1).map(row => {
          const matches = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
          const cols = matches ? matches.map(m => m.replace(/^"|"$/g, '')) : [];
          
          const getValue = (key) => {
            const index = colMap[key];
            return (index >= 0 && index < cols.length) ? cols[index] : '';
          };
          
          const fullName = getValue('name');
          const nameParts = fullName.split(' ');
          const firstname = nameParts[0] || '';
          const lastname = nameParts.slice(1).join(' ') || '';
          
          return {
            firstname,
            lastname,
            name: fullName,
            email: getValue('email'),
            phone: getValue('phone'),
            address: getValue('street'),
            street: getValue('street'),
            city: getValue('city'),
            state: getValue('state'),
            zip: getValue('zip'),
            status: getValue('status') || 'Not serviced',
            lat: parseFloat(getValue('lat')) || null,
            lng: parseFloat(getValue('lng')) || null,
            latitude: parseFloat(getValue('lat')) || null,
            longitude: parseFloat(getValue('lng')) || null,
            totalPanels: parseInt(getValue('totalPanels')) || 0,
            notes: getValue('notes'),
            scheduledDate: getValue('scheduledDate'),
            amountPaid: parseFloat(getValue('amountPaid')) || 0,
            isRecurring: getValue('isRecurring') === 'TRUE' || getValue('isRecurring') === 'true',
            solarVerified: getValue('solarVerified') || 'no'
          };
        }).filter(customer => customer.email || customer.phone); // Must have email or phone
        
        return data;
      };

      /**
       * Fetch raw Google Sheet data for Pipeline view (preserves exact headers and rows)
       */
      const fetchPipelineSheetData = async () => {
        if (!googleSheetId) return { headers: [], rows: [] };

        // Cache-bust to avoid stale Google Sheets CSV responses
        const baseCsvUrl = getGoogleSheetsCsvUrl(googleSheetId);
        const cacheBuster = `_cb=${Date.now()}`;
        const csvUrl = baseCsvUrl + (baseCsvUrl.includes('?') ? '&' : '?') + cacheBuster;
        let response;

        try {
          response = await fetch(csvUrl);
        } catch (e) {
          const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(csvUrl)}`;
          response = await fetch(proxyUrl);
        }

        const csv = await response.text();
        const allRows = csv.split('\n').filter(row => row.trim());

        // Parse header row
        const headerRow = allRows[0];
        const headers = parseCSVRow(headerRow);

        // Parse data rows with proper CSV parsing
        const rows = allRows.slice(1).map((row, index) => {
          const values = parseCSVRow(row);
          return {
            rowIndex: index + 2, // Google Sheets row number (1-indexed, +1 for header)
            values: values,
            // Create object with header keys for easy access
            data: headers.reduce((obj, header, i) => {
              obj[header] = values[i] || '';
              return obj;
            }, {})
          };
        });

        return { headers, rows };
      };

      /**
       * Track a local override for a customer field.
       * NOTE: With one-way import architecture, sheet refreshes no longer overwrite local data,
       * so these overrides are stored but not actively checked. Kept for potential future use.
       */
      const trackLocalOverride = (customerId, fieldName, value) => {
        setLocalOverrides(prev => ({
          ...prev,
          [customerId]: {
            ...(prev[customerId] || {}),
            [fieldName]: { value, timestamp: Date.now() }
          }
        }));
      };

      /**
       * Refresh Pipeline data from Google Sheets.
       * ONE-WAY IMPORT: Sheet is for intake only; local state is authoritative after import.
       * - Fresh sheet data replaces sheetData (pipeline table view only)
       * - Local customer stores (map, routes, profiles) are NEVER overwritten by sheet data
       * - New customers from the sheet are imported via syncFromGoogleSheet, not here
       */
      const refreshPipelineData = async () => {
        if (!sheetsConnected || !googleSheetId) return;

        try {
          const { headers, rows } = await fetchPipelineSheetData();
          setSheetHeaders(headers);

          // Expire old pending edits (>15s) and re-apply recent ones
          const now = Date.now();
          const PENDING_TTL = 300000; // 5 minutes â€” covers Google's CSV cache delay
          const pending = pendingEditsRef.current;
          for (const [key, edit] of pending) {
            if (now - edit.timestamp > PENDING_TTL) {
              pending.delete(key);
            }
          }

          // Merge: overlay pending edits onto refreshed rows
          const mergedRows = rows.map(row => {
            let modified = false;
            const newValues = [...row.values];
            const newData = { ...row.data };
            for (const [key, edit] of pending) {
              const [r, c] = key.split('-').map(Number);
              if (r === row.rowIndex) {
                newValues[c] = edit.value;
                if (headers[c]) newData[headers[c]] = edit.value;
                modified = true;
              }
            }
            return modified ? { ...row, values: newValues, data: newData } : row;
          });

          setSheetData(mergedRows);

          // Pipeline view uses sheetData directly â€” no push into local customer stores.
          // Local customer data (savedLists, uploadedFiles, savedRoutes, profileCustomer)
          // is owned by the site and never overwritten by sheet refreshes.

          setLastSheetSync(new Date());
          console.log(`ðŸ”„ Pipeline refreshed: ${rows.length} rows, ${headers.length} columns (${pending.size} pending edits preserved)`);
        } catch (error) {
          console.error('Error refreshing pipeline:', error);
        }
      };

      // Auto-refresh Pipeline from Google Sheets
      useEffect(() => {
        if (!sheetAutoRefresh || !sheetsConnected) return;

        // Initial load
        refreshPipelineData();

        // Set up interval for auto-refresh
        const interval = setInterval(refreshPipelineData, sheetRefreshInterval);
        return () => clearInterval(interval);
      }, [sheetsConnected, sheetAutoRefresh, sheetRefreshInterval, googleSheetId]);

      /**
       * Map a Google Sheet header name to the corresponding customer object property.
       * Returns { prop, transform } where transform converts the raw string value.
       */
      const mapSheetHeaderToCustomerProps = (headerName) => {
        const h = (headerName || '').toLowerCase().trim();
        const identity = v => v;
        const toFloat = v => parseFloat(v) || 0;
        const toInt = v => parseInt(v) || 0;
        const toBool = v => v === 'TRUE' || v === 'true';

        if (/customer\s*name|^name$/i.test(h)) return [
          { prop: 'name', transform: identity },
          { prop: 'firstname', transform: v => (v || '').trim().split(' ')[0] || '' },
          { prop: 'lastname', transform: v => (v || '').trim().split(' ').slice(1).join(' ') || '' }
        ];
        if (/^email|customer\s*email/i.test(h)) return [{ prop: 'email', transform: identity }];
        if (/^phone|mobile|customer\s*mobile/i.test(h)) return [{ prop: 'phone', transform: identity }];
        if (/^address/i.test(h)) return [{ prop: 'address', transform: identity }];
        if (/^street/i.test(h)) return [{ prop: 'street', transform: identity }];
        if (/^city/i.test(h)) return [{ prop: 'city', transform: identity }];
        if (/^state/i.test(h)) return [{ prop: 'state', transform: identity }];
        if (/^zip|zipcode/i.test(h)) return [{ prop: 'zip', transform: identity }];
        if (/panel|number\s*of\s*panel/i.test(h)) return [
          { prop: 'totalPanels', transform: toInt },
          { prop: 'panelCount', transform: toInt }
        ];
        if (/job\s*status|^status$/i.test(h)) return [{ prop: 'status', transform: identity }];
        if (/job\s*description|^description$/i.test(h)) return [{ prop: 'jobDescription', transform: identity }];
        if (/^amount|job\s*amount/i.test(h)) return [{ prop: 'amountPaid', transform: toFloat }];
        if (/^tip/i.test(h)) return [{ prop: 'tipAmount', transform: toFloat }];
        if (/^recurring$/i.test(h)) return [
          { prop: 'isRecurring', transform: toBool },
          { prop: 'recurring', transform: identity }
        ];
        if (/completed|completed\s*date|job\s*completed/i.test(h)) return [{ prop: 'lastServiceDate', transform: identity }];
        if (/next\s*service|upcoming\s*date/i.test(h)) return [{ prop: 'nextServiceDate', transform: identity }];
        if (/^notes|customer\s*notes/i.test(h)) return [{ prop: 'notes', transform: identity }];
        if (/solar\s*verified|^verified$/i.test(h)) return [{ prop: 'solarVerified', transform: v => v === 'yes' ? 'yes' : (v === 'no' ? 'no' : null) }];
        if (/^tags|job\s*tags/i.test(h)) return [{ prop: 'tags', transform: identity }];
        if (/^employee|assigned/i.test(h)) return [{ prop: 'employee', transform: identity }];
        return [];
      };

      /**
       * Find the sheet header index for a given set of possible header names.
       */
      const findSheetHeaderIndex = (possibleNames) => {
        for (const name of possibleNames) {
          const idx = sheetHeaders.findIndex(h =>
            h.toLowerCase().includes(name.toLowerCase())
          );
          if (idx !== -1) return idx;
        }
        return -1;
      };

      /**
       * Given a pipeline row's data object, find the matching customer by name+address or phone.
       */
      const findCustomerFromPipelineRow = (rowData) => {
        const nameIdx = findSheetHeaderIndex(['Customer Name', 'Name']);
        const addressIdx = findSheetHeaderIndex(['Address']);
        const phoneIdx = findSheetHeaderIndex(['Phone', 'Mobile', 'Customer Mobile']);
        const emailIdx = findSheetHeaderIndex(['Email', 'Customer Email']);

        const rowName = String(nameIdx >= 0 && rowData.values[nameIdx] ? rowData.values[nameIdx] : '').toLowerCase().trim();
        const rowAddress = String(addressIdx >= 0 && rowData.values[addressIdx] ? rowData.values[addressIdx] : '').toLowerCase().trim().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '').replace(/\s+/g, ' ');
        const rowPhone = String(phoneIdx >= 0 && rowData.values[phoneIdx] ? rowData.values[phoneIdx] : '').trim();
        const rowEmail = String(emailIdx >= 0 && rowData.values[emailIdx] ? rowData.values[emailIdx] : '').toLowerCase().trim();

        // Match by name+address first, then by phone, then by email
        return customers.find(c => {
          const cName = (c.name || '').toLowerCase().trim();
          const cAddress = (c.address || '').toLowerCase().trim().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '').replace(/\s+/g, ' ');
          if (rowName && rowAddress && cName === rowName && cAddress === rowAddress) return true;
          if (rowPhone && c.phone && rowPhone === c.phone) return true;
          if (rowEmail && c.email && rowEmail === c.email.toLowerCase().trim()) return true;
          return false;
        });
      };

      /**
       * Map customer property names back to possible sheet header names
       */
      const mapCustomerPropToSheetHeaders = (propName) => {
        const propMap = {
          name: ['Customer Name', 'Name'],
          email: ['Email', 'Customer Email'],
          phone: ['Phone', 'Mobile', 'Customer Mobile'],
          address: ['Address'],
          street: ['Street'],
          city: ['City'],
          state: ['State'],
          zip: ['Zip', 'Zipcode'],
          totalPanels: ['Panels', 'Number of Panels', 'Panel Count'],
          panelCount: ['Panels', 'Number of Panels', 'Panel Count'],
          status: ['Job Status', 'Status'],
          jobDescription: ['Job Description', 'Description'],
          amountPaid: ['Amount', 'Job Amount'],
          tipAmount: ['Tip'],
          isRecurring: ['Recurring'],
          recurring: ['Recurring'],
          lastServiceDate: ['Completed', 'Completed Date', 'Job Completed'],
          nextServiceDate: ['Next Service', 'Upcoming Date'],
          notes: ['Notes', 'Customer Notes'],
          solarVerified: ['Solar Verified', 'Verified'],
          tags: ['Tags', 'Job Tags'],
          employee: ['Employee', 'Assigned']
        };
        return propMap[propName] || [];
      };

      /**
       * Apply customer property updates across all data stores:
       * savedLists, uploadedFiles, savedRoutes, pipelineCustomers, and sheetData.
       */
      const propagateCustomerUpdate = (customerId, updates) => {
        // Update savedLists (triggers customers rebuild via useEffect)
        setSavedLists(prev => prev.map(list => ({
          ...list,
          customers: list.customers.map(c =>
            c.id === customerId ? { ...c, ...updates } : c
          )
        })));

        // Update uploadedFiles
        setUploadedFiles(prev => prev.map(file => ({
          ...file,
          customers: file.customers.map(c =>
            c.id === customerId ? { ...c, ...updates } : c
          )
        })));

        // Update savedRoutes
        setSavedRoutes(prev => prev.map(route => ({
          ...route,
          customers: (route.customers || []).map(c =>
            c.id === customerId ? { ...c, ...updates } : c
          )
        })));

        // Update pipelineCustomers (legacy)
        setPipelineCustomers(prev => prev.map(c =>
          c.id === customerId ? { ...c, ...updates } : c
        ));

        // Update sheetData (Pipeline view) - sync changes back to sheet data
        setSheetData(prev => {
          const customer = customers.find(c => c.id === customerId);
          if (!customer) return prev;

          return prev.map(row => {
            // Match row to customer by name+address or phone
            const nameIdx = findSheetHeaderIndex(['Customer Name', 'Name']);
            const addressIdx = findSheetHeaderIndex(['Address']);
            const phoneIdx = findSheetHeaderIndex(['Phone', 'Mobile', 'Customer Mobile']);

            const rowName = (nameIdx >= 0 && row.values[nameIdx] ? String(row.values[nameIdx]) : '').toLowerCase().trim();
            const rowAddress = (addressIdx >= 0 && row.values[addressIdx] ? String(row.values[addressIdx]) : '').toLowerCase().trim().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '').replace(/\s+/g, ' ');
            const rowPhone = (phoneIdx >= 0 && row.values[phoneIdx] ? String(row.values[phoneIdx]) : '').trim();

            const cName = (customer.name || '').toLowerCase().trim();
            const cAddress = (customer.address || '').toLowerCase().trim().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '').replace(/\s+/g, ' ');
            const isMatch = (rowName && rowAddress && cName === rowName && cAddress === rowAddress) ||
                           (rowPhone && customer.phone && rowPhone === customer.phone);

            if (!isMatch) return row;

            // Update matching row with new values
            const newValues = [...row.values];
            const newData = { ...row.data };

            Object.entries(updates).forEach(([prop, value]) => {
              const possibleHeaders = mapCustomerPropToSheetHeaders(prop);
              const headerIdx = findSheetHeaderIndex(possibleHeaders);
              if (headerIdx >= 0) {
                newValues[headerIdx] = String(value || '');
                newData[sheetHeaders[headerIdx]] = String(value || '');
              }
            });

            return { ...row, values: newValues, data: newData };
          });
        });

        // Update profileCustomer if it's currently open
        if (profileCustomer && profileCustomer.id === customerId) {
          setProfileCustomer(prev => ({ ...prev, ...updates }));
        }
      };

      /**
       * Handle Pipeline cell edit - update local state, sync to Google Sheets,
       * and propagate changes to all views (map, recurring, saved routes, profile).
       */
      const handlePipelineCellEdit = async (rowIndex, colIndex, newValue) => {
        // Capture the original row BEFORE editing to match against customers
        let originalRow = null;
        let editedRow = null;
        setSheetData(prev => prev.map(row => {
          if (row.rowIndex === rowIndex) {
            originalRow = row;
            const newValues = [...row.values];
            newValues[colIndex] = newValue;
            const newData = { ...row.data };
            newData[sheetHeaders[colIndex]] = newValue;
            editedRow = { ...row, values: newValues, data: newData };
            return editedRow;
          }
          return row;
        }));

        // Track this edit so the next refresh won't overwrite it
        pendingEditsRef.current.set(`${rowIndex}-${colIndex}`, {
          value: newValue,
          timestamp: Date.now()
        });

        // Push the cell edit to Google Sheets via Apps Script
        if (appsScriptUrl) {
          try {
            await fetch(appsScriptUrl, {
              method: 'POST',
              mode: 'no-cors',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                type: 'cellUpdate',
                row: rowIndex,
                col: colIndex + 1, // Convert to 1-indexed for Google Sheets
                value: newValue
              })
            });
          } catch (err) {
            console.error('Failed to sync cell edit to sheet:', err);
          }
        }

        // Map the edited column to customer properties and propagate
        const headerName = sheetHeaders[colIndex];
        const propMappings = mapSheetHeaderToCustomerProps(headerName);

        if (propMappings.length > 0 && originalRow) {
          // Match using the original row data (before edit) so name/address edits still match
          const matchedCustomer = findCustomerFromPipelineRow(originalRow);
          if (matchedCustomer) {
            const updates = {};
            propMappings.forEach(({ prop, transform }) => {
              updates[prop] = transform(newValue);
              // Track the edit (no longer needed for sync protection with one-way import,
              // but kept for audit trail)
              trackLocalOverride(matchedCustomer.id, prop, transform(newValue));
            });
            propagateCustomerUpdate(matchedCustomer.id, updates);
          }
        }
      };

      /**
       * Sort Pipeline data by column
       */
      const sortPipelineData = (colIndex) => {
        if (pipelineSortColumn === colIndex) {
          // Toggle order if same column
          setPipelineSortOrder(prev => prev === 'asc' ? 'desc' : 'asc');
        } else {
          // New column, start with ascending
          setPipelineSortColumn(colIndex);
          setPipelineSortOrder('asc');
        }
      };

      // Get sorted Pipeline data
      const getSortedPipelineData = () => {
        if (pipelineSortColumn === null) return sheetData;

        return [...sheetData].sort((a, b) => {
          const aVal = a.values[pipelineSortColumn] || '';
          const bVal = b.values[pipelineSortColumn] || '';

          // Try numeric comparison first
          const aNum = parseFloat(aVal.replace(/[^0-9.-]/g, ''));
          const bNum = parseFloat(bVal.replace(/[^0-9.-]/g, ''));

          if (!isNaN(aNum) && !isNaN(bNum)) {
            return pipelineSortOrder === 'asc' ? aNum - bNum : bNum - aNum;
          }

          // Fall back to string comparison
          const comparison = aVal.localeCompare(bVal, undefined, { numeric: true });
          return pipelineSortOrder === 'asc' ? comparison : -comparison;
        });
      };

      // Google Sheets API Functions
      const testGoogleSheetsConnection = async () => {
        if (!googleSheetId) {
          alert('Please enter your Google Sheet ID or URL');
          return false;
        }

        setSheetSyncing(true);
        try {
          // Use helper to get proper CSV URL for any format
          const csvUrl = getGoogleSheetsCsvUrl(googleSheetId);

          console.log('Testing connection to:', csvUrl);

          let response;
          try {
            // Try direct fetch first
            response = await fetch(csvUrl);
          } catch (directError) {
            console.log('Direct fetch failed, trying CORS proxy...');
            // If CORS error, use proxy
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(csvUrl)}`;
            response = await fetch(proxyUrl);
          }

          if (response.ok) {
            const csvData = await response.text();

            // Check if we got actual data
            if (csvData && csvData.length > 10) {
              setSheetsConnected(true);
              setLastSheetSync(new Date());
              localStorage.setItem('googleSheetId', googleSheetId); // Store the original URL/ID
              if (googleApiKey) localStorage.setItem('googleApiKey', googleApiKey);

              // Show preview of first row
              const firstLine = csvData.split('\n')[0];
              alert(`âœ… Connected to Google Sheets!\n\nFirst row preview:\n${firstLine.substring(0, 100)}...\n\nReady to sync customers.`);

              return true;
            } else {
              throw new Error('Sheet appears empty');
            }
          } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
        } catch (error) {
          setSheetsConnected(false);
          
          // Provide helpful error message
          let helpText = '';
          if (error.message.includes('fetch') || error.message.includes('CORS')) {
            helpText = '\n\nðŸ”§ Fix:\n1. Click "Share" button in your Google Sheet\n2. Click "Publish to web"\n3. Select "Entire Document" and "Comma-separated values (.csv)"\n4. Click "Publish"\n5. Or change sharing to "Anyone with the link"';
          } else if (error.message.includes('404')) {
            helpText = '\n\nðŸ”§ Fix:\nSheet ID might be wrong. Use either:\nâ€¢ Just the ID: 1w3bZyKiHK4YQBtO80zEh5HctNarMngbMjaUyITylltI\nâ€¢ Or the full URL from your browser';
          }
          
          alert(`âŒ Connection failed!\n\nError: ${error.message}${helpText}`);
          return false;
        } finally {
          setSheetSyncing(false);
        }
      };

      const addRowToGoogleSheet = async (customerData, jobData = null) => {
        if (!sheetsConnected || !googleSheetId) {
          console.log('Sheets not connected, skipping');
          return false;
        }

        try {
          // Prepare row data matching user's EXACT column order
          const rowData = [
            jobData?.jobType || 'Panel Cleaning',                          // 1. Job Description
            customerData.status || 'Not serviced',                         // 2. Job Status
            `${customerData.firstname} ${customerData.lastname}`,          // 3. Customer Name
            customerData.address || '',                                    // 4. Address (full)
            customerData.street || '',                                     // 5. Street
            customerData.city || '',                                       // 6. City
            customerData.state || '',                                      // 7. State
            customerData.zip || '',                                        // 8. Zipcode
            customerData.email || '',                                      // 9. Customer Email
            customerData.phone || '',                                      // 10. Customer Mobile number
            jobData?.scheduledDate || '',                                  // 11. Job Scheduled Start Date
            jobData?.completedDate || '',                                  // 12. Job completed Date
            jobData?.assignedEmployee || 'Chance Thompson',                // 13. Assigned Employees
            customerData.tags?.join(', ') || 'Route Planner',              // 14. Job Tags
            customerData.isRecurring ? 'TRUE' : 'FALSE',                   // 15. Recurring
            jobData?.price || customerData.amountPaid || '',               // 16. Job Amount
            jobData?.tip || '',                                            // 17. Tip Amount
            customerData.latitude || '',                                   // 18. Latitude
            customerData.longitude || '',                                  // 19. Longitude
            customerData.totalPanels || '',                                // 20. Number of Panel
            customerData.notes || '',                                      // 21. Customer Notes
            customerData.solarVerified || ''                               // 22. Solar Verified
          ];

          if (googleApiKey) {
            // Use API to append (columns A through V - 22 columns)
            const response = await fetch(
              `https://sheets.googleapis.com/v4/spreadsheets/${googleSheetId}/values/Sheet1!A:V:append?valueInputOption=RAW&key=${googleApiKey}`,
              {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ values: [rowData] })
              }
            );

            if (response.ok) {
              console.log('Row added to Google Sheet');
              return true;
            } else {
              console.error('Failed to add row to sheet:', await response.text());
              return false;
            }
          } else {
            console.log('Need API key to write to sheet. Row not added.');
            return false;
          }
        } catch (error) {
          console.error('Error adding row to sheet:', error);
          return false;
        }
      };

      // ========================================
      // EXPORT TO GOOGLE SHEET (local wins + preserve new rows)
      // ========================================

      /**
       * Build a CSV row from a customer object using the sheet's column headers.
       * Maps customer properties to the matching sheet header columns.
       * If jobOverride is provided, uses job-level fields from that instead of customer-level.
       */
      const customerToSheetRow = (customer, headers, jobOverride) => {
        return headers.map(header => {
          const h = (header || '').toLowerCase().trim();
          // If jobOverride is provided, use job-level values for job-specific columns
          if (jobOverride) {
            if (/job\s*description|^description$/i.test(h)) return jobOverride.jobDescription || '';
            if (/^amount|job\s*amount/i.test(h)) return jobOverride.amount != null ? `$${Number(jobOverride.amount).toFixed(2)}` : '$0.00';
            if (/^tip/i.test(h)) return jobOverride.tip != null ? `$${Number(jobOverride.tip).toFixed(2)}` : '$0.00';
            if (/completed|completed\s*date|job\s*completed/i.test(h)) return jobOverride.date || '';
            if (/job\s*status|^status$/i.test(h)) return jobOverride.status || '';
            if (/^notes|customer\s*notes/i.test(h)) return jobOverride.notes || '';
          }
          const mappings = mapSheetHeaderToCustomerProps(header);
          if (mappings.length === 0) return '';
          // Use first mapping (primary property)
          const { prop, transform } = mappings[0];
          let val = customer[prop];
          if (val === undefined || val === null) val = '';
          // Special handling for booleans
          if (prop === 'isRecurring') return val ? 'TRUE' : 'FALSE';
          if (prop === 'solarVerified') return val || '';
          return String(val);
        });
      };

      /**
       * Expand a customer into multiple rows â€” one per job in serviceHistory.
       * If no serviceHistory, returns a single row.
       */
      const customerToSheetRows = (customer, headers) => {
        const history = customer.serviceHistory || [];
        if (history.length <= 1) {
          return [customerToSheetRow(customer, headers)];
        }
        // One row per job, with customer-level fields repeated
        return history.map(job => customerToSheetRow(customer, headers, job));
      };

      /**
       * Export local customer data back to Google Sheet.
       * - Local data wins for existing customers
       * - New rows in the sheet (not in local data) are preserved
       * - Uses Apps Script web app URL if available, otherwise falls back to CSV download
       */
      const exportToGoogleSheet = async () => {
        setSheetExporting(true);
        try {
          // Step 1: Fetch current sheet to find new rows added by others
          const { headers: currentHeaders, rows: currentRows } = await fetchPipelineSheetData();
          const headers = currentHeaders.length > 0 ? currentHeaders : sheetHeaders;

          if (headers.length === 0) {
            alert('No sheet headers found. Please connect and sync your Google Sheet first.');
            return;
          }

          // Step 2: Build matching sets from local customers
          const localPhones = new Set(customers.filter(c => c.phone).map(c => String(c.phone).trim()));
          const localEmails = new Set(customers.filter(c => c.email).map(c => String(c.email).toLowerCase().trim()));
          const localNameAddresses = new Set(customers.map(c => {
            const name = String(c.name || '').toLowerCase().trim();
            const address = String(c.address || '').toLowerCase().trim().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '').replace(/\s+/g, ' ');
            return `${name}|${address}`;
          }));

          // Step 3: Find new rows in the sheet that don't exist locally
          const nameCol = headers.findIndex(h => h && /customer\s*name|^name$/i.test(String(h).toLowerCase().trim()));
          const addressCol = headers.findIndex(h => h && /^address/i.test(String(h).toLowerCase().trim()));
          const phoneCol = headers.findIndex(h => h && /^phone|mobile|customer\s*mobile/i.test(String(h).toLowerCase().trim()));
          const emailCol = headers.findIndex(h => h && /^email|customer\s*email/i.test(String(h).toLowerCase().trim()));

          const newSheetRows = [];
          currentRows.forEach(row => {
            const rowPhone = (phoneCol >= 0 ? row.values[phoneCol] || '' : '').trim();
            const rowEmail = (emailCol >= 0 ? row.values[emailCol] || '' : '').toLowerCase().trim();
            const rowName = (nameCol >= 0 ? row.values[nameCol] || '' : '').toLowerCase().trim();
            const rowAddress = (addressCol >= 0 ? row.values[addressCol] || '' : '').toLowerCase().trim().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '').replace(/\s+/g, ' ');
            const nameAddressKey = `${rowName}|${rowAddress}`;

            const existsLocally =
              (rowPhone && localPhones.has(rowPhone)) ||
              (rowEmail && localEmails.has(rowEmail)) ||
              (rowName && rowAddress && localNameAddresses.has(nameAddressKey));

            if (!existsLocally) {
              newSheetRows.push(row.values);
            }
          });

          // Step 4: Build export data = local customers (expanded by job history) + new sheet rows
          const localRows = customers.flatMap(c => customerToSheetRows(c, headers));
          const allRows = [headers, ...localRows, ...newSheetRows];

          console.log(`ðŸ“¤ Export: ${customers.length} customers â†’ ${localRows.length} rows (expanded by job history) + ${newSheetRows.length} new sheet rows = ${allRows.length - 1} total`);

          // Step 5: Send via Apps Script or fall back to CSV download
          if (appsScriptUrl) {
            const response = await fetch(appsScriptUrl, {
              method: 'POST',
              mode: 'no-cors',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(allRows)
            });

            // no-cors means we can't read the response, but if it didn't throw, it likely worked
            setLastSheetExport(new Date());
            localStorage.setItem('lastSheetExport', new Date().toISOString());
            alert(`Sheet updated!\n\n${localRows.length} local customers exported\n${newSheetRows.length} new sheet rows preserved\n${allRows.length - 1} total rows`);
          } else {
            // CSV download fallback
            downloadExportCSV(allRows);
          }
        } catch (error) {
          console.error('Export failed:', error);
          alert(`Export failed: ${error.message}\n\nTry the CSV download fallback instead.`);
        } finally {
          setSheetExporting(false);
        }
      };

      /**
       * CSV download fallback â€” generates a CSV file and triggers browser download.
       * User can then manually import into Google Sheets (File > Import > Replace current sheet).
       */
      const downloadExportCSV = (allRows) => {
        const csvContent = allRows.map(row =>
          row.map(cell => {
            const str = String(cell || '');
            // Escape cells containing commas, quotes, or newlines
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
              return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
          }).join(',')
        ).join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `customer-export-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        setLastSheetExport(new Date());
        localStorage.setItem('lastSheetExport', new Date().toISOString());
        alert(`CSV downloaded!\n\n${allRows.length - 1} total rows\n\nTo update your Google Sheet:\n1. Open your Google Sheet\n2. File > Import > Upload\n3. Select "Replace current sheet"\n4. Click Import`);
      };

      // ========================================
      // SMART QUERY FUNCTIONS - Use Sheets as Database
      // ========================================
      
      /**
       * Query Google Sheets with filters (like a database)
       * @param {Object} options - Query options
       * @param {number} options.limit - Max rows to return
       * @param {number} options.offset - Skip N rows (pagination)
       * @param {string} options.status - Filter by job status
       * @param {string} options.scheduledDate - Filter by date
       * @param {Object} options.bounds - {minLat, maxLat, minLng, maxLng}
       * @param {boolean} options.useCache - Use cached results if available
       */
      const queryGoogleSheet = async (options = {}) => {
        const {
          limit = 500,
          offset = 0,
          status = null,
          scheduledDate = null,
          bounds = null,
          useCache = true
        } = options;
        
        // Generate cache key
        const cacheKey = JSON.stringify({limit, offset, status, scheduledDate, bounds});
        
        // Check cache (5 min expiry)
        if (useCache && queryCache[cacheKey]) {
          const cached = queryCache[cacheKey];
          if (Date.now() - cached.timestamp < 300000) { // 5 minutes
            console.log('ðŸ“¦ Using cached query result');
            return cached.data;
          }
        }
        
        try {
          // Use helper to get proper CSV URL for any format
          const csvUrl = getGoogleSheetsCsvUrl(googleSheetId);

          let response;
          try {
            response = await fetch(csvUrl);
          } catch (e) {
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(csvUrl)}`;
            response = await fetch(proxyUrl);
          }

          if (!response.ok) {
            throw new Error(`Failed to fetch sheet: ${response.status}`);
          }
          
          const csv = await response.text();
          const rows = csv.split('\n').filter(row => row.trim());
          
          // Parse headers
          const headers = rows[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
          
          // Parse all data rows
          const allData = rows.slice(1).map(row => {
            const matches = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            return matches ? matches.map(m => m.replace(/^"|"$/g, '')) : [];
          }).filter(row => row.length >= 10); // Filter out empty/incomplete rows
          
          setTotalRowCount(allData.length);
          
          // Apply filters CLIENT-SIDE (still way faster than loading everything)
          let filtered = allData;
          
          // Filter by status
          if (status) {
            filtered = filtered.filter(row => {
              const rowStatus = row[1]; // Column B: Job Status
              return rowStatus && rowStatus.toLowerCase().includes(status.toLowerCase());
            });
          }
          
          // Filter by scheduled date
          if (scheduledDate) {
            filtered = filtered.filter(row => {
              const rowDate = row[10]; // Column K: Job Scheduled Start Date
              return rowDate && rowDate === scheduledDate;
            });
          }
          
          // Filter by bounds (lat/lng)
          if (bounds) {
            filtered = filtered.filter(row => {
              const lat = parseFloat(row[17]); // Column R: Latitude
              const lng = parseFloat(row[18]); // Column S: Longitude
              
              return !isNaN(lat) && !isNaN(lng) &&
                     lat >= bounds.minLat && lat <= bounds.maxLat &&
                     lng >= bounds.minLng && lng <= bounds.maxLng;
            });
          }
          
          // Apply pagination
          const paginated = filtered.slice(offset, offset + limit);
          
          // Update has more data flag
          setHasMoreData(offset + limit < filtered.length);
          
          console.log(`ðŸ“Š Query result: ${paginated.length} rows (filtered from ${allData.length}, offset: ${offset})`);
          
          // Cache the result
          setQueryCache(prev => ({
            ...prev,
            [cacheKey]: {
              data: paginated,
              timestamp: Date.now()
            }
          }));
          
          return paginated;
          
        } catch (error) {
          console.error('Query failed:', error);
          return [];
        }
      };
      
      /**
       * Load initial customers (smart subset)
       */
      const loadInitialCustomers = async () => {
        console.log('ðŸš€ Loading initial customers (smart query)...');
        
        const today = new Date().toISOString().split('T')[0];
        
        // Load today's scheduled jobs
        const scheduledToday = await queryGoogleSheet({
          scheduledDate: today,
          limit: 1000
        });
        
        // Load some unscheduled (for preview)
        const unscheduled = await queryGoogleSheet({
          status: 'Not serviced',
          limit: 500,
          offset: 0
        });
        
        return [...scheduledToday, ...unscheduled];
      };
      
      /**
       * Load more customers (pagination)
       */
      const loadMoreCustomers = async () => {
        if (!hasMoreData || isLoadingMore) return;
        
        setIsLoadingMore(true);
        try {
          const moreData = await queryGoogleSheet({
            limit: 500,
            offset: loadedRowCount
          });
          
          setLoadedRowCount(prev => prev + moreData.length);
          return moreData;
          
        } finally {
          setIsLoadingMore(false);
        }
      };
      
      /**
       * Query customers in viewport (map bounds)
       */
      const queryCustomersInViewport = async (mapBounds) => {
        if (!mapBounds) return [];
        
        const bounds = {
          minLat: mapBounds.getSouth(),
          maxLat: mapBounds.getNorth(),
          minLng: mapBounds.getWest(),
          maxLng: mapBounds.getEast()
        };
        
        console.log(`ðŸ—ºï¸ Loading customers in viewport: ${JSON.stringify(bounds)}`);
        
        return await queryGoogleSheet({
          bounds,
          limit: 2000, // More than enough for any viewport
          useCache: true
        });
      };

      const syncFromGoogleSheet = async (options = {}) => {
        if (!sheetsConnected || !googleSheetId) {
          console.log('Sheets not connected');
          return;
        }

        setSheetSyncing(true);
        try {
          let data;
          
          // Extract actual sheet ID from various URL formats
          let actualSheetId = googleSheetId;
          
          // If it's a full URL, extract the ID
          if (googleSheetId.includes('docs.google.com')) {
            // Format 1: https://docs.google.com/spreadsheets/d/1w3bZy.../edit
            const match1 = googleSheetId.match(/\/d\/([a-zA-Z0-9-_]+)/);
            // Format 2: https://docs.google.com/spreadsheets/d/e/2PACX-.../pubhtml
            const match2 = googleSheetId.match(/\/d\/e\/([a-zA-Z0-9-_]+)/);
            
            if (match2) {
              actualSheetId = match2[1]; // Published sheet ID
            } else if (match1) {
              actualSheetId = match1[1]; // Regular sheet ID
            }
          }
          
          console.log('Using Sheet ID:', actualSheetId);
          
          data = [];
          let colMap = null;
          
          if (googleApiKey) {
            // Use API - Get headers separately
            const headersResponse = await fetch(
              `https://sheets.googleapis.com/v4/spreadsheets/${actualSheetId}/values/Sheet1!A1:Z1?key=${googleApiKey}`
            );
            const headersJson = await headersResponse.json();
            const headers = headersJson.values ? headersJson.values[0] : [];
            
            console.log('ðŸ“‹ Sheet headers (API):', headers);
            
            // Create column mapping
            const getColumnIndex = (possibleNames) => {
              for (const name of possibleNames) {
                const index = headers.findIndex(h => 
                  h.toLowerCase().includes(name.toLowerCase())
                );
                if (index !== -1) return index;
              }
              return -1;
            };
            
            colMap = {
              jobDesc: getColumnIndex(['Job Description', 'Description']),
              status: getColumnIndex(['Job Status', 'Status']),
              name: getColumnIndex(['Customer Name', 'Name']),
              address: getColumnIndex(['Address']),
              street: getColumnIndex(['Street']),
              city: getColumnIndex(['City']),
              state: getColumnIndex(['State']),
              zip: getColumnIndex(['Zipcode', 'Zip', 'ZIP']),
              email: getColumnIndex(['Email', 'Customer Email']),
              phone: getColumnIndex(['Phone', 'Mobile', 'Customer Mobile']),
              schedStart: getColumnIndex(['Scheduled Start', 'Start Date', 'Job Scheduled']),
              completed: getColumnIndex(['Completed', 'Completed Date']),
              employee: getColumnIndex(['Employee', 'Assigned']),
              tags: getColumnIndex(['Tags', 'Job Tags']),
              recurring: getColumnIndex(['Recurring']),
              amount: getColumnIndex(['Amount', 'Job Amount']),
              tip: getColumnIndex(['Tip']),
              lat: getColumnIndex(['Latitude', 'Lat']),
              lng: getColumnIndex(['Longitude', 'Lng', 'Long']),
              panels: getColumnIndex(['Panel', 'Number of Panel', 'Panels']),
              notes: getColumnIndex(['Notes', 'Customer Notes']),
              solarVerified: getColumnIndex(['Solar Verified', 'Verified'])
            };
            
            // Get data rows
            const dataResponse = await fetch(
              `https://sheets.googleapis.com/v4/spreadsheets/${actualSheetId}/values/Sheet1!A2:Z?key=${googleApiKey}`
            );
            const dataJson = await dataResponse.json();
            data = dataJson.values || [];
            
          } else {
            // Use CSV export with CORS proxy fallback
            const csvUrl = getGoogleSheetsCsvUrl(googleSheetId);

            console.log('Fetching CSV from:', csvUrl);

            let response;
            try {
              response = await fetch(csvUrl);
            } catch (e) {
              console.log('Direct fetch failed, trying CORS proxy...');
              // Use CORS proxy
              const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(csvUrl)}`;
              response = await fetch(proxyUrl);
            }

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: Sheet may not be published or shared publicly`);
            }
            
          // Parse CSV and create header mapping
          const csv = await response.text();
          const rows = csv.split('\n').filter(row => row.trim());

          // First row is headers - use top-level parseCSVRow function
          const headers = parseCSVRow(rows[0]);
          console.log('ðŸ“‹ Sheet headers:', headers);
          
          // Create column mapping
          const getColumnIndex = (possibleNames) => {
            for (const name of possibleNames) {
              const index = headers.findIndex(h => 
                h.toLowerCase().includes(name.toLowerCase())
              );
              if (index !== -1) return index;
            }
            return -1;
          };
          
          colMap = {
            jobDesc: getColumnIndex(['Job Description', 'Description']),
            status: getColumnIndex(['Job Status', 'Status']),
            name: getColumnIndex(['Customer Name', 'Name']),
            address: getColumnIndex(['Address']),
            street: getColumnIndex(['Street']),
            city: getColumnIndex(['City']),
            state: getColumnIndex(['State']),
            zip: getColumnIndex(['Zipcode', 'Zip', 'ZIP']),
            email: getColumnIndex(['Email', 'Customer Email']),
            phone: getColumnIndex(['Phone', 'Mobile', 'Customer Mobile']),
            schedStart: getColumnIndex(['Scheduled Start', 'Start Date', 'Job Scheduled']),
            completed: getColumnIndex(['Completed', 'Completed Date', 'Job completed date']),
            employee: getColumnIndex(['Employee', 'Assigned']),
            tags: getColumnIndex(['Tags', 'Job Tags']),
            recurring: getColumnIndex(['Recurring']),
            amount: getColumnIndex(['Amount', 'Job Amount']),
            tip: getColumnIndex(['Tip', 'Tip amount']),
            lat: getColumnIndex(['Latitude', 'Lat']),
            lng: getColumnIndex(['Longitude', 'Lng', 'Long']),
            panels: getColumnIndex(['Panel', 'Number of Panel', 'Panels']),
            notes: getColumnIndex(['Notes', 'Customer Notes']),
            solarVerified: getColumnIndex(['Solar Verified', 'Verified']),
            nextServiceDate: getColumnIndex(['Next Service Date', 'Next Service', 'Upcoming Date'])
          };
          
          console.log('ðŸ“ Column mapping:', colMap);
          console.log(`ðŸ” CRITICAL: lat=${colMap.lat}, lng=${colMap.lng}, panels=${colMap.panels}`);

          // Parse data rows (skip header) - reuse parseCSVRow from above
          data = rows.slice(1).map(row => parseCSVRow(row));
          }
          
          console.log('ðŸ“ Column mapping:', colMap);
          console.log(`ðŸ” CRITICAL: lat=${colMap.lat}, lng=${colMap.lng}, panels=${colMap.panels}`);
          console.log(`ðŸ“Š Found ${data.length} data rows`);

          // Import customers from sheet - ONLY add NEW customers, never update existing
          let imported = 0;
          let skipped = 0;
          let skipReasons = [];

          // Build sets for duplicate detection (by phone, email, and name+address)
          const existingPhones = new Set(customers.filter(c => c.phone).map(c => String(c.phone).trim()));
          const existingEmails = new Set(customers.filter(c => c.email).map(c => String(c.email).toLowerCase().trim()));
          const existingNameAddresses = new Set(customers.map(c => {
            const name = String(c.name || '').toLowerCase().trim();
            const address = String(c.address || '').toLowerCase().trim().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '').replace(/\s+/g, ' ');
            return `${name}|${address}`;
          }));

          const newCustomers = []; // Collect all new customers here

          console.log(`ðŸ“Š Starting sync... Found ${data.length} rows in sheet`);
          console.log(`ðŸ“Š Existing customers: ${customers.length}`);
          
          for (const row of data) {
            if (row.length < 5) {
              skipped++;
              skipReasons.push(`Row ${skipped + imported + 1}: Too few columns (${row.length})`);
              continue;
            }
            
            // Extract data using column mapping (handles any order!)
            const getValue = (key) => {
              const index = colMap[key];
              return (index >= 0 && index < row.length) ? row[index] : '';
            };
            
            const jobDesc = getValue('jobDesc');
            const status = getValue('status');
            const name = getValue('name');
            const fullAddress = getValue('address');
            const street = getValue('street');
            const city = getValue('city');
            const state = getValue('state');
            const zip = getValue('zip');
            const email = getValue('email');
            const phone = getValue('phone');
            const schedStart = getValue('schedStart');
            const completed = getValue('completed');
            const employee = getValue('employee');
            const tags = getValue('tags');
            const recurring = getValue('recurring');
            const amount = getValue('amount');
            const tip = getValue('tip');
            const lat = getValue('lat');
            const lng = getValue('lng');
            const totalPanels = getValue('panels');
            const customerNotes = getValue('notes');
            const solarVerified = getValue('solarVerified');
            const nextServiceDateFromSheet = getValue('nextServiceDate');

            // Calculate next service date: use sheet value, or 12 months from completed date
            let calculatedNextServiceDate = nextServiceDateFromSheet;
            if (!calculatedNextServiceDate && completed) {
              const completedDate = new Date(completed);
              if (!isNaN(completedDate.getTime())) {
                const nextDate = new Date(completedDate);
                nextDate.setFullYear(nextDate.getFullYear() + 1);
                calculatedNextServiceDate = nextDate.toISOString().split('T')[0];
              }
            }
            
            // Debug first row
            if (imported === 0 && skipped === 0) {
              console.log(`ðŸ” First customer: Name="${name}", Lat="${lat}", Lng="${lng}", Panels="${totalPanels}"`);
              console.log(`ðŸ” RAW row[${colMap.lat}]="${row[colMap.lat]}", row[${colMap.lng}]="${row[colMap.lng]}", row[${colMap.panels}]="${row[colMap.panels]}"`);
            }
            
            // Skip if no coordinates
            if (!lat || !lng) {
              skipped++;
              skipReasons.push(`Row ${skipped + imported + 1}: Missing coordinates (Lat: "${lat}", Lng: "${lng}")`);
              continue;
            }
            
            // Skip if no name
            if (!name) {
              skipped++;
              skipReasons.push(`Row ${skipped + imported + 1}: Missing customer name`);
              continue;
            }
            
            // Build full address if not provided
            const addressToUse = fullAddress || (street ? `${street}, ${city}, ${state} ${zip}`.trim() : '');
            
            // Check if this customer already exists (by phone, email, or name+address)
            const checkName = (name || '').toLowerCase().trim();
            const checkAddress = (addressToUse || '').toLowerCase().trim().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '').replace(/\s+/g, ' ');
            const nameAddressKey = `${checkName}|${checkAddress}`;

            const isDuplicate =
              (phone && existingPhones.has(phone.trim())) ||
              (email && existingEmails.has(email.toLowerCase().trim())) ||
              (checkName && checkAddress && existingNameAddresses.has(nameAddressKey));

            // Build the job entry for this row
            const jobEntry = {
              date: completed || '',
              jobDescription: jobDesc || 'Service',
              amount: parseFloat(amount) || 0,
              tip: parseFloat(tip) || 0,
              notes: customerNotes || '',
              status: status || (completed ? 'Completed' : 'unscheduled')
            };

            if (isDuplicate) {
              // Merge this job into the existing customer's serviceHistory
              const existing = [...customers, ...newCustomers].find(c => {
                if (phone && c.phone && String(c.phone).trim() === phone.trim()) return true;
                if (email && c.email && String(c.email).toLowerCase().trim() === email.toLowerCase().trim()) return true;
                const cName = (c.name || '').toLowerCase().trim();
                const cAddr = (c.address || '').toLowerCase().trim().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '').replace(/\s+/g, ' ');
                if (cName && cAddr && `${cName}|${cAddr}` === nameAddressKey) return true;
                return false;
              });

              if (existing && completed) {
                if (!existing.serviceHistory) existing.serviceHistory = [];
                // Avoid adding duplicate jobs (same date + same description)
                const alreadyHasJob = existing.serviceHistory.some(j =>
                  j.date === jobEntry.date && j.jobDescription === jobEntry.jobDescription
                );
                if (!alreadyHasJob) {
                  existing.serviceHistory.push(jobEntry);
                  // Update lastServiceDate if this job is more recent
                  if (completed && (!existing.lastServiceDate || new Date(completed) > new Date(existing.lastServiceDate))) {
                    existing.lastServiceDate = completed;
                  }
                  // Update total amount
                  existing.amountPaid = (existing.amountPaid || 0) + (parseFloat(amount) || 0);
                  existing.tipAmount = (existing.tipAmount || 0) + (parseFloat(tip) || 0);
                  // Update panel count if this row has a higher value
                  const rowPanels = parseInt(totalPanels) || 0;
                  if (rowPanels > (existing.totalPanels || 0)) {
                    existing.totalPanels = rowPanels;
                    existing.panelCount = rowPanels;
                  }
                  console.log(`ðŸ”„ Merged job into ${name}: "${jobDesc}" (${completed}) â€” ${existing.serviceHistory.length} total jobs`);
                }
              }
              skipped++;
              skipReasons.push(`Row ${skipped + imported + 1}: Merged job into existing customer (${name})`);
              continue;
            }

            console.log(`âœ… Importing: ${name} - Lat: ${lat}, Lng: ${lng}, Panels: ${totalPanels}`);

            // Parse name
            const nameParts = (name || '').trim().split(' ');
            const firstname = nameParts[0] || '';
            const lastname = nameParts.slice(1).join(' ') || '';

            const newCustomer = {
              id: Date.now() + Math.random(),
              firstname,
              lastname,
              address: addressToUse,
              street: street || '',
              city: city || '',
              state: state || '',
              zip: zip || '',
              lat: parseFloat(lat),
              lng: parseFloat(lng),
              latitude: parseFloat(lat),
              longitude: parseFloat(lng),
              phone: phone || '',
              email: email || '',
              totalPanels: parseInt(totalPanels) || 0,
              panelCount: parseInt(totalPanels) || 0,
              name: `${firstname} ${lastname}`.trim(),
              status: (status && status.toLowerCase() === 'scheduled') ? 'scheduled' : 'unscheduled', // Use sheet status if 'scheduled', otherwise 'unscheduled'
              jobDescription: jobDesc || '',
              isRecurring: recurring === 'TRUE' || recurring === true,
              amountPaid: parseFloat(amount) || 0,
              tipAmount: parseFloat(tip) || 0,
              lastServiceDate: completed || '',
              nextServiceDate: calculatedNextServiceDate || '',
              notes: customerNotes || '',
              customerNotes: '', // General customer notes (separate from job notes)
              solarVerified: solarVerified === 'yes' ? 'yes' : (solarVerified === 'no' ? 'no' : null),
              serviceHistory: completed ? [jobEntry] : [],
              notesHistory: customerNotes ? [{
                date: new Date().toISOString(),
                note: customerNotes,
                source: 'Google Sheets Import',
                jobDate: completed || null
              }] : [],
              existingJob: !!completed
            };

            newCustomers.push(newCustomer); // Add to collection
            imported++;

            // Track for duplicate detection in same batch
            if (phone) existingPhones.add(phone.trim());
            if (email) existingEmails.add(email.toLowerCase().trim());
            existingNameAddresses.add(nameAddressKey);
          }

          // Add all customers to savedLists so they appear on map
          if (newCustomers.length > 0) {
            const listId = Date.now() + Math.random();
            const listName = `Google Sheets Import - ${new Date().toLocaleDateString()}`;

            // Add customers with proper structure for the list
            const customersForList = newCustomers.map(c => ({
              ...c,
              fileId: listId,
              fileName: listName
            }));

            // Add to savedLists (this triggers the useEffect that updates customers)
            setSavedLists(prev => [...prev, {
              id: listId,
              name: listName,
              customers: customersForList,
              visible: true,
              count: customersForList.length,
              type: 'sheets'
            }]);

            // Also add to pipelineCustomers so they appear in Pipeline view
            const pipelineEntries = newCustomers.map(c => ({
              ...c,
              pipelineId: Date.now().toString() + Math.random(),
              addedDate: new Date().toISOString()
            }));
            setPipelineCustomers(prev => [...prev, ...pipelineEntries]);

            console.log(`âœ… Added ${newCustomers.length} customers as "${listName}"`);
            console.log(`ðŸ“ Sample customer:`, newCustomers[0]);
          }

          // Count how many jobs were merged
          const mergedCount = skipReasons.filter(r => r.includes('Merged job')).length;

          console.log(`ðŸ“Š Sync complete: ${imported} imported, ${mergedCount} jobs merged, ${skipped - mergedCount} skipped`);
          if (skipReasons.length > 0) {
            console.log('Skip reasons:', skipReasons);
          }

          setLastSheetSync(new Date());
          if (imported > 0 || mergedCount > 0) {
            const totalCustomers = customers.length + imported;
            let message = `âœ… Synced from Google Sheets!\n\nâ€¢ ${imported} new customer${imported !== 1 ? 's' : ''} imported\nâ€¢ ${mergedCount} additional job${mergedCount !== 1 ? 's' : ''} merged into existing customers\n\nTotal customers: ${totalCustomers}`;

            // Performance warning for large datasets
            if (totalCustomers > 10000) {
              message += `\n\nâš ï¸ PERFORMANCE TIP:\nWith ${totalCustomers.toLocaleString()} customers, the map uses smart rendering:\nâ€¢ Clusters shown when zoomed out\nâ€¢ Full detail when zoomed in\nâ€¢ Zoom in to see individual markers`;
            }

            alert(message);
          } else {
            alert(`âš ï¸ No new customers found.\n\nChecked ${data.length} rows, skipped ${skipped}.\n\nCommon reasons:\nâ€¢ Missing Latitude/Longitude\nâ€¢ Duplicate phone numbers\nâ€¢ Empty customer names\n\nCheck browser console (F12) for details.`);
          }
        } catch (error) {
          console.error('Error syncing from sheet:', error);
          alert(`âŒ Sync failed: ${error.message}`);
        } finally {
          setSheetSyncing(false);
        }
      };

      const createJob = async () => {
        try {
          let customerId = jobForm.customerId;
          let customerData = null;

          // If new customer, create them first
          if (jobForm.isNewCustomer) {
            if (!jobForm.firstName || !jobForm.lastName || !jobForm.address) {
              alert('Please fill in all required customer fields (name and address)');
              return;
            }

            // Geocode the address (or use pre-geocoded coordinates from autocomplete)
            setGeocoding(true);
            let geoResult;
            
            if (jobForm._preGeocodedLat && jobForm._preGeocodedLng) {
              // Use coordinates from autocomplete selection
              geoResult = {
                lat: jobForm._preGeocodedLat,
                lng: jobForm._preGeocodedLng
              };
            } else {
              // Geocode the address manually
              geoResult = await geocodeAddress(jobForm.address);
            }
            
            setGeocoding(false);

            if (!geoResult) {
              alert('Could not find coordinates for this address. Please check the address and try again.');
              return;
            }

            // Create new customer
            const newCustomer = {
              id: Date.now(),
              firstname: jobForm.firstName.trim(),
              lastname: jobForm.lastName.trim(),
              address: jobForm.address.trim(),
              latitude: geoResult.lat,
              longitude: geoResult.lng,
              phone: jobForm.phone.trim(),
              email: jobForm.email.trim(),
              totalPanels: parseInt(jobForm.panelCount) || 0,
              lastServiceDate: '',
              amountPaid: 0,
              status: 'Not serviced', // Default status
              existingJob: false,
              isRecurring: jobForm.isRecurring,
              solarVerified: null,
              serviceHistory: [],
              notesHistory: []
            };

            customerData = newCustomer;
            customerId = newCustomer.id;
            
            // Add to customers
            setCustomers(prev => [...prev, newCustomer]);

            // Add to Google Sheets
            if (sheetsConnected && googleApiKey) {
              const jobData = {
                jobType: jobForm.jobType,
                scheduledDate: jobForm.scheduledDate,
                price: jobForm.useCustomPrice ? jobForm.customPrice : jobForm.calculatedPrice,
                assignedEmployee: jobForm.assignedEmployee
              };
              await addRowToGoogleSheet(newCustomer, jobData);
              console.log('âœ… Customer added to Google Sheets');
            }
          } else {
            // Find existing customer
            customerData = customers.find(c => c.id === customerId);
            if (!customerData) {
              alert('Customer not found');
              return;
            }
          }

          // Calculate final price
          const finalPrice = jobForm.useCustomPrice 
            ? parseFloat(jobForm.customPrice) || 0
            : jobForm.calculatedPrice;

          // Create the job
          const newJob = {
            id: Date.now(),
            customerId: customerId,
            customerName: jobForm.isNewCustomer 
              ? `${jobForm.firstName} ${jobForm.lastName}`
              : jobForm.customerName,
            panelCount: parseInt(jobForm.panelCount) || 0,
            price: finalPrice,
            pricingTier: jobForm.pricingTier,
            jobType: jobForm.jobType,
            scheduledDate: jobForm.scheduledDate,
            scheduledTime: jobForm.scheduledTime,
            isRecurring: jobForm.isRecurring,
            recurringFrequency: jobForm.isRecurring ? parseInt(jobForm.recurringFrequency) : null,
            assignedEmployee: jobForm.assignedEmployee,
            notes: jobForm.notes,
            status: jobForm.scheduledDate ? 'scheduled' : 'unscheduled',
            createdAt: new Date().toISOString()
          };

          // Update customer with panel count if new customer or not set
          if (jobForm.isNewCustomer || !customerData.totalPanels) {
            const updatedCustomers = customers.map(c => 
              c.id === customerId 
                ? { ...c, totalPanels: parseInt(jobForm.panelCount) || 0 }
                : c
            );
            if (jobForm.isNewCustomer) {
              updatedCustomers.push({
                ...customerData,
                totalPanels: parseInt(jobForm.panelCount) || 0
              });
            }
            setCustomers(updatedCustomers);
          }

          // If job has a scheduled date/time, add to calendar
          if (jobForm.scheduledDate && jobForm.scheduledTime) {
            const dateKey = jobForm.scheduledDate;
            const timeSlot = jobForm.scheduledTime;
            
            const jobForRoute = {
              ...customerData,
              scheduledTime: timeSlot,
              jobId: newJob.id,
              jobType: jobForm.jobType,
              jobPrice: finalPrice,
              jobNotes: jobForm.notes,
              isRecurringJob: jobForm.isRecurring,
              panelCount: parseInt(jobForm.panelCount) || customerData.totalPanels
            };

            setRoutesByDay(prev => {
              const dayRoute = prev[dateKey] || [];
              const updatedRoute = [...dayRoute, jobForRoute];
              return { ...prev, [dateKey]: updatedRoute };
            });

            // If recurring, generate future instances
            if (jobForm.isRecurring) {
              const futureJobs = generateRecurringJobs(
                jobForm.scheduledDate,
                jobForm.scheduledTime,
                jobForm.recurringFrequency,
                10 // 10 years
              );

              futureJobs.forEach(futureJob => {
                const futureJobForRoute = {
                  ...jobForRoute,
                  jobId: Date.now() + Math.random(),
                  scheduledTime: futureJob.time
                };

                setRoutesByDay(prev => {
                  const dayRoute = prev[futureJob.date] || [];
                  const updatedRoute = [...dayRoute, futureJobForRoute];
                  return { ...prev, [futureJob.date]: updatedRoute };
                });
              });
            }

            // Update customer status to scheduled
            setCustomers(prev => prev.map(c => 
              c.id === customerId 
                ? { ...c, status: 'scheduled' }
                : c
            ));
          } else {
            // No date/time - remains unscheduled
            // Update customer status filter will show it
            setCustomers(prev => prev.map(c => 
              c.id === customerId 
                ? { ...c, status: 'unscheduled' }
                : c
            ));
          }

          // Close modal and reset form
          setShowJobModal(false);
          resetJobForm();
          
          alert(`Job created successfully! ${jobForm.isRecurring ? `${Math.floor((10 * 12) / parseInt(jobForm.recurringFrequency))} recurring instances generated.` : ''}`);
        } catch (error) {
          console.error('Error creating job:', error);
          alert('Error creating job. Please try again.');
        }
      };

      // Handle file upload
      const handleFileUpload = async (uploadedFiles) => {
        setLoading(true);
        setError(null);

        try {
          const fileArray = Array.from(uploadedFiles);
          
          for (const file of fileArray) {
            if (!file.name.endsWith('.csv')) {
              setError('Please upload CSV files only');
              continue;
            }

            setError(`ðŸ“¡ Processing ${file.name}...`);
            const result = await processCSVFile(file);
            
            if (result.customers.length === 0) {
              setError(`âš ï¸ No valid data found in ${file.name}. Please check that all required columns are present with valid data.`);
            } else {
              // Add file with its customers and visibility flag
              const fileId = Date.now() + Math.random(); // Unique ID
              const customersWithFileId = result.customers.map(c => ({
                ...c,
                fileId: fileId
              }));
              
              setUploadedFiles(prev => [...prev, {
                id: fileId,
                name: result.fileName,
                customers: customersWithFileId,
                visible: true, // Default to visible
                count: customersWithFileId.length
              }]);
              
              // Store failed customers if any
              if (result.failed && result.failed.length > 0) {
                setFailedCustomers(prev => [...prev, ...result.failed.map(f => ({ ...f, fileName: result.fileName }))]);
              }
              
              setError(null); // Clear error after successful upload
            }
          }
        } catch (err) {
          setError(`âŒ Failed to process file: ${err.message}`);
        } finally {
          setLoading(false);
        }
      };

      const handleFileDragOver = (e) => {
        e.preventDefault();
        setDragOver(true);
      };

      const handleFileDragLeave = () => {
        setDragOver(false);
      };

      const handleFileDrop = (e) => {
        e.preventDefault();
        setDragOver(false);
        handleFileUpload(e.dataTransfer.files);
      };

      const zoomToCustomer = (customer) => {
        if (mapInstanceRef.current) {
          mapInstanceRef.current.setView([customer.lat, customer.lng], 15);
          setCurrentView('map');
        }
      };

      const removeFile = (fileName) => {
        const newFiles = files.filter(f => f.name !== fileName);
        const newCustomers = customers.filter(c => c.fileName !== fileName);
        setFiles(newFiles);
        setCustomers(newCustomers);
        // filteredCustomers will be updated by unified filter reacting to customers change
      };

      return (
        <>
        <div style={{
          width: '100vw',
          height: '95vh',
          background: 'linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%)',
          fontFamily: "'Inter', sans-serif",
          color: '#f1f5f9',
          display: 'flex',
          flexDirection: 'column',
          overflow: 'hidden',
          maxWidth: '100vw',
          overflowX: 'hidden'
        }}>
          
          {/* Floating Verification Notification */}
          {verifying && (
            <div style={{
              position: 'fixed',
              bottom: '32px',
              right: '32px',
              zIndex: 10000,
              background: 'linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%)',
              padding: '20px 24px',
              borderRadius: '16px',
              boxShadow: '0 20px 60px rgba(139, 92, 246, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1)',
              display: 'flex',
              alignItems: 'center',
              gap: '16px',
              minWidth: '320px',
              animation: 'slideInRight 0.3s ease-out',
              border: '2px solid rgba(255, 255, 255, 0.2)'
            }}>
              <div style={{
                width: '48px',
                height: '48px',
                borderRadius: '12px',
                background: 'rgba(255, 255, 255, 0.2)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: '24px',
                animation: 'pulse 2s infinite'
              }}>
                ðŸ¤–
              </div>
              <div style={{ flex: 1 }}>
                <div style={{ fontSize: '15px', fontWeight: 700, marginBottom: '6px', color: 'white' }}>
                  Verifying Solar Panels
                </div>
                <div style={{ fontSize: '13px', color: 'rgba(255, 255, 255, 0.9)', marginBottom: '8px' }}>
                  {verificationProgress.current} of {verificationProgress.total} homes analyzed
                </div>
                <div style={{ height: '6px', background: 'rgba(255, 255, 255, 0.2)', borderRadius: '3px', overflow: 'hidden' }}>
                  <div style={{
                    height: '100%',
                    background: 'linear-gradient(90deg, #ffffff 0%, #e0e7ff 100%)',
                    width: `${(verificationProgress.current / verificationProgress.total * 100)}%`,
                    transition: 'width 0.3s ease',
                    boxShadow: '0 0 10px rgba(255, 255, 255, 0.5)'
                  }}></div>
                </div>
              </div>
            </div>
          )}
          
          {/* Header */}
          <div style={{
            background: 'rgba(15, 23, 42, 0.8)',
            backdropFilter: 'blur(20px)',
            borderBottom: '1px solid rgba(139, 92, 246, 0.1)',
            padding: '6px 16px',
            maxWidth: '100vw',
            overflowX: 'hidden'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '4px' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                <div style={{
                  width: '20px',
                  height: '20px',
                  background: 'linear-gradient(135deg, #8b5cf6, #6366f1)',
                  borderRadius: '6px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  boxShadow: '0 2px 8px rgba(139, 92, 246, 0.4)',
                  fontSize: '12px'
                }}>
                  ðŸ“
                </div>
                <div>
                  <h1 style={{
                    fontSize: '14px',
                    fontWeight: 800,
                    margin: 0,
                    background: 'linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%)',
                    WebkitBackgroundClip: 'text',
                    WebkitTextFillColor: 'transparent',
                    letterSpacing: '-0.5px'
                  }}>
                    Route Planner & CRM
                  </h1>
                  <p style={{ fontSize: '9px', color: '#94a3b8', margin: '0' }}>
                    {stats.visible > 0 && stats.visible !== stats.total 
                      ? `Viewing ${stats.visible} of ${stats.total} customers`
                      : `${stats.total} customers loaded`
                    }
                  </p>
                </div>
              </div>
              
              {/* Show All Markers Button (only for large datasets) */}
              {customers.length > 5000 && !showAllMarkers && (
                <button
                  onClick={() => {
                    if (confirm(`âš ï¸ You have ${customers.length.toLocaleString()} customers!\n\nShowing all markers may slow down your browser.\n\nRecommended: Use filters or radius search instead.\n\nShow all anyway?`)) {
                      setShowAllMarkers(true);
                    }
                  }}
                  style={{
                    padding: '8px 16px',
                    fontSize: '12px',
                    fontWeight: 600,
                    display: 'flex',
                    alignItems: 'center',
                    gap: '6px',
                    background: 'rgba(245, 158, 11, 0.1)',
                    border: '1px solid rgba(245, 158, 11, 0.3)',
                    borderRadius: '8px',
                    color: '#fbbf24',
                    cursor: 'pointer',
                    transition: 'all 0.2s'
                  }}
                >
                  <span style={{ fontSize: '16px' }}>âš¡</span>
                  Show All ({customers.length.toLocaleString()})
                </button>
              )}
              
              {/* Hide Some Markers Button (when showing all) */}
              {customers.length > 5000 && showAllMarkers && (
                <button
                  onClick={() => setShowAllMarkers(false)}
                  style={{
                    padding: '8px 16px',
                    fontSize: '12px',
                    fontWeight: 600,
                    display: 'flex',
                    alignItems: 'center',
                    gap: '6px',
                    background: 'rgba(34, 197, 94, 0.1)',
                    border: '1px solid rgba(34, 197, 94, 0.3)',
                    borderRadius: '8px',
                    color: '#86efac',
                    cursor: 'pointer',
                    transition: 'all 0.2s'
                  }}
                >
                  <span style={{ fontSize: '16px' }}>âš¡</span>
                  Performance Mode
                </button>
              )}
              
              {/* Failed Customers Notification */}
              {failedCustomers.length > 0 && (
                <div style={{
                  padding: '12px 16px',
                  background: 'rgba(251, 191, 36, 0.1)',
                  border: '1px solid rgba(251, 191, 36, 0.3)',
                  borderRadius: '12px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between',
                  gap: '12px',
                  marginTop: '16px'
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <div style={{ fontSize: '24px' }}>âš ï¸</div>
                    <div>
                      <div style={{ fontSize: '13px', fontWeight: 600, color: '#fbbf24' }}>
                        {failedCustomers.length} {failedCustomers.length === 1 ? 'address' : 'addresses'} couldn't be mapped
                      </div>
                      <div style={{ fontSize: '11px', color: '#94a3b8' }}>
                        Click to review and fix addresses
                      </div>
                    </div>
                  </div>
                  <button
                    onClick={() => setShowFailedCustomersModal(true)}
                    style={{
                      padding: '8px 16px',
                      background: 'rgba(251, 191, 36, 0.2)',
                      border: '1px solid rgba(251, 191, 36, 0.4)',
                      borderRadius: '8px',
                      color: '#fbbf24',
                      fontSize: '12px',
                      fontWeight: 600,
                      cursor: 'pointer',
                      whiteSpace: 'nowrap'
                    }}
                  >
                    ðŸ“ Review & Fix
                  </button>
                </div>
              )}
              
              {currentView === 'map' && (
                <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                  {referenceAddress && (
                    <div className="glass-card" style={{ padding: '8px 12px', display: 'flex', alignItems: 'center', gap: '6px' }}>
                      <div style={{ fontSize: '14px' }}>ðŸŽ¯</div>
                      <div style={{ fontSize: '12px' }}>
                        <div style={{ color: '#94a3b8', fontSize: '10px' }}>Search Center</div>
                        <div style={{ color: '#f1f5f9', fontWeight: 600 }}>{referenceAddress.split(',')[0]}</div>
                      </div>
                    </div>
                  )}
                  <button
                    className="button-secondary"
                    onClick={() => setShowHeatMap(!showHeatMap)}
                  >
                    ðŸ”¥ Heat Map
                  </button>
                  <button
                    className="button-primary"
                    onClick={() => setRadiusMode(true)}
                  >
                    ðŸŽ¯ Radius Search
                  </button>
                  {referencePoint && (
                    <>
                      <button
                        className="button-secondary"
                        onClick={downloadRadiusResultsCSV}
                        style={{ background: 'rgba(34, 197, 94, 0.1)', borderColor: 'rgba(34, 197, 94, 0.3)', color: '#86efac' }}
                      >
                        ðŸ“¥ Download CSV ({filteredCustomers.length})
                      </button>
                      <button
                        className="button-secondary"
                        onClick={() => {
                          setRadiusMode(false);
                          setAwaitingMapClick(false);
                          setDrawMode(false);
                          clearRadius();
                          clearDrawnArea();
                        }}
                        style={{ background: 'rgba(239, 68, 68, 0.1)', borderColor: 'rgba(239, 68, 68, 0.3)', color: '#fca5a5' }}
                      >
                        âŒ Exit Radius Mode
                      </button>
                    </>
                  )}
                </div>
              )}
            </div>

            {/* Statistics - only show on map tab */}
            {currentView === 'map' && stats.total > 0 && (
              <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))',
                gap: '6px',
                marginBottom: '6px'
              }}>
                <div className="glass-card stat-card" style={{ padding: '6px' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '6px', marginBottom: '4px' }}>
                    <div style={{
                      width: '16px',
                      height: '16px',
                      background: 'rgba(139, 92, 246, 0.2)',
                      borderRadius: '6px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '10px'
                    }}>
                      ðŸ‘¥
                    </div>
                    <span style={{ fontSize: '8px', color: '#94a3b8', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                      Customers
                    </span>
                  </div>
                  <div style={{ fontSize: '16px', fontWeight: 800, color: '#f1f5f9', lineHeight: 1 }}>
                    {stats.visible > 0 && stats.visible !== stats.total ? stats.visible : stats.total}
                  </div>
                </div>

                <div className="glass-card stat-card" style={{ padding: '6px' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '6px', marginBottom: '4px' }}>
                    <div style={{
                      width: '16px',
                      height: '16px',
                      background: 'rgba(34, 197, 94, 0.2)',
                      borderRadius: '6px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '10px'
                    }}>
                      ðŸ›£ï¸
                    </div>
                    <span style={{ fontSize: '8px', color: '#94a3b8', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Route Stops</span>
                  </div>
                  <div style={{ fontSize: '16px', fontWeight: 800, color: '#f1f5f9', lineHeight: 1 }}>{route.length}</div>
                </div>

                {/* Solar Verification Stats Card */}
                <div className="glass-card stat-card" style={{ padding: '6px', background: verifying ? 'rgba(139, 92, 246, 0.15)' : 'rgba(15, 23, 42, 0.6)', border: verifying ? '2px solid rgba(139, 92, 246, 0.5)' : '1px solid rgba(139, 92, 246, 0.2)' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '6px', marginBottom: '4px' }}>
                    <div style={{
                      width: '16px',
                      height: '16px',
                      background: verifying ? 'rgba(139, 92, 246, 0.3)' : 'rgba(34, 197, 94, 0.2)',
                      borderRadius: '6px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '10px',
                      animation: verifying ? 'pulse 2s infinite' : 'none'
                    }}>
                      {verifying ? 'â³' : 'âœ“'}
                    </div>
                    <span style={{ fontSize: '8px', color: '#94a3b8', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                      {verifying ? 'Verifying...' : 'Solar Verified'}
                    </span>
                  </div>
                  <div style={{ fontSize: '16px', fontWeight: 800, color: '#f1f5f9', lineHeight: 1 }}>
                    {verifying ? verificationProgress.current : customers.filter(c => c.solarVerified === 'yes').length}
                    <span style={{ fontSize: '11px', color: '#64748b', marginLeft: '4px' }}>
                      / {verifying ? verificationProgress.total : customers.length}
                    </span>
                  </div>
                  <div style={{ display: 'flex', gap: '6px', marginTop: '4px', fontSize: '8px', color: '#94a3b8' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '2px' }}>
                      <span>âœ“</span>
                      <span>{customers.filter(c => c.solarVerified === 'yes').length}</span>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '2px' }}>
                      <span>âŒ</span>
                      <span>{customers.filter(c => c.solarVerified === 'no').length}</span>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '2px' }}>
                      <span>ðŸ”</span>
                      <span>{customers.filter(c => !c.solarVerified).length}</span>
                    </div>
                  </div>
                  {verifying && (
                    <div style={{ marginTop: '8px', height: '3px', background: 'rgba(139, 92, 246, 0.2)', borderRadius: '2px', overflow: 'hidden' }}>
                      <div style={{ 
                        height: '100%', 
                        background: 'linear-gradient(90deg, #8b5cf6, #c4b5fd)', 
                        width: `${(verificationProgress.current / verificationProgress.total * 100)}%`,
                        transition: 'width 0.3s ease'
                      }}></div>
                    </div>
                  )}
                </div>

                {stats.totalRouteDistance > 0 && (
                  <div className="glass-card stat-card" style={{ padding: '6px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '6px', marginBottom: '4px' }}>
                      <div style={{
                        width: '16px',
                        height: '16px',
                        background: 'rgba(245, 158, 11, 0.2)',
                        borderRadius: '6px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '10px'
                      }}>
                        ðŸ“
                      </div>
                      <span style={{ fontSize: '8px', color: '#94a3b8', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.5px' }}>Total Route</span>
                    </div>
                    <div style={{ fontSize: '16px', fontWeight: 800, color: '#f1f5f9', lineHeight: 1 }}>
                      {(stats.totalRouteDistance || 0).toFixed(1)}<span style={{ fontSize: '12px', color: '#64748b', marginLeft: '4px' }}>mi</span>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Tabs and Search */}
            <div style={{ display: 'flex', gap: '8px', alignItems: 'center', borderTop: '1px solid rgba(139, 92, 246, 0.1)', paddingTop: '8px', flexWrap: 'wrap' }}>
              <div style={{ display: 'flex', gap: '4px', flexShrink: 0 }}>
                <button className={`tab-button ${currentView === 'map' ? 'active' : ''}`} onClick={() => setCurrentView('map')}>
                  ðŸ—ºï¸ Map
                </button>
                <button className={`tab-button ${currentView === 'saved' ? 'active' : ''}`} onClick={() => setCurrentView('saved')}>
                  ðŸ“ Saved Routes ({savedRoutes.length})
                </button>
                <button className={`tab-button ${currentView === 'pipeline' ? 'active' : ''}`} onClick={() => setCurrentView('pipeline')}>
                  ðŸ“Š Pipeline ({pipelineCustomers.length})
                </button>
                <button className={`tab-button ${currentView === 'recurring' ? 'active' : ''}`} onClick={() => setCurrentView('recurring')} style={{ color: currentView === 'recurring' ? '#22c55e' : undefined }}>
                  ðŸ¦– Recurring ({customers.filter(c => c.isRecurring === true || c.recurring === 'TRUE' || c.recurring === true).length})
                </button>
              </div>
              
              {/* Search Bar */}
              {customers.length > 0 && (
                <div style={{ position: 'relative', flex: 1, minWidth: '200px', maxWidth: '350px' }}>
                  <div style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: '#64748b', fontSize: '14px' }}>
                    ðŸ”
                  </div>
                  <input
                    type="text"
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    placeholder="Search customers..."
                    className="input-field"
                    style={{ 
                      paddingLeft: '38px', 
                      paddingRight: searchQuery ? '38px' : '12px',
                      height: '32px',
                      fontSize: '12px'
                    }}
                  />
                  {searchQuery && (
                    <button
                      onClick={() => setSearchQuery('')}
                      style={{
                        position: 'absolute',
                        right: '12px',
                        top: '50%',
                        transform: 'translateY(-50%)',
                        background: 'transparent',
                        border: 'none',
                        color: '#64748b',
                        cursor: 'pointer',
                        padding: 0,
                        display: 'flex',
                        alignItems: 'center',
                        fontSize: '14px'
                      }}
                    >
                      âŒ
                    </button>
                  )}
                </div>
              )}
              
              {/* Save List Button - only show when searching or filtering */}
              {(searchQuery || cityFilter || stateFilter || zipFilter) && visibleCustomers.length > 0 && (
                <button
                  onClick={() => setShowSaveListModal(true)}
                  className="button-secondary"
                  style={{
                    fontSize: '10px',
                    padding: '6px 12px',
                    whiteSpace: 'nowrap'
                  }}
                >
                  ðŸ’¾ Save List ({visibleCustomers.length})
                </button>
              )}
            </div>
          </div>

          {/* Content - Keep map always rendered but hidden */}
          <div style={{ flex: 1, overflow: 'hidden', position: 'relative' }}>
            {/* Map View */}
            <div style={{ 
              display: currentView === 'map' ? 'flex' : 'none',
              flex: 1,
              overflow: 'hidden',
              position: 'absolute',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0
            }}>
              {/* Left Sidebar */}
              <div style={{
                width: '320px',
                background: 'rgba(15, 23, 42, 0.95)',
                backdropFilter: 'blur(20px)',
                borderRight: '1px solid rgba(139, 92, 246, 0.1)',
                display: 'flex',
                flexDirection: 'column',
                overflow: 'hidden'
              }}>
                {/* Weekly Calendar */}
                {showCalendar && (
                  <div style={{
                    padding: '8px 12px',
                    borderBottom: '1px solid rgba(139, 92, 246, 0.1)',
                    background: 'rgba(15, 23, 42, 0.8)'
                  }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '6px' }}>
                      <h3 style={{ fontSize: '12px', fontWeight: 700, margin: 0, color: '#8b5cf6' }}>
                        ðŸ“… {calendarViewMode === 'month' ? selectedDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) : 'Schedule'}
                      </h3>
                      <div style={{ display: 'flex', gap: '4px' }}>
                        <button
                          onClick={() => setCalendarViewMode(calendarViewMode === 'week' ? 'month' : 'week')}
                          style={{
                            background: 'rgba(34, 197, 94, 0.1)',
                            border: '1px solid rgba(34, 197, 94, 0.3)',
                            borderRadius: '6px',
                            padding: '4px 8px',
                            color: '#22c55e',
                            cursor: 'pointer',
                            fontSize: '10px',
                            fontWeight: 600
                          }}
                          title={calendarViewMode === 'week' ? 'Show month view' : 'Show week view'}
                        >
                          {calendarViewMode === 'week' ? 'ðŸ“… Month' : 'ðŸ“† Week'}
                        </button>
                        {calendarViewMode === 'week' && (
                          <>
                            <button
                              onClick={() => navigateWeek(-1)}
                              style={{
                                background: 'rgba(139, 92, 246, 0.1)',
                                border: '1px solid rgba(139, 92, 246, 0.2)',
                                borderRadius: '6px',
                                padding: '4px 8px',
                            color: '#8b5cf6',
                            cursor: 'pointer',
                            fontSize: '12px'
                          }}
                        >
                          â†
                        </button>
                        <button
                          onClick={goToToday}
                          style={{
                            background: 'rgba(139, 92, 246, 0.1)',
                            border: '1px solid rgba(139, 92, 246, 0.2)',
                            borderRadius: '6px',
                            padding: '4px 12px',
                            color: '#8b5cf6',
                            cursor: 'pointer',
                            fontSize: '11px',
                            fontWeight: 600
                          }}
                        >
                          Today
                        </button>
                        <button
                          onClick={() => navigateWeek(1)}
                          style={{
                            background: 'rgba(139, 92, 246, 0.1)',
                            border: '1px solid rgba(139, 92, 246, 0.2)',
                            borderRadius: '6px',
                            padding: '4px 8px',
                            color: '#8b5cf6',
                            cursor: 'pointer',
                            fontSize: '12px'
                          }}
                        >
                          â†’
                        </button>
                          </>
                        )}
                        {calendarViewMode === 'month' && (
                          <>
                            <button
                              onClick={() => {
                                const newDate = new Date(selectedDate);
                                newDate.setMonth(newDate.getMonth() - 1);
                                setSelectedDate(newDate);
                              }}
                              style={{
                                background: 'rgba(139, 92, 246, 0.1)',
                                border: '1px solid rgba(139, 92, 246, 0.2)',
                                borderRadius: '6px',
                                padding: '4px 8px',
                                color: '#8b5cf6',
                                cursor: 'pointer',
                                fontSize: '12px'
                              }}
                            >
                              â†
                            </button>
                            <button
                              onClick={goToToday}
                              style={{
                                background: 'rgba(139, 92, 246, 0.1)',
                                border: '1px solid rgba(139, 92, 246, 0.2)',
                                borderRadius: '6px',
                                padding: '4px 12px',
                                color: '#8b5cf6',
                                cursor: 'pointer',
                                fontSize: '11px',
                                fontWeight: 600
                              }}
                            >
                              Today
                            </button>
                            <button
                              onClick={() => {
                                const newDate = new Date(selectedDate);
                                newDate.setMonth(newDate.getMonth() + 1);
                                setSelectedDate(newDate);
                              }}
                              style={{
                                background: 'rgba(139, 92, 246, 0.1)',
                                border: '1px solid rgba(139, 92, 246, 0.2)',
                                borderRadius: '6px',
                                padding: '4px 8px',
                                color: '#8b5cf6',
                                cursor: 'pointer',
                                fontSize: '12px'
                              }}
                            >
                              â†’
                            </button>
                          </>
                        )}
                        <button
                          onClick={() => setShowCalendar(false)}
                          style={{
                            background: 'transparent',
                            border: 'none',
                            color: '#64748b',
                            cursor: 'pointer',
                            fontSize: '16px',
                            padding: '0 4px'
                          }}
                          title="Hide calendar"
                        >
                          âœ•
                        </button>
                      </div>
                    </div>
                    
                    {/* Week or Month Days */}
                    {calendarViewMode === 'week' ? (
                      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '4px' }}>
                        {getWeekDays(weekStart).map((date, index) => {
                        const isToday = date.toDateString() === new Date().toDateString();
                        const isSelected = date.toDateString() === selectedDate.toDateString();
                        const routesForDay = getRoutesForDate(date);
                        const hasRoutes = routesForDay.length > 0;
                        
                        return (
                          <div
                            key={index}
                            onClick={() => setSelectedDate(date)}
                            style={{
                              padding: '4px 2px',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              background: isSelected ? 'rgba(139, 92, 246, 0.3)' : 
                                         isToday ? 'rgba(59, 130, 246, 0.1)' : 
                                         'rgba(30, 41, 59, 0.3)',
                              border: isSelected ? '2px solid rgba(139, 92, 246, 0.8)' :
                                     isToday ? '1px solid rgba(59, 130, 246, 0.4)' :
                                     '1px solid transparent',
                              boxShadow: isSelected ? '0 0 12px rgba(139, 92, 246, 0.6)' : 'none',
                              transition: 'all 0.2s',
                              position: 'relative',
                              animation: isSelected ? 'pulse-glow 2s ease-in-out infinite' : 'none'
                            }}
                            onMouseEnter={(e) => {
                              if (!isSelected) {
                                e.currentTarget.style.background = 'rgba(139, 92, 246, 0.15)';
                              }
                            }}
                            onMouseLeave={(e) => {
                              if (!isSelected) {
                                e.currentTarget.style.background = isToday ? 'rgba(59, 130, 246, 0.1)' : 'rgba(30, 41, 59, 0.3)';
                              }
                            }}
                            title="Click to view day schedule"
                          >
                            <div style={{ fontSize: '8px', fontWeight: 600, color: '#64748b', textAlign: 'center', marginBottom: '1px', textTransform: 'uppercase' }}>
                              {date.toLocaleDateString('en-US', { weekday: 'short' })}
                            </div>
                            <div style={{ fontSize: '13px', fontWeight: 700, color: isSelected ? '#a78bfa' : isToday ? '#60a5fa' : '#f1f5f9', textAlign: 'center', position: 'relative' }}>
                              {date.getDate()}
                              {/* Green checkmark for saved routes */}
                              {(() => {
                                const hasSavedRoute = savedRoutes.some(r => {
                                  const routeDate = new Date(r.scheduledDate);
                                  return routeDate.toDateString() === date.toDateString() && r.confirmed;
                                });
                                return hasSavedRoute ? (
                                  <span style={{
                                    position: 'absolute',
                                    top: '-6px',
                                    right: '-6px',
                                    fontSize: '14px',
                                    color: '#22c55e',
                                    filter: 'drop-shadow(0 2px 4px rgba(0,0,0,0.8))'
                                  }}>âœ“</span>
                                ) : null;
                              })()}
                            </div>
                            {hasRoutes && (
                              <div style={{
                                position: 'absolute',
                                bottom: '4px',
                                left: '50%',
                                transform: 'translateX(-50%)',
                                display: 'flex',
                                gap: '2px'
                              }}>
                                {routesForDay.slice(0, 3).map((_, idx) => (
                                  <div key={idx} style={{
                                    width: '4px',
                                    height: '4px',
                                    borderRadius: '50%',
                                    background: isSelected ? '#a78bfa' : '#22c55e'
                                  }} />
                                ))}
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                    ) : (
                      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '3px', maxHeight: '240px', overflowY: 'auto' }} className="scrollbar-custom">
                        {getMonthDays(selectedDate).map((date, index) => {
                          const isToday = date.toDateString() === new Date().toDateString();
                          const isSelected = date.toDateString() === selectedDate.toDateString();
                          const routesForDay = getRoutesForDate(date);
                          const hasSavedRoute = savedRoutes.some(r => {
                            const routeDate = new Date(r.scheduledDate);
                            return routeDate.toDateString() === date.toDateString() && r.confirmed;
                          });
                          
                          return (
                            <div
                              key={index}
                              onClick={() => {
                                // Set the selected date
                                setSelectedDate(date);
                                
                                // Navigate to the week containing this date
                                const clickedDate = new Date(date);
                                const day = clickedDate.getDay();
                                const diff = clickedDate.getDate() - day;
                                const monday = new Date(clickedDate.setDate(diff));
                                setWeekStart(monday);
                                
                                // Switch to week view
                                setCalendarViewMode('week');
                              }}
                              style={{
                                padding: '6px 2px',
                                borderRadius: '6px',
                                cursor: 'pointer',
                                background: isSelected ? 'rgba(139, 92, 246, 0.3)' : 
                                           isToday ? 'rgba(59, 130, 246, 0.1)' : 
                                           'rgba(30, 41, 59, 0.3)',
                                border: isSelected ? '2px solid rgba(139, 92, 246, 0.8)' :
                                       isToday ? '1px solid rgba(59, 130, 246, 0.4)' :
                                       '1px solid transparent',
                                transition: 'all 0.2s',
                                position: 'relative',
                                minHeight: '35px'
                              }}
                              onMouseEnter={(e) => {
                                if (!isSelected) {
                                  e.currentTarget.style.background = 'rgba(139, 92, 246, 0.15)';
                                }
                              }}
                              onMouseLeave={(e) => {
                                if (!isSelected) {
                                  e.currentTarget.style.background = isToday ? 'rgba(59, 130, 246, 0.1)' : 'rgba(30, 41, 59, 0.3)';
                                }
                              }}
                              title={`${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}${routesForDay.length > 0 ? ` - ${routesForDay.length} route(s)` : ''}`}
                            >
                              <div style={{ fontSize: '11px', fontWeight: 600, color: isSelected ? '#a78bfa' : isToday ? '#60a5fa' : '#f1f5f9', textAlign: 'center', position: 'relative' }}>
                                {date.getDate()}
                                {hasSavedRoute && (
                                  <span style={{
                                    position: 'absolute',
                                    top: '-4px',
                                    right: '2px',
                                    fontSize: '10px',
                                    color: '#22c55e'
                                  }}>âœ“</span>
                                )}
                              </div>
                              {routesForDay.length > 0 && (
                                <div style={{
                                  fontSize: '8px',
                                  color: '#22c55e',
                                  textAlign: 'center',
                                  marginTop: '2px'
                                }}>
                                  {routesForDay.length}
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    )}
                    
                    {/* Selected Date Info */}
                    <div style={{ marginTop: '6px', padding: '6px 8px', background: 'rgba(139, 92, 246, 0.05)', borderRadius: '6px' }}>
                      <div style={{ fontSize: '9px', color: '#94a3b8', marginBottom: '2px' }}>
                        Route Date:
                      </div>
                      <div style={{ fontSize: '11px', fontWeight: 600, color: '#f1f5f9' }}>
                        {selectedDate.toLocaleDateString('en-US', { 
                          weekday: 'long',
                          month: 'short', 
                          day: 'numeric',
                          year: 'numeric'
                        })}
                      </div>
                      {getRoutesForDate(selectedDate).length > 0 && (
                        <div style={{ fontSize: '9px', color: '#22c55e', marginTop: '4px', fontWeight: 600 }}>
                          {getRoutesForDate(selectedDate).length} route{getRoutesForDate(selectedDate).length > 1 ? 's' : ''} scheduled
                        </div>
                      )}
                    </div>
                  </div>
                )}
                
                {/* Calendar Toggle Button (when hidden) */}
                {!showCalendar && (
                  <div style={{ padding: '8px 12px', borderBottom: '1px solid rgba(139, 92, 246, 0.1)' }}>
                    <button
                      onClick={() => setShowCalendar(true)}
                      className="button-secondary"
                      style={{
                        width: '100%',
                        justifyContent: 'center',
                        padding: '6px',
                        fontSize: '11px'
                      }}
                    >
                      ðŸ“… Show Calendar
                    </button>
                  </div>
                )}

                {/* Content Area */}
                <div className="scrollbar-custom" style={{ flex: 1, overflow: 'auto', padding: '12px' }}>
                  {/* Day Schedule View */}
                  <div style={{ marginBottom: '12px' }}>
                    {/* Tip at top */}
                    {customers.length > 0 && showTip && (
                      <div style={{
                        marginBottom: '12px',
                        padding: '12px',
                        background: 'rgba(139, 92, 246, 0.1)',
                        border: '1px solid rgba(139, 92, 246, 0.2)',
                        borderRadius: '8px',
                        fontSize: '11px',
                        color: '#c4b5fd',
                        lineHeight: '1.6',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'space-between',
                        gap: '12px'
                      }}>
                        <span>
                          <strong>ðŸ’¡ Tip:</strong> Click customers on map to build route. Drag stops to reorder!
                        </span>
                        <button
                          onClick={() => setShowTip(false)}
                          style={{
                            background: 'transparent',
                            border: 'none',
                            color: '#94a3b8',
                            cursor: 'pointer',
                            fontSize: '16px',
                            padding: '0 4px',
                            flexShrink: 0
                          }}
                          title="Dismiss tip"
                        >
                          âœ•
                        </button>
                      </div>
                    )}
                    
                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '8px' }}>
                      <h3 style={{
                        fontSize: '12px',
                        fontWeight: 700,
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px',
                        color: '#8b5cf6'
                      }}>
                        ðŸ“… {selectedDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
                      </h3>
                      <div style={{ fontSize: '9px', color: '#94a3b8' }}>
                        {(() => {
                          const jobsForDay = customers.filter(c => {
                            if (!c.scheduledDate) return false;
                            const custDate = new Date(c.scheduledDate);
                            return custDate.toDateString() === selectedDate.toDateString();
                          });
                          return `${jobsForDay.length} job${jobsForDay.length !== 1 ? 's' : ''}`;
                        })()}
                      </div>
                    </div>
                    
                    {(() => {
                      const dateKey = selectedDate.toDateString();
                      const inSavedView = savedViewDays[dateKey] === true;

                      // Find ALL saved routes for this day (multiple technicians)
                      const savedRoutesForDay = savedRoutes.filter(r => {
                        const rDate = new Date(r.scheduledDate);
                        return rDate.toDateString() === dateKey;
                      });

                      // Get the currently selected route index for this day (default to 0)
                      const selectedIdx = selectedRouteIndexByDay[dateKey] || 0;
                      const savedRouteForDay = savedRoutesForDay[selectedIdx] || savedRoutesForDay[0];

                      // Get jobs from saved route OR from customers state (fallback)
                      let jobsForDay = [];
                      if (inSavedView && savedRouteForDay && savedRouteForDay.customers) {
                        // Use customers from saved route (source of truth for saved view)
                        jobsForDay = [...savedRouteForDay.customers].sort((a, b) => {
                          if (!a.scheduledTime || !b.scheduledTime) return 0;
                          const [aHour, aMin] = a.scheduledTime.split(':').map(Number);
                          const [bHour, bMin] = b.scheduledTime.split(':').map(Number);
                          return (aHour * 60 + aMin) - (bHour * 60 + bMin);
                        });
                      } else {
                        // Use customers state (for edit view)
                        jobsForDay = customers
                          .filter(c => {
                            if (!c.scheduledDate) return false;
                            const custDate = new Date(c.scheduledDate);
                            return custDate.toDateString() === dateKey;
                          })
                          .sort((a, b) => {
                            if (!a.scheduledTime || !b.scheduledTime) return 0;
                            const [aHour, aMin] = a.scheduledTime.split(':').map(Number);
                            const [bHour, bMin] = b.scheduledTime.split(':').map(Number);
                            return (aHour * 60 + aMin) - (bHour * 60 + bMin);
                          });
                      }

                      // SAVED VIEW - Show compact list (only if in saved mode and has routes)
                      if (inSavedView && savedRoutesForDay.length > 0) {
                        return (
                          <div>
                            {/* Route Tabs - only show if multiple routes for this day */}
                            {savedRoutesForDay.length > 1 && (
                              <div style={{
                                display: 'flex',
                                gap: '4px',
                                marginBottom: '12px',
                                background: 'rgba(15, 23, 42, 0.5)',
                                padding: '4px',
                                borderRadius: '8px'
                              }}>
                                {savedRoutesForDay.map((route, idx) => (
                                  <button
                                    key={route.id}
                                    onClick={() => setSelectedRouteIndexByDay(prev => ({ ...prev, [dateKey]: idx }))}
                                    style={{
                                      flex: 1,
                                      padding: '8px 12px',
                                      fontSize: '11px',
                                      fontWeight: 600,
                                      background: idx === selectedIdx ? 'rgba(139, 92, 246, 0.3)' : 'transparent',
                                      border: idx === selectedIdx ? '1px solid rgba(139, 92, 246, 0.5)' : '1px solid transparent',
                                      borderRadius: '6px',
                                      color: idx === selectedIdx ? '#a78bfa' : '#94a3b8',
                                      cursor: 'pointer',
                                      transition: 'all 0.2s',
                                      whiteSpace: 'nowrap',
                                      overflow: 'hidden',
                                      textOverflow: 'ellipsis'
                                    }}
                                  >
                                    {route.name || `Route ${idx + 1}`}
                                  </button>
                                ))}
                              </div>
                            )}

                            <div style={{ display: 'flex', gap: '6px', marginBottom: '12px' }}>
                              <button
                                onClick={() => {
                                  if (savedRouteForDay && savedRouteForDay.sentToTech) {
                                    alert('This route has already been sent to the technician. Reach out to the technician directly to make further changes.');
                                    return;
                                  }
                                  if (savedRouteForDay) {
                                    // Load into routesByDay
                                    setRoutesByDay(prev => ({
                                      ...prev,
                                      [dateKey]: savedRouteForDay.customers
                                    }));
                                    setEditingSavedRouteId(savedRouteForDay.id);

                                    // Restore scheduledTime/scheduledDate into customers state
                                    // so the time slots in edit view show the jobs
                                    setCustomers(prev => {
                                      const routeCustomerMap = new Map();
                                      savedRouteForDay.customers.forEach(rc => {
                                        routeCustomerMap.set(rc.id, rc);
                                      });
                                      return prev.map(c => {
                                        const rc = routeCustomerMap.get(c.id);
                                        if (rc) {
                                          return {
                                            ...c,
                                            scheduledTime: rc.scheduledTime || c.scheduledTime,
                                            scheduledDate: savedRouteForDay.scheduledDate || rc.scheduledDate || c.scheduledDate,
                                            status: 'scheduled',
                                            routeConfirmed: true
                                          };
                                        }
                                        return c;
                                      });
                                    });
                                  }
                                  setSavedViewDays(prev => ({ ...prev, [dateKey]: false }));
                                }}
                                className="button-secondary"
                                style={{
                                  flex: 1,
                                  padding: '8px 10px',
                                  fontSize: '11px',
                                  justifyContent: 'center'
                                }}
                              >
                                âœï¸ Edit Route
                              </button>
                              <button
                                onClick={() => {
                                  // Start a fresh new route - DON'T clear other routes' customers
                                  setRoutesByDay(prev => ({
                                    ...prev,
                                    [dateKey]: []
                                  }));
                                  setEditingSavedRouteId(null);
                                  setSuggestedCustomers([]);
                                  setSavedViewDays(prev => ({ ...prev, [dateKey]: false }));
                                }}
                                className="button-primary"
                                style={{
                                  flex: 1,
                                  padding: '8px 10px',
                                  fontSize: '11px',
                                  justifyContent: 'center'
                                }}
                              >
                                + New Route
                              </button>
                            </div>
                            
                            <div style={{ 
                              padding: '12px',
                              background: 'rgba(139, 92, 246, 0.1)',
                              border: '1px solid rgba(139, 92, 246, 0.3)',
                              borderRadius: '8px'
                            }}>
                              <h4 style={{ 
                                fontSize: '11px', 
                                fontWeight: 700, 
                                color: '#8b5cf6', 
                                marginBottom: '10px',
                                textTransform: 'uppercase',
                                letterSpacing: '0.5px'
                              }}>
                                ðŸ“‹ Scheduled Jobs ({jobsForDay.length})
                              </h4>
                              <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                                {jobsForDay.map((job, idx) => (
                                  <div key={job.id}
                                    onClick={() => {
                                      const fullCustomer = customers.find(c => c.id === job.id) || job;
                                      setProfileCustomer(fullCustomer);
                                      setShowCustomerProfile(true);
                                    }}
                                    style={{
                                      display: 'flex',
                                      alignItems: 'center',
                                      gap: '10px',
                                      padding: '8px',
                                      background: 'rgba(15, 23, 42, 0.6)',
                                      borderRadius: '6px',
                                      border: '1px solid rgba(139, 92, 246, 0.2)',
                                      cursor: 'pointer',
                                      transition: 'all 0.15s'
                                    }}
                                    onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(139, 92, 246, 0.15)'}
                                    onMouseLeave={(e) => e.currentTarget.style.background = 'rgba(15, 23, 42, 0.6)'}
                                  >
                                    <div style={{
                                      fontSize: '11px',
                                      fontWeight: 700,
                                      color: '#8b5cf6',
                                      minWidth: '25px'
                                    }}>
                                      #{idx + 1}
                                    </div>
                                    <div style={{
                                      fontSize: '11px',
                                      fontWeight: 600,
                                      color: '#22c55e',
                                      minWidth: '65px'
                                    }}>
                                      {job.scheduledTime ?
                                        new Date(`2000-01-01T${job.scheduledTime}`).toLocaleTimeString('en-US', {
                                          hour: 'numeric',
                                          minute: '2-digit',
                                          hour12: true
                                        }) : 'N/A'}
                                    </div>
                                    <div style={{ flex: 1, overflow: 'hidden' }}>
                                      <div style={{
                                        fontSize: '12px',
                                        fontWeight: 600,
                                        color: '#f1f5f9',
                                        overflow: 'hidden',
                                        textOverflow: 'ellipsis',
                                        whiteSpace: 'nowrap'
                                      }}>
                                        {job.name}
                                      </div>
                                      <div style={{
                                        fontSize: '10px',
                                        color: '#64748b',
                                        overflow: 'hidden',
                                        textOverflow: 'ellipsis',
                                        whiteSpace: 'nowrap'
                                      }}>
                                        {job.address}
                                      </div>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          </div>
                        );
                      }
                      
                      // EDIT VIEW - Show action buttons (if jobs exist) and timeslots
                      return (
                        <div>
                          {/* Action Buttons - Only show if there are jobs */}
                          {jobsForDay.length > 0 && (
                            <div style={{ display: 'flex', gap: '6px', marginBottom: '8px' }}>
                              <button
                                onClick={() => {
                                  // Pre-fill name if editing existing route
                                  if (editingSavedRouteId) {
                                    const existingRoute = savedRoutes.find(r => r.id === editingSavedRouteId);
                                    if (existingRoute) setRouteName(existingRoute.name);
                                  }
                                  setShowSaveModal(true);
                                }}
                                className="button-primary"
                                style={{
                                  padding: '6px 10px',
                                  fontSize: '10px',
                                  flex: 1,
                                  justifyContent: 'center'
                                }}
                              >
                                ðŸ’¾ Save Route
                              </button>
                              <button
                                onClick={() => {
                                  // Clear all jobs for selected day
                                  setCustomers(prev => prev.map(c => {
                                    if (!c.scheduledDate) return c;
                                    const custDate = new Date(c.scheduledDate);
                                    if (custDate.toDateString() === dateKey) {
                                      return {
                                        ...c,
                                        scheduledDate: null,
                                        scheduledTime: null,
                                        status: 'unscheduled',
                                        routeConfirmed: false
                                      };
                                    }
                                    return c;
                                  }));
                                  
                                  // Clear THIS DAY'S route
                                  setRoutesByDay(prev => ({
                                    ...prev,
                                    [dateKey]: []
                                  }));
                                  
                                  // Clear old route state (backward compatibility)
                                  setRoute([]);
                                  setSuggestedCustomers([]);
                                }}
                                style={{
                                background: 'rgba(239, 68, 68, 0.1)',
                                border: '1px solid rgba(239, 68, 68, 0.2)',
                                borderRadius: '6px',
                                padding: '6px 10px',
                                color: '#fca5a5',
                                cursor: 'pointer',
                                fontSize: '10px',
                                fontWeight: 600,
                                flex: 1,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '4px'
                              }}
                            >
                              ðŸ—‘ï¸ Clear Day
                            </button>
                          </div>
                          )}
                          
                          {/* Time Slots */}
                          <div>
                          {/* Up Arrow - Show Earlier Times */}
                          {visibleStartHour > 6 && (
                            <button
                              onClick={() => setVisibleStartHour(prev => Math.max(6, prev - 1))}
                              style={{
                                width: '100%',
                                padding: '8px',
                                marginBottom: '8px',
                                background: 'rgba(139, 92, 246, 0.1)',
                            border: '1px solid rgba(139, 92, 246, 0.3)',
                            borderRadius: '6px',
                            color: '#8b5cf6',
                            cursor: 'pointer',
                            fontSize: '12px',
                            fontWeight: 600,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: '6px'
                          }}
                        >
                          â†‘ Show Earlier Times
                        </button>
                          )}
                          
                          <div style={{ display: 'grid', gap: '6px' }}>
                        {generateTimeSlots()
                          .filter(slot => slot.hour >= visibleStartHour && slot.hour < visibleEndHour)
                          .map((slot, index) => {
                            const jobsInSlot = getJobsForTimeSlot(selectedDate, slot.time);
                            const isBlocked = jobsInSlot.length > 0;
                            
                            // Calculate job number based on scheduled time
                            const allJobsForDay = customers
                              .filter(c => {
                                if (!c.scheduledDate || !c.scheduledTime) return false;
                                const custDate = new Date(c.scheduledDate);
                                return custDate.toDateString() === selectedDate.toDateString();
                              })
                              .sort((a, b) => {
                                const [aHour, aMin] = a.scheduledTime.split(':').map(Number);
                                const [bHour, bMin] = b.scheduledTime.split(':').map(Number);
                                return (aHour * 60 + aMin) - (bHour * 60 + bMin);
                              });
                            
                            return (
                              <div
                                key={slot.time}
                                onDragOver={(e) => {
                                  e.preventDefault();
                                  e.currentTarget.style.background = 'rgba(139, 92, 246, 0.2)';
                                }}
                                onDragLeave={(e) => {
                                  e.currentTarget.style.background = isBlocked ? 'rgba(239, 68, 68, 0.05)' : 'rgba(30, 41, 59, 0.3)';
                                }}
                                onDrop={(e) => {
                                  e.preventDefault();
                                  e.currentTarget.style.background = isBlocked ? 'rgba(239, 68, 68, 0.05)' : 'rgba(30, 41, 59, 0.3)';
                                  
                                  const customerData = e.dataTransfer.getData('customer');
                                  if (customerData) {
                                    const customer = JSON.parse(customerData);
                                    scheduleCustomerToTimeSlot(customer, selectedDate, slot.time);
                                  }
                                }}
                                style={{
                                  padding: '8px 12px',
                                  background: isBlocked ? 'rgba(239, 68, 68, 0.05)' : 'rgba(30, 41, 59, 0.3)',
                                  border: `2px solid ${isBlocked ? 'rgba(239, 68, 68, 0.3)' : 'rgba(100, 116, 139, 0.2)'}`,
                                  borderRadius: '6px',
                                  transition: 'all 0.2s',
                                  minHeight: jobsInSlot.length > 0 ? 'auto' : '40px'
                                }}
                              >
                            {/* Time Label */}
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: jobsInSlot.length > 0 ? '6px' : 0 }}>
                              <div style={{
                                fontSize: '11px',
                                fontWeight: 700,
                                color: isBlocked ? '#fca5a5' : '#8b5cf6',
                                minWidth: '65px'
                              }}>
                                {slot.display}
                              </div>
                              
                              {jobsInSlot.length === 0 && (
                                <div style={{ fontSize: '9px', color: '#64748b', fontStyle: 'italic' }}>
                                  Available
                                </div>
                              )}
                            </div>
                            
                            {/* Jobs in this slot */}
                            {jobsInSlot.length > 0 && (
                              <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                                {jobsInSlot.map((job, jobIndex) => {
                                  // Find job number based on time order
                                  const jobNumber = allJobsForDay.findIndex(j => j.id === job.id) + 1;
                                  
                                  // Calculate distance and drive time to next job
                                  const nextJob = allJobsForDay[jobNumber]; // jobNumber is 1-indexed, so this gets the next
                                  let distanceToNext = null;
                                  let driveTimeToNext = null;
                                  
                                  if (nextJob && job.lat && job.lng && nextJob.lat && nextJob.lng) {
                                    distanceToNext = calculateDistance(job.lat, job.lng, nextJob.lat, nextJob.lng);
                                    // Assume 25 mph average speed
                                    driveTimeToNext = Math.round((distanceToNext / 25) * 60); // minutes
                                  }
                                  
                                  return (
                                    <React.Fragment key={job.id}>
                                      <div
                                        draggable
                                        onDragStart={(e) => {
                                          e.dataTransfer.setData('customer', JSON.stringify(job));
                                        }}
                                        style={{
                                          padding: '8px 10px',
                                          background: 'rgba(15, 23, 42, 0.8)',
                                          border: '1px solid rgba(139, 92, 246, 0.3)',
                                          borderRadius: '6px',
                                          cursor: 'grab',
                                          display: 'flex',
                                          gap: '10px',
                                          alignItems: 'flex-start',
                                          position: 'relative'
                                        }}
                                        onMouseDown={(e) => {
                                          e.currentTarget.style.cursor = 'grabbing';
                                        }}
                                        onMouseUp={(e) => {
                                          e.currentTarget.style.cursor = 'grab';
                                        }}
                                      >
                                        {/* Job Number Badge */}
                                        <div style={{
                                          width: '24px',
                                          height: '24px',
                                          borderRadius: '50%',
                                          background: 'rgba(139, 92, 246, 0.3)',
                                          border: '2px solid rgba(139, 92, 246, 0.6)',
                                          display: 'flex',
                                          alignItems: 'center',
                                          justifyContent: 'center',
                                          fontSize: '11px',
                                          fontWeight: 700,
                                          color: '#c4b5fd',
                                          flexShrink: 0
                                        }}>
                                          {jobNumber}
                                        </div>
                                        
                                        {/* Job Details */}
                                        <div style={{ flex: 1, minWidth: 0 }}>
                                          <div style={{ fontSize: '11px', fontWeight: 600, color: '#f1f5f9', marginBottom: '3px' }}>
                                            {job.name}
                                          </div>
                                          <div style={{ fontSize: '9px', color: '#94a3b8' }}>
                                            ðŸ“ {job.address}
                                          </div>
                                          {job.phone && (
                                            <div style={{ fontSize: '9px', color: '#94a3b8', marginTop: '2px' }}>
                                              ðŸ“± {job.phone}
                                            </div>
                                          )}
                                        </div>
                                        
                                        {/* Action Buttons */}
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '4px', flexShrink: 0 }}>
                                          {/* Up Arrow - Move job earlier */}
                                          {jobNumber > 1 && (
                                            <button
                                              onClick={(e) => {
                                                e.stopPropagation();
                                                const currentIndex = jobNumber - 1; // Convert to 0-indexed
                                                const prevJob = allJobsForDay[currentIndex - 1];
                                                
                                                // Swap scheduled times
                                                setCustomers(prev => prev.map(c => {
                                                  if (c.id === job.id) {
                                                    return { ...c, scheduledTime: prevJob.scheduledTime };
                                                  }
                                                  if (c.id === prevJob.id) {
                                                    return { ...c, scheduledTime: job.scheduledTime };
                                                  }
                                                  return c;
                                                }));
                                              }}
                                              style={{
                                                background: 'rgba(139, 92, 246, 0.1)',
                                                border: '1px solid rgba(139, 92, 246, 0.3)',
                                                borderRadius: '4px',
                                                width: '20px',
                                                height: '20px',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                color: '#8b5cf6',
                                                cursor: 'pointer',
                                                fontSize: '10px',
                                                flexShrink: 0,
                                                padding: 0
                                              }}
                                              title="Move up"
                                            >
                                              â–²
                                            </button>
                                          )}
                                          
                                          {/* Down Arrow - Move job later */}
                                          {jobNumber < allJobsForDay.length && (
                                            <button
                                              onClick={(e) => {
                                                e.stopPropagation();
                                                const currentIndex = jobNumber - 1; // Convert to 0-indexed
                                                const nextJob = allJobsForDay[currentIndex + 1];
                                                
                                                // Swap scheduled times
                                                setCustomers(prev => prev.map(c => {
                                                  if (c.id === job.id) {
                                                    return { ...c, scheduledTime: nextJob.scheduledTime };
                                                  }
                                                  if (c.id === nextJob.id) {
                                                    return { ...c, scheduledTime: job.scheduledTime };
                                                  }
                                                  return c;
                                                }));
                                              }}
                                              style={{
                                                background: 'rgba(139, 92, 246, 0.1)',
                                                border: '1px solid rgba(139, 92, 246, 0.3)',
                                                borderRadius: '4px',
                                                width: '20px',
                                                height: '20px',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                color: '#8b5cf6',
                                                cursor: 'pointer',
                                                fontSize: '10px',
                                                flexShrink: 0,
                                                padding: 0
                                              }}
                                              title="Move down"
                                            >
                                              â–¼
                                            </button>
                                          )}
                                          
                                          {/* Remove Button */}
                                          <button
                                          onClick={(e) => {
                                            e.stopPropagation();
                                            const dateKey = selectedDate.toDateString();
                                            
                                            // Remove from day-specific route
                                            setRoutesByDay(prev => ({
                                              ...prev,
                                              [dateKey]: (prev[dateKey] || []).filter(r => r.id !== job.id)
                                            }));
                                            
                                            // Remove from old route state
                                            setRoute(prev => prev.filter(r => r.id !== job.id));
                                            
                                            // Unschedule customer
                                            setCustomers(prev => prev.map(c => {
                                              if (c.id === job.id) {
                                                return {
                                                  ...c,
                                                  scheduledDate: null,
                                                  scheduledTime: null,
                                                  status: 'unscheduled',
                                                  routeConfirmed: false
                                                };
                                              }
                                              return c;
                                            }));
                                          }}
                                          style={{
                                            background: 'rgba(239, 68, 68, 0.1)',
                                            border: '1px solid rgba(239, 68, 68, 0.3)',
                                            borderRadius: '4px',
                                            width: '20px',
                                            height: '20px',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            color: '#fca5a5',
                                            cursor: 'pointer',
                                            fontSize: '12px',
                                            flexShrink: 0,
                                            padding: 0
                                          }}
                                          title="Remove from route"
                                        >
                                          âœ•
                                        </button>
                                      </div> {/* Close action buttons container */}
                                    </div> {/* Close job card */}
                                      
                                      {/* Distance and Drive Time to Next Job */}
                                      {distanceToNext !== null && (
                                        <div style={{
                                          display: 'flex',
                                          alignItems: 'center',
                                          justifyContent: 'center',
                                          gap: '6px',
                                          padding: '6px',
                                          fontSize: '9px',
                                          color: '#64748b',
                                          background: 'rgba(100, 116, 139, 0.1)',
                                          borderRadius: '4px',
                                          margin: '4px 0'
                                        }}>
                                          <span>â†“</span>
                                          <span style={{ fontWeight: 600, color: '#94a3b8' }}>
                                            {(distanceToNext || 0).toFixed(1)} mi
                                          </span>
                                          <span>â€¢</span>
                                          <span style={{ fontWeight: 600, color: '#94a3b8' }}>
                                            {driveTimeToNext < 60 
                                              ? `${driveTimeToNext} min` 
                                              : `${Math.floor(driveTimeToNext / 60)}h ${driveTimeToNext % 60}min`
                                            } drive
                                          </span>
                                        </div>
                                      )}
                                    </React.Fragment>
                                  );
                                })}
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                    
                          {/* Down Arrow - Show Later Times */}
                          {visibleEndHour < 20 && (
                            <button
                              onClick={() => setVisibleEndHour(prev => Math.min(20, prev + 1))}
                              style={{
                                width: '100%',
                                padding: '8px',
                                marginTop: '8px',
                                background: 'rgba(139, 92, 246, 0.1)',
                                border: '1px solid rgba(139, 92, 246, 0.3)',
                                borderRadius: '6px',
                                color: '#8b5cf6',
                                cursor: 'pointer',
                                fontSize: '12px',
                                fontWeight: 600,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '6px'
                              }}
                            >
                              â†“ Show Later Times
                            </button>
                          )}
                      </div>
                          </div>
                        );
                    })()}
                  </div>
                  
                  {/* Hidden file input (shared by both upload methods) */}
                  <input
                    ref={fileInputRef}
                    type="file"
                    accept=".csv"
                    multiple
                    onChange={(e) => {
                      handleFileUpload(e.target.files);
                      e.target.value = ''; // Reset so same file can be uploaded again
                    }}
                    style={{ display: 'none' }}
                  />


                  {/* Error Display */}
                  {error && (
                    <div style={{
                      marginTop: '16px',
                      marginBottom: '16px',
                      padding: '16px',
                      background: 'rgba(239, 68, 68, 0.1)',
                      border: '1px solid rgba(239, 68, 68, 0.3)',
                      borderRadius: '12px',
                      fontSize: '13px',
                      color: '#fca5a5'
                    }}>
                      âš ï¸ {error}
                    </div>
                  )}

                  {/* Google Sheets Connection - VISIBLE IN SIDEBAR */}
                  <div style={{
                    padding: '14px',
                    background: 'rgba(34, 197, 94, 0.1)',
                    border: '1px solid rgba(34, 197, 94, 0.3)',
                    borderRadius: '12px',
                    marginBottom: '16px'
                  }}>
                    <div style={{ fontSize: '13px', fontWeight: 600, color: '#4ade80', marginBottom: '10px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                      ðŸ“Š Google Sheets
                      {sheetsConnected && <span style={{ fontSize: '10px', background: 'rgba(34, 197, 94, 0.3)', padding: '2px 6px', borderRadius: '4px' }}>âœ“ Connected</span>}
                    </div>
                    <input
                      type="text"
                      value={googleSheetId}
                      onChange={(e) => setGoogleSheetId(e.target.value)}
                      placeholder="Paste Sheet URL here..."
                      style={{
                        width: '100%',
                        padding: '10px',
                        background: 'rgba(15, 23, 42, 0.8)',
                        border: '1px solid rgba(34, 197, 94, 0.3)',
                        borderRadius: '8px',
                        color: '#f1f5f9',
                        fontSize: '11px',
                        marginBottom: '8px',
                        boxSizing: 'border-box'
                      }}
                    />
                    <div style={{ display: 'flex', gap: '6px' }}>
                      <button
                        onClick={testGoogleSheetsConnection}
                        disabled={sheetSyncing || !googleSheetId}
                        style={{
                          flex: 1,
                          padding: '8px',
                          background: sheetSyncing ? 'rgba(100, 116, 139, 0.3)' : 'linear-gradient(135deg, #22c55e, #16a34a)',
                          border: 'none',
                          borderRadius: '6px',
                          color: '#fff',
                          fontSize: '11px',
                          fontWeight: 600,
                          cursor: sheetSyncing ? 'not-allowed' : 'pointer',
                          opacity: sheetSyncing || !googleSheetId ? 0.5 : 1
                        }}
                      >
                        {sheetSyncing ? 'â³...' : 'ðŸ”— Test'}
                      </button>
                      {sheetsConnected && (
                        <button
                          onClick={() => syncFromGoogleSheet()}
                          disabled={sheetSyncing}
                          style={{
                            flex: 1,
                            padding: '8px',
                            background: 'linear-gradient(135deg, #8b5cf6, #7c3aed)',
                            border: 'none',
                            borderRadius: '6px',
                            color: '#fff',
                            fontSize: '11px',
                            fontWeight: 600,
                            cursor: 'pointer'
                          }}
                        >
                          ðŸ“¥ Import
                        </button>
                      )}
                    </div>

                    {/* Export to Sheet Section */}
                    {sheetsConnected && (
                      <div style={{ marginTop: '10px' }}>
                        <input
                          type="text"
                          value={appsScriptUrl}
                          onChange={(e) => setAppsScriptUrl(e.target.value)}
                          placeholder="Apps Script Web App URL (optional)"
                          style={{
                            width: '100%',
                            padding: '8px',
                            background: 'rgba(15, 23, 42, 0.8)',
                            border: '1px solid rgba(245, 158, 11, 0.3)',
                            borderRadius: '6px',
                            color: '#f1f5f9',
                            fontSize: '10px',
                            marginBottom: '6px',
                            boxSizing: 'border-box'
                          }}
                        />
                        <button
                          onClick={exportToGoogleSheet}
                          disabled={sheetExporting}
                          style={{
                            width: '100%',
                            padding: '8px',
                            background: sheetExporting ? 'rgba(100, 116, 139, 0.3)' : 'linear-gradient(135deg, #f59e0b, #d97706)',
                            border: 'none',
                            borderRadius: '6px',
                            color: '#fff',
                            fontSize: '11px',
                            fontWeight: 600,
                            cursor: sheetExporting ? 'not-allowed' : 'pointer'
                          }}
                        >
                          {sheetExporting ? 'â³ Exporting...' : (appsScriptUrl ? 'ðŸ“¤ Export to Sheet' : 'ðŸ“¤ Download CSV')}
                        </button>
                        {lastSheetExport && (
                          <div style={{ fontSize: '9px', color: '#64748b', marginTop: '4px', textAlign: 'center' }}>
                            Last export: {lastSheetExport.toLocaleString()}
                          </div>
                        )}
                      </div>
                    )}
                  </div>

                  {/* Customer Summary */}
                  {(uploadedFiles.length > 0 || savedLists.length > 0) && (
                    <div style={{
                      padding: '16px',
                      background: 'rgba(139, 92, 246, 0.1)',
                      border: '1px solid rgba(139, 92, 246, 0.2)',
                      borderRadius: '12px',
                      marginBottom: '16px'
                    }}>
                      <div style={{ fontSize: '12px', color: '#94a3b8', marginBottom: '8px', fontWeight: 600 }}>
                        ðŸ“Š ACTIVE SITES
                      </div>
                      <div style={{ fontSize: '24px', fontWeight: 800, color: '#f1f5f9', lineHeight: 1, marginBottom: '8px' }}>
                        {customers.length}
                        <span style={{ fontSize: '12px', color: '#64748b', marginLeft: '6px', fontWeight: 400 }}>
                          (unique)
                        </span>
                      </div>
                      <div style={{ fontSize: '11px', color: '#94a3b8', display: 'flex', gap: '12px' }}>
                        {uploadedFiles.length > 0 && (
                          <span>
                            ðŸ“„ {uploadedFiles.filter(f => f.visible).length}/{uploadedFiles.length} files
                          </span>
                        )}
                        {savedLists.length > 0 && (
                          <span>
                            ðŸ“¡ {savedLists.filter(l => l.visible).length}/{savedLists.length} lists
                          </span>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Hidden file input (shared by both upload methods) */}
                  <input
                    ref={fileInputRef}
                    type="file"
                    accept=".csv"
                    multiple
                    onChange={(e) => {
                      handleFileUpload(e.target.files);
                      e.target.value = ''; // Reset so same file can be uploaded again
                    }}
                    style={{ display: 'none' }}
                  />

                </div>
              </div>

              {/* Map Container */}
              <div style={{ flex: 1, position: 'relative', display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
                {/* Compact Filter Bar - Top of Map */}
                {currentView === 'map' && customers.length > 0 && (
                  <div style={{
                    position: 'absolute',
                    top: '12px',
                    left: '12px',
                    right: '420px',
                    zIndex: 1001,
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '8px'
                  }}>
                    {/* Collapsed: just a small toggle button */}
                    {!showFilterPanel ? (
                      <button
                        onClick={() => setShowFilterPanel(true)}
                        style={{
                          alignSelf: 'flex-start',
                          padding: '6px 14px',
                          fontSize: '12px',
                          fontWeight: 600,
                          background: 'rgba(10, 14, 39, 0.88)',
                          backdropFilter: 'blur(16px)',
                          border: '1px solid rgba(139, 92, 246, 0.3)',
                          borderRadius: '10px',
                          color: '#a78bfa',
                          cursor: 'pointer',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '6px'
                        }}
                      >
                        Filters
                        {(() => {
                          const cnt = [statusFilter !== 'all', stateFilter, cityFilter, zipFilter, lastServiceFilter,
                            activeFilters.verifiedSolar, activeFilters.existingJob, activeFilters.recurring, activeFilters.minPanels,
                            preferredDateFilter.length > 0, preferredTimeFilter.length > 0].filter(Boolean).length;
                          return cnt > 0 ? <span style={{ background: 'rgba(139,92,246,0.4)', padding: '1px 7px', borderRadius: '8px', fontSize: '10px', color: '#fff' }}>{cnt}</span> : null;
                        })()}
                        <span style={{ fontSize: '10px' }}>â–¼</span>
                      </button>
                    ) : (
                    <>
                    {/* Row 1: Status pills + Location + Service date */}
                    <div style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '6px',
                      flexWrap: 'wrap',
                      background: 'rgba(10, 14, 39, 0.88)',
                      backdropFilter: 'blur(16px)',
                      border: '1px solid rgba(139, 92, 246, 0.2)',
                      borderRadius: '12px',
                      padding: '8px 12px'
                    }}>
                      {/* Status pills */}
                      {[
                        { value: 'all', label: 'All' },
                        { value: 'unscheduled', label: 'Unscheduled', color: '#ef4444' },
                        { value: 'scheduled', label: 'Scheduled', color: '#eab308' }
                      ].map(s => (
                        <button
                          key={s.value}
                          onClick={() => setStatusFilter(statusFilter === s.value ? 'all' : s.value)}
                          style={{
                            padding: '4px 10px',
                            fontSize: '11px',
                            fontWeight: 600,
                            border: 'none',
                            borderRadius: '6px',
                            cursor: 'pointer',
                            transition: 'all 0.15s',
                            background: statusFilter === s.value
                              ? (s.color ? `${s.color}33` : 'rgba(139, 92, 246, 0.3)')
                              : 'rgba(30, 41, 59, 0.4)',
                            color: statusFilter === s.value
                              ? (s.color || '#a78bfa')
                              : '#94a3b8',
                            boxShadow: statusFilter === s.value
                              ? `0 0 0 1px ${s.color || 'rgba(139, 92, 246, 0.5)'}`
                              : 'none'
                          }}
                        >
                          {s.label}
                        </button>
                      ))}

                      <div style={{ width: '1px', height: '20px', background: 'rgba(100, 116, 139, 0.3)', margin: '0 4px' }} />

                      {/* Location selects - inline */}
                      <select
                        value={stateFilter}
                        onChange={(e) => { setStateFilter(e.target.value); setCityFilter(''); }}
                        style={{
                          padding: '4px 6px',
                          fontSize: '11px',
                          background: stateFilter ? 'rgba(139, 92, 246, 0.2)' : 'rgba(30, 41, 59, 0.5)',
                          border: stateFilter ? '1px solid rgba(139, 92, 246, 0.4)' : '1px solid rgba(100, 116, 139, 0.2)',
                          borderRadius: '6px',
                          color: '#f1f5f9',
                          cursor: 'pointer',
                          maxWidth: '90px'
                        }}
                      >
                        <option value="">State</option>
                        {[...new Set(customers.map(c => c.state).filter(Boolean))].sort().map(state => (
                          <option key={state} value={state}>{state}</option>
                        ))}
                      </select>
                      <select
                        value={cityFilter}
                        onChange={(e) => setCityFilter(e.target.value)}
                        style={{
                          padding: '4px 6px',
                          fontSize: '11px',
                          background: cityFilter ? 'rgba(139, 92, 246, 0.2)' : 'rgba(30, 41, 59, 0.5)',
                          border: cityFilter ? '1px solid rgba(139, 92, 246, 0.4)' : '1px solid rgba(100, 116, 139, 0.2)',
                          borderRadius: '6px',
                          color: '#f1f5f9',
                          cursor: 'pointer',
                          maxWidth: '110px'
                        }}
                      >
                        <option value="">City</option>
                        {[...new Set(customers.filter(c => !stateFilter || c.state === stateFilter).map(c => c.city).filter(Boolean))].sort().map(city => (
                          <option key={city} value={city}>{city}</option>
                        ))}
                      </select>
                      <input
                        type="text"
                        value={zipFilter}
                        onChange={(e) => setZipFilter(e.target.value)}
                        placeholder="ZIP"
                        style={{
                          padding: '4px 6px',
                          fontSize: '11px',
                          background: zipFilter ? 'rgba(139, 92, 246, 0.2)' : 'rgba(30, 41, 59, 0.5)',
                          border: zipFilter ? '1px solid rgba(139, 92, 246, 0.4)' : '1px solid rgba(100, 116, 139, 0.2)',
                          borderRadius: '6px',
                          color: '#f1f5f9',
                          width: '60px',
                          boxSizing: 'border-box'
                        }}
                      />

                      <div style={{ width: '1px', height: '20px', background: 'rgba(100, 116, 139, 0.3)', margin: '0 4px' }} />

                      {/* Last service dropdown */}
                      <select
                        value={lastServiceFilter}
                        onChange={(e) => setLastServiceFilter(e.target.value)}
                        style={{
                          padding: '4px 6px',
                          fontSize: '11px',
                          background: lastServiceFilter ? 'rgba(251, 191, 36, 0.2)' : 'rgba(30, 41, 59, 0.5)',
                          border: lastServiceFilter ? '1px solid rgba(251, 191, 36, 0.4)' : '1px solid rgba(100, 116, 139, 0.2)',
                          borderRadius: '6px',
                          color: lastServiceFilter ? '#fbbf24' : '#f1f5f9',
                          cursor: 'pointer',
                          maxWidth: '130px'
                        }}
                      >
                        <option value="">Last Service</option>
                        <option value="3months">3+ months ago</option>
                        <option value="6months">6+ months ago</option>
                        <option value="12months">12+ months ago</option>
                      </select>

                      <div style={{ flex: 1 }} />
                      <button
                        onClick={() => setShowFilterPanel(false)}
                        title="Hide filters"
                        style={{
                          padding: '3px 8px',
                          fontSize: '10px',
                          fontWeight: 600,
                          background: 'rgba(100, 116, 139, 0.2)',
                          border: '1px solid rgba(100, 116, 139, 0.3)',
                          borderRadius: '6px',
                          color: '#94a3b8',
                          cursor: 'pointer'
                        }}
                      >â–² Hide</button>
                    </div>

                    {/* Row 2: Toggle chips + panels + results count */}
                    <div style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '6px',
                      flexWrap: 'wrap',
                      background: 'rgba(10, 14, 39, 0.88)',
                      backdropFilter: 'blur(16px)',
                      border: '1px solid rgba(139, 92, 246, 0.15)',
                      borderRadius: '12px',
                      padding: '6px 12px'
                    }}>
                      {/* Toggle chips */}
                      {[
                        { key: 'verifiedSolar', label: 'ðŸ›° Has Solar (filter)', color: '#8b5cf6' },
                        { key: 'existingJob', label: 'ðŸ¦• Past', color: '#22c55e' },
                        { key: 'recurring', label: 'ðŸ¦– Recurring', color: '#3b82f6' }
                      ].map(chip => (
                        <button
                          key={chip.key}
                          onClick={() => setActiveFilters(prev => ({ ...prev, [chip.key]: !prev[chip.key] }))}
                          style={{
                            padding: '3px 10px',
                            fontSize: '11px',
                            fontWeight: 600,
                            border: 'none',
                            borderRadius: '6px',
                            cursor: 'pointer',
                            transition: 'all 0.15s',
                            background: activeFilters[chip.key] ? `${chip.color}30` : 'rgba(30, 41, 59, 0.4)',
                            color: activeFilters[chip.key] ? chip.color : '#94a3b8',
                            boxShadow: activeFilters[chip.key] ? `0 0 0 1px ${chip.color}80` : 'none'
                          }}
                        >
                          {chip.label}
                        </button>
                      ))}

                      <div style={{ width: '1px', height: '18px', background: 'rgba(100, 116, 139, 0.3)', margin: '0 2px' }} />

                      {/* Min panels inline */}
                      <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                        <span style={{ fontSize: '11px', color: '#94a3b8' }}>Min panels:</span>
                        <input
                          type="number"
                          value={activeFilters.minPanels}
                          onChange={(e) => setActiveFilters(prev => ({ ...prev, minPanels: e.target.value }))}
                          placeholder="0"
                          min="0"
                          style={{
                            width: '48px',
                            padding: '3px 6px',
                            fontSize: '11px',
                            background: activeFilters.minPanels ? 'rgba(139, 92, 246, 0.2)' : 'rgba(30, 41, 59, 0.5)',
                            border: activeFilters.minPanels ? '1px solid rgba(139, 92, 246, 0.4)' : '1px solid rgba(100, 116, 139, 0.2)',
                            borderRadius: '6px',
                            color: '#f1f5f9',
                            boxSizing: 'border-box'
                          }}
                        />
                      </div>

                      {/* Scheduled view controls - week/month toggle + needs scheduling */}
                      {statusFilter === 'scheduled' && (
                        <>
                          <div style={{ width: '1px', height: '18px', background: 'rgba(100, 116, 139, 0.3)', margin: '0 2px' }} />
                          {/* Week / Month toggle */}
                          {['week', 'month'].map(view => (
                            <button
                              key={view}
                              onClick={() => setScheduledMapView(view)}
                              style={{
                                padding: '3px 8px',
                                fontSize: '11px',
                                fontWeight: 600,
                                border: 'none',
                                borderRadius: '6px',
                                cursor: 'pointer',
                                background: scheduledMapView === view ? 'rgba(234, 179, 8, 0.25)' : 'rgba(30, 41, 59, 0.4)',
                                color: scheduledMapView === view ? '#fbbf24' : '#94a3b8',
                                boxShadow: scheduledMapView === view ? '0 0 0 1px rgba(234, 179, 8, 0.5)' : 'none'
                              }}
                            >
                              {view === 'week' ? 'ðŸ“… Week' : 'ðŸ—“ï¸ Month'}
                            </button>
                          ))}
                          {/* Needs Scheduling toggle */}
                          <button
                            onClick={() => setShowNeedScheduling(!showNeedScheduling)}
                            style={{
                              padding: '3px 8px',
                              fontSize: '11px',
                              fontWeight: 600,
                              border: 'none',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              background: showNeedScheduling ? 'rgba(100, 116, 139, 0.3)' : 'rgba(30, 41, 59, 0.4)',
                              color: showNeedScheduling ? '#cbd5e1' : '#94a3b8',
                              boxShadow: showNeedScheduling ? '0 0 0 1px rgba(100, 116, 139, 0.5)' : 'none'
                            }}
                          >
                            {showNeedScheduling ? 'ðŸ‘ï¸' : 'ðŸ‘ï¸â€ðŸ—¨ï¸'} Needs Sched
                          </button>
                        </>
                      )}

                      {/* Preferred time chips - only when unscheduled */}
                      {statusFilter === 'unscheduled' && (
                        <>
                          <div style={{ width: '1px', height: '18px', background: 'rgba(100, 116, 139, 0.3)', margin: '0 2px' }} />
                          {['morning', 'afternoon', 'evening'].map(tw => {
                            const isOn = preferredTimeFilter.includes(tw);
                            const icon = tw === 'morning' ? 'ðŸŒ…' : tw === 'afternoon' ? 'â˜€ï¸' : 'ðŸŒ†';
                            return (
                              <button
                                key={tw}
                                onClick={() => {
                                  if (isOn) setPreferredTimeFilter(prev => prev.filter(t => t !== tw));
                                  else setPreferredTimeFilter(prev => [...prev, tw]);
                                }}
                                style={{
                                  padding: '3px 8px',
                                  fontSize: '11px',
                                  fontWeight: 600,
                                  border: 'none',
                                  borderRadius: '6px',
                                  cursor: 'pointer',
                                  background: isOn ? 'rgba(239, 68, 68, 0.25)' : 'rgba(30, 41, 59, 0.4)',
                                  color: isOn ? '#fca5a5' : '#94a3b8',
                                  boxShadow: isOn ? '0 0 0 1px rgba(239, 68, 68, 0.5)' : 'none'
                                }}
                                title={tw === 'morning' ? '8am-12pm' : tw === 'afternoon' ? '12pm-4pm' : '4pm-8pm'}
                              >
                                {icon} {tw.charAt(0).toUpperCase() + tw.slice(1, 3)}
                              </button>
                            );
                          })}
                        </>
                      )}

                      {/* Spacer + results + clear */}
                      <div style={{ flex: 1 }} />
                      <span style={{ fontSize: '11px', color: '#22c55e', fontWeight: 700 }}>
                        {filteredCustomers.length} results
                      </span>
                      {(() => {
                        const hasAny = statusFilter !== 'all' || stateFilter || cityFilter || zipFilter ||
                          lastServiceFilter || activeFilters.verifiedSolar || activeFilters.existingJob ||
                          activeFilters.recurring || activeFilters.minPanels || preferredDateFilter.length > 0 ||
                          preferredTimeFilter.length > 0;
                        return hasAny ? (
                          <button
                            onClick={() => {
                              setStatusFilter('all');
                              setStateFilter('');
                              setCityFilter('');
                              setZipFilter('');
                              setLastServiceFilter('');
                              setPreferredDateFilter([]);
                              setPreferredTimeFilter([]);
                              setActiveFilters({ verifiedSolar: false, existingJob: false, recurring: false, minPanels: '', lastService: '' });
                            }}
                            style={{
                              padding: '3px 8px',
                              fontSize: '10px',
                              fontWeight: 600,
                              background: 'rgba(239, 68, 68, 0.2)',
                              border: '1px solid rgba(239, 68, 68, 0.3)',
                              borderRadius: '6px',
                              color: '#fca5a5',
                              cursor: 'pointer'
                            }}
                          >
                            Clear all
                          </button>
                        ) : null;
                      })()}
                    </div>

                    {/* Row 3: Date picker - only when unscheduled */}
                    {statusFilter === 'unscheduled' && (
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                        background: 'rgba(10, 14, 39, 0.88)',
                        backdropFilter: 'blur(16px)',
                        border: '1px solid rgba(239, 68, 68, 0.2)',
                        borderRadius: '12px',
                        padding: '6px 12px'
                      }}>
                        <span style={{ fontSize: '11px', color: '#fca5a5', fontWeight: 600, whiteSpace: 'nowrap' }}>Preferred dates:</span>
                        <button
                          onClick={() => {
                            const newWeek = new Date(filterWeekStart);
                            newWeek.setDate(newWeek.getDate() - 7);
                            setFilterWeekStart(newWeek);
                          }}
                          style={{ padding: '2px 6px', fontSize: '10px', background: 'rgba(239, 68, 68, 0.15)', border: '1px solid rgba(239, 68, 68, 0.25)', borderRadius: '4px', color: '#fca5a5', cursor: 'pointer' }}
                        >â—€</button>
                        {getWeekDays(filterWeekStart).map((date, index) => {
                          const dateStr = date.toISOString().split('T')[0];
                          const isSelected = preferredDateFilter.includes(dateStr);
                          const isToday = date.toDateString() === new Date().toDateString();
                          return (
                            <button
                              key={index}
                              onClick={() => {
                                if (isSelected) setPreferredDateFilter(prev => prev.filter(d => d !== dateStr));
                                else setPreferredDateFilter(prev => [...prev, dateStr]);
                              }}
                              style={{
                                padding: '4px 8px',
                                fontSize: '10px',
                                fontWeight: 700,
                                border: 'none',
                                borderRadius: '6px',
                                cursor: 'pointer',
                                background: isSelected ? 'rgba(239, 68, 68, 0.3)' : isToday ? 'rgba(59, 130, 246, 0.15)' : 'rgba(30, 41, 59, 0.4)',
                                color: isSelected ? '#fca5a5' : '#f1f5f9',
                                boxShadow: isSelected ? '0 0 0 1px rgba(239, 68, 68, 0.5)' : 'none',
                                display: 'flex',
                                flexDirection: 'column',
                                alignItems: 'center',
                                lineHeight: 1.2,
                                minWidth: '36px'
                              }}
                            >
                              <span style={{ fontSize: '8px', color: '#64748b', fontWeight: 600 }}>{date.toLocaleDateString('en-US', { weekday: 'short' })}</span>
                              <span>{date.getDate()}</span>
                            </button>
                          );
                        })}
                        <button
                          onClick={() => {
                            const newWeek = new Date(filterWeekStart);
                            newWeek.setDate(newWeek.getDate() + 7);
                            setFilterWeekStart(newWeek);
                          }}
                          style={{ padding: '2px 6px', fontSize: '10px', background: 'rgba(239, 68, 68, 0.15)', border: '1px solid rgba(239, 68, 68, 0.25)', borderRadius: '4px', color: '#fca5a5', cursor: 'pointer' }}
                        >â–¶</button>
                        {preferredDateFilter.length > 0 && (
                          <button
                            onClick={() => setPreferredDateFilter([])}
                            style={{ padding: '2px 8px', fontSize: '10px', background: 'rgba(239, 68, 68, 0.15)', border: '1px solid rgba(239, 68, 68, 0.25)', borderRadius: '4px', color: '#fca5a5', cursor: 'pointer', fontWeight: 600 }}
                          >Clear</button>
                        )}
                      </div>
                    )}

                    {/* Row 3b: Week/Month navigator - only when scheduled */}
                    {statusFilter === 'scheduled' && (
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                        background: 'rgba(10, 14, 39, 0.88)',
                        backdropFilter: 'blur(16px)',
                        border: '1px solid rgba(234, 179, 8, 0.2)',
                        borderRadius: '12px',
                        padding: '6px 12px',
                        flexWrap: 'wrap'
                      }}>
                        <span style={{ fontSize: '11px', color: '#fbbf24', fontWeight: 600, whiteSpace: 'nowrap' }}>
                          {scheduledMapView === 'week' ? 'Week:' : 'Month:'}
                        </span>
                        <button
                          onClick={() => {
                            const d = new Date(scheduledViewWeekStart);
                            if (scheduledMapView === 'week') d.setDate(d.getDate() - 7);
                            else d.setMonth(d.getMonth() - 1);
                            setScheduledViewWeekStart(d);
                          }}
                          style={{ padding: '2px 6px', fontSize: '10px', background: 'rgba(234, 179, 8, 0.15)', border: '1px solid rgba(234, 179, 8, 0.25)', borderRadius: '4px', color: '#fbbf24', cursor: 'pointer' }}
                        >â—€</button>

                        {scheduledMapView === 'week' ? (
                          // Show days of the week with color-coded dots
                          getWeekDays(scheduledViewWeekStart).map((date, index) => {
                            const dayColor = DAY_COLORS[date.getDay()];
                            const isToday = date.toDateString() === new Date().toDateString();
                            const routesOnDay = savedRoutes.filter(r => !r.sentToTech && new Date(r.scheduledDate).toDateString() === date.toDateString());
                            const jobCount = routesOnDay.reduce((sum, r) => sum + r.customers.length, 0);
                            return (
                              <div key={index} style={{
                                display: 'flex',
                                flexDirection: 'column',
                                alignItems: 'center',
                                padding: '3px 6px',
                                borderRadius: '6px',
                                background: isToday ? 'rgba(59, 130, 246, 0.15)' : 'rgba(30, 41, 59, 0.4)',
                                border: `1px solid ${jobCount > 0 ? dayColor.color + '55' : 'transparent'}`,
                                minWidth: '36px',
                                lineHeight: 1.2
                              }}>
                                <span style={{ fontSize: '8px', color: dayColor.color, fontWeight: 700 }}>{dayColor.label}</span>
                                <span style={{ fontSize: '11px', color: '#f1f5f9', fontWeight: 600 }}>{date.getDate()}</span>
                                {jobCount > 0 && (
                                  <span style={{ fontSize: '8px', color: dayColor.color, fontWeight: 700 }}>{jobCount} jobs</span>
                                )}
                              </div>
                            );
                          })
                        ) : (
                          // Month view: show month name
                          <span style={{ fontSize: '13px', color: '#f1f5f9', fontWeight: 600 }}>
                            {scheduledViewWeekStart.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                          </span>
                        )}

                        <button
                          onClick={() => {
                            const d = new Date(scheduledViewWeekStart);
                            if (scheduledMapView === 'week') d.setDate(d.getDate() + 7);
                            else d.setMonth(d.getMonth() + 1);
                            setScheduledViewWeekStart(d);
                          }}
                          style={{ padding: '2px 6px', fontSize: '10px', background: 'rgba(234, 179, 8, 0.15)', border: '1px solid rgba(234, 179, 8, 0.25)', borderRadius: '4px', color: '#fbbf24', cursor: 'pointer' }}
                        >â–¶</button>

                        <button
                          onClick={() => {
                            const d = new Date(); d.setDate(d.getDate() - d.getDay()); d.setHours(0,0,0,0);
                            setScheduledViewWeekStart(d);
                          }}
                          style={{ padding: '2px 8px', fontSize: '10px', background: 'rgba(234, 179, 8, 0.15)', border: '1px solid rgba(234, 179, 8, 0.25)', borderRadius: '4px', color: '#fbbf24', cursor: 'pointer', fontWeight: 600 }}
                        >Today</button>
                      </div>
                    )}
                    </>
                    )}
                  </div>
                )}

                {/* Map - takes remaining space */}
                <div
                  ref={mapRef}
                  style={{
                    flex: 1,
                    width: '100%',
                    position: 'relative',
                    background: '#0a0e27'
                  }}
                />

                {/* Scheduled View - Day Color Legend */}
                {statusFilter === 'scheduled' && currentView === 'map' && (
                  <div style={{
                    position: 'absolute',
                    bottom: '20px',
                    left: '20px',
                    zIndex: 1000,
                    background: 'rgba(10, 14, 39, 0.92)',
                    backdropFilter: 'blur(12px)',
                    border: '1px solid rgba(234, 179, 8, 0.3)',
                    borderRadius: '10px',
                    padding: '10px 14px',
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '4px'
                  }}>
                    <div style={{ fontSize: '10px', fontWeight: 700, color: '#fbbf24', marginBottom: '2px' }}>Route Days</div>
                    {(() => {
                      let rangeStart, rangeEnd;
                      if (scheduledMapView === 'week') {
                        rangeStart = new Date(scheduledViewWeekStart); rangeStart.setHours(0,0,0,0);
                        rangeEnd = new Date(rangeStart); rangeEnd.setDate(rangeEnd.getDate() + 6); rangeEnd.setHours(23,59,59,999);
                      } else {
                        rangeStart = new Date(scheduledViewWeekStart.getFullYear(), scheduledViewWeekStart.getMonth(), 1);
                        rangeEnd = new Date(scheduledViewWeekStart.getFullYear(), scheduledViewWeekStart.getMonth() + 1, 0, 23,59,59,999);
                      }
                      const activeDays = new Set();
                      savedRoutes.forEach(r => {
                        if (r.sentToTech) return;
                        const d = new Date(r.scheduledDate);
                        if (d >= rangeStart && d <= rangeEnd) activeDays.add(d.getDay());
                      });
                      return Array.from(activeDays).sort().map(dayNum => {
                        const info = DAY_COLORS[dayNum];
                        return (
                          <div key={dayNum} style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                            <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: info.color }} />
                            <span style={{ fontSize: '10px', color: '#cbd5e1', fontWeight: 600 }}>{info.label}</span>
                          </div>
                        );
                      });
                    })()}
                    {showNeedScheduling && (
                      <div style={{ display: 'flex', alignItems: 'center', gap: '6px', marginTop: '2px', borderTop: '1px solid rgba(100, 116, 139, 0.3)', paddingTop: '4px' }}>
                        <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: '#64748b' }} />
                        <span style={{ fontSize: '10px', color: '#94a3b8', fontWeight: 600 }}>Needs Scheduling</span>
                      </div>
                    )}
                  </div>
                )}

                {/* Right Sidebar - Absolutely positioned over map */}
                {currentView === 'map' && customers.length > 0 && (
                  <div style={{
                    position: 'absolute',
                    top: 0,
                    right: 0,
                    bottom: 0,
                    width: '380px',
                    background: 'rgba(15, 23, 42, 0.95)',
                    backdropFilter: 'blur(20px)',
                    borderLeft: '2px solid rgba(139, 92, 246, 0.2)',
                    display: 'flex',
                    flexDirection: 'column',
                    overflow: 'hidden',
                    boxShadow: '-10px 0 30px rgba(0, 0, 0, 0.3)',
                    zIndex: 1000
                  }}>
                    {/* Header */}
                    <div style={{
                      padding: '12px',
                      borderBottom: '1px solid rgba(139, 92, 246, 0.2)',
                      background: 'rgba(15, 23, 42, 0.8)'
                    }}>
                      <h3 style={{ fontSize: '16px', fontWeight: 700, margin: 0, marginBottom: '8px' }}>
                        {mapBounds ? filteredCustomers.filter(c => c.lat && c.lng && mapBounds.contains([c.lat, c.lng])).length : filteredCustomers.length} Properties in View
                      </h3>
                      <p style={{ fontSize: '12px', color: '#94a3b8', margin: 0, marginBottom: '12px' }}>
                        {customers.filter(c => c.solarVerified === 'yes').length} verified solar installations
                      </p>
                      
                      {/* Quick Save List Button */}
                      {filteredCustomers.length > 0 && (
                        <button
                          onClick={() => {
                            const listName = prompt(`Save current filter results (${filteredCustomers.length} customers)`, `Filtered List - ${new Date().toLocaleDateString()}`);
                            if (!listName || !listName.trim()) return;
                            
                            const newList = {
                              id: Date.now().toString(),
                              name: listName.trim(),
                              customers: filteredCustomers.map(c => ({
                                ...c,
                                fileId: Date.now().toString(),
                                fileName: listName.trim()
                              })),
                              count: filteredCustomers.length,
                              visible: true,
                              type: 'list',
                              createdAt: new Date().toISOString()
                            };
                            
                            setSavedLists(prev => [...prev.map(l => ({ ...l, visible: false })), newList]);
                            setUploadedFiles(prev => prev.map(f => ({ ...f, visible: false })));
                            // Clear radius/draw if active
                            if (radiusMode || referencePoint || drawnArea) {
                              setRadiusMode(false);
                              setAwaitingMapClick(false);
                              setDrawMode(false);
                              clearRadius();
                              clearDrawnArea();
                            }
                            alert(`Saved "${listName}" with ${filteredCustomers.length} customers!`);
                          }}
                          style={{
                            width: '100%',
                            padding: '10px',
                            marginBottom: '12px',
                            background: 'rgba(139, 92, 246, 0.2)',
                            border: '1px solid rgba(139, 92, 246, 0.4)',
                            borderRadius: '8px',
                            color: '#c4b5fd',
                            fontSize: '12px',
                            fontWeight: 600,
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: '8px',
                            transition: 'all 0.2s'
                          }}
                          onMouseEnter={(e) => {
                            e.currentTarget.style.background = 'rgba(139, 92, 246, 0.3)';
                            e.currentTarget.style.borderColor = 'rgba(139, 92, 246, 0.6)';
                          }}
                          onMouseLeave={(e) => {
                            e.currentTarget.style.background = 'rgba(139, 92, 246, 0.2)';
                            e.currentTarget.style.borderColor = 'rgba(139, 92, 246, 0.4)';
                          }}
                        >
                          ðŸ’¾ Quick Save This List ({filteredCustomers.length})
                        </button>
                      )}
                      
                      {/* Sorting Controls */}
                      <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                        <select
                          value={sortBy}
                          onChange={(e) => {
                            setSortBy(e.target.value);
                            if (e.target.value !== 'none' && !sortOrder) {
                              setSortOrder('asc');
                            }
                          }}
                          style={{
                            flex: 1,
                            padding: '8px',
                            background: 'rgba(30, 41, 59, 0.5)',
                            border: '1px solid rgba(139, 92, 246, 0.3)',
                            borderRadius: '6px',
                            color: '#f1f5f9',
                            fontSize: '12px',
                            cursor: 'pointer'
                          }}
                        >
                          <option value="none">No Sorting</option>
                          <option value="lastService">Last Service Date</option>
                          <option value="zip">ZIP Code</option>
                          <option value="panels">Panel Count</option>
                        </select>
                        
                        {sortBy !== 'none' && (
                          <button
                            onClick={() => setSortOrder(prev => prev === 'asc' ? 'desc' : 'asc')}
                            style={{
                              padding: '8px 12px',
                              background: 'rgba(139, 92, 246, 0.2)',
                              border: '1px solid rgba(139, 92, 246, 0.3)',
                              borderRadius: '6px',
                              color: '#f1f5f9',
                              fontSize: '12px',
                              cursor: 'pointer',
                              fontWeight: 600
                            }}
                            title={sortOrder === 'asc' ? 'Ascending' : 'Descending'}
                          >
                            {sortOrder === 'asc' ? 'â†‘' : 'â†“'}
                          </button>
                        )}
                      </div>
                    </div>
                    
                    {/* Scrollable List */}
                    <div className="scrollbar-custom" style={{ flex: 1, overflow: 'auto' }}>
                      {(() => {
                        // Filter to only show customers visible in current map bounds
                        const visibleInMap = mapBounds 
                          ? filteredCustomers.filter(customer => {
                              if (!customer.lat || !customer.lng) return false;
                              return mapBounds.contains([customer.lat, customer.lng]);
                            })
                          : filteredCustomers;
                        
                        if (visibleInMap.length === 0) {
                          return (
                            <div style={{ 
                              textAlign: 'center', 
                              padding: '60px 20px', 
                              color: '#64748b' 
                            }}>
                              <div style={{ fontSize: '48px', marginBottom: '16px' }}>ðŸ”</div>
                              <div style={{ fontSize: '16px', fontWeight: 600, marginBottom: '8px' }}>
                                No customers match filters
                              </div>
                              <div style={{ fontSize: '13px' }}>
                                Try adjusting your filter settings
                              </div>
                            </div>
                          );
                        }
                        
                        return visibleInMap.map((customer, index) => {
                        const isHovered = hoveredCustomer?.id === customer.id;
                        const isSelected = selectedCustomer?.id === customer.id;
                        const verifyIcon = customer.solarVerified === 'no' ? 'âŒ' : 
                                         !customer.solarVerified ? 'ðŸ”' : '';
                        
                        return (
                          <div
                            key={customer.id}
                            draggable
                            onDragStart={(e) => {
                              e.dataTransfer.setData('customer', JSON.stringify(customer));
                              e.currentTarget.style.opacity = '0.5';
                            }}
                            onDragEnd={(e) => {
                              e.currentTarget.style.opacity = '1';
                            }}
                            onMouseEnter={() => setHoveredCustomer(customer)}
                            onMouseLeave={() => setHoveredCustomer(null)}
                            onClick={() => { setProfileCustomer(customer); setShowCustomerProfile(true); }}
                            style={{
                              padding: '16px 20px',
                              borderBottom: '1px solid rgba(139, 92, 246, 0.1)',
                              cursor: 'grab',
                              transition: 'all 0.2s ease',
                              background: isSelected ? 'rgba(139, 92, 246, 0.15)' : 
                                         isHovered ? 'rgba(139, 92, 246, 0.1)' : 
                                         'transparent',
                              borderLeft: isSelected ? '3px solid #8b5cf6' : '3px solid transparent',
                              position: 'relative'
                            }}
                          >
                            {/* Satellite Preview on Hover */}
                            {isHovered && (
                              <div style={{
                                position: 'absolute',
                                left: '-420px',
                                top: '0',
                                width: '320px',
                                background: 'rgba(15, 23, 42, 0.98)',
                                border: '2px solid rgba(139, 92, 246, 0.4)',
                                borderRadius: '12px',
                                overflow: 'hidden',
                                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)',
                                zIndex: 1000,
                                animation: 'fadeIn 0.2s ease'
                              }}>
                                {/* Satellite Image */}
                                <div style={{ position: 'relative' }}>
                                  {(() => {
                                    const zoom = 20;
                                    const x = Math.floor((customer.lng + 180) / 360 * Math.pow(2, zoom));
                                    const y = Math.floor((1 - Math.log(Math.tan(customer.lat * Math.PI / 180) + 1 / Math.cos(customer.lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom));
                                    return (
                                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', width: '100%' }}>
                                        <img src={`https://mt1.google.com/vt/lyrs=y&x=${x}&y=${y}&z=${zoom}`} style={{ width: '100%', display: 'block' }} alt="" />
                                        <img src={`https://mt1.google.com/vt/lyrs=y&x=${x+1}&y=${y}&z=${zoom}`} style={{ width: '100%', display: 'block' }} alt="" />
                                        <img src={`https://mt1.google.com/vt/lyrs=y&x=${x}&y=${y+1}&z=${zoom}`} style={{ width: '100%', display: 'block' }} alt="" />
                                        <img src={`https://mt1.google.com/vt/lyrs=y&x=${x+1}&y=${y+1}&z=${zoom}`} style={{ width: '100%', display: 'block' }} alt="" />
                                      </div>
                                    );
                                  })()}
                                  
                                  <div style={{
                                    position: 'absolute',
                                    top: '12px',
                                    left: '12px',
                                    background: 'rgba(0,0,0,0.8)',
                                    padding: '6px 12px',
                                    borderRadius: '6px',
                                    fontSize: '11px',
                                    fontWeight: 600
                                  }}>
                                    ðŸ›°ï¸ Satellite View
                                  </div>
                                </div>
                                
                                {/* Quick Info */}
                                <div style={{ padding: '16px' }}>
                                  <div
                                    onClick={(e) => { e.stopPropagation(); setProfileCustomer(customer); setShowCustomerProfile(true); }}
                                    style={{ fontSize: '14px', fontWeight: 600, marginBottom: '8px', cursor: 'pointer' }}
                                    onMouseOver={(e) => e.currentTarget.style.color = '#a78bfa'}
                                    onMouseOut={(e) => e.currentTarget.style.color = '#f1f5f9'}
                                  >
                                    {customer.name}
                                  </div>
                                  <div style={{ fontSize: '12px', color: '#94a3b8' }}>{customer.address}</div>
                                </div>
                              </div>
                            )}
                            
                            {/* Card Content */}
                            <div style={{ display: 'flex', gap: '12px', alignItems: 'flex-start' }}>
                              {/* Satellite Thumbnail */}
                              {(() => {
                                const zoom = 19;
                                const x = Math.floor((customer.lng + 180) / 360 * Math.pow(2, zoom));
                                const y = Math.floor((1 - Math.log(Math.tan(customer.lat * Math.PI / 180) + 1 / Math.cos(customer.lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom));
                                return (
                                  <div style={{
                                    width: '60px',
                                    height: '60px',
                                    borderRadius: '8px',
                                    overflow: 'hidden',
                                    flexShrink: 0,
                                    border: '1px solid rgba(139, 92, 246, 0.3)',
                                    position: 'relative',
                                    background: '#0a0e27'
                                  }}>
                                    <img 
                                      src={`https://mt1.google.com/vt/lyrs=y&x=${x}&y=${y}&z=${zoom}`} 
                                      style={{ 
                                        width: '100%', 
                                        height: '100%', 
                                        objectFit: 'cover',
                                        display: 'block'
                                      }} 
                                      alt=""
                                    />
                                    {/* Solar Verification Badge */}
                                    {customer.solarVerified === 'yes' && (
                                      <div style={{
                                        position: 'absolute',
                                        top: '4px',
                                        right: '4px',
                                        background: 'rgba(251, 191, 36, 0.95)',
                                        borderRadius: '50%',
                                        width: '18px',
                                        height: '18px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        fontSize: '10px',
                                        fontWeight: 700,
                                        color: '#000',
                                        boxShadow: '0 2px 4px rgba(0,0,0,0.3)'
                                      }}>
                                        âœ“
                                      </div>
                                    )}
                                    {customer.solarVerified === 'no' && (
                                      <div style={{
                                        position: 'absolute',
                                        top: '4px',
                                        right: '4px',
                                        background: 'rgba(239, 68, 68, 0.95)',
                                        borderRadius: '50%',
                                        width: '18px',
                                        height: '18px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        fontSize: '10px',
                                        fontWeight: 700,
                                        color: '#fff',
                                        boxShadow: '0 2px 4px rgba(0,0,0,0.3)'
                                      }}>
                                        âœ•
                                      </div>
                                    )}
                                  </div>
                                );
                              })()}
                              
                              {/* Info */}
                              <div style={{ flex: 1, minWidth: 0 }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>
                                  <div style={{
                                    fontSize: '18px',
                                    lineHeight: 1,
                                    flexShrink: 0
                                  }}>
                                    {verifyIcon}
                                  </div>
                                  <div
                                    onClick={(e) => { e.stopPropagation(); setProfileCustomer(customer); setShowCustomerProfile(true); }}
                                    style={{
                                    fontSize: '14px',
                                    fontWeight: 600,
                                    color: '#f1f5f9',
                                    overflow: 'hidden',
                                    textOverflow: 'ellipsis',
                                    whiteSpace: 'nowrap',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px',
                                    cursor: 'pointer'
                                  }}
                                    onMouseOver={(e) => e.currentTarget.style.color = '#a78bfa'}
                                    onMouseOut={(e) => e.currentTarget.style.color = '#f1f5f9'}
                                  >
                                    {customer.name}
                                  </div>
                                </div>
                                <div style={{
                                  fontSize: '12px',
                                  color: '#94a3b8',
                                  marginBottom: '8px',
                                  overflow: 'hidden',
                                  textOverflow: 'ellipsis',
                                  whiteSpace: 'nowrap'
                                }}>
                                  {customer.address}
                                </div>
                                
                                {/* Tags */}
                                <div style={{ display: 'flex', gap: '6px', flexWrap: 'wrap' }}>
                                  {customer.status === 'unscheduled' && (
                                    <span style={{
                                      fontSize: '11px',
                                      padding: '3px 8px',
                                      background: 'rgba(239, 68, 68, 0.2)',
                                      border: '1px solid rgba(239, 68, 68, 0.4)',
                                      borderRadius: '4px',
                                      color: '#fca5a5',
                                      fontWeight: 600
                                    }}>
                                      ðŸ”´ Unscheduled
                                    </span>
                                  )}
                                  {customer.status === 'scheduled' && (
                                    <span style={{
                                      fontSize: '11px',
                                      padding: '3px 8px',
                                      background: 'rgba(251, 191, 36, 0.2)',
                                      border: '1px solid rgba(251, 191, 36, 0.4)',
                                      borderRadius: '4px',
                                      color: '#fbbf24',
                                      fontWeight: 600
                                    }}>
                                      ðŸŸ¡ Scheduled
                                    </span>
                                  )}
                                  {customer.routeConfirmed && (
                                    <span style={{
                                      fontSize: '11px',
                                      padding: '3px 8px',
                                      background: 'rgba(34, 197, 94, 0.2)',
                                      border: '1px solid rgba(34, 197, 94, 0.4)',
                                      borderRadius: '4px',
                                      color: '#22c55e',
                                      fontWeight: 600
                                    }}
                                    title={`Confirmed on ${customer.confirmedRouteName || 'route'}`}>
                                      âœ“ Route Saved
                                    </span>
                                  )}
                                  {customer.panelCount && (
                                    <span style={{
                                      fontSize: '11px',
                                      padding: '3px 8px',
                                      background: 'rgba(251, 191, 36, 0.1)',
                                      border: '1px solid rgba(251, 191, 36, 0.3)',
                                      borderRadius: '4px',
                                      color: '#fbbf24',
                                      fontWeight: 600
                                    }}>
                                      {customer.panelCount} panels
                                    </span>
                                  )}
                                  {(customer.isRecurring || customer.recurring) && (
                                    <span style={{
                                      fontSize: '11px',
                                      padding: '3px 8px',
                                      background: 'rgba(59, 130, 246, 0.2)',
                                      border: '1px solid rgba(59, 130, 246, 0.4)',
                                      borderRadius: '4px',
                                      color: '#3b82f6',
                                      fontWeight: 600
                                    }}>
                                      ðŸ¦– Recurring
                                    </span>
                                  )}
                                  {customer.existingJob && !(customer.isRecurring || customer.recurring) && (
                                    <span style={{
                                      fontSize: '11px',
                                      padding: '3px 8px',
                                      background: 'rgba(34, 197, 94, 0.2)',
                                      border: '1px solid rgba(34, 197, 94, 0.4)',
                                      borderRadius: '4px',
                                      color: '#22c55e',
                                      fontWeight: 600
                                    }}>
                                      ðŸ¦• Past
                                    </span>
                                  )}
                                  {customer.lastServiceDate && (
                                    <span style={{
                                      fontSize: '11px',
                                      padding: '3px 8px',
                                      background: 'rgba(100, 116, 139, 0.2)',
                                      border: '1px solid rgba(100, 116, 139, 0.3)',
                                      borderRadius: '4px',
                                      color: '#94a3b8'
                                    }}>
                                      Last: {new Date(customer.lastServiceDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' })}
                                    </span>
                                  )}
                                  {customer.nextScheduledDate && (customer.isRecurring || customer.recurring) && (
                                    <span style={{
                                      fontSize: '11px',
                                      padding: '3px 8px',
                                      background: 'rgba(59, 130, 246, 0.2)',
                                      border: '1px solid rgba(59, 130, 246, 0.3)',
                                      borderRadius: '4px',
                                      color: '#3b82f6'
                                    }}>
                                      Next: {new Date(customer.nextScheduledDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' })}
                                    </span>
                                  )}
                                  {route.some(r => r.id === customer.id) && (
                                    <span style={{
                                      fontSize: '11px',
                                      padding: '3px 8px',
                                      background: 'rgba(34, 197, 94, 0.1)',
                                      border: '1px solid rgba(34, 197, 94, 0.3)',
                                      borderRadius: '4px',
                                      color: '#22c55e'
                                    }}>
                                      In Route
                                    </span>
                                  )}
                                  {(customer.amountPaid || customer.jobAmount) && (
                                    <span style={{
                                      fontSize: '11px',
                                      padding: '3px 8px',
                                      background: 'rgba(34, 197, 94, 0.15)',
                                      border: '1px solid rgba(34, 197, 94, 0.3)',
                                      borderRadius: '4px',
                                      color: '#22c55e',
                                      fontWeight: 600
                                    }}>
                                      ${customer.amountPaid || customer.jobAmount}
                                    </span>
                                  )}
                                  {customer.tipAmount && (
                                    <span style={{
                                      fontSize: '11px',
                                      padding: '3px 8px',
                                      background: 'rgba(251, 191, 36, 0.15)',
                                      border: '1px solid rgba(251, 191, 36, 0.3)',
                                      borderRadius: '4px',
                                      color: '#fbbf24',
                                      fontWeight: 600
                                    }}>
                                      +${customer.tipAmount} tip
                                    </span>
                                  )}
                                </div>
                              </div>
                              
                              {/* Arrow */}
                              <div style={{
                                color: '#8b5cf6',
                                fontSize: '18px',
                                opacity: isHovered ? 1 : 0.3,
                                transition: 'opacity 0.2s ease',
                                flexShrink: 0
                              }}>
                                â†’
                              </div>
                            </div>
                          </div>
                        );
                      })})()}
                    </div>
                  </div>
                )}
                
                {/* Selected Customer Detail Modal */}
                {selectedCustomer && (
                  <div
                    style={{
                      position: 'fixed',
                      top: 0,
                      left: 0,
                      right: 0,
                      bottom: 0,
                      background: 'rgba(0, 0, 0, 0.7)',
                      backdropFilter: 'blur(4px)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      zIndex: 10000,
                      animation: 'fadeIn 0.2s ease'
                    }}
                    onClick={() => setSelectedCustomer(null)}
                  >
                    <div
                      onClick={(e) => e.stopPropagation()}
                      style={{
                        width: '500px',
                        maxHeight: '90vh',
                        background: 'rgba(15, 23, 42, 0.98)',
                        backdropFilter: 'blur(20px)',
                        border: '2px solid rgba(139, 92, 246, 0.3)',
                        borderRadius: '16px',
                        overflow: 'hidden',
                        boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)',
                        display: 'flex',
                        flexDirection: 'column'
                      }}
                    >
                      {/* Modal Header */}
                      <div style={{
                        padding: '20px 24px',
                        borderBottom: '1px solid rgba(139, 92, 246, 0.2)',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        background: 'rgba(139, 92, 246, 0.05)'
                      }}>
                        <h3 style={{ fontSize: '18px', fontWeight: 700, margin: 0 }}>Site Details</h3>
                        <button
                          onClick={() => setSelectedCustomer(null)}
                          style={{
                            background: 'transparent',
                            border: 'none',
                            color: '#94a3b8',
                            cursor: 'pointer',
                            fontSize: '24px',
                            padding: 0,
                            lineHeight: 1
                          }}
                        >
                          Ã—
                        </button>
                      </div>
                      
                      {/* Scrollable Content */}
                      <div className="scrollbar-custom" style={{ flex: 1, overflow: 'auto', padding: '24px' }}>
                        {/* Satellite Image */}
                        <div style={{ marginBottom: '24px' }}>
                          <div style={{
                            background: 'rgba(139, 92, 246, 0.05)',
                            borderRadius: '12px',
                            overflow: 'hidden',
                            border: '2px solid rgba(139, 92, 246, 0.2)',
                            position: 'relative'
                          }}>
                            {(() => {
                              const zoom = 20;
                              const x = Math.floor((selectedCustomer.lng + 180) / 360 * Math.pow(2, zoom));
                              const y = Math.floor((1 - Math.log(Math.tan(selectedCustomer.lat * Math.PI / 180) + 1 / Math.cos(selectedCustomer.lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom));
                              return (
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', width: '100%' }}>
                                  <img src={`https://mt1.google.com/vt/lyrs=y&x=${x}&y=${y}&z=${zoom}`} style={{ width: '100%', display: 'block' }} alt="" />
                                  <img src={`https://mt1.google.com/vt/lyrs=y&x=${x+1}&y=${y}&z=${zoom}`} style={{ width: '100%', display: 'block' }} alt="" />
                                  <img src={`https://mt1.google.com/vt/lyrs=y&x=${x}&y=${y+1}&z=${zoom}`} style={{ width: '100%', display: 'block' }} alt="" />
                                  <img src={`https://mt1.google.com/vt/lyrs=y&x=${x+1}&y=${y+1}&z=${zoom}`} style={{ width: '100%', display: 'block' }} alt="" />
                                </div>
                              );
                            })()}
                            {/* Solar Verification Badge */}
                            {selectedCustomer.solarVerified === 'yes' && (
                              <div style={{
                                position: 'absolute',
                                top: '16px',
                                right: '16px',
                                background: 'rgba(251, 191, 36, 0.95)',
                                borderRadius: '50%',
                                width: '36px',
                                height: '36px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '18px',
                                fontWeight: 700,
                                color: '#000',
                                boxShadow: '0 4px 12px rgba(0,0,0,0.4)'
                              }}>
                                âœ“
                              </div>
                            )}
                            {selectedCustomer.solarVerified === 'no' && (
                              <div style={{
                                position: 'absolute',
                                top: '16px',
                                right: '16px',
                                background: 'rgba(239, 68, 68, 0.95)',
                                borderRadius: '50%',
                                width: '36px',
                                height: '36px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '18px',
                                fontWeight: 700,
                                color: '#fff',
                                boxShadow: '0 4px 12px rgba(0,0,0,0.4)'
                              }}>
                                âœ•
                              </div>
                            )}
                          </div>
                        </div>
                        
                        {/* Customer Info */}
                        <div style={{ marginBottom: '20px' }}>
                          <div style={{ fontSize: '20px', fontWeight: 700, marginBottom: '12px' }}>{selectedCustomer.name}</div>
                          <div style={{ fontSize: '14px', color: '#94a3b8', marginBottom: '16px' }}>ðŸ“ {selectedCustomer.address}</div>
                          
                          {/* Verification Status */}
                          <div style={{ marginBottom: '16px' }}>
                            {selectedCustomer.solarVerified === 'yes' && (
                              <div style={{
                                padding: '12px 16px',
                                background: 'rgba(251, 191, 36, 0.1)',
                                border: '1px solid rgba(251, 191, 36, 0.3)',
                                borderRadius: '8px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px'
                              }}>
                                <span style={{ fontSize: '20px' }}>âœ“</span>
                                <span style={{ fontSize: '14px', color: '#fbbf24', fontWeight: 600 }}>Has Solar</span>
                              </div>
                            )}
                            {selectedCustomer.solarVerified === 'no' && (
                              <div style={{
                                padding: '12px 16px',
                                background: 'rgba(239, 68, 68, 0.1)',
                                border: '1px solid rgba(239, 68, 68, 0.3)',
                                borderRadius: '8px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px'
                              }}>
                                <span style={{ fontSize: '20px' }}>âŒ</span>
                                <span style={{ fontSize: '14px', color: '#ef4444', fontWeight: 600 }}>No Solar</span>
                              </div>
                            )}
                            {!selectedCustomer.solarVerified && (
                              <div style={{
                                padding: '12px 16px',
                                background: 'rgba(139, 92, 246, 0.1)',
                                border: '1px solid rgba(139, 92, 246, 0.3)',
                                borderRadius: '8px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px'
                              }}>
                                <span style={{ fontSize: '20px' }}>ðŸ”</span>
                                <span style={{ fontSize: '14px', color: '#c4b5fd', fontWeight: 600 }}>Not Confirmed</span>
                              </div>
                            )}
                          </div>
                          
                          {/* Status Section with Dropdown */}
                          <div style={{ marginBottom: '16px' }}>
                            <div style={{
                              padding: '12px 16px',
                              background: selectedCustomer.status === 'unscheduled' ? 'rgba(239, 68, 68, 0.1)' :
                                         selectedCustomer.status === 'scheduled' ? 'rgba(251, 191, 36, 0.1)' :
                                         selectedCustomer.status === 'completed' ? 'rgba(34, 197, 94, 0.1)' :
                                         'rgba(100, 116, 139, 0.1)',
                              border: selectedCustomer.status === 'unscheduled' ? '1px solid rgba(239, 68, 68, 0.3)' :
                                     selectedCustomer.status === 'scheduled' ? '1px solid rgba(251, 191, 36, 0.3)' :
                                     selectedCustomer.status === 'completed' ? '1px solid rgba(34, 197, 94, 0.3)' :
                                     '1px solid rgba(100, 116, 139, 0.3)',
                              borderRadius: '8px',
                              marginBottom: '12px'
                            }}>
                              <div style={{ fontSize: '11px', color: '#64748b', marginBottom: '6px', fontWeight: 600 }}>
                                STATUS
                              </div>
                              <select
                                value={selectedCustomer.status || 'unscheduled'}
                                onChange={(e) => {
                                  const newStatus = e.target.value;
                                  setCustomers(prev => prev.map(c =>
                                    c.id === selectedCustomer.id ? { ...c, status: newStatus } : c
                                  ));
                                  setSelectedCustomer(prev => ({ ...prev, status: newStatus }));
                                }}
                                style={{
                                  width: '100%',
                                  padding: '10px 12px',
                                  background: 'rgba(15, 23, 42, 0.8)',
                                  border: '1px solid rgba(139, 92, 246, 0.3)',
                                  borderRadius: '6px',
                                  color: '#f1f5f9',
                                  fontSize: '14px',
                                  fontWeight: 600,
                                  cursor: 'pointer'
                                }}
                              >
                                <option value="unscheduled">ðŸ”´ Unscheduled</option>
                                <option value="scheduled">ðŸŸ¡ Scheduled</option>
                              </select>

                              {selectedCustomer.status === 'unscheduled' && (
                                <div style={{ marginTop: '10px' }}>
                                  {selectedCustomer.preferredDate && (
                                    <div style={{ fontSize: '12px', color: '#94a3b8', marginBottom: '4px' }}>
                                      <strong style={{ color: '#fca5a5' }}>Preferred Date:</strong>{' '}
                                      {new Date(selectedCustomer.preferredDate).toLocaleDateString('en-US', {
                                        weekday: 'short',
                                        month: 'short',
                                        day: 'numeric',
                                        year: 'numeric'
                                      })}
                                    </div>
                                  )}
                                  {selectedCustomer.preferredTimeWindow && (
                                    <div style={{ fontSize: '12px', color: '#94a3b8' }}>
                                      <strong style={{ color: '#fca5a5' }}>Preferred Time:</strong>{' '}
                                      {selectedCustomer.preferredTimeWindow === 'morning' ? 'ðŸŒ… Morning (8am-12pm)' :
                                       selectedCustomer.preferredTimeWindow === 'afternoon' ? 'â˜€ï¸ Afternoon (12pm-4pm)' :
                                       selectedCustomer.preferredTimeWindow === 'evening' ? 'ðŸŒ† Evening (4pm-8pm)' :
                                       selectedCustomer.preferredTimeWindow}
                                    </div>
                                  )}
                                </div>
                              )}
                            </div>
                          </div>
                          
                          {/* Details Grid */}
                          <div style={{ display: 'grid', gap: '12px' }}>
                            {selectedCustomer.panelCount && (
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <span style={{ fontSize: '18px' }}>â˜€ï¸</span>
                                <span style={{ fontSize: '13px', color: '#94a3b8' }}>{selectedCustomer.panelCount} panels</span>
                              </div>
                            )}
                            {selectedCustomer.email && (
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <span style={{ fontSize: '18px' }}>ðŸ“§</span>
                                <span style={{ fontSize: '13px', color: '#94a3b8' }}>{selectedCustomer.email}</span>
                              </div>
                            )}
                            {selectedCustomer.phone && (
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <span style={{ fontSize: '18px' }}>ðŸ“±</span>
                                <span style={{ fontSize: '13px', color: '#94a3b8' }}>{selectedCustomer.phone}</span>
                              </div>
                            )}
                          </div>
                        </div>
                        
                        {/* Actions */}
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                          <button
                            className="button-primary"
                            onClick={() => {
                              handleCustomerClick(selectedCustomer);
                              setSelectedCustomer(null);
                            }}
                            style={{ width: '100%', justifyContent: 'center', padding: '14px' }}
                          >
                            {route.some(r => r.id === selectedCustomer.id) ? 'âŒ âŒ Remove from Route' : 'âž• ðŸ›¸ Add to Route'}
                          </button>
                          
                          {/* Manual Verification */}
                          {!verificationEditMode ? (
                            <div 
                              onClick={() => setVerificationEditMode(true)}
                              onMouseEnter={(e) => e.currentTarget.querySelector('.edit-icon').style.opacity = '1'}
                              onMouseLeave={(e) => e.currentTarget.querySelector('.edit-icon').style.opacity = '0'}
                              style={{
                                padding: '12px 16px',
                                background: selectedCustomer.solarVerified === 'yes' ? 'rgba(251, 191, 36, 0.1)' :
                                           selectedCustomer.solarVerified === 'no' ? 'rgba(239, 68, 68, 0.1)' :
                                           'rgba(139, 92, 246, 0.1)',
                                border: selectedCustomer.solarVerified === 'yes' ? '1px solid rgba(251, 191, 36, 0.3)' :
                                       selectedCustomer.solarVerified === 'no' ? '1px solid rgba(239, 68, 68, 0.3)' :
                                       '1px solid rgba(139, 92, 246, 0.3)',
                                borderRadius: '8px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between',
                                cursor: 'pointer',
                                transition: 'all 0.2s'
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <span style={{ fontSize: '20px' }}>
                                  {selectedCustomer.solarVerified === 'yes' ? 'âœ“' :
                                   selectedCustomer.solarVerified === 'no' ? 'âŒ' : 'ðŸ”'}
                                </span>
                                <span style={{ 
                                  fontSize: '14px', 
                                  fontWeight: 600,
                                  color: selectedCustomer.solarVerified === 'yes' ? '#fbbf24' :
                                         selectedCustomer.solarVerified === 'no' ? '#ef4444' :
                                         '#c4b5fd'
                                }}>
                                  {selectedCustomer.solarVerified === 'yes' ? 'Has Solar' :
                                   selectedCustomer.solarVerified === 'no' ? 'No Solar' :
                                   'Not Confirmed'}
                                </span>
                              </div>
                              <span className="edit-icon" style={{ fontSize: '16px', opacity: 0, transition: 'opacity 0.2s' }}>âœï¸</span>
                            </div>
                          ) : (
                            <div style={{
                              padding: '16px',
                              background: 'rgba(139, 92, 246, 0.05)',
                              border: '1px solid rgba(139, 92, 246, 0.2)',
                              borderRadius: '8px'
                            }}>
                              <div style={{ fontSize: '12px', fontWeight: 600, color: '#c4b5fd', marginBottom: '8px' }}>
                                Select Solar Status:
                              </div>
                              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '8px' }}>
                                <button
                                  className="button-secondary"
                                  onClick={() => {
                                    markVerified(selectedCustomer.id, 'yes');
                                    setSelectedCustomer(prev => ({ ...prev, solarVerified: 'yes' }));
                                    setVerificationEditMode(false);
                                  }}
                                  style={{ 
                                    background: 'rgba(251, 191, 36, 0.1)', 
                                    borderColor: 'rgba(251, 191, 36, 0.3)', 
                                    color: '#fbbf24', 
                                    padding: '10px', 
                                    fontSize: '12px' 
                                  }}
                                >
                                  âœ“ Yes
                                </button>
                                <button
                                  className="button-secondary"
                                  onClick={() => {
                                    markVerified(selectedCustomer.id, 'no');
                                    setSelectedCustomer(prev => ({ ...prev, solarVerified: 'no' }));
                                    setVerificationEditMode(false);
                                  }}
                                  style={{ 
                                    background: 'rgba(239, 68, 68, 0.1)', 
                                    borderColor: 'rgba(239, 68, 68, 0.3)', 
                                    color: '#ef4444', 
                                    padding: '10px', 
                                    fontSize: '12px' 
                                  }}
                                >
                                  âŒ No
                                </button>
                                <button
                                  className="button-secondary"
                                  onClick={() => {
                                    markVerified(selectedCustomer.id, null);
                                    setSelectedCustomer(prev => ({ ...prev, solarVerified: null }));
                                    setVerificationEditMode(false);
                                  }}
                                  style={{ 
                                    background: 'rgba(139, 92, 246, 0.1)', 
                                    borderColor: 'rgba(139, 92, 246, 0.3)', 
                                    color: '#8b5cf6', 
                                    padding: '10px', 
                                    fontSize: '12px' 
                                  }}
                                >
                                  ðŸ” Not Confirmed
                                </button>
                              </div>
                            </div>
                          )}
                          
                          {/* Existing Job Info - Show if marked as existing */}
                          {selectedCustomer.existingJob && (
                            <div style={{
                              padding: '16px',
                              background: 'rgba(34, 197, 94, 0.1)',
                              border: '1px solid rgba(34, 197, 94, 0.3)',
                              borderRadius: '8px',
                              marginTop: '12px'
                            }}>
                              <div style={{ 
                                fontSize: '13px', 
                                fontWeight: 700, 
                                color: '#22c55e', 
                                marginBottom: '12px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                              }}>
                                ðŸ¦• KNOWN CONTACT INTEL
                              </div>
                              
                              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                {selectedCustomer.totalPanels && (
                                  <div style={{ fontSize: '12px', color: '#94a3b8' }}>
                                    <strong style={{ color: '#22c55e' }}>Total Panels:</strong> {selectedCustomer.totalPanels}
                                  </div>
                                )}
                                {selectedCustomer.lastServiceDate && (
                                  <div style={{ fontSize: '12px', color: '#94a3b8' }}>
                                    <strong style={{ color: '#22c55e' }}>Last Customer:</strong> {new Date(selectedCustomer.lastServiceDate).toLocaleDateString()}
                                  </div>
                                )}
                                {selectedCustomer.amountPaid && (
                                  <div style={{ fontSize: '12px', color: '#94a3b8' }}>
                                    <strong style={{ color: '#22c55e' }}>Last Payment:</strong> ${parseFloat(selectedCustomer.amountPaid || 0).toFixed(2)}
                                  </div>
                                )}
                                {selectedCustomer.isRecurring && (
                                  <div style={{ fontSize: '12px', color: '#22c55e', fontWeight: 600 }}>
                                    ðŸŒ€ Recurring Customer
                                  </div>
                                )}
                              </div>
                            </div>
                          )}
                          
                          {/* Service History Section */}
                          {selectedCustomer.serviceHistory && selectedCustomer.serviceHistory.length > 0 && (
                            <div style={{
                              padding: '16px',
                              background: 'rgba(34, 197, 94, 0.1)',
                              border: '1px solid rgba(34, 197, 94, 0.3)',
                              borderRadius: '8px',
                              marginTop: '12px'
                            }}>
                              <div style={{ 
                                fontSize: '13px', 
                                fontWeight: 700, 
                                color: '#22c55e', 
                                marginBottom: '12px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                              }}>
                                ðŸ“‹ SERVICE HISTORY ({selectedCustomer.serviceHistory.length})
                              </div>
                              
                              <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                {selectedCustomer.serviceHistory.slice().reverse().map((job, index) => (
                                  <div 
                                    key={job.id}
                                    style={{
                                      padding: '12px',
                                      background: 'rgba(15, 23, 42, 0.5)',
                                      border: '1px solid rgba(34, 197, 94, 0.3)',
                                      borderRadius: '8px'
                                    }}
                                  >
                                    {/* Job Header */}
                                    <div style={{ marginBottom: '8px' }}>
                                      <div style={{ fontSize: '12px', fontWeight: 600, color: '#f1f5f9', marginBottom: '2px' }}>
                                        {job.jobType || 'Panel Cleaning'}
                                      </div>
                                      <div style={{ fontSize: '10px', color: '#94a3b8' }}>
                                        ðŸ“… {new Date(job.date).toLocaleDateString('en-US', { 
                                          month: 'short', 
                                          day: 'numeric', 
                                          year: 'numeric' 
                                        })}
                                      </div>
                                    </div>
                                    
                                    {/* Job Details Grid */}
                                    <div style={{ 
                                      display: 'grid', 
                                      gridTemplateColumns: '1fr 1fr',
                                      gap: '6px',
                                      marginBottom: '8px'
                                    }}>
                                      {job.cost > 0 && (
                                        <div style={{ fontSize: '11px', color: '#94a3b8' }}>
                                          <strong style={{ color: '#22c55e' }}>ðŸ’µ Cost:</strong> ${parseFloat(job.cost).toFixed(2)}
                                        </div>
                                      )}
                                      {job.panelCount > 0 && (
                                        <div style={{ fontSize: '11px', color: '#94a3b8' }}>
                                          <strong style={{ color: '#fbbf24' }}>â˜€ï¸ Panels:</strong> {job.panelCount}
                                        </div>
                                      )}
                                      {job.routeName && (
                                        <div style={{ fontSize: '11px', color: '#94a3b8', gridColumn: '1 / -1' }}>
                                          <strong style={{ color: '#8b5cf6' }}>ðŸ—ºï¸ Route:</strong> {job.routeName}
                                        </div>
                                      )}
                                    </div>
                                    
                                    {/* Notes */}
                                    {job.customerNotes && (
                                      <div style={{
                                        padding: '8px',
                                        background: 'rgba(139, 92, 246, 0.1)',
                                        border: '1px solid rgba(139, 92, 246, 0.2)',
                                        borderRadius: '4px',
                                        fontSize: '10px',
                                        color: '#c4b5fd',
                                        lineHeight: '1.5',
                                        marginTop: '6px'
                                      }}>
                                        <strong>ðŸ“ Notes:</strong> {job.customerNotes}
                                      </div>
                                    )}
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}
                          
                          {/* Past Notes Section (separate from service history) */}
                          {selectedCustomer.notesHistory && selectedCustomer.notesHistory.length > 0 && (
                            <div style={{
                              padding: '16px',
                              background: 'rgba(139, 92, 246, 0.1)',
                              border: '1px solid rgba(139, 92, 246, 0.3)',
                              borderRadius: '8px',
                              marginTop: '12px'
                            }}>
                              <div style={{ 
                                fontSize: '13px', 
                                fontWeight: 700, 
                                color: '#8b5cf6', 
                                marginBottom: '12px',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                              }}>
                                ðŸ“ NOTES HISTORY
                              </div>
                              
                              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                {selectedCustomer.notesHistory.slice().reverse().map((noteEntry) => (
                                  <div 
                                    key={noteEntry.id}
                                    style={{
                                      padding: '10px',
                                      background: 'rgba(15, 23, 42, 0.4)',
                                      border: '1px solid rgba(139, 92, 246, 0.2)',
                                      borderRadius: '6px'
                                    }}
                                  >
                                    <div style={{ fontSize: '10px', color: '#94a3b8', marginBottom: '4px' }}>
                                      {new Date(noteEntry.date).toLocaleDateString()} - {noteEntry.addedBy}
                                    </div>
                                    <div style={{ fontSize: '11px', color: '#c4b5fd', lineHeight: '1.5' }}>
                                      {noteEntry.note}
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}
                          
                          {/* Mark as Existing Button */}
                          <button
                            onClick={() => {
                              // Pre-populate form with existing values
                              setExistingJobData({
                                totalPanels: selectedCustomer.totalPanels || '',
                                lastServiceDate: selectedCustomer.lastServiceDate || '',
                                amountPaid: selectedCustomer.amountPaid || '',
                                isRecurring: selectedCustomer.isRecurring || false,
                                nextScheduledDate: selectedCustomer.nextScheduledDate || ''
                              });
                              setShowExistingJobModal(true);
                            }}
                            style={{
                              width: '100%',
                              padding: '14px',
                              background: selectedCustomer.existingJob 
                                ? 'rgba(34, 197, 94, 0.2)' 
                                : 'rgba(139, 92, 246, 0.1)',
                              border: selectedCustomer.existingJob
                                ? '2px solid rgba(34, 197, 94, 0.5)'
                                : '2px solid rgba(139, 92, 246, 0.3)',
                              borderRadius: '12px',
                              color: selectedCustomer.existingJob ? '#22c55e' : '#c4b5fd',
                              fontSize: '14px',
                              fontWeight: 700,
                              cursor: 'pointer',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              gap: '8px',
                              transition: 'all 0.2s',
                              marginTop: '8px'
                            }}
                          >
                            {selectedCustomer.existingJob ? 'ðŸ¦• Known Customer' : 'ðŸ¦• Mark as Known Customer'}
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
                
                {/* Existing Job Modal */}
                {showExistingJobModal && (
                  <div
                    style={{
                      position: 'fixed',
                      top: 0,
                      left: 0,
                      right: 0,
                      bottom: 0,
                      background: 'rgba(0, 0, 0, 0.7)',
                      backdropFilter: 'blur(4px)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      zIndex: 10001,
                      animation: 'fadeIn 0.2s ease'
                    }}
                    onClick={() => setShowExistingJobModal(false)}
                  >
                    <div
                      onClick={(e) => e.stopPropagation()}
                      style={{
                        width: '480px',
                        maxHeight: '90vh',
                        background: 'rgba(15, 23, 42, 0.98)',
                        backdropFilter: 'blur(20px)',
                        border: '2px solid rgba(139, 92, 246, 0.3)',
                        borderRadius: '16px',
                        overflow: 'hidden',
                        boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)',
                        display: 'flex',
                        flexDirection: 'column'
                      }}
                    >
                      {/* Header */}
                      <div style={{
                        padding: '24px',
                        borderBottom: '1px solid rgba(34, 197, 94, 0.2)',
                        background: 'rgba(34, 197, 94, 0.05)'
                      }}>
                        <h2 style={{ fontSize: '20px', fontWeight: 700, margin: 0, color: '#f1f5f9' }}>
                          ðŸ¦• Past Customer Details
                        </h2>
                        <p style={{ fontSize: '13px', color: '#94a3b8', margin: '8px 0 0 0' }}>
                          {selectedCustomer?.name} - {selectedCustomer?.address}
                        </p>
                      </div>

                      {/* Form */}
                      <div style={{ 
                        padding: '24px', 
                        overflowY: 'auto',
                        flex: 1
                      }} className="scrollbar-custom">
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
                          
                          {/* Total Panels */}
                          <div>
                            <label style={{ 
                              fontSize: '13px', 
                              color: '#94a3b8', 
                              fontWeight: 600, 
                              marginBottom: '8px', 
                              display: 'block' 
                            }}>
                              Total Panels
                            </label>
                            <input
                              type="number"
                              value={existingJobData.totalPanels}
                              onChange={(e) => setExistingJobData(prev => ({ ...prev, totalPanels: e.target.value }))}
                              placeholder="e.g., 24"
                              min="0"
                              style={{
                                width: '100%',
                                padding: '12px',
                                background: 'rgba(30, 41, 59, 0.5)',
                                border: '1px solid rgba(34, 197, 94, 0.3)',
                                borderRadius: '8px',
                                color: '#f1f5f9',
                                fontSize: '14px',
                                outline: 'none'
                              }}
                            />
                          </div>

                          {/* Last Service Date */}
                          <div>
                            <label style={{ 
                              fontSize: '13px', 
                              color: '#94a3b8', 
                              fontWeight: 600, 
                              marginBottom: '8px', 
                              display: 'block' 
                            }}>
                              Last Service Date
                            </label>
                            <input
                              type="date"
                              value={existingJobData.lastServiceDate}
                              onChange={(e) => setExistingJobData(prev => ({ ...prev, lastServiceDate: e.target.value }))}
                              style={{
                                width: '100%',
                                padding: '12px',
                                background: 'rgba(30, 41, 59, 0.5)',
                                border: '1px solid rgba(34, 197, 94, 0.3)',
                                borderRadius: '8px',
                                color: '#f1f5f9',
                                fontSize: '14px',
                                outline: 'none'
                              }}
                            />
                          </div>

                          {/* Amount Paid */}
                          <div>
                            <label style={{ 
                              fontSize: '13px', 
                              color: '#94a3b8', 
                              fontWeight: 600, 
                              marginBottom: '8px', 
                              display: 'block' 
                            }}>
                              Amount Paid on Last Service
                            </label>
                            <div style={{ position: 'relative' }}>
                              <span style={{
                                position: 'absolute',
                                left: '12px',
                                top: '50%',
                                transform: 'translateY(-50%)',
                                color: '#94a3b8',
                                fontSize: '14px'
                              }}>
                                $
                              </span>
                              <input
                                type="number"
                                value={existingJobData.amountPaid}
                                onChange={(e) => setExistingJobData(prev => ({ ...prev, amountPaid: e.target.value }))}
                                placeholder="0.00"
                                min="0"
                                step="0.01"
                                style={{
                                  width: '100%',
                                  padding: '12px 12px 12px 28px',
                                  background: 'rgba(30, 41, 59, 0.5)',
                                  border: '1px solid rgba(139, 92, 246, 0.3)',
                                  borderRadius: '8px',
                                  color: '#f1f5f9',
                                  fontSize: '14px',
                                  outline: 'none'
                                }}
                              />
                            </div>
                          </div>

                          {/* Next Scheduled Service Date */}
                          {false && (
                            <div>
                              <label style={{ 
                                fontSize: '13px', 
                                color: '#94a3b8', 
                                fontWeight: 600, 
                                marginBottom: '8px', 
                                display: 'block' 
                              }}>
                                Next Scheduled Service Date
                              </label>
                              <input
                                type="date"
                                value={existingJobData.nextScheduledDate}
                                onChange={(e) => setExistingJobData(prev => ({ ...prev, nextScheduledDate: e.target.value }))}
                                style={{
                                  width: '100%',
                                  padding: '12px',
                                  background: 'rgba(30, 41, 59, 0.5)',
                                  border: '1px solid rgba(59, 130, 246, 0.3)',
                                  borderRadius: '8px',
                                  color: '#f1f5f9',
                                  fontSize: '14px',
                                  outline: 'none'
                                }}
                              />
                            </div>
                          )}

                          {/* Info Box */}
                          <div style={{
                            padding: '14px',
                            background: 'rgba(139, 92, 246, 0.1)',
                            border: '1px solid rgba(139, 92, 246, 0.3)',
                            borderRadius: '8px',
                            fontSize: '12px',
                            color: '#c4b5fd',
                            lineHeight: 1.6
                          }}>
                            ðŸ’¡ <strong>Note:</strong> All fields are optional. Fill out what you know and update later if needed.
                          </div>
                        </div>
                      </div>

                      {/* Footer Buttons */}
                      <div style={{
                        padding: '20px 24px',
                        borderTop: '1px solid rgba(139, 92, 246, 0.2)',
                        background: 'rgba(15, 23, 42, 0.8)',
                        display: 'flex',
                        gap: '12px'
                      }}>
                        <button
                          onClick={() => {
                            setShowExistingJobModal(false);
                            setExistingJobData({
                              totalPanels: '',
                              lastServiceDate: '',
                              amountPaid: '',
                              isRecurring: false,
                              nextScheduledDate: ''
                            });
                          }}
                          style={{
                            flex: 1,
                            padding: '14px',
                            background: 'rgba(100, 116, 139, 0.2)',
                            border: '1px solid rgba(100, 116, 139, 0.3)',
                            borderRadius: '10px',
                            color: '#94a3b8',
                            fontSize: '14px',
                            fontWeight: 600,
                            cursor: 'pointer'
                          }}
                        >
                          Cancel
                        </button>
                        <button
                          onClick={handleMarkExisting}
                          style={{
                            flex: 1,
                            padding: '14px',
                            background: 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',
                            border: 'none',
                            borderRadius: '10px',
                            color: '#fff',
                            fontSize: '14px',
                            fontWeight: 700,
                            cursor: 'pointer',
                            boxShadow: '0 4px 12px rgba(139, 92, 246, 0.4)'
                          }}
                        >
                          âœ… Submit
                        </button>
                      </div>
                    </div>
                  </div>
                )}
                
                {loading && (
                  <div style={{
                    position: 'absolute',
                    top: '50%',
                    left: '50%',
                    transform: 'translate(-50%, -50%)',
                    background: 'rgba(15, 23, 42, 0.98)',
                    backdropFilter: 'blur(20px)',
                    padding: '32px 48px',
                    borderRadius: '24px',
                    border: '1px solid rgba(139, 92, 246, 0.3)',
                    textAlign: 'center',
                    boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)'
                  }}>
                    <div style={{ width: '40px', height: '40px', border: '4px solid rgba(139, 92, 246, 0.2)', borderTopColor: '#8b5cf6', borderRadius: '50%', animation: 'spin 1s linear infinite', margin: '0 auto 16px' }}></div>
                    <div style={{ fontSize: '15px', fontWeight: 600 }}>Processing...</div>
                  </div>
                )}
              </div>
            </div>


            {/* ðŸ‘¤ Customer Profile Modal */}
            {showCustomerProfile && profileCustomer && (
              <div
                style={{
                  position: 'fixed',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  background: 'rgba(0, 0, 0, 0.85)',
                  backdropFilter: 'blur(8px)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  zIndex: 10005,
                  animation: 'fadeIn 0.2s ease'
                }}
                onClick={() => { setShowCustomerProfile(false); setProfileCustomer(null); }}
              >
                <div
                  onClick={(e) => e.stopPropagation()}
                  style={{
                    width: '100%',
                    maxWidth: '800px',
                    maxHeight: '90vh',
                    background: 'rgba(15, 23, 42, 0.98)',
                    backdropFilter: 'blur(20px)',
                    border: '2px solid rgba(139, 92, 246, 0.3)',
                    borderRadius: '16px',
                    overflow: 'hidden',
                    boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)',
                    display: 'flex',
                    flexDirection: 'column'
                  }}
                >
                  {/* Header */}
                  <div style={{
                    padding: '20px 24px',
                    background: 'linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(99, 102, 241, 0.1))',
                    borderBottom: '1px solid rgba(139, 92, 246, 0.2)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between'
                  }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px', flex: 1 }}>
                      <div style={{ fontSize: '28px' }}>
                        {(profileCustomer.isRecurring || profileCustomer.recurring === 'TRUE') ? 'ðŸ¦–' : 'ðŸ‘¤'}
                      </div>
                      <div style={{ flex: 1 }}>
                        <input
                          type="text"
                          value={profileCustomer.name || ''}
                          onChange={(e) => {
                            const updatedCustomer = { ...profileCustomer, name: e.target.value };
                            propagateCustomerUpdate(profileCustomer.id, { name: e.target.value });
                            setProfileCustomer(updatedCustomer);
                            trackLocalOverride(profileCustomer.id, 'name', e.target.value);
                          }}
                          style={{
                            margin: 0,
                            fontSize: '20px',
                            fontWeight: 700,
                            color: '#f1f5f9',
                            background: 'transparent',
                            border: '1px solid transparent',
                            borderRadius: '6px',
                            padding: '4px 8px',
                            width: '100%',
                            maxWidth: '400px',
                            transition: 'border-color 0.2s'
                          }}
                          onFocus={(e) => e.target.style.borderColor = 'rgba(139, 92, 246, 0.5)'}
                          onBlur={(e) => e.target.style.borderColor = 'transparent'}
                          placeholder="Customer Name"
                        />
                        <input
                          type="text"
                          value={profileCustomer.address || ''}
                          onChange={(e) => {
                            const updatedCustomer = { ...profileCustomer, address: e.target.value };
                            propagateCustomerUpdate(profileCustomer.id, { address: e.target.value });
                            setProfileCustomer(updatedCustomer);
                            trackLocalOverride(profileCustomer.id, 'address', e.target.value);
                          }}
                          style={{
                            fontSize: '12px',
                            color: '#94a3b8',
                            marginTop: '4px',
                            background: 'transparent',
                            border: '1px solid transparent',
                            borderRadius: '4px',
                            padding: '2px 8px',
                            width: '100%',
                            maxWidth: '400px',
                            transition: 'border-color 0.2s'
                          }}
                          onFocus={(e) => e.target.style.borderColor = 'rgba(139, 92, 246, 0.5)'}
                          onBlur={(e) => e.target.style.borderColor = 'transparent'}
                          placeholder="Address"
                        />
                      </div>
                    </div>
                    <button
                      onClick={() => { setShowCustomerProfile(false); setProfileCustomer(null); }}
                      style={{
                        background: 'none',
                        border: 'none',
                        color: '#94a3b8',
                        fontSize: '24px',
                        cursor: 'pointer',
                        padding: '0',
                        width: '32px',
                        height: '32px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                      }}
                    >
                      âœ•
                    </button>
                  </div>

                  {/* Content */}
                  <div style={{ padding: '24px', overflow: 'auto', flex: 1 }} className="scrollbar-custom">
                    {/* Customer Info Grid */}
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px', marginBottom: '24px' }}>
                      <div style={{ padding: '16px', background: 'rgba(139, 92, 246, 0.1)', borderRadius: '12px', border: '1px solid rgba(139, 92, 246, 0.2)' }}>
                        <div style={{ fontSize: '11px', color: '#94a3b8', marginBottom: '4px', textTransform: 'uppercase', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                          <span>Email</span>
                          <span style={{ fontSize: '10px', color: '#a78bfa' }}>click to edit</span>
                        </div>
                        <input
                          type="email"
                          value={profileCustomer.email || ''}
                          onChange={(e) => {
                            const updatedCustomer = { ...profileCustomer, email: e.target.value };
                            propagateCustomerUpdate(profileCustomer.id, { email: e.target.value });
                            setProfileCustomer(updatedCustomer);
                            trackLocalOverride(profileCustomer.id, 'email', e.target.value);
                          }}
                          style={{
                            width: '100%',
                            padding: '4px 8px',
                            background: 'rgba(139, 92, 246, 0.2)',
                            border: '1px solid rgba(139, 92, 246, 0.3)',
                            borderRadius: '6px',
                            color: '#f1f5f9',
                            fontSize: '14px'
                          }}
                          placeholder="email@example.com"
                        />
                      </div>
                      <div style={{ padding: '16px', background: 'rgba(139, 92, 246, 0.1)', borderRadius: '12px', border: '1px solid rgba(139, 92, 246, 0.2)' }}>
                        <div style={{ fontSize: '11px', color: '#94a3b8', marginBottom: '4px', textTransform: 'uppercase', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                          <span>Phone</span>
                          <span style={{ fontSize: '10px', color: '#a78bfa' }}>click to edit</span>
                        </div>
                        <input
                          type="tel"
                          value={profileCustomer.phone || ''}
                          onChange={(e) => {
                            const updatedCustomer = { ...profileCustomer, phone: e.target.value };
                            propagateCustomerUpdate(profileCustomer.id, { phone: e.target.value });
                            setProfileCustomer(updatedCustomer);
                            trackLocalOverride(profileCustomer.id, 'phone', e.target.value);
                          }}
                          style={{
                            width: '100%',
                            padding: '4px 8px',
                            background: 'rgba(139, 92, 246, 0.2)',
                            border: '1px solid rgba(139, 92, 246, 0.3)',
                            borderRadius: '6px',
                            color: '#f1f5f9',
                            fontSize: '14px'
                          }}
                          placeholder="(555) 555-5555"
                        />
                      </div>
                      <div style={{ padding: '16px', background: 'rgba(139, 92, 246, 0.1)', borderRadius: '12px', border: '1px solid rgba(139, 92, 246, 0.2)' }}>
                        <div style={{ fontSize: '11px', color: '#94a3b8', marginBottom: '4px', textTransform: 'uppercase', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                          <span>Panels</span>
                          <span style={{ fontSize: '10px', color: '#a78bfa' }}>click to edit</span>
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                          <span>â˜€ï¸</span>
                          <input
                            type="number"
                            value={profileCustomer.panelCount || profileCustomer.totalPanels || ''}
                            onChange={(e) => {
                              const updatedCustomer = { ...profileCustomer, panelCount: e.target.value, totalPanels: e.target.value };
                              propagateCustomerUpdate(profileCustomer.id, { panelCount: e.target.value, totalPanels: e.target.value });
                              setProfileCustomer(updatedCustomer);
                              trackLocalOverride(profileCustomer.id, 'panelCount', e.target.value);
                            }}
                            style={{
                              width: '100%',
                              padding: '4px 8px',
                              background: 'rgba(139, 92, 246, 0.2)',
                              border: '1px solid rgba(139, 92, 246, 0.3)',
                              borderRadius: '6px',
                              color: '#f1f5f9',
                              fontSize: '14px'
                            }}
                            placeholder="0"
                            min="0"
                          />
                        </div>
                      </div>
                      <div style={{ padding: '16px', background: 'rgba(34, 197, 94, 0.1)', borderRadius: '12px', border: '1px solid rgba(34, 197, 94, 0.2)' }}>
                        <div style={{ fontSize: '11px', color: '#94a3b8', marginBottom: '4px', textTransform: 'uppercase', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                          <span>Status</span>
                          <span style={{ fontSize: '10px', color: '#4ade80' }}>click to edit</span>
                        </div>
                        <select
                          value={profileCustomer.status || 'unscheduled'}
                          onChange={(e) => {
                            const updatedCustomer = { ...profileCustomer, status: e.target.value };
                            propagateCustomerUpdate(profileCustomer.id, { status: e.target.value });
                            setProfileCustomer(updatedCustomer);
                            trackLocalOverride(profileCustomer.id, 'status', e.target.value);
                          }}
                          style={{
                            width: '100%',
                            padding: '6px 8px',
                            background: 'rgba(34, 197, 94, 0.2)',
                            border: '1px solid rgba(34, 197, 94, 0.3)',
                            borderRadius: '6px',
                            color: '#22c55e',
                            fontSize: '14px',
                            cursor: 'pointer'
                          }}
                        >
                          <option value="unscheduled">ðŸ”´ Unscheduled</option>
                          <option value="scheduled">ðŸŸ¡ Scheduled</option>
                        </select>
                        {(profileCustomer.isRecurring || profileCustomer.recurring === 'TRUE') && (
                          <div style={{ fontSize: '12px', color: '#22c55e', marginTop: '4px' }}>ðŸ¦– Recurring Customer</div>
                        )}
                      </div>
                      <div style={{ padding: '16px', background: 'rgba(251, 191, 36, 0.1)', borderRadius: '12px', border: '1px solid rgba(251, 191, 36, 0.2)' }}>
                        <div style={{ fontSize: '11px', color: '#94a3b8', marginBottom: '4px', textTransform: 'uppercase', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                          <span>Last Service</span>
                          <span style={{ fontSize: '10px', color: '#fbbf24' }}>click to edit</span>
                        </div>
                        <input
                          type="date"
                          value={profileCustomer.lastServiceDate || ''}
                          onChange={(e) => {
                            const updatedCustomer = { ...profileCustomer, lastServiceDate: e.target.value };
                            propagateCustomerUpdate(profileCustomer.id, { lastServiceDate: e.target.value });
                            setProfileCustomer(updatedCustomer);
                            trackLocalOverride(profileCustomer.id, 'lastServiceDate', e.target.value);
                          }}
                          style={{
                            width: '100%',
                            padding: '4px 8px',
                            background: 'rgba(251, 191, 36, 0.2)',
                            border: '1px solid rgba(251, 191, 36, 0.3)',
                            borderRadius: '6px',
                            color: '#fbbf24',
                            fontSize: '14px',
                            cursor: 'pointer'
                          }}
                        />
                      </div>
                      <div style={{ padding: '16px', background: 'rgba(59, 130, 246, 0.1)', borderRadius: '12px', border: '1px solid rgba(59, 130, 246, 0.2)' }}>
                        <div style={{ fontSize: '11px', color: '#94a3b8', marginBottom: '4px', textTransform: 'uppercase', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                          <span>Next Service</span>
                          <span style={{ fontSize: '10px', color: '#60a5fa' }}>click to edit</span>
                        </div>
                        <input
                          type="date"
                          value={(() => {
                            let next = profileCustomer.nextServiceDate;
                            if (!next && profileCustomer.lastServiceDate) {
                              const d = new Date(profileCustomer.lastServiceDate);
                              d.setFullYear(d.getFullYear() + 1);
                              next = d.toISOString().split('T')[0];
                            }
                            return next || '';
                          })()}
                          onChange={(e) => {
                            const updatedCustomer = { ...profileCustomer, nextServiceDate: e.target.value };
                            // Propagate to all views (savedLists, uploadedFiles, savedRoutes)
                            propagateCustomerUpdate(profileCustomer.id, { nextServiceDate: e.target.value });
                            setProfileCustomer(updatedCustomer);
                            // Protect from sheet sync overwriting this change
                            trackLocalOverride(profileCustomer.id, 'nextServiceDate', e.target.value);
                          }}
                          style={{
                            width: '100%',
                            padding: '4px 8px',
                            background: 'rgba(59, 130, 246, 0.2)',
                            border: '1px solid rgba(59, 130, 246, 0.3)',
                            borderRadius: '6px',
                            color: '#60a5fa',
                            fontSize: '14px',
                            cursor: 'pointer'
                          }}
                        />
                      </div>
                    </div>

                    {/* Job History Section */}
                    <div style={{ marginBottom: '24px' }}>
                      <h3 style={{ fontSize: '16px', fontWeight: 700, color: '#f1f5f9', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                        ðŸ“‹ Job History
                      </h3>
                      {(profileCustomer.serviceHistory && profileCustomer.serviceHistory.length > 0) ? (
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                          {profileCustomer.serviceHistory.map((job, idx) => (
                            <div key={idx} style={{
                              padding: '16px',
                              background: 'rgba(30, 41, 59, 0.5)',
                              borderRadius: '12px',
                              border: '1px solid rgba(139, 92, 246, 0.2)'
                            }}>
                              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '8px' }}>
                                <div>
                                  <div style={{ fontSize: '14px', fontWeight: 600, color: '#f1f5f9' }}>
                                    {job.jobDescription || 'Service'}
                                  </div>
                                  <div style={{ fontSize: '12px', color: '#94a3b8', marginTop: '4px' }}>
                                    ðŸ“… {job.date ? new Date(job.date).toLocaleDateString() : 'Unknown date'}
                                  </div>
                                </div>
                                <div style={{ textAlign: 'right' }}>
                                  <div style={{ fontSize: '14px', fontWeight: 600, color: '#22c55e' }}>
                                    ${job.amount || 0}
                                  </div>
                                  {job.tip > 0 && (
                                    <div style={{ fontSize: '12px', color: '#fbbf24' }}>
                                      + ${job.tip} tip
                                    </div>
                                  )}
                                </div>
                              </div>
                              {job.notes && (
                                <div style={{ fontSize: '12px', color: '#94a3b8', marginTop: '8px', padding: '8px', background: 'rgba(0,0,0,0.2)', borderRadius: '6px' }}>
                                  ðŸ“ {job.notes}
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      ) : (
                        <div style={{ padding: '24px', textAlign: 'center', color: '#64748b', background: 'rgba(30, 41, 59, 0.3)', borderRadius: '12px' }}>
                          No job history yet
                        </div>
                      )}
                    </div>

                    {/* General Customer Notes Section */}
                    <div>
                      <h3 style={{ fontSize: '16px', fontWeight: 700, color: '#f1f5f9', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                        ðŸ“ Customer Notes
                      </h3>
                      <div style={{ marginBottom: '12px' }}>
                        <textarea
                          value={newCustomerNote}
                          onChange={(e) => setNewCustomerNote(e.target.value)}
                          placeholder="Add a general note about this customer..."
                          style={{
                            width: '100%',
                            padding: '12px',
                            background: 'rgba(15, 23, 42, 0.8)',
                            border: '1px solid rgba(139, 92, 246, 0.3)',
                            borderRadius: '8px',
                            color: '#f1f5f9',
                            fontSize: '13px',
                            minHeight: '80px',
                            resize: 'vertical',
                            boxSizing: 'border-box'
                          }}
                        />
                        <button
                          onClick={() => {
                            if (!newCustomerNote.trim()) return;
                            const newNotes = (profileCustomer.customerNotes || '') +
                              (profileCustomer.customerNotes ? '\n' : '') +
                              `[${new Date().toLocaleDateString()}] ${newCustomerNote}`;
                            const updatedCustomer = {
                              ...profileCustomer,
                              customerNotes: newNotes
                            };
                            // Propagate to all views
                            propagateCustomerUpdate(profileCustomer.id, { customerNotes: newNotes });
                            setProfileCustomer(updatedCustomer);
                            setNewCustomerNote('');
                            // Protect from sheet sync overwriting notes
                            trackLocalOverride(profileCustomer.id, 'notes', newNotes);
                          }}
                          disabled={!newCustomerNote.trim()}
                          style={{
                            marginTop: '8px',
                            padding: '10px 20px',
                            background: newCustomerNote.trim() ? 'linear-gradient(135deg, #8b5cf6, #7c3aed)' : 'rgba(100, 116, 139, 0.3)',
                            border: 'none',
                            borderRadius: '8px',
                            color: '#fff',
                            fontSize: '13px',
                            fontWeight: 600,
                            cursor: newCustomerNote.trim() ? 'pointer' : 'not-allowed'
                          }}
                        >
                          ðŸ’¾ Save Note
                        </button>
                      </div>
                      {profileCustomer.customerNotes && (
                        <div style={{
                          padding: '16px',
                          background: 'rgba(30, 41, 59, 0.5)',
                          borderRadius: '12px',
                          border: '1px solid rgba(139, 92, 246, 0.2)',
                          whiteSpace: 'pre-wrap',
                          fontSize: '13px',
                          color: '#cbd5e1'
                        }}>
                          {profileCustomer.customerNotes}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* âž• Job Creation Modal */}

            {/* âš ï¸ Failed Customers Modal */}
            {showFailedCustomersModal && (
              <div
                style={{
                  position: 'fixed',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  background: 'rgba(0, 0, 0, 0.7)',
                  backdropFilter: 'blur(4px)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  zIndex: 10002,
                  animation: 'fadeIn 0.2s ease'
                }}
                onClick={() => setShowFailedCustomersModal(false)}
              >
                <div
                  onClick={(e) => e.stopPropagation()}
                  style={{
                    width: '900px',
                    maxHeight: '90vh',
                    background: 'rgba(15, 23, 42, 0.98)',
                    backdropFilter: 'blur(20px)',
                    border: '2px solid rgba(251, 191, 36, 0.3)',
                    borderRadius: '16px',
                    overflow: 'hidden',
                    boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)',
                    display: 'flex',
                    flexDirection: 'column'
                  }}
                >
                  {/* Header */}
                  <div style={{
                    padding: '24px',
                    borderBottom: '1px solid rgba(251, 191, 36, 0.2)',
                    background: 'rgba(251, 191, 36, 0.05)',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'start'
                  }}>
                    <div>
                      <h2 style={{ fontSize: '20px', fontWeight: 700, margin: 0, color: '#f1f5f9' }}>
                        âš ï¸ Failed Addresses ({failedCustomers.length})
                      </h2>
                      <p style={{ fontSize: '13px', color: '#94a3b8', margin: '8px 0 0 0' }}>
                        These addresses couldn't be mapped. Edit them below and click "Retry" to try geocoding again.
                      </p>
                    </div>
                    <button
                      onClick={() => setShowFailedCustomersModal(false)}
                      style={{
                        background: 'none',
                        border: 'none',
                        color: '#94a3b8',
                        fontSize: '24px',
                        cursor: 'pointer',
                        padding: '0',
                        lineHeight: 1
                      }}
                    >
                      Ã—
                    </button>
                  </div>

                  {/* Customers List */}
                  <div style={{ 
                    padding: '24px', 
                    overflowY: 'auto',
                    flex: 1
                  }} className="scrollbar-custom">
                    <div style={{ display: 'grid', gap: '16px' }}>
                      {failedCustomers.map((customer, index) => (
                        <div key={customer.id} className="glass-card" style={{ padding: '16px' }}>
                          <div style={{ display: 'flex', gap: '16px', marginBottom: '12px', alignItems: 'start' }}>
                            <div style={{
                              width: '32px',
                              height: '32px',
                              background: 'rgba(251, 191, 36, 0.2)',
                              borderRadius: '8px',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              fontSize: '12px',
                              fontWeight: 600,
                              color: '#fbbf24',
                              flexShrink: 0
                            }}>
                              {index + 1}
                            </div>
                            <div style={{ flex: 1 }}>
                              <div style={{ fontSize: '14px', fontWeight: 600, color: '#f1f5f9', marginBottom: '4px' }}>
                                {customer.name}
                              </div>
                              <div style={{ fontSize: '11px', color: '#ef4444', marginBottom: '12px' }}>
                                {customer.reason}
                              </div>
                              
                              {/* Editable Fields */}
                              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                                <div>
                                  <label style={{ fontSize: '11px', color: '#94a3b8', display: 'block', marginBottom: '4px' }}>
                                    Street Address
                                  </label>
                                  <input
                                    type="text"
                                    value={customer.street}
                                    onChange={(e) => {
                                      const updated = [...failedCustomers];
                                      updated[index].street = e.target.value;
                                      updated[index].address = `${e.target.value}, ${customer.city}, ${customer.state} ${customer.zip}`.trim();
                                      setFailedCustomers(updated);
                                    }}
                                    style={{
                                      width: '100%',
                                      padding: '8px',
                                      background: 'rgba(30, 41, 59, 0.5)',
                                      border: '1px solid rgba(251, 191, 36, 0.3)',
                                      borderRadius: '6px',
                                      color: '#f1f5f9',
                                      fontSize: '12px'
                                    }}
                                  />
                                </div>
                                <div>
                                  <label style={{ fontSize: '11px', color: '#94a3b8', display: 'block', marginBottom: '4px' }}>
                                    City
                                  </label>
                                  <input
                                    type="text"
                                    value={customer.city}
                                    onChange={(e) => {
                                      const updated = [...failedCustomers];
                                      updated[index].city = e.target.value;
                                      updated[index].address = `${customer.street}, ${e.target.value}, ${customer.state} ${customer.zip}`.trim();
                                      setFailedCustomers(updated);
                                    }}
                                    style={{
                                      width: '100%',
                                      padding: '8px',
                                      background: 'rgba(30, 41, 59, 0.5)',
                                      border: '1px solid rgba(251, 191, 36, 0.3)',
                                      borderRadius: '6px',
                                      color: '#f1f5f9',
                                      fontSize: '12px'
                                    }}
                                  />
                                </div>
                                <div>
                                  <label style={{ fontSize: '11px', color: '#94a3b8', display: 'block', marginBottom: '4px' }}>
                                    State
                                  </label>
                                  <input
                                    type="text"
                                    value={customer.state}
                                    onChange={(e) => {
                                      const updated = [...failedCustomers];
                                      updated[index].state = e.target.value;
                                      updated[index].address = `${customer.street}, ${customer.city}, ${e.target.value} ${customer.zip}`.trim();
                                      setFailedCustomers(updated);
                                    }}
                                    style={{
                                      width: '100%',
                                      padding: '8px',
                                      background: 'rgba(30, 41, 59, 0.5)',
                                      border: '1px solid rgba(251, 191, 36, 0.3)',
                                      borderRadius: '6px',
                                      color: '#f1f5f9',
                                      fontSize: '12px'
                                    }}
                                  />
                                </div>
                                <div>
                                  <label style={{ fontSize: '11px', color: '#94a3b8', display: 'block', marginBottom: '4px' }}>
                                    ZIP Code
                                  </label>
                                  <input
                                    type="text"
                                    value={customer.zip}
                                    onChange={(e) => {
                                      const updated = [...failedCustomers];
                                      updated[index].zip = e.target.value;
                                      updated[index].address = `${customer.street}, ${customer.city}, ${customer.state} ${e.target.value}`.trim();
                                      setFailedCustomers(updated);
                                    }}
                                    style={{
                                      width: '100%',
                                      padding: '8px',
                                      background: 'rgba(30, 41, 59, 0.5)',
                                      border: '1px solid rgba(251, 191, 36, 0.3)',
                                      borderRadius: '6px',
                                      color: '#f1f5f9',
                                      fontSize: '12px'
                                    }}
                                  />
                                </div>
                              </div>
                              
                              {/* Action Buttons */}
                              <div style={{ display: 'flex', gap: '8px', marginTop: '12px' }}>
                                <button
                                  onClick={async () => {
                                    try {
                                      const coords = await geocodeAddress(customer.address);
                                      if (coords) {
                                        // Add to map
                                        const newCustomer = {
                                          ...customer,
                                          lat: coords.lat,
                                          lng: coords.lng,
                                          id: Math.random().toString(36).substr(2, 9),
                                          fileId: Date.now() + Math.random()
                                        };
                                        
                                        setUploadedFiles(prev => [...prev, {
                                          id: newCustomer.fileId,
                                          name: customer.fileName || 'Fixed Addresses',
                                          customers: [newCustomer],
                                          visible: true,
                                          count: 1
                                        }]);
                                        
                                        // Remove from failed
                                        setFailedCustomers(prev => prev.filter(c => c.id !== customer.id));
                                      } else {
                                        alert('Still unable to geocode this address. Please check the address details.');
                                      }
                                    } catch (err) {
                                      alert('Error geocoding address: ' + err.message);
                                    }
                                  }}
                                  style={{
                                    flex: 1,
                                    padding: '8px',
                                    background: 'rgba(34, 197, 94, 0.2)',
                                    border: '1px solid rgba(34, 197, 94, 0.3)',
                                    borderRadius: '6px',
                                    color: '#22c55e',
                                    fontSize: '12px',
                                    fontWeight: 600,
                                    cursor: 'pointer'
                                  }}
                                >
                                  âœ“ Retry Geocode
                                </button>
                                <button
                                  onClick={() => {
                                    setFailedCustomers(prev => prev.filter(c => c.id !== customer.id));
                                  }}
                                  style={{
                                    padding: '8px 12px',
                                    background: 'rgba(239, 68, 68, 0.1)',
                                    border: '1px solid rgba(239, 68, 68, 0.2)',
                                    borderRadius: '6px',
                                    color: '#ef4444',
                                    fontSize: '12px',
                                    cursor: 'pointer'
                                  }}
                                >
                                  ðŸ—‘ï¸
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* Footer */}
                  <div style={{
                    padding: '20px 24px',
                    borderTop: '1px solid rgba(251, 191, 36, 0.2)',
                    background: 'rgba(15, 23, 42, 0.8)',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center'
                  }}>
                    <div style={{ fontSize: '12px', color: '#94a3b8' }}>
                      {failedCustomers.length} {failedCustomers.length === 1 ? 'address' : 'addresses'} remaining
                    </div>
                    <button
                      onClick={() => setShowFailedCustomersModal(false)}
                      style={{
                        padding: '12px 24px',
                        background: 'rgba(100, 116, 139, 0.2)',
                        border: '1px solid rgba(100, 116, 139, 0.3)',
                        borderRadius: '10px',
                        color: '#94a3b8',
                        fontSize: '14px',
                        fontWeight: 600,
                        cursor: 'pointer'
                      }}
                    >
                      Close
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* ðŸ“ Saved Routes View */}
            {currentView === 'saved' && (
              <div style={{ 
                position: 'absolute',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                overflow: 'auto',
                padding: '32px'
              }} className="scrollbar-custom">
                <h2 style={{ fontSize: '24px', fontWeight: 800, marginBottom: '24px' }}>ðŸ“ Saved Routes</h2>
                
                {savedRoutes.length === 0 ? (
                  <div style={{ textAlign: 'center', padding: '80px 20px', color: '#64748b' }}>
                    <div style={{ fontSize: '64px', marginBottom: '16px' }}>ðŸ“</div>
                    <div style={{ fontSize: '18px', fontWeight: 600, marginBottom: '8px' }}>No saved routes yet</div>
                    <div style={{ fontSize: '14px' }}>Build a route on the Map tab and save it!</div>
                  </div>
                ) : (
                  <div style={{ display: 'grid', gap: '24px', maxWidth: '1200px' }}>
                    {savedRoutes.map((savedRoute) => (
                      <div key={savedRoute.id} className="glass-card" style={{ padding: '24px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '20px' }}>
                          <div>
                            {/* Editable Title */}
                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px' }}>
                              {editingRouteId === savedRoute.id ? (
                                <>
                                  <input
                                    type="text"
                                    value={editedRouteName}
                                    onChange={(e) => setEditedRouteName(e.target.value)}
                                    onBlur={() => {
                                      if (editedRouteName.trim()) {
                                        setSavedRoutes(prev => prev.map(r => 
                                          r.id === savedRoute.id ? { ...r, name: editedRouteName } : r
                                        ));
                                      }
                                      setEditingRouteId(null);
                                    }}
                                    onKeyPress={(e) => {
                                      if (e.key === 'Enter' && editedRouteName.trim()) {
                                        setSavedRoutes(prev => prev.map(r => 
                                          r.id === savedRoute.id ? { ...r, name: editedRouteName } : r
                                        ));
                                        setEditingRouteId(null);
                                      }
                                    }}
                                    autoFocus
                                    style={{
                                      fontSize: '20px',
                                      fontWeight: 700,
                                      background: 'rgba(139, 92, 246, 0.1)',
                                      border: '1px solid rgba(139, 92, 246, 0.3)',
                                      borderRadius: '6px',
                                      padding: '4px 8px',
                                      color: '#f1f5f9',
                                      flex: 1
                                    }}
                                  />
                                  <button
                                    onClick={() => {
                                      if (editedRouteName.trim()) {
                                        setSavedRoutes(prev => prev.map(r => 
                                          r.id === savedRoute.id ? { ...r, name: editedRouteName } : r
                                        ));
                                      }
                                      setEditingRouteId(null);
                                    }}
                                    style={{
                                      padding: '4px 12px',
                                      background: 'rgba(34, 197, 94, 0.2)',
                                      border: '1px solid rgba(34, 197, 94, 0.3)',
                                      borderRadius: '6px',
                                      color: '#22c55e',
                                      fontSize: '12px',
                                      cursor: 'pointer',
                                      fontWeight: 600
                                    }}
                                  >
                                    âœ“
                                  </button>
                                </>
                              ) : (
                                <>
                                  <h3 style={{ fontSize: '20px', fontWeight: 700, flex: 1, margin: 0 }}>{savedRoute.name}</h3>
                                  <button
                                    onClick={() => {
                                      setEditingRouteId(savedRoute.id);
                                      setEditedRouteName(savedRoute.name);
                                    }}
                                    style={{
                                      padding: '4px 12px',
                                      background: 'rgba(139, 92, 246, 0.1)',
                                      border: '1px solid rgba(139, 92, 246, 0.3)',
                                      borderRadius: '6px',
                                      color: '#8b5cf6',
                                      fontSize: '12px',
                                      cursor: 'pointer',
                                      fontWeight: 600
                                    }}
                                  >
                                    âœï¸ Edit
                                  </button>
                                </>
                              )}
                            </div>
                            
                            <div style={{ fontSize: '13px', color: '#94a3b8', marginBottom: '8px' }}>
                              Created: {new Date(savedRoute.date).toLocaleDateString()} â€¢ {savedRoute.customers.length} stops â€¢ {(savedRoute.totalDistance || 0).toFixed(1)} miles
                            </div>
                            {savedRoute.scheduledDate && (
                              <div style={{
                                display: 'inline-block',
                                padding: '6px 12px',
                                background: 'rgba(139, 92, 246, 0.2)',
                                border: '1px solid rgba(139, 92, 246, 0.3)',
                                borderRadius: '8px',
                                fontSize: '12px',
                                fontWeight: 600,
                                color: '#a78bfa'
                              }}>
                                ðŸ“… Scheduled: {new Date(savedRoute.scheduledDate).toLocaleDateString('en-US', { 
                                  weekday: 'short',
                                  month: 'short', 
                                  day: 'numeric',
                                  year: 'numeric'
                                })}
                              </div>
                            )}
                            
                            
                            {/* Sent Status */}
                            {savedRoute.sentToTech && (
                              <div style={{
                                marginTop: '12px',
                                padding: '8px 12px',
                                background: 'rgba(34, 197, 94, 0.1)',
                                border: '1px solid rgba(34, 197, 94, 0.3)',
                                borderRadius: '8px',
                                fontSize: '11px',
                                color: '#22c55e',
                                fontWeight: 600,
                                display: 'inline-block'
                              }}>
                                âœ“ Sent to Tech: {new Date(savedRoute.sentDate).toLocaleDateString()}
                              </div>
                            )}
                          </div>
                          <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                            <button
                              onClick={() => {
                                if (savedRoute.sentToTech) {
                                  alert('This route has already been sent to the technician. Reach out to the technician directly to make further changes.');
                                  return;
                                }
                                // Load route into map editor
                                const routeDateKey = new Date(savedRoute.scheduledDate).toDateString();
                                setRoutesByDay(prev => ({
                                  ...prev,
                                  [routeDateKey]: savedRoute.customers
                                }));
                                setEditingSavedRouteId(savedRoute.id);
                                setSelectedDate(new Date(savedRoute.scheduledDate));

                                // Restore scheduledTime into customers state for time slot display
                                setCustomers(prev => {
                                  const rcMap = new Map();
                                  savedRoute.customers.forEach(rc => rcMap.set(rc.id, rc));
                                  return prev.map(c => {
                                    const rc = rcMap.get(c.id);
                                    if (rc) {
                                      return {
                                        ...c,
                                        scheduledTime: rc.scheduledTime || c.scheduledTime,
                                        scheduledDate: savedRoute.scheduledDate || rc.scheduledDate || c.scheduledDate,
                                        status: 'scheduled',
                                        routeConfirmed: true
                                      };
                                    }
                                    return c;
                                  });
                                });

                                setSavedViewDays(prev => ({
                                  ...prev,
                                  [routeDateKey]: false
                                }));
                                setCurrentView('map');
                              }}
                              className="button-secondary"
                              style={{ padding: '12px 16px', fontSize: '14px', fontWeight: 600 }}
                            >
                              âœï¸ Edit Route
                            </button>
                            <button
                              onClick={() => emailRouteToTech(savedRoute)}
                              className="button-primary"
                            >
                              ðŸ“§ Email to Tech
                            </button>
                            <button
                              onClick={() => {
                                if (window.confirm(`Delete route "${savedRoute.name}"?`)) {
                                  // Unschedule all customers in this route and propagate changes
                                  const routeCustomerIds = new Set(savedRoute.customers.map(c => c.id));
                                  const unscheduleUpdates = {
                                    scheduledDate: null,
                                    scheduledTime: null,
                                    status: 'unscheduled',
                                    routeConfirmed: false,
                                    confirmedRouteName: null
                                  };

                                  // Propagate unschedule updates to all data stores for each customer
                                  savedRoute.customers.forEach(c => {
                                    propagateCustomerUpdate(c.id, unscheduleUpdates);
                                  });

                                  setCustomers(prev => prev.map(c => {
                                    if (routeCustomerIds.has(c.id)) {
                                      return { ...c, ...unscheduleUpdates };
                                    }
                                    return c;
                                  }));
                                  // Clear routesByDay for this route's date
                                  const routeDateKey = new Date(savedRoute.scheduledDate).toDateString();
                                  setRoutesByDay(prev => ({ ...prev, [routeDateKey]: [] }));
                                  setSavedViewDays(prev => ({ ...prev, [routeDateKey]: false }));
                                  setSavedRoutes(prev => prev.filter(r => r.id !== savedRoute.id));
                                }
                              }}
                              style={{
                                background: 'rgba(239, 68, 68, 0.1)',
                                border: '1px solid rgba(239, 68, 68, 0.3)',
                                borderRadius: '10px',
                                padding: '12px 16px',
                                color: '#fca5a5',
                                cursor: 'pointer',
                                fontSize: '14px',
                                fontWeight: 600,
                                transition: 'all 0.2s'
                              }}
                            >
                              ðŸ—‘ï¸ Delete
                            </button>
                          </div>
                        </div>

                        <div style={{ display: 'grid', gap: '12px' }}>
                          {savedRoute.customers.map((customer, index) => (
                            <div
                              key={customer.id}
                              draggable
                              onDragStart={(e) => {
                                e.dataTransfer.setData('customer', JSON.stringify(customer));
                                e.currentTarget.style.opacity = '0.5';
                              }}
                              onDragEnd={(e) => {
                                e.currentTarget.style.opacity = '1';
                              }}
                              style={{
                                padding: '16px',
                                background: 'rgba(15, 23, 42, 0.4)',
                                borderRadius: '12px',
                                border: '1px solid rgba(139, 92, 246, 0.2)',
                                display: 'flex',
                                flexDirection: 'column',
                                gap: '8px',
                                cursor: 'grab'
                              }}
                              onMouseDown={(e) => {
                                e.currentTarget.style.cursor = 'grabbing';
                              }}
                              onMouseUp={(e) => {
                                e.currentTarget.style.cursor = 'grab';
                              }}
                            >
                              <div style={{ display: 'flex', gap: '16px', alignItems: 'start' }}>
                                <div className="route-number" style={{ width: '28px', height: '28px', fontSize: '13px', flexShrink: 0 }}>
                                  {index + 1}
                                </div>
                                <div style={{ flex: 1 }}>
                                  <div
                                    onClick={() => {
                                      const fullCustomer = customers.find(c => c.id === customer.id) || customer;
                                      setProfileCustomer(fullCustomer);
                                      setShowCustomerProfile(true);
                                    }}
                                    style={{ fontSize: '14px', fontWeight: 600, marginBottom: '4px', color: '#c4b5fd', cursor: 'pointer', textDecoration: 'underline', textDecorationColor: 'rgba(139, 92, 246, 0.3)' }}
                                    onMouseEnter={(e) => e.currentTarget.style.color = '#a78bfa'}
                                    onMouseLeave={(e) => e.currentTarget.style.color = '#c4b5fd'}
                                  >
                                    {customer.name}
                                  </div>
                                  <div style={{ fontSize: '12px', color: '#94a3b8', marginBottom: '8px' }}>
                                    ðŸ“ {customer.address}
                                  </div>
                                  <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px', fontSize: '11px', color: '#94a3b8' }}>
                                    {customer.phone && (
                                      <span>ðŸ“ž {customer.phone}</span>
                                    )}
                                    {customer.secondaryPhones && customer.secondaryPhones.length > 0 && (
                                      <span style={{ color: '#64748b' }}>
                                        ({customer.secondaryPhones.join(', ')})
                                      </span>
                                    )}
                                    {customer.email && (
                                      <span>ðŸ“§ {customer.email}</span>
                                    )}
                                    {customer.secondaryEmails && customer.secondaryEmails.length > 0 && (
                                      <span style={{ color: '#64748b' }}>
                                        ({customer.secondaryEmails.join(', ')})
                                      </span>
                                    )}
                                  </div>
                                  
                                  {/* Customer Notes - Editable */}
                                  <div style={{
                                    marginTop: '8px',
                                    padding: '8px',
                                    background: 'rgba(139, 92, 246, 0.1)',
                                    border: '1px solid rgba(139, 92, 246, 0.2)',
                                    borderRadius: '6px',
                                    fontSize: '11px',
                                    color: '#c4b5fd',
                                    lineHeight: '1.5'
                                  }}>
                                    {editingCustomerNotes?.routeId === savedRoute.id && editingCustomerNotes?.customerId === customer.id ? (
                                      <div>
                                        <textarea
                                          value={editedNotes}
                                          onChange={(e) => setEditedNotes(e.target.value)}
                                          placeholder="Add notes (gate codes, special instructions, etc.)"
                                          autoFocus
                                          rows="3"
                                          style={{
                                            width: '100%',
                                            padding: '8px',
                                            background: 'rgba(15, 23, 42, 0.5)',
                                            border: '1px solid rgba(139, 92, 246, 0.3)',
                                            borderRadius: '4px',
                                            color: '#f1f5f9',
                                            fontSize: '11px',
                                            resize: 'vertical',
                                            fontFamily: 'inherit',
                                            marginBottom: '8px'
                                          }}
                                        />
                                        <div style={{ display: 'flex', gap: '8px', justifyContent: 'flex-end' }}>
                                          <button
                                            onClick={() => {
                                              setEditingCustomerNotes(null);
                                              setEditedNotes('');
                                            }}
                                            style={{
                                              padding: '4px 12px',
                                              background: 'rgba(100, 116, 139, 0.2)',
                                              border: '1px solid rgba(100, 116, 139, 0.3)',
                                              borderRadius: '4px',
                                              color: '#94a3b8',
                                              fontSize: '11px',
                                              cursor: 'pointer',
                                              fontWeight: 600
                                            }}
                                          >
                                            Cancel
                                          </button>
                                          <button
                                            onClick={() => {
                                              // Update customer notes in saved route
                                              setSavedRoutes(prev => prev.map(r => {
                                                if (r.id === savedRoute.id) {
                                                  return {
                                                    ...r,
                                                    customers: r.customers.map(c => 
                                                      c.id === customer.id 
                                                        ? { ...c, customerNotes: editedNotes, notes: editedNotes }
                                                        : c
                                                    )
                                                  };
                                                }
                                                return r;
                                              }));
                                              
                                              // Update customer in main customers array
                                              setCustomers(prev => prev.map(c => {
                                                if (c.id === customer.id) {
                                                  return {
                                                    ...c,
                                                    notes: editedNotes,
                                                    notesHistory: [
                                                      ...(c.notesHistory || []),
                                                      {
                                                        id: Date.now().toString(),
                                                        date: new Date().toISOString(),
                                                        note: editedNotes,
                                                        addedBy: 'User'
                                                      }
                                                    ]
                                                  };
                                                }
                                                return c;
                                              }));
                                              
                                              setEditingCustomerNotes(null);
                                              setEditedNotes('');
                                            }}
                                            style={{
                                              padding: '4px 12px',
                                              background: 'rgba(34, 197, 94, 0.2)',
                                              border: '1px solid rgba(34, 197, 94, 0.3)',
                                              borderRadius: '4px',
                                              color: '#22c55e',
                                              fontSize: '11px',
                                              cursor: 'pointer',
                                              fontWeight: 600
                                            }}
                                          >
                                            ðŸ’¾ Save
                                          </button>
                                        </div>
                                      </div>
                                    ) : (
                                      <div 
                                        onClick={() => {
                                          setEditingCustomerNotes({ routeId: savedRoute.id, customerId: customer.id });
                                          setEditedNotes(customer.customerNotes || customer.notes || '');
                                        }}
                                        style={{ cursor: 'pointer' }}
                                      >
                                        <strong>ðŸ“ Notes:</strong> {customer.customerNotes || customer.notes || <span style={{ fontStyle: 'italic', opacity: 0.7 }}>Click to add notes...</span>}
                                      </div>
                                    )}
                                  </div>
                                  
                                  <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '8px' }}>
                                    {customer.panelCount && (
                                      <span style={{
                                        fontSize: '10px',
                                        padding: '3px 8px',
                                        background: 'rgba(251, 191, 36, 0.2)',
                                        border: '1px solid rgba(251, 191, 36, 0.3)',
                                        borderRadius: '4px',
                                        color: '#fbbf24'
                                      }}>
                                        â˜€ï¸ {customer.panelCount} panels
                                      </span>
                                    )}
                                    {(customer.isRecurring || customer.recurring) && (
                                      <span style={{
                                        fontSize: '10px',
                                        padding: '3px 8px',
                                        background: 'rgba(59, 130, 246, 0.2)',
                                        border: '1px solid rgba(59, 130, 246, 0.3)',
                                        borderRadius: '4px',
                                        color: '#3b82f6'
                                      }}>
                                        ðŸ¦– Recurring
                                      </span>
                                    )}
                                    {customer.existingJob && !(customer.isRecurring || customer.recurring) && (
                                      <span style={{
                                        fontSize: '10px',
                                        padding: '3px 8px',
                                        background: 'rgba(34, 197, 94, 0.2)',
                                        border: '1px solid rgba(34, 197, 94, 0.3)',
                                        borderRadius: '4px',
                                        color: '#22c55e'
                                      }}>
                                        ðŸ¦• Past
                                      </span>
                                    )}
                                    {customer.lastServiceDate && (
                                      <span style={{
                                        fontSize: '10px',
                                        padding: '3px 8px',
                                        background: 'rgba(100, 116, 139, 0.2)',
                                        border: '1px solid rgba(100, 116, 139, 0.3)',
                                        borderRadius: '4px',
                                        color: '#94a3b8'
                                      }}>
                                        Last: {new Date(customer.lastServiceDate).toLocaleDateString()}
                                      </span>
                                    )}
                                    {customer.amountPaid && (
                                      <span style={{
                                        fontSize: '10px',
                                        padding: '3px 8px',
                                        background: 'rgba(34, 197, 94, 0.2)',
                                        border: '1px solid rgba(34, 197, 94, 0.3)',
                                        borderRadius: '4px',
                                        color: '#22c55e'
                                      }}>
                                        ðŸ’µ ${customer.amountPaid}
                                      </span>
                                    )}
                                  </div>
                                </div>
                                {customer.distanceFromHome && (
                                  <span className="distance-badge" style={{ flexShrink: 0 }}>
                                    ðŸ  {(customer.distanceFromHome || 0).toFixed(1)} mi
                                  </span>
                                )}
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}

            {/* Pipeline View */}
            {currentView === 'pipeline' && (
              <div style={{
                position: 'absolute',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                overflow: 'auto',
                padding: '32px'
              }} className="scrollbar-custom">
                {/* Pipeline Header */}
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                    <h2 style={{ fontSize: '24px', fontWeight: 800, margin: 0 }}>ðŸ“¡ Google Sheets Pipeline</h2>
                    {sheetsConnected && (
                      <span style={{
                        fontSize: '11px',
                        padding: '4px 10px',
                        background: 'rgba(34, 197, 94, 0.2)',
                        border: '1px solid rgba(34, 197, 94, 0.3)',
                        borderRadius: '12px',
                        color: '#22c55e'
                      }}>
                        ðŸ”— Live Sync
                      </span>
                    )}
                  </div>
                  <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                    {lastSheetSync && (
                      <span style={{ fontSize: '11px', color: '#64748b' }}>
                        Last sync: {new Date(lastSheetSync).toLocaleTimeString()}
                      </span>
                    )}
                    <button
                      onClick={refreshPipelineData}
                      className="button-primary"
                      disabled={!sheetsConnected || sheetSyncing}
                      style={{
                        padding: '8px 16px',
                        opacity: sheetsConnected ? 1 : 0.5
                      }}
                    >
                      ðŸ”„ Refresh
                    </button>
                    <label style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '12px', color: '#94a3b8', cursor: 'pointer' }}>
                      <input
                        type="checkbox"
                        checked={sheetAutoRefresh}
                        onChange={(e) => setSheetAutoRefresh(e.target.checked)}
                      />
                      Auto-refresh
                    </label>
                  </div>
                </div>

                {/* Connection Status */}
                {!sheetsConnected ? (
                  <div style={{ textAlign: 'center', padding: '80px 20px', color: '#64748b' }}>
                    <div style={{ fontSize: '64px', marginBottom: '16px' }}>ðŸ“Š</div>
                    <div style={{ fontSize: '18px', fontWeight: 600, marginBottom: '8px' }}>Connect to Google Sheets</div>
                    <div style={{ fontSize: '14px', marginBottom: '24px' }}>
                      Enter your Google Sheet URL in the sidebar and click "Test Connection" to view your data here.
                    </div>
                    <div style={{
                      background: 'rgba(139, 92, 246, 0.1)',
                      border: '1px solid rgba(139, 92, 246, 0.3)',
                      borderRadius: '12px',
                      padding: '20px',
                      maxWidth: '500px',
                      margin: '0 auto',
                      textAlign: 'left'
                    }}>
                      <div style={{ fontWeight: 600, color: '#a78bfa', marginBottom: '12px' }}>ðŸ“‹ Setup Instructions:</div>
                      <ol style={{ margin: 0, paddingLeft: '20px', lineHeight: '1.8', fontSize: '13px' }}>
                        <li>Open your Google Sheet</li>
                        <li>Click File â†’ Share â†’ Publish to web</li>
                        <li>Select "Comma-separated values (.csv)"</li>
                        <li>Copy the published URL</li>
                        <li>Paste it in the "Google Sheets" field in the sidebar</li>
                        <li>Click "Test Connection"</li>
                      </ol>
                    </div>
                  </div>
                ) : sheetHeaders.length === 0 ? (
                  <div style={{ textAlign: 'center', padding: '60px 20px', color: '#64748b' }}>
                    <div style={{ fontSize: '48px', marginBottom: '16px' }}>â³</div>
                    <div style={{ fontSize: '16px' }}>Loading Google Sheet data...</div>
                  </div>
                ) : (
                  /* Google Sheets Data Table */
                  <div style={{ overflowX: 'auto' }}>
                    <div style={{
                      marginBottom: '12px',
                      fontSize: '13px',
                      color: '#94a3b8',
                      display: 'flex',
                      justifyContent: 'space-between',
                      alignItems: 'center'
                    }}>
                      <span>ðŸ“Š {sheetData.length} rows â€¢ {sheetHeaders.length} columns</span>
                      {pipelineSortColumn !== null && (
                        <span style={{ color: '#a78bfa' }}>
                          Sorted by: {sheetHeaders[pipelineSortColumn]} ({pipelineSortOrder === 'asc' ? 'â†‘ A-Z' : 'â†“ Z-A'})
                        </span>
                      )}
                    </div>
                    <table className="pipeline-table">
                      <thead>
                        <tr>
                          {sheetHeaders.map((header, colIndex) => (
                            <th
                              key={colIndex}
                              onClick={() => sortPipelineData(colIndex)}
                              style={{
                                cursor: 'pointer',
                                userSelect: 'none',
                                whiteSpace: 'nowrap',
                                background: pipelineSortColumn === colIndex ? 'rgba(139, 92, 246, 0.3)' : undefined
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                {header}
                                <span style={{
                                  fontSize: '10px',
                                  opacity: pipelineSortColumn === colIndex ? 1 : 0.4,
                                  color: pipelineSortColumn === colIndex ? '#a78bfa' : '#64748b'
                                }}>
                                  {pipelineSortColumn === colIndex
                                    ? (pipelineSortOrder === 'asc' ? 'â–²' : 'â–¼')
                                    : 'â‡…'
                                  }
                                </span>
                              </div>
                            </th>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        {(() => {
                          // Find the customer name column index for job history click-through
                          const nameColIdx = sheetHeaders.findIndex(h => h && /customer\s*name|^name$/i.test(h.toLowerCase().trim()));
                          return getSortedPipelineData().map((row) => {
                            // Find matching local customer for this row
                            const matchedCustomer = findCustomerFromPipelineRow(row);
                            const jobCount = matchedCustomer?.serviceHistory?.length || 0;
                            return (
                              <tr key={row.rowIndex}>
                                {row.values.map((value, colIndex) => (
                                  <td key={colIndex}>
                                    {colIndex === nameColIdx && matchedCustomer ? (
                                      <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                                        <input
                                          type="text"
                                          value={value || ''}
                                          onChange={(e) => handlePipelineCellEdit(row.rowIndex, colIndex, e.target.value)}
                                          style={{
                                            flex: 1,
                                            minWidth: '80px',
                                            padding: '6px 8px',
                                            background: 'transparent',
                                            border: '1px solid transparent',
                                            borderRadius: '4px',
                                            color: '#f1f5f9',
                                            fontSize: '12px'
                                          }}
                                          onFocus={(e) => e.target.style.borderColor = 'rgba(139, 92, 246, 0.5)'}
                                          onBlur={(e) => e.target.style.borderColor = 'transparent'}
                                        />
                                        {jobCount > 1 && (
                                          <button
                                            onClick={() => {
                                              setProfileCustomer(matchedCustomer);
                                              setShowCustomerProfile(true);
                                            }}
                                            title={`${jobCount} jobs â€” click to view history`}
                                            style={{
                                              padding: '2px 6px',
                                              background: 'rgba(139, 92, 246, 0.2)',
                                              border: '1px solid rgba(139, 92, 246, 0.4)',
                                              borderRadius: '10px',
                                              color: '#a78bfa',
                                              fontSize: '10px',
                                              fontWeight: 700,
                                              cursor: 'pointer',
                                              whiteSpace: 'nowrap',
                                              flexShrink: 0
                                            }}
                                          >
                                            {jobCount} jobs
                                          </button>
                                        )}
                                      </div>
                                    ) : (
                                      <input
                                        type="text"
                                        value={value || ''}
                                        onChange={(e) => handlePipelineCellEdit(row.rowIndex, colIndex, e.target.value)}
                                        style={{
                                          width: '100%',
                                          minWidth: '80px',
                                          padding: '6px 8px',
                                          background: 'transparent',
                                          border: '1px solid transparent',
                                          borderRadius: '4px',
                                          color: '#f1f5f9',
                                          fontSize: '12px'
                                        }}
                                        onFocus={(e) => e.target.style.borderColor = 'rgba(139, 92, 246, 0.5)'}
                                        onBlur={(e) => e.target.style.borderColor = 'transparent'}
                                      />
                                    )}
                                  </td>
                                ))}
                              </tr>
                            );
                          });
                        })()}
                      </tbody>
                    </table>

                  </div>
                )}
              </div>
            )}

            {/* Recurring Customers View */}
            {currentView === 'recurring' && (
              <div style={{
                position: 'absolute',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                overflow: 'auto',
                padding: '32px'
              }} className="scrollbar-custom">
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                  <h2 style={{ fontSize: '24px', fontWeight: 800, color: '#22c55e' }}>ðŸ¦– Recurring Customers</h2>
                  <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                    <span style={{ fontSize: '14px', color: '#94a3b8' }}>
                      {customers.filter(c => c.isRecurring === true || c.recurring === 'TRUE' || c.recurring === true).length} recurring customers
                    </span>
                  </div>
                </div>

                {(() => {
                  const recurringCustomers = customers.filter(c => c.isRecurring === true || c.recurring === 'TRUE' || c.recurring === true);

                  if (recurringCustomers.length === 0) {
                    return (
                      <div style={{ textAlign: 'center', padding: '80px 20px', color: '#64748b' }}>
                        <div style={{ fontSize: '64px', marginBottom: '16px' }}>ðŸ¦–</div>
                        <div style={{ fontSize: '18px', fontWeight: 600, marginBottom: '8px' }}>No recurring customers yet</div>
                        <div style={{ fontSize: '14px' }}>Customers marked as "Recurring" in Google Sheets will appear here.</div>
                      </div>
                    );
                  }

                  return (
                    <div style={{ overflowX: 'auto' }}>
                      <table className="pipeline-table">
                        <thead>
                          <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Address</th>
                            <th>City, State</th>
                            <th>Panels</th>
                            <th>Last Service</th>
                            <th>Next Service</th>
                            <th>Job Amount</th>
                            <th>Tip</th>
                            <th style={{ width: '200px' }}>Notes</th>
                          </tr>
                        </thead>
                        <tbody>
                          {recurringCustomers.map((customer) => {
                            // Calculate next service date if not set
                            let nextService = customer.nextServiceDate;
                            if (!nextService && customer.lastServiceDate) {
                              const lastDate = new Date(customer.lastServiceDate);
                              const next = new Date(lastDate);
                              next.setFullYear(next.getFullYear() + 1);
                              nextService = next.toISOString().split('T')[0];
                            }
                            const isOverdue = nextService && new Date(nextService) < new Date();

                            return (
                              <tr key={customer.id} style={{ background: isOverdue ? 'rgba(239, 68, 68, 0.1)' : undefined }}>
                                <td style={{ fontWeight: 600 }}>
                                  <span style={{ marginRight: '8px' }}>ðŸ¦–</span>
                                  <span
                                    onClick={() => { setProfileCustomer(customer); setShowCustomerProfile(true); }}
                                    style={{ cursor: 'pointer', color: '#f1f5f9' }}
                                    onMouseOver={(e) => e.currentTarget.style.color = '#a78bfa'}
                                    onMouseOut={(e) => e.currentTarget.style.color = '#f1f5f9'}
                                  >
                                    {customer.name}
                                  </span>
                                </td>
                                <td>{customer.email || '-'}</td>
                                <td>{customer.phone || '-'}</td>
                                <td style={{ fontSize: '11px', maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                                  {customer.address || '-'}
                                </td>
                                <td>{customer.city}, {customer.state}</td>
                                <td>{customer.panelCount || customer.totalPanels ? `â˜€ï¸ ${customer.panelCount || customer.totalPanels}` : '-'}</td>
                                <td>
                                  {customer.lastServiceDate
                                    ? new Date(customer.lastServiceDate).toLocaleDateString()
                                    : '-'
                                  }
                                </td>
                                <td style={{ color: isOverdue ? '#ef4444' : '#22c55e', fontWeight: 600 }}>
                                  {nextService
                                    ? (isOverdue ? 'âš ï¸ ' : 'ðŸ“… ') + new Date(nextService).toLocaleDateString()
                                    : '-'
                                  }
                                </td>
                                <td style={{ color: '#22c55e' }}>
                                  {customer.amountPaid ? `$${customer.amountPaid}` : '-'}
                                </td>
                                <td style={{ color: '#fbbf24' }}>
                                  {customer.tipAmount ? `$${customer.tipAmount}` : '-'}
                                </td>
                                <td>
                                  <div style={{ fontSize: '11px', color: '#94a3b8', maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                                    {customer.notes || customer.customerNotes || '-'}
                                  </div>
                                </td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  );
                })()}
              </div>
            )}
          </div>

          {/* Radius Search Floating Control Panel */}
          {radiusMode && (
            <div style={{
              position: 'absolute',
              top: '80px',
              right: '20px',
              zIndex: 1000,
              background: 'rgba(15, 23, 42, 0.95)',
              backdropFilter: 'blur(20px)',
              border: '1px solid rgba(139, 92, 246, 0.3)',
              borderRadius: '12px',
              padding: '20px',
              width: '320px',
              boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)'
            }}>
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '16px' }}>
                <h3 style={{ fontSize: '16px', fontWeight: 700, margin: 0, color: '#f1f5f9' }}>ðŸŽ¯ Radius Search</h3>
                <button
onClick={exitRadiusMode}
                  style={{ background: 'transparent', border: 'none', color: '#94a3b8', cursor: 'pointer', padding: 0, fontSize: '20px' }}
                >
                  âœ•
                </button>
              </div>

              {/* Radius Slider */}
              <div style={{ marginBottom: '16px' }}>
                <label style={{ fontSize: '12px', color: '#94a3b8', fontWeight: 600, marginBottom: '8px', display: 'block' }}>
                  Radius (miles)
                </label>
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                  <input
                    type="range"
                    min="1"
                    max="100"
                    value={radiusMiles}
                    onChange={(e) => {
                      const newRadius = parseInt(e.target.value);
                      setRadiusMiles(newRadius);
                      // Update circle if one exists
                      if (referencePoint) {
                        clearRadius();
                        drawRadius(referencePoint, newRadius * 1609.34, referenceAddress);
                      }
                    }}
                    style={{ flex: 1 }}
                  />
                  <div style={{
                    fontSize: '18px',
                    fontWeight: 700,
                    color: '#8b5cf6',
                    minWidth: '60px',
                    textAlign: 'right'
                  }}>
                    {radiusMiles} mi
                  </div>
                </div>
              </div>

              {/* Address Input */}
              <div style={{ marginBottom: '16px' }}>
                <label style={{ fontSize: '12px', color: '#94a3b8', fontWeight: 600, marginBottom: '8px', display: 'block' }}>
                  Search Address
                </label>
                <input
                  type="text"
                  value={radiusAddress}
                  onChange={(e) => setRadiusAddress(e.target.value)}
                  onKeyPress={(e) => {
                    if (e.key === 'Enter' && radiusAddress) {
                      handleRadiusSearch(false);
                    }
                  }}
                  placeholder="123 Main St, Austin, TX"
                  style={{
                    width: '100%',
                    padding: '10px 12px',
                    background: 'rgba(30, 41, 59, 0.5)',
                    border: '1px solid rgba(139, 92, 246, 0.3)',
                    borderRadius: '6px',
                    color: '#f1f5f9',
                    fontSize: '13px',
                    outline: 'none'
                  }}
                />
              </div>

              {/* Action Buttons */}
              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                <button
                  className="button-primary"
                  onClick={() => {
                    setDrawMode(false);
                    clearDrawnArea();
                    if (radiusAddress) {
                      handleRadiusSearch(false);
                    }
                  }}
                  disabled={!radiusAddress}
                  style={{ 
                    width: '100%', 
                    justifyContent: 'center',
                    opacity: radiusAddress ? 1 : 0.5,
                    cursor: radiusAddress ? 'pointer' : 'not-allowed'
                  }}
                >
                  ðŸ” Search Address
                </button>
                <button
                  className="button-secondary"
                  onClick={() => {
                    setDrawMode(false);
                    clearDrawnArea();
                    if (homeBase) {
                      clearRadius();
                      drawRadius(homeBase, radiusMiles * 1609.34, 'Home Base');
                    } else {
                      alert('Home base not set');
                    }
                  }}
                  style={{ width: '100%', justifyContent: 'center' }}
                >
                  ðŸ  From Home Base
                </button>
                <button
                  className="button-secondary"
                  onClick={() => {
                    setDrawMode(false);
                    clearDrawnArea();
                    setAwaitingMapClick(true);
                  }}
                  style={{
                    width: '100%',
                    justifyContent: 'center',
                    background: awaitingMapClick ? 'rgba(139, 92, 246, 0.2)' : 'rgba(30, 41, 59, 0.5)',
                    borderColor: awaitingMapClick ? 'rgba(139, 92, 246, 0.5)' : 'rgba(139, 92, 246, 0.3)'
                  }}
                >
                  ðŸ“ {awaitingMapClick ? 'Click on Map...' : 'Click on Map'}
                </button>

                {/* Draw Area Button */}
                <button
                  className="button-secondary"
                  onClick={() => {
                    if (drawMode) {
                      setDrawMode(false);
                    } else {
                      clearRadius();
                      clearDrawnArea();
                      setDrawMode(true);
                    }
                  }}
                  style={{
                    width: '100%',
                    justifyContent: 'center',
                    background: drawMode ? 'rgba(251, 191, 36, 0.2)' : 'rgba(30, 41, 59, 0.5)',
                    borderColor: drawMode ? 'rgba(251, 191, 36, 0.5)' : 'rgba(139, 92, 246, 0.3)',
                    color: drawMode ? '#fbbf24' : undefined
                  }}
                >
                  âœï¸ {drawMode ? 'Drawing... (drag to draw)' : 'Draw Custom Area'}
                </button>

                {/* Clear Drawn Area Button */}
                {drawnArea && (
                  <button
                    className="button-secondary"
                    onClick={clearDrawnArea}
                    style={{
                      width: '100%',
                      justifyContent: 'center',
                      background: 'rgba(239, 68, 68, 0.1)',
                      borderColor: 'rgba(239, 68, 68, 0.4)',
                      color: '#fca5a5'
                    }}
                  >
                    âœ• Clear Drawn Area ({filteredCustomers.length} customers)
                  </button>
                )}

                {/* Exit and Show All Customers Button */}
                <button
                  className="button-secondary"
                  onClick={exitRadiusMode}
                  style={{
                    width: '100%',
                    justifyContent: 'center',
                    marginTop: '8px',
                    background: 'rgba(34, 197, 94, 0.1)',
                    borderColor: 'rgba(34, 197, 94, 0.4)',
                    color: '#22c55e'
                  }}
                >
                  ðŸ”™ Exit & Show All Customers
                </button>

                {/* Time Filter - Always visible in radius mode */}
                <div style={{
                  marginTop: '12px',
                  padding: '12px',
                  background: 'rgba(251, 191, 36, 0.1)',
                  border: '1px solid rgba(251, 191, 36, 0.3)',
                  borderRadius: '8px'
                }}>
                  <div style={{ fontSize: '11px', fontWeight: 600, color: '#fbbf24', marginBottom: '8px' }}>
                    â° Filter by Last Service
                  </div>
                  <select
                    value={lastServiceFilter}
                    onChange={(e) => setLastServiceFilter(e.target.value)}
                    style={{
                      width: '100%',
                      padding: '8px',
                      background: 'rgba(15, 23, 42, 0.8)',
                      border: '1px solid rgba(251, 191, 36, 0.3)',
                      borderRadius: '6px',
                      color: '#f1f5f9',
                      fontSize: '12px'
                    }}
                  >
                    <option value="">All Customers</option>
                    <option value="3months">Not serviced in 3+ months</option>
                    <option value="6months">Not serviced in 6+ months</option>
                    <option value="12months">Not serviced in 12+ months</option>
                  </select>
                </div>

                {/* Save List & Download Buttons - Show for radius or drawn area */}
                {(referencePoint || drawnArea) && filteredCustomers.length > 0 && (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    <button
                      className="button-primary"
                      onClick={() => {
                        const defaultName = drawnArea
                          ? `Drawn Area - ${new Date().toLocaleDateString()}`
                          : `Radius - ${referenceAddress || 'Search'}`;
                        const listName = prompt(`Save results as list (${filteredCustomers.length} customers)`, defaultName);
                        if (listName && listName.trim()) {
                          const listId = Date.now() + Math.random();
                          const customersToSave = filteredCustomers.map(c => ({
                            ...c,
                            fileId: listId,
                            fileName: listName.trim()
                          }));

                          setSavedLists(prev => [...prev.map(l => ({ ...l, visible: false })), {
                            id: listId,
                            name: listName.trim(),
                            customers: customersToSave,
                            visible: true,
                            createdDate: new Date().toISOString()
                          }]);
                          // Hide uploaded files too
                          setUploadedFiles(prev => prev.map(f => ({ ...f, visible: false })));

                          // Fully exit radius/draw mode and clear visual layers
                          setRadiusMode(false);
                          setAwaitingMapClick(false);
                          setDrawMode(false);
                          clearRadius();
                          clearDrawnArea();
                        }
                      }}
                      style={{
                        width: '100%',
                        justifyContent: 'center',
                        background: 'rgba(34, 197, 94, 0.2)',
                        borderColor: 'rgba(34, 197, 94, 0.3)',
                        color: '#22c55e'
                      }}
                    >
                      ðŸ’¾ Save List ({filteredCustomers.length})
                    </button>

                    <button
                      className="button-primary"
                      onClick={() => {
                        // Generate CSV from filtered customers
                        const headers = ['Name', 'Phone', 'Email', 'Address', 'City', 'State', 'Zip', 'Panel Count', 'Last Service', 'Next Service', 'Recurring', 'Notes'];
                        const csvRows = [headers.join(',')];

                        filteredCustomers.forEach(c => {
                          const row = [
                            `"${(c.name || c.contactName || '').replace(/"/g, '""')}"`,
                            `"${(c.phone || c.phoneNumber || '').replace(/"/g, '""')}"`,
                            `"${(c.email || '').replace(/"/g, '""')}"`,
                            `"${(c.address || c.fullAddress || '').replace(/"/g, '""')}"`,
                            `"${(c.city || '').replace(/"/g, '""')}"`,
                            `"${(c.state || '').replace(/"/g, '""')}"`,
                            `"${(c.zip || c.zipCode || '').replace(/"/g, '""')}"`,
                            `"${(c.panelCount || c.totalPanels || '').toString().replace(/"/g, '""')}"`,
                            `"${(c.lastServiceDate || c.lastService || '').replace(/"/g, '""')}"`,
                            `"${(c.nextServiceDate || '').replace(/"/g, '""')}"`,
                            `"${(c.isRecurring || c.recurring) ? 'Yes' : 'No'}"`,
                            `"${(c.notes || '').replace(/"/g, '""')}"`
                          ];
                          csvRows.push(row.join(','));
                        });

                        const csvContent = csvRows.join('\n');
                        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.setAttribute('href', url);
                        const filename = drawnArea
                          ? `drawn-area-customers-${new Date().toISOString().split('T')[0]}.csv`
                          : `radius-customers-${new Date().toISOString().split('T')[0]}.csv`;
                        link.setAttribute('download', filename);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                      }}
                      style={{
                        width: '100%',
                        justifyContent: 'center',
                        background: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 0.3)',
                        color: '#60a5fa'
                      }}
                    >
                      ðŸ“¥ Download CSV ({filteredCustomers.length})
                    </button>
                  </div>
                )}
              </div>

              {/* Results Count */}
              {(referencePoint || drawnArea) && (
                <div style={{
                  marginTop: '16px',
                  padding: '12px',
                  background: 'rgba(139, 92, 246, 0.1)',
                  border: '1px solid rgba(139, 92, 246, 0.3)',
                  borderRadius: '8px',
                  fontSize: '13px',
                  color: '#c4b5fd',
                  textAlign: 'center'
                }}>
                  ðŸ“Š {filteredCustomers.length} customers {drawnArea ? 'in drawn area' : 'in radius'}
                </div>
              )}
            </div>
          )}

          {/* Save List Modal */}
          {showSaveListModal && (
            <div className="modal" onClick={() => setShowSaveListModal(false)}>
              <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '24px' }}>
                  <h2 style={{ fontSize: '20px', fontWeight: 700, margin: 0 }}>Save as List</h2>
                  <button
                    onClick={() => setShowSaveListModal(false)}
                    style={{ background: 'transparent', border: 'none', color: '#94a3b8', cursor: 'pointer', padding: 0, fontSize: '24px' }}
                  >
                    âŒ
                  </button>
                </div>

                <div style={{ marginBottom: '24px' }}>
                  <label style={{ fontSize: '13px', color: '#94a3b8', fontWeight: 600, marginBottom: '10px', display: 'block' }}>
                    List Name
                  </label>
                  <input
                    type="text"
                    value={listName}
                    onChange={(e) => setListName(e.target.value)}
                    onKeyPress={(e) => {
                      if (e.key === 'Enter' && listName.trim()) {
                        handleSaveList();
                      }
                    }}
                    placeholder="e.g., Austin High-Value Leads"
                    className="input-field"
                    autoFocus
                  />
                </div>

                <div style={{
                  padding: '16px',
                  background: 'rgba(139, 92, 246, 0.1)',
                  border: '1px solid rgba(139, 92, 246, 0.2)',
                  borderRadius: '12px',
                  marginBottom: '24px',
                  fontSize: '13px',
                  color: '#c4b5fd'
                }}>
                  ðŸ’¡ This will save {visibleCustomers.length} {visibleCustomers.length === 1 ? 'customer' : 'customers'} as a reusable list
                </div>

                <div style={{ display: 'flex', gap: '12px' }}>
                  <button
                    className="button-secondary"
                    onClick={() => setShowSaveListModal(false)}
                    style={{ flex: 1, justifyContent: 'center' }}
                  >
                    Cancel
                  </button>
                  <button
                    className="button-primary"
                    onClick={handleSaveList}
                    disabled={!listName.trim()}
                    style={{ 
                      flex: 1, 
                      justifyContent: 'center',
                      opacity: listName.trim() ? 1 : 0.5,
                      cursor: listName.trim() ? 'pointer' : 'not-allowed'
                    }}
                  >
                    ðŸ’¾ Save List
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Save Route Modal */}
          {showSaveModal && (
            <div className="modal" onClick={() => setShowSaveModal(false)}>
              <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '24px' }}>
                  <h2 style={{ fontSize: '20px', fontWeight: 700, margin: 0 }}>{editingSavedRouteId ? 'Update Route' : 'Save Route'}</h2>
                  <button
                    onClick={() => setShowSaveModal(false)}
                    style={{ background: 'transparent', border: 'none', color: '#94a3b8', cursor: 'pointer', padding: 0, fontSize: '24px' }}
                  >
                    âŒ
                  </button>
                </div>

                <div style={{ marginBottom: '24px' }}>
                  <label style={{ fontSize: '13px', color: '#94a3b8', fontWeight: 600, marginBottom: '10px', display: 'block' }}>
                    Route Name
                  </label>
                  <input
                    type="text"
                    value={routeName}
                    onChange={(e) => setRouteName(e.target.value)}
                    placeholder="e.g., Austin Morning Route"
                    className="input-field"
                    autoFocus
                  />
                </div>

                <div style={{
                  padding: '16px',
                  background: 'rgba(139, 92, 246, 0.1)',
                  border: '1px solid rgba(139, 92, 246, 0.2)',
                  borderRadius: '16px',
                  fontSize: '13px',
                  color: '#c4b5fd',
                  marginBottom: '24px'
                }}>
                  <div style={{ marginBottom: '12px' }}>
                    ðŸ“… <strong>Scheduled:</strong> {selectedDate.toLocaleDateString('en-US', { 
                      weekday: 'long',
                      month: 'long', 
                      day: 'numeric',
                      year: 'numeric'
                    })}
                  </div>
                  This route has <strong>{route.length} stops</strong> and <strong>{(stats.totalRouteDistance || 0).toFixed(1)} miles</strong>.
                  <br /><br />
                  Customers will be added to your pipeline as "New" leads.
                </div>

                <div style={{ display: 'flex', gap: '12px' }}>
                  <button
                    className="button-secondary"
                    onClick={() => setShowSaveModal(false)}
                    style={{ flex: 1, justifyContent: 'center' }}
                  >
                    Cancel
                  </button>
                  <button
                    className="button-primary"
                    onClick={handleSaveRoute}
                    style={{ flex: 1, justifyContent: 'center' }}
                  >
                    {editingSavedRouteId ? 'ðŸ’¾ Update Route' : 'ðŸ’¾ Save Route'}
                  </button>
                </div>
              </div>
            </div>
          )}

        </div>
        
        {/* Footer Section - Scroll down to see */}
        <div style={{
          width: '100vw',
          minHeight: '60vh',
          background: 'linear-gradient(135deg, #1a1f3a 0%, #0a0e27 100%)',
          borderTop: '2px solid rgba(139, 92, 246, 0.3)',
          padding: '48px 24px',
          display: 'flex',
          gap: '48px'
        }}>
          {/* Left Section - File Management */}
          <div style={{
            width: '380px',
            display: 'flex',
            flexDirection: 'column',
            gap: '24px'
          }}>
            <h2 style={{ fontSize: '20px', fontWeight: 700, color: '#f1f5f9', marginBottom: '8px' }}>
              ðŸ“ Data Management
            </h2>

            {/* Upload Button */}
            <button
              onClick={() => fileInputRef.current?.click()}
              className="button-primary"
              style={{
                width: '100%',
                marginBottom: '16px',
                justifyContent: 'center',
                padding: '14px'
              }}
            >
              ðŸ“¤ ðŸ“¡ Upload CSV File
            </button>

            {/* Files Section */}
            {uploadedFiles.length > 0 && (
              <div style={{ marginBottom: '16px' }}>
                <h3 style={{
                  fontSize: '14px',
                  fontWeight: 700,
                  textTransform: 'uppercase',
                  letterSpacing: '0.5px',
                  color: '#94a3b8',
                  marginBottom: '12px'
                }}>
                  ðŸ“ Files ({uploadedFiles.length})
                </h3>
                
                <div style={{ maxHeight: '300px', overflowY: 'auto' }} className="scrollbar-custom">
                  {uploadedFiles.map((file) => (
                    <div key={file.id} className="glass-card" style={{ 
                      padding: '14px', 
                      marginBottom: '10px', 
                      display: 'flex', 
                      alignItems: 'center', 
                      gap: '12px',
                      opacity: file.visible ? 1 : 0.5,
                      transition: 'opacity 0.2s',
                      border: file.visible ? '1px solid rgba(139, 92, 246, 0.3)' : '1px solid rgba(100, 116, 139, 0.2)'
                    }}>
                      <input
                        type="checkbox"
                        checked={file.visible}
                        onChange={(e) => {
                          if (e.target.checked) {
                            setUploadedFiles(prev => prev.map(f => 
                              f.id === file.id ? { ...f, visible: true } : { ...f, visible: false }
                            ));
                            setSavedLists(prev => prev.map(l => ({ ...l, visible: false })));
                          } else {
                            setUploadedFiles(prev => prev.map(f => 
                              f.id === file.id ? { ...f, visible: false } : f
                            ));
                          }
                        }}
                        style={{
                          width: '18px',
                          height: '18px',
                          cursor: 'pointer',
                          accentColor: '#8b5cf6',
                          flexShrink: 0
                        }}
                      />
                      <div style={{
                        width: '36px',
                        height: '36px',
                        background: file.visible ? 'rgba(139, 92, 246, 0.2)' : 'rgba(100, 116, 139, 0.2)',
                        borderRadius: '10px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '18px',
                        flexShrink: 0
                      }}>
                        ðŸ“„
                      </div>
                      <div style={{ flex: 1, overflow: 'hidden' }}>
                        <div style={{ 
                          fontSize: '13px', 
                          color: file.visible ? '#f1f5f9' : '#94a3b8', 
                          marginBottom: '4px', 
                          fontWeight: 600,
                          overflow: 'hidden',
                          textOverflow: 'ellipsis',
                          whiteSpace: 'nowrap'
                        }}>
                          {file.name}
                        </div>
                        <div style={{ fontSize: '11px', color: '#64748b' }}>
                          {file.count} customers
                        </div>
                      </div>
                      <button
                        onClick={() => setUploadedFiles(prev => prev.filter(f => f.id !== file.id))}
                        style={{
                          background: 'rgba(239, 68, 68, 0.1)',
                          border: '1px solid rgba(239, 68, 68, 0.2)',
                          borderRadius: '8px',
                          width: '32px',
                          height: '32px',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          color: '#fca5a5',
                          cursor: 'pointer',
                          fontSize: '14px',
                          flexShrink: 0
                        }}
                      >
                        ðŸ—‘ï¸
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}
            
            {/* Saved Lists Section */}
            {savedLists.length > 0 && (
              <div>
                <h3 style={{
                  fontSize: '14px',
                  fontWeight: 700,
                  textTransform: 'uppercase',
                  letterSpacing: '0.5px',
                  color: '#94a3b8',
                  marginBottom: '12px'
                }}>
                  ðŸ“¡ Saved Lists ({savedLists.length})
                </h3>
                
                <div style={{ maxHeight: '300px', overflowY: 'auto' }} className="scrollbar-custom">
                  {savedLists.map((list) => (
                    <div key={list.id} className="glass-card" style={{ 
                      padding: '14px', 
                      marginBottom: '10px', 
                      display: 'flex', 
                      alignItems: 'center', 
                      gap: '12px',
                      opacity: list.visible ? 1 : 0.5,
                      transition: 'opacity 0.2s',
                      border: list.visible ? '1px solid rgba(34, 197, 94, 0.3)' : '1px solid rgba(100, 116, 139, 0.2)'
                    }}>
                      <input
                        type="checkbox"
                        checked={list.visible}
                        onChange={(e) => {
                          if (e.target.checked) {
                            setSavedLists(prev => prev.map(l => 
                              l.id === list.id ? { ...l, visible: true } : { ...l, visible: false }
                            ));
                            setUploadedFiles(prev => prev.map(f => ({ ...f, visible: false })));
                          } else {
                            setSavedLists(prev => prev.map(l => 
                              l.id === list.id ? { ...l, visible: false } : l
                            ));
                          }
                        }}
                        style={{
                          width: '18px',
                          height: '18px',
                          cursor: 'pointer',
                          accentColor: '#22c55e',
                          flexShrink: 0
                        }}
                      />
                      <div style={{
                        width: '36px',
                        height: '36px',
                        background: list.visible ? 'rgba(34, 197, 94, 0.2)' : 'rgba(100, 116, 139, 0.2)',
                        borderRadius: '10px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '18px',
                        flexShrink: 0
                      }}>
                        ðŸ“‹
                      </div>
                      <div style={{ flex: 1, overflow: 'hidden' }}>
                        <div style={{ 
                          fontSize: '12px', 
                          color: list.visible ? '#f1f5f9' : '#94a3b8', 
                          marginBottom: '3px', 
                          fontWeight: 600 
                        }}>
                          {list.count} customers
                        </div>
                        <div style={{
                          fontSize: '11px',
                          color: '#64748b',
                          overflow: 'hidden',
                          textOverflow: 'ellipsis',
                          whiteSpace: 'nowrap'
                        }}>
                          {list.name}
                        </div>
                      </div>
                      <button
                        onClick={() => {
                          const remaining = savedLists.filter(l => l.id !== list.id);
                          setSavedLists(remaining);
                          // If deleted list was visible, show the first remaining list or first uploaded file
                          if (list.visible) {
                            if (remaining.length > 0) {
                              setSavedLists(remaining.map((l, i) => ({ ...l, visible: i === 0 })));
                            } else if (uploadedFiles.length > 0) {
                              setUploadedFiles(prev => prev.map((f, i) => ({ ...f, visible: i === 0 })));
                            }
                          }
                        }}
                        style={{
                          background: 'rgba(239, 68, 68, 0.1)',
                          border: '1px solid rgba(239, 68, 68, 0.2)',
                          borderRadius: '8px',
                          width: '32px',
                          height: '32px',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          color: '#fca5a5',
                          cursor: 'pointer',
                          fontSize: '14px',
                          flexShrink: 0
                        }}
                      >
                        ðŸ—‘ï¸
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
          
          {/* Right Section - Info */}
          <div style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', gap: '24px' }}>
          <div style={{ textAlign: 'center', maxWidth: '800px' }}>
            <h2 style={{ fontSize: '28px', fontWeight: 700, marginBottom: '16px', color: '#f1f5f9' }}>
              ðŸ›¸ Route Planning System
            </h2>
            <p style={{ fontSize: '16px', color: '#94a3b8', lineHeight: '1.6' }}>
              Complete route management and customer relationship tools for your business.
            </p>
          </div>
          
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '24px', width: '100%', maxWidth: '1000px' }}>
            <div style={{ 
              background: 'rgba(139, 92, 246, 0.1)', 
              border: '1px solid rgba(139, 92, 246, 0.3)',
              borderRadius: '12px',
              padding: '24px',
              textAlign: 'center'
            }}>
              <div style={{ fontSize: '32px', marginBottom: '12px' }}>ðŸ“…</div>
              <h3 style={{ fontSize: '16px', fontWeight: 600, color: '#f1f5f9', marginBottom: '8px' }}>Schedule Management</h3>
              <p style={{ fontSize: '13px', color: '#94a3b8' }}>Organize routes by day with drag-and-drop time slots</p>
            </div>
            
            <div style={{ 
              background: 'rgba(139, 92, 246, 0.1)', 
              border: '1px solid rgba(139, 92, 246, 0.3)',
              borderRadius: '12px',
              padding: '24px',
              textAlign: 'center'
            }}>
              <div style={{ fontSize: '32px', marginBottom: '12px' }}>ðŸ—ºï¸</div>
              <h3 style={{ fontSize: '16px', fontWeight: 600, color: '#f1f5f9', marginBottom: '8px' }}>Interactive Maps</h3>
              <p style={{ fontSize: '13px', color: '#94a3b8' }}>Satellite views and route optimization</p>
            </div>
            
            <div style={{ 
              background: 'rgba(139, 92, 246, 0.1)', 
              border: '1px solid rgba(139, 92, 246, 0.3)',
              borderRadius: '12px',
              padding: '24px',
              textAlign: 'center'
            }}>
              <div style={{ fontSize: '32px', marginBottom: '12px' }}>ðŸ’¾</div>
              <h3 style={{ fontSize: '16px', fontWeight: 600, color: '#f1f5f9', marginBottom: '8px' }}>Route Saving</h3>
              <p style={{ fontSize: '13px', color: '#94a3b8' }}>Save and manage multiple route configurations</p>
            </div>
          </div>
          
          <div style={{ fontSize: '12px', color: '#64748b', marginTop: '24px' }}>
            Â© 2026 Route Planning System â€¢ All Rights Reserved
          </div>
          </div>
        </div>
        </>
      );
    };

    ReactDOM.render(<CustomerMap />, document.getElementById('root'));
  </script>
</body></html>
